---
name: ビットコインにおけるプライバシー
goal: ビットコインを使用する際のプライバシー保護の原則を理解し、習得する。
objectives: 

  - プライバシーの問題を理解するために必要な理論的概念を定義する。
  - ビットコインユーザーの機密性喪失に関連するリスクを特定し、軽減する。
  - ビットコインでプライバシーを保護する方法とツールを使う
  - チェーン分析の手法を理解し、防衛戦略を立てる

---
# ビットコインでプライバシーを守る

金融取引の機密性が徐々に贅沢品になりつつある世界では、ビットコインを使用する際のプライバシー保護の原則を理解し、習得することが不可欠です。このトレーニングコースでは、これを自律的に達成するためのすべての鍵を、理論と実践の両面から学びます。

今日、ビットコインでは、ブロックチェーン分析を専門とする企業が存在する。彼らの本業はまさに、あなたの取引の機密性を危うくするために、あなたのプライベートな領域に侵入することにある。現実には、ビットコインには「プライバシーの権利」など存在しない。つまり、自分の自然権を主張し、取引の機密性を守るのは、ユーザーであるあなた次第なのだ。

このコースは包括的かつ一般的な内容となっている。各技術的なコンセプトは詳細に説明され、説明図によってサポートされています。このコースの目的は、すべての人が知識を習得できるようにすることです。そのため、BTC204は初心者や中級者の方にも受講しやすい内容となっています。また、経験豊富なビットコイナーにも、誤解されがちな技術的概念を深く掘り下げることで、付加価値を提供します。

私たちと一緒にビットコインの使い方を変え、機密保持とプライバシー保護の問題を理解できる情報通のユーザーになりましょう。

+++
# はじめに

<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## コース概要

<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

BTC204コースへようこそ！

金融取引の機密性が徐々に贅沢品になりつつある世界では、ビットコインを使用する際のプライバシー保護の原則を理解し、習得することが不可欠です。このトレーニングコースでは、これを自律的に達成するためのすべての鍵を、理論と実践の両面から学びます。

今日、ビットコインでは、ブロックチェーン分析を専門とする企業が存在する。彼らの本業はまさに、あなたの取引の機密性を危うくするために、あなたのプライベートな領域に侵入することにある。現実には、ビットコインには「プライバシーの権利」など存在しない。つまり、自分の自然権を主張し、取引の機密性を守るのは、ユーザーであるあなた次第なのだ。

ビットコインは「ナンバー・ゴー・アップ」や貯蓄価値の保全のためだけのものではない。そのユニークな特徴と歴史により、ビットコインは何よりもまず、反経済のツールなのだ。この恐ろしい発明のおかげで、誰にも止められることなく、自由にお金を処分し、使い、蓄積することができる。

ビットコインは、国家のくびきから逃れる平和的な手段を提供し、既成の法律では対抗できない自然権を完全に享受することを可能にする。サトシ・ナカモトの発明のおかげで、あなたは私有財産の尊重を強制し、契約の自由を取り戻す力を手に入れた。

しかし、ビットコインはデフォルトでは匿名ではないため、特に専制的な支配下にある地域では、カウンターエコノミーに従事する個人にとってリスクとなりうる。しかし、危険はこれだけではない。ビットコインは価値のある、測定不能な資産であるため、泥棒の標的になる可能性がある。つまり、プライバシーの保護はセキュリティの問題でもあるのだ。ハッキングや物理的な攻撃を防ぐことができる。

後述するように、プロトコルはそれ自体で一定の機密性保護を提供するが、この機密性を最適化し、守るために追加のツールを使用することが極めて重要である。

このトレーニングコースは、ビットコインの守秘義務に関わる問題の包括的で一般的な概要を提供することを目的としています。各技術的な概念は、説明図によってサポートされながら詳細にカバーされています。その目的は、初心者や中級者であっても、誰もがこの知識にアクセスできるようにすることです。また、経験豊富なビットコイナー向けには、各テーマの理解を深めるために、コース全体を通して高度に技術的で、時にはあまり知られていない概念も取り上げています。

このトレーニングコースの目的は、ビットコインの利用を完全に匿名化することではなく、個人の目的に応じて機密性を保護する方法を知るために不可欠なツールを提供することです。あなたは、提示されたコンセプトやツールから自由に選択し、特定の目標やニーズに合わせた独自の戦略を開発することができます。

**第1節 定義と主要概念**

まず始めに、ビットコインの運用を支配する基本原則を確認し、機密性に関する概念に落ち着いて取り組めるようにします。UTXO、受信アドレス、スクリプティングなど、いくつかの基本的な概念をマスターしておくことは、以降のセクションで取り上げる概念を完全に理解するために不可欠である。また、サトシ・ナカモトが想像したビットコインの一般的な秘密保持モデルを紹介し、関連する賭け金とリスクを把握できるようにする。

![BTC204](assets/fr/001.webp)

**第2節 チェーン分析の理解と対策**

第2章では、ブロックチェーン分析会社がビットコイン上でのあなたの行動を追跡するために使用する技術について見ていきます。これらの手法を理解することは、あなたのプライバシー保護を強化する上で極めて重要です。このセクションの目的は、リスクをよりよく理解し、次のセクションで研究するテクニックの土台を整えるために、攻撃者の戦略を検証することです。トランザクションのパターン、内部および外部のヒューリスティック、そしてこれらのパターンの解釈の可能性を分析します。理論に加え、チェーン分析のためのブロック・エクスプローラーの使い方を、実践的な例と演習を通して学びます。

![BTC204](assets/fr/002.webp)

**セクション3：プライバシー保護のベストプラクティスをマスターする**

トレーニングコースの第3章では、実践に入ります！その目的は、ビットコインユーザーの自然な反射神経となるべき本質的なベストプラクティスをすべてマスターすることです。空白アドレスの使用、タグ付け、統合、完全なノードの使用、さらにKYCと取得方法をカバーします。その目的は、プライバシー保護の探求において強固な基盤を確立するために避けるべき落とし穴の包括的な概要を提供することです。いくつかの実践方法については、具体的なチュートリアルをご覧ください。

![BTC204](assets/fr/003.webp)

**第4節 コインジョイント・トランザクションを理解する**

コインジョイントに触れずに、ビットコインのプライバシーを語ることができるだろうか？セクション4では、このミキシング方法について知っておくべきことをすべて説明します。コインジョイントとは何か、その歴史と目的、そして存在する様々なタイプのコインジョイントについて学びます。最後に、経験豊富なユーザーのために、アノンセットとエントロピーとは何か、そしてそれらの計算方法について見ていきます。

![BTC204](assets/fr/004.webp)

**第5節 他の高度な機密保持技術の課題を理解する**

第5章では、coinjoinとは別に、ビットコイン上でプライバシーを保護するために利用可能な他のテクニックをすべて見ていきます。何年もの間、開発者はプライバシーに特化したツールの設計において驚くべき創造性を発揮してきました。ここでは、payjoin、協調取引、コインスワップ、アトミックスワップなど、これらの方法をすべて取り上げ、その仕組み、目的、弱点について詳しく説明します。

また、ノードのネットワークとトランザクションの普及というレベルでのプライバシーについても見ていきます。また、静的アドレスプロトコルなど、ビットコイン上でユーザーのプライバシーを強化するために長年提案されてきた様々なプロトコルについても説明します。

![BTC204](assets/fr/005.webp)
ビットコインのプライバシーの奥深くを探求する準備はできましたか？さあ、始めましょう！

# 定義と主要概念

<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>

## ビットコインのUTXOモデル

<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>


ビットコインは何よりもまず通貨ですが、実際にBTCがプロトコル上でどのように表現されているかご存知ですか？

### ビットコインのUTXO：それは何ですか？

ビットコインのプロトコルは、「Unspent Transaction Output」の略であるUTXOモデルに基づいている。

このモデルは、金融の流れを追跡するために口座と残高のメカニズムに依存する伝統的な銀行システムとは大きく異なる。実際、銀行システムでは、個々の残高はIDに付随する口座で管理される。例えば、あなたがパン屋からバゲットを買うと、銀行はあなたの口座から購入金額を引き落とし、あなたの残高を減らす。このシステムでは、取引記録は別として、あなたの口座に入るお金と出ていくお金の間にはリンクという概念はない。

![BTC204](assets/fr/006.webp)

ビットコインの仕組みは異なる。口座という概念は存在せず、通貨単位は残高ではなく、UTXOを通じて管理される。UTXOは、まだ使用されていない特定の量のビットコインを表し、「ビットコインの一部」を形成する。例えば、1つのUTXOは「500 BTC」に相当することもあれば、単に「700 SATS」に相当することもある。

**> サトシはビットコインの最小単位で、不換紙幣の1セントに相当する。

```plaintext
1 BTC = 100 000 000 SATS
```

理論的には、1つのUTXOはビットコインで任意の価値を表すことができ、その価値は1サットから理論上の最大値である約2100万BTCまである。しかし、2,100万ビットコインすべてを所有することは論理的に不可能であり、「ダスト」と呼ばれる経済的閾値が存在し、それ以下ではUTXOの使用は経済的に採算が合わないとみなされる。

**> ビットコインで作成された最大のUTXOの価値は`500,000 BTC`であった。これは2011年11月にMtGoxプラットフォームが統合作業中に作成したものである：[29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXOと支出状況

UTXOはビットコインの交換手段である。各取引では、インプットとしてUTXOが消費され、アウトプットとして新しいUTXOが生成されます。トランザクションが完了すると、入力として使用されたUTXOは「使用された」とみなされ、新しいUTXOが生成され、トランザクションの出力で示された受信者に割り当てられます。従って、UTXOは単に未使用のトランザクションのアウトプットを表し、従ってある時点でユーザーに属するビットコインの量を表す。

![BTC204](assets/fr/007.webp)

すべてのUTXOは、UTXOを消費できる条件を定義したスクリプトによって保護されている。UTXOを消費するには、ユーザーは、そのUTXOを保護するスクリプトが規定する条件を満たすことをネットワークに示さなければならない。通常、UTXOは公開鍵（またはこの公開鍵を表す受信アドレス）によって保護されている。この公開鍵に関連付けられたUTXOを使用するには、ユーザーは、この鍵で作成されたデジタル署名を提供することによって、対応する秘密鍵を保持していることを証明する必要があります。これが、ビットコイン・ウォレットには実際にはビットコインが入っておらず、秘密鍵が保管されている理由である。

![BTC204](assets/fr/008.webp)

ビットコインにはアカウントという概念がないため、ウォレットの残高は単純に、使用できるすべてのUTXOの値の合計となります。例えば、あなたのビットコインウォレットが以下の4つのUTXOを使えるとします：

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

ポートフォリオの総残高は17BTCとなる。

![BTC204](assets/fr/009.webp)

## ビットコイン取引の仕組み

<chapterId>29d3aaab-de2e-4746-ab40-c9748898850c</chapterId>


### トランザクションの入出力

ビットコイン取引とは、ある人から別の人にビットコインの所有権を移転する、ブロックチェーン上に記録された操作のことである。より正確には、私たちはUTXOモデルであり、アカウントは存在しないため、トランザクションは1つまたは複数のUTXOを確保する支出条件を満たし、それらを消費し、等価的に新しい支出条件を持つ新しいUTXOを作成します。要するに、取引はビットコインを満足させたスクリプトから、それを確保するために設計された新しいスクリプトに移動させる。

![BTC204](assets/fr/010.webp)

したがって、各ビットコイントランザクションは、1つ以上の入力と1つ以上の出力から構成される。インプットは、アウトプットを生成するためにトランザクションによって消費されるUTXOである。出力は、将来のトランザクションの入力として使用できる新しい UTXO である。

![BTC204](assets/fr/011.webp)

**> 理論的には、ビットコイン取引は無限の入力と出力を持つことができる。唯一の制限は最大ブロックサイズである。

ビットコイン取引における各入力は、以前の未使用の UTXO を参照する。インプットとして UTXO を使用するには、その保有者は、関連するスクリプトを検証することによって、つまり課された支出条件を満たすことによって、彼/彼女が正当な所有者であることを証明しなければならない。一般的に言えば、これは、このUTXOを最初に確保した公開鍵に対応する秘密鍵で作成されたデジタル署名を提供することを意味する。したがってスクリプトは、その署名が、資金を受け取ったときに使用された公開鍵に対応することを検証することで構成される。

![BTC204](assets/fr/012.webp)

各出力は順に、送金されるビットコインの量と受取人を指定する。後者は新しいスクリプトで定義され、通常、受信アドレスまたは新しい公開鍵で新しく作成されたUTXOをブロックする。

コンセンサスルールに従ってトランザクションが有効とみなされるためには、総アウトプットが総インプット以下でなければならない。言い換えれば、トランザクションによって生成された新しいUTXOの合計は、インプットとして消費されたUTXOの合計を超えてはならない。この原則は論理的である。もしあなたが`500,000 SATS`しか持っていなければ、`700,000 SATS`を購入することはできない。

### ビットコイン取引における交換とマージ

従って、UTXOに対するビットコイン取引の作用は、金貨を鋳造し直すことに例えることができる。実際、UTXOは分割可能ではなく、溶解可能なだけである。つまり、あるビットコインに相当するUTXOを単純にいくつかの小さなUTXOに分割することはできない。取引でUTXOを完全に消費し、出力が初期値以下の任意の値のUTXOを1つ以上新たに作らなければならない。

この仕組みは金貨と似ている。例えば、2オンスの金貨を持っていて、1オンスの支払いをしたいとします。その場合、あなたは自分のコインを溶かして、1オンスずつ2枚の新しいコインを鋳造しなければなりません。

ビットコインも同じような仕組みだ。アリスが10,000 SATSのUTXOを持っていて、4,000 SATSのバゲットを買いたいとする。アリスは入力として10,000 SATS`のUTXOを1つ持ち、それを全額消費し、出力として4,000 SATS`と6,000 SATS`のUTXOを2つ持って取引をする。4,000SATS`のUTXOはバゲットの代金としてパン屋に送られ、6,000SATS`のUTXOはお釣りの形でアリスに戻る。このUTXOはトランザクションの元の発行者に戻り、ビットコインの専門用語では「交換」と呼ばれる。

![BTC204](assets/fr/013.webp)

では、アリスが10,000 SATSのUTXOを1つ持っているのではなく、3,000 SATSのUTXOを2つ持っているとしましょう。この状況では、どちらのUTXOも杖の`4,000 SATS`をセットするのに十分ではありません。したがって、アリスは3,000 SATS`の2つのUTXOを同時にトランザクショ ンの入力として使わなければならない。こうすることで、インプットの総量は6,000 SATS`に達し、パン屋への4,000 SATS`の支払いを満たすことができる。複数のUTXOを1つの取引のインプットとしてまとめるこの方法は、しばしば「マージ ング」と呼ばれる。

![BTC204](assets/fr/014.webp)

### 取引手数料

直感的には、取引コストも取引のアウトプットを表していると考えるかもしれない。しかし、実際にはそうではない。取引コストは、総インプットと総アウトプットの差を表している。つまり、ある取引において、インプットの価値の一部を使って所望のアウトプットをまかなった後、インプットのある合計が未使用のまま残るということである。この残額が取引コストである。

```plaintext
Frais = total inputs - total outputs
```

10,000SATS`のUTXOを持っていて、4,000SATS`のバゲットを買いたいアリスの例を見てみよう。アリスは10,000 SATS`のUTXOを入力としてトランザクションを作成する。その後、アリスはパン屋にバゲットの代金を支払うために4,000 SATS`のアウトプットを生成する。彼女の取引をブロックに統合するようマイナーに奨励するため、アリスは手数料として200SATS`を割り当てる。その後、アリスは2つ目の出力である交換を作成し、5,800 SATS`を彼女に返却する。

![BTC204](assets/fr/015.webp)

料金の計算式に当てはめると、未成年者には200SATSが残されていることになる：

```plaintext
Frais = total inputs - total outputs
Frais = 10 000 - (4 000 + 5 800)
Frais = 10 000 - 9 800
Frais = 200
```

マイナーはブロックの検証に成功すると、いわゆる「coinbase」トランザクションを通じて、そのブロックに含まれるすべてのトランザクションに対してこれらの手数料を徴収する権限を持つ。

### ビットコインでUTXOを作る

ここまでの段落を注意深く読んでいただければ、UTXOは他の既存のUTXOを消費することでしか作成できないことがお分かりいただけると思います。このようにして、ビットコインコインは連続的なチェーンを形成します。しかし、この連鎖の最初のUTXOがどのようにして生まれたのか不思議に思うかもしれません。これはニワトリと卵の問題に似ている。

答えは**取引コインベース**にある。

コインベースはビットコインのトランザクションの特定のタイプで、ブロックごとにユニークであり、常にこれらの最初のものです。これにより、有効なプルーフ・オブ・ワークを見つけた採掘者はブロック報酬を受け取ることができます。この報酬は2つの要素で構成されています： **ブロックグラント**と**取引手数料**である。

coinbaseのトランザクションは、出力を生成するために入力を消費する必要がなく、ビットコインを自然に生成できる唯一のトランザクションであるという点でユニークです。これらの新しく作られたビットコインは「オリジナルUTXO」と呼ばれるものである。

![BTC204](assets/fr/016.webp)

ブロック補助ビットコインとは、コンセンサスルールにあらかじめ定められた発行スケジュールに従って、ゼロから作られた新しいBTCのことである。ブロック補助金は21万ブロックごと、つまり約4年ごとに「半減」と呼ばれるプロセスで半減される。当初は1ブロックあたり50ビットコインが発行されていたが、徐々に減少し、現在は1ブロックあたり3.125ビットコインとなっている。

取引手数料に関しても、新たに創出されたBTCを表すものではあるが、ブロック内の全取引のインプットとアウトプットの合計の差を超えてはならない。これらの手数料は、トランザクションのアウトプットに使用されなかったインプットの部分を表していることは前述したとおりである。この部分は技術的には取引中に「失われた」ものであり、採掘者はこの価値を1つまたは複数の新しいUTXOの形で再作成する権利を有する。これはトランザクションの発行者と、それをブロックチェーンに追加するマイナーとの間の価値の移転である。

**> コインベース取引によって生成されたビットコインには100ブロックの満期期間があり、その間はマイナーによって使用されることはない。このルールは、新しく生成されたビットコインがチェーン上で使用され、後に陳腐化することを避けるためのものである。

### UTXOモデルの意味

まず、UTXOモデルはビットコインの取引手数料に直接影響する。各ブロックの容量には限りがあるため、マイナーはブロック内で占有するスペースに対して最高の手数料を提供するトランザクションを選好する。実際、トランザクションのインプットとアウトプットに含まれるUTXOが多ければ多いほど、そのトランザクションは重くなり、したがって高い手数料が必要となる。これが、しばしばポートフォリオ内のUTXOの数を減らそうとする理由の1つであり、これは機密性にも影響する可能性がある。

第二に、前のセクションで述べたように、ビットコインコインは本質的にUTXOの連鎖である。そのため、各取引は過去の UTXO と将来の UTXO の間のリンクを作成する。したがって、UTXO により、ビットコインの作成から現在の支出までの経路を明示的にたどることが可能になる。この透明性は、各ユーザーが受け取ったビットコインの真正性を確認することを可能にするため、肯定的に捉えることができる。しかし、ブロックチェーン分析がこのトレーサビリティと監査可能性の原則に基づいていることもまた事実であり、機密性を損なうように設計された行為です。コースの後半では、この慣行について詳しく見ていきます。

## ビットコインのプライバシー・モデル

<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>


### お金：信頼性、誠実さ、二重支出

貨幣の機能の一つは、ニーズの二重の一致という問題を解決することである。物々交換に基づくシステムでは、交換を完了させるためには、私のニーズに対応する財を手放してくれる個人を見つけるだけでなく、彼自身のニーズを満たす同等の価値の財を提供する必要がある。このバランスを取るのは複雑な問題である。

![BTC204](assets/fr/017.webp)

だからこそ、私たちは空間と時間の両方で価値を移動させるためにお金を使うのだ。

![BTC204](assets/fr/018.webp)

硬貨がこの問題を解決するためには、財やサービスを提供する側が、後日その金額を使うことができると確信することが不可欠である。したがって、デジタルであれ現物であれ、コインを受け入れようとする合理的な個人は、そのコインが2つの基本的な基準を満たしていることを確認することになる：


- 作品には完全性と信憑性がなければならない。
- 二重支出は許されない。

現物通貨を使用する場合、最も複雑なのはこの最初の特徴である。歴史上のさまざまな時代において、金属コインの完全性は、削ったり穴を開けたりするような行為によってしばしば影響を受けてきた。たとえば古代ローマでは、市民が金貨の縁を削って貴金属を少し集め、将来の取引のために取っておくことが一般的だった。こうしてコインの本質的な価値は下がったが、額面は変わらなかった。これが、後にコインの縁にフルート加工が施されるようになった理由のひとつである。

また、真正性を物理的な貨幣媒体で確認することも困難である。今日の偽造通貨対策技術はますます複雑化しており、小売業者はコストのかかる検証システムへの投資を余儀なくされている。

一方、現物通貨はその性質上、二重支出は問題にならない。私が10ユーロ札をあなたに渡すと、その10ユーロ札は不可逆的に私の手元から離れ、あなたの手元に入る。つまり、私はこの10ユーロ札を二度と使うことはできないのだ。

![BTC204](assets/fr/019.webp)

デジタル通貨の場合、その難しさは異なる。コインの真正性と完全性を保証することは、多くの場合、より単純である。前節で見たように、ビットコインのUTXOモデルでは、コインの出所をさかのぼることが可能であり、その結果、そのコインが本当にコンセンサスルールに従ってマイナーによって作成されたかを検証することができる。

一方、デジタル財はすべて本質的に情報であるため、二重支出がないようにすることはより複雑である。物理的な商品と違って、情報は交換されるときに分割されるのではなく、掛け算で広がっていく。例えば、私が電子メールで文書を送れば、それは複製される。私が元の文書を削除したかどうかはわからない。

![BTC204](assets/fr/020.webp)

### ビットコインでの二重支出を防ぐ

デジタル資産の重複を避ける唯一の方法は、システム上のすべての取引所を把握することだ。そうすれば、誰が何を所有しているかを把握し、行われた取引に応じて各人の保有資産を更新することができる。これは例えば、銀行システムにおける経典の貨幣で起こっていることだ。クレジットカードで加盟店に10ユーロを支払うと、銀行はそのやり取りを記録し、口座簿を更新する。

![BTC204](assets/fr/021.webp)

ビットコインでは、二重支出は同じ方法で防止される。私たちは、問題のコインをすでに使った取引がないことを確認しようとします。コインが一度も使われていなければ、二重支出は起きないと確信できる。この原則は、サトシ・ナカモトが白書の中で有名なフレーズで説明している：

**取引がないことを確認する唯一の方法は、すべての取引を把握することである。

しかし銀行モデルとは異なり、ビットコインでは中央のエンティティを信頼する必要はない。そのため、すべてのユーザーが、第三者に頼ることなく、二重支出のないことを確認できる必要がある。そのため、誰もがすべてのビットコイン取引を認識する必要がある。これが、ビットコインの取引がすべてのネットワークノードで公にブロードキャストされ、ブロックチェーン上にクリアテキストで記録される理由です。

ビットコインにおけるプライバシーの保護を複雑にしているのは、まさにこの情報の公開である。伝統的な銀行システムでは、理論上、金融機関だけが取引の内容を知ることができる。一方、ビットコインでは、すべてのユーザーがそれぞれのノードを介して、すべての取引を知らされる。

### 機密保持モデル：銀行システム対ビットコイン

従来のシステムでは、銀行口座はあなたの身元とリンクしている。銀行員は、どの銀行口座がどの顧客のもので、どの取引がその口座に関連付けられているかを知ることができる。しかし、この情報の流れは、銀行と一般領域との間で遮断されている。つまり、他人の銀行口座の残高や取引を知ることはできない。この情報にアクセスできるのは銀行だけなのだ。

![BTC204](assets/fr/022.webp)

例えば、銀行員はあなたが毎朝地元のパン屋からバゲットを買っていることを知っているが、隣人はこの取引について知らない。このように、情報の流れは、銀行をはじめとする関係者にはアクセスできるが、外部の人間にはアクセスできないままである。

![BTC204](assets/fr/023.webp)

前節で見たトランザクションの公開という制約のため、ビットコインの機密性モデルは銀行システムのモデルには従えない。ビットコインの場合、トランザクションとパブリックドメインの間で情報の流れを断ち切ることができないため、**プライバシーモデルはユーザーのアイデンティティとトランザクション**自体の分離に依存する。

![BTC204](assets/fr/024.webp)

例えば、あなたがパン屋でバゲットを買い、BTCで支払った場合、自分の完全なノードを持つ隣人は、システム内の他のすべてのトランザクションを見ることができるのと同様に、あなたのトランザクションが通過するのを見ることができる。しかし、機密保持の原則が尊重されるのであれば、彼はこの特定の取引とあなたの身元を結びつけることはできないはずだ。

![BTC204](assets/fr/025.webp)

しかし、ビットコインの取引は公開されているため、取引間のリンクを確立して関係者の情報を推測することは可能である。この活動は、「ブロックチェーン分析」として知られる、それ自体が1つの専門分野を構成しています。コースの次のパートでは、ビットコインがどのようにトレースされるかを理解し、ビットコインから身を守ることができるように、ブロックチェーン分析の基本を探求していただきたい。

# チェーン分析の理解と防御

<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## ビットコインチェーン分析とは何か？

<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>


### 定義と運用

ブロックチェーン分析とは、ブロックチェーン上のビットコインの流れを追跡することである。一般的にチェーン分析は、過去の取引のサンプルの特徴を観察することに基づいている。そして、分析したい取引についてこれらと同じ特徴を特定し、そこからもっともらしい解釈を推論する。十分な解を見出すための実践的アプローチに基づくこの問題解決手法は、「ヒューリスティック」として知られる。

平たく言えば、チェーン分析には主に3つの段階がある：

1. **ブロックチェーンを監視する。

2. **既知の特徴の識別 ;**.

3. **仮定の推理

![BTC204](assets/fr/026.webp)

ブロックチェーンの分析は誰でも行うことができる。必要なのは、完全なノードを介してブロックチェーンの公開情報にアクセスし、取引の動きを観察して仮説を立てることだけだ。この分析を容易にする無料のツールもあり、例えば[OXT.me](https://oxt.me/)などがある。このセクションの最後の2つの章で詳しく説明する。しかし、機密性に対する主なリスクは、文字列分析を専門とする企業からもたらされる。これらの企業はブロックチェーン分析を工業的規模にまで高め、金融機関や政府にサービスを販売している。こうした企業の中で、Chainalysis社が最も有名であることは間違いない。

### チェーン分析の目的

ブロックチェーン分析の目的のひとつは、ビットコイン上のさまざまな活動をグループ化し、それらを実行したユーザーの独自性を判断することである。その後、この活動のクラスターを実際のアイデンティティにリンクさせる試みが可能になる。

![BTC204](assets/fr/027.webp)

前章を思い出してほしい。ビットコインのプライバシーモデルが、もともとユーザーIDとトランザクションの分離に基づいている理由を説明した。そのため、ブロックチェーン分析は役に立たない、と考えたくなるだろう。たとえオンチェーンでの活動を何とか集約できたとしても、それを本当のアイデンティティと関連付けることはできないからだ。

理論的には、この記述は正しい。このコースの最初の部分では、暗号鍵ペアがUTXOの条件を確立するために使用されることを見た。要するに、これらの鍵ペアは、その保持者の身元に関する情報を一切漏らさない。したがって、異なる鍵ペアに関連する活動をグループ化できたとしても、これらの活動の背後にある実体については何もわからない。

![BTC204](assets/fr/028.webp)

しかし、現実ははるかに複雑である。本物のIDをオンチェーン・アクティビティに結びつけることができる行動は多数存在する。分析では、これをエントリー・ポイントと呼び、その数は膨大である。

最も一般的なものは KYC (*Know Your Customer*)です。あなたが規制されたプラットフォームからあなたの個人的な受信アドレスの1つにビットコインを引き出す場合、一部の人々はあなたのアイデンティティをそのアドレスにリンクすることができます。より広義には、エントリーポイントは、あなたの実生活とビットコイン取引との間のあらゆる形式の相互作用であり得る。例えば、ソーシャルネットワーク上で受信アドレスを公開する場合、これは分析のためのエントリーポイントとなり得る。あなたがパン屋にビットコインで支払いをすれば、パン屋はあなたの顔（あなたのアイデンティティの一部）とビットコインアドレスを関連付けることができる。

ビットコインを使用する場合、これらのエントリーポイントは事実上避けられない。その範囲を制限しようとしても、常に存在する。だからこそ、プライバシーの保護を目的とした方法を組み合わせることが極めて重要なのだ。実際のアイデンティティとトランザクションの分離を維持することは興味深いアプローチではあるが、現在ではまだ不十分である。実際、もしあなたのオンチェーン・アクティビティがすべてグループ化できるのであれば、たとえ小さなエントリー・ポイントであっても、あなたが確立した機密性の単一レイヤーを危険にさらす可能性が高い。

![BTC204](assets/fr/029.webp)

### チェーン分析から身を守る

そのため、ビットコインの利用においてもブロックチェーン分析に対応する必要がある。そうすることで、私たちの活動の集約を最小限に抑え、プライバシーへのエントリーポイントの影響を抑えることができる。

![BTC204](assets/fr/030.webp)

ブロックチェーン分析に対抗するには、そこで使われている手法を学ぶのが一番だろう。ビットコインでプライバシーを向上させる方法を知りたければ、これらの方法を理解する必要がある。そうすることで、coinjoinやpayjoinのようなテクニック（コースの最後の部分で見るテクニック）をよりよく把握できるようになり、あなたが犯すかもしれないミスを減らすことができます。

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef

https://planb.network/tutorials/privacy/on-chain/payjoin-848b6a23-deb2-4c5f-a27e-93e2f842140f

この点で、暗号と暗号解読を類推することができる。優れた暗号解読者は、何よりもまず優れた暗号解読者である。新しい暗号化アルゴリズムを考案するには、それがどのような攻撃に直面するかを知る必要があり、また過去のアルゴリズムがなぜ破られたかを研究する必要がある。同じ原理がビットコインのプライバシーにも当てはまる。ブロックチェーンの分析手法を理解することが、それらから身を守る鍵なのだ。このトレーニングコースにチェーン分析のセクションを設けたのはそのためです。

### チェーン分析手法

ストリング解析は厳密な科学ではないことを理解することが重要だ。過去の観測結果や論理的解釈から導き出されたヒューリスティックに依存している。これらの規則によって、かなり信頼できる結果を得ることができますが、絶対的な正確さを持つことはありません。言い換えれば、**連鎖解析は、到達した結論に常に確率の次元を含む**ということです。例えば、2つのアドレスが同じエンティティに属することを、程度の差こそあれ推定することは可能かもしれないが、完全な確実性は常に手の届かないところにある。

連鎖分析の要点は、まさに様々なヒューリスティックを集約し、エラーのリスクを最小限に抑えることにある。ある意味、それは私たちを現実に近づける証拠の集積なのだ。

これらの有名なヒューリスティックは異なるカテゴリーに分類することができ、以下に詳しく説明する：


- 取引パターン ;**
- トランザクション内部のヒューリスティック ;**)
- トランザクションの外部にあるヒューリスティック。

### サトシ・ナカモトとチェーン分析

最初の2つのチェーン分析ヒューリスティックは、サトシ・ナカモト自身が発見した。サトシ・ナカモトは、ビットコイン白書の第10回でこれらについて述べている。それは


- cIOH（*共通入力所有ヒューリスティック*）；
- とアドレスの再利用。

![BTC204](assets/fr/031.webp)

出典S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

この2つのヒューリスティックが、今日でもチェーン分析において優位を保っていることは、すでに興味深い。

## 取引パターン

<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>


トランザクションパターンとは、ブロックチェーン上で見つけることができ、その解釈の可能性が知られている典型的なトランザクションの全体的なモデルや構造のことである。パターンを研究する際には、単一のトランザクションに焦点を当て、それを高いレベルで分析する。

言い換えれば、トランザクションのより具体的な詳細や環境にはこだわらず、インプットのUTXOの数とアウトプットのUTXOの数だけを見ることになる。観察されたパターンに基づいて、トランザクションの性質を解釈することができる。次に、その構造の特徴を探し、解釈を推測する。

![BTC204](assets/fr/032.webp)

このセクションでは、チェーン分析で遭遇する主なトランザクションモデルを一緒に見て、それぞれのモデルについて、この構造の解釈の可能性と具体的な例を挙げます。

### 1回の発送（または1回の支払い）

ほとんどのビットコイン決済で見られるパターンなので、非常に一般的なパターンから始めましょう。単純な支払いモデルは、入力として1つ以上のUTXOを消費し、出力として2つのUTXOを生産することを特徴とする。したがって、このモデルは次のようになる：

![BTC204](assets/fr/033.webp)

ブロックチェーン上でこの取引構造を見つけたとき、私たちはすでに解釈を導き出すことができる。その名前が示すように、このモデルは送金または決済取引の存在を示している。ユーザーはインプットで自身のUTXOを消費し、アウトプットで支払いのUTXOと交換のUTXO（同じユーザーに返されるお金）を満たした。

したがって、観察されたユーザーは、おそらく2つの出力UTXOのうちの1つ（支払UTXO）はもはや所有していないが、もう1つのUTXO（交換UTXO）はまだ所有していることがわかる。

今のところ、どの出力がどのUTXOを表しているかを特定することはできない。次のセクションで研究するヒューリスティックスに頼ることで、そこに到達する。この段階では、我々の目的は問題のトランザクションの性質を特定することに限定される。

例えば、単純な送信パターンを採用したビットコインの取引である：

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/fr/034.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

この最初の例を見れば、「トランザクションモデル」を研究することの意味がよく理解できるはずである。私たちは、環境や取引の具体的な詳細を考慮することなく、取引の構造のみに着目して取引を検討する。この最初のステップでは、全体像を見るだけである。

さて、パターンとは何かを理解したところで、他の既存のモデルに移ろう。

### 掃除

この第二のモデルは、入力としての単一UTXOの消費と出力としての単一UTXOの生産を特徴とする。

![BTC204](assets/fr/035.webp)

このモデルの解釈では、自己送金が行われていることになる。ユーザーはビットコインを自分自身へ、自分所有の別のアドレスへ送金した。この取引には交換がないため、決済が行われている可能性は極めて低い。実際、支払いが行われた場合、支払い者が売り手の要求額と取引手数料に正確に対応するUTXOを持つことはほとんど不可能である。従って、一般的に、支払人は交換アウトプットを生成する義務がある。

次に、観察されたユーザーはおそらくまだこのUTXOを所持していることがわかる。連鎖分析の文脈では、トランザクションの入力として使用されたUTXOがアリスのものであるこ とが分かれば、出力として使用されたUTXOもアリスのものであると仮定できる。後で面白くなるのは、この仮定を補強するトランザクション内部のヒューリスティックスを見つけることである（これらのヒューリスティックスについては3.3章で見る）。

例えば、スイープパターンを採用したビットコイン取引である：

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/fr/036.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d)

しかし、この種のパターンでは、暗号通貨交換プラットフォームの口座への自己送金が明らかになることもあるので注意が必要だ。それが自己保管ウォレットへのスワイプなのか、それともプラットフォームへの引き出しなのかを知るには、既知のアドレスと取引の文脈を調べる必要がある。実際、取引所プラットフォームのアドレスは簡単に特定できることが多い。

アリスの例をもう一度見てみましょう。スキャンがプラットフォーム（例えばBinanceなど）に知られたアドレスにつながる場合、これはビットコインがアリスの直接の所有から移されたことを意味するかもしれません。一方、送金先アドレスが不明な場合、それは単にアリスが所有する別のウォレットであると考えるのが妥当である。しかし、この種の研究はパターンというよりヒューリスティックの範疇に入る。

### 統合

このモデルの特徴は、入力で複数のUTXOを消費し、出力で単一のUTXOを生産することである。

![BTC204](assets/fr/037.webp)

このパターンを解釈すると、統合が進んでいることになる。これはビットコインユーザーの間では一般的な慣行で、取引手数料が上昇する可能性を見越して、複数のUTXOを統合することを目的としている。手数料が低い期間にこの操作を行うことで、将来の手数料を節約することができる。この慣行については4.3章で詳しく説明する。

このトランザクションモデルの背後にいるユーザーは、おそらく入力のすべてのUTXOを所有しており、出力のUTXOをまだ所有していると推測できる。つまり、おそらく自動転送である。

スイープと同様、この種のパターンもまた、取引所プラットフォームの口座への自己送金を明らかにすることができる。それが自己保管ポートフォリオへの統合なのか、それともプラットフォームへの出金なのかを知るには、既知のアドレスと取引の文脈を調べる必要がある。

例えば、これは連結パターンを採用したビットコイン取引である：

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/fr/038.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)

連鎖分析において、このモデルは多くの情報を明らかにすることができる。例えば、入力の1つがアリスのものであることが分かれば、このトランザク ションの他の入力と出力もすべてアリスのものであると仮定できる。この仮定により、以前の取引の連鎖をさかのぼり、アリスに関連しそうな他の取引を発見し分析することが可能になる。

![BTC204](assets/fr/039.webp)

### グループ支出

このモデルの特徴は、インプットとして少数のUTXOを消費し（多くの場合1つだけ）、アウトプットとして多数のUTXOを生産することである。

![BTC204](assets/fr/040.webp)

このモデルの解釈は、グループ化された支出が存在するということだ。これはおそらく、交流プラットフォームのような非常に大規模な経済活動を明らかにする慣行である。グループ化された支出は、これらのエンティティが単一のトランザクションで費用を組み合わせることによってコストを節約することを可能にします。

このモデルから推測できるのは、インプットのUTXOは経済活動レベルの高い企業からもたらされ、アウトプットのUTXOは分散するということである。その多くは、プラットフォームからビットコインを引き出した企業の顧客のものとなる。その他はパートナー企業に行くかもしれない。最後に、発行会社に戻る取引所が1つ以上あることは間違いない。

例えば、これはバンドル消費パターンを採用したビットコイン取引である（おそらくBybitプラットフォームが発行した取引である）：

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/fr/041.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### プロトコル固有のトランザクション

トランザクションパターンの中で、特定のプロトコルの使用を明らかにするものも識別できる。例えば、Whirlpoolのコイン結合（第5回で説明）には、他の従来型の取引とは異なる、容易に識別できる構造がある。

![BTC204](assets/fr/042.webp)

このパターンを分析すると、協調的な取引が行われている可能性が高い。コインジョインを観察することも可能である。この後者の仮説が正しいと証明されれば、退場者数からコインジョインの参加者数を大まかに推定することができる。

例えば、これはcoinjoin協調取引パターンを採用したビットコイン取引である：

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/fr/043.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

この他にも、独自の構造を持つプロトコルは数多くある。例えば、ワビサビ取引、スタンプ取引、ルーン取引などがある。

このようなトランザクションパターンのおかげで、私たちは与えられたトランザクショ ンに関するある程度の情報をすでに解釈することができる。しかし、分析のための情報源はトランザクション構造だけではない。その詳細についても研究することができる。これらの内部的な詳細は、私が「内部ヒューリスティック」と呼びたいものであり、次の章で見ていくことにする。

## 内部ヒューリスティック

<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>


内部ヒューリスティックとは、トランザクションの環境を調査することなく、トランザクション自体の中から特定し、推論を可能にする特定の特性のことである。高いレベルでトランザクションの全体的な構造に焦点を当てるパターンとは異なり、内部ヒューリスティックは抽出可能なデータの集合に基づいている。これには以下が含まれる：


- 様々なUTXOの出入りの量；
- スクリプトに関するあらゆること：受信アドレス、バージョン管理、ロックタイム...。

一般的に言って、この種のヒューリスティックは、特定の取引における交換を特定することを可能にする。そうすることで、複数の異なるトランザクションにわたってエンティティの追跡を継続することができる。実際、追跡したいユーザーが所有するUTXOを特定する場合、そのユーザーがトランザクションを実行したときに、どの出力が他のユーザーに転送され、どの出力が交換を表し、そのためそのユーザーが所有したままであるかを判断することが極めて重要である。

![BTC204](assets/fr/044.webp)

もう一度言っておくが、これらのヒューリスティックは絶対的に正確なものではない。個々に見れば、可能性の高いシナリオを特定できるに過ぎない。不確実性を完全に排除することはできなくても、不確実性を減らすのに役立つのは、いくつかのヒューリスティックの積み重ねなのだ。

### 内部の類似性

この発見的手法では、同じ取引のインプットとアウトプットの類似性を研究する。同じ特徴がインプットと取引のアウトプットの1つだけに観察される場合、このアウトプットが交換を構成している可能性が高い。

最も明白な特徴は、同一トランザクションにおける受信アドレスの再利用である。

![BTC204](assets/fr/045.webp)

このヒューリスティックは疑いの余地をほとんど残さない。彼の秘密鍵がハッキングされない限り、同じ受信アドレスは必然的に一人のユーザーの活動を明らかにする。その結果、取引交換は入力と同じアドレスの出力であると解釈される。そして、このやり取りから個人を追跡し続けることができる。

例えば、このヒューリスティックが適用できるであろうトランザクションを紹介しよう：

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/fr/046.webp)

Source : [Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

このような入力と出力の類似性は、アドレスの再利用にとどまらない。スクリプトの使い方に類似点があれば、ヒューリスティックを適用するために利用できる。例えば、入力とトランザクション出力の間で同じバージョニングが観察されることがある。

![BTC204](assets/fr/047.webp)

この図では、入力n° 0がP2WPKHスクリプト(`bc1q`で始まるSegWit V0)をアンロックしていることがわかる。出力n° 0は同じタイプのスクリプトを使用する。一方、出力n° 1はP2TRスクリプト（`bc1p`で始まるSegWit V1）を使用する。この特徴を解釈すると、入力と同じバージョニングのアドレスが交換アドレスである可能性が高い。したがって、常に同じユーザーに属することになる。

このヒューリスティックがおそらく適用できるであろう取引がある：

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/fr/048.webp)

Source : [Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)

後者では、入力番号0と出力番号1がP2WPKHスクリプト（SegWit V0）を使用しているのに対し、出力番号0は別のP2PKHスクリプト（Legacy）を使用していることがわかる。

2010年代初期には、利用可能なスクリプトの種類が限られていたため、スクリプトのバージョニングに基づくこのヒューリスティックは比較的役に立たなかった。しかし、時が経ち、Bitcoinが更新されるにつれて、スクリプトの種類はますます多様化している。そのため、スクリプトの種類が増えるにつれて、ユーザーはより小さなグループに分かれ、この内部バージョニング再利用ヒューリスティックが適用される可能性が高まるため、このヒューリスティックはますます意味を持つようになっています。このため、機密保持の観点からだけ言えば、最も一般的なタイプのスクリプトを選ぶことが望ましい。たとえば、この行を書いている時点では、Taprootスクリプト（`bc1p`）はSegWit V0スクリプト（`bc1q`）よりも使用頻度が低い。前者は、特定の文脈では経済的および機密保持上の利点を提供するが、より伝統的な単一署名の用途では、新しい標準がより広く採用されるまで、機密保持上の理由から古い標準に固執することが理にかなっているかもしれない。

### ラウンド数の支払い

交換を識別するのに役立つもう一つの内部ヒューリスティックは、ラウンド・ナンバー・ヒューリスティックである。一般的に、単純な支払いパターン（1つの入力と2つの出力）に直面したとき、出力の1つが丸い金額を使った場合、これは支払いを表している。

![BTC204](assets/fr/049.webp)

消去法では、一方の出力が支払いを表す場合、他方は交換を表す。したがって、入力ユーザーは常に、交換として特定された出力を手にしている可能性が高いと解釈できる。

このヒューリスティックが常に適用されるわけではないことを強調しておく。実際、フランスの小売業者がビットコインを受け入れる場合、一般的に安定した価格をサッツで表示することはない。その代わりに、ユーロ建て価格とビットコイン建て支払額の換算を選択する。そのため、取引終了時に丸数字は表示されない。

とはいえ、アナリストはトランザクションがネットワーク上でブロードキャストされたときの為替レートを考慮して、この換算を試みることができる。97,552sats`の入力と、31,085sats`と64,152sats`の2つの出力の取引を例にとってみよう。一見したところ、この取引には丸い金額は含まれていないように見える。しかし、取引時の為替レート64,339ユーロを適用すると、以下のようにユーロに換算される：


- 投入額は62.76ユーロ；
- 生産高は20ユーロ；
- 出力は41.27ユーロ。

一旦不換紙幣に変換されると、この取引はラウンド金額支払いヒューリスティックを適用するために使用することができる。20ユーロの出力はおそらく商人に渡った、あるいは少なくとも所有者が変わった。差し引き、41.27ユーロの出力は元のユーザーが所有したままである可能性が高い。

![BTC204](assets/fr/050.webp)

いつの日か、ビットコインが取引所での口座単位として好まれるようになれば、このヒューリスティックは分析にさらに役立つだろう。

例えば、このヒューリスティックが適用できるであろうトランザクションを紹介しよう：

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/fr/051.webp)

Source : [Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)

### 最大出力

単純な支払いモデルにおいて、2つの取引アウトプットの間に十分に大きなギャップがあることを確認した場合、最大のアウトプットは外国為替である可能性が高いと推定できる。

![BTC204](assets/fr/052.webp)

この最大出力ヒューリスティックは、最も不正確なものであることは間違いない。それだけではかなり弱い。しかし、この特徴を他のヒューリスティックと組み合わせることで、解釈の不確実性を減らすことができる。

例えば、丸い支払額と大きい支払額の取引を見る場合、丸い支払額のヒューリスティックと大きい支払額のヒューリスティックを一緒に適用することで、不確実性のレベルが下がる。

例えば、このヒューリスティックが適用できるであろうトランザクションを紹介しよう：

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/fr/053.webp)

Source : [Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## 外部ヒューリスティック

<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>


外部ヒューリスティックの研究とは、取引そのものに特有ではない特定の要素の類似性、パターン、特徴を分析することである。言い換えれば、以前は内部ヒューリスティックによって取引に内在する要素を利用することに限定していたが、現在は外部ヒューリスティックによって取引の環境まで分析領域を広げているのである。

### 住所再利用

これはビットコイナーの最もよく知られたヒューリスティックスの一つである。アドレスの再利用は、異なるトランザクションと異なるUTXO間のリンクを確立することを可能にする。これは、ビットコインの受信アドレスが数回使用された場合に発生する。

従って、（前章で見たように）交換を識別するための内部ヒューリスティックとして、同一トランザク ション内でのアドレス再利用を利用することは可能である。しかしアドレスの再利用は、複数のトランザクショ ンの背後にあるエンティティの一意性を認識するための外部ヒューリスティックとしても利用できる。

アドレスの再利用の解釈は、そのアドレスでブロックされたすべてのUTXOが同じエンティティに属する（または属していた）ということである。このヒューリスティックは不確実性の余地をほとんど残さない。一旦識別されれば、結果として得られる解釈は現実に対応する可能性が高い。したがって、異なるオンチェーン活動をグループ化することができる。

![BTC204](assets/fr/054.webp)

第3部の冒頭で説明したように、このヒューリスティックはサトシ・ナカモト自身が発見したものである。ホワイトペーパーの中で、彼はユーザーがこのヒューリスティックの発生を避けるための解決策に言及している：

"追加のファイアウォールとして、各トランザクションに新しいキー・ペアを使用し、共通の所有者にリンクされないようにすることができる。"

![BTC204](assets/fr/055.webp)

出典S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

例えば、複数のトランザクションで再利用されるアドレスがある：

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/056.webp)

提供 : [Mempool.space](https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### スクリプトの類似性と財布の刻印

アドレスの再利用だけでなく、同じポートフォリオやアドレス・クラスターにアクションをリンクさせるヒューリスティックな方法は他にもたくさんある。

まず、分析者はスクリプトの使用法の類似性を探すことができる。たとえば、multisigのような特定の少数派スクリプトは、SegWit V0スクリプトよりも見つけやすいかもしれません。私たちが隠れているグループが大きければ大きいほど、私たちを見つけるのは難しくなります。これは、優れたCoinjoinプロトコルにおいて、すべての参加者が全く同じ種類のスクリプトを使用する理由の一つです。

より一般的には、アナリストはポートフォリオの特徴的な指紋に注目することもできる。これらは、トレース・ヒューリスティックとして利用することを視野に入れて特定することができる用途に特化したプロセスである。言い換えれば、トレースされたエンティティに帰属する取引において、同じ内部特性の集積が観察された場合、他の取引におけるこれらと同じ特性の特定を試みることができる。

例えば、追跡されたユーザーが組織的にP2TRアドレス(`bc1p...`)に変更を送信していることを特定できるだろう。もしこのプロセスが繰り返されるのであれば、残りの分析にヒューリスティックとして使うことができます。また、UTXO の順番、出力における変更の場所、RBF (Replace-by-Fee) シグナリング、あるいはバージョン番号、`nSequence` フィールド、`nLockTime` フィールドのような他のフィンガープリントを使うこともできる。

![BTC204](assets/fr/057.webp)

Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji)（フランス語のポッドキャスト）で [@LaurentMT](https://twitter.com/LaurentMT)が指摘しているように、連鎖分析におけるポートフォリオのフィンガープリントの有用性は時間の経過とともに著しく高まっています。実際、スクリプトタイプの増加とポートフォリオソフトウェアによるこれらの新機能のますます進歩的な展開はその違いを際立たせています。場合によっては、追跡されるエンティティによって使用される正確なソフトウェアを特定することさえ可能です。したがって、ポートフォリオの足跡の研究は、2010年代初頭に開始されたものではなく、最近の取引に特に関連性があることを理解することが重要である。

要約すると、フットプリントとは、ウォレットが自動的に、またはユーザーが手動で実行した、他のトランザクションで見つけることができる、分析に役立つ特定のプラクティスのことである。

### 共通入力所有ヒューリスティック（CIOH）

共通入力所有ヒューリスティック（Common Input Ownership Heuristic：CIOH）とは、ある取引に複数の入力がある場合、それらの入力はすべて単一の主体から発せられる可能性が高いというヒューリスティックである。したがって、それらの所有権は共通である。

![BTC204](assets/fr/058.webp)

CIOHを適用するには、まずいくつかの入力を持つ取引を観察する。これは2入力かもしれないし、30入力かもしれない。この特徴が特定されたら、その取引が既知の取引モデルに当てはまるかどうかをチェックする。例えば、ほぼ同じ金額の5つの入力と全く同じ金額の5つの出力があれば、これはコインジョインの構造であることがわかる。CIOHを適用することはできない。

![BTC204](assets/fr/059.webp)

一方、トランザクションが既知の協調的トランザクションモデルに当てはまらない場合、すべての入力は同じエンティティから来ている可能性が高いと解釈できる。これは既に知られているクラスターを拡張したり、トレースを継続したりするのに非常に有用である。

![BTC204](assets/fr/060.webp)

CIOHはサトシ・ナカモトによって発見された。彼は白書のパート10でそれについて語っている：

「リンクはマルチ・エントリー取引では不可避であり、必然的にそのエントリーが同じ所有者によって保持され ていることが明らかになる。リスクは、キーの所有者が明らかになった場合、リンクによって同じ所有者に属する他の取引が明らかになる可能性があることである。

![BTC204](assets/fr/061.webp)

サトシ・ナカモトがビットコインの正式なローンチ以前から、CIOHとアドレスの再利用という、ユーザーにとっての2つの主要なプライバシーの脆弱性をすでに特定していたことは特に興味深い。この2つのヒューリスティックは現在でもブロックチェーン分析において最も有用であるため、このような先見性は非常に注目に値する。

例を挙げると、CIOHを適用できる可能性のある取引がある：

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

![BTC204](assets/fr/062.webp)

Source : [Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### オフチェーンデータ

もちろん、チェーン分析はオンチェーンデータだけに限定されるものではない。過去に分析したデータやインターネット上で入手可能なデータであれば、分析を改良するために使用することもできる。

例えば、トレースされたトランザクションが同じビットコインノードから体系的にブロードキャストされていることを観察し、そのIPアドレスを特定することに成功すれば、同じエンティティからの他のトランザクションを特定することができるかもしれないし、発行者のアイデンティティの一部を決定することもできるかもしれない。この方法は多数のノードを操作する必要があるため、簡単には実現できないが、ブロックチェーン分析を専門とする一部の企業では採用されている可能性がある。

分析者はまた、以前にオープンソースで公開された分析結果や、自分自身の過去の分析結果に頼るという選択肢もある。おそらく、すでに特定したアドレスのクラスターを指し示す出力を見つけることができるだろう。これらの企業のアドレスは一般的に知られているため、交換プラットフォームを指す出力に頼ることもできる。

同様に、消去法による分析も可能である。例えば、2つの出力があるトランザクションを分析するとき、そのうちの1つがすでに知られているアドレスクラスタに関連しているが、トレースしているエンティティとは異なる場合、もう1つの出力はおそらく交換を表していると解釈できる。

チャンネル分析には、インターネット検索を含む、やや一般的なOSINT（*オープンソースインテリジェンス*）の要素も含まれる。そのため、偽名であろうとなかろうと、ソーシャルネットワークやウェブサイトでアドレスを直接公開することは控えるようアドバイスしている。

![BTC204](assets/fr/063.webp)

### 時間モデル

私たちはあまり意識しないが、ある種の人間の行動はオンチェーンで認識できる。おそらく分析に最も役立つのは睡眠パターンだろう！そう、寝ているときはビットコインのトランザクションをブロードキャストしない。しかし、あなたは一般的にほぼ同じ時間に眠ります。これが、ブロックチェーン分析で時間分析を使うのが一般的な理由です。端的に言えば、これは特定のエンティティのトランザクションがビットコインネットワークにブロードキャストされる時間の国勢調査です。これらの時間的パターンを分析することで、豊富な情報を推測することができる。

まず第一に、時間的分析によって、追跡された実体の性質を特定できることがある。取引が24時間にわたって一貫して放送されていることが確認されれば、これは高度な経済活動を裏切ることになる。このような取引の背後にある企業は、国際的な企業である可能性が高く、おそらく自動化された社内手続きを持つ企業であろう。

例えば、[手数料に19ビットコインを誤って割り当てた取引](https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd)を分析したとき、[数ヶ月前にこのパターンに気づいた](https://twitter.com/Loic_Pandul/status/1701127409712452072)。単純な時間的分析によって、私たちは自動化されたサービスを扱っており、したがっておそらく取引所プラットフォームのような大規模な組織と取引しているのだろうという仮説を立てることができた。

実際、数日後、その資金はパクソスの取引所プラットフォームを通じてペイパルのものであることが判明した。

逆に、時間的なパターンが特定の16時間にわたって広がっていることがわかれば、個人ユーザー、あるいは交換された量によっては地元企業であると推定できる。

観察されたエンティティの性質だけでなく、時間的パターンは、タイムゾーンのおかげで、ユーザーがどこにいるのかをおおよそ教えてくれる。このようにして、他のトランザクションを照合し、そのタイムスタンプを分析に追加できる追加ヒューリスティックとして使用することができる。

たとえば、先ほどのマルチユース・アドレスでは、トランザクションが入出ともに13時間間隔に集中していることがわかる。

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/064.webp)

提供 : OXT.me

この範囲はおそらくヨーロッパ、アフリカ、中東に相当する。したがって、これらの取引の背後にいるユーザーはこれらの地域に住んでいると推測できる。

また、この種の時間分析によって、サトシ・ナカモトは日本からではなく、アメリカから活動していたという仮説も導き出された：[*サトシ・ナカモトのタイムゾーン*](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## ブロック・エクスプローラーで実践する

<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

この最終章では、これまで勉強してきたコンセプトを実践していきます。実際のビットコイン取引の例をお見せしますので、私が求める情報を抽出してください。

理想的には、これらの演習を実行するには、プロのチェーン分析ツールを使用することが望ましいでしょう。しかし、Samourai Walletのクリエイターが逮捕されて以来、唯一の無料分析ツールOXT.meは利用できなくなってしまいました。そのため、この演習では古典的なブロックエクスプローラーを使用することにします。私は、その多くの機能とチェーン分析ツールの範囲のために[Mempool.space](https://mempool.space/)を使用することをお勧めしますが、[Bitcoin Explorer](https://bitcoinexplorer.org/)のような他のエクスプローラを選択することもできます。

まずはじめに、練習問題を紹介しよう。ブロック・エクスプローラーを使って問題を解き、解答を紙に書いてください。そして、この章の最後に、あなたが結果をチェックし、修正できるように、答えを提供します。

*これらの演習のために選択された取引は、純粋にその特徴から、やや無作為に選ばれたものである。本章は教育的かつ情報提供のみを目的としている。悪意ある目的でのこれらのツールの使用を支持も推奨もしないことを明言しておきたい。目的は、文字列解析から身を守る方法を教えることであり、他人の個人情報を暴露するために解析を行うことではありません*。

### エクササイズ1

分析対象のトランザクションの識別子：

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

このトランザクションのモデル名は何か。また、そのモデル、すなわちトランザクションの構造だけを検討することによって、どのようなもっともらしい解釈が導き出されるのか。

### エクササイズ2

分析対象のトランザクションの識別子：

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

このトランザクションのモデル名は何か。また、そのモデル、すなわちトランザクションの構造だけを検討することによって、どのようなもっともらしい解釈が導き出されるのか。

### エクササイズ3

分析対象のトランザクションの識別子：

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

この取引のモデルは何ですか？

トランザクションの内部ヒューリスティックを使用して、そのモデルを特定した後、交換はどのようなアウトプットを表す可能性が高いか？

### 練習4

分析対象のトランザクションの識別子：

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

この取引のモデルは何ですか？

トランザクションの内部ヒューリスティックを使用して、そのモデルを特定した後、交換はどのようなアウトプットを表す可能性が高いか？

### エクササイズ5

ロイックがビットコインの受け取りアドレスをソーシャルネットワークのツイッターに投稿したとしよう：

![BTC204](assets/fr/065.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

この情報に基づき、**アドレス再利用ヒューリスティック**のみを使用して、どのビットコイン取引がロイックのアイデンティティにリンクできますか？

*明らかに、私はこの受信アドレスの本当の所有者ではないし、ソーシャルネットワークに投稿したわけでもない。ブロックチェーン*からランダムに取ったアドレスなんだ。

### エクササイズ6

演習 5 の後、アドレス再利用ヒューリスティックのおかげで、ロイックが関与していると思われるビットコイン取引をいくつか特定できました。通常、特定されたトランザクションの中で、あなたはこのトランザクションを発見するはずです：

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
```

この取引はLoïcのアドレスへの最初の送金です。この取引でLoïcが受け取ったビットコインはどこから来たと思いますか？

### エクササイズ7

練習5に従い、アドレス再利用ヒューリスティックのおかげで、あなたはLoïcが関与していると思われるいくつかのビットコイン取引を特定することができました。次に、Loïc がどこから来たかを調べます。見つかったトランザクションに基づいて、時間分析を実行し、Loïcが使用している可能性が最も高いタイムゾーンを見つけます。このタイムゾーンから、Loïcが住んでいると思われる場所（国、州/地域、都市...）を特定します。

![BTC204](assets/fr/066.webp)

### エクササイズ8

ここで、ビットコインの取引を研究してみよう：

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

この取引だけを見て、どのような解釈ができるだろうか？

### エクササイズ・ソリューション

***エクササイズ1

この取引のモデルは単純な支払いモデルである。その構造だけを調べると、1つの出力は交換を表し、もう1つの出力は実際の支払いを表すと解釈できる。したがって、観察されたユーザーは、おそらく出力された2つのUTXOのうちの1つ（支払いのUTXO）はもはや所有していないが、もう1つのUTXO（交換のUTXO）はまだ所有していることがわかる。

***エクササイズ2

この取引のモデルは、グループ支出である。このモデルはおそらく、交換プラットフォームのような大規模な経済活動を示している。インプットのUTXOは経済活動の盛んな企業からのものであり、アウトプットのUTXOは分散していると推測できる。あるものは、ビットコインを自己保管ウォレットに引き出した企業の顧客のものでしょう。また、パートナー企業に渡るものもあるだろう。最後に、発行会社に戻る交換も間違いなくあるだろう。

***エクササイズ3

この取引のモデルは単純な支払いである。したがって、取引に内部ヒューリスティックを適用して、交換を特定しようとすることができる。

私は個人的に、同じ仮説を支持する少なくとも2つの内部ヒューリスティックを特定した：


- 同じタイプのスクリプトの再利用；
- 最大出力。

最も明白なヒューリスティックは、同じタイプのスクリプトを再利用することである。実際、出力 `0` は `P2SH` であり、受信アドレスが `3` で始まることで認識できる：

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

出力 `1` は `bc1q` で始まるアドレスで識別可能な `P2WPKH` である：

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

このトランザクションの入力として使用されるUTXOも `P2WPKH`スクリプトを使用している：

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

したがって、出力`0`は支払いに対応し、出力`1`は取引交換であると仮定することができる。これは、入力ユーザーが常に出力`1`を所有していることを意味する。

この仮説を支持または反証するために、私たちは自分の考えを確認するか、あるいは仮説が正しい確率を下げるような他のヒューリスティクスを探すことができる。

私は少なくとももう1つのヒューリスティックを特定した。それは最大の出力ヒューリスティックだ。出力 `0` は `123,689 sats` を計測し、出力 `1` は `505,839 sats` を計測する。したがって、この2つの出力には大きな差がある。最大アウトプットのヒューリスティックは、最大アウトプットは外国為替である可能性が高いことを示唆している。このヒューリスティッ クは、最初の仮説をさらに強化するものである。

したがって、入力としてUTXOを供給したユーザーは、トランザクションの交換を具現化すると思われる`1`出力をまだ保持している可能性が高いと思われる。

***エクササイズ4:***

この取引のモデルは単純な支払いである。したがって、取引に内部ヒューリスティックを適用して、交換を特定しようとすることができる。

私は個人的に、同じ仮説を支持する少なくとも2つの内部ヒューリスティックを特定した：


- 同じタイプのスクリプトの再利用；
- ラウンドポストの出力。

最も明白なヒューリスティックは、同じタイプのスクリプトを再利用することである。実際、出力 `0` は `P2SH` であり、受信アドレスが `3` で始まることで認識できる：

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

出力 `1` は `bc1q` で始まるアドレスで識別可能な `P2WPKH` である：

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

このトランザクションの入力として使用されるUTXOも `P2WPKH`スクリプトを使用している：

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

したがって、出力`0`は支払いに対応し、出力`1`は取引交換であると仮定することができる。これは、入力ユーザーが常に出力`1`を所有していることを意味する。

この仮説を支持または反証するために、私たちは自分の考えを確認するか、あるいは仮説が正しい確率を下げるような他のヒューリスティクスを探すことができる。

私は少なくとももう1つのヒューリスティックを特定した。それはラウンド量出力だ。出力 `0` は `70,000 sats` を計測し、出力 `1` は `22,962 sats` を計測する。したがって、BTC単位で完全に丸い出力がある。ラウンド出力ヒューリスティックは、ラウンド金額を持つUTXOが支払いのものである可能性が最も高く、消去により、他は交換を表すことを示唆している。このヒューリスティックは、最初の仮説をさらに強化する。

しかしこの例では、別のヒューリスティックが最初の仮説を覆す可能性がある。確かに、出力`0`は出力`1`より大きい。最大の出力は一般的に外国為替であるというヒューリスティックに基づけば、出力 `0` は外国為替であると推論できる。しかし、他の2つのヒューリスティックは最大出力ヒューリスティックよりもかなり説得力があるように見えるので、この逆仮説はありえないように思われる。したがって、この明らかな矛盾にもかかわらず、最初の仮説を維持することは合理的であると思われる。

したがって、入力としてUTXOを供給したユーザーは、トランザクションの交換を具現化すると思われる`1`出力をまだ保持している可能性が高いと思われる。

***エクササイズ5:***

8つの取引がロイックのIDに関連付けられることがわかる。このうち、4件はビットコインの受領に関係している：

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
8b70bd322e6118b8a002dbdb731d16b59c4a729c2379af376ae230cf8cdde0dd
d5864ea93e7a8db9d3fb113651d2131567e284e868021e114a67c3f5fb616ac4
bc4dcf2200c88ac1f976b8c9018ce70f9007e949435841fc5681fd33308dd762
```

残りの4つはビットコインの出荷に関するものだ：

```plaintext
8b52fe3c2cf8bef60828399d1c776c0e9e99e7aaeeff721fff70f4b68145d540
c12499e9a865b9e920012e39b4b9867ea821e44c047d022ebb5c9113f2910ed6
a6dbebebca119af3d05c0196b76f80fdbf78f20368ebef1b7fd3476d0814517d
3aeb7ce02c35eaecccc0a97a771d92c3e65e86bedff42a8185edd12ce89d89cc
```

***エクササイズ6:***

この取引のモデルを見ると、バンドル支出であることは明らかである。実際、この取引には1つの入力と51の出力があり、経済活動のレベルが高いことを示している。したがって、ロイックは取引所プラットフォームからビットコインを引き出したという仮説を立てることができる。

いくつかの要因がこの仮説を補強している。第一に、UTXOの入力を保護するために使用されたスクリプトのタイプは、P2SH 2/3マルチシグスクリプトであり、これは取引所プラットフォームの典型的な高度なセキュリティレベルを示している：

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```

さらに、調査されたアドレス`3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF`は22万件以上の異なる取引で再利用されており、これは一般的に秘密保持に無頓着な取引所プラットフォームによく見られる特徴である。

このアドレスに適用された時間的ヒューリスティックも、3ヶ月間にわたってほぼ毎日、24時間以上にわたって取引が定期的に放送されていることを示しており、取引所プラットフォームの継続的な活動を示唆している。

最後に、このエンティティが扱う量は膨大である。このアドレスは2022年12月から2023年3月までの間に222,262件の取引で44BTCを送受信している。このような大量の取引は、取引所プラットフォームの活動である可能性が高いことをさらに裏付けている。

***エクササイズ7:***

取引確認時刻を分析することにより、以下のUTC時刻を特定することができる：

```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

これらのスケジュールを分析すると、UTC-7とUTC-8は、ほとんどのスケジュールにおいて、現在の人間活動の範囲（08:00から23:00の間）と一致していることがわかる：

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7
05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

![BTC204](assets/fr/066.webp)




- カリフォルニア州（ロサンゼルス、サンフランシスコ、サンディエゴなどの都市がある）；
- ネバダ州（ラスベガスを含む）；
- オレゴン州（ポートランドを含む）；
- ワシントン州（シアトルと一緒）；
- カナダのブリティッシュ・コロンビア州（バンクーバーやビクトリアなどの都市がある）。

この情報から、ロイックはアメリカ西海岸かカナダに住んでいる可能性が高い。

***エクササイズ8:***

このトランザクションを分析すると、5つの入力と1つの出力があり、連結が示唆される。CIOHヒューリスティックを適用すると、入力のUTXOはすべて1つのエンティティが所有し、出力のUTXOもこのエンティティに属すると仮定できる。このユーザーは、自分が所有する複数のUTXOをグループ化し、出力のUTXOを1つにすることを選択したようだ。この動きはおそらく、将来のコストを削減するために、当時の低い取引コストを利用したいという願望が動機となっているのだろう。

___

*チェーン分析に関するこのパート3を書くにあたり、私は以下の資料を参考にした。


- OXTでビットコインのプライバシーを理解する](https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923)と題された4つの記事のシリーズは、2021年にSamourai Walletによって制作された;*。
- OXT Research](https://medium.com/oxt-research)の様々なレポートや、無料のブロックチェーン分析ツール（Samourai Walletの創設者が逮捕されたため、現在は利用できません）;*。
- もっと広く言えば、私の知識は[@LaurentMT](https://twitter.com/LaurentMT)と[@ErgoBTC](https://twitter.com/ErgoBTC)の様々なツイートやコンテンツから得ている;*。
- louneskmt](https://twitter.com/louneskmt)、[@TheoPantamis](https://twitter.com/TheoPantamis)、[@Sosthene___](https://twitter.com/Sosthene___)、[@LaurentMT](https://twitter.com/LaurentMT)と共に参加した[スペースケク#19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji)*。

*その作者、開発者、プロデューサーに感謝したい。また、このパート3のベースとなった記事を丹念に添削し、専門的なアドバイスをくれた校正者にも感謝する:*。


- [ジル・カディニャン](https://twitter.com/gillesCadignan) ;*
- [ルドヴィク・ラース](https://viresinnumeris.fr/)

# プライバシー保護のベストプラクティスをマスターする

<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## 住所再利用

<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>


ビットコインの機密性を破るテクニックを研究してきたので、この第3部では、自分自身を守るために採用すべきベストプラクティスを見ていこう。このパートの目的は、後で扱う機密性を向上させる方法を探ることではなく、むしろ、追加のテクニックに頼ることなく、ビットコインが自然に提供する機密性を保持するために、ビットコインと正しくやり取りする方法を理解することです。

この第3部を始めるにあたって、アドレスの再利用について話をするのは明らかだ。この現象はユーザーの機密性を脅かす主なものである。この章は、このコース全体の中で最も重要であることは間違いない。

### 受信アドレスとは？

ビットコイン受け取りアドレスは、ウォレットでビットコインを受け取るために使用される文字列または識別子です。

厳密には、ビットコインの受け取りアドレスは、文字通りの意味でビットコインを「受け取る」のではなく、ビットコインを使用できる条件を定義する役割を果たします。具体的に言うと、あなたに支払いが送られると、送信者のトランザクションは、入力として消費したUTXOから出力としてあなたのために新しいUTXOを作成します。この出力には、このUTXOを後日どのように使用するかを定義するスクリプトが付加される。このスクリプトは「*ScriptPubKey*」または「*Locking Script*」として知られています。あなたの受信アドレス、より正確にはそのペイロードは、このスクリプトに組み込まれています。平たく言えば、このスクリプトは基本的に次のように記述する：

> "*この新しいUTXOを使用するには、この受信アドレスに関連付けられた秘密鍵を使用してデジタル署名を提供する必要があります。"
![BTC204](assets/fr/067.webp)

ビットコインアドレスには、使用されるスクリプトモデルによって異なるタイプがあります。レガシー*」として知られる最初のモデルには、`P2PKH`（*Pay-to-PubKey-Hash*）アドレスと`P2SH`（*Pay-to-Script-Hash*）アドレスがある。P2PKHアドレスは常に `1` で始まり、P2SHアドレスは `3` で始まる。P2PKHアドレスは常に `1` から始まり、P2SHアドレスは `3` から始まる。まだ安全ではあるが、これらの形式は取引コストが高く、新しい標準よりも機密性が低いため、現在では廃止されている。

SegWit V0（`P2WPKH`と`P2WSH`）とTaproot / SegWit V1（`P2TR`）アドレスは最新のフォーマットを表している。SegWitアドレスは`bc1q`で始まり、2021年に導入されたTaprootアドレスは`bc1p`で始まる。

例えば、タプロットの受信アドレスです：

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

ScriptPubKeyをどのように構築するかは、使用する規格によって異なります：

| ScriptPubKey｜スクリプトテンプレート

| ---------------- | ----------------------------------------------------------- |

| P2PKH｜OP_DUP OP_HASH160 `<pubKeyHash>` OP_EQUALVERIFY OP_CHECKSIG｜OP_EQUALVERIFY OP_CHECKSIG

| P2SH｜OP_HASH160 `<scriptHash>` OP_EQUAL｜P2SH｜OP_HASH160 `<scriptHash>` OP_EQUAL｜OP_EQUAL

| P2WPKH｜0 `<pubKeyHash>`｜｜P2WPKH｜0 `<pubKeyHash>`｜｜P2WPKH

| P2WSH | 0 `<witnessScriptHash>` |

| P2SH - P2WPKH｜OP_HASH160 `<RedeemScriptHash>` OP_EQUAL｜P2SH - P2WPKH｜OP_HASH160 `<RedeemScriptHash>` OP_EQUAL｜OP_EQUAL

| P2SH - P2WSH｜OP_HASH160 `<RedeemScriptHash>` OP_EQUAL｜P2SH - P2WSH｜OP_HASH160 `<RedeemScriptHash>` OP_EQUAL｜OP_EQUAL

| P2TR | 1 `<pubKey>`

受信アドレスの構築は、選択したスクリプトモデルにも依存する：


- P2PKH`と`P2WPKH`アドレスの場合、ペイロード、つまりアドレスのコアは 公開鍵のハッシュを表す；
- P2SH` と `P2WSH` アドレスの場合、ペイロードは .NET Framework のハッシュを表す；
- P2TRアドレスに関しては、ペイロードは微調整された公開鍵である。P2TRの出力は、_Pay-to-PubKey_と_Pay-to-Script_を組み合わせたものである。微調整された公開鍵は、古典的な支出公開鍵に「微調整」を加えたもので、ビットコインの支出にも使用できるスクリプトのセットのメルクルルートから派生したものである。

![BTC204](assets/fr/068.webp)

ポートフォリオ・ソフトウェアに表示されるアドレスには、HRP（*Human-Readable Part*）、通常ポストSegWitアドレスの場合は`bc`、セパレーターの`1`、SegWit V0の場合はバージョン番号の`q`、Taproot/SegWit V1の場合は`p`も含まれます。また、送信中のアドレスの完全性と有効性を保証するためにチェックサムも追加される。

最後に、アドレスは標準的なフォーマットにまとめられる：


- 古いレガシーアドレスの Base58check ；
- SegWit アドレス用 Bech32 ；
- Taprootアドレス用Bech32m。

以下はbech32とbech32mフォーマット（SegWitとTaproot）のベース10からの加算行列である：

| + | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |

| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| 0｜q｜p｜z｜r｜y｜9｜x｜8



| 16｜s｜3｜j｜n｜5｜4｜k｜h

| 24 | c | e | 6 | m | u | a | 7 | l |

### アドレスの再利用とは？

アドレス再利用とは、複数の異なるUTXOをブロックするために同じ受信アドレスを使用することである。

前のセクションで見たように、各UTXOは独自のScriptPubKeyを持っている。このScriptPubKeyはUTXOをロックし、UTXOが新しいトランザクションの入力として消費されるためには満たされなければならない。このScriptPubKeyにペイロードアドレスが統合される。

異なるScriptPubKeyに同じ受信アドレスが含まれている場合、これをアドレスの再利用と呼びます。実際には、ユーザーが複数の支払いでビットコインを受け取るために、同じアドレスを繰り返し送信者に提供していることを意味します。そして、このような行為こそが、あなたのプライバシーを破壊するのです。

### なぜアドレスの再利用が問題になるのか？

ブロックチェーンは公開されているため、どのアドレスがどのUTXOを何ビットコインロックしているかは簡単にわかる。同じアドレスが複数の取引に使用されている場合、そのアドレスに関連するすべてのビットコインが同一人物のものであると推測することが可能になる。このやり方は、異なる取引の間に決定論的なリンクを確立し、ブロックチェーン上でビットコインを追跡できるようにすることで、ユーザーのプライバシーを損なうことになる。サトシ・ナカモト自身、ビットコインのホワイトペーパーですでにこの問題を強調している：

> *追加のファイアウォールとして、トランザクションごとに新しい鍵のペアを使用し、共通の所有者*にリンクされないようにすることができる。
![BTC204](assets/fr/055.webp)

出典S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

この一文に込められたサトシの意図は、ユーザーのアイデンティティとビットコイン上のキー・ペアが関連づけられた場合に追加のファイアウォールを作り、ユーザーの活動全体が公に彼のアイデンティティにリンクされるのを防ぐことだった。今日、ブロックチェーン分析企業やKYC規制の普及に伴い、固有アドレスの使用はもはや「追加のファイアウォール」ではなく、最低限のプライバシーを守りたい人にとって不可欠な慣行となっている。

アドレスを再利用すると、そのアドレスに関連するすべての取引の間に、ほとんど否定できないリンクができます。楕円曲線暗号が秘密鍵の安全性を保証しているため、これが直接あなたの資金を危険にさらすことはないが、あなたの活動を監視することは容易になる。実際、ノードを持つ誰もがアドレスの取引と残高を観察することができ、あなたの匿名性は完全に損なわれる。

![BTC204](assets/fr/054.webp)

この点を説明するために、DCAで少額のビットコインを定期的に購入し、いつも同じアドレスに送金しているユーザー、ボブを例にとってみよう。2年後、このアドレスにはかなりの量のビットコインが入っている。ボブがこのアドレスを使って地元の商人に支払いを行うと、商人は関連するすべての資金を見ることができ、ボブの富を推測することができる。これは、窃盗や恐喝を試みるなど、個人的なセキュリティリスクにつながる可能性がある。もしボブが、定期的な購入のたびに空白のアドレスを使っていたなら、商人に明かす情報は限りなく少なくて済んだだろう。

文字列解析では、2種類のアドレス再利用がある：


- 外部再利用；
- トランザクション内での内部再利用。

1つ目は、アドレスが複数の異なるビットコイン取引で再利用される場合である。このヒューリスティックは、このアドレスを通過したすべてのUTXOが単一のエンティティに属すると推論する。

内部アドレスの再利用は、再利用が複数のトランザクションにまたがって発生する場合ではなく、1 つのトランザクション内で発生する場合に発生する。実際、入力をロックするために使用された同じアドレスがトランザクションの出力として使用された場 合、この出力は依然として同じユーザー（取引所）に属し、2番目の出力は実際の支払いを表していると推論できる。この他の発見的手法により、複数のトランザクションにわたって資金トレースを永続させることが可能になる。

![BTC204](assets/fr/045.webp)

アドレスの再利用は、ビットコインの本当の惨劇である。OXT.meのウェブサイト（現在はアクセスできない）によると、ビットコインにおけるアドレス再利用の全体的な割合は、2022年には約52％だった：

![BTC204](assets/fr/069.webp)

この割合は莫大なものだが、個人ユーザーよりもむしろ取引所プラットフォームからのものが圧倒的に多い。

### アドレスの再利用を避けるには？

アドレスの再利用を避けるのはとても簡単です： **ウォレットへの新しい支払いには、新しい空白のアドレスを使用するだけです。

BIP32のおかげで、最新のポートフォリオは決定論的かつ階層的になった。つまり、ユーザーはシードという単一の初期情報から多数のアドレスを生成することができる。この単一の情報を保存することで、ポートフォリオ内のすべての秘密鍵を復元することが可能になり、対応するアドレスで保護された資金へのアクセスが可能になります。

![BTC204](assets/fr/070.webp)

このため、ウォレットソフトウェアの「*受信*」ボタンを押すと、毎回未使用の受信アドレスが提案されます。このアドレスでビットコインを受け取った後、ソフトウェアは自動的に新しいアドレスを提案します。

> *追記：最近、一部のウォレットソフトウェアが、当局によるマネーロンダリングの一種と見なされることを恐れ、空白アドレスの生成を停止する意向を表明しました。もしお使いのソフトウェアがこのようなものであれば、直ちに交換することを強くお勧めします。
寄付などの支払いを受け取るために静的な識別子が必要な場合、再利用のリスクがあるため、古典的なビットコインアドレスを使用することはお勧めできません。代わりに、Lightningアドレスを使用するか、BIP47やSilent Paymentsのような静的なオンチェーン決済識別子を選択します。これらのプロトコルについては、このトレーニングコースのパート6で詳しく説明しています。

## 部品のラベリングとチェック

<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>


文字列解析のセクションで発見したように、トランザクションに関する情報を推測するた めに使用できるヒューリスティックな手法やパターンは数多く存在する。ユーザーとして、これらのテクニックからよりよく身を守るために、これらのテクニックを知っておくことは重要である。

つまり、UTXOの出所を把握し、支払いの際に消費するUTXOを慎重に選択する必要があります。この効率的なウォレット管理は、優れたビットコインウォレットの2つの重要な機能、タグ付けとコイン管理に依存しています。

この章では、これらの機能を見て、ビットコインでのプライバシーを大幅に最適化するために、作業負荷をあまり増やすことなく、どのようにインテリジェントに使用できるかを見ていきます。

### ラベリングとは何か？

ラベリングとは、ビットコインウォレットの特定の UTXO に注釈またはラベルを割り当てることです。これらの注釈はウォレットソフトウェアによってローカルに保存され、ビットコインネットワーク上で送信されることはありません。したがって、ラベリングは個人管理ツールです。

例えば、BisqでCharlesとP2Pで購入したUTXOがある場合、"`Non-KYC Bisq Charles`"とラベルを付けることができる。

タグ付けは、UTXOの起源または意図された宛先を記憶するのに役立つ良い習慣であり、したがって、資金の管理とプライバシーの最適化を容易にします。確かに、あなたのビットコインウォレットは複数のUTXOを確保しているはずです。これらの UTXO のソースが異なる場合、将来的にこれらの UTXO をマージしたくないかもしれません。すべてのパーツに適切なラベルを付けることで、たとえそれが数年後であっても、使用する必要が生じたときにそのパーツの出所を確実に思い出すことができます。

### コーナーコントロールとは？

ポートフォリオ・ソフトウェアのコイン・コントロール・オプションと組み合わせれば、ラベリングの積極的な利用がさらに面白くなる。

コインコントロールは、優れたビットコインウォレットソフトウェアに見られる機能であり、取引を完了するために入力として使用する特定のUTXOを手動で選択する機能を提供します。実際、アウトプットの支払いを満たすためには、インプットの UTXO を消費する必要があります。後ほど説明するが、様々な理由から、ある支払いを満たすために入力として消費するパーツを正確に選択したい場合がある。これこそがコイン・コントロールが可能にすることである。例えるなら、この機能はバゲットの代金を支払うときに財布から特定のコインを選ぶのと似ている。

![BTC204](assets/fr/071.webp)

UTXOのラベリングとコインコントロールを備えたポートフォリオ・ソフトウェアを使用することで、ユーザーは取引に使用するUTXOを区別し、正確に選択することができる。

### UTXOにはどのようなラベルを貼っていますか？

UTXOのラベリングに万能な方法はない。あなたのポートフォリオにとって分かりやすいラベリングシステムを定義するのはあなた次第である。いずれにせよ、良いラベリングとは、必要なときに理解できるラベリングであることに留意してください。あなたのビットコインウォレットが主に貯蓄用である場合、ラベルは今後何十年も役に立たないかもしれません。そのため、明確で、正確で、包括的であることを確認してください。

あなたの大切な人が、いつかあなたのポートフォリオにアクセスする必要が生じたときに、資金の出所を簡単に特定できるようにしておくことは重要です。これは、秘密保持のためと、当局に対して資金の出所を正当化する必要が生じた場合の法的目的のために役立ちます。

ラベルに記載する最も重要なことは、UTXOの出所である。そのコインがどのようにしてあなたのウォレットに入ったかを簡単に記載する必要があります。取引所プラットフォームでの購入の結果ですか？顧客からの請求書支払い？ピアツーピアの取引所ですか？それとも費用との交換ですか？例えば


- Exchange.com` を削除する；
- 顧客の支払い David` ；
- P2Pシャルルを購入する；
- ソファの購入を変更する

![BTC204](assets/fr/072.webp)

UTXO管理を微調整し、ポートフォリオ内のファンド分離戦略を尊重するために、これらの分離を反映する追加指標をラベルに追加することができる。ポートフォリオにUTXOが2つのカテゴリーに分類され、混 在させないようにする必要がある場合、これらのグループを明確に 区別するためのマーカーをラベルに組み込むことができる。これらの分離マーカーは、KYCを伴う買収プロセスから生じたUTXOの区別や、プロフェッ ショナルファンドとパーソナルファンドの区別など、各自の基準によって異なる。前述のラベルの例で言えば、以下のようになる：


- KYC - 出金為替.com` ；
- KYC - 顧客支払いデイビッド` ；
- NO KYC - P2Pシャルルを購入する` ；
- NO KYC - ソファー購入の変更

![BTC204](assets/fr/073.webp)

また、取引の過程においても、ある部分のラベリングを永続させることが望ましい。例えば、UTXOのno-KYCを統合する場合、コインの出所を明確に記録するために、結果として生じるUTXOに`統合`だけでなく、特に`統合no-KYC`とマークするようにしてください。

最後に、ラベルに日付を入れることは必須ではありません。ほとんどのウォレットソフトウェアはすでに取引日を表示しているし、TXIDのおかげでブロックエクスプローラーでいつでもこの情報を見つけることができる。

### 正しい部品の選び方は？

トランザクションを実行するとき、コイン・コントロールは、どのUTXOをインプットとして消費して支払いのアウトプットを満たすかを具体的に選択することができる。この選択には2つの側面がある：


- 支払いの受領者が、入力に使用されたUTXOにあなたのIDの一部をリンクさせる可能性；
- 外部オブザーバーが、入力として消費されるすべてのUTXO間のリンクを確立する能力。

最初の点を説明するために、具体的な例を挙げてみよう。あなたがパン屋からビットコインでバゲットを買うとする。あなたは、少なくともバゲットの価格と取引手数料を支払うために、インプットとして保有する1つ以上のUTXOを使用する。パン屋は、あなたの顔や、彼が知っているあなたのアイデンティティの他の部分を、入力として使用されたコインと関連付けることができる可能性がある。このリンクの存在を知っていれば、支払いの際に他のUTXOではなく、特定のUTXOを選ぶことを好むかもしれない。

![BTC204](assets/fr/074.webp)

例えば、あなたのUTXOの1つが取引所プラットフォームから来たもので、パン屋にそのプラットフォームのあなたのアカウントを知られたくない場合、あなたは支払いにそのUTXOを使うことを避けるでしょう。また、高額なUTXOを持っていて、そのUTXOにかなりのビットコインが含まれている場合、パン屋にあなたのBTC資産が知られるのを避けるために、そのUTXOを使用しないことを選択するかもしれません。

そのため、この最初のポイントにどのUTXOを使うかは、あなたが何を公開したいか、公開したくないかによって左右される、個人的な決断となる。UTXOを受け取ったときにあなたがUTXOに付けるラベルは、一度使用すれば、あなたが相手に公開しても構わない情報のみを公開するUTXOを選ぶのに役立つ。

受信者に公開される可能性のある情報だけでなく、入力の選択もブロックチェーンのすべての観察者に公開される内容に影響する。実際、トランザクションの入力として複数のUTXOを使用することで、CIOHヒューリスティック（_Common Input Ownership Heuristic_）に従って、それらが同じエンティティによって所有されていることが明らかになる。

![BTC204](assets/fr/075.webp)

したがって、パーツを選択する際には、ブロードキャストしようとしているトランザクションが、使用されているすべてのUTXO間のリンクを作成することに注意する必要があります。このリンクは、特にUTXOが異なるソースから来た場合、あなたの個人的なプライバシーにとって問題となる可能性があります。

![BTC204](assets/fr/076.webp)

私がBisqから購入したKYCなしのUTXOを例に取ろう。私のIDを知っている、例えば規制された取引所プラットフォームのUTXOと組み合わせることは避けたい。実際、私がこれら2つのUTXOを同じ取引のインプットとして使用することがあれば、規制対象プラットフォームは私のアイデンティティとBisqで購入したUTXOをリンクすることができます。

![BTC204](assets/fr/077.webp)

最後に、取引の入力として使用するUTXOを選択する場合、最も重要なことは、複数のUTXOを使用しないことです。できる限り、支払いを満たすのに十分な大きさのコインを1枚選ぶことです。こうすることで、CIOHに関連するリスクを完全に回避することができます。しかし、1枚のUTXOでは支払いに十分でなく、複数のUTXOを消費する必要がある場合は、不要なリンクのリスクを最小限に抑えるために、同様のソースからのUTXOであることを確認してください。また、受取人があなたに関する情報を入力に使用されたコインの履歴と関連付ける可能性があることにも留意してください。

### 自動部品選択を理解する

前のセクションでは、取引に使用するUTXOを手動で選択する方法について説明した。しかし、ウォレットソフトウェアがこの選択を自動的に行うとどうなるでしょうか？消費するコインを決定する方法はいくつか存在し、UTXOの選択はビットコインに関する真の研究分野を構成している。この自動処理の主な目的は、多くの場合、ユーザーの取引コストを最小化することである。

FIFO（*First In First Out*）やLIFO（*Last In First Out*）のようなUTXOの選択方法は、最も単純なものの一つだが、最も効率が悪いものでもある。FIFOでは、ポートフォリオの中で最も古い部品が最初に使用される。このアプローチは、相対タイムロックが使用され、定期的に更新される必要がある場合を除き、取引コストの最小化と機密性の保持の両方において、一般的に非効率的である。逆に、LIFOは最新のUTXOを優先的に使用する。どちらの方法も単純ではあるが、効果がないことが多い。

より高度な方法として、*Knapsack Solver*があります。これはバージョン0.17までBitcoin Coreウォレットで使用されていました。これは、ウォレットからUTXOを反復的かつランダムに選択し、サブセットでそれらを加算し、ユーザーへのコストを削減するために、トランザクションの重みをできるだけ減らす解を保持することから構成されています。

ブランチアンドバウンド*（BNB）は、その発明者にちなんでしばしば「マーチアルゴリズム」という愛称で呼ばれ、バージョン0.17からビットコインコアの*ナップザックソルバー*に取って代わられた。このより高度な方法は、トランザクションの出力を満たすために必要な量に正確に対応するUTXOのセットを見つけることを目的としています。BNBの目的は、交換の即時コストと予想される将来コストの両方を考慮した、いわゆる無駄の基準を減らすことによって、手数料と同様に交換額を最小化することである。この方法は、1960年にAilsa LandとAlison Harcourtによって考案された*Branch-and-Bound*のオリジナルの概念から派生したものであり、*Knapsack Solver*よりも正確な手数料の最適化を提供する。

これらの自動UTXO選択法はすべて、トランザクションコストを削減する上では効果的かもしれないが、ユーザーの機密性を保持する上では効果がないことが多い。実際、これらのアルゴリズ ムは複数のUTXOを入力に統合することができるため、CIOHによるこれらのUTXOの共通の特 性が明らかになる。明らかに、これらの方法はUTXOに貼付されたラベルを考慮することができない。それにもかかわらず、UTXOは取引の受信者にどの部分を明らかにするかを意識的に選択するために極めて重要である。現在のところ、コインを選択する際の機密性を最適化する唯一の方法は、手作業で行うことである。

### UTXOラベリングのチュートリアル

UTXOにタグを付ける方法を知りたい方は、主なビットコインウォレットソフトウェアの包括的なチュートリアルをご覧ください：

https://planb.network/tutorials/privacy/on-chain/utxo-labelling-d997f80f-8a96-45b5-8a4e-a3e1b7788c52

## KYCと鍵の識別

<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>


KYCは「Know Your Customer」の略です。ビットコイン分野で事業を展開する特定の企業によって実施されている規制手続きである。この手続きの目的は、顧客の身元を確認し登録することであり、マネーロンダリングとテロ資金調達に対抗することが明記されている。

実務的には、KYCは顧客から様々な個人データを収集することを含み、それは法域によって異なるかもしれないが、一般的にはID、写真、住所証明などを含む。これらの情報は検証され、将来の使用のために保存される。

この手続きは、欧米諸国の大半で規制されているすべての交換プラットフォームで必須となっている。つまり、これらのプラットフォームを通じて国の通貨をビットコインに交換したい人は、KYC要件を遵守しなければならない。

この手続きは、ユーザーのプライバシーとセキュリティにとってリスクがないわけではない。本章では、これらのリスクを詳細に検証し、KYCと本人確認プロセスがビットコインユーザーのプライバシーに与える具体的な影響を分析する。

### オンチェーン・トレーシングの促進

KYCに関連する第1のリスクは、ブロックチェーン分析のための特権的なエントリーポイントを提供することである。前節で見たように、アナリストは取引パターンとヒューリスティックを使ってブロックチェーン上のアクティビティをクラスタリングし、追跡することができる。ひとたびユーザーのオンチェーン・アクティビティをクラスタリングすることに成功すれば、あとはそのユーザーの全取引と鍵の中から単一のエントリー・ポイントを見つけるだけで、そのユーザーの機密性を完全に侵害することができる。

![BTC204](assets/fr/078.webp)

KYCを実行すると、取引所プラットフォームからビットコインを引き出す際に使用される受取アドレスを、検証済みの完全な身元と関連付けることになるため、ブロックチェーン分析のための高品質なエントリーポイントを提供することになります。理屈の上では、この情報はあなたが提供した会社にしか知られないが、後述するように、データ漏洩のリスクは実際にある。さらに、たとえ企業がこの情報を共有していなくても、企業がこの情報を保持しているという事実だけでも問題になる可能性があります。

そのため、ブロックチェーン上のあなたの活動の集約を制限するための他の措置を講じなければ、このKYCエントリーポイントを知る誰もが、ビットコイン上のすべての活動をあなたの身元に結びつけることができる可能性がある。その企業から見れば、あなたのビットコインの使用はすべての機密性を失うことになる。

![BTC204](assets/fr/079.webp)

これを比較で説明すると、*銀行X*の銀行員が*銀行X*とのすべての取引にアクセスできるだけでなく、*銀行Y*との取引やすべての現金取引も観察できたとする。

このトレーニングコースの最初の部分を思い出してください：サトシ・ナカモトによって考案されたビットコインの機密性モデルは、ユーザーのIDと鍵ペアの分離に基づいている。このレイヤーの機密性は今日ではもはや十分ではありませんが、それでも可能な限りその劣化を抑えることが賢明です。

### 国家による監視

KYCの2つ目の大きな問題は、ある時点でビットコインを所有していたことが国家に明らかになることだ。規制された行為者を通じてビットコインを購入すると、その所有について国家が知ることが可能になる。現時点では、これは些細なことに思えるかもしれないが、あなたの国の政治的、経済的未来があなたの手の中にあるわけではないことを忘れてはならない。

第一に、国家はすぐに権威主義的な姿勢をとることができる。歴史には、政策が突然変更された例がたくさんある。今日、ヨーロッパではビットコイナーがビットコインに関する記事を書いたり、カンファレンスに参加したり、ウォレットを自己管理したりすることができる。しかし、明日のことは誰にもわからない。ビットコインが突然、パブリック・エネミー・ナンバーワンになった場合、政府の資料の中でビットコインと関連付けられていることが問題になるかもしれない。

そして、深刻な経済危機に直面したとき、国家は市民が保有するビットコインの差し押さえを検討するかもしれない。おそらく明日は、ビットコイナーは危機的な利益を得る者とみなされ、不換紙幣の切り下げに直面したキャピタルゲインに対して過剰な課税を受けることになるだろう。

ビットコインは混在しているため、追跡できないので問題ないと思うかもしれない。しかし、追跡は問題ではない。本当の問題は、あなたがビットコインを所有していることを国家が知っていることだ。この情報だけで、あなたを有罪にしたり、責任を追及したりすることができる。ビットコインを使い込んだと主張することもできるが、それは確定申告に反映させなければならず、捕まってしまう。また、ボート事故で鍵をなくしたと言うこともできるが、ツイッターのジョークを越えて、本当にそれで冤罪が晴れると思うか？

だから、あなたがBTCを所有していることが国家に知られるリスクを考慮することが重要だ。

国の監督という観点からKYCがもたらすもう一つの問題は、規制対象プラットフォームによる報告義務です。他の国の規制には詳しくないが、フランスでは、*Prestataires de Services sur Actifs Numériques* (PSAN)は、疑わしいと思われる資金の動きを金融監督当局に報告する義務がある。

2023年のフランスでは、1,449件の不審な行為がPSANによって報告された。当面、これらの行為の大半は犯罪関連である。しかし、当局は規制対象のプラットフォームに対し、疑わしいビットコイン取引をその構造のみに基づいて報告するよう求めている。もしあなたが共同取引を行ったり、あるいは少し非典型的なパターンの取引を行ったりし、その取引がこれらのプラットフォームからのビットコインの引き出しからそう遠くない時期に発生した場合、あなたは当局に報告される可能性があります。悪意がなく、正当な権利行使であったとしても、このような報告により、チェックや監視が強化され、KYCがなければ避けられたであろう不都合が生じる可能性がある。

### 個人情報漏洩のリスク

KYCのもう一つの問題は、すべての個人データを民間企業のサーバーに保存する必要があることだ。

最近の出来事から、誰も金融やITの失敗を免れないことを思い知らされた。2022年、セルシオの顧客はその結果に苦しんだ。同社の破産後、債権者の名前とその資産額は、行政手続き中にアメリカの裁判所によって公開された。

ちょうど2年前、暗号通貨のサイバーセキュリティのフラッグシップとして、顧客の個人情報が盗まれた。この事件はビットコインの購入に直接関連するものではなかったが、このようなリスクは取引所プラットフォームにも残っている。したがって、個人データに関連するリスクは確実に存在する。

私たちがすでに多くの個人データを民間企業に預けているのは事実だ。しかし、このデータは個人を特定するだけでなく、ビットコインでの活動にもリンクしているため、リスクは二重になっている。実際、ハッカーが取引所プラットフォームの顧客データにアクセスした場合、その顧客はビットコインを保有していると合理的に推測できる。このリスクは、ビットコインが他の貴重な資産と同様に窃盗団の注意を引くという事実によって高まります。

データ漏洩が発生した場合、最悪の場合、標的型フィッシングの標的になる可能性がある。最悪の場合、自宅を狙った物理的な脅威の中心となってしまうかもしれない。

ビットコイン特有のリスクに加え、身分証明書の送信に伴う危険もある。実際、データが流出した場合、なりすましの被害に遭う可能性がある。つまり、取引の機密性を守ることだけにとどまらず、各個人の個人的な安全にも関わるのだ。

### KYCに関する先入観

ツイッターやビットコイナー同士のやり取りでよく目にするKYCに関する先入観を解体することが重要だ。

まず第一に、KYCで取得したビットコインのプライバシー保護が無意味だと考えるのは不正確だ。ビットコインのプライバシー保護ツールや方法は多様であり、目的も異なる。例えば、KYCで取得したビットコインにcoinjoinトランザクションを使用することは悪い考えではない。もちろん、アカウントを凍結されたり禁止されたりしないように、規制された取引所プラットフォームには注意する必要があるが、厳密に技術的な観点から見れば、これらの方法は相容れないものではない。Coinjoinはコインの履歴を壊す効果があるため、KYCに関連する特定の連鎖分析リスクを回避するのに役立ちます。すべてのリスクを排除できるわけではありませんが、大きな利点があります。

![BTC204](assets/fr/080.webp)

ビットコインにおける秘匿性は、「匿名」ビットコインとそうでないものを区別するような二元的な見方をすべきではない。KYCを通じて取得したビットコインを所有しても、すべてが失われるわけではなく、それどころか、機密保持ツールの使用はさらに有益であることを証明することができる。

逆に、KYC以外の方法でビットコインを取得しても、完全な機密性が保証されるわけではありませんし、他の保護措置を講じる必要性が免除されるわけでもありません。非KYCのビットコインを保有していても、受信アドレスを何度も再利用している場合、取引が追跡され、集計される可能性があります。ビットコインの外の世界とのわずかなリンクが、あなたが持っている唯一の機密性を損なう可能性があります。そのため、ビットコインのプライバシーを強化するツールや手法はすべて補完的なものと考えることが重要です。各手法は特定のリスクに対処し、保護層を増やすことができる。つまり、非KYCビットコインを所有しているからといって、他の予防措置を講じる必要がないわけではない。

### KYCはキャンセルできますか？

KYCを行った後に「後戻り」することは可能かと聞かれることがあるが、先の段落から想像できるように、答えは微妙である。KYCに関連するリスクを回避する最も簡単な方法は、ビットコインを取得する際にKYCを使用しないことです。このテーマについては次の章で詳しく見ていくことにする。しかし、KYCがすでに実施され、ビットコインが購入されている場合、そのリスクを軽減する方法はあるのでしょうか？

取引をトレースされるリスクに関しては、coinjoinを使用することで解決できます。この方法については後ほど詳しく見ていきますが、coinjoinを使えばコインの履歴を断ち切ることができ、過去-現在、現在-過去の追跡を防ぐことができることを知っておいてください。規制されたプラットフォーム経由で入手したBTCであっても、このテクニックを使えば追跡を防ぐことができます。

しかし、coinjoinはKYCに関連する2つ目のリスク、つまりビットコインを所有していることを国家に知られる可能性があるという事実を消し去ることはできません。実際、あなたのコインが追跡不可能になったとしても、司法管轄権によっては、国があなたの暗号資産移転申告書にアクセスできる可能性がある。このリスクは技術的なものではなく、管理的なものであるため、そもそもKYCの対象としないことを除けば、ビットコイン特有の解決策はない。このリスクを軽減する唯一の合法的なアプローチは、規制されたプラットフォームを通じて取得したビットコインを規制されたプラットフォームで売却し、その後KYCフリーの手段で再購入することです。売却し、譲渡を宣言することで、当局はあなたがもはやそれらを所有していないことを確認するはずです。

個人データや身分証明書が流出する危険性については、ビットコインの外部にある危険性であり、それを回避する技術的な解決策はない。一度データが漏えいしてしまうと、元に戻すことは難しい。プラットフォーム上でアカウントを閉鎖しようとすることはできますが、特に身元確認が外部委託されている場合、これはKYCデータの削除を保証するものではありません。情報の完全な削除を検証することは不可能です。したがって、このリスクを完全に防止し、リスクが存在しないようにする解決策はありません。

### KYCとキー・アイデンティフィケーションの違い

時々、一部のビットコイナーは「KYC」という用語を、電信送金やクレジットカードによる支払いを伴うBTC交換にまで拡大する傾向がある。しかし、KYCを鍵識別と混同してはならない。個人的なことだが、このテーマに対する私の認識は、時間の経過とともに変化してきたことを認めざるを得ない。

KYCとは特に、特定の企業が顧客の身元を確認し登録するために実施する規制手続きのことを指す。ビットコインを取得する際には、KYCを行うか行わないかの二者択一である。しかし、ユーザーのアイデンティティの一面とオンチェーン・アクティビティとの関連に関わるキー・アイデンティフィケーションは、二元的なものではなく、むしろ連続的なものである。実際、ビットコインの取得や移転の文脈では、そのような識別は程度の差こそあれ常に可能である。

例えば、スイスの規制されたプラットフォームでビットコインを購入する場合、KYCは必要ない。しかし、購入が銀行口座経由で行われたため、あなたの鍵は特定される可能性がある。KYCのない取引所では、KYCに関連する最初の2つのリスク（オンチェーン追跡の円滑化と国家監視への暴露）が顕在化する可能性がある。スイスの事業体があなたの国の当局に疑わしい取引を報告した場合、当局は購入に使われた銀行口座を調べるだけであなたの身元を突き止めることができます。そのため、規制されたプラットフォームでKYCを行わずに購入することは、重要な身元確認のリスクとしてはむしろ高い。

![BTC204](assets/fr/081.webp)

しかし、規制されたプラットフォームを避け、P2Pの取得方法を選択しても、鍵識別のリスクが完全になくなるわけではなく、単にリスクが軽減されるだけである。Bisqや他のP2Pプラットフォームでの購入を例に考えてみよう。取引相手への支払いには、おそらく銀行口座を使うだろう。もし当局が取引相手に質問し、あなたの名前を尋ねたら、リスク1と2に戻ってしまう。これらのリスクは、KYCなしのプラットフォームで購入する場合よりもはるかに低く、KYCありで購入する場合よりもさらに低いとはいえ、それでも少なからず存在する。

![BTC204](assets/fr/082.webp)

最後に、現金との物理的な交換を通じてビットコインを入手したとしても、完全に匿名というわけではない。交換した相手はあなたの顔を見ており、それはあなたのアイデンティティの一部です。この例ではごくわずかだが、それでも鍵による本人確認の可能性はある。

![BTC204](assets/fr/083.webp)

結論として、ビットコインが他の資産と交換される場合、それが国の通貨による購入であれ、実物商品に対する売却であれ、必ず何らかの形で鍵の識別が行われる。選択された交換方法によって、この識別の強さは異なります。この本人確認を、明確に定義された規制プロセスであるKYCと混同しないことが重要である。KYCは、当局によるユーザー鍵の識別を組織的に促進するため、KYCと識別スペクトルの間には関連性がある。

## 販売と買収の方法

<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>


前章を読んで、KYCに関連するリスクを回避するために、本人確認手続きを受けることなくビットコインを売買するにはどうすればよいのか疑問に思うかもしれない。ビットコインを取引する方法はいくつかあります。

### P2P現金取引所

これまで見てきたように、秘密保持の点で最良の方法は、現金決済によるP2P（個人間）交換であることに変わりはない。この方法であれば、残された痕跡を最小限に抑えることができ、売買にかかわらず、鍵を特定される可能性を大幅に減らすことができる。

![BTC204](assets/fr/084.webp)

とはいえ、個人の安全にはリスクがある。主な危険は、取引中に、あなたが現金またはビットコインで大金を保有していることが取引相手に知られることにある。この情報は悪意のある人物の注意を引く可能性があります。実際、一般的にビットコインの保有については慎重になることが望ましい。このアドバイスは現金にも適用できる。しかし、対面でやり取りする場合、ビットコインを所有していることを明かすことは避けられず、歓迎されない注目を集める可能性がある。

![BTC204](assets/fr/085.webp)

このリスクを抑えるには、家族や親しい友人など、信頼できる人との現金取引を優先することをお勧めする。また、[local Bitcoin meetups](https://btcmap.org/communities/map)に数回参加した後、取引を検討することもできます。そうすることで、他の参加者とより深く知り合うことができ、物理的に交換するときに一人にならずに済む。ただし、P2P 現金取引所には、規制されたプラットフォームや銀行口座を通じて購入する場合には存在しない、個人のセキュリティに対するリスクが内在していることを認識することが重要です。

さらに、住んでいる場所によっては、ビットコインであろうと現金であろうと、大金を輸送したり保管したりするのはリスクが伴う。

現金の両替は、警察などのチェックが入った場合に法的なリスクを伴うこともある。ほとんどの国では現金の所持量に制限はありませんが、過剰な所持は疑われる可能性があります。そのため、特に長距離を移動しなければならない場合は注意し、一度に多額の取引をすることは避け、多額の所持を正当化する必要がないようにしましょう。

最後に、P2P購入のもう一つのデメリットは、規制されたプラットフォームよりも価格が高いことが多いことだ。売り手は多くの場合、1％から時には10％以上のマークアップを請求する。この価格差にはいくつかの理由がある。第一に、これはP2P販売者の間で一般的な慣行であり、時間の経過とともに定着してきた。第二に、売り手は買い手に資金を送るために取引に関連する手数料がかかる。また、P2P販売ではプラットフォーム取引に比べて盗難のリスクが高まるため、リスクに対する補償が正当化される。最後に、余分なコストは、秘密保持という点で、取引所の需要や品質と関連している可能性がある。買い手としては、秘密保持の利得は、売り手によって適用されるマークアップに反映される価格がある。また、一部のビットコイナーは、P2Pで購入したBTCのマークアップ価格は、その真の価格を反映していると考えており、規制されたプラットフォームでの低価格は、個人データの機密性が損なわれた結果であると主張しています。

![BTC204](assets/fr/086.webp)

### マッチング・プラットフォームによるP2P交換

個人的なセキュリティの観点から、よりリスクの低い選択肢は、PayPal、銀行振込、Revolutなどの電子決済手段を使って、オンラインのみでP2P交換を行うことである。

![BTC204](assets/fr/087.webp)

この方法は、現金取引に関連する多くのリスクを回避できる。しかし、オンライン取引所では、取引相手が債務不履行に陥るリスクが大きくなる。実際、物理的な取引所では、ビットコインの見返りを送らない売り手にお金を渡せば、目の前にその人が立っているため、すぐに責任を問うことができる。一方、オンラインでは、あなたから盗んだ人を追跡することは不可能な場合が多い。

![BTC204](assets/fr/088.webp)

このリスクを軽減するために、P2P交換に特化したプラットフォームを利用することができる。このようなプラットフォームでは、紛争解決メカニズムを利用して、不満を持つユーザーを保護する。通常、エスクロー（預託）システムを提供し、売り手が不換紙幣での支払いを確認するまでビットコインを預かる。

![BTC204](assets/fr/089.webp)

個人のセキュリティという点では、この購入方法は物理的な現金交換よりもかなり安全である。しかし、前述したように、オンラインP2P取引所は、物理的な取引所よりも多くの痕跡を残し、ビットコイン上のプライバシーを損なう可能性がある。銀行のようなオンラインの不換紙幣の支払い方法を使用することで、鍵の特定を容易にする可能性のある、より多くの情報を公開することになります。

![BTC204](assets/fr/090.webp)

繰り返しになるが、これらのプラットフォームで1回の取引であまり大きな取引をすることはお勧めしない。取引を分割することで、取引相手の盗難リスクを分散することができる。

繰り返しになるが、P2P購入のもう一つの欠点は、価格が規制されたプラットフォームで観察される価格よりもしばしば高いことである。売り手は多くの場合、1％から時には10％以上のマークアップを請求する。この価格差にはいくつかの理由がある。第一に、これはP2P販売者の間で一般的な慣行であり、時間の経過とともに定着してきた。第二に、売り手は買い手に資金を送るために取引に関連する手数料がかかる。また、P2P販売ではプラットフォーム取引に比べて盗難のリスクが高まるため、リスクに対する補償が正当化される。最後に、余分なコストは、秘密保持という点で、取引所の需要や品質と関連している可能性がある。買い手としては、秘密保持の利得は、売り手によって適用されるマークアップに反映される価格がある。また、一部のビットコイナーは、P2Pで購入したBTCのマークアップ価格は、その真の価格を反映していると考えており、規制されたプラットフォームでの低価格は、個人データの機密性が損なわれた結果であると主張しています。

![BTC204](assets/fr/086.webp)

ソリューションに関しては、個人的にはいつも[Bisq](https://bisq.network/)を使っていて、とても満足している。Bisqのシステムは試行錯誤が繰り返され、信頼性が高い。しかし、BisqはPCでのみ利用可能で、そのインターフェースは初心者には複雑すぎるかもしれません。もう一つの欠点は、Bisqがオンチェーン取引でしか動作しないことで、ビットコインの取引手数料が高い時期にはコストが高くなる可能性がある。

-> Bisqのチュートリアルをご覧ください。

https://planb.network/tutorials/exchange/peer-to-peer/bisq-fe244bfa-dcc4-4522-8ec7-92223373ed04

よりシンプルなオプションとして、[Peach](https://peachbitcoin.com/)を試してみることができる。[Peach](https://peachbitcoin.com/)は、買い手と売り手をつなぐモバイルアプリで、紛争解決システムが組み込まれている。Bisqよりも直感的に利用できる。

-> ピーチのチュートリアルをご覧ください。

https://planb.network/tutorials/exchange/peer-to-peer/peach-c6143241-d900-4047-9b73-1caba5e1f874

もう一つのオンライン・オプションは[HodlHodl](https://hodlhodl.com/)で、個人的にはテストしていないが、良い流動性を提供する定評のあるプラットフォームである。

-> HodlHodlのチュートリアルをご覧ください。

https://planb.network/tutorials/exchange/peer-to-peer/hodlhodl-d7344cd5-6b18-40f5-8e78-2574a93a3879

ライトニングネットワークベースのソリューションとしては、[RoboSats](https://learn.robosats.com/)と[LNP2PBot](https://lnp2pbot.com/)をお試しください。RoboSatsはウェブサイトからアクセスでき、使い方も比較的簡単である。LNP2PBotはより非典型的で、Telegramメッセージング・アプリケーション上の交換システムを介して動作する。

-> ロボサットのチュートリアルをご覧ください。

-> LNP2PBotのチュートリアルをご覧ください。

https://planb.network/tutorials/exchange/peer-to-peer/robosats-b60e4f7c-533a-4295-9f6d-5368152e8c06

https://planb.network/tutorials/exchange/peer-to-peer/lnp2pbot-v2-e6bcb210-610b-487d-970c-7cce85273e3c

![BTC204](assets/fr/091.webp)

### KYCなしの規制プラットフォーム

お住まいの国によっては、ビットコインの売買に KYC 手続きを必要としない規制されたプラットフォームを利用できる場合があります。例えばスイスでは、[Relai](https://relai.app/)や[MtPelerin](https://www.mtpelerin.com/)といったプラットフォームを利用することができます。

-> Relaiのチュートリアルをご覧ください。

https://planb.network/tutorials/exchange/centralized/relai-v2-30a9671d-e407-459d-9203-4c3eae15b30e

前章で見たように、この種のプラットフォームは KYC 手続きに関連するリスクからあなたを救うが、キー識別のリスクは高くなる。ビットコインの機密性という点では、これらのプラットフォームはKYCを伴う購入方法よりも優れた保護を提供しますが、P2P取引所よりも魅力的でないことに変わりはありません。

しかし、個人的なセキュリティの面では、これらのプラットフォームを使用することは、P2P取引所よりもはるかにリスクが低い。また、P2Pプラットフォームよりも使い方が簡単な場合が多い。

### ATM

KYCなしでビットコインを売買するもう一つの選択肢は、暗号通貨ATMである。個人的には、私の国にはないので、このソリューションを試す機会がなかった。しかしこの方法は、住んでいる場所によっては非常に興味深いものになる。

![BTC204](assets/fr/092.webp)

ATMの問題は、国によっては禁止されているか、他の国では高度に規制されていることである。ATM に本人確認手続きが必要な場合、KYC 規制のあるプラットフォームと同じリスクにさらされる。一方、少額であれば本人確認なしで取引ができるATMであれば、P2P現金交換に匹敵する機密性を提供できる一方、この種の交換に関連するリスクはほとんど回避できる。

ATMの主な欠点は、両替手数料がしばしば高いことで、数％から時には両替額の15％にもなる。

### ギフトカード

最後に、ビットコインを不換紙幣に対して売却するのではなく、日常的にビットコインを使って買い物をしたい人に有効なソリューションも紹介したい。

BTCを使う最良の方法は、もちろん、ビットコインやライトニング・ネットワークを直接使って商品やサービスを購入することだ。しかし、多くの国では、ビットコインを受け入れる加盟店の数はまだ限られている。現実的な代替手段は、ギフトカードを使うことだ。

KYC手続きを必要としないいくつかのプラットフォームは、ビットコインを主要小売店で使用できるギフトカードと交換する可能性を提供している。CoinsBee](https://www.coinsbee.com/)、[The Bitcoin Company](https://thebitcoincompany.com/)、[Bitrefill](https://www.bitrefill.com/)などである。これらのプラットフォームを利用することで、ビットコインを不換紙幣に換金することなく、日常的に様々な商品やサービスを利用することができます。

https://planb.network/tutorials/exchange/centralized/bitrefill-8c588412-1bfc-465b-9bca-e647a647fbc1

![BTC204](assets/fr/093.webp)

### その他の獲得方法

プライバシーを守りながらビットコインを入手する他の方法には、もちろんマイニングがあります。サットマイニングを開始するには、身元を明らかにする必要はありません。有効な作業証明を見つけてネットワークに提出するだけです。プールマイニングを選ぶ場合、KYCのような何らかの身分証明書が必要なプールもあれば、不要なプールもあります。

もう一つの方法は、ビットコインと引き換えに働くことである。この入手方法も面白いが、必要な本人確認の程度は状況によってかなり異なる。

*この章を書くために、プラン₿ネットワークで[@pivi___](https://x.com/pivi___)によって行われたBTC205トレーニングコースを使用した（今のところフランス語でのみ利用可能）。

## 統合、UTXO経営、CIOH

<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>


セルフ・カストディ・ポートフォリオを運営する上で、最も複雑な側面の一つが統合である。統合すべきか？ポイントは何か？尊重すべきUTXOの規模は？守秘義務という点での妥協点は何か？それがこのセクションで見ていくことだ。

### 統合とは何か？

ビットコインはオークション市場のように運営され、マイナーは手数料の安い取引を優先する。しかし、各ブロックには最大ウェイトがあり、含まれるトランザクション数が制限される。ブロックは平均10分ごとに生成されるため、各ブロックで利用可能なスペースは希少な資源である。

電力、固定資産、メンテナンスに多大なコストを要する採掘業者は、当然ながら収益性を最大化しようとする。そのため、重量の割に手数料が高い取引を好む傾向がある。

すべてのビットコイン取引が同じ重みを持つわけではない。インプットとアウトプットが多いものは、より重くなります。例えば、2つのトランザクションを想像してみましょう：


- 取引Aは1入力と1出力からなる。このトランザクションは1,994サットの手数料を割り当て、141 vBのウェイトを持つ；
- トランザクションBは、2つのインプットと2つのアウトプットを持つより複雑なトランザクションで、2,640サットの手数料を220ビットのウェイトに割り当てている。

![BTC204](assets/fr/094.webp)

この例では、トランザクションBの方が総手数料は高いが、マイナー は手数料とウェイトの比率が良いトランザクションAを好む。以下は各トランザクションの計算で、仮想バイト当たりのサット数（sat/vB）で表したものである：

```text
TXA : 1994 / 141 = 14 sats/vB
TXB : 2640 / 220 = 12 sats / vB
```

つまり、1単位の重量に対して、取引Aは取引Bより多くのコストを提供している。

![BTC204](assets/fr/095.webp)

したがって、ユーザーにとっては、取引で消費するインプットはできるだけ少ない方が常に興味深い。しかし、アウトプットの支払いを満足させるためには、十分な量を消費する必要がある。ポートフォリオを管理する際には、十分に大きなUTXOを持つ必要がある。

統合の原則は、ビットコインの手数料が低い期間を利用して、その小さなUTXOを1つの大きなUTXOに統合することにある。こうすることで、ビットコインの手数料が上昇したときに、最小限の入力で取引を行うことができるため、手数料の絶対額を少なくすることができる。そのため、手数料が高い時期に強制的に取引を行うことを見越した狙いがある。

![BTC204](assets/fr/096.webp)

取引コストの節約に加え、UTXOを統合することで「ダスト」の発生を防ぐことができる。ダスト」とは、サットでの価値が非常に低く、それを使うために必要な取引コストをカバーするには不十分なUTXOのことである。このため、取引コストが高いままである限り、これらのUTXOを使用することは経済的に不合理となります。UTXOを積極的にプールすることで、UTXOがダストになるのを防ぎ、すべての資金を使用可能な状態に保つことができます。

### UTXOの最小サイズは？

UTXOの推奨最低値はいくらかという質問を受けることがあります。残念ながら、あなたの好みや手数料市場の状況によって異なるため、普遍的な答えはありません。しかし、あなたのニーズに合った基準値を決めるのに役立つかもしれない計算式があります：

$$
\frac {P \times F}T = M
$$

どこでだ：


- p$は取引重量である；
- F$は、1バイトあたりのサトシ（sats/vB）単位で、ヘッジの対象となる最大チャージレートを表す；
- t$は、UTXOの総額に対する取引手数料の割合である；
- m$は、各UTXOの最低金額（サトシ単位）。

1インプットと2アウトプットの標準的なSegWitトランザクションの手数料を、141vBでカバーする予定だとします。800サット/vBまでヘッジし、手数料は最大でもUTXO値の12%までで構わないとすると、計算は次のようになります：

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

したがって、この例では、UTXOの最低値を94万サットとするのが賢明である。

### 統合とCIOH

ブロックチェーン分析で最も広く使用されているヒューリスティックの1つはCIOH（*Common Input Ownership Heuristic*）で、ビットコイン取引へのすべての入力が同じエンティティに属していると仮定します。コンソリデーションの原理は、入力として複数のUTXOを消費し、出力として単一のUTXOを作成することです。したがって、コンソリデーションはICOHの適用を可能にする。

![BTC204](assets/fr/097.webp)

実際には、これは外部のオブザーバーが、連結されたすべてのUTXOがおそらく同じ人物のものであり、生成されたユニークな出力もその人物のものであると推測できることを意味する。このような状況は、異なる取引履歴を関連付けることで、機密保持を危うくする可能性がある。例えば、P2P経由で取得した3つのUTXOと、KYCを必要とするプラットフォーム経由で取得した1つのUTXOを統合するとします：

![BTC204](assets/fr/098.webp)

そうすることで、政府機関を含む可能性のある、取引所プラットフォームのデータにアクセスできるあらゆる組織が、私が他の金額のBTCを所有していることを特定できるようになる。以前は、これらのUTXOは私のIDに直接リンクされていなかったが、今はリンクされている。さらに、私が一定量のビットコインを所有していることがあらゆる情報源に明らかになる。

UTXOの管理に関して言えば、コスト削減のために統合を推進する経済的配慮は、UTXOを決して統合しないことを推奨する優れたプライバシー慣行と対立する。したがって、経済性と機密性の選択は、各ユーザーの優先順位に依存する。

実質的なUTXOを維持しながら統合を回避できれば理想的だ。そのためには、取得方法を最適化しましょう。DCAでビットコインを購入する場合、1回限りの購入はできるだけ間隔をあけて、より少ないUTXOに価値を集約するようにしましょう。毎週120ユーロを購入するよりも、2ヶ月に1度1,000ユーロを購入する方が管理しやすいでしょう。こうすることで、UTXOの発生回数を最小限に抑え、お客様の守秘義務を守りつつ、ポートフォリオの管理を簡素化することができます。

ビットコインを統合する必要がある場合は、まず同じソースからの UTXO を統合することを優先してください。例えば、1つのプラットフォームから10個のUTXOを統合することは、プラットフォームAからの5個のUTXOとプラットフォームBからの5個のUTXOを混合することよりも機密性に影響を与えません。例えば、KYC経由で取得したUTXOは1つの取引にまとめ、P2P経由で取得したUTXOは別の取引にまとめる。

いずれにせよ、統合は必然的に守秘義務の喪失を伴うことを忘れてはならない。そのため、CIOHを考慮に入れながら、この作業の必要性とプライバシーへの潜在的な影響を慎重に評価してください。

## その他のベストプラクティス

<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>


ビットコインでプライバシーを最適化するためのベストプラクティスをいくつか見てみよう。

### 完全な結び目

自分のビットコインを自己保管することは素晴らしいことですが、自分の完全なノードを使うことはさらに良いことです！自分のノードを持つことが、ビットコインを完全に主権的に使用するために重要である理由を説明します：


- 検閲への耐性**：あなたの取引は誰にもブロックされません；
- 第三者からの独立性**：ブロックチェーンデータの検証を外部サービスに依存する必要がなくなります；
- 積極的な参加**：独自の検証ルールを定義し、コンセンサスに直接参加することができます；
- ネットワークへの貢献**：ノードを運営することで、ビットコインネットワークの強化と分散に貢献できます；
- 技術教育**：完全なノードを管理することは、ビットコインに関する技術的な知識を深めるのに最適な方法です。

これらの利点に加え、完全なノードを使用することで、トランザクションをブロードキャストする際の機密性も向上します。あなたがトランザクションを発行するとき、それは最初にあなたの財布を介して作成され、署名されます。それをビットコインネットワーク上でブロードキャストするには、少なくとも1つのノードによって知られている必要があります。自分のノードを使用することで、この配布を直接制御できるため、機密性が強化され、データ漏えいのリスクが制限されます。

![BTC204](assets/fr/099.webp)

自分のビットコインノードを持っていない場合、ウォレットソフトウェアプロバイダーが提供するようなサードパーティのものを使用せざるを得なくなる。トランザクションをブロードキャストするだけでなく、ウォレットは保留中のトランザクション、アドレスに関連付けられた残高、トランザクションの確認数などの様々な情報にアクセスする必要があります。これらすべてのデータにアクセスするには、ノードに問い合わせる必要があります。

![BTC204](assets/fr/100.webp)

自分のビットコインノードを使用していない場合の主なリスクは、サードパーティーノードのオペレーターがブロックチェーン上のあなたの活動を観察したり、この情報を他の団体と共有したりする可能性があることです。このリスクを制限するための中間的な解決策は、Tor経由で接続をマスクするウォレットソフトウェアを使用することです。これにより、あなたのデータの露出を減らすことができる。しかし、最適な解決策は、自分自身のビットコインノードを持ち、それを使ってトランザクションをブロードキャストすることだ。もちろん、自分のノードを通じて情報が漏れないように注意する必要もあるが、それは後のセクションで見ていく別のテーマだ。

自分の完全なノードを持つことは、プライバシーに対する明らかな利点だけでなく、ブロックチェーン上のデータの信憑性を保証し、検閲から守り、ビットコインの統治に積極的に参加することを可能にします。自分のノードを使用することで、選択したチェーンに経済的な重みを貢献することができ、これは例えば2015年から2017年にかけてのブロックサイズ戦争のような、コミュニティ内の紛争時に重要な意味を持ちます。フォークが発生した場合、サードパーティのノードを使用すると、ノードオペレータがあなたのために選択を行うため、あなたが支持したくないチェーンをサポートすることにつながる可能性があります。

おわかりのように、機密保持と個人の主権のためには、自分自身の完全なノードを運営し、使用することが不可欠である！

### 欺く分析ヒューリスティック

より広く言えば、前節で話したヒューリスティックを理解し、より上手に回避したり欺いたりすることが重要である。一連のベストプラクティスを採用することは、たとえ必須でないとしても有益である。これらのベストプラクティスは、ビットコインを使用する際に機密性を維持するために重要な、追加の保護レイヤーを提供します。

私ができる最初のアドバイスは、最も密集した群衆に溶け込むことだ。ビットコインでは、これは最も広く採用されているスクリプトテンプレートを使用することを意味する。例えば、SegWit V0マルチシグ構成によく使用されるP2WSHスクリプトは非常に珍しいものです。これらのスクリプトでは、大規模な匿名性セットに隠れることはできません。P2PKHやP2SHのような古いモデルも同様です。これらはUTXOセットには広く存在するが、新しいトランザクションで使用されることは少なくなっている。

一般的に言って、最新のスクリプト標準が十分に採用されているのであれば、それを選ぶ方が賢明である。したがって、2022年にP2TR（Taproot）の採用率が低かったため、P2TRを使用しないことを勧めたとすれば、2024年には、P2TRを使用するトランザクションの数が非常に大きな割合を占め始めているため、代わりにこのタイプのスクリプトを選ぶか、それができなければSegWit V0スクリプトを選ぶことを勧めます。

![BTC204](assets/fr/101.webp)

ソース : [txstats.com](https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)

機密性を保持するためのもう1つのヒントは、内部トランザクションのヒューリスティックスをバイパスしてみることである。例えば、支払いを行う際、丸い金額のアウトプットを作成しないようにすることができる。100kサットを友人に送る必要がある場合は、このヒューリスティックから逃れるために、少し高い金額を送金することを検討してください。同様に、支払額に対して不釣り合いに高い外貨のアウトプットを作成しないようにしてください。

![BTC204](assets/fr/102.webp)

最後に、ビットコインの取引を定期的に行う場合は、常に同じ時間に放送しないように注意すること。トランザクションのブロードキャストを一日や一週間を通して分散させることで、外部のオブザーバーにタイムゾーンに基づく時間的パターンを検出する機会を与えず、分析を強化することができます。

日常的に取り入れるべきこれらすべてのグッドプラクティスに加え、ビットコインのトレーサビリティを完全に破壊するさらに効果的な方法があります。これにはもちろんコインジョイント取引も含まれますが、次のセクションで詳しく見ていきましょう。

# コインジョイントトランザクションを理解する

<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## コインジョイント取引とは何ですか？

<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>


プライバシー保護の基本を学んだので、これからは、特にビットコインの履歴をアンバンドリングすることで、積極的に秘密保持を守ることを目的とした、より洗練されたテクニックを見ていこう。次のパートでは、小さなテクニックの数々を見ていきますが、まずはcoinjoinについてお話したいと思います。

Coinjoinは、ビットコインユーザーのプライバシーを保護する最も効果的な方法と考えられています。しかし、コインジョイント取引とは一体何なのでしょうか？調べてみましょう。

### コインジョイントの基本原則

コインジョインはブロックチェーン上のビットコインの追跡を解除する技術である。これは、coinjoinトランザクションという同名の特定の構造を持つ共同トランザクションに基づいている。

このコースの最初の部分で見たように、ビットコインの取引はノードを介してすべてのユーザーに知られている。したがって、各コインの電子署名チェーンを確認し、その履歴を観察することは容易である。これは、すべてのユーザーが他のユーザーの取引を分析しようと試みることができることを意味する。その結果、取引レベルでの匿名性は不可能となる。しかし、個人の識別レベルでは匿名性が保たれる。各口座が個人のIDにリンクされている従来の銀行システムとは異なり、ビットコインでは、資金は暗号キーペア（またはスクリプト）に関連付けられ、暗号識別子の背後に擬似匿名性の形式をユーザーに提供する。

![BTC204](assets/fr/103.webp)

外部のオブザーバーが特定のUTXOを特定ユーザーと関連付けることができるようになると、ビットコインの機密性は損なわれる。この関連付けが確立されると、そのユーザーの取引を追跡し、ビットコインの履歴を分析することが可能になる。CoinjoinはまさにUTXOのトレーサビリティを破るために開発された技術であり、ビットコインユーザーに取引レベルでの一定の機密性を提供するためである。

コイン結合は、外部のオブザーバーにとってチェーン分析をより複雑にすることで、ビットコインユーザーの機密性を強化する。その構造は、異なるユーザーからの複数のコインを単一のトランザクションにマージすることを可能にし、境界線をあいまいにし、入力アドレスと出力アドレスの間のリンクを決定することを困難にする。

コインジョイント取引の目的は、コインの履歴を断ち切ることであることを理解することが重要です。このテクニックは、永久的な匿名性を付与するものでも、ビットコインの追跡を決定的にブロックするものでもありません。Coinjoinの目的は、Coinjoin取引が実行された時点で履歴を破壊することだけです。しかし、この操作の前も後も、コインは機密性という点で同じリスクにさらされたままです。

![BTC204](assets/fr/104.webp)

### コインジョイントはどのように機能するのか？

coinjoinの原理は協調的なアプローチに基づいている：自分のビットコインを混合したい複数のユーザーが、同じトランザクションのインプットとして同じ金額を入金する。その後、これらの金額は各ユーザーに等しい価値のアウトプットとして再配布される。

![BTC204](assets/fr/105.webp)

トランザクションが終了すると、特定のアウトプットをインプットとして知られるユーザーに関連付けることは不可能になる。インプットとアウトプットの間に直接的なリンクがないため、ユーザーとそのUTXOの関連付けが崩れ、各部品の履歴も崩れる。

![BTC204](assets/fr/106.webp)

アリスの例を見てみよう。彼女は妹のイヴの誕生日に約10万サットを送りたい。しかし、AliceはEveに自分の取引履歴を追跡されたくない。自分が何ビットコインを持っているか、どうやって手に入れたかを明かしたくないからだ。そのため、アリスはコインジョイント取引でUTXOの履歴を壊すことにした。彼女はBob、Charles、David、Frankと共同で取引を行うことにした：


- Alice、Bob、Charles、David、Frankはそれぞれ105,000サットのUTXO（マイニング手数料として5,000サット）を取引のインプットとしてコミットする：

![BTC204](assets/fr/107.webp)


- これらの入力を消費する見返りとして、それぞれが空白のアドレスを生成し、それぞれ10万サットの同一の出力を5つ作成する。それぞれが1つの出力を取り出す：

![BTC204](assets/fr/108.webp)


- アリスは10万サットのUTXOの履歴が混ざっていることに気づく。彼女はこのUTXOを新たな取引に使い、Eveの誕生日にその金額を送る：

![BTC204](assets/fr/109.webp)


- Eveがこの取引を分析して情報を引き出そうとすると、Alice、Bob、Charles、David、Frankを含むcoinjoin取引に直面することになる。金額が一様であるため、どのインプットが誰のものかを区別することができず、イヴはアリスのUTXO履歴を追跡することも、妹が所有しているビットコインの数やその取得方法を特定することもできない：

![BTC204](assets/fr/110.webp)

この場合、アリスは遡及分析に関する機密性を高めるためにコイン結合技術を使用した。事実上、AliceはEveによる可能性のある分析から身を守っている。Eveは特定のトランザクションから始めて、UTXOの履歴を遡って分析するだろう。現在から過去への分析に対するこの保護はretrospective anonsetとして知られている。この概念については、このセクションの最終章で詳しく説明する。

しかしcoinjoinは、プロスペクティブ・アノンセットとして知られる、過去から現在への分析に直面して、機密性を強化する可能性も提供する。アリスがイヴの誕生日に98,000サットを送った例に戻ろう。今度は、プライバシーを心配しているのがイヴだと想像してみよう。実際、アリスはイブに送ったコインから情報を引き出すために、そのコインを追跡したくなるかもしれません。イヴは受け取ったばかりのUTXOを他のUTXOと統合して、アリスに自分のウォレットにあるビットコインの量を明らかにしてしまうかもしれません。これを避けるために、Eveは受け取ったばかりのコインの履歴を壊すこともできます：


- イブ、グレース、マロリー、オスカー、ビクターはそれぞれ、ビットコイン取引の入力として98,000サットのUTXOを投入した：

![BTC204](assets/fr/111.webp)


- これらの入力を消費する見返りとして、各ユーザーは97,500の完全に等しい衛星からなる5つの出力を作成するために使用される空白のアドレスを提供する。各ユーザーは1つの出力を得る：

![BTC204](assets/fr/112.webp)


- イブは現在、履歴が破壊された97,500衛星のUTXOを保有している。イヴはこのUTXOを恐れることなく、今後の取引に使うことができる。実際、アリスがイヴに送ったビットコインを追跡しようとすると、コインジョイント取引に直面することになる。アリスはどのUTXOがイヴのものかを判断できない。分析が不可能になる：

![BTC204](assets/fr/113.webp)

最初の例では、コインジョイントが、その部屋のプライバシーを、その部屋の過去との関係において、どのように保護することができるかを見た。だからこそ、コインジョイントは、双方向の一部分の履歴を区分する一回限りの出来事とみなすべきだと述べたのである：

![BTC204](assets/fr/104.webp)

### ミキサー、コインジョイント、ミキサー...。その違いは？

コインジョイントは「ミキサー」と表現されることがあるが、一部のビットコイナーはカストディアル・ミキサーと混同されることを恐れて、この用語を拒否している。なぜなら、数学的な文脈では、コインジョイントはまさに「混合」の概念を体現しているからである。

一般的な数学の分野では、混合とは、ある一定の時間が経過すると、理論的には初期空間のすべての部分が他の部分と混合されるようになる力学系の性質を指す。混合とは、粒子の位置やシステムの状態が、将来の分布が初期分布に依存しないように進化し、初期状態の特徴がシステムの空間全体に一様に分布する状態になることを意味する。これはまさに、ビットコインによるコインジョイントで起こることである。つまり、coinjoinはまさにコインの混合法であると私は考えている。

![BTC204](assets/fr/114.webp)

一方、coinjoinとシャフラーを区別することも重要だ。シャフラーは、ユーザーがビットコインを送ってシャッフルしてもらうサービスである。これらのサービスは2010年代に人気を博したが、coinjoinと比較して2つの大きな欠点があるため、その利用は減少している：


- そのため、利用者は資金の保管を放棄しなければならず、盗難の危険にさらされる；
- ミキサーが取引の詳細を記録したり、チェーン分析会社にこの情報を売ったりしないという保証はない。

![BTC204](assets/fr/115.webp)

そのため、今日のユーザーはcoinjoinを好んでいる。なぜなら、coinjoinはプロセス全体を通して資金を完全に管理できるからである。Coinjoin の参加者は、他の関係者にビットコインを盗まれるリスクはない。次の章では、このようなことがどのように可能なのかを見てみよう。

## ゼロリンクとショーミアンのコインジョイント

<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>


コインジョイントが提供するプライバシーは、私たちの作品が隠されているグループの大きさによって得られる。つまり、できるだけ多くの参加者を見つけるということだ。自分で見つけたユーザーを使って手動でコインジョイントを作成することは完全に可能ですが、これは複雑なプロセスであり、大きなアノネットを獲得することはできません。

そのため、ビットコインではコインジョインコーディネーターが発達した。彼らの役割は、さまざまなユーザーを互いに連絡させ、共同取引を完了するために必要な情報を送信することである。

![BTC204](assets/fr/116.webp)

しかし、コーディネータがユーザーのビットコインを決して手にすることがないようにするにはどうすればいいのだろうか。また、コーディネータはcoinjoinトランザクションを構築する人物であるにもかかわらず、ユーザーのインプットとアウトプットをリンクさせることができず、機密漏洩となりうることをどうすれば保証できるのだろうか。

### チャウムのブラインドサイン

最近のコイン結合の実装では、David Chaumのブラインド署名を使って情報の漏洩を防いでいる。このブラインド署名の仕組みを簡単に見てみよう。

Chaumのブラインド署名はデジタル署名の一形態で、署名の発行者は署名するメッセージの内容を知らない。しかし、署名は元のメッセージと照合して検証することができる。この技法は1983年に暗号学者デビッド・チョームによって開発された。

![BTC204](assets/fr/117.webp)

契約書などの機密文書を、その内容を明らかにすることなく認証したいと考える企業を例にとってみよう。この企業は、元の文書を可逆的な方法で暗号的に変換するマスキング・プロセスを適用する。この変更された文書は認証機関に送られ、認証機関は基本的な内容を知ることなくブラインド署名を行う。署名された文書を受け取った後、企業は署名を解除する。その結果、認証局が元のコンテンツを見ることなく、認証局の署名によって認証されたオリジナル文書ができあがる。

したがって、Chaumのブラインド署名は、文書の内容を知らなくてもその文書の真正性を証明することができ、その結果、ユーザーのデータの機密性と署名された文書の完全性の両方を保証することができる。

### チャウミアン・コインジョイン

いわゆる "Chaumian "コイン結合は、TorとDavid Chaumのブラインド署名を組み合わせて、どの出力がどのユーザーのものかをコーディネータが知ることができないようにしている。

コインジョインの取引構築プロセスには、入力登録、出力登録、取引署名の3つの主要な段階がある。コインジョイン参加者の一人であるアリスの例を通してこのプロセスを見てみよう。他の参加者はそれぞれアリスと同じ手順を踏む。

**ステップ1：入力登録


- アリスはトランザクションの入力として使いたいUTXOと、ビットコインを受け取るための出力として使いたいマスクされた受信アドレスをコーディネータに送信する。したがって、コーディネータはアリスのアドレスを知る術がない。彼女のマスクされたバージョンしか見ることができない：

![BTC204](assets/fr/118.webp)


- コーディネータは入力の妥当性をチェックし、アリスのマスクされた アドレスに自分の秘密鍵で署名する。コーディネータはそのブラインド署名をAliceに返す：

![BTC204](assets/fr/119.webp)

**ステップ2：出力登録


- アリスはコーディネーターの秘密鍵で署名された自分のアドレスのマスクを外すことができる。彼女は別のTor IDで新しい接続を確立する。コーディネーターはこの新しいIDで接続しているのがアリスであることを識別できません：

![BTC204](assets/fr/120.webp)


- アリスはマスクされていないアドレスと署名をコーディネーターに送る（コーディネーターはまだそれがアリスだとは知らない）：

![BTC204](assets/fr/121.webp)

**ステップ3：取引に署名する**。


- 同様に、コーディネータはすべての参加者からマスクされていないアウトプットを取得する。関連する署名のおかげで、コーディネータは匿名で提出された各アウトプットが事前に自分の秘密鍵で署名されていることを確認でき、その正当性が保証される。その後、コーディネータはコインジョイントランザクションを作成し、参加者に送信して署名してもらう：

![BTC204](assets/fr/122.webp)


- Aliceは他の参加者と同様に、自分の入力と出力がコーディネー ターによって構築されたトランザクションに正しく含まれていることを チェックする。すべてが満足のいくものであれば、Aliceは自分の入力スクリプトのロックを解除する署名をCoordinatorに送る：

![BTC204](assets/fr/123.webp)


- coinjoinの参加者全員から署名を集めた後、コーディネーターはビットコインネットワーク上でトランザクションをブロードキャストし、ブロックに追加できるようにする。

このシステムでは、コーディネーターはインプットを特定のアウトプットに結びつけることができない。さらに、彼は参加者のUTXOのロックを解除するために必要な秘密鍵にアクセスすることができないため、参加者の資金を詐取することもできない。ステップ3の最後まで、彼は署名にもアクセスできない。アリスと他の参加者がグローバルトランザクションに署名し、すべてが正しいことを確認した後、コーディネータはトランザクションを無効にすることなく、出力を含むトランザクションを修正することができなくなる。これによりコーディネータがビットコインを盗むのを防ぐことができる。

最後に、コインジョイン・ユーザーは、自分のアウトプットを取引に登録する際、選挙で投票する市民のような保証を望む。これらの行動には、公的な側面と私的な側面の二面性がある。一方では、非公開にしたいことがある。有権者にとっては、自分の投票用紙と自分のIDがリンクされることを避けたい。コインジョインユーザーにとっては、自分の出力と自分の入力が関連付けられることを避けたい。実際、コーディネータやその他の関係者が、入力と出力の間のリンクを確立することに成功した場合、コイン結合はすべての関心を失う。上で説明したように、コインジョイントはコインの履歴の切れ目として機能しなければならない。この停止は、コインジョイントの取引において、特定のインプットと特定のアウトプットを関連付けること（プロスペクティブ・アノンセット）、およびその逆（レトロスペクティブ・アノンセット）が不可能であるために、正確に発生する。

投票者は自分の投票が投票箱に含まれていることを確認したい。同様に、コインジョインのユーザーは自分のアウトプットがコインジョイン取引に含まれていることを確認したい。実際、コインジョイントの参加者は、取引に署名する前に自分のアウトプットの存在を確認できなければならない。

デビッド・チャウムのブラインド署名を使用することで、まさにこの2つのパブリックとプライベートの側面が可能になり、チャウムのコインジョインの参加者は、自分のビットコインが盗まれることはなく、資金を追跡されることもないことが保証される。

### コインジョインのコンセプトを考案したのは誰ですか？

誰が最初にコインジョイントのアイデアをビットコインに導入し、誰がこの文脈でDavid Chaumのブラインド署名を使用するアイデアを思いついたのか、はっきり言うのは難しい。2013年のBitcoinTalkのメッセージ](https://bitcointalk.org/index.php?topic=279249.0)で最初に言及したのはグレゴリー・マクスウェルだと考えられている：

> *「Chaumのブラインド署名を使う：サーバーはトークンに署名して送り返す。サーバーはトークンに署名し、それを送り返す。ユーザーは匿名で再接続し、出力アドレスのマスキングを解除してサーバーに送り返す。サーバーは、すべての出力がサーバーによって署名され、その結果、すべての出力が有効な参加者からのものであることを確認できる。その後、人々は再接続し、署名する
Maxwell, G. (2013, August 22). *CoinJoin：現実世界のためのビットコインプライバシー*.ビットコイン・トーク・フォーラム https://bitcointalk.org/index.php?topic=279249.0

![BTC204](assets/fr/124.webp)

しかし、ミキシングの一部としてのChaum署名だけでなく、コイン結合に関する言及は他にもある。[2011年6月、Duncan TownsendはBitcoinTalk](https://bitcointalk.org/index.php?topic=12751.0)で、現代のChaumコインジョイントに非常に似た方法でChaum署名を使用するミキサーを発表した。

同じスレッドに、ミキサーを改良するための[ダンカン・タウンゼントに対するhashcoinからのメッセージ](https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793)がある。このメッセージに書かれているプロセスは、まさにコインジョイントのすべてである。同様のシステムについての言及は、[2012年のAlex Mizrahiからのメッセージ](https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry)にも見出すことができる。彼は、後にLitecoinを生み出す基礎となった最初のアルトコインの1つであるTenebrixのクリエイターにアドバイスをしていた。コインジョイント」という言葉自体も、グレッグ・マクスウェルによる造語ではなく、ピーター・トッドによるアイデアから生まれたと言われている。

![BTC204](assets/fr/125.webp)

### ゼロリンク

Zerolinkは、Chaumian coinjoinsと様々な戦略を組み込んだ包括的なミキシング・プロトコルであり、特にポートフォリオ管理に関連するエラーを最小限に抑えることで、いくつかの形式の連鎖分析からユーザーの匿名性を保護する。このプロトコルは[2017年にnopara73とTDevDによって紹介された](https://github.com/nopara73/ZeroLink/blob/master/README.md)。

![BTC204](assets/fr/126.webp)

その名前が示すように、Zerolinkの原理は、インプットとアウトプットの間のリンクを追跡できないようにするcoinjoinトランザクションを作成することである。これは、すべてのアウトプットが完全に同一金額であることを保証することによって達成される。

![BTC204](assets/fr/127.webp)

Zerolinkの重要な予防措置は、未混合のUTXOと混合のUTXOを、別々の暗号キーセット、あるいは別々のポートフォリオを使用することで完全に分離しておくことである。これにより、混合前の部品用の "*pre-mix*"ウォレットと、混合後の部品用の "*post-mix*"ウォレットを区別することができます。

![BTC204](assets/fr/128.webp)

このUTXOの厳密な分離は、何よりも混合UTXOと非混合UTXOの間の偶発的な関連付けを防ぐことに役立つ。実際、このようなリンクが発生した場合、混合UTXO上のコイン結合の有効性は、ユーザーが気づかないうちにキャンセルされ、その結果、ユーザーが破棄したと思っていたUTXOの履歴の機密性が損なわれる。このようなリンクは、ミックスされたUTXOをミックスされていないUTXOで確保する際にアドレスが再利用されるか、またはユーザーがミックスされたUTXOとミックスされていないUTXOを同じトランザクションの入力として消費する場合、CIOH（_Common-Input-Ownership Heuristic_）の適用によって発生する可能性がある。プレミックスポートフォリオとポストミックスポートフォリオを分離することで、このような偶発的な関連付けを回避し、ユーザーを不慮のエラーから保護する。

![BTC204](assets/fr/129.webp)

この分離は、ポートフォリオソフトウェアレベルで、プレミックスポートフォリオとポストミックスポートフォリオの間で異なるルールを適用する可能性も提供する。例えば、ポストミックス・ポートフォリオでは、ユーザーのアノ ンセットを損なうCIOHの適用を防ぐため、ソフトウェアがUTXOをインプッ トにマージすることを禁止することができる。また、ウォレットフィンガープリントによる識別を防ぐために、スクリプトやトランザクションオプション（例えば RBF レポートなど）の使用を標準化することも可能である。

現在、WhirlpoolはZerolinkプロトコルを厳密に適用した唯一のコインジョイント実装です。次の章では、存在する様々なコインジョイントの実装と、それぞれの利点と欠点について見ていきます。

## コイン結合の実装

<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>


*2024年、ビットコインでコインジョイントを行いたいユーザーが利用できるツールに大きな変化が起きている。現在、私たちは転換期を迎えており、コインジョイント市場は大規模な再編が行われています。この章は時間の経過とともに更新される予定です。

今のところ、ビットコインには主に3つの異なるコインジョイントの実装がある：


- ワールプール
- ワビサビ；
- ジョインマーケット

これらの実装はいずれも、コインジョイントランザクションを通じてUTXOの歴史を断ち切ることを目的としている。しかし、その仕組みはかなり異なっている。したがって、それぞれの仕組みを理解し、自分のニーズに最も適したオプションを選択することが不可欠である。

### ジョインマーケット

アダム・ギブソンとクリス・ベルチャーによって2015年に設立されたJoinMarketは、ユーザーをつなぐユニークなモデルのおかげで、他のcoinjoinの実装とは明らかに一線を画している。このシステムはP2P交換市場に基づいており、「メイカー」と呼ばれる一部のユーザーは自分のビットコインをミキシングに利用できるようにし、「テイカー」と呼ばれる他のユーザーは手数料と引き換えにこの現金を使ってコインジョイントを行う。

![BTC204](assets/fr/130.webp)

このモデルでは、"メイカー "が "テイカー "にビットコインを提供し、そのサービスに対して手数料を受け取る。一方、「テイカー」は、「メイカー」のビットコインを使用してコインジョイン取引を行うために料金を支払う。サービス料はその役割によって異なる：「メイカー」は流動性を提供することで手数料を蓄積し、「テイカー」は手数料を支払う。市場は自由に運営され、利用条件はない。

JoinMarketの主な欠点のひとつは、その使い方の複雑さであり、効果的に操作するためには端末にある程度の慣れが必要である。この複雑さは経験豊富なユーザーにとっては障害にはならないが、一般ユーザーにとってはアクセスが制限される可能性がある。しかし、最近JAMと呼ばれるウェブ・インターフェイスが導入され、少しは使いやすくなった。

![BTC204](assets/fr/131.webp)

出典：[JAM](https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

しかし、技術的な障壁は依然として大きな障害となっている。参加者の数によって機密性が強化されるコインジョイン・エコシステムでは、アクセスが制限されると、利用可能な流動性に直接影響する。ビットコインは金融取引においてすでにニッチであり、コインジョイントの利用はサブニッチと見なされている。JoinMarketはその中でもさらに特化した部分であるため、ユーザーのアノンセットを増やす可能性が制限されている。

JoinMarketはコインジョイナーに対する革新的なP2Pリンクモデルであるにもかかわらず、特にトランザクション構造の面で大きな欠点がある。Whirlpoolのような他の実装とは異なり、JoinMarketは出力間の完全な平等性を保証しておらず、入力と出力間の決定論的リンクを追跡することが可能である。さらに、JoinMarketにはすでに混合された部品が再び混合されるのを防ぐツールはなく、ユーザーの求める機密性が損なわれる可能性がある。

最後に、JoinMarketのコンセプトは、特にダイナミックな流動性市場に興味がある人にとっては興味深いものだが、その構造的な弱点と技術的な複雑さから、コインジョイントの実装を探している初心者と専門家の両方にとって、あまり興味深いものではないと私は思う。

### ワビサビ

Wabisabiはコインジョイントのもう一つの実装であり、トランザクションの調整を一元化するアプローチである。このモデルは2021年にÁdám Ficsór（nopara73）、Yuval Kogman、Lucas Ontivero、István András Seresによって考案され、翌年にWasabi 2.0ソフトウェアに統合された。Wabisabiはまさに、2018年に発表されたWasabiソフトウェアのコインジョインモデルを進化させたものである。

![BTC204](assets/fr/132.webp)

2010年代の終わり頃、WasabiはWhirlpoolとは根本的に異なるコインジョイント取引の仕組みを採用した。Wasabiは数十人の参加者を含む非常に大規模なコインジョイント取引を行い、参加者のアノンセットを増加させた。対照的に、Whirlpoolは複数の小規模な取引を採用し、サイクルごとに指数関数的にアノンを増やすことを可能にした。

為替管理方法も2つの実装を区別した。Whirlpoolでは、TX0のおかげで、外国為替はコインジョインサイクルの前にUTXOから除外され、分離されていた。一方、Wasabiでは、外国為替はコインジョイントランザクションのアウトプットの1つとなり、特定のインプットとアウトプットの間の決定論的なリンクを維持しました。

![BTC204](assets/fr/133.webp)

Wabisabiにより、Wasabiバージョン2.0はコイン結合へのアプローチをWhirlpoolと同じにした。コインジョイン取引は依然として非常に大規模であるが、ワールプールモデルに従って、複数の連続したサイクルを連鎖させることが可能になった。ワビサビ1.0では、為替レートはユーザーの入力に直接リンクしていたが、ワビサビでは、為替レートをいくつかの小額に細分化し、すべての参加者が等しい額面になるように分割している。

2人のユーザーを単純化した例で説明しよう：アリスは115,000サットを、ボブは210,000サットを混合したい。手数料を無視すると、Wasabi 1.0では、コインジョイン取引は100,000サットの3つの出力と、アリスへの15,000サットの1つの交換、ボブへの10,000サットの1つの交換を生成したことになる。交換のアウトプットは依然としてインプットにリンクされている：

![BTC204](assets/fr/134.webp)

ワビサビでは、同じ取引で10万サットのアウトプットが3回、5千サットのアウトプットが5回発生し、交換が分散されるため、特定のインプットに直接リンクさせることができない：

![BTC204](assets/fr/135.webp)

個人的には、ワビサビの為替管理には、機密保持の面で有効性を損ないかねないいくつかのリスクがあると感じている：


- ユーザーが他の参加者よりもかなり大きなUTXOを提供した場合、必然的にそのユーザーは自分の入力にリンクされた交換額を持つことになる。これは、識別可能な交換をすべて排除するというプロトコルの本来の目的に反する；
- 交換を細分化する目的でデノミネーションを増やすことは、逆説的に混合効率に悪影響を及ぼす可能性がある。このプロセスは、特定のアウトプットのアノンセットの減少につながる可能性がある；
- この方法では、価値の低いUTXOも生成され、ユーザーにとって管理上の問題となる。このような小さなUTXOは、その価値に比して使用コストが高くなりすぎると、「塵」となる可能性がある。この現象により、ユーザーは複数のUTXOを将来のトランザクションのためのインプットに統合するか、それらを統合することになる。どちらの場合も、CIOHによって、得られるアノニセットが減少するか、最初のコイン結合によって得られた秘密保持の利益が完全に打ち消される可能性がある。

ゼロリンク・プロトコルを実装し、プレミックスUTXOとポストミックスUTXOの厳格な分離を保証しているワールプールとは異なり、ワビサビはこの厳格な分離を維持していない。また、一部のワサビ顧客によるアドレス再利用の問題も発生しており、これは明らかにユーザーにとって非常に不利である。

Wasabiバージョン2.0では、新しいコインジョイント手数料ポリシーが導入されました。今後、0.01ビットコイン以上のUTXOの場合、調整手数料は0.3%に設定され、それ以下のUTXOの場合、これらの手数料は全額提供されます。さらに、これらの小さなUTXOのリミックスは無料ですが、リミックスを含むすべてのトランザクションの採掘手数料はユーザーが支払う必要があります。

これは、取得したアノ ンセットのサイズに関係なく手数料が固定されるWhirlpoolのポリシーとは対照的である。Wasabi 2.0では、小規模のUTXOについてはコーディネーターの手数料が免除されるものの、ユーザーはリミックスを含むすべての取引でマイニング手数料を支払う必要がある。

この行を書いている今、最近の出来事の結果、ワビサビの利用は著しく複雑になっている。Samourai Walletの創設者が逮捕されたことを受け、ワサビの開発に資金を提供し管理しているzkSNACKs社は、コインジョイン・コーディネーターのサービスを2024年6月1日に廃止すると発表した。Wasabiのデフォルトで設定されていたこのコーディネーターは、流動性の大部分を担っていた。

このメイン・コーディネーターの廃止に伴い、ユーザーは新しい独立したコーディネーターに接続しなければならなくなった。一方では、新しいコーディネーターは十分な流動性を持っていない可能性があり、コインジョイントの機密性の有効性が低下する。一方では、悪意のあるコーディネーターに出くわすリスクもある。このような状況は、ワビサビを利用しようとする人々にとって重大な新たなリスクとなる。

技術的な問題だけでなく、Wasabiの運営会社であるzkSNACKsが、コインジョイントの参加者をフィルタリングするために文字列解析会社のサービスを利用するという決定は、深刻な倫理的・戦略的問題を提起している。当初のアイデアは、犯罪者によるWasabi上でのコインジョイントの使用を防ぐことであった。しかし、ユーザーの機密保持を強化することを第一の使命とするコーディネーターに料金を支払いながら、同じ機密保持を危うくすることを目的とする企業に資金を提供させるというパラドックスが生じる。

さらに心配なのはフィルタリングの原則で、オープンで検閲のない金融システムを提供するというビットコインの理念とは根本的に対照的だ。犯罪行為を排除したいと考えるのは正当化されるように思えるかもしれないが、このフィルタリングは、ある文脈では違法と分類されるものの、道徳的に正当化されたり、社会的に有益であったりする可能性のある行為にも影響を及ぼす可能性がある。エドワード・スノーデンの例は、この二律背反を見事に示している。彼の暴露によって一部の政府からは犯罪者とみなされ、他の政府からは公益のために行動した内部告発者とみなされている。この複雑さは、善意ではあっても、最終的には合法的な利用者の権利と安全を損ないかねないフィルタリングの潜在的な危険性を強調している。また、特定の権威主義体制の下で迫害されている活動家やジャーナリストについても言及することができた。

もうお分かりのように、私はビットコインのコインジョインにはワールプールモデルを好んでいる。このシステムはその厳格さで際立っており、機密性の優れた保証を提供している。また、数学的な文脈で完璧とみなされるミックスを提供する唯一のものです。私の意見では、このモデルはビットコインにおけるコインジョイントの未来を象徴しています。次の章で、このモデルをより深く探求していただきたい。

## ワールプールの仕組み

<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>


Whirlpoolが他のコインジョイント方式と異なる点は、「_ZeroLink_」トランザクションを使用していることで、すべてのインプットとアウトプットの間に技術的なリンクが厳密に存在しないことを保証しています。この完璧な組み合わせは、各参加者が（マイニング手数料を除いて）同量のインプットを提供し、完全に同量のアウトプットを生成する構造によって達成されます。

インプットに対するこのような制限的なアプローチにより、Whirlpool のコインジョイン取引には、インプットとアウトプットの間に決定論的なリンクが全くないというユニークな特徴がある。すなわち、インプットとアウトプットの間に決定論的なリンクがまったく存在しないということである。言い換えれば、各アウトプットは、取引における他のすべてのアウトプットに対して、どの参加者にも帰属する確率が等しいということである。

![BTC204](assets/fr/136.webp)

### ワールプールの仕組み

当初、各Whirlpoolコインジョイントの参加者数は5人に制限され、新規参入者が2人、リミキサーが3人だった（これらの概念については後で説明する）。しかし、2023年に観察されたオンチェーン取引手数料の増加により、Samourai氏のチームはコストを削減しつつ機密性を向上させるためにモデルの見直しを行った。そこで、手数料市場の状況と参加者の数を考慮し、コーディネーターは6人、7人、8人の参加者を含むコインジョインを開催できるようになった。こうした強化されたセッションは「サージ・サイクル」と呼ばれる。どのような構成であっても、Whirlpoolコインジョインへの新規参加者は常に2人だけであることに注意することが重要である。

従って、Whirlpoolの取引は、同じ数の入力と出力によって特徴付けられ、それは：


- 5入力、5出力；

![BTC204](assets/fr/137.webp)


- 6入力、6出力；

![BTC204](assets/fr/138.webp)


- 7入力、7出力；

![BTC204](assets/fr/139.webp)


- 8入力8出力。

![BTC204](assets/fr/140.webp)

Whirlpoolのモデルは小規模なコインジョイント取引に基づいている。WabisabiやJoinMarketのように、アノンセットの堅牢性が1サイクル（または数サイクル）の参加者の量に基づいているのとは異なり、Whirlpoolはいくつかの小さなサイクルの連続に依存している。

このモデルでは、ユーザーは最初にプールに参加するときだけ料金を支払うので、追加料金なしで多数のリミックスに参加できる。新規参入者は、リミキサー用のマイニング料金を支払う。

ある楽曲がコインジョイントに参加するたびに、また過去に参加した楽曲がコインジョイントに参加するたびに、アノン・セットは指数関数的に増えていく。このような自由なリミックスを利用することが目的であり、リミックスが起こるたびに、ミックスされた各作品に関連するアノニセットの密度を強化することに貢献する。

![BTC204](assets/fr/141.webp)

ワールプールは、2つの重要な要件を念頭に置いて設計されています：


- サムライ・ウォレットは何よりもまずスマートフォンのアプリケーションであることから、モバイル機器への実装が容易である；
- アノンセットの大幅な増加を促進する高速リミックスサイクル。

サムライ・ウォレットの開発者がWhirlpoolを設計する際に選択したのは、このような要件であった。参加者が少なすぎればコイン結合の効率性が損なわれ、サイクルごとに生成されるアノンセットが激減し、多すぎればモバイルアプリケーションでの管理に問題が生じ、サイクルの流れが阻害されるからだ。

最後に、Whirlpoolでは、コインジョイントごとに参加者の数を多くする必要はない。ここで最も重要な原則は、すべての参加者のUTXOが均一であることです。これにより、完璧なミキシングが保証されるため、ミキシングとリミキシングのサイクルから十分な利益を得ることができます。

### コインジョイン・プールと手数料

このような複数サイクルで混合パーツのアノンセットを増やすためには、UTXOの使用量を制限する一定の枠組みが必要である。Whirlpoolは異なるプールを定義している。

プールは、完全なパーツの均質性を維持しながらコイン結合プロセスを最適化するために使用するUTXOの量に合意した、一緒に混合を希望するユーザーのグループを表します。各プールは固定のUTXO量を指定し、ユーザーは参加するためにそれを守らなければなりません。そのため、Whirlpoolでコインジョイントを行うには、プールを選択する必要があります。現在、以下のプールが利用可能です：


- 0.5ビットコイン；
- 0.05 ビットコイン ；
- 0.01 ビットコイン ；
- 0.001ビットコイン（＝100,000サット）。

プールにビットコインを投入すると、プールの他の参加者と完全に均質なUTXOが生成されるように分割されます。各プールには上限があるため、この上限を超える金額については、同じプールに2回に分けてエントリーするか、より金額の高い別のプールに移動する必要があります：

| プール（ビットコイン）｜1エントリーあたりの上限額（ビットコイン

|----------------|--------------------------------------|



| 0,05 | 3,5 |

| 0,01 | 0,7 |



UTXOは、コインジョイントに組み込む準備ができた時点でプールに属するとみなされる。しかし、これはユーザーがその所有権を失うことを意味するものではありません。このセクションの最初の章で見たように、様々なミキシングサイクルを通じて、ユーザーは自分の鍵、ひいては自分のビットコインを完全に管理し続けることができる。これがcoinjoinの手法が他の中央集権的なミキシング手法と異なる点である。

coinjoinプールに参加するには、サービス料とマイニング料を支払う必要があります。サービス料は各プールに固定されており、Whirlpoolの開発とメンテナンスを担当するチームへの報酬を目的としています。

ワールプールの利用料は、プール入会時に一度だけお支払いいただきます。一度参加すれば、追加料金なしで無制限にリミックスに参加できます。現在の各プールの固定料金は以下の通りです：

| プール（ビットコイン）｜エントリーフィー（ビットコイン

|----------------|---------------------------------|

| 0,5 | 0,0175 |

| 0,05 | 0,00175 |

| 0.01｜0.0005（5万サット

| 0.001｜0.00005（5,000サット

これらの手数料は、coinjoinに投入した金額にかかわらず、基本的に選択したプールへの入場券として機能します。つまり、0.01BTCで0.01プールに入ろうが、0.5BTCで0.01プールに入ろうが、手数料の絶対額は変わりません。

ワールプールのコインジョイントを行う前に、ユーザーは2つの戦略を選択することができる：


- サービス・コストを最小限に抑えるため、小規模のプールを選ぶ；
- あるいは、より大きなプールを選び、高い手数料を支払うことを厭わないが、より価値の高いUTXOの数が少なくなってしまう。

一般的に、コインジョインサイクルの後に複数の混合UTXOをマージすることは推奨されません。これは、特に共通入力所有ヒューリスティック（CIOH：*Common-Input-Ownership-Heuristic*）により、獲得した機密性を損なう可能性があるからです。その結果、出力に小さな値のUTXOが多すぎることを避けるために、たとえ多く支払うことになったとしても、より大きなプールを選択することは理にかなっているかもしれない。ユーザーは、これらのトレードオフを評価して、好みのプールを選択しなければならない。

サービス料に加えて、ビットコイン取引に固有のマイニング料も考慮する必要があります。Whirlpoolのユーザーとして、あなたは準備トランザクション（`Tx0`）と同様に最初のコイン参加にマイニング料金を支払う必要があります。Whirlpoolの新規参入者への支払いに基づくモデルのおかげで、その後のリミックスはすべて無料となります。

実際、それぞれのWhirlpool coinjoinでは、インプットのうち2つのユーザーが新規参入者である。他のインプットはリミキサーからのものである。その結果、トランザクションの全参加者のマイニングコストは、この2人の新規参入者が負担し、彼らは無料のリミックスからも利益を得ることができます：

![BTC204](assets/fr/142.webp)

この料金システムのおかげで、Whirlpoolは他のcoinjoinの実装とは一線を画しています。その結果、2つのトランザクション（Tx0とイニシャルミックス）に対してプール参加料とマイニング料のみを支払うことで、かなり高いレベルの匿名性を達成することができます。

ただし、「mix to」オプションを選択した場合は、追加取引なしでcoinjoinから直接資金を受け取る外部アドレスを提供します。

### HDポートフォリオ口座

Whirlpool経由でコインジョイントを作成するには、ウォレットは複数の個別のアカウントを生成する必要があります。これがZeroLinkプロトコルの原理です。HD (*Hierarchical Deterministic*)ポートフォリオのコンテキストでは、アカウントは他のものから完全に分離されたセクションを構成し、この分離はポートフォリオ階層の3番目の深さのレベル、すなわち`xpub`レベルで発生します。

![BTC204](assets/fr/143.webp)

HDウォレットは理論上、最大`2^(31)`の異なるアカウントを導き出すことができる。初期アカウントはすべてのビットコインウォレットでデフォルトで使用され、`0'`インデックスに対応する。

ワールプールに適合したポートフォリオの場合、ゼロリンク・プロセスのニーズを満たすために4つの口座が使用される：


- インデックス `0'` で識別される **預金** 口座；
- 2,147,483,644'`というインデックスで識別される**バッドバンク**（または「ドキシック・チェンジ」）口座；
- 2 147 483 645'`というインデックスで識別される**プレミックス**勘定である；
- 2 147 483 646'`というインデックスで識別される**ポストミックス**口座。

これらのアカウントはそれぞれ、コインジョイントのプロセスにおいて特定の機能を果たす。

これらのアカウントはすべて1つのシードにリンクされており、ユーザーは自分のリカバリフレーズと、該当する場合はパスフレーズを使用して、すべてのビットコインへのアクセスを回復することができます。しかしながら、回復操作の間、ソフトウェアは使用される様々なアカウントインデックスを知らされなければならない。

これらのアカウントにおけるワールプールのコインジョイントのさまざまな段階を見てみよう。

### TX0

Whirlpoolコインジョイントの開始点は、**預金**アカウントです。これは、新しいビットコインウォレットを作成する際に自動的に使用されるアカウントです。このアカウントに、ミックスしたいビットコインを入金する必要があります。

Tx0」は、Whirlpoolのミキシングプロセスにおける最初のステップである。その目的は、コインジョイン用のUTXOを準備し均等化し、選択されたプールの量に対応する単位に分割し、均質な混合を保証することである。こうして均等化されたUTXOは、**premix**アカウントに送られる。プールに入ることができない差額については、**バッドバンク**（または「ドキシックチェンジ」）という特定の口座に分けられます。

この最初のトランザクション`Tx0`は、coinjoinコーディネーターへのサービス料の支払いにも使用される。以下のステップとは異なり、このトランザクションは協調的ではないため、ユーザーはマイニングの全コストを負担しなければならない：

![BTC204](assets/fr/144.webp)

この「Tx0」トランザクションの例では、私たちの**預金**口座からの「372,000サット」の入力は、いくつかの出力UTXOに分割され、その内訳は次のとおりである：


- プール・エントリー100,000サッツに相当するサービス料として、コーディネーターに5,000サッツを支払う；
- 3つのUTXOがミキシング用に準備され、当社の**premix**アカウントにリダイレクトされ、コーディネーターに登録される。これらのUTXOはそれぞれ`108,000 sats`で均等化され、将来の初期ミックスのための採掘コストをカバーする；
- 余剰金が少なすぎるためにプールに入ることができないものは、有害な外国為替とみなされる。これは特定の口座に送られる。ここでは、この為替は`40,000 sats`に相当する；
- Tx0`を確認するために必要な採掘コストである。

例えば、これは本物のWhirlpool Tx0です（私のものではありません）：[edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/fr/145.webp)

### 毒素による変化

プールに組み入れられなかった余剰分（ここでは4万サットに相当）は、ポートフォリオ内の他のUTXOから厳密に分離するため、「ドキシック・エクスチェンジ」とも呼ばれる**バッドバンク**口座に振り向けられる。

このUTXOは、ユーザーの機密性にとって危険である。なぜなら、このUTXOには過去の履歴が残っており、そのため所有者の身元がわかってしまう可能性があるだけでなく、コインジョイントを行ったユーザーのものであることが記録されてしまうからである。

![BTC204](assets/fr/146.webp)

このUTXOが混合出力とマージされた場合、後者は、特にCIOH（*Common-Input-Ownership-Heuristic*）により、コイン結合サイクル中に得られた機密性をすべて失うことになります。もしそれが他のdoxicな変更とマージされた場合、様々なcoinjoinサイクルのエントリーがリンクされるため、ユーザーは機密性を失う危険があります。したがって、慎重に扱われるべきです。これらのUTXOs doxxicの管理については、この章の最後のセクションで詳しく説明します。

### 初期ミックス

Tx0`の後、均等化されたUTXOはポートフォリオの**premix**アカウントに送られ、「イニシャルミックス」とも呼ばれる最初のコイン接合サイクルに導入される準備が整います。この例のように、`Tx0`がミキシングのために複数のUTXOを生成した場合、それぞれのUTXOは別々のイニシャルミックスに統合されます。

これらの最初のミックスが終わると、**premix**アカウントは空になり、私たちのコインは、この最初のコイン結合のための採掘手数料を支払った後、選択したプールによって定義された量に正確に調整されます。この例では、最初のUTXOである`108,000 sats`はちょうど`100,000 sats`に減少します。

![BTC204](assets/fr/147.webp)

### リミックス

最初のミックスの後、UTXOは**postmix**アカウントに転送されます。このアカウントには、すでにミックスされたUTXOとリミックス待ちのUTXOが集められます。Whirlpoolの顧客がアクティブになると、**postmix**アカウントにあるUTXOは自動的にリミックスに使用できるようになり、これらの新しいサイクルに参加するためにランダムに選択されます。

注意点として、リミックスは100％無料です：追加サービス料や採掘料は必要ありません。そのため、UTXOを**postmix**アカウントに保管することで、UTXOの価値はそのまま維持され、同時にアノンセットも改善されます。そのため、これらのコインをいくつかのcoinjoinサイクルに参加させることが重要です。これには全くコストがかかりませんし、匿名性のレベルも向上します。

ミックスされたUTXOを使用する場合、この**postmix**アカウントから直接使用することができます。ミックスUTXOは、無料リミックスの恩恵を受けるため、またワールプール回路から出るのを防ぐため、このアカウントに保管することをお勧めします。

### ポストミックスはどのように管理していますか？

コインジョインサイクルを実行した後は、UTXOを**postmix**アカウントに保管し、将来の使用を待つのが最善の戦略です。使う必要があるまで、無期限にリミックスしておくことをお勧めします。

一部のユーザーは、ハードウェアウォレットによって保護されたウォレットに混合ビットコインを転送することを検討するかもしれません。これは可能ですが、取得した機密性を損なわないよう、Samourai Walletの推奨事項に注意深く従うことが重要です。

UTXOのマージは最も一般的な間違いである。CIOH（*Common-Input-Ownership-Heuristic*） を避けるためには、混合UTXOと非混合UTXOを同じ取引で組み合わせることを避けなければならない。そのためには、ポートフォリオ内のUTXOの管理、特にラベリングに注意する必要がある。

![BTC204](assets/fr/148.webp)

混合UTXOをコンソリデーションする場合にも注意が必要です。混合されたUTXOに重要なアノンセットがある場合、適度なコンソリデーションは可能だが、これは必然的にパーツの機密性を低下させる。コインジョインサイクルの前後で、UTXO間に推測可能なリンクが確立される危険性があります。これらの操作に疑問がある場合、ベストプラクティスは、ポストミックスのUTXOを統合するのではなく、1つずつハードウェアウォレットに移し、その都度新しいブランクアドレスを生成することです。もう一度言いますが、受け取った各UTXOにラベルを付けることを忘れないでください。

また、広く使われていないスクリプトを使ってポストミックスのUTXOをウォレットに移すこともお勧めできません。例えば、`P2WSH`スクリプトを使ってマルチシグウォレットからWhirlpoolに入る場合、元々同じタイプのウォレットを持っていた他のユーザーと混ざる可能性はほとんどありません。ポストミックスをこの同じマルチシグウォレットに再ミックスした場合、ミックスしたビットコインの機密性は大幅に低下します。スクリプト以外にも、あなたを欺く可能性のあるウォレットのフィンガープリントはたくさんあります。

他のビットコイン取引と同様に、受信アドレスを再利用しないことも重要です。それぞれの新しいトランザクションは、新しい空白のアドレスで受信する必要があります。

最もシンプルで安全な解決策は、ミックスしたUTXOを**postmix**アカウントに静止させ、リミックスさせ、使う時だけ触れるようにすることです。SamuraiウォレットとSparrowウォレットは、このような連鎖分析リスクに対する追加保護機能を備えています。これらのプロテクションはミスを避けるのに役立ちます。

### 有害な交流はどのように管理していますか？

次に、coinjoinのプールに入れなかった取引所であるdoxic exchangeの管理には注意が必要です。これらの有毒なUTXOは、Whirlpoolを使用した結果、あなたとcoinjoinユーザーとの間にリンクを確立するため、あなたのプライバシーにリスクをもたらします。そのため、他のUTXO、特に混合UTXOと組み合わせないよう、注意して管理する必要があります。

ここでは、それらを使うための戦略をいくつか紹介しよう：


- 小さいプールに混ぜる：** 有毒なUTXOが、それだけで小さいプールに入るほど大きい場合は、混ぜることを検討する。これが最善の選択肢であることが多い。しかし、複数の有毒UTXOを統合してプールにアクセスすることはお勧めできません；
- 使用不可」とマークする：** もうひとつの方法は、使用を中止し、専用アカウントで「使用不可」とマークし、そのままホドルすることだ。こうすることで、誤って使ってしまうことを防ぐことができる。ビットコインの価値が上がれば、あなたの有害なUTXOにより適した新しいプールが出現するかもしれない；
- 寄付をする：** ビットコインや関連ソフトウェアに取り組んでいる開発者に、ささやかでも寄付をすることを検討してください。BTCを受け入れている団体に寄付することもできる。有毒なUTXOの管理が複雑すぎるようであれば、それらを処分して寄付をすることもできます；
- ギフトカードの購入:** [Bitrefill](https://www.bitrefill.com/)のようなプラットフォームでは、ビットコインを様々な商店で使えるギフトカードに交換することができる。これは、関連する価値を失うことなく、有毒なUTXOを手放す方法です；
- Moneroに集約:** Samourai WalletはBTCとXMR間のアトミックスワップサービスを提供しています。これは、CIOHを経由して機密性を損なうことなくMoneroに集約してからBitcoinに送り返すことで、有毒なUTXOを管理するのに理想的です。しかし、このオプションは流動性の制約により、採掘手数料とプレミアムの点でコストがかかる可能性があります；
- ライトニング・ネットワークに送る：** これらのUTXOをライトニング・ネットワークに転送し、取引手数料の削減の恩恵を受けることは、魅力的なオプションとなり得る。しかし、この方法は、Lightningの使用方法によっては特定の情報が明らかになる可能性があるため、注意して使用する必要があります。

### ワールプールの使い方は？

2024年4月24日にSamourai Walletの創設者が逮捕され、サーバーが押収された後、Whirlpoolツールは、独自のDojoを持っている人でも使えなくなりました。以前はSamourai WalletとSparrow Walletで利用可能でした。

![BTC204](assets/fr/149.webp)

しかし、トライアルの結果次第では、このツールが今後数週間で再稼働するか、別の形で再スタートする可能性は残っている。いずれにせよ、需要がある以上、ビットコインのコインジョイント市場が長く供給なしになるとは思わない。さらに、Whirlpoolのモデルは機密性という点で最も先進的であるため、将来的に他の実装モデルとして選択されることは間違いないだろう。

私たちはこの事件と関連ツールの動向を注視しています。新しい情報が入り次第、このトレーニングコースを更新していきますのでご安心ください。

次の章では、「アノンセット」とは何か、この指標はどのように計算されるのか、そしてコインジョインサイクルの効率を推定するためにどのように役立つのかについて説明する。

https://planb.network/tutorials/privacy/on-chain/coinjoin-sparrow-wallet-84def86d-faf5-4589-807a-83be60720c8b

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef

https://planb.network/tutorials/privacy/on-chain/coinjoin-dojo-c4b20263-5b30-4c74-ae59-dc8d0f8715c2

## 匿名セット

<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>


コインジョイントの仕組みと、効果的なミキシングに関わる問題を勉強したところで、今度はその効果を測定する方法を調べよう。コインジョインが効果的であったかどうか、またあるパートがどの程度の匿名性を獲得したかを判断するにはどうすればよいのだろうか。この章では、アノニマスセット（anonset）を使って、それを明らかにしていく。

### coinjoinの便利さを思い出す

coinjoinの有用性は、区別のつかないパーツのグループの中に自分のパーツを埋め込むことで、もっともらしい否認可能性を作り出す能力にある。この行為の目的は、過去から現在へ、そして現在から過去への追跡可能性のリンクを断ち切ることである。

言い換えれば、コインジョインサイクルのエントリー時の最初の取引（Tx0）を知っているアナリストは、リミックスサイクルのエグジット時のUTXOを確実に特定することはできないはずです（サイクルエントリーからサイクルエグジットまでの分析）。

![BTC204](assets/fr/150.webp)

逆に、コイン結合サイクルの出口であなたのUTXOを知っているアナリストは、サイクルの入口で元の取引を判断することができないはずです（サイクル出口からサイクル入口への分析）。

![BTC204](assets/fr/151.webp)

分析者が過去と現在を結びつけること、あるいはその逆を行うことがどれほど難しいかを評価するためには、自分の部分が隠れている同質の部分のグループの大きさを定量化する必要がある。この尺度によって、いくつの分析が同じ確率を持つかがわかる。つまり、正しい分析が、同じ確率の他の3つの分析にかき消されている場合、あなたの隠蔽レベルは非常に低いということになります。一方、20,000の同じ確率の分析の集合の中に正しい分析がある場合、あなたの部分は非常によく隠されています。これらのグループの大きさは、「アノンセット」として知られる指標を表している。

### アノンセットを理解する

アノンセットは、特定のUTXOの機密性の程度を評価する指標として使用される。より具体的には、研究対象部分を含む集合内の区別できないUTXOの数を測定する。UTXOの均質な集合の要件は、アノンセットが通常コイン結合サイクルで計算されることを意味する。これらの指標の使用は、その均一性から、特にワールプールコインジョイントに関連する。

必要であれば、コインジョインの質を判断するためにアノニセットを使用することができる。アノンセットが大きいと、均質な集合の中で特定のUTXOを区別することが難しくなるため、匿名性が高いことを意味します。

2種類のアノンセットが存在する：


- アノニセットの見込み ;**)
- レトロスペクティブ・アノンセット

### アノンセットの見込み

フォワード・ルッキング・アノンセットは、サイクル開始時のUTXOから、サイクル終了時に調査されたUTXOが隠されているグループの大きさ、すなわち、このグループ内に存在する区別できない部分の数を示す。この指標の名称は "forward-looking metrics "である。

この指標は、過去から現在（入力から出力）への分析に対する部屋の機密性の耐性を測定する。

![BTC204](assets/fr/152.webp)

この指標は、あなたのUTXOが、コイン結合プロセスにおいて、そのUTXOが入った時点から出た時点までの履歴を再構築する試みに対して、どの程度保護されているかを推定するために使用されます。

例えば、あなたの取引が最初のコイン接合サイクルに参加し、さらに2つの下降サイクルが完了した場合、あなたのコインのアノーンセット見込みは `13` となります：

![BTC204](assets/fr/153.webp)

例えば、コイン結合サイクルの最初にあるコインのアノンセットが86,871`であったとしよう。現実的な言い方をすれば、これは「86,871`個の区別のつかない部分の中に隠れている」ことを意味します。コイン接合サイクルの開始時にこのコインを知っている外部の観察者が、そのコインの出口をたどろうとすると、「86,871`個のUTXOの可能性があり、それぞれが探しているコインである確率が同じ」という状況に直面することになる。

![BTC204](assets/fr/154.webp)

### レトロスペクティブ・アノンセット

レトロスペクティブ・アノンセットは、サイクル終了時にUTXOを知ることで、ある部品の出所の可能性の数を示します。この指標は、現在から過去への（出力から入力への）分析に対する部品の機密性の耐性を測定します。つまり、コインジョインサイクルの前に、アナリストが部品をその起源まで遡ることがどれだけ難しいかを測定します。この指標の名前は「バックワード・アノンセット」、または「バックワード・ルッキング・メトリクス」です。

![BTC204](assets/fr/155.webp)

サイクルの出口での UTXO を知ることで、遡及的アノニセットは、コインジョインサイクルへのエントリーを構成する可能性のある Tx0 取引の数を決定する。下図では、これはオレンジ色のバブルの合計に相当する。

![BTC204](assets/fr/156.webp)

例えば、コインジョインパートのアノニ ーズが42,185`であったとしよう。実用的な言い方をすれば、このUTXOには42,185`の発生源の可能性があるということである。外部のオブザーバーがサイクルの終わりにこのコインを特定し、その出所をたどろうとした場合、そのオブザーバーは`42,185`の出所の可能性に直面することになります。

![BTC204](assets/fr/157.webp)

### アノンセットはどのように計算するのですか？

小さなアンサンブルであれば、ブロック・エクスプローラーを使って手動でアノンシェットを計算することが可能である。しかし、より大きなアノンシェットを計算するためには、専門的なツールの使用が不可欠になります。私が知る限り、このタスクを実行できる唯一のソフトウェアは、*Whirlpool Stats Tool*で、SamouraiチームとOXTチームによって開発されたPythonツールです。残念ながら、このツールはSamouraiの創設者が逮捕され、ブロックチェーンからデータを抽出するために使用されていたOXTが中断されたため、現在サービスを停止している。

![BTC204](assets/fr/158.webp)

本章で見てきたように、アノンセットはコインジョイント構造に一定の均質性がある場合にのみ計算できる。次の章では、コインジョインであれ、より伝統的な取引であれ、ビットコイン取引でこの同質性を定量化する方法を見つける。

https://planb.network/tutorials/privacy/analysis/wst-anonsets-0354b793-c301-48af-af75-f87569756375

## エントロピー

<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>


コインジョインに関するこのセクションで見てきたように、入力と出力におけるUTXOの同質性は、ビットコイン取引の機密性を向上させる上で重要な役割を果たす。このパラメータは、ブロックチェーン分析を前にして、もっともらしい否認可能性を生み出す。この均質性を測定するためにいくつかの方法を使用することができますが、私の意見では、最も効果的なものの1つは、OXTとSamourai Walletチームによって開発された*Boltzmann*ツールによって提供される指標、特にトランザクションのエントロピーを使用することです。この章ではこれを詳しく見ていく。

一連の取引について計算されるアノンセットとは異なり、ここで紹介する指標は、コインジョインであれ、より伝統的な取引であれ、単一の取引に焦点を当てている。

### 解釈の数

ビットコイン取引で観察できる最初の指標は、外部のオブザーバーからの分析に直面する可能な解釈の総数である。取引に関与する UTXO の値を考慮に入れて、この指標は入力が出力に関連付けられ得る方法の数を示す。言い換えれば、この指標はトランザクションを分析する外部のオブザーバーから見たビットコインフローの解釈の可能性の数を決定する。

例えば、1入力2出力の単純な支払取引は、1つの解釈しか持たない。すなわち、入力#0が出力#0と出力#1を賄ったという解釈である。それ以外の解釈はありえない：

![BTC204](assets/fr/159.webp)

一方、ワールプールの5×5コーナーは$1,496$の組み合わせが可能である：

![BTC204](assets/fr/160.webp)

Whirlpool Surge Cycle 8x8 coinjoinには、$9,934, 563$の解釈が可能：

![BTC204](assets/fr/161.webp)

### エントロピー

ビットコイン取引の解釈の数から、そのエントロピーを計算することができる。

暗号と情報の一般的な文脈では、エントロピーは、データソースやランダムなプロセスに関連する不確実性や予測不可能性の定量的な尺度である。言い換えれば、エントロピーとは、ある情報の断片を予測したり推測したりするのがどれだけ難しいかを測定する方法である。

ブロックチェーン分析に特化した文脈では、エントロピーはシャノンのエントロピーに由来し、[LaurentMTによって発明された](https://gist.github.com/LaurentMT/e758767ca4038ac40aaf)、ビットコイン取引で計算できる指標の名前でもある。

ある取引が多数の解釈の可能性を提示する場合、しばしばそのエントロピーを参照することがより適切である。この指標はトランザクションの正確な構成に関するアナリストの知識不足を測定する。言い換えれば、エントロピーが高ければ高いほど、アナリストがインプットとアウトプットの間のビットコインの流れを特定することが難しくなる。

実際には、エントロピーは、外部の観察者から見て、取引が、他の外部または内部のパターンやヒューリス ティックを考慮することなく、インプットとアウトプットの量のみに基づいて、複数の可能な解釈を示 すかどうかを明らかにする。したがって、エントロピーが高いことは、取引の機密性が高いことと同義である。

エントロピーは可能な組み合わせの数の2進対数として定義される。E$は取引のエントロピー、$C$は可能な解釈の数である：

$$
E = \log_2(C)
$$

つまり、$x$の2進対数とは、$x$を得るために$2$を上げる指数である。したがって、この指標はビットで表される。

Whirlpool 5x5モデルに従って構造化されたコインジョイン取引のエントロピー計算を例に取ろう。前節で述べたように、この取引は$1,496$の解釈可能数を持つ：

$$
\begin{align*}
C &= 1\,496 \\
E &= \log_2(1\,496) \\
E &= 10.5469 \text{ bits}
\end{align*}
$$

従って、このコイン結合トランザクションのエントロピーは10.5469$ビットであり、非常に満足のいくものであると考えられる。この値が高ければ高いほど、トランザクションはより多くの異なる解釈を許容することになり、機密性が強化される。

コイン結合8x8のトランザクションで$9,934$解釈の場合、エントロピーは：

$$
\begin{align*}
C &= 9\,934\,563 \\
E &= \log_2(9\,934\,563) \\
E &= 23.244 \text{ bits}
\end{align*}
$$

入力が1つ、出力が2つの、古典的な支払いトランザクションを例にとってみよう：[1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/fr/162.webp)

このトランザクションの場合、唯一可能な解釈は、(In.0) > (Out.0 ; Out.1)`である。その結果、エントロピーは$0$である：

$$
\begin{align*}
C &= 1 \\
E &= \log_2(1) \\
E &= 0 \text{ bits}
\end{align*}
$$

### 効率性

トランザクションのエントロピーに基づき、機密性の観点からその効率を計算することもできる。この指標は、同じ構成で想定される最適なトランザクションと比較することで、トランザクションの効率を評価する。

これは特定のトランザクション構造が理論的に達成できる最高のエントロピーに相当する。そしてトランザクション効率は、この最大エントロピーと分析対象のトランザク ションの実際のエントロピーを比較することによって計算される。

使用される計算式は以下の通りである：


- e_R$: トランザクションの実際のエントロピーをビットで表したもの；
- e_M$：トランザクション構造の最大エントロピー；
- Ef$：ビット単位でのトランザクション効率：

$$
Ef = E_R - E_M
$$

例えば、Whirlpool 5x5 coinjoin 構造の場合、最大エントロピーは $10.5469$ である：

$$
\begin{align*}
E_R &= 10.5469 \\
E_M &= 10.5469 \\
Ef &= E_R - E_M \\
Ef &= 10.5469 - 10.5469 \\
Ef &= 0 \text{ bits}
\end{align*}
$$

この指標はパーセンテージでも表される。計算式は以下の通り：:


- c_R$ : 可能な実数解釈の数；
- c_M$: 同じ構造の解釈の可能な最大数；
- Ef$：パーセンテージで表した効率：

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1\,496}{1\,496} \\
E_f &= 100 \%
\end{align*}
$$

効率が100ドルであれば、その取引の構造にもよるが、機密保持の可能性が最大限に生かされていることを示す。

### エントロピー密度

エントロピーはトランザクションの機密性を測定するための良い指標であるが、トランザクショ ンのインプットとアウトプットの数に部分的に依存する。入力と出力の数が異なる2つの異なるトランザクションのエントロピーを比較するために、エントロピー密度を計算することができる。この指標は、トランザクションの各入力または出力に対するエントロピーの視点を提供する。密度は異なるサイズのトランザクションの効率を評価・比較するのに有用である。

これを計算するには、単純にトランザクションの総エントロピーをトランザクションに関与する入力と出力の総数で割る：


- e_D$：エントロピー密度をビットで表したもの；
- e$：トランザクションのエントロピーをビットで表したもの；
- t$：トランザクションの入力と出力の総数：

$$
E_D = \frac{E}{T}
$$

ワールプールの5x5のコインジョイントを例に考えてみよう：

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ bits}
\end{align*}
$$

8x8のワールプール・コインジョインのエントロピー密度も計算してみよう：

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
E_D &= 1.453 \text{ bits}
\end{align*}
$$

これら2種類のコインジョインのエントロピー密度を分析することで、エントロピーを要素数で正規化した場合でも、「サージサイクル8x8」コインジョインの方が分析に不確実性をもたらすことが明らかになった。

### ボルツマン・スコア

トランザクションで分析されるもう一つの情報は、各要素の他の要素に対する相対的なボルツマンスコアである。これはインプットとアウトプットのマッチング確率の表である。この表は、ボルツマンスコアを通じて、特定のインプットが所定のアウトプットにリンクしている条件付確率を示している。したがって、ボルツマンスコアは、ある解釈の集合の中で、この事象が発生する可能性のある総数に対する、この事象の好ましい発生数の比率に基づいて、ある取引における入力と出力との間の関連付けが発生する条件付き確率の定量的尺度である。

Whirlpoolのコインジョインを例にとると、条件付き確率表は各入力と出力の間のリンクの可能性を強調し、取引における関連付けの曖昧さを定量的に測定する：

| 出力0 出力1 出力2 出力3 出力4

| ------- | -------- | -------- | -------- | -------- | -------- |

| 入力0｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34

| 入力1｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜入力1

| 入力2｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34

| 入力3｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜入力3

| 入力4｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34%｜34

明らかに、各入力はどの出力にも等しい確率で関連づけられ、トランザクションの機密性を強化する。

ボルツマンスコアは、ある事象が発生する解釈の数を、利用可能な解釈の総数で割ることによって計算される。従って、入力#0と出力#3（$512$個の解釈の中に存在する事象）を関連付けるスコアを求めるには、次のようにする：

$$
\begin{align*}
\text{Interpretations (IN.0 > OUT.3)} &= 512 \\
\text{Interpretations totales} &= 1496 \\
\text{Score} &= \frac{512}{1496} \\
\text{Score} &= 34 \%
\end{align*}
$$

ワールプールの8x8サージサイクルのコインジョイントを例にとると、ボルツマンテーブルは次のようになる：

| out.0｜out.1｜out.2｜out.3｜out.4｜out.5｜out.6｜out.7｜。

|-------|-------|-------|-------|-------|-------|-------|-------|-------|

| 23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23

| 23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23

| 23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23

| 23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23

| 23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜4

| 23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23

| 23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23

| 23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23%｜23

しかし、入力が1つ、出力が2つの単純なトランザクションの場合、状況は異なる：

| 出力0｜出力1

|---------|----------|----------|

| 入力0｜100％｜100％｜100

ここで、各アウトプットがインプット#0に由来する確率は100%であることがわかる。確率が低いほど機密性が高く、インプットとアウトプットの直接的な結びつきが希薄になる。

### 決定論的リンク

トランザクション内の決定論的リンクの数も計算できる。この指標は、分析された取引におけるインプットとアウトプットの間の接続のうち、いくつが100％の確率で疑う余地のないものであるかを明らかにするものである。この指標は決定論的リンクの比率を計算することで完成する。この比率は、トランザクションの全リンクの中で、これらの決定論的リンクの重みを示すものである。

例えば、Whirlpoolのコインジョイン取引はインプットとアウトプットの間に決定論的リンクがないため、インジケータはリンク0、比率は0%と表示される。逆に、2 番目の単純な支払取引（入力が 1 つ、出力が 2 つ）では、インジケータは決定論的リンクが 2 つあることを示し、比率は 100%に達する。言い換えれば、インプットとアウトプットの間に直接的で議論の余地のないリンクが存在しないため、インジケータが0であれば機密性は極めて高いということになる。

### これらの指標はどのように算出するのですか？

私が提供した方程式を使って手動でこれらの指標を計算するのは比較的簡単である。難しいのは、主に取引の解釈の可能性の数を決定することである。古典的な取引の場合、この計算は手作業で行うことができる。しかし、コインジョイントの場合、この作業ははるかに複雑である。

以前は、OXTとSamouraiチームによって開発された_Boltzmann Calculator_と呼ばれるPythonツールがあり、ビットコインのトランザクションのすべての指標を自動的に計算していました：

![BTC204](assets/fr/163.webp)

これらの分析にはKYCP.orgのウェブサイトを利用することも可能だった：

![BTC204](assets/fr/164.webp)

残念なことに、サムライの創設者が逮捕された後、これらのツールは使えなくなってしまった。

コインジョインについて詳しく説明したので、コースの最後のセクションでは、ビットコインで利用可能なその他のプライバシー技術について見ていきます。ペイジョイン、特定の擬似コインジョイントトランザクションタイプ、静的アドレスプロトコル、そしてトランザクション自体のレベルではなく、ノードのネットワークのレベルで機密性を強化するための対策について見ていきます。

https://planb.network/tutorials/privacy/analysis/boltzmann-entropy-738e45af-18a6-4ce6-af1a-1bf58e15f1fe

# その他の高度な機密保持技術の課題を理解する

<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## ペイジョイン取引

<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>


Coinjoinは現在、連鎖分析における部品のトレースに不確実性を導入する最も効果的な方法です。これまでの章で見てきたように、高性能なミックスを得るためには、インプットとアウトプットは可能な限り均質でなければなりません。さらに、アノンセットを最大化するためには、パーツができるだけ大きなグループに統合されることが重要です。つまり、コインジョインが効果的であるためには、多数の均一なパーツが関与していなければならない。このように多くの要件があるため、コインジョイントの取引は非常に厳格な構造になっている。つまり、金額はあらかじめ固定されており、プロセスの均一性を保証するために、すべての参加者はその金額を守らなければならない。さらに、コインジョインはトランザクションの構築中にすべての参加者とコーディネータとの間の同期を必要とする。

このような要件があるため、coinjoinは直接の支払いには不向きです。例えば、coinjoinのプールに100万satsのコインがある場合、それを直接支払いに使うのは複雑です。他の参加者やコーディネータと同期して、支払いを行う必要がある瞬間に協調取引を正確に構築する必要があり、購入金額はあなたのコインの価値に正確に対応しなければならないが、これは事実上実現不可能である。したがって、coinjoin取引はその性質上、協調的なスイープ取引であり、すなわち、通常、出力に見られるのと同じ入力の所有者である。

しかし、現実的な方法で支払いを可能にし、同時に連鎖分析に疑念をもたらすような取引構造があれば面白いだろう。これこそが、この章と次の章で検討することである。

### ペイジョイントランザクションとは何ですか？

payjoinは特定のビットコイン取引構造であり、支払先と協力することで支出時のユーザーのプライバシーを強化する。

2015年、LaurentMTはこの手法を初めて「*steganographic transactions*」と名付けて言及しました。その内容は[こちら](https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt)の文書で確認できます。この技術はその後、Samourai Wallet によって採用され、2018年にStowawayツールを使って最初に実装したクライアントとなりました。payjoinの概念は [BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki)、[BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki)、および [BIP77](https://payjoin.org/docs/how-it-works/payjoin-v2-bip-77/) にも見られます。payjoin を表すために使用される用語はいくつかあります：

- Payjoin ；
- 密航者；
- P2EP (*ペイ・ツー・エンド・ポイント*) ；
- ステガノグラフィー・トランザクション。

payjoinの特徴は、一見普通の取引に見えるが、実は二人の間のミニCoinjoinを生成する能力にある。これを実現するために、この取引構造では、実際の送金者と並んで、支払いの受取人が入力に含まれる。そのため、受取人は取引の途中で自分自身への支払いを含むことになり、それ自体が支払いを可能にする。

このプロセスをよりよく理解するために、例を挙げてみよう。アリスは10,000サットのUTXOを使って4,000サットのバゲットを買い、ペイジョインを選んだ。彼女のパン屋であるボブは、アリスの4,000サッツに加え、彼所有の15,000サッツのUTXOを入力として加え、それを出力として全額回収する。

![BTC204](assets/fr/165.webp)

この例では、パン屋のボブは15,000サットを入力し、19,000サットで終了する。アリスのほうは、10,000サットを入力し、6,000サットを出力する。例を簡単にするために、この取引では採掘コストを意図的に省略している。

### 何のためのペイジョイン？

payjoinトランザクションは2つの目的を果たし、ユーザーは支払いの機密性を高めることができる。

まず第一に、ペイジョインは、チェーン分析において誘い水を作ることによって、外部の観察者を惑わすことを目的としている。これはCIOHヒューリスティック（*Common Input Ownership Heuristic*）によって可能となる。第3回で見たように、通常、ブロックチェーン上の取引に複数の入力がある場合、これらの入力はすべて同じエンティティまたはユーザーに属すると仮定される。

そのため、アナリストがペイジョイントランザクションを調査する際、すべてのインプットは同一人物からもたらされたものだと考えるようになる。しかし、この認識は間違っている。なぜなら、受取人も実際の支払人とともにインプットに貢献しているからである。そのため、連鎖分析は、結果的に間違った解釈へと誘導される。

バゲットの支払いのためのpayjoinトランザクションの例を見てみよう：

![BTC204](assets/fr/166.webp)

ブロックチェーン上のこの取引を見て、ブロックチェーン分析の通常のヒューリスティックスに従った外部のオブザーバーは次のように解釈するだろう：「アリスはボブに19,000サットを支払うために、トランザクションの入力として2つのUTXOをマージした。

![BTC204](assets/fr/167.webp)

この解釈は明らかに間違っている。すでにご存知のように、入力された2つのUTXOは同じ人物のものではない。一つはバゲットのバイヤーであるアリスのもので、もう一つはパン屋のボブのものである。

![BTC204](assets/fr/168.webp)

こうすることで、外部オブザーバーの分析が誤った結論へと誘導され、利害関係者の秘密が守られる。

### ステガノグラフィー・トランザクション

ペイジョインの第二の目的は、実際の支払額について外部の観察者を欺くことである。トランザクションの構造を調べることで、アナリストは支払いがアウトプットの1つの金額と等価であると考えるかもしれない。

バゲットの購入の例に戻れば、アナリストは、支払額が6,000サッツのUTXOに相当するか、19,000サッツのUTXOに相当するかのどちらかだと考えるだろう。この場合、アナリストはむしろ支払額を19,000サットと考えるだろう。なぜなら、出力されるUTXOが2つあり、そのうちの少なくとも1つは6,000サットより大きいからである（1つのUTXOでこの支払額を満たすことができるのに、6,000サットの支払いに2つのUTXOを使用する論理的な理由はない）。

![BTC204](assets/fr/169.webp)

しかし実際には、この分析には欠陥がある。支払額はどのアウトプットにも対応していない。実際には、受給者のアウトプットにおけるUTXOと、受給者のインプットにおけるUTXOの差額である。

![BTC204](assets/fr/170.webp)

この点で、payjoin取引はステガノグラフィーの領域に入る。ペイジョイン取引は、おとりとして機能する偽の取引の中に実際の取引額を隠すことができる。

ステガノグラフィとは、他のデータやオブジェクトの中に情報を隠し、隠された情報の存在を知覚できないようにする技術である。例えば、秘密のメッセージは、無関係なテキストのドットの中に隠すことができ、肉眼では検出できないようにすることができる（これは[microdot](https://fr.wikipedia.org/wiki/Micropoint)テクニックである）。

復号キーなしでは情報を理解できなくする暗号化とは異なり、ステガノグラフィは情報を変更しない。情報は平文のまま表示される。むしろ、その目的は、秘密のメッセージの存在そのものを隠すことである。一方、暗号化は、鍵なしではアクセスできないとはいえ、隠された情報の存在を明らかにする。これが、payjoinの当初の名称が「ステガノグラフィック・トランザクション」であった理由である。

暗号とコインジョイン、ステガノグラフィとペイジョインの間には類似性がある。コインジョインは暗号と似た性質を持っている：方法は認識できるが、情報は解読できない。逆に、ペイジョインはステガノグラフィに似ている。情報は理論的にはアクセス可能だが、隠蔽方法が認識できないため、アクセスできなくなる。

### payjoinの使い方は？

payjoinをサポートする有名なソフトウェアプログラムには、Sparrow Wallet、Wasabi Wallet、Mutiny、BitMask、BlueWallet、JoinMarket、および支払いプロセッサBTCPayがあります。

![BTC204](assets/fr/171.webp)

最も先進的なpayjoinの実装は、Samourai Wallet上のStowawayのみであった。しかし、このソフトウェアの創設者が逮捕されて以来、このツールは現在部分的にしか機能していません。Stowawayの利点は、包括的で使いやすいプロトコルで、payjoinの受信と送信の両方をサポートしていることです。部分的に署名された取引は、いくつかのQRコードをスキャンすることで手動で、またはソロバンを介してTorによって自動的に交換することができる。後者の通信オプションは現在サービス停止中である。

![BTC204](assets/fr/172.webp)

payjoinの使いにくさは、加盟店の参加に依存している点にある。顧客としては、加盟店がpayjoinをサポートしていなければ利用できない。ビットコインが使える加盟店を探すのが難しいだけでなく、payjoinに対応している加盟店を探すとなると、さらに複雑になってしまう。

一つの解決策は、受取人の協力を必要とせずに、連鎖分析に曖昧さを導入する取引構造を使用することであろう。これにより、加盟店の積極的な参加に頼ることなく、支払いの機密性を高めることができる。これこそ、次の章で検討することである。

https://planb.network/tutorials/privacy/on-chain/payjoin-sparrow-wallet-087a0e49-61cd-41f5-8440-ac7b157bdd62

https://planb.network/tutorials/privacy/on-chain/payjoin-samourai-wallet-48a5c711-ee3d-44db-b812-c55913080eab

## ミニコイン決済

<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>


ある程度の機密性を保ちながら決済取引を行いたい場合、payjoinは良い選択肢である。しかし、今見てきたように、payjoin には受取人の関与が必要である。では、受取人がpayjoinへの参加を拒否した場合、あるいは単に参加させたくない場合はどうすればいいのでしょうか？一つの選択肢は、StonewallまたはStonewall x2のトランザクションを使用することです。この2種類の取引を詳しく見てみましょう。

### ストーンウォール事件

Stonewallはビットコイン取引の特定の形式であり、実際には2人ではなく、2人の間の擬似的なコイン結合を模倣することで、支出時のユーザーの機密性を高めるように設計されている。実際、この取引は共同作業ではない。ユーザーは、自分が所有するUTXOのみをインプットとして使用し、自分自身で構築することができます。そのため、他のユーザーや受取人と同期することなく、あらゆる機会にストーンウォール取引を作成することができる。

Stonewall取引は以下のように機能する。取引への入力として、発行者は自分に属する2つのUTXOを使用する。出力時には、取引は4枚のUTXOを生成し、そのうちの2枚はまったく同額である。残りの2枚のUTXOは外国為替を構成する。同額の2つのアウトプットのうち、実際に受取人に支払われるのは1つだけである。

つまり、ストーンウォール取引には2つの役割しかない：


- 支払いを行う発行者；
- 受取人は、取引の具体的な内容を知らず、単に送信者からの支払いを期待している可能性がある。

この取引構造を理解するために例を挙げてみよう。アリスはパン屋のボブのところへ4,000サットのバゲットを買いに行く。彼女はビットコインで支払いたいが、支払いに関してある種の機密性を保ちたい。そこで彼女は支払いのためにストーンウォール取引を構築することにした。

![BTC204](assets/fr/173.webp)

この取引を分析すると、パン屋のボブはバゲットの代金として4,000サットを実際に受け取ったことがわかる。アリスは2つのUTXOをインプットとして使用した。アウトプットとして、彼女は3つのUTXOを回収した：4,000サット分、6,000サット分、11,000サット分。したがって、アリスはこの取引で-4,000サットの正味残高があり、これはバゲットの価格に相当する。

この例では、理解しやすくするため、意図的にマイニング手数料を省いている。実際には、取引コストはすべて発行者が負担する。

### ストーンウォール取引の目的とは？

ストーンウォール構造は取引に莫大な量のエントロピーを付加し、チェーン分析の境界線を曖昧にする。外から見ると、このような取引は2人の間のミニコイン結合と解釈されるかもしれない。しかし、実際には決済である。したがって、この方法は連鎖分析に不確実性をもたらし、あるいは誤った連鎖分析につながることさえある。

アリスがパン屋のボブに行った場合を考えてみよう。ブロックチェーン上の取引は次のようになる：

![BTC204](assets/fr/174.webp)

一般的な連鎖分析ヒューリスティックに頼る外部のオブザーバーは、「*2人が、入力にそれぞれ1つのUTXO、出力にそれぞれ2つのUTXOを使って、小さなコインジョイントを行った*」と誤って結論付けるかもしれない。この取引を外部から分析しても、同じ金額の2つのアウトプットが存在することからコインジョイントのパターンが示唆されるため、CIOHの適用にはつながらない。従って、外部から見た場合、CIOHはこの特定のケースには適用されない。

![BTC204](assets/fr/175.webp)

この解釈は不正確だ。ご存知のように、1つのUTXOはパン屋のボブに送られ、2つのUTXO入力はアリスからで、彼女は3つの交換出力を回収した。

![BTC204](assets/fr/176.webp)

そして、ストーンウォールの取引の構造で特に興味深いのは、外部のオブザーバーから見ると、あらゆる点でストーンウォール×2の取引に似ているということだ。

### ストーンウォール事件 x2

Stonewall x2 は、ビットコイン取引のもう一つの特殊な形態であり、支出を行う際のユーザーの機密性を高めることを目的としているが、今回はその支出に関与していない第三者と協力することによっている。この方法は、2人の参加者の間で擬似的なコイン結合のように機能し、同時に第三者に支払いを行う。

Stonewallx2の取引は比較的単純である。私たちは手持ちのUTXOを使って支払いを行い、同じく自分のUTXOを使って貢献する第三者の協力を得る。そのうちの2つは同額で、1つは受取人のアドレスに、もう1つは協力者のアドレスに送られる。3つ目のUTXOは協力者に属する別のアドレスに返され、協力者は最初の金額を回収することができます（協力者にとっては、マイニングコストを差し引いた中立的な行為です）。

このように、ストーンウォール×2取引では3つの異なる役割が定義されている：


- 実際に支払いを行うのは発行者である；
- 受取人は、取引の具体的な内容を知らず、単に送信者からの支払いを期待している可能性がある；
- 協力者は、取引の分析に疑念を抱かせるためにビットコインを入手できるようにし、その一方で、最終的に資金を全額回収する（採掘コストを除けば、協力者にとっては中立的な行為である）。

アリスはパン屋のボブに4,000サットのバゲットを買いに行く。彼女はビットコインで支払いたいが、支払いに関しては一定の機密性を保ちたい。そこで、彼女は友人のチャールズに声をかける。

![BTC204](assets/fr/177.webp)

この取引を分析すると、パン屋のボブはバゲットの代金として4,000サットを実際に受け取ったことがわかる。アリスは10,000サットをインプットとして使用し、6,000サットをアウトプットとして回収した。シャルルは、15,000サッツを投入し、4,000サッツと11,000サッツの2つのアウトプットを受け取った。

この例では、理解しやすくするために、意図的に手数料を省いています。実際には、マイニングの手数料は一般的に、支払いの発行者と投稿者の間で均等に分配されます。

### ストーンウォールX2取引の目的は何か？

ストーンウォール構造と同様、ストーンウォールx2構造は取引に多大なエントロピーを付加し、連鎖分析を混乱させる。外から見ると、このような取引は2人の間のちょっとしたコイン結合と解釈できる。しかし実際には、これは支払いである。したがって、この方法は連鎖分析に不確実性をもたらし、あるいは誤った連鎖分析につながることさえある。

アリス、パン屋のボブ、チャールズの例を見てみよう。ブロックチェーン上の取引は次のようになる：

![BTC204](assets/fr/178.webp)

一般的な連鎖分析ヒューリスティックに依存する外部のオブザーバーは、「*AliceとCharlesは、入力にそれぞれ1つのUTXO、出力にそれぞれ2つのUTXOを使用して、小さなコインジョイントを実行した*」と誤って結論付けるかもしれない。同じ金額の2つの出力が存在することはコインジョイントのパターンを示唆しているため、ここでも外部からこの取引を分析してもICOHの適用にはつながらない。したがって、外から見た場合、CIOHはこの特定のケースには適用されない。

![BTC204](assets/fr/179.webp)

ご存知のように、パン屋のボブにはUTXOが1つ送られており、アリスには交換出力が1つしかなく、チャールズには2つあるからだ。

![BTC204](assets/fr/180.webp)

そしてまた、ストーンウォールx2の取引の構造について特に興味深いのは、外部の観察者から見ると、あらゆる点でストーンウォールの取引に似ているということだ。

### ストーンウォールとストーンウォール×2の違いは？

StonewallX2取引はStonewall取引と全く同様に機能するが、前者は協調的であるのに対し、後者はそうではない。これまで見てきたように、Stonewall x2取引には、支払いの外部にいる第三者（Charles）が参加し、取引の機密性を高めるために自分のビットコインを利用できるようにする。古典的なストーンウォール取引では、協力者の役割は送金者が担う。

![BTC204](assets/fr/181.webp)

外部から見れば、取引パターンはまったく同じである。

![BTC204](assets/fr/182.webp)

これら2つの取引構造がまったく同じパターンを共有しているという事実は、外部のオブザーバーが「ストーンウォール(x2)」パターンを特定することに成功したとしても、その人がすべての情報を持っているわけではないということを意味する。同じ金額の2つのUTXOのうち、どちらが支払いに対応するかを判断することはできない。さらに、彼は、入力された2つのUTXOが2つの異なる人物（ストーンウォールx2）からのものなのか、それともそれらを統合した1人の人物（ストーンウォール）のものなのかを判断することもできない。

この最後の点は、ストーンウォール x2 取引がストーンウォール取引と全く同じパターンに従っているという事実によるものである。外から見て、追加的な文脈情報がなければ、ストーンウォール取引とストーンウォールx2取引を区別することは不可能である。前者は共同取引ではないが、後者は共同取引である。このことは、これらの取引の一つを分析することにさらに疑念を加えるものである。

### StonewallとStonewall x2の取引はいつ使うべきか？

経費に機密保持ツールを使いたい場合、ロジックは次のようになるはずだ：


- 優先順位としては、ペイジョインを選択することができる；
- 加盟店がpayjoinsをサポートしていない場合、Stonewall x2構造を使用して、決済外の別の人と共同取引を行うことができます；
- ストーンウォールx2取引を行う人が見つからない場合は、ストーンウォールx2取引の動作を模倣したストーンウォールオンリー取引を行うことができます。

### StonewallおよびStonewall x2の取引はどのように利用できますか？

StonewallとStonewall x2の取引は、Samourai WalletアプリケーションとSparrow Walletソフトウェアの両方で利用可能です。

![BTC204](assets/fr/183.webp)

しかし、payjoinsと同様に、Samouraiの創設者が逮捕された後、Stonewall x2の取引は、関係者間でPSBTを手動で交換することによってのみ機能するようになった。残念ながら、ソロバン経由の自動交換は利用できなくなった。

この種の取引は、ビットコイン・ウォレットソフトウェアから手動で実行することも可能である。

次の章では、比較的知られていないが、すでに学んだことを補完するのに非常に有用な、もうひとつの守秘義務技術を見てみよう。

https://planb.network/tutorials/privacy/on-chain/stonewall-033daa45-d42c-40e1-9511-cea89751c3d4

https://planb.network/tutorials/privacy/on-chain/stonewall-x2-05120280-f6f9-4e14-9fb8-c9e603f73e5b

## 跳弾

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>


コインジョインのようなチェーン分析に曖昧さを加えるビットコインのトランザクション構造の使用は、プライバシ ー保護にとって特に有益である。しかし、payjoins の章で述べたように、coin-join の取引は当然ながらチェーン上で識別可能である。暗号化とコインジョインの間のアナロジーを思い出してください。ファイルが暗号化されている場合、暗号化されたファ イルを発見した第三者はその中身にアクセスすることはできませんが、中身を隠すためにファイルが変更され ていることは明確に識別できます。同じことがコインジョインにも当てはまります。アナリストがコインジョイン取引を調査するとき、インプットとアウトプットの間の直接的なリンクを確立することはできませんが（その逆も同様です）、それでもアナリストは観察された取引がコインジョインであることを認識することができます。

coinjoinサイクル後にどのように使用するかにもよりますが、coinjoinプロセスを経たことが問題となる場合があります。例えば、あなたが規制された取引所プラットフォームでコインを売却する予定であるにもかかわらず、そのコインが最近コインジョイントを受けたものである場合、プラットフォームのチェーン分析ツールはこの事実を検出します。するとプラットフォームは、あなたのコインジョイントされたUTXOの受け入れを拒否したり、あなたに説明を求めたりする可能性があり、あなたのアカウントが停止されたり、資金が凍結されたりするリスクがあります。場合によっては、プラットフォームはあなたの行動を国家当局に報告することもあります（これは例えば、フランスのTRACFINがPSANに要求していることです）。

![BTC204](assets/fr/184.webp)

このような事態を避けるために必要なのは、ビットコインの過去の痕跡をぼかすことができるツールであり、何らかの形で換金性を回復することである。これこそが跳弾の目的である。

![BTC204](assets/fr/185.webp)

### 跳弾とは？

リコシェは、ビットコインの所有権移転をシミュレートするために、自分自身に対していくつかの架空の取引を行う（スイープ）ことからなるテクニックである。このツールは、これまで説明してきた他の取引構造とは異なり、将来的な匿名性を得るのではなく、むしろ遡及的な匿名性の一形態を得るものである。事実上、跳弾はその過去に起因するビットコインコインの換金性を損なう可能性のある特異性をぼかします。

コイン接合サイクルのような、コインに過去に起こった出来事が残した痕跡を滑らかにするために、跳弾は、ユーザーが異なるアドレスで自分自身に資金を送金する4つの連続したトランザクションを実行する。

![BTC204](assets/fr/186.webp)

この一連の取引の後、跳弾ツールは最終的にビットコインを取引所プラットフォームなどの最終目的地に送る。

![BTC204](assets/fr/187.webp)

その目的は、コインの接合取引など、コインのカジナビリティーに影響を与える距離と、そのコインの過去を理由にこのコインを拒否する可能性のある最終的な支出行為を作り出すことである。このため、チェーン分析ツールは、このイベントの後に所有者の変更があった可能性が高いと結論づけ、このコインを換金可能であるとみなすかもしれない。コインジョインの場合、ブロックチェーン分析ツールは、ビットコインを送金したのもコインジョインを実行したのも同一人物ではないため、送金者に対して行動を起こしても意味がないと考えることができます。

![BTC204](assets/fr/188.webp)

### なぜうまくいくのか？

この跳弾法に直面すると、連鎖分析ソフトは4回の跳弾を越えて検査を深めるだろうと想像するかもしれない。しかし、これらのプラットフォームは、検出しきい値を最適化する際にジレンマに直面する。ホップ数の上限を設定し、そのホップ数を超えると、特性の変化が起こった可能性が高いと判断し、以前のイベント（コイン結合など）との関連は無視する必要があるのだ。

![BTC204](assets/fr/189.webp)

しかし、この閾値の設定は危険である。観測されたジャンプの数が増えるごとに、指数関数的に偽陽性の量が増加する。つまり、実際には他の誰かが行った操作であるにもかかわらず、誤ってイベントの参加者としてマークされてしまう個人のことである。このシナリオは、これらの企業にとって大きなリスクとなる。なぜなら、誤検出は不満につながり、影響を受けた顧客が競合他社に流れてしまう可能性があるからだ。長期的には、検出のしきい値が高すぎると、プラットフォームは競合他社よりも多くの顧客を失うことになり、その存続が脅かされる可能性がある。したがって、これらのプラットフォームにとって、観測されるバウンスの数を増やすことは複雑であり、分析に対抗するには4つで十分な場合が多い。

ここで観察される現象は、6度の隔たりの理論にやや類似している。

六次の隔たりという理論によれば、地球上のすべての人間は、最大でも6人の仲介者からなる人間関係の連鎖によって他のどの人間ともつながっていることになる。従って、世界中のどの個人にも到達するためには、それぞれが個人的に次の個人を知っている6人の人間を通過するだけで十分なのである。

ビットコイン取引の場合も、同様の現象が見られる。十分な数のビットコイン取引を追跡すると、必然的にコイン結合に出くわす。跳弾法は、取引所プラットフォームが合理的に追跡できるホップ数よりも多いホップ数を使用することで、この原理を利用している。プラットフォームがより多くの取引を追跡することを決定した場合、この対策を回避するために単に余分なホップを追加することが可能になる。

### いつ、どのように跳弾を使うのか？

跳弾の最も一般的な使用例は、所有する UTXO のコインジョイントに以前参加したことを隠す必要がある場合です。理想的には、コインジョイントを経たビットコインを規制対象団体に送金することは避けるのがベストです。しかし、他の選択肢がない場合、特に国の通貨でビットコインを清算する緊急の必要がある場合、リコシェは効果的な解決策を提供します。

この方法は、コインジョイントだけでなく、パーツの接合性を損なう可能性のあるその他のマークにも有効である。

この跳弾法のアイデアはもともとSamourai Walletチームから生まれたもので、プロセスを自動化するために彼らのアプリケーションに統合された。跳弾には100,000サットのサービス料と採掘コストがかかるため、このサービスはSamouraiでは無料ではない。そのため、多額の送金を行う場合に利用することが推奨される。

![BTC204](assets/fr/190.webp)

サムライ・アプリケーションは2種類の跳弾を提供する：


- 強化された跳弾、すなわち「時差配信」は、サムライのサービス料を5回の連続取引に分散できるという利点がある。このオプションはまた、各トランザクションが別々の時間にブロードキャストされ、異なるブロックに記録されることを保証し、オーナー交代の挙動を可能な限り模倣する。スピードは落ちるが、連鎖分析への耐性を強化することで跳弾の効率を最大化できるため、急いでいない人にはこの方法が望ましい；

![BTC204](assets/fr/191.webp)


- 古典的な跳弾方式は、操作を高速で実行するように設計されており、時間間隔を短縮してすべてのトランザクションを放送する。したがって、この方法は、強化された方法よりも機密性が低く、分析に対する耐性も低い。緊急の発送にのみ使用すべきである。

![BTC204](assets/fr/192.webp)

跳弾とは、単にビットコインを自分自身に送ることを意味します。特別なツールを使わなくても、どのウォレットソフトでも手動でビットコインを送金することは完全に可能です。毎回新しい空白のアドレスを使って、同じコインを連続して自分自身に送金するだけです。

次の章では、所有権を秘密裏に移転するためのさまざまな手法を見ていく。これらの手法は、運用の面でも結果の面でも、これまで検討してきたものとは根本的に異なる。

https://planb.network/tutorials/privacy/on-chain/ricochet-e0bb1afe-becd-44a6-a940-88a463756589

## 所有権の秘密譲渡

<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>


ビットコインの秘密保持技術のもう1つは、所有権の秘密移転である。この方法は、ブロックチェーン上に取引が明示的に表示されることなく、ビットコインの所有権をある人から別の人に、またはその逆に移転することを目的としています。利用可能なさまざまな技術を、その長所と短所とともに見てみよう。

### コインスワップ

Coinwapは比較的シンプルなコンセプトに基づいている。スマートコントラクトを使用して、2人のユーザー間のビットコインの所有権の移転を、信頼の必要なく、この移転がブロックチェーン上で明示的に可視化されることなく、促進する。

![BTC204](assets/fr/193.webp)

アリスとボブの素朴な例を想像してみよう。アリスは秘密鍵$A$で保護された1BTCを持っており、ボブも秘密鍵$B$で保護された1BTCを持っている。二人は理論上、外部通信路を介して秘密鍵を交換し、秘密の送金を行うことができる。

![BTC204](assets/fr/194.webp)

しかし、この素朴な方法は信頼という点でリスクが高い。交換後、アリスが$A$秘密鍵のコピーを保持し、鍵がボブの手に渡ると、後でそれを使ってビットコインを盗むことを止めることはできない。

![BTC204](assets/fr/195.webp)

さらに、アリスがボブの秘密鍵$B$を受け取らず、自分の秘密鍵 $A$を交換に渡さないという保証はない。したがって、この交換は当事者間の過度の信頼に依存しており、所有権の安全な秘密譲渡を保証するには効果がない。

![BTC204](assets/fr/196.webp)

このような問題を解決し、お互いを信用していない当事者間でのやり取りを可能にするために、私たちは代わりにスマート・コントラクト・システムを使おうとしている。スマートコントラクトとは、あらかじめ定義された条件を満たすと自動的に実行されるプログラムのことだ。私たちの場合、これによって相互の信頼関係を必要とせず、財産の交換が自動的に行われるようになる。

これは、HTLC（*ハッシュタイムロックコントラクト*）またはPTLC（*ポイントタイムロックコントラクト*）を使用して達成することができます。これら2つのプロトコルは同様の方法で動作し、交換が正常に完了するか、完全にキャンセルされることを保証するタイムロックシステムを使用するため、両当事者の資金の整合性が保護されます。HTLCとPTLCの主な違いは、HTLCがハッシュとプリイメージを使用して取引を保護するのに対し、PTLCはアダプター署名を使用することです。

アリスとボブの間でHTLCまたはPTLCを使用したコインスワップ・シナリオでは、交換は安全に行われます：成功してそれぞれが相手のBTCを受け取るか、失敗してそれぞれが自分のBTCを保持します。このため、どちらか一方が相手のBTCをだましたり盗んだりすることは不可能です。

> *HTLCはまた、ライトニング・ネットワークの双方向チャネル*を通じて支払いを安全にルーティングするために使用されるメカニズムでもあります。
アダプ タ署名の使用は、従来のスクリプトを省略することが可能であるため、この文脈では特に興味深い（"_scriptless scripts_"と呼ばれることもある）。この機能により、交換に伴うコストが削減される。Adaptor Signaturesのもう一つの大きな利点は、取引の両当事者に共通のハッシュを使用する必要がないため、ある種の取引において両当事者間の直接的なリンクを明らかにする必要がないことである。

### アダプター署名

アダプト署名は、有効な署名と「_adaptor signature_」と呼ばれる追加の署名を統合し、秘密データを明らかにする暗号手法である。このメカニズムは、有効な署名、アダプター署名、秘密の3つの要素のうち2つを知っていれば、欠けている3つ目の要素を推測できるように設計されている。この方法の興味深い特性は、もし私たちが仲間のアダプター署名と、そのアダプター署名を計算するのに使われた秘密に関連する楕円曲線上の特定の点を知っていれば、秘密そのものに直接アクセスすることなく、その同じ秘密に適合する私たち自身のアダプター署名を導き出すことができるということである。

コインスワップでは、Adaptor Signaturesを使用することで、参加者間で2つの機密情報を同時に開示することができ、相互信頼の必要性を回避することができます。アリスとボブはそれぞれ1BTCを交換したいが、お互いを信用していない。彼らはAdaptor Signaturesを使って、この交換においてお互いを信頼する必要性をなくします。以下がその方法である：


- AliceはBobに1BTCを送る$m_A$トランザクションを生成して交換を開始する。アリスは秘密鍵$p_A$ ($P_A = p_A \cdot G$)、ノンス$n_A$ ($N_A = n_A G$)、秘密$t$ ($T = t G$)を使って、この取引を検証する署名$s_A$を生成する：

s_A = n_A + t + H(N_A + T ︓平行 P_A ︓平行 m_A) ︓cdot p_A$$.


- アリスは、真の署名 $s_A$ から秘密 $t$ を引くことで、アダプタ署名 $s_A'$ を計算する：

s_A' = s_A - t$$.


- アリスはボブに署名アダプタ$s'_A$、署名なしトランザクション$m_A$、 秘密($T$)に対応する点、および非核($N_A$)に対応する点を送る。これらの要素は、いわゆる「アダプター」を構成する。重要なのは、この情報だけではボブはアリスのBTCを復元できないということだ。
- しかし、ボブはアリスが自分から盗もうとしていないことを チェックできる。そのためには、アリスのアダプタ署名 $s_A'$ が提案された取引 $m_A$ に本当に対応しているかどうかをチェックする。もし次の式が正しければ、ボブはアリスの署名アダプターが有効であると確信できる：

s_A'  \cdot G = N_A + H(N_A + T ﹑平行 P_A ﹑平行 m_A) ﹑cdot P_A$$.


- この検証により、ボブは完全に信頼して交換を継続できる十分な保証を得る。次に彼は、アリスに1BTCを送るための自分のトランザクション$m_B$を作成し、同じ秘密$t$にリンクされるアダプタ署名$s_B'$を生成する。この段階では、アリスだけが$t$の値を知っており、ボブはアリスが彼に送信した対応する点$T$しか知らない：

s_B' = n_B + H(N_B + T ㎟平行 P_B ㎟平行 m_B) ㎟cdot p_B$.


- ボブはアリスに、自分のアダプタ署名$s_B'$と、署名なしのトランザクション$m_B$、 秘密に対応するポイント($T$)とノンスに対応するポイント($N_B$)を送る。秘密$T$を知っているアリスは、ボブのアダプタ署名$s_B'$とこの秘密を組み合わせて、ボブのBTCを彼女に送金するトランザクション$m_B$に対して有効な署名$s_B$を生成することができる：

s_B = s_B' + t$$.

(s_B' + t)  \cdot G = N_B + T + H(N_B + T  \parallel P_B ¤parallel m_B) ¤parallel P_B$$ ¤̴̶̷̀ω¤̴̶̷́)


- アリスはこの署名された$m_B$トランザクションをビットコインのブロックチェーン上にブロードキャストし、ボブが約束したBTCを取得する。ボブはブロックチェーン上のこのトランザクションを見ると、$s_B = s_B' + t$の署名を取り出すことができる。この情報により、ボブは必要な有名な秘密$t$を分離することができる：

t = (s_B' + t) - s_B' = s_B - s_B'$$.


- そしてこの秘密$t$は、ボブがアリスのアダプタ署名$s_A'$から有効な署名$s_A$を生成するために欠けている唯一の要素であった。この署名は$m_A$トランザクションを検証し、アリスからボブにBTCを送る。次にボブは$s_A$を計算し、ブロックチェーン上に$m_A$取引をブロードキャストする：

s_A = s_A' + t$$.

(s_A' + t)  \cdot G = N_A + T + H(N_A + T  \parallel P_A  \parallel m_A)  \cdot P_A$$.

コインスワップにおけるアダプタ署名の仕組みを要約してみよう。最初に、AliceはBobにアダプタを伴った署名のないトランザクションを送り、Bobが後で明かされる秘密によってビットコインにアクセスできることを検証できるようにする。そのお返しとして、Bobは自分の署名されていない取引とアダプターをAliceに送る。アリスは秘密によって有効な取引をブロードキャストすることで、ボブの取引を確定し、ビットコインを受け取ることができる。この取引がブロックチェーン上で公開されると、ボブは秘密を抽出し、アリスの取引をアンロックする能力を持つ。その結果、アリスがボブのビットコインの送金を開始した場合、ボブは相互信頼を必要とせずにアリスのビットコインにアクセスすることができる。

なお、コインスワップは2013年10月にビットコイントークでグレゴリー・マクスウェル氏](https://bitcointalk.org/index.php?topic=321228.0)によって初めて提案された。

### アトミックスワップ

コインスワップと同様に、同じ種類のスマートコントラクトを使用して、アトミックスワップを行うことも可能である。アトミックスワップは、BTCとXMRのような異なる暗号通貨を、信頼や仲介者の介入を必要とせずに、2人のユーザー間で直接交換することを可能にする。スワップが成功して両者が満足するか、失敗してそれぞれが元の暗号通貨を保持し、相手を信頼する必要がなくなるかのどちらかである。

![BTC204](assets/fr/197.webp)

アトミックスワップとコインスワップは操作方法が似ており、機密性という点では同じメリットとデメリットがある。実際、ビットコインから見れば、アトミックスワップは2段階で行われるコインスワップに匹敵する。まず、BTCを別の暗号通貨と交換し、次にこの暗号通貨を他のBTCと交換する。最後に、別のユーザーのBTCを回収する。機密性の問題の分析において、この2つのプロトコルを独自の秘密交換のカテゴリーに分類したのはこのためである。

![BTC204](assets/fr/198.webp)

ただし、コインスワップとは異なり、アトミックスワップは、特にBTC/XMR取引所において、利用可能な流動性の面で不均衡が生じる可能性があることに注意してください。一般的に、ビットコインをアルトコインに交換するのは簡単です。ビットコインには強い需要があるため、この変換方向のプレミアムは低く抑えられます。しかし、アルトコインからBTCへの交換は、需要が低いためより複雑で、しばしば非常に高いプレミアムが発生します。

最後に、アトミックスワップがオンチェーンビットコインとライトニングネットワーク上のビットコインを含む場合、「サブマリンスワップ」と呼ばれる。

### 本当に役に立つのか？

コインスワップやアトミックスワップなどの秘密の所有権移転には、連鎖分析ヒューリスティックスを欺く利点がある。これらの方法は、実際の所有権が変更されているにもかかわらず、同じユーザーが関与している取引を示唆することができる。しかし、これらの方法の主な欠点は、コインの履歴を破る追加のテクニックを使用しない限り、非常にリスクが高いということである。

実際、アリスがボブとコインスワップやアトミックスワップを行う場合、アリスは自分のビットコインとボブのビットコインを交換する。アトミックスワップの場合、交換にはアルトコインが含まれるが、原理は同じである。したがって、アリスは$B$コインを、ボブは$A$コインを所有することになる。これは連鎖分析に疑念を与えるが、コインの履歴は追跡可能である。アナリストが$A$の部分を調べれば、アリスの以前の行動を追跡することができ、$B$の部分についてはその逆である。

![BTC204](assets/fr/199.webp)

アリスから見れば、$B$コインの履歴が特定の団体に不審に思われるリスクがある。例えば、ボブがハッキングなどの犯罪行為によって$B$コインを手に入れた場合、そのコインは彼の違法行為と結びついたままになってしまいます。アリスは、資金を凍結されたり、ボブの犯罪とは無関係であるにもかかわらず、ボブの犯罪の嫌疑をかけられたりするリスクなしに、規制された取引所プラットフォームに送金できないコインを所持していることに気づく可能性がある。

![BTC204](assets/fr/200.webp)

必然的に、コインスワップやアトミックスワップといった秘密保持の方法は、当局に資金を監視されている犯罪者に好まれる。これらのプロトコルは、監視下にあるビットコインを処分し、完全に換金可能なビットコインと交換することを可能にします。また、当局を他のユーザーに向かわせることで、陽動作戦も可能だ。つまり、彼らには二重の目的があるのだ。

coinjoinでは、たとえあなたのコインが監視対象のビットコインと混ざっていたとしても、そのコインの履歴は破壊され、coinswapやatomic swapのような秘密の所有権移転プロトコルには存在しない、もっともらしい否認可能性を提供します。

![BTC204](assets/fr/201.webp)

もしアリスがリスクを避けたいなら、$B$コインの履歴を破る方法、例えばコインジョイントで渡す方法を使わなければならない。このことは、所有権の秘密譲渡とコインジョイントを組み合わせることの有用性に疑問を投げかける。コイン結合は、コインの履歴を破ることで、すでにアリスに十分な機密性を提供している。従って、もしアリスがプライバシーを守りたいのであれば、コインスワップの後にコインジョイントをするのではなく、直接コインジョイントに進む方が賢明であるというのが私の意見である。

秘密の所有権移転方法が真に効果的で、$A$ユーザーの履歴が$B$ユーザーにリンクするリスクを回避するためには、逆説的だが、その利用が広く知られる必要がある。コインスワップが大量に使用され、当局がこの一般的な慣行を認識しているのであれば、もっともらしい拒否の形を確立することができるだろう。しかし、これらの送金の利用がわずかなものである限り、これらの方法は利用者にとってリスクが高すぎると思う。

これまでは、主にトランザクションそのもののレベルでの機密保持方法を研究してきた。次の章では、ネットワーク・レベルとトランザクションの普及に関する問題を取り上げる。

## P2Pネットワークにおけるプライバシー

<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>


パート4では、取引の機密性を保護するために完全なノードを使用することの重要性について説明した。しかし、あなたのノード自体が、あなたの活動に関する情報を引き出そうとする攻撃にさらされる可能性があることを理解することが重要です。そこで本章では、取引そのものやビットコインフローのレベルではなく、ネットワークのレベルでプライバシーを保護するために講じることができる様々な対策について見ていきます。

### ダンデライオン

様々な非匿名化攻撃を回避する1つの方法は、Dandelion提案を使用することです。このブロードキャストプロトコルはBIP156で公式化されたが、ビットコインで実装されたことはない。

Dandelion の背後にあるアイデアは、様々な形態の攻撃に対抗するために、ビットコインネットワークにおけるトランザクションルーティングの機密性を向上させることである。その主な目的は、ネットワーク上でトランザクションを最初にブロードキャストしたソースノードを隠すことである。このノードを開示することで、ビットコイン取引を特定のIPアドレスにリンクさせることが可能になり（ノードがクリアネット上で動作している場合）、連鎖分析のためのエントリーポイントを提供することができる。

ビットコイン上の活動とIPアドレスとの間のこの関連性は、ユーザーの機密性に対するかなりのリスクを意味する。実際、多くのエンティティがIPアドレスと個人のアイデンティティを簡単に結びつける立場にある。これには政府やインターネットサービスプロバイダーも含まれる。さらに、例えばウェブサイトのデータベースがハッキングされたときにIPアドレスと個人データが流出した場合、この情報は一般にアクセス可能になる可能性がある。

古典的なビットコインの操作では、ユーザーが自分のウォレットソフトウェア上で構築したトランザクションは、彼の個人ノードに送信される。このノードは直ちに、接続しているすべてのピアに新しいトランザクションをブロードキャストする。

![BTC204](assets/fr/202.webp)

次にこれらのピアは、トランザクションがコンセンサスとローカルの標準化ルールに準拠していることを確認する。検証されると、各ピアはトランザクションを自分のピアに転送する。

![BTC204](assets/fr/203.webp)

ブロックへの統合を待つトランザクションのこのような分布はかなりバランスが取れており、統計的に予測可能である。この弱点は、トランザクションをブロードキャストした最初のノードを特定するために、ネットワークを監視・分析するために協力する共犯的なスパイノードによって悪用される可能性がある。観察者が送信元ノードの特定に成功した場合、その取引はそのノードのオペレータから発信されたと仮定することができる。この種の観測は、通常は匿名であるトランザクションを特定のIPアドレスに結びつけるために利用できる。

![BTC204](assets/fr/204.webp)

BIP156の目的はこの問題に対処することである。これを実現するために、BIP156は新しいトランザクションの拡散に追加フェーズを導入し、広く一般に伝播する前に匿名性を保持する。Dandelionはまず「ステム」フェーズを使用し、そこではトランザクションがノードのランダムな経路を経由して送信される。

![BTC204](assets/fr/205.webp)

その後、トランザクションは「Fluff」フェーズでネットワーク全体にブロードキャストされます。

![BTC204](assets/fr/206.webp)

「茎」と「Fluff」は、ネットワーク内でのトランザクションの伝播挙動を指しており、それはタンポポ（英語で "Dandelion"）の形状と成長過程に似ています。

したがって、スパイノードはトランザクションを「Fluff」フェーズ（大量拡散）を開始したノードまで追跡できる可能性がありますが、そのノードは最初にトランザクションをブロードキャストしたわけではありません。なぜなら、それは茎の最後のノードから受け取ったからです。スパイノードが茎をたどれない場合、送信元ノードも特定できません。

![BTC204](assets/fr/207.webp)

ステムフェーズでスパイノードが存在しても、拡散グラフで正直なノードに出会うとすぐに、スパイはこのノードがオリジナルのソースなのか、単なる仲介者なのかを判断できないため、常に疑念が残る。

![BTC204](assets/fr/208.webp)

このルーティング方式は、送信元ノードへの軌跡をぼかすため、トランザクションをネットワーク経由でその送信元まで遡ることを困難にする。こうしてダンデライオンは、敵対者がネットワークを非匿名化する能力を制限することで、機密性を向上させる。この方法は、「ステミング」段階において、TorやP2P Transport V2のようにネットワーク通信を暗号化するノードをトランザクションが通過する場合に、より効果的である。

BIP156はBitcoin Coreに統合されておらず、現在は「却下」に分類されている。このプロトコルの主な懸念事項の1つは、ステムフェーズの間、トランザクションが検証される前に中間ノードを経由して中継されなければならないことである。これまで見てきたように、通常のビットコインモデルでは、各ノードは仲間にブロードキャストする前にまずトランザクションを検証する。トランザクションがノードのコンセンサスルールやローカルの標準化ルールに準拠していない場合、ノードはそれを無視して配布しない。有効なトランザクションのみがネットワーク全体にブロードキャストされるため、このプロセスはDoS攻撃に対抗するために重要である。ネットワークに過負荷をかけるために大量に生成される可能性のある無効なトランザクションは、最初に遭遇したノードで停止され、伝播しない。Dandelionの主なリスクは、この新しいプロトコルが無効なトランザクションをネットワークの一部にブロードキャストさせることで、DoS攻撃の新たなベクトルを導入する可能性があることである。

### P2Pトランスポート V2

P2PトランスポートV2は、BIP324で発表された別のネットワークプロトコルである。これはビットコインのP2Pトランスポートプロトコルの新バージョンで、ノード間の通信の機密性と安全性を向上させるために日和見暗号化を組み込んでいる。

この機能拡張は、P2Pプロトコルの基本バージョンにおけるいくつかの問題を解決するために設計されている。一方では、受動的なオブザーバーにとって、交換されるデータをインターネット上で流通する他のタイプのデータと区別できないようにする。主な目的は、政府、ISP、VPNプロバイダーがビットコインユーザーを大規模に監視するのを防ぐことだ。これはまた、インターネットユーザーがビットコインユーザーでもあるかどうか、つまり完全なノードを操作しているかどうかをこれらのエンティティが判断することをより困難にする。

P2P V2はまた、データパケットの特定のパターンを検出することにより、検閲や攻撃のリスクを軽減するのに役立ちます。P2P V2は、ネットワーク・レベルでの様々なタイプのシビル・アタックの実行を複雑化し、よりコスト高にします。シビル攻撃は、行為者が不公正な利点を得るために複数の偽のIDを作成する場合に発生します。ビットコインネットワークの文脈では、これは多くの場合、行為者が多数の完全なノードを支配し、接続を増やすために積極的にそれらを使用することとして現れます。シビル攻撃には、情報を収集してユーザーの機密性を侵害する受動的なものと、エクリプス攻撃のような能動的なものがある。後者は、特定のノードをネットワークの他の部分から隔離し、ユーザーを検閲したり、受信するデータを変更したりする。最後に、P2P V2はまた、*MITM（Man-In-The-Middle）攻撃をよりコスト高にし、検出しやすくする。

P2P V2が実装する暗号化には認証が含まれていない。これは、不必要な複雑さを追加したり、ネットワークへの接続がパーミッションレスのままであるという事実を損なわないようにするためである。とはいえ、この新しいP2Pトランスポート・プロトコルは、受動的な攻撃に対するセキュリティが向上し、能動的な攻撃はかなりコストがかかり、検出しやすくなっている。ネットワーク・メッセージに擬似ランダム・データ・ストリームを導入することで、攻撃者が通信を検閲したり操作したりすることがより困難になる。

P2P V2トランスポートは、2023年12月にデプロイされたBitcoin Coreバージョン26.0にオプション（デフォルトでは無効）として含まれていた。その後、2024年4月のバージョン27.0でデフォルトで有効になった。設定ファイルの `v2transport=` オプションで変更できる。

### トーア

ネットワークノードの機密性喪失のリスクを回避するもう1つの簡単な解決策は、完全にTorの下で実行することである。

Torは、インターネット上のTCP接続の発信元を匿名化する中継サーバー（ノード）のネットワークである。データを数層の暗号化でカプセル化することで機能する。各リレーノードは、最終的な宛先に到達するまで、次のノードのアドレスを明らかにするためにレイヤーを削除します。Torネットワークは、中間ノードがデータの発信元と宛先の両方を知ることを防ぐことで匿名性を確保し、監視者がユーザーの活動を追跡することを非常に困難にしています。

![BTC204](assets/fr/209.webp)

Torはデータを暗号化するだけでなく、通信の発信元と宛先をマスクします。ISPは通信を解読できず、ビットコインネットワークの他のノードは送信元ノードのIPアドレスを特定できない。さらに、Torはビットコインの使用そのものをISPから隠します。

この方法の主なリスクは、Torがビットコインから独立したプロトコルであることだ。Torの下でBitcoinノードを動かしていて、Torが機能しなくなった場合、Bitcoinノードは通信できなくなる。

また、Torでの通信が遅くなることにも注意が必要です。IBD（*Initial Block Download*）は多くの通信を必要とするため、この待ち時間はノードの初期起動時に特に厄介です。その結果、ビットコインネットワークとの最初の同期にTorを使用すると大幅に時間がかかる可能性があります。クリアネット上でIBDを実行し、第二段階としてTorを有効化することも可能です。この方法はISPにビットコインノードの存在を開示しますが、Torに切り替えた後の個人取引情報を保護します。

ネットワークレベルでの様々な機密保持の方法を探ってきたが、次の数章では、アドレスの再利用を避けるための2つのエレガントなソリューションも紹介したい：BIP47とサイレント・ペイメントである。

## BIP47と再利用可能な支払コード

<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>


第 3 回で見たように、アドレスの再利用はビットコインプロトコルにおけるユーザーの機密性にとって重大な障害となる。このようなリスクを軽減するために、ウォレットで新しい支払いを受け取るたびに空白の受け取りアドレスを生成することが強く推奨される。新しいアドレスの生成は、最新のソフトウェアと階層的な決定論的ウォレットの使用によって簡素化されましたが、この実践は直感に反すると思われるかもしれません。

![BTC204](assets/fr/210.webp)

例えば、従来の銀行システムでは、私たちはIBANを共有することに慣れている。一度このIBANを相手に渡せば、相手は私たちと再びやり取りすることなく、複数の支払いを送ってくることができる。ネオバンクはまた、ペイパルでのユニークなメールアドレスの使用や、リボルトでのRevTagsの使用など、より現代的な可能性を提供している。金融分野以外でも、住所、電話番号、電子メールアドレスなど、私たちが日常的に使用する識別子もまた、ユニークで永続的なものである。新たなやりとりのたびに更新する必要はない。

![BTC204](assets/fr/211.webp)

しかし、ビットコインの仕組みは異なる。着信トランザクションごとに新しい受信アドレスを生成しなければならない。使いやすさと機密性の間のこの妥協は、ビットコイン白書の原点にまでさかのぼる。サトシ・ナカモトは、2008年末に彼の文書の最初のバージョンを公表した時点で、すでにこのリスクを警告していた：

**追加のファイアウォールとして、各トランザクションに新しいキー・ペアを使用し、共通の所有者にリンクされないようにすることができる。

アドレスを再利用することなく、1つの識別子で複数の支払いを受け取る方法はたくさんある。それぞれにトレードオフや欠点がある。こうした方法の中で、ユストゥス・ランヴィエが開発し、2015年に発表された提案であるBIP47がある。この提案は、アドレスの再利用を避けつつ、同一人物に対して複数の取引を実行できる再利用可能な決済コードを作成することを目的としている。つまり、BIP47は、取引の機密性を保持しつつ、一意の識別子のように直感的な決済システムを提供することを目指している。

![BTC204](assets/fr/212.webp)

BIP47による支払いは、空白のアドレスを使用した従来のビットコイン取引と同レベルの機密性を提供するため、BIP47はユーザーの機密性を直接的に向上させるものではない。しかし、BIP47はビットコインの利用をより便利で直感的なものにします。BIP47のおかげで、この使いやすさは古典的な取引と同じレベルの機密性を実現しています。そのため、BIP47はプライバシーを守るための貴重なツールなのです。

当初、BIP47はBitcoin Coreへの統合が提案されたが、実際には実装されなかった。しかし、いくつかのソフトウェアアプリケーションは独自に実装することを選択した。例えば、Samourai Walletチームは "PayNym "と呼ばれるBIP47の独自の実装を開発した。

### BIP47とPayNymの一般原則

BIP47の目的は、アドレスを再利用することなく多数の支払いを受け取ることを可能にすることである。これは、再利用可能な支払コードの使用に基づいており、異なる発行者が別の利用者に属する単一のコードに複数の支払を送信することを可能にする。その結果、受信者は取引のたびに新しい空白のアドレスを提供する必要がなくなり、機密性を保ちながらやり取りが大幅に容易になる。

![BTC204](assets/fr/213.webp)

そのため、ユーザーは、従来の受信者アドレスや公開鍵の場合と異なり、機密性を失うリスクを負うことなく、ソーシャルネットワーク上であれ、自分のウェブサイト上であれ、完全に自由に自分の支払いコードを共有することができる。

トランザクションを実行するには、両当事者はSamurai WalletやSparrow Wallet上のPayNymのようなBIP47実装を持つビットコインウォレットが必要です。決済コードの共同使用により、両者間に秘密チャネルが形成される。このチャネルを効果的に確立するために、発行者はビットコインのブロックチェーン上で「通知トランザクション」として知られる特定のトランザクションを実行しなければならない（これについては後で詳しく説明する）。

2人のユーザーの支払いコードを組み合わせることで、共有された秘密が生成され、その秘密が大量のユニークなビットコイン受け取りアドレス（ちょうど2^32、約40億）を作り出す。このようにして、BIP47を介して行われた支払いは、実際には支払いコードそのものではなく、関係するユーザーの支払いコードから派生した古典的な受け取りアドレスに宛てられている。

このように、ペイメントコードはポートフォリオシードから派生した仮想識別子の役割を果たす。ポー トフォリオの階層的派生構造では、支払コードはレベル 3、すなわち口座レベルに位置づけられる。

![BTC204](assets/fr/214.webp)

BIP47の派生ターゲットは、BIP47を参照するインデックス`47'`（`0x8000002F`）で識別される。再利用可能な支払いコードの派生パスの例は以下の通りである：

```plaintext
m/47'/0'/0'/
```

ペイメントコードがどのようなものかを知ってもらうために、これが私のものだ：

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

このコードはQRコードとして符号化することもでき、従来の受信アドレスのように簡単に伝達できる。

ツイッターで時々見かけるPayNymボットは、Samourai Walletが作成した決済コードを視覚的に表現したものである。ハッシュ関数を使って生成されるため、一意性に近い。で始まる小さな文字列の形をとる：

```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

これらのアバターは画像として表現することもできる：

![BTC204](assets/fr/215.webp)

これらのロボットは、BIP47のフレームワークの中では特別な技術的機能を持たないが、簡単に認識できるビジュアル・アイデンティティを提供することで、ユーザーとのインタラクションを促進する役割を果たす。

---
*この章では、BIP47の仕組みについて、特に使用されている暗号方式に重点を置いて詳しく説明します。これらのやや専門的な説明を完全に理解するためには、まずHDウォレットの構造、鍵の導出手順、楕円曲線暗号の基礎を理解することが不可欠です。これらの概念をより深く理解したい方は、Plan ₿ Networkで別の無料トレーニングコースをご利用いただけます :*。

https://planb.network/courses/46b0ced2-9028-4a61-8fbc-3b005ee8d70f

*というのも、BIP47の技術的な運用を理解することで、次の章で説明する他の似たような提案を理解しやすくなるからである*。

---
### 再利用可能な支払いコード

前述したように、再利用可能な支払いコードはHDウォレットの深さ3に位置し、ウォレット構造における位置とその役割の両方において、`xpub`に匹敵する。

80バイトの支払いコードの内訳は以下の通り：


- バイト `0`：バージョン**。BIP47 の最初のバージョンでは、このバイトは `0x01` に設定される；
- バイト `1`：ビットフィールド**。このスペースは特定の用途のための追加表示を統合するために確保されている。古典的なPayNymの使用では、このバイトは`0x00`に設定される；
- 2`バイト：y`** のパリティ。このバイトは `0x02` または `0x03` であり、公開鍵の縦軸が偶数か奇数かを示す；
- バイト `3` からバイト `34` まで：x`**の値。これらのバイトは公開鍵の横軸を表す。x` とパリティ `y` を連結したものが、圧縮された公開鍵の完全な形となる；
- バイト`35`からバイト`66`まで：文字列コード**。このスペースには公開鍵に関連付けられた文字列コードが格納される；
- バイト `67` からバイト `79` まで：パディング**。このスペースは将来の進化に備えるためのものである。現在のバージョンでは、`OP_RETURN`の出力に必要な80バイトのサイズに達するために、ここにゼロを置くだけである。

前節で紹介した再利用可能な支払いコードを16進数で表したものがこちら：

```plaintext
0x010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

![BTC204](assets/fr/216.webp)

次に、ペイメントコードであることを明確に示すために、先頭に `P` というプレフィックスバイトを付加しなければならない。このバイトは `0x47` で表される：

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

最後に、ペイメントコードの完全性を保証するために、`SHA256` 関数を使用した二重ハッシュからなる `HASH256` を使用してチェックサム計算が実行される。このハッシュの最初の 4 バイトがペイメントコードの最後に連結される：

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

![BTC204](assets/fr/217.webp)

これらの手順が完了すれば、支払いコードの準備は完了だ。あとは、これを58ベースに変換して最終版を入手するだけだ：

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

支払いコードを作成するプロセスでは、圧縮された公開鍵と文字列コードを使用する。どちらもウォレットシードから決定論的かつ階層的に導出される。このために使用される導出パスは ：

```plaintext
m/47'/0'/0'/
```

具体的には、再利用可能な支払いコードに関連する圧縮された公開鍵と文字列コードを生成す るために、まずウォレットシードからマスター秘密鍵を計算する。次に、`47 + 2^31` というインデックスを使用して娘鍵のペアを導出する(導出を強化す る)。続いて、インデックス `2^31` (強化された派生)を使用して、さらに2組の鍵を派生させる。

![BTC204](assets/fr/218.webp)

### 楕円曲線上のディフィー・ヘルマン鍵交換(ECDH)

BIP47の核となる暗号プロトコルは、*Elliptic-Curve Diffie-Hellman*の頭文字をとってECDHと呼ばれている。この方法は、オリジナルのDiffie-Hellman鍵交換の変形である。

1976年に発表されたディフィー・ヘルマン（Diffie-Hellman）は、公開鍵と秘密鍵のペアを持つ2つの当事者が、公開された安全でない通信路を介してのみ通信する場合でも、共通の秘密について合意することを可能にする鍵合意プロトコルである。

![BTC204](assets/fr/219.webp)

この共有秘密（この場合はブルー・キー）は、他の操作に使用することができる。通常、この共有秘密は、安全でないネットワーク上の通信を暗号化したり復号化したりするのに使われる：

![BTC204](assets/fr/220.webp)

これを実現するために、ディフィー・ヘルマンではモジュール演算を使って共有秘密を計算する。その仕組みを平たく説明するとこうなる：


- アリスとボブは共通の色（この場合は黄色）に合意し、これは公開データである（攻撃者はこの色を知っている）；
- アリスは秘密の色、この場合は赤を選び、2つを混ぜてオレンジを得る；
- ボブも秘密の色、この場合は青を選び、黄色と混ぜて緑を得る；
- その結果、オレンジ色と緑色が交換される。この交換は安全でないネットワーク上で行われ、攻撃者に観察される可能性がある；
- ボブの緑と自分の秘密の色を混ぜて、アリスは茶色を作る；
- ボブはアリスのオレンジと秘密の青で同じことをし、茶色を得た。

![BTC204](assets/fr/221.webp)

この一般化では、茶色はアリスとボブが共有する秘密を表す。現実には、攻撃者がアリスやボブの秘密の色を見つけるために、オレンジと緑を分離することは不可能だと想像してください。

では、このプロトコルが実際にどのように機能するのか、色に例えるのではなく、実数とモジュラー演算を使って見てみよう！

ディフィー・ヘルマン・メカニズムに入る前に、必要不可欠な2つの数学的概念を簡単に思い出しておこう：


- 素数**とは、$1$とそれ自身の2つしか約数を持たない自然数のことである：とそれ自身である。例えば、$7$は$1$と$7$でしか割り切れないので素数である。一方、$8$は$1$、$2$、$4$、$8$で割り切れるので、素数ではない。したがって、$8$は2つではなく4つの正の整数の約数を持つ；
- モジュロ**（$mod$または$%$と表記される）は、2つの整数の間で、最初の整数を2番目の整数でユークリッド除算した余りを返す数学演算である。例えば、$16bmod 5 = $1$ である。

**アリスとボブの間のディフィー・ヘルマン鍵交換は次のように行われる。


- アリスとボブは$p$と$g$という2つの共通の数で合意している。$p$は素数で、数が大きいほどディフィー・ヘルマンの安全性は高くなる。g$は$p$の原始根である。g$は$p$の原始根である。これら2つの数は、安全でないネットワーク上では平文で通信できる。これらは以前の一般化における**黄色**に相当する。したがって、アリスとボブは$p$と$g$に全く同じ値を使うことが重要である。
- これらのパラメータが定義されると、アリスとボブはそれぞれ秘密の乱数を選ぶ。アリスは秘密の乱数を $a$ (**色の赤** に相当) と名付け、ボブは $b$ (**色の青*** に相当) と名付ける。これらの数字は秘密にしておかなければならない。
- a$と$b$を直接交換する代わりに、各パーティは$A$と$B$を次のように計算する：

A$は$g$の$p$乗$a$乗に等しい：

$$
A = g^a \bmod p
$$

B$ は $g$ の $p$ 乗 $b$ 乗に等しい：

$$
B = g^b \bmod p
$$


- A$(**オレンジ色**に相当)と$B$(**緑色**に相当)の値が、両者の間で交換される。この交換は、安全でないネットワーク上では平文で行われる；
- B$を受け取ったアリスは、$z$の値を次のように計算する：

z$ は $p$ を $a$ 乗した $B$ に等しい：

$$
z = B^a \bmod p
$$

念のため：

$$
B = g^b \bmod p
$$

結果は...：

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

パワー・ルールを適用することによって：

$$
(x^n)^m = x^{nm}
$$

結果は...：

$$
z = g^{ba} \bmod p
$$


- A$を受け取ったボブも、次のように$z$の値を計算する：

z$ は $p$ を $b$ 乗した $A$ に等しい：

$$
z = A^b \bmod p
$$

結果は...：

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

モジュロ演算子の分配性のおかげで、アリスとボブは全く同じ値$z$を得る。この数値は二人の共通の秘密であり、以前ペンキ缶で一般化された**茶色**に相当する。この共通の秘密を使って、安全でないネットワーク上の通信を対称的に暗号化することができる。

![BTC204](assets/fr/222.webp)

攻撃者は$p$、$g$、$A$、$B$（公開値）を手に入れても、$a$、$b$、$z$（非公開値）を計算することはできない。これは、離散対数、つまり有限環状群における指数の逆数を計算することに等しいので、可能性を一つ一つ試さなければ不可能な操作である。

つまり、$a$、$b$、$p$の値が十分大きい限り、ディフィー・ヘルマン・プロトコルは安全である。通常、パラメータが2048ビット（10進数で600桁）の場合、$a$と$b$のすべての可能性をテストすることは非現実的である。現在までのところ、このような数では、このアルゴリズムは安全であると考えられている。

ここにディフィー・ヘルマン・プロトコルの主な欠点がある。安全であるためには、アルゴリズムは大きな数を使わなければならない。そのため最近では、代数曲線、より正確には楕円曲線に基づくディフィー・ヘルマンの変種であるECDH（*Elliptic Curve Diffie-Hellman*）アルゴリズムの使用が好まれている。このアプローチにより、同等のセキュリティを維持しながら、より小さな数を扱うことが可能になり、計算と保存に必要なリソースを削減することができる。

アルゴリズムの一般原理は変わらない。ただし、乱数$a$と、$a$からべき乗によって計算された数$A$を使う代わりに、楕円曲線上で確立された鍵のペアを使う。モジュロ演算子の分配性に頼る代わりに、楕円曲線上の群法則、より正確にはこの法則の連想性を利用する。

楕円曲線上の暗号の原理を簡単に説明すると、秘密鍵は$1$から$n-1$の間の乱数で表される。一方、公開鍵は、この曲線の特定の点であり、式に従って、生成点から点を加算し、2倍にすることによって秘密鍵から得られる：

$$
K = k \cdot G
$$

この式において、$K$は公開鍵、$k$は秘密鍵、$G$は生成点を示す。

これらの鍵の本質的な特徴は、$k$と$G$から$K$を簡単に計算できる一方、$K$と$G$から$k$を求めることは事実上不可能なことである。この非対称性が一方向性関数を生み出す。つまり、秘密鍵が分かれば公開鍵を計算するのは簡単だが、公開鍵から秘密鍵を取り出すのは不可能なのだ。この安全性は、離散対数の計算の難しさによってさらに裏付けられている。

この性質を利用して、Diffie-Hellmanアルゴリズムを適応させることにする。 **ECDHの動作原理は以下の通りである。


- アリスとボブは暗号的に安全な楕円曲線とそのパラメータに合意する。この情報は公開される；
- アリスは秘密鍵となる乱数$ka$を生成する。この秘密鍵は秘密にしておかなければならない。彼女は、選んだ楕円曲線上の点を足したり2倍にしたりして公開鍵$Ka$を決める：

$$
K_a = k_a \cdot G
$$


- ボブも乱数$kb$を生成する。彼は関連する公開鍵 $Kb$ を計算する：

$$
K_b = k_b \cdot G
$$


- アリスとボブは、安全でない公衆ネットワーク上で公開鍵$Ka$と$Kb$を交換する。
- アリスは、ボブの公開鍵$Kb$に自分の秘密鍵$ka$を適用して、曲線上の点$(x,y)$を計算する：

$$
(x,y) = k_a \cdot K_b
$$


- ボブは、アリスの公開鍵$Ka$に自分の秘密鍵$kb$を適用して、曲線上の点$(x,y)$を計算する：

$$
(x,y) = k_b \cdot K_a
$$


- アリスとボブは楕円曲線上の同じ点を得る。共有秘密はこの点の横軸$x$となる。

彼らは同じ共有秘密を得る：

$$
(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a
$$

セキュアでない公開ネットワークを観察している潜在的な攻撃者は、各個人の 公開鍵と、選択された楕円曲線のパラメータしか得ることができない。上で説明したように、この情報だけでは秘密鍵を決定するには不十分である。その結果、攻撃者はアリスとボブの間で共有された秘密を見つけることはできない。

したがって、ECDHは鍵交換アルゴリズムである。完全なプロトコルを確立するために、他の暗号方式と組み合わせて使われることが多い。例えば、ECDHはTLS（*Transport Layer Security*）の中核をなしている。TLSはインターネットのトランスポート層で使われる暗号化と認証のプロトコルである。TLSは鍵交換にECDHEを使用し、鍵がエフェメラルであるECDHの変種で、永続的な機密性を提供する。さらに、TLSはECDSAなどの認証アルゴリズム、AESなどの暗号化アルゴリズム、SHA256などのハッシュ関数を使用する。

TLS は、https の `s` や、ブラウザのアドレスバーの南京錠など、暗号化された通信のシンボルです。このコースを受講することで、ECDHを使用することになり、知らず知らずのうちに日常的に使用している可能性が高くなります。

### 通知トランザクション

前のセクションで見たように、ECDH は楕円曲線上で確立されたキー・ペアを使用する Diffie-Hellman 交換の変形です。私たちのビットコイン・ウォレットには、すでにこの標準に準拠した鍵ペアが多数存在する！BIP47のアイデアは、両者の階層的決定論的ビットコインウォレットのキーペアを使用して、両者間で共有された一時的な秘密を確立することです。BIP47 はその代わりに ECDHE (*Elliptic Curve Diffie-Hellman **Ephemeral***) を使用します。

![BTC204](assets/fr/223.webp)

ECDHEはまずBIP47で、送信者から受信者への支払いコードの伝送に使用される。これが有名な**通知トランザクション**である。BIP47が効果的に機能するためには、関係者（送信者と受信者）がお互いのペイメントコードを知る必要があるため、このステップは不可欠である。この知識により、エフェメラルな公開鍵の導出が可能になり、その結果、関連する空白の受信アドレスが可能になる。

この交換の前に、送信者は、論理的にはすでに受信者の支払コードを知っており、たとえば、自分のウェブサイト、請求書またはソーシャルネットワークからオフチェーンで取得した。しかし、受信者は必ずしも送信者の支払コードを知っているわけではない。そうでなければ、ビットコインが保管されているアドレスを特定したり、資金にアクセスしたりするために必要なエフェメラルキーを導き出すことができないからだ。送信者のコードの送信は、技術的には他の通信手段によってオフチェーンで行うことができるが、ウォレットをシードからのみ取得する場合には問題が生じる。

これは、従来のアドレスとは異なり、BIP47アドレスは受信者のシードから直接導き出されるのではなく、送信者と受信者の2つの支払いコードを組み合わせた計算から得られるからである。そのため、受信者がウォレットを紛失し、自分のシードからウォレットを復元しようとすると、自分のシードから直接派生した自分の支払いコードを復元することになる。しかし、エフェメラルアドレスを復元するためには、BIP47を介してビットコインを送ったすべての人の支払いコードも必要になる。それゆえ、通知トランザクションの重要性は、この情報をビットコインのブロックチェーンに保存することを可能にすると同時に、2009年の開始以来実行された10億のトランザクションを検索することなく、非常に簡単にそれを見つけることができるようにすることである。

![BTC204](assets/fr/224.webp)

したがって、各ユーザーが仲間の支払いコードのバックアップを保持することを条件に、通知トランザクショ ンを使用せずにBIP47を実装することは可能である。しかし、この方法は、これらのバックアップを作成、保存、更新するためのシンプルで堅牢かつ効率的なソリューションが開発されるまで、管理が複雑であることが判明する。現状では、通知トランザクションはほとんど避けられない。

しかしながら、以下の章では、BIP47と似た目的を持つが、通知トランザクショ ンを必要としない他のプロトコルについて見ていく。しかしながら、これらの代替案は、それ自身のトレードオフをもたらす。

通知トランザクションには、支払いコードを保存する役割に加え、その名前が示すように、受信者に対する通知機能もある。これは、新しい支払いトンネルが確立されたという事実を受信者の顧客に警告し、その結果生じるエフェメラルアドレスを注視するよう提案する。

### BIP47の機密保持モデル

通知トランザクションの技術的な動作を詳述する前に、BIP47に関連する機密性モデルについて議論することが重要である。

支払いコード自体は、機密性に対する直接的なリスクをもたらさない。キーとアドレスの匿名性を維持することで、ユーザーのアイデンティティと取引（公開されている）の間のリンクを断ち切ることを目的とした従来のビットコインモデルとは異なり、支払いコードは脅威をもたらすことなく、公然とアイデンティティと関連付けることができる。

これは、支払いコードがBIP47の支払いを受けるアドレスを直接導出するために使用されないためである。その代わり、これらのアドレスは、ECDHアプリケーションを経由して、関係する2者の支払 コードから派生する鍵の間で生成される。

したがって、決済コード自体から直接機密性が失われることはない。このアドレスから特定の情報が明らかになることはあるが、徹底的な連鎖分析が行われない限り、通常、取引相手が明らかになることはない。実際、送信者が自分の ID にリンクできる UTXO を使用して通知トランザクショ ンを実行した場合、その ID がおそらくあなたの支払コードに対する BIP47 の支払いにリンクされてい ることを推論することが可能になる。これによって基礎となる取引が明らかになるわけではないが、その可能性が高いことが示される。

したがって、ユーザーの支払いコード間の厳密な分離を維持することが不可欠である。このことを念頭に置くと、コードの最初の伝達は、支払いの機密性にとって重要な瞬間であるが、プロトコルが正しく機能するためには不可欠なものである。支払いコードの一方が（ウェブサイト上などで）公開されている場合、2 番目のコード（送信者 のコード）は、いかなる場合でも最初のコードとリンクさせてはならない。

具体的な例を挙げてみよう：ある政治運動にBIP47を通じて寄付をしたい：


- 同団体は、ウェブサイトやソーシャルネットワークを通じて支払いコードを公開している；
- したがって、この規約は政治運動と結びついている；
- 私はこの支払いコードを取得します；
- 送信する前に、相手が私自身の支払いコードを知っていることを確認しなければならない。このコードは、私のソーシャルネットワークで取引を受けるために使用しているため、私のIDともリンクしている。

自分のコードをリスクなく伝えるにはどうしたらいいのだろう？従来の通信手段を使用すると、情報の漏洩につながり、その結果、この政治運動と私を結びつけることになりかねない。通知取引は、2つのコード間のそのような関連付けを防ぐ暗号化レイヤーのおかげで、解決策を提供する。送信者の支払いコードを秘密裏に送信する唯一の方法ではないが、非常に効果的な方法である。

下の図では、オレンジ色の線が情報の流れを遮断しなければならない箇所を示し、黒い矢印が第三者が観察できる可能性のあるつながりを示している：

![BTC204](assets/fr/225.webp)

現実には、ビットコインの伝統的な機密性モデルでは、特に遠隔地の取引において、鍵ペアとユーザーとの間の情報の流れを完全に切り離すのは複雑な場合が多い。例えば、寄付キャンペーンの文脈では、受取人は必然的に自分のウェブサイトやソーシャルネットワークを通じてアドレスや公開鍵を開示しなければならない。BIP47を正しく使えば、特に通知トランザクションでは、ECDHEと後で説明する暗号化レイヤーのおかげで、この問題を回避することが可能になる。

もちろん、ビットコインの古典的な機密性モデルは、2つの支払いコードの組み合わせから得られるエフェメラルな公開鍵にも適用される。この2つのモデルは実際、補完関係にある。ここで強調したいのは、ビットコインを受け取るための通常の公開鍵の使用とは異なり、「_AliceはBob_と取引している」という情報が別の段階で破られるため、支払いコードは特定のIDにリンクできるということである。ペイメントコードはペイメントアドレスを生成するために使用されるが、ブロックチェーンの観察のみに基づけば、関係するUTXOが以前にすでにアイデンティティにリンクされており、ユーザーがペイメントコードをそれぞれのアイデンティティに関連付けない限り、BIP47のペイメントトランザクションをその実行に使用されたペイメントコードにリンクすることは不可能である。

結論から言えば、BIP47ペイメントが提供する秘密保持モデルは、ビットコインの基本モデルよりも優れていると考えられるが、これは魔法のようなものという意味ではない。

### 通知トランザクションの構築

では、この通知トランザクションがどのように機能するか見てみよう。アリスがBIP47を使ってボブに資金を送りたい場合を考えてみよう。この例では、アリスが送り手、ボブが受け手となります。ボブは自分のウェブサイトで支払いコードを公開している。したがって、アリスはすでにボブの支払いコードを知っている。

**アリスはECDHで共有秘密を計算する。


- 彼女は自分のHDウォレットから、支払いコードとは別のブランチ上のキーペアを選択する。このペアは、アリスの通知アドレスやアリスのID(前のセクションを参照)と簡単に関連づけられるものであってはならないことに注意；
- アリスはこのペアの秘密鍵を選ぶ。これを$a$(小文字)と呼ぶ；

$$
a
$$


- AliceはBobの通知アドレスに関連付けられた公開鍵を取り出す。この鍵は、Bobの支払いコード(インデックス$/0$)から派生した最初の 子鍵である。この公開鍵を$B$(大文字)と呼ぶ。この公開鍵に関連する秘密鍵を$b$(小文字)と呼ぶ。B$は、$G$(生成点)から楕円曲線上の点を$b$(秘密鍵)で加算・倍加することで決定される：

B = b Γcdot G $$.


- アリスは、ボブの公開鍵$B$から秘密鍵$a$を適用して、楕円曲線上の秘密点$S$(大文字)を、点の足し算と2倍算によって計算する。

S = a \cdot B $$.


- Aliceは、自分の支払いコードを暗号化するために使用される目隠し係数$f$を計算する。これを行うために、アリスはHMAC-SHA512関数を使って擬似乱数を決定する。この関数への2つ目の入力は、ボブだけが見つけることができる値である：これは上で計算した秘密点の横軸である。最初の入力は$o$であり、このトランザクションの入力として消費されたUTXOである(outpoint)。

f = \text{HMAC-SHA512}(o, x) $$.

**2 - アリスは個人の支払いコードをベース2（バイナリ）に変換する。

**使用される暗号化アルゴリズムは単純に`XOR`である。実行される操作は、「ワンタイムパッド」としても知られるバーナム暗号に匹敵する。


- 最初の32バイトを$f1$、最後の32バイトを$f2$とする。これで ：

f = f1 || f2 $$.


- アリスは、自分の支払いコードの公開鍵$x$の横軸の暗号$x'$と、自分の文字列コード$c$の暗号$c'$を別々に計算する。f1$と$f2$はそれぞれ暗号鍵として機能する。使用する演算は `XOR`（または排他的論理和）である。

x' = x ﹑ f1 $$.

c' = c \oplus f2 $$.


- アリスは、公開鍵の横軸$x$と支払いコードの文字列コード$c$の実数値を、暗号化された値$x'$と$c'$に置き換える。

**したがって、Aliceは現在、暗号化されたペイロードを持つ自分の支払い コードを持っている。彼女は自分の公開鍵$A$を入力とし、Bobの通知アドレスへの出力と、暗号化されたペイロードを持つ自分の支払いコードからなる出力`OP_RETURN`を含むトランザクションを構築し、ブロードキャストする。 **このトランザクションが通知トランザクションである。

OP_RETURN`はビットコイン取引の出力を無効とマークするオペコードである。今日、これはビットコインブロックチェーン上の情報をブロードキャストまたはアンカーするために使用される。これは最大80バイトのデータを保存することができ、チェーンに書き込まれ、他のすべてのユーザーが見ることができる。

これまでのセクションで見てきたように、ECDHは安全でないネットワーク上で通信する2人のユーザー間で共有秘密を生成するために使用され、攻撃者に観察される可能性がある。BIP47では、ECDHはビットコインネットワーク上で通信するために使用されます。ビットコインネットワークはその性質上、透過的な通信ネットワークであり、多くの攻撃者に観察されます。ECDH鍵交換によって計算された共有秘密は、送信される秘密情報である送信者の支払いコード（アリス）を暗号化するために使用される。

通知トランザクションを実行するために、今見てきた手順をまとめておこう：


- アリスはボブの支払いコードと通知アドレスを取得する；
- アリスは対応するキー・ペアを持つHDポートフォリオからUTXOを選択する；
- ECDH を使って楕円曲線上の秘密点を計算する；
- このシークレットポイントを使ってHMACを計算する；
- 彼女はこの目くらまし要素を使って、個人的な支払いコードのペイロードを暗号化する；
- OP_RETURN`トランザクション出力を使用して、隠された支払いコードをBobに伝える。

![BTC204](assets/fr/226.webp)

### 取引通知：実践的研究

OP_RETURN`の使い方をより詳しく理解するために、実際の通知トランザクションを見てみよう。ここをクリック](https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e)してください。

![BTC204](assets/fr/227.webp)

このトランザクションを見ると、すでに1つの入力と4つの出力があることがわかる：


- 最初の出力は`OP_RETURN`で、私の隠れた支払いコードが含まれている；
- 546サッツの2番目の出力は、私の受信者の通知アドレスを指している；
- 15,000サットの3番目の出力はサービス料を表している。この取引を構築するためにサムライ・ウォレットを使用したからだ；
- 200万サッツの4番目の出力は、為替レート、つまり私の入力の残りの差額を表し、それは私に属する別のアドレスに戻る。

最も興味深いのは、明らかに`OP_RETURN`を使った出力0である。その中身を詳しく見てみよう。これが `scriptPubKey` を16進数で表したものだ：

```text
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

このスクリプトにはいくつかの部分がある。まず、：

```text
6a4c
```

オペコードのうち、`OP_RETURN`を指定する`0x6a`と`OP_PUSHDATA1`を指定する`0x4c`を認識することができる。

この最後のオペコードに続くバイトは、それに続くペイロードのサイズを示す。0x50`、つまり80バイトを示す：

```text
6a4c50
```

次に、私の支払いコードのメタデータを平文で：

```text
010002
```

私の支払いコードの公開鍵の暗号化された横軸：

```text
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

私の支払コードの暗号化された文字列コード：

```text
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

そして最後に、`OP_RETURN`の標準サイズである80バイトにパディングする：

```text
00000000000000000000000000
```

理解を助けるために、ここに私の支払いコードをプレーンテキストでベース58で示します：

```text
PM8TJQCyt6ovbozreUCBrfKqmSVmTzJ5vjqse58LnBzKFFZTwny3KfCDdwTqAEYVasn11tTMPc2FJsFygFd3YzsHvwNXLEQNADgxeGnMK8Ugmin62TZU
```

そして、ベース16：

```text
4701000277507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42add94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc000000000000000000000000008604e4db
```

プレーンテキストの支払いコードと`OP_RETURN`を比較すると、HRP (`0x47`)とチェックサム(`0x8604e4db`)が送信されていないことがわかる。この情報は人間のためのものなので、これは正常である。

次に、バージョン(`0x01`)、ビットフィールド(`0x00`)、公開鍵のパリティ(`0x02`)を認識できる。そして、ペイメントコードの最後には、合計 80 バイトになるようにパディングするための空白バイト (`0x000000000000000000`) がある。このメタデータはすべて暗号化されずに送信される。

最後に、公開鍵の横軸 (`0x77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a`) と文字列コード (`0xdd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc`) が暗号化されていることがわかる。これが支払いコードのペイロードである。

### XORとは？

これまでのセクションで、決済コードは XOR 演算を使って暗号化されて送信されることを見てきた。この演算子は暗号技術で広く使用されているため、その仕組みを詳しく見てみよう。

XORはブール代数に基づくビットごとの論理演算子である。ビットの2つのオペランドが与えられたとき、同じ順位のビットが異なれば`1`を返し、同じ順位のビットが等しければ`0`を返す。以下はオペランド `D` と `E` の値によるXOR真理値表である：

| d | e | d xor e |

| --- | --- | ------- |

| 0 | 0 | 0 |

| 0 | 1 | 1 |

| 1 | 0 | 1 |

| 1 | 1 | 0 |

例えば、こうだ：

$$
0110 \oplus 1110 = 1000
$$

あるいは：

$$
010011 \oplus 110110 = 100101
$$

ECDHでは、暗号化レイヤーとしてXORを使用することが特に一貫している。第一に、この演算子のおかげで、暗号化は対称的である。つまり、受信者は暗号化に使われたのと同じ鍵で支払いコードを復号化できる。暗号化キーと復号化キーは、ECDHを使用して共有秘密から計算される。この対称性は、XOR 演算子の可換性と連想性の特性によって可能となる：


- その他の物件 ：

$$
D \oplus D = 0
$$

$$
D \oplus 0 = D
$$


- 可換性：

$$
D \oplus E = E \oplus D
$$


- 連想性：

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
$$

もし：

$$
D \oplus E = L
$$

それから：

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
$$

第二に、この暗号化方式はバーナム（ワンタイムパッド）暗号に非常によく似ている。バーナム暗号は、現在知られている暗号化アルゴリズムで唯一、無条件（あるいは絶対）安全性を持つものだ。バーナムの暗号がこの機能を持つためには、暗号鍵は完全にランダムで、メッセージと同じサイズで、一度しか使われないものでなければならない。ここでBIP47に使用されている暗号化方式では、鍵は確かにメッセージと同じ大きさであり、盲検化係数は公開鍵の横軸と支払いコードの文字列コードを連結したものと全く同じ大きさである。この暗号鍵は一度しか使用されない。一方、この鍵はHMACであるため、完全なランダム性から導出されたものではない。むしろ、疑似ランダムである。つまり、バーナム暗号ではないが、この方法はそれに近い。

### 通知トランザクションの受信

アリスが通知トランザクションをボブに送ったので、ボブがそれをどう解釈するか見てみよう。注意として、BobはAliceの支払いコードにアクセスできなければならない。この情報がないと、次のセクションで説明するように、アリスが作成した鍵ペアを導き出すことができないので、BIP47経由で受け取ったビットコインにアクセスすることができない。今のところ、アリスの支払いコードのペイロードは暗号化されています。ボブがどのように解読するか見てみましょう。

**1-**ボブは、自分の通知アドレスでアウトプットを作成するトランザクションを監視する。

**2-**トランザクションがその通知アドレスに出力を持つとき、ボブは、それがBIP47標準に準拠したOP_RETURN出力を含むかどうかを確認するために、それを分析する。

**OP_RETURN ペイロードの最初のバイトが`0x01`の場合、ボブはECDHと共有される可能性のある秘 密の検索を開始する：


- Bobはトランザクションの入力公開鍵を選択する。つまり、アリスの公開鍵$A$と：

A = a \cdot G $$.


- Bobは、自分の個人通知アドレスに関連付けられた秘密鍵$b$を選択する：

$$ b $$


- ボブは、楕円曲線上の秘密点$S$(共有秘密ECDH)を計算する。この計算では、アリスの公開鍵$A$に自分の秘密鍵$b$を適用して、点を足し合わせたり2倍にしたりする：

S = b Γcdot A $$.


- Bobは、Aliceの支払いコードのペイロードを復号できるようにする目隠し係数 $f$を決定する。アリスが以前に計算したのと同じ方法で、ボブは秘密点$S$の横軸値$x$と、この通知トランザクションの入力として消費されたUTXOである$o$にHMAC-SHA512を適用して$f$を求める：

f = \text{HMAC-SHA512}(o, x) $$.

**Bobは通知トランザクションのOP_RETURNデータを支払いコードと解釈する。彼はこの潜在的な支払いコードのペイロードを$f$の盲検化係数を使用して単純に復号化する：


- ボブは目隠し係数$f$を2つに分割する。$f$の最初の32バイトを$f1$とし、最後の32バイトを$f2$とする；
- ボブはアリスの支払いコードの公開鍵から、暗号化された横軸$x'$の値を復号する：

x = x' ㊟ $$ f1


- ボブはアリスの支払いコードから暗号化された文字列コード$c'$の値を復号する：

$$ c = c'  \oplus f2 $$

**5-**BobはAliceの支払いコードの公開鍵がsecp256k1グループの一部であるか どうかチェックする。もしそうなら、Bobはこれを有効なペイメントコードと解釈する。そうでない場合、トランザクションを無視する。

ボブはアリスの支払いコードを知っているので、アリスはこのタイプの通知トランザクションを繰り返すことなく、`2^32`までの支払いを送ることができる。

なぜうまくいくのか？ボブはどうやってアリスと同じ目くらまし要素を判断し、彼女の支払いコードを解読できるのか？今説明したECDHの動作を詳しく見てみよう。

まず第一に、我々は対称暗号化を扱っている。これは、暗号化キーと復号化キーが同じ値であることを意味する。通知トランザクションでは、この鍵が盲点となる：

f = f1 || f2 $$.

したがって、AliceとBobは$f$の値を直接送信することなく、同じ値を得る必要がある。この目隠し係数は、2つの値にHMAC-SHA512を適用することで得られる：


- 秘密点の横軸；
- とトランザクション入力で消費されるUTXO。

したがって、BobはAliceの支払いコードペイロードを復号化するために、これら両方の情報を必要とする。入力UTXOについては、Bobは通知トランザクションを観察することで、単純にそれを取得することができる。秘密鍵については、BobはECDHを使う必要がある。ディフィー・ヘ ルマン(Diffie-Hellman)の前のセクションで見たように、それぞれの公開鍵を交換し、秘密鍵 を互いの公開鍵に秘密裏に適用するだけで、AliceとBobは楕円曲線上の正確な秘密点を見つけ ることができる。通知トランザクションはこのメカニズムに基づいている：


- ボブのペアキー ：

B = b Γcdot G $$.


- アリスの鍵ペア：

A = a \cdot G $$.


- 秘密 $S (x, y)$ について：

S = a ╱ B = a ╱ (b ╱ G) = (b ╱ a) ╱ G = b ╱ A $$.

![BTC204](assets/fr/228.webp)

ボブはアリスの支払いコードを知っているので、彼女のBIP47支払いを検出することができ、受け取ったビットコインをブロックする秘密鍵を導き出すことができる。

通知トランザクションを受信して解釈するために、今見てきた手順をまとめておこう：


- ボブは自分の通知アドレスへのトランザクション出力を監視している；
- それを検出すると、OP_RETURNに含まれる情報を取得する；
- Bobは入力として公開鍵を選択し、ECDHを用いて秘密点を計算する；
- このシークレットポイントを使ってHMACを計算する；
- OP_RETURNに含まれるアリスの支払いコードペイロードを解読するために、この目くらまし要素を使用する。

![BTC204](assets/fr/229.webp)

### BIP47の支払いトランザクション

BIP47での支払いプロセスを見てみましょう。現在の状況を思い出してください：


- アリスはボブの支払いコードを知っており、それは単にボブのウェブサイトから取得したものである；
- ボブは通知トランザクションからアリスの支払コードを知っている；
- アリスはボブに最初の支払いをする。アリスは同じ方法でもっと多くの支払いをすることができる。

このプロセスを説明する前に、現在取り組んでいるインデックスを覚えておくことが重要だと思う。支払いコードの導出パスは次のように記述される：`m/47'/0'/0'`.次の深さはインデックスを次のように分割する：


- 最初の通常の（非強制的な）ドーターペアは、前のセクションで説明した通知アドレスの生成に使用されるものである： `m/47'/0'/0'/0` ；
- 通常のドーターキーペアは、このセクションで説明するように、ECDH 内で BIP47 の支払い受領アドレスを生成するために使用されます： `m/47'/0'/0` から `m/47'/0'/0'/2,147,483,647` まで；
- 強化娘鍵ペアは、「m/47'/0'/0'/0'`」から「m/47'/0'/0'/2,147,483,647'`」までの儚い支払コードである。

アリスがボブに支払いを送りたいときは毎回、ECDHプロトコルを使って、新しい、ユニークな、空白のアドレスを導き出す：


- アリスは個人の再利用可能な支払いコードから最初の秘密鍵を選択する：

$$ a $$


- AliceはBobの支払いコードから、最初の未使用の公開鍵を選択する。この公開鍵を$B$と呼ぶ。この公開鍵は、ボブだけが知っている秘密鍵 $b$ と結びついている：

B = b Γcdot G $$.


- アリスは、ボブの公開鍵$B$から自分の秘密鍵$a$を適用して、楕円曲線上の点を足したり2倍にしたりして秘密点$S$を計算する：

S = a \cdot B $$.


- この秘密点から、アリスは共有秘密$s$(小文字)を計算する。これを行うには、秘密点 $S$ の横軸を $Sx$ とし、この値を SHA256 ハッシュ関数に渡す：

S = (Sx, Sy) $$.

s = \text{SHA256}(Sx) $$.


- アリスはこの共有秘密 $s$ を使って、ビットコイン支払受付アドレスを計算する。まず、$s$がsecp256k1曲線の次数に含まれているかチェックする。そうでない場合、アリスはボブの公開鍵インデックスをインクリメントし、別の共有秘密を導き出す；
- 第二段階として、楕円曲線上の点$B$と$s-G$を加算して公開鍵$K0$を計算する。つまり、アリスはボブの支払いコード$B$から導き出した公開鍵を、secp256k1曲線生成点$G$から共有秘密$s$を用いて楕円曲線上の点を加算・倍加して計算した別の点に加える。この新しい点を公開鍵とし、$K0$ と呼ぶ：

K0 = B + s ⊖cdot G $$.


- この公開鍵$K0$を使えば、アリスは標準的な方法(例えばbech32のSegWit V0)で空白の受信アドレスを導き出すことができる。

AliceがBobの$K0$受信アドレスを取得したら、標準的な方法でビットコイン取引を実行できる。これを行うために、彼女はHDウォレットの別のブランチから鍵ペアで保護された、自分の所有するUTXOを選択し、ボブの$K0$アドレスへの出力を満たすためにそれを消費する。この支払いは、一旦アドレスが導出されると、古典的なプロセスに従い、もはやBIP47に関連する鍵に依存しないことに注意することが重要である。

今見てきたBIP47の支払いを送るまでの手順をまとめてみよう：


- アリスは個人の支払いコードから最初の娘の秘密鍵を選択する；
- Bobの支払いコードから得られる最初の未使用の娘公開鍵から、ECDHを使用して楕円曲線上の秘密点を計算する；
- このシークレットポイントを使って、SHA256で共有秘密を計算する；
- 彼女はこの共有秘密を使って楕円曲線上の新しい秘密点を計算する；
- 彼女はこの新しい秘密鍵をボブの公開鍵に追加する；
- 彼女は、Bobだけが関連する秘密鍵を持っている新しいエフェメラル公開鍵を得る；
- Aliceは派生したエフェメラル受信アドレスでBobに古典的な取引を行うことができる。

![BTC204](assets/fr/230.webp)

Aliceが2回目の支払いを行う場合、Bobの支払いコードから2つ目の公開鍵を選択する ことを除いて、前と同じ手順を踏む。具体的には、次の未使用の鍵を使用する。こうして、アリスはボブの新しい受信アドレスを取得する：

![BTC204](assets/fr/231.webp)

このようにして、ボブに属する最大`2^32`の空白アドレスを導き出すことができる。

外部の視点からブロックチェーンを見ると、BIP47決済を従来の決済と区別することは理論上不可能です。以下は、TestnetにおけるBIP47決済取引の例である：

```text
94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
```

それは、消費された入力、支払いの出力、為替レートを持つ古典的な取引のように見える：

![BTC204](assets/fr/232.webp)

### BIP47の受領と秘密鍵の導出

アリスはボブの空白のBIP47アドレスに最初の支払いをした。では、ボブがどうやってこの支払いを受け取るかを見てみよう。また、アリスが自分で生成したアドレスの秘密鍵にアクセスできない理由と、ボブが受け取ったビットコインを使うためにこの鍵を見つける方法も見てみましょう。

BobはAliceから通知トランザクションを受け取るとすぐに、彼のコレスポン ダーが支払いを送る前であっても、公開鍵BIP47 $K0$を導き出す。そのため、ボブは関連するアドレスへの支払いを観察する。実際、ボブは観察した複数のアドレス($K0$, $K1$, $K2$, $K3$...)を即座に導き出す。この公開鍵$K0$の導き出し方は以下の通りである：


- Bobは、自分の支払いコードに由来する最初の娘の秘密鍵を選択する。この秘密鍵は$b$と名付けられる。この秘密鍵は、アリスが前のステップで計算を行った公開鍵 $B$と関連付けられている：

$$ b $$


- ボブはアリスの支払いコードから最初の公開鍵を選ぶ。この鍵は$A$と名付けられる。この鍵はアリスが計算した秘密鍵$a$と関連付けられ、アリスだけが知っている。Bobは、通知トランザクションで送られたAliceの支払いコードを知っているので、 このプロセスを実行できる：

A = a \cdot G $$.


- ボブは、アリスの公開鍵$A$に自分の秘密鍵$b$を適用することで、 楕円曲線上の点を足したり2倍にしたりして秘密点$S$を計算する。ここでもECDHは、この点$S$がボブとアリスの両方にとって同じであることを保証するために使われる：

S = b Γcdot A $$.


- アリスと同じように、ボブはこの点$S$の横軸を分離する。この値を$Sx$と名付けた。彼はこの値をSHA256関数に渡し、共有秘密$s$(小文字)を求める：

s = \text{SHA256}(Sx) $$.


- アリスと同じように、ボブは楕円曲線上の$s-G$点を計算する。そして、この秘密点を自分の公開鍵$B$に加える。そして、楕円曲線上の新しい点を得て、それを公開鍵$K0$と解釈する：

K0 = B + s ⊖cdot G $$.

ボブはこの公開鍵 $K0$ を手に入れると、ビットコインを使うための秘密鍵を導き出すことができる。この秘密鍵を生成できるのは本人だけである：


- ボブは、自分の個人的な支払いコードから導き出された娘の秘密鍵$b$を加算する。b$の値を知ることができるのは本人だけである。次に$b$を共有秘密$s$に加え、$k0$の秘密鍵$k0$を得る：

k0 = b + s $$.

楕円曲線の群律のおかげで、ボブはアリスが使った公開鍵に対応する秘密鍵を正確に得ることができる。したがって、次のようになる：

K0 = k0 ㎟ G $$.

BIP47の支払いを受け、それに対応する秘密鍵を計算するために、今見てきた手順をまとめておこう：


- Bobは、個人の支払いコードから派生した最初の娘の秘密鍵を選択する；
- アリスの文字列コードから得られる最初の娘の公開鍵から、ECDHを使って楕円曲線上の秘密点を計算する；
- このシークレットポイントを使って、SHA256で共有秘密を計算する；
- 彼はこの共有された秘密を使って楕円曲線上の新しい秘密点を計算する；
- 彼は、この新しい秘密鍵を自分の個人公開鍵に追加する；
- 彼は新しいエフェメラルな公開鍵を手に入れ、アリスはその公開鍵に最初の支払いを送る；
- Bobは、支払いコードと共有秘密鍵から得た娘秘密鍵を加えることで、このエフェメラルな公開鍵に関連する秘密鍵を計算する。

![BTC204](assets/fr/233.webp)

アリスは$b$(ボブの秘密鍵)を入手できないので、$k0$(ボブの BIP47受信アドレスに関連付けられた秘密鍵)を決定できない。共有秘密$S$の計算を模式的に表すと以下のようになる：

![BTC204](assets/fr/228.webp)

ECDHで共有秘密が見つかると、アリスとボブはBIP47支払い公開鍵$K0$を計算し、ボブも関連する秘密鍵$k0$を計算する：

![BTC204](assets/fr/234.webp)

### BIP47の払い戻し

ボブはアリスの再利用可能な支払いコードを知っているので、彼女に返金を送るために必要な情報をすでにすべて持っている。ボブはアリスに再度連絡して情報を求める必要はない。ボブは単に通知トランザクションでアリスに通知し、アリスがシードでBIP47アドレ スを取得できるようにする必要があるだけである。

この払い戻し機能はBIP47特有のもので、後の章で説明するサイレント・ペイメントなどの他の方法と比較した場合の利点の一つである。

ボブはアリスに支払いを送ったのと同じ方法でアリスに払い戻すことができる。役割は逆である：

![BTC204](assets/fr/235.webp)

*本章執筆のきっかけとなった論文の校正と専門的なアドバイスをしてくれた[Fanis Michalakis](https://x.com/FanisMichalakis)に感謝する！

https://planb.network/tutorials/privacy/on-chain/paynym-bip47-a492a70b-50eb-4f95-a766-bae2c5535093

## サイレント・ペイメント

<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>


BIP47はそのオンチェーンの非効率性から広く批判されてきた。前章で説明したように、BIP47では新しい受取人ごとに通知トランザクションを実行する必要がある。この制約が無視できなくなるのは、この受信者と持続可能な支払いチャネルを確立しようと計画している場合である。実際、1回の通知トランザクションは、ほぼ無限に続くBIP47の支払いに道を開く。

しかし、特定の状況では、通知トランザクションがユーザーにとって障害となることがある。例えば、ある受取人への1回限りの寄付を例にとってみよう。従来のビットコインアドレスでは、1回の取引で寄付が完了する。しかし、BIP47では2つのトランザクションが必要となる。1つは通知用、もう1つは実際の支払い用である。ブロックスペースの需要が低く、取引手数料が低い場合、この余分なステップは通常問題にはならない。しかし、混雑時には、1回の支払いにかかる取引手数料が法外になり、標準的なビットコイン取引に比べてユーザーへのコストが2倍になる可能性がある。

ユーザーが静的な識別子に対して数回しか支払いを行わない予定の場合、他のソリューションが 開発されている。これには、[BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki)で説明されているSilent Paymentsが含まれる。このプロトコルは、アドレスの再利用を発生させることなく、また通知トランザクショ ンを使用することなく、静的識別子を使用して支払いを受け取ることを可能にする。このプロトコルの仕組みを見てみよう。

---
*この章を完全に理解するためには、HDウォレットにおけるECDH（楕円曲線ディフィー・ヘルマン）と暗号鍵導出の仕組みをマスターすることが不可欠です。これらの概念はBIP47の前の章で詳しく説明した。ここでは繰り返しません。これらの概念にまだ馴染みがない場合は、この章に進む前に前の章を参照することをお勧めします。受け取りアドレスの再利用に関連するリスクや、支払いを受け取るための一意の識別子を持つことの重要性については、ここでは繰り返しません。

---
### なぜ通知を移動させないのか？

BIP47の章で議論されたように、通知トランザクションには2つの主な機能がある：


- 受信者に通知される；
- 送信者の支払いコードを送信する。

この通知プロセスはオフチェーンで行えるのではないかと素朴に思うかもしれない。受信者は、送信者からBIP47支払いコードを受信するための通信手段を指示するだけでよいからだ。しかし、この方法には2つの大きな問題がある：


- まず、コード伝送プロセスを別の通信プロトコルに移行する。交換のコストと機密性に関する問題は残るが、単にこの新しいプロトコルに移されるだけである。機密性という点では、ユーザーのアイデンティティとオンチェーン活動との間にリンクが生じる可能性もあり、これはブロックチェーン上で直接通知を行うことで避けようとしていることである。さらに、通知をブロックチェーンの外で行うことは、ビットコインには存在しない検閲のリスク（資金のブロックなど）をもたらすことになる；
- 第二に、これはリカバリーの問題を引き起こす。BIP47では、受信者は資金にアクセスするために送信者の支払いコードを知っていなければならない。これは、受領時だけでなく、ウォレットが紛失した場合にシードを通じて資金が回収される場合にも当てはまる。オンチェーン通知では、ユーザーは自分のシードを知っているだけで通知トランザクションを取得し、復号化できるため、このリスクは回避される。しかし、通知がブロックチェーンの外部で行われる場合、ユーザーは受け取ったすべての支払いコードの動的バックアップを維持しなければならず、一般ユーザーにとっては現実的ではない。

これらすべての制約から、BIP47にはオンチェーン通知の利用が不可欠である。しかし、サイレント・ペイメントは、まさにそのコストのために、このオンチェーン通知のステップを避けようとしている。したがって、採用された解決策は、通知を移動させることではなく、通知を完全に排除することである。これを達成するためには、スキャンという妥協案を受け入れなければならない。通知トランザクションのおかげでユーザーが資金のありかを正確に知っているBIP47とは異なり、サイレント・ペイメンツでは、ユーザーは自分宛ての支払いを検出するために既存のビットコイン取引をすべて調べなければならない。この操作負担を軽減するため、サイレントペイメン トの検索は、そのような支払いを含む可能性の高いトランザクション、すなわち少なくとも 1 つの Taproot P2TR 出力があるトランザクションのみに限定される。また、スキャンはウォレット作成日からのトランザクションのみに焦点を当てる（ウォレットが2024年に作成された場合、2009年までのトランザクションをスキャンする必要はない）。

BIP47とサイレント・ペイメントは、同じような目的でありながら、異なるトレードオフを伴うため、**実際には異なるユースケース**に対応することがお分かりいただけるでしょう。一回限りの寄付のような単発の支払いには、サイレント・ペイメントの方が低コストであるため適している。一方、取引所プラットフォームやマイニングプールのように、同じ受取人に対する定期的な取引には、BIP47が好まれるかもしれません。

何が問題になっているのかをよりよく理解するために、サイレント・ペイメントの技術的な運用を見てみよう。そのために、BIP352の説明文書と同じアプローチを取ることを提案する。実施される計算を要素ごとに徐々に分解し、新たに追加される各要素を正当化する。

### 理解すべきいくつかの概念

サイレント・ペイメントを始める前に、P2TR（*Pay to Taproot*）スクリプト・タイプの使用のみに依存していることを指摘しておく。BIP47とは異なり、ハッシュ化によって子公開鍵から受信アドレスを導き出す必要はない。P2TR標準では、微調整された公開鍵がアドレスで暗号化されずに直接使用される。つまり、Taprootの受信アドレスは、基本的に公開鍵にメタデータを加えたものである。1つは単純な署名による従来の直接支出を可能にするもので、もう1つは MASTのメルクルルートを表すものである。このメルクルルートは、メルクルツリーに刻まれる可能性のある 条件の1つを満たすことを条件に支出を認可するものである。

![BTC204](assets/fr/068.webp)

サイレント・ペイメントをタップルートに限定した主な理由は2つある：


- 第一に、1つの規格に準拠すればよいので、ポートフォリオ・ソフトウェアの実装と将来のアップグレードがかなり容易になる；
- 第二に、このアプローチは、連鎖分析において別個のポートフォリオ・フィンガープリントを生成する異なるタイプのスクリプトの間で自分自身を分断しないように促すことによって、ユーザーのアノンセットを改善するのに役立つ（このコンセプトの詳細については、第2部の第4章を参照）。

### サイレント・ペイメンツ公開鍵のナイーブな導出

SP（サイレント・ペイメント）の仕組みの核心に迫るため、簡単な例から始めよう。アリスとボブ、2人のビットコインユーザーを例にしよう。アリスは空白の受信アドレスでボブにビットコインを送りたい。このプロセスには3つの目的がある：


- アリスは空白のアドレスを生成できなければならない；
- ボブは、この特定のアドレスに送られた支払いを特定できなければならない；
- ボブは資金を使うために、このアドレスに関連する秘密鍵を入手できる必要がある。

アリスはセキュアなビットコインウォレットに以下のキーペアでUTXOを持っている：


- a$: 秘密鍵 ；
- A$: 公開鍵 ($A = a \cdot G$)

ボブはSPアドレスを持っており、それをインターネット上で公開している：


- b$: 秘密鍵 ；
- B$：公開鍵($B = b \cdot G$)。

ボブのアドレスを取得することで、アリスはECDHを使ってボブに属する 新しい空白アドレスを計算することができる。このアドレスを $P$ と呼ぶことにする：

P = B +  \text{hash}(a ˶´⚰︎`˵) ˶´⚰︎`˵$ $$ G

この式で、アリスは自分の秘密鍵$a$とボブの公開鍵$B$のスカラー積を計算しただけである。アリスはこの結果を、誰もが知っているハッシュ関数に渡した。その結果得られた値に、楕円曲線 `secp256k1` の生成点 $G$ がスカラー倍される。最後に、アリスは結果の点をボブの公開鍵 $B$ に加える。アリスがこのアドレス$P$を手に入れたら、それを取引の出力として使う。

> *サイレントペイメン トの文脈では、「ハッシュ」関数は、`BIP0352/SharedSecret`で特別にタグ付けされた SHA256ハッシュ関数に相当する。これは、生成されるハッシュがこのプロトコルに固有であり、 他の文脈で再利用できないことを保証するものである。この規格は `secp256k1` の [BIP340 for Schnorr signatures](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) で規定されているものに相当する*。
ECDHのベースとなっている楕円曲線の性質のおかげで、：

a \cdot B = b \cdot A $$.

したがって、ボブはアリスがビットコインを送った受信アドレスを計算できる。これを行うために、彼はサイレント・ペイメントの基準を満たす全てのビットコイン取引を監視し、それぞれの取引に以下の計算を適用し、支払いが自分宛かどうかを確認する（*スキャン*）：

P' = B +  \text{hash}(b  \cdot A)  \cdot G $$ P' = B +  \text{hash}(b ˶´⚰︎`˵)

アリスの取引をスキャンしたとき、彼は$P'$が$P$と等しいことに気づいた。したがって、彼はその支払いがアリス宛であることを知る：

P' = B + ⅳtext{hash}(b ⅳcdot A) ⅳ G = B + ⅳtext{hash}(a ⅳcdot B) ⅳ G = P $$.

ここから、ボブはアドレス$P$の使用を可能にする秘密鍵$p$を計算することができる：

$$ p = (b + \text{hash}(b \cdot A))\bmod n $$

おわかりのように、この秘密鍵$p$を計算するには、秘密鍵$b$を持っていなければならない。この秘密鍵$b$を持っているのはボブだけである。したがって、サイレントペイメントのアドレスに送られたビットコインを使うことができるのは彼だけになります。

![BTC204](assets/fr/236.webp)

*凡例：*。


- B$ : ボブが公開した公開鍵/静的アドレス
- b$ : ボブの秘密鍵
- A$ : トランザクションの入力として使われるアリスのUTXO公開鍵。
- a$ : アリスの秘密鍵
- G$ : 楕円曲線 `secp256k1` の生成点。
- text{SHA256}$ : `BIP0352/SharedSecret` でタグ付けされたSHA256ハッシュ関数。
- s$ : ECDH共通の秘密
- P$ : ボブへの支払い用の公開鍵/固有アドレス

ボブの静的アドレス（$B$と記す）を使って、ビットコインを送るためのユニークなアドレス$P$を導き出すという、かなり素朴な最初のアプローチを紹介しよう。しかし、この方法は単純すぎるし、修正すべきいくつかの欠陥がある。第一の問題は、この方式ではアリスが同じトランザクション内でボブへの複数のアウトプットを作成できないことである。

### 複数の出力を作成するには？

前節の例では、アリスはボブの一意なアドレス$P$に送る一つの出力を作 成する。同じ入力が選択された場合、アリスがボブのために2つの異なる空白のアドレスを 作成することは不可能である。しかし、アリスがボブへの支払いを幾つかの少額に分けたい、そのため幾つかの UTXOを作りたい、という状況は多くあり得る。したがって、これを実現する方法を見つける必要がある。

これを実現するために、アリスが$P$を導き出すために行う計算を少し修正し、ボブに対して2つの異なるアドレス、すなわち$P_0$と$P_1$を生成できるようにする。

計算を修正して2つの異なるアドレスを得るには、単に結果を修正する整数を加える。したがって、アリスは $0$ を加えて $P_0$ というアドレスを得、 $1$ を加えて $P_1$ というアドレスを得る。この整数を $i$ と呼ぶことにする：

P_i = B + \text{hash}(a \cdot B ‖ } i) ‖cdot G $$ P_i = B + ‖text{hash}(a ‖ } i) ‖cdot G $$ P_i = B

計算過程は前の方法と変わらないが、今回はAliceが$i$に$a \cdot B$を連結してからハッシュを進める。その後、単に$i$を修正してボブに属する新しいアドレスを得る。例えば

P_0 = B + \text{hash}(a \cdot B ‖ } 0) ‖cdot G $$ P_0 = B + ‖text{hash}(a ‖ } 0)

P_1 = B + \text{hash}(a \cdot B \text{ ‖ } 1)

ボブが自分宛のサイレント・ペイメントがないかブロックチェーンをスキャンする場合、まずアドレス$P_0$に対して$i = 0$を使う。もし$P_0$に支払いが見つからなければ、この取引には自分宛のサイレントペイメントが含まれていないと判断し、スキャンを中止する。しかし、$P_0$が有効で、自分宛の支払いがある場合、彼は同じトランザクショ ンの$P_1$を続けて、アリスが2回目の支払いをしたかどうかを確認する。P_1$が無効であることが判明した場合、このトランザクションの検索を止める：

P_0 = B + \text{hash}(b \cdot A \text{ ‖ } 0) ˶$$ G



P_0$が動作しない場合、ボブは直ちに$i = 0$で停止するので、この整数を使用することで、トランザクショ ン・スキャンの段階でボブに追加の操作負荷をほとんど与えない。

Bobは同じ方法で秘密鍵を計算できる：

$$
p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n
$$

$$
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n
$$

![BTC204](assets/fr/237.webp)

*凡例：*。


- B$ : ボブが公開した公開鍵/静的アドレス
- b$ : ボブの秘密鍵
- A$ : トランザクションの入力として使われるアリスのUTXO公開鍵。
- a$ : アリスの秘密鍵
- G$ : 楕円曲線 `secp256k1` の生成点。
- text{SHA256}$ : `BIP0352/SharedSecret` でタグ付けされたSHA256ハッシュ関数。
- s_0$ : 第一共通秘密 ECDH
- s_1$ : 第2のECDH共通秘密
- P_0$ : ボブへの支払い用の最初の公開鍵/一意なアドレス
- P_1$ : 2つ目の公開鍵/Bobへの支払い用一意アドレス

この方法で、私たちは素晴らしいプロトコルを手に入れ始めているが、アドレス再利用の防止を筆頭に、克服すべき課題がまだいくつかある。

### アドレスの再利用を避けるには？

前のセクションで見たように、アリスは自分のUTXOを保護する鍵ペアを使い、ボブとの ECDH共有秘密を計算する。この秘密によって、アリスは一意なアドレス$P_0$を導出できる。しかし、アリスが使った鍵ペア($a$, $A$)は、アリスがこのアドレスを何度か再利用した場合、 複数のUTXOを確保することができる。アリスがボブの静的アドレス$B$に対して、同じ鍵$A$で保護された2つのUTXOを使って2回の支払いを行った場合、ボブはアドレスを再利用することになる。

> *アドレスの再利用は、ユーザーの機密保持の観点から非常に悪い習慣です。その理由を知るために、このトレーニングコースの最初の部分を復習することをお勧めします。
確かに、一意なアドレス$P_0$は$A$と$B$から導出されるので、もしアリスが同じキー$A$で$B$に二回目の支払いをするために二番目のアドレスを導出すると、全く同じアドレス$P_0$になってしまう。このリスクを回避し、サイレント・ペイメント内でのアドレスの再利用を防ぐには、計算を少し修正する必要がある。

私たちが望むのは、Aliceが支払いの入力として消費する各UTXOが、Bob側で一意なアドレスを与えることである。そのため、一意なアドレス$P_0$を計算するときにUTXOへの参照を追加するだけでよい。この参照は単に入力として消費されるUTXOのハッシュとなる：

を入力する。

そして、アリスはこの参照を、固有アドレス$P_0$の計算の入力に加える：



スキャンするとき、Bobも$text{inputHash}$を追加できる。なぜなら、Bobは$text{outpoint}$を推測するためにトランザクションを観察すればよいからである：

P_0 = B + ⅳtext{hash}(ⅳtext{inputHash} b ⅳtext{A

有効な$P_0$を見つけると、対応する$p_0$秘密鍵を計算できる：

$$
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
$$

![BTC204](assets/fr/238.webp)

*凡例：*。


- B$ : ボブが公開した公開鍵/静的アドレス
- b$ : ボブの秘密鍵
- A$ : トランザクションの入力として使われるアリスのUTXO公開鍵。
- a$ : アリスの秘密鍵
- H$ : 入力として使用されるUTXOハッシュ
- G$ : 楕円曲線 `secp256k1` の生成点。
- text{SHA256}$ : `BIP0352/SharedSecret` でタグ付けされたSHA256ハッシュ関数。
- s_0$ : 最初のECDH共通秘密
- P_0$ : ボブへの支払い用の最初の公開鍵/一意なアドレス

今のところ、この計算では、アリスが取引に使う入力は一つであると仮定している。しかし、アリスは複数の入力を使用できるはずである。その結果、ボブ側では、複数の入力を含む各取引について、理論的には各入力について ECDH を計算し、自分に対する支払いが意図されているかどうかを判断しなければならない。この方法は満足できるものではないので、作業負荷を軽減する解決策を見つける必要がある！

### 公開鍵を入力に細工する

この問題を解決するために、Alice側で特定の入力を確保する鍵ペアを使う 代わりに、トランザクションの入力で使われたすべての鍵ペアの合計を使う。この合計が新しい鍵ペアとみなされる。この技法は "Tweaking "として知られている。

例えば、アリスのトランザクションに3つの入力があり、それぞれが異なる鍵ペアで保護されているとしよう：


- a_0$は入力#0を確保するために使われる；
- a_1$は入力#1を確保するために使われる；
- a_2$は入力#2を確保する。

![BTC204](assets/fr/239.webp)

先に説明した方法に従って、アリスは$a_0$, $a_1$, $a_2$の中から一つの鍵ペアを選んでECDH秘密を計算し、ボブの静的アドレス$B$から一つの支払いアドレス$P$を生成しなければならない。しかし、この方法では、ボブは有効な$P$アドレスを生成するペアを特定するまで、 $a_0$から始め、次に$a_1$、...と順次各可能性をテストする必要がある。このプロセスでは、ボブは全トランザクションの全入力に対してECDH計算を実行する必要があり、スキャンの運用負荷が大幅に増加する。

これを避けるために、アリスに全入力鍵の合計を使って $P$を計算するように頼むことにする。この例では、秘密鍵 $a$ を微調整したものを次のように計算する：

a = a_0 + a_1 + a_2 $$.

同じようにして、アリスとボブは調整された公開鍵を計算することができる：

a = a_0 + a_1 + a_2 $$.

この方法では、Bobはトランザクションの公開鍵の合計を計算し、$A$だけからECDH 秘密を計算するだけでよい。

しかし、前のセクションを思い出してほしい。私たちは$text{inputHash}$ハッシュを計算に加えた：

を入力する。

しかし、1つのトランザクションに複数の入力がある場合、この計算でどの $text{outpoint}$を選択するかを決定できるようにする必要がある。BIP352によると、使用する$text{outpoint}$の選択基準は、辞書的に最も小さいものを選択する、つまりアルファベット順で最初に現れるUTXOを選択する。この方法は、各トランザクションで選択されるUTXOを標準化する。例えば、この辞書順で最小の$text{outpoint}$が$text{outpoint}_L$の場合、 $text{inputHash}$の計算は：

$$ \text{inputHash} = \text{hash}(∕text{outpoint}_L∕text{‖ } A) $$ ∕text{outpoint}_L∕text{‖ } A

ただし、秘密鍵$a$とそれに対応する公開鍵$A$は、もはや1つの入力を保護するために使われるペアではなく、入力におけるすべての鍵ペアの微調整を表すようになった。

### 経費キーとスキャンキーを分離

今のところ、Silent Payment静的アドレス$B$を一意な公開鍵と呼ぶ。アリスが共有秘密ECDHを作成するために使用するのはこの公開鍵 $B$である。Bobはこの公開鍵$B$と、対応する秘密鍵$b$をスキャン段階で使用する。また、秘密鍵$b$を使用して、アドレス$P$から支出を可能にする秘密鍵$p$を計算する。

この方法の欠点は、$b$秘密鍵が、サイレント・ペイメン トを受け取ったアドレスのすべての秘密鍵を計算するのに使われ、ボブがトランザクショ ンをスキャンするのにも使われることである。このステップでは、$b$鍵をインターネットに接続されたウォレットソフトウェアで利用できるようにする必要があり、コールドウォレットに保管するよりも盗難のリスクにさらされる。理想的には、サイレント・ペイメントを利用しながら、他のすべての秘密鍵へのアクセスを制御する$b$秘密鍵をハードウェア・ウォレットで安全に保管できることが有益である。幸いなことに、このプロトコルはそれを可能にするように適応されている。

そのために、BIP352は受信機に2つの異なるペアのキーを要求する：


- b_{text{spend}}$：一意の支払いアドレスの秘密鍵を計算する；
- b_{text{scan}}$: ユニークな支払いアドレスを見つける。

このように、ボブは秘密鍵$b_{text{spend}}$をハードウェアウォレットに保持し、秘密鍵$b_{text{scan}}$をオンラインソフトウェアで使用することで、$b_{text{spend}}$を公開せずにサイレントペイメントを見つけることができる。一方、公開鍵$B_{text{scan}}$と$B_{text{spend}}$は、ボブの静的アドレス$B$にあるため、どちらも公開されている：

B = B_{text{scan}}\B_{text{ ‖ }B_{text{spend}}$$

ボブに属するユニークな支払いアドレス$P_0$を計算するために、アリスは次の計算を行う：

P_0 = B_{text{spend}}とする。+ \text{hash}( \text{inputHash} a  \cdot B_{text

自分宛の支払いを見つけるために、ボブは次のような計算をする：

P_0 = B_{text{spend}}とする。

見ての通り、今のところBobはハードウェア・ウォレットにある$b_{text{spend}}$を使う必要がない。P_0$を使いたいときは、以下の計算で秘密鍵$p_0$を求めることができる：

p_0 = (b_{text{spend}})+  \text{hash}(b_{text{scan}}  \cdot b_{text{scan}}  \cdot A ¤̴̶̷̀ω¤̴̶̷́) $$ p_0 = (b_{text{spend}} ¤̴̶̷́)

![BTC204](assets/fr/240.webp)

*凡例：*。


- B_{text{scan}}$：ボブの公開スキャン鍵（静的アドレス）
- b_{text{scan}}$ : ボブのスキャン秘密鍵
- B_{text{spend}}$ : ボブの公開支出鍵（静的アドレス）
- b_{text{spend}}$ : ボブのプライベート支出鍵
- A$ : 公開鍵入力の合計 (微調整)
- a$ : 改変された公開鍵に対応する秘密鍵。
- H$ : 入力として使われた最小のUTXOのハッシュ(辞書順)
- G$ : 楕円曲線 `secp256k1` の生成点。
- text{SHA256}$ : `BIP0352/SharedSecret` でタグ付けされたSHA256ハッシュ関数。
- s_0$ : 第一共通秘密 ECDH
- P_0$ : ボブへの支払い用の最初の公開鍵/一意なアドレス

### SPアドレスをラベルで使用する

したがって、ボブは.NETのようなサイレント・ペイメント用の静的アドレス$B$を持っている：

B = B_{text{scan}}\B_{text{ ‖ }B_{text{spend}}$$

この方法の問題点は、このアドレスに送られる異なる支払いを分離することができないことだ。例えば、ボブのビジネスに2つの異なる顧客がいて、それぞれへの支払いを区別したい場合、2つの異なる静的アドレスが必要になる。現在のアプローチによる素朴な解決策は、ボブが2つの異なるウォレットを作成し、それぞれ独自の静的アドレスを持つか、あるいは同じウォレット内に2つの異なる静的アドレスを確立することである。しかし、この解決策では、各アドレス宛ての支払いをそれぞれ検出するために、ブロックチェーン全体を2回（各アドレスに対して1回）スキャンする必要があります。この二重スキャンはボブの運用負荷を不当に増大させる。

この問題を解決するために、BIP352は、ブロックチェーン上のサイレント・ペイメントを見つける作業負荷を不当に増加させることなく、異なる静的アドレスを許容するラベル・システムを使用している。これを行うために、公開支出鍵$B_{text{spend}}$に整数$m$を追加する。この整数は、最初の静的アドレスには$1$、2番目には$2$というように、値を取ることができる。支出鍵$B_{text{spend}}$を$B_m$と呼び、このように構成する：

B_m = B_{text{spend}}。+  \text{hash}(b_{text{scan}}  \text{ ‖ } m)  \cdot G $$

例えば、ラベルが$1$の最初の経費キーの場合：

B_1 = B_{text{spend}}。+ B_{text{hash}(b_{text{scan}} ￤ 1) ￤ G $$ B_{text{spend

Bobが公開する静的アドレスは、$B_{text{scan}}$と$B_m$で構成される。例えば、ラベル$1$の最初の静的アドレスは：

B = B_{text{scan}}\テキストB_1 $$

> *ラベル0は変更のために予約されているため、ラベル1から始める。
しかし、$B_{text{spend}}$の代わりに新しい$B_1$を使う：



現実には、アリスはボブがラベル付きアドレスを持っていることを必ずしも 知っているわけでもない。

支払いをスキャンするために、ボブは常にこのように$B_{text{spend}}$で初期静的アドレスの値を使用する：

P_0 = B_{text{spend}}とする。

次に、各出力から$P_0$の値を一つずつ引いていく。そして、これらの引き算の結果の1つが、ポートフォリオで使用しているラベルの1つの値と一致するかどうかをチェックする。例えば、出力#4が$1$ラベルと一致した場合、この出力は静的にラベル付けされたアドレス$B_1$に関連するサイレント・ペイメントであることを意味する：

Out_4 - P_0 = \text{hash}(b_{text{scan}} \text{ ‖ } 1)

それがうまくいく理由は......：

B_1 = B_{text{spend}}とする。+ B_{text{hash}(b_{text{scan}} ￤ 1) ￤ G $$ B_{text{spend

この方法のおかげで、ボブは、基本静的アドレス（$B = B_{text{scan}} Ⓐ text{ ‖ } B_{text{spend}}$）から派生した多数の静的アドレス（$B_1$、$B_2$、$B_3$...）を使い分けることができる。

ただし、この静的アドレスの分離は、個人のポートフォリオ管理の観点からのみ有効であり、IDを分離するものではないことに注意してください。これらの静的アドレスはすべて同じ$B_{text{scan}}$を持っているので、すべての静的アドレスを一緒に関連付け、それらが単一のエンティティに属していると推論するのは非常に簡単である。

![BTC204](assets/fr/241.webp)

*凡例：*。


- B_{text{scan}}$：ボブの公開スキャン鍵（静的アドレス）
- b_{text{scan}}$ : ボブのスキャン秘密鍵
- B_{text{spend}}$ : ボブの公開支出鍵（初期アドレス）
- B_m$ : ラベル付きボブの公開鍵（静的アドレス）
- b_m$：ボブの秘密鍵。
- A$ : 公開鍵入力の合計 (微調整)
- a$ : 改変された公開鍵に対応する秘密鍵。
- H$ : 入力として使われた最小のUTXOのハッシュ(辞書順)
- G$ : 楕円曲線 `secp256k1` の生成点。
- text{SHA256}$ : `BIP0352/SharedSecret` でタグ付けされたSHA256ハッシュ関数。
- s_0$ : 最初のECDH共通秘密
- P_0$ : ボブへの支払い用の最初の公開鍵/一意なアドレス
- p_0$ : ボブへの最初のユニークな支払いアドレスの秘密鍵
- X$ : スキャンした秘密鍵のハッシュ。

### サイレント・ペイメントのアドレスを構築するにはどうすればよいですか？

サイレントペイメント専用のアドレスを構築するには、まずビットコインHDのウォレットから2つのキーペアを導き出す必要があります：


- b_{text{scan}}$, $B_{text{scan}}$のペアで、自分宛の支払いを検索する；
- b_{text{spend}}$と$B_{text{spend}}$のペアで、受け取ったビットコインを考える。

これらのペアは、以下のパス（*ビットコインメインネット*）を使用して導き出される：

```text
scan : m / 352' / 0' / 0' / 1' / 0
spend : m / 352' / 0' / 0' / 0' / 0
```

この2つの鍵のペアを手に入れたら、単純に（エンド・ツー・エンドで）連結して静的アドレスのペイロードを作る：

B = B_{text{scan}}\B_{text{ ‖ }B_{text{spend}}$$

ラベルを使う場合は、$B_{text{spend}}$を$B_m$に置き換える：

B = B_{text{scan}}\テキストB_m $$

ラベルを $m$ とする：

B_m = B_{text{spend}}。+  \text{hash}(b_{text{scan}}  \text{ ‖ } m)  \cdot G $$

このペイロードを得たら、HRP（*Human-Readable Part*） `sp`とバージョン`q`（=バージョン0）を追加する。また、チェックサムを追加し、アドレスをbech32mとしてフォーマットする。

例えば、これが私のサイレント・ペイメントの固定アドレスだ：

```text
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```

静的アドレスに関する重要な点は、前のセクションで理解できたかもしれないが、これらのアドレスはビットコイン取引では見えないということである。出力に使用される$P$支払いアドレスのみが、標準的なTaprootフォーマットでブロックチェーン上に表示される。そのため、外部からは、サイレントペイメントを含む取引とP2TR出力を使用する通常の取引とを区別することは不可能です。

BIP47と同様に、静的アドレス$B$と、$B$から派生した支払いアドレス$P$との間の接続を確立することは不可能である。実際、潜在的な攻撃者であるイブがボブの静的アドレス$B$を使ってブロックチェーンをスキャンしようとしても、$P$を決定するために必要な計算を行うことはできない。そのためには、ボブの秘密鍵$b_{text{scan}}$か、送信者の秘密鍵$a$が必要になるが、もちろんどちらも非公開である。したがって、静的アドレスと個人のIDを明示的に結びつけることが可能である。

### サイレント・ペイメントの利用方法を教えてください。

サイレント・ペイメントの提案は比較的最近なされたもので、現時点では非常に限られた数のウォレットによってのみ実装されています。私の知る限り、サイレント・ペイメントをサポートしているソフトウェア製品は3つしかありません：


- [CakeWallet](https://cakewallet.com/)
- [サレンティウム](https://app.silentium.dev/)
- [ドネーションウォレット](https://github.com/Sosthene00/donationwallet)

サイレント・ペイメント静的アドレスの設定方法については、近日中に詳しいチュートリアルをお届けする予定です。

この機能は新しいため、メインネット上で多額のサイレント・ペイメントを使用することは避けてください。

*この「サイレント・ペイメント」の章を作るにあたり、[サイレント・ペイメント解説サイト](https://silentpayments.xyz/)と[BIP352解説資料](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki)を利用した*。

# 最終セクション

<partId>2aee56c0-b285-4799-b4f7-373a552ee2b2</partId>

## レビュー＆評価

<chapterId>195d149f-80fa-5816-8b46-995a9226d082</chapterId>

<isCourseReview>true</isCourseReview>

## 最終試験

<chapterId>e803d394-e3c1-5816-a6b4-a69a2472019c</chapterId>

<isCourseExam>true</isCourseExam>

## 結論

<chapterId>cd8e5c67-50e4-4dcd-8e04-88ba5ec95305</chapterId>

<isCourseConclusion>true</isCourseConclusion>
