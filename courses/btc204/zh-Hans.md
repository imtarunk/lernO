---
name: 比特币隐私
goal: 了解并掌握使用比特币时的隐私保护原则
objectives: 

  - 定义理解隐私问题所需的理论概念
  - 识别并降低与比特币用户失密相关的风险
  - 在比特币上使用保护隐私的方法和工具
  - 了解连锁分析方法并制定防御策略

---
# 在比特币上保护您的隐私

在金融交易的保密性逐渐成为奢侈品的今天，了解和掌握使用比特币时的隐私保护原则至关重要。本培训课程从理论和实践两方面为您提供了自主实现这一目标的全部关键。

如今，在比特币上，有一些公司专门从事区块链分析。他们的核心业务正是侵入你的私人领域，以破坏你交易的保密性。实际上，在比特币中并不存在所谓的 "隐私权"。因此，用户应该维护自己的自然权利，保护自己交易的机密性，因为没有人会替你这么做。

课程的设计既全面又概括。每个技术概念都有详细介绍，并配有解释性图表。目的是让所有人都能掌握这些知识。因此，初学者和中级用户都能负担得起 BTC204。本课程还为经验丰富的比特币使用者提供了附加值，因为我们会深入探讨某些经常被误解的技术概念。

加入我们，改变你对比特币的使用，成为一个知情的用户，能够理解与保密和保护隐私有关的问题。

+++
# 导言

<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## 课程概述

<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

欢迎来到 BTC204 课程！

在金融交易的保密性逐渐成为奢侈品的今天，了解和掌握使用比特币时的隐私保护原则至关重要。本培训课程从理论和实践两方面为您提供了自主实现这一目标的全部关键。

如今，在比特币上，有一些公司专门从事区块链分析。他们的核心业务正是侵入你的私人领域，以破坏你交易的保密性。实际上，在比特币中并不存在所谓的 "隐私权"。因此，用户应该维护自己的自然权利，保护自己交易的机密性，因为没有人会替你这么做。

比特币不仅仅是 "数字上涨 "和储蓄保值。凭借其独特的特性和历史，比特币首先是反经济的工具。有了这个强大的发明，你可以自由支配你的钱，花掉它，积累它，没有任何人可以阻止你。

比特币提供了一种摆脱国家桎梏的和平方式，让你充分享受你的自然权利，而这些权利是既定法律所无法挑战的。多亏了中本聪的发明，你才有能力让自己的私有财产得到尊重，重新获得契约自由。

然而，比特币默认情况下并不是匿名的，这对从事反经济活动的个人来说可能意味着风险，尤其是在专制统治地区。但这并不是唯一的危险。由于比特币是一种有价值且不可计量的资产，它可能成为窃贼的目标。因此，保护个人隐私也是一个安全问题：它可以帮助你防止黑客攻击和人身攻击。

我们将看到，虽然协议本身提供了一定的保密保护，但使用其他工具来优化和保护这种保密性也至关重要。

本培训课程旨在全面概述比特币保密所涉及的问题。每个技术概念都有详细介绍，并配有解释性图表。目的是让每个人，甚至是初学者和中级用户都能了解这些知识。对于经验丰富的比特币使用者，我们也会在整个课程中涉及技术性较强、有时鲜为人知的概念，以加深对每个主题的理解。

本培训课程的目的不是让您在使用比特币时完全匿名，而是为您提供必要的工具，让您知道如何根据个人目标保护自己的机密性。您可以根据自己的具体目标和需求，自由选择所介绍的概念和工具，制定自己的策略。

**第 1 部分：定义和关键概念**

首先，我们要回顾一下比特币运行的基本原理，然后才能静下心来探讨与保密有关的概念。掌握一些基本概念是很有必要的，比如UTXO、接收地址和脚本，然后才能完全理解我们在接下来的章节中要介绍的概念。我们还将介绍中本聪设想的比特币一般保密模式，这将使我们能够掌握相关的利害关系和风险。

![BTC204](assets/fr/001.webp)

**第 2 部分：了解和防范连锁分析**

在第二部分中，我们将介绍区块链分析公司用来追踪你在比特币上的活动的技术。了解这些方法对于加强隐私保护至关重要。本节的目的是研究攻击者的策略，以便更好地了解风险，并为我们在接下来的章节中研究的技术打下基础。我们将分析交易模式、内部和外部启发式方法以及对这些模式的可能解释。除了理论，我们还将通过实际案例和练习，学习如何使用区块资源管理器进行链分析。

![BTC204](assets/fr/002.webp)

**第 3 部分：掌握保护隐私的最佳做法**

在培训课程的第三部分，我们将深入到细节：实践！我们的目标是掌握所有基本的最佳实践，这应该成为任何比特币用户的自然反应。我们将介绍空白地址的使用、标记、合并、完整节点的使用以及 KYC 和获取方法。我们的目的是为你提供一个全面的概览，让你了解应该避免的陷阱，从而为我们保护隐私的努力打下坚实的基础。对于其中的一些做法，我们将为您提供具体的实施教程。

![BTC204](assets/fr/003.webp)

**第 4 节：了解共同连接事务**

说到比特币的隐私，怎么能不提到币合呢？在第 4 部分，你将了解到关于这种混合方法的所有信息。您将了解到什么是币币结合、币币结合的历史和目的，以及现有的不同类型的币币结合。最后，对于更有经验的用户，我们将介绍什么是 "anonsets "和 "熵"，以及如何计算它们。

![BTC204](assets/fr/004.webp)

**第 5 部分：了解其他先进保密技术的挑战**

在第五部分，我们将介绍除了 Coinjoin 之外，比特币上保护隐私的其他技术。多年来，开发者们在设计隐私保护工具方面表现出了非凡的创造力。我们将介绍所有这些方法，如 payjoin、协同交易、币币交换和原子交换，详细说明它们的工作原理、目标和弱点。

我们还将探讨节点网络和交易传播层面的隐私问题。我们还将讨论多年来为提高比特币用户隐私而提出的各种协议，包括静态地址协议。

![BTC204](assets/fr/005.webp)
准备好探索比特币隐私的奥秘了吗？让我们开始吧！

# 定义和关键概念

<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>

## 比特币的UTXO模式

<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>


比特币首先是一种货币，但你真的知道 BTC 在协议中是如何表示的吗？

### 比特币上的UTXOs：它们是什么？

比特币协议基于UTXO模式，即 "未花费交易输出"。

这种模式与传统的银行系统大相径庭，后者依靠账户和余额机制来跟踪资金流动。事实上，在银行系统中，个人余额保存在与身份相关的账户中。例如，当你从面包师那里买了一根法棍，你的银行只需从你的账户中扣除购买金额，从而减少你的余额，而面包师的账户则被记入相同金额的贷方，从而增加其余额。在这个系统中，除了交易记录之外，并不存在进入你账户的钱和离开你账户的钱之间的联系。

![BTC204](assets/fr/006.webp)

比特币的运作方式与此不同。比特币不存在账户的概念，货币单位也不是通过余额管理，而是通过UTXO管理。一个UTXO代表一个特定数量的比特币，这些比特币还没有被花掉，因此形成了一个 "比特币碎片"，可大可小。例如，一个UTXO可能价值 "500 BTC"，也可能只是 "700 SATS"。

**> satoshi（通常缩写为 sat）是比特币的最小单位，相当于法定货币中的一美分。

```plaintext
1 BTC = 100 000 000 SATS
```

从理论上讲，一枚UTXO 可以代表任何比特币价值，从一比特币到理论上最高约 2 100 万比特币不等。然而，从逻辑上讲，不可能拥有全部 2,100 万比特币，而且还有一个较低的经济阈值，称为 "灰尘"，低于这个阈值，UTXO 被认为在经济上无利可图。

**> 比特币有史以来最大的UTXO价值为500,000 BTC。它是 MtGox 平台在 2011 年 11 月的一次整合行动中创建的：[29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXOs 和支出条件

UTXOs是比特币的交换工具。每笔交易都会消耗作为输入的UTXOs，并产生作为输出的新UTXOs。交易完成后，作为输入的UTXO被视为 "消耗"，新的UTXO被生成并分配给交易输出中指定的接收者。因此，UTXO 只代表未用完的交易输出，也就是在特定时间属于某个用户的比特币数量。

![BTC204](assets/fr/007.webp)

所有UTXO都由脚本保护，脚本规定了使用UTXO的条件。要使用UTXO，用户必须向网络证明他或她满足了保护该UTXO的脚本所规定的条件。通常情况下，UTXO 受公共密钥（或代表该公共密钥的接收地址）的保护。要使用与该公开密钥相关联的UTXO，用户必须通过提供用该密钥制作的数字签名，证明自己持有相应的私人密钥。这就是为什么我们说你的比特币钱包实际上并不包含比特币，而是存储着你的私钥，而私钥又能让你访问你的UTXO，进而访问它们所代表的比特币。

![BTC204](assets/fr/008.webp)

由于比特币中没有账户的概念，钱包的余额就是它可以使用的所有 UTXOs 的价值总和。例如，如果你的比特币钱包可以使用以下 4 个 UTXOs：

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

您的投资组合总余额为 17 BTC。

![BTC204](assets/fr/009.webp)

## 比特币交易的结构

<chapterId>29d3aaab-de2e-4746-ab40-c9748898850c</chapterId>


### 交易输入和输出

比特币交易是在区块链上记录的将比特币所有权从一个人转移到另一个人的操作。更确切地说，由于我们采用的是UTXO模式，没有账户，交易满足了确保一个或多个UTXO的消费条件，消耗了这些UTXO，并等同于创建了具有新消费条件的新UTXO。简而言之，一笔交易将比特币从一个已满足条件的脚本转移到一个新的脚本，新脚本的目的是确保比特币的安全。

![BTC204](assets/fr/010.webp)

因此，每个比特币交易由一个或多个输入和一个或多个输出组成。输入是交易产生输出所消耗的UTXO。输出是新的UTXO，可用作未来交易的输入。

![BTC204](assets/fr/011.webp)

**> 理论上，比特币交易可以有无限多的输入和输出。唯一的限制是最大区块大小。

比特币交易中的每一笔输入都是指之前未花费的UTXO。要使用一个UTXO作为输入，其持有者必须通过验证相关脚本，即满足规定的支出条件，来证明他/她是合法所有者。一般来说，这意味着提供一个数字签名，该数字签名是用私钥制作的，而私钥与最初确保该UTXO安全的公钥相对应。因此，脚本包括验证该签名是否与收到资金时使用的公用钥匙一致。

![BTC204](assets/fr/012.webp)

每次输出都会指定要转移的比特币数量和接收方。后者由一个新脚本定义，该脚本通常会用接收地址或新的公钥阻止新创建的 UTXO。

根据共识规则，总输出必须小于或等于总输入，交易才能被视为有效。换句话说，交易产生的新 UTXOs 总和不得超过作为输入消耗的 UTXOs 总和。这一原则是合乎逻辑的：如果你只有`500,000 SATS`，你就不能购买`700,000 SATS`。

### 比特币交易中的交换与合并

因此，比特币交易对UTXO的作用可以比作重铸一枚金币。事实上，UTXO 是不可分割的，只能熔化。这意味着用户不能简单地将一个代表一定比特币数额的UTXO分割成几个较小的UTXO。他必须在交易中将其全部消耗掉，以创建一个或多个新的任意输出值的UTXO，这些输出值必须小于或等于初始值。

这种机制与金币类似。假设你拥有一枚 2 盎司的金币，想支付 1 盎司的货款，前提是卖方不能找零。您必须熔化您的金币，然后铸造 2 枚每枚 1 盎司的新金币。

比特币的运作方式与此类似。假设爱丽丝有一个 `10,000 SATS` 的UTXO，她想买一个 `4,000 SATS` 的法棍。爱丽丝将以 1 个 `10,000 SATS` 的UTXO 作为输入（她将全额消费），以 2 个 `4,000 SATS` 和 `6,000 SATS` 的UTXO 作为输出进行交易。4,000 SATS` 的UTXO 将被送到面包师那里，作为购买长棍面包的付款，而 6,000 SATS` 的UTXO 将以零钱的形式返回爱丽丝。在比特币术语中，这种返回到交易原始发行者的UTXO被称为 "交换"。

![BTC204](assets/fr/013.webp)

现在让我们设想一下，爱丽丝并没有一个 "10,000 SATS "的UTXO，而是有两个 "3,000 SATS "的UTXO。在这种情况下，任何一个UTXO都不足以单独设置魔杖的 "4,000 SATS"。因此，爱丽丝必须同时使用 2 个 `3,000 SATS` 的UTXO 作为交易输入。这样，投入的总金额将达到 6000 SATS，从而使她能够满足支付给面包师的 4000 SATS。这种将多个UTXO组合在一起作为交易投入的方法通常被称为 "合并"。

![BTC204](assets/fr/014.webp)

### 交易费

直觉上，人们可能认为交易成本也代表交易的产出。但实际上并非如此。交易成本代表总投入与总产出之间的差额。这意味着，在一项交易中，在使用部分投入价值来支付预期产出之后，仍有一定的投入总和没有使用。这个剩余部分就是交易成本。

```plaintext
Frais = total inputs - total outputs
```

以爱丽丝为例，她的UTXO为`10,000 SATS`，她想以`4,000 SATS`的价格买一根法棍。爱丽丝以她的UTXO`10,000 SATS`为输入创建了一个交易。然后，她生成一个 `4,000 SATS` 的输出，用于支付面包师购买长棍面包的费用。为了鼓励矿工将她的交易整合到一个区块中，爱丽丝分配了 `200 SATS` 作为费用。然后，她创建了第二个输出，即交换，将返回给她`5,800 SATS`。

![BTC204](assets/fr/015.webp)

根据费用计算公式，我们可以看出未成年人确实还剩`200 SATS`：

```plaintext
Frais = total inputs - total outputs
Frais = 10 000 - (4 000 + 5 800)
Frais = 10 000 - 9 800
Frais = 200
```

当矿工成功验证一个区块后，他就有权通过所谓的 "coinbase "交易，为其区块中包含的所有交易收取这些费用。

### 在比特币上创建UTXOs

如果你仔细阅读了前面的段落，你就会知道，UTXO 只能通过消耗其他现有的 UTXO 来创建。这样，比特币就形成了一条连续的链。不过，你可能想知道，这条链上的第一个UTXO是如何产生的。这就产生了一个类似于鸡和蛋的问题：这些最初的UTXO从何而来？

答案就在**交易币库**中。

代币库是比特币交易的一种特殊类型，在每个区块中都是独一无二的，而且总是第一个区块。它允许找到有效工作证明的矿工获得区块奖励。这种奖励由两个元素组成： **区块奖励**和**交易费**，在上一节中已经讨论过。

Coinbase 交易的独特之处在于，它是唯一能够 "凭空 "创造比特币的交易，无需消耗输入来产生输出。这些新创建的比特币我们可以称之为 "原始 UTXOs"。

![BTC204](assets/fr/016.webp)

区块补助比特币是根据共识规则中预先确定的发行时间表从零开始创建的新 BTC。区块补贴每 21 万个区块减半，即大约每四年减半一次，这个过程被称为 "减半"。最初，每次补贴会产生 50 个比特币，但这一数量逐渐减少；目前，每个区块的补贴为 3.125 个比特币。

至于交易费，虽然它们也代表新创建的 BTC，但不得超过一个区块中所有交易的总投入和总产出之间的差额。我们在前面已经看到，这些费用代表的是没有用于交易输出的那部分输入。从技术上讲，这部分在交易过程中 "损失 "了，矿工有权以一个或多个新的 UTXO 的形式重新创造这部分价值。这是交易发行者和将其添加到区块链的矿工之间的价值转移。

**> Coinbase 交易产生的比特币有 100 个区块的成熟期，在此期间，矿工不能使用这些比特币。这一规则旨在避免在链上使用新产生的比特币所带来的复杂性，因为这些新产生的比特币日后可能会被淘汰。

### UTXO模型的影响

首先，UTXO 模式直接影响比特币的交易费用。由于每个区块的容量都是有限的，矿工们倾向于选择与区块所占空间相对应的费用最高的交易。事实上，一个交易的输入和输出中包含的UTXO越多，它就越重，因此需要更高的费用。这也是我们经常试图减少投资组合中 UTXO 数量的原因之一，这也会影响保密性，我们将在本课程的第三部分详细讨论这个问题。

其次，如前文所述，比特币本质上是一条UTXO 链。因此，每一笔交易都在过去的UTXO和未来的UTXO之间建立了联系。因此，UTXO 可以明确地跟踪比特币从产生到当前支出的过程。这种透明度是积极的，因为它使每个用户都能确定收到的比特币的真实性。然而，区块链分析也正是基于这种可追溯性和可审计性原则，这种做法旨在损害您的保密性。我们将在课程的第二部分深入探讨这种做法。

## 比特币的隐私模式

<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>


### 金钱：真实性、诚信和双重消费

货币的功能之一就是解决需求的双重重合问题。在一个以物易物的体系中，要完成一次交换，不仅需要找到一个人赠送与我的需求相对应的物品，还需要向他提供满足他自己需求的等值物品。取得这种平衡是一个复杂的问题。

![BTC204](assets/fr/017.webp)

这就是为什么我们用货币在空间和时间上移动价值。

![BTC204](assets/fr/018.webp)

硬币要解决这个问题，就必须让提供商品或服务的一方相信自己有能力在日后花掉这笔钱。因此，任何希望接受硬币（无论是数字硬币还是实物硬币）的理性个体都会确保硬币符合两个基本标准：


- 作品必须具有完整性和真实性；**
- 不得重复使用。

如果您使用的是实物货币，那么第一个特征是最复杂的。在不同的历史时期，金属硬币的完整性往往会受到修剪或穿孔等做法的影响。例如，在古罗马，市民们通常会刮掉金币的边缘，以收集一点贵金属，同时保存起来以备将来交易之用。这样，金币的内在价值就降低了，但其面值却保持不变。这也是后来金币边缘出现凹槽的原因之一。

在实物货币媒介上，真实性也是一个难以验证的特征。如今，打击假币的技术越来越复杂，迫使零售商投资昂贵的验证系统。

另一方面，由于实物货币的性质，重复消费对实物货币来说不是问题。如果我给你一张 10 欧元的钞票，它就不可逆转地离开了我，进入了你的手中，这自然就排除了重复消费它所包含的货币单位的可能性。简而言之，我将无法再次使用这张 10 欧元的钞票。

![BTC204](assets/fr/019.webp)

数字货币的难度则不同。确保一个币的真实性和完整性通常比较简单。正如我们在上一节中看到的，比特币的UTXO模式使得追溯一个币的来源成为可能，从而验证它确实是由矿工按照共识规则创建的。

另一方面，确保没有重复消费则更为复杂，因为所有数字商品的本质都是信息。与实物商品不同，信息在交换时不会被分割，而是通过倍增的方式传播。例如，如果我通过电子邮件发送给你一份文件，它就会被复制。你无法确定我是否删除了原始文件。

![BTC204](assets/fr/020.webp)

### 防止比特币重复消费

避免数字资产重复的唯一方法就是了解系统中的所有交易所。这样，我们就能知道谁拥有什么，并根据所进行的交易更新每个人的持有量。例如，银行系统中的经文货币就是如此。当您用信用卡向商家支付 10 欧元时，银行会记录这笔交易并更新账簿。

![BTC204](assets/fr/021.webp)

在比特币上，防止重复消费的方法是相同的。我们要确认的是，不存在已经使用过相关硬币的交易。如果这些币从未被使用过，那么我们就可以确定不会发生重复消费。中本聪在白皮书中用一句名言描述了这一原则：

**确认没有交易的唯一方法是了解所有交易

但与银行模式不同的是，我们不希望在比特币上信任一个中心实体。因此，所有用户都需要能够确认没有重复消费，而不依赖第三方。因此，每个人都需要了解所有的比特币交易。这就是为什么比特币交易会在所有网络节点上公开广播，并以明文记录在区块链上。

正是这种信息的公开传播使比特币的隐私保护变得更加复杂。在传统的银行系统中，理论上只有金融机构知道所进行的交易。而在比特币中，所有用户都可以通过各自的节点获知所有交易。

### 保密模式：银行系统与比特币

在传统系统中，您的银行账户与您的身份相关联。银行家能够知道哪个银行账户属于哪个客户，以及与之相关的交易。然而，银行与公共领域之间的信息流被切断了。换句话说，不可能知道属于另一个人的银行账户的余额和交易情况。只有银行才能获得这些信息。

![BTC204](assets/fr/022.webp)

例如，你的银行家知道你每天早上从当地面包师那里购买法棍，但你的邻居却不知道这笔交易。通过这种方式，有关各方，尤其是银行，可以获得信息流，但外人却无法获得。

![BTC204](assets/fr/023.webp)

由于我们在上一节中看到的交易公开传播的限制，比特币的保密模式不能沿用银行系统的模式。就比特币而言，由于交易和公共领域之间的信息流无法切断，**隐私模式依赖于用户身份和交易**本身之间的分离。

![BTC204](assets/fr/024.webp)

例如，如果您从面包店买了一根法棍，并用 BTC 支付，您的邻居（他有自己的完整节点）可以看到您的交易，就像他可以看到系统中的所有其他交易一样。不过，如果遵守保密原则，他应该无法将这笔特定交易与您的身份联系起来。

![BTC204](assets/fr/025.webp)

但是，由于比特币交易是公开的，因此仍有可能在它们之间建立联系，从而推断出有关各方的信息。这项活动甚至本身就是一门专业，被称为 "区块链分析"。在课程的下一部分，我将邀请您探索区块链分析的基本原理，从而了解比特币是如何被追踪的，并更好地抵御它们。

# 了解并防范连锁分析

<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## 什么是比特币链分析？

<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>


### 定义和操作

区块链分析是追踪区块链上比特币流向的一种做法。一般来说，区块链分析是基于对之前交易样本特征的观察。然后，它包括在我们希望分析的交易中识别这些相同的特征，并从中推导出合理的解释。这种基于实际方法寻找足够好的解决方案的问题解决方法被称为 "启发式"。

通俗地说，产业链分析主要分为三个阶段：

1. **观察区块链；**

2. **识别已知特征；**

3. **假设的推导 **

![BTC204](assets/fr/026.webp)

任何人都可以进行区块链分析。你只需要通过一个完整的节点访问区块链的公共信息，观察交易动向并提出假设。也有一些免费工具可以促进这种分析，比如 [OXT.me](https://oxt.me/)，我们将在本节的最后两章详细探讨。不过，保密性的主要风险来自专门从事字符串分析的公司。这些公司已将区块链分析推向工业化规模，并向金融机构和政府出售服务。在这些公司中，Chainalysis无疑是最知名的。

### 产业链分析目标

区块链分析的目的之一是将比特币上的各种活动归类，以确定进行这些活动的用户的唯一性。随后，就可以尝试将这组活动与真实身份联系起来。

![BTC204](assets/fr/027.webp)

回想上一章。我解释过为什么比特币的隐私模式最初是基于用户身份与交易的分离。因此，我们很容易认为区块链分析毫无用处，因为即使我们设法汇总了链上活动，也无法将其与真实身份联系起来。

从理论上讲，这种说法是正确的。在本课程的第一部分，我们看到加密密钥对用于建立UTXO的条件。从本质上讲，这些密钥对不会泄露其持有者的身份信息。因此，即使我们设法将与不同密钥对相关的活动归为一组，也无法了解这些活动背后的实体。

![BTC204](assets/fr/028.webp)

然而，实际情况要复杂得多。有许多行为可以将真实身份与链上活动联系起来。在分析中，这被称为切入点，而切入点有很多。

最常见的是 KYC（*了解你的客户*）。如果你将比特币从一个受监管的平台提取到你的一个个人接收地址，那么有些人就能将你的身份与该地址联系起来。更广泛地说，切入点可以是你的现实生活和比特币交易之间的任何形式的互动。例如，如果你在社交网络上公布了一个收款地址，这就可以成为分析的切入点。如果你用比特币向你的面包师付款，他就能把你的脸（你身份的一部分）和比特币地址联系起来。

在使用比特币时，这些入口几乎是不可避免的。虽然我们可以设法限制其范围，但它们始终存在。这就是为什么将保护隐私的方法结合起来至关重要。虽然将真实身份和交易分开是一种有趣的方法，但在今天仍然是不够的。事实上，如果您的所有链上活动都可以归为一组，那么即使是最小的切入点也有可能破坏您所建立的单一保密层。

![BTC204](assets/fr/029.webp)

### 防范连锁分析

因此，我们在使用比特币时还需要能够应对区块链分析。通过这样做，我们可以最大限度地减少我们活动的聚合，并限制切入点对我们隐私的影响。

![BTC204](assets/fr/030.webp)

还有什么比了解区块链分析中使用的方法更好的呢？如果你想知道如何提高你在比特币上的隐私，你需要了解这些方法。这将使你更好地掌握 coinjoin 或 payjoin 等技术（我们将在课程的最后部分介绍这些技术），并减少你可能犯的错误。

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef

https://planb.network/tutorials/privacy/on-chain/payjoin-848b6a23-deb2-4c5f-a27e-93e2f842140f

在这一点上，我们可以用密码学和密码分析来类比。一名优秀的密码学家首先是一名优秀的密码分析师。要设计一种新的加密算法，你需要知道它将面临哪些攻击，还要研究以前的算法被破解的原因。同样的原则也适用于比特币隐私。了解区块链分析方法是防范这些攻击的关键。这就是为什么我在本培训课程中加入了一整节关于链分析的内容。

### 链分析方法

要知道，弦分析并不是一门精确的科学。它依赖于从以往观察或逻辑解释中得出的启发式方法。这些规则使我们能够获得相当可靠的结果，但绝不会绝对精确。换句话说，**弦分析得出的结论总是包含一定的概率维度**。例如，我们可以在不同程度上确定两个地址属于同一个实体，但总是无法完全确定。

链式分析的全部意义恰恰在于汇集各种启发式方法，将出错的风险降到最低。从某种程度上说，它是一种证据的积累，让我们更接近现实。

这些著名的启发式方法可以分为不同的类别，我们将在下文中详细介绍：


- 交易模式；**
- 交易内部启发式方法 ;**
- 交易之外的启发式**

### 中本聪与链分析

前两种链分析启发式方法是中本聪自己发现的。他在《比特币白皮书》的第 10 部分中谈到了它们。它们是


- cIOH（*通用输入所有权启发式*）；
- 和地址重复使用。

![BTC204](assets/fr/031.webp)

资料来源S. Nakamoto，《比特币：点对点电子现金系统》，https://bitcoin.org/bitcoin.pdf，2009 年。

我们将在接下来的章节中了解它们是什么，但这两种启发式方法在今天的连锁分析中仍然占据着主导地位，这一点已经很有趣了。

## 交易模式

<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>


交易模式是典型交易的整体模型或结构，可以在区块链上找到，其可能的解释也是已知的。在研究模式时，我们将重点放在单个交易上，并对其进行高层次分析。

换句话说，我们只看输入中的UTXO数量和输出中的UTXO数量，而不纠缠于交易的具体细节或环境。根据观察到的模式，我们可以解释交易的性质。然后，我们将寻找其结构的特点，并推导出一种解释。

![BTC204](assets/fr/032.webp)

在本节中，我们将一起探讨链分析中遇到的主要交易模式，对于每种模式，我都会给出这种结构的可能解释，并举一个具体的例子。

### 单次发货（或单次付款）

让我们从一个非常常见的模式开始，因为它是大多数比特币支付中出现的模式。这种简单支付模式的特点是：消费一个或多个 UTXO 作为输入，生产 2 个 UTXO 作为输出。因此，这种模式是这样的

![BTC204](assets/fr/033.webp)

当我们在区块链上发现这种交易结构时，我们已经可以得出一种解释。顾名思义，这种模式表明我们正在进行发送或支付交易。用户在输入时消耗了自己的UTXO，在输出时满足了支付UTXO和交换UTXO（钱返回给同一个用户）。

因此我们知道，被观测的用户可能不再拥有两个输出UTXO（支付UTXO）中的一个，但仍然拥有另一个UTXO（交换UTXO）。

目前，我们还不能明确指出哪个输出代表哪个 UTXO，因为这不是模式研究的目的。我们将在接下来的章节中研究启发式方法。在现阶段，我们的目标仅限于确定相关事务的性质，在本例中就是简单的发送。

例如，下面是一个采用简单发送模式的比特币交易：

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/fr/034.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

看完第一个例子，你应该对研究 "交易模型 "的含义有了更好的理解。我们研究交易时只关注其结构，而不考虑其环境或交易的具体细节。在这第一步中，我们只着眼于全局。

既然你已经了解了什么是模式，那么让我们来看看其他现有的模式。

### 清扫

第二种模式的特点是将消耗单个 UTXO 作为输入，将生产单个 UTXO 作为输出。

![BTC204](assets/fr/035.webp)

对这种模式的解释是，我们正处于自我转移的过程中。用户将自己的比特币转移到属于自己的另一个地址。由于交易中没有交换，因此我们不太可能看到支付。事实上，在付款时，付款人几乎不可能拥有与卖方所需的金额完全对应的UTXO，再加上交易费。因此，一般来说，付款人有义务产生交换输出。

这样我们就知道，被观察到的用户很可能还持有这个UTXO。在链式分析中，如果我们知道作为交易输入的UTXO属于爱丽丝，我们就可以假设作为输出的UTXO也属于她。以后有趣的是找到交易内部的启发式方法来加强这一假设（我们将在第 3.3 章中讨论这些启发式方法）。

例如，下面是一笔采用扫码模式的比特币交易：

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/fr/036.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d)

但要注意的是，这种模式也可能揭示了向加密货币交易平台账户的自我转账。通过对已知地址和交易背景的研究，我们就能知道这到底是向自我保管的钱包刷卡，还是向平台取款。事实上，交易所平台的地址通常很容易识别。

让我们再以 Alice 为例：如果扫描结果指向一个平台（例如 Binance）已知的地址，这可能意味着比特币已从 Alice 直接持有的钱包中转移出去，其目的可能是将比特币出售或存储在该平台上。另一方面，如果目标地址未知，则可以合理地认为这只是另一个仍属于 Alice 的钱包。但这类研究更多属于启发式而非模式。

### 合并

这种模式的特点是，输入端消耗多个UTXO，输出端产生一个UTXO。

![BTC204](assets/fr/037.webp)

对这种模式的解释是，我们正处于合并阶段。这是比特币用户的一种常见做法，目的是合并几个UTXO，以应对可能出现的交易费用上涨。在费用较低的时期进行这种操作，可以节省未来的费用。我们将在第 4.3 章详细介绍这种做法。

我们可以推断出，这个事务模型背后的用户很可能拥有输入中的所有UTXO，并且仍然拥有输出中的UTXO。因此，这很可能是一次自动转移。

与扫码一样，这种模式也可以揭示向交易所平台账户的自我转账。通过对已知地址和交易背景的研究，我们就能知道这是向自我托管的投资组合合并，还是向平台提款。

例如，下面是一笔采用盘整模式的比特币交易：

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/fr/038.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)

在链式分析中，这个模型可以揭示大量信息。例如，如果我们知道其中一个输入属于爱丽丝，那么我们就可以假设该交易的所有其他输入和输出也属于她。根据这一假设，我们就可以顺着之前的交易链发现并分析可能与爱丽丝有关的其他交易。

![BTC204](assets/fr/039.webp)

### 分组支出

这种模式的特点是，消耗少量UTXO 作为输入（通常只有一个），生产许多UTXO 作为输出。

![BTC204](assets/fr/040.webp)

对这一模型的解释是，我们正处于分组消费的环境中。这种做法很可能揭示了一种非常大的经济活动，如交换平台。分组消费使这些实体能够通过在单笔交易中合并支出来节约成本。

我们可以从这个模型中推断出，输入的 UTXO 来自一家经济活动频繁的公司，而输出的 UTXO 则会分散。许多UTXO属于从平台上提取比特币的公司客户。其他的可能会流向合作公司。最后，肯定会有一个或多个交易所回到发行公司。

例如，下面是一笔采用捆绑消费模式的比特币交易（据推测，这是一笔由 Bybit 平台发行的交易）：

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/fr/041.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### 特定协议交易

在交易模式中，我们还可以识别出那些显示使用了特定协议的模式。例如，漩涡币合并（第 5 部分将讨论）将具有一种易于识别的结构，使其有别于其他更常规的交易。

![BTC204](assets/fr/042.webp)

对这种模式的分析表明，我们很可能正在进行合作交易。也有可能观察到的是共同加入。如果后一种假设被证明是正确的，那么退出的次数就可以让我们大致估计出共同加入的参与者人数。

例如，下面是一个采用 coinjoin 协作交易模式的比特币交易：

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/fr/043.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

还有许多其他协议都有自己的特定结构。例如，有 Wabisabi 交易、Stamps 交易和 Runes 交易。

有了这些交易模式，我们就可以解读特定交易的某些信息。但是，交易结构并不是唯一的分析信息来源。我们还可以研究其细节。这些内部细节我称之为 "内部启发法"，我们将在下一章研究它们。

## 内部启发式方法

<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>


内部启发式是我们在交易本身中识别出的特定特征，无需对其环境进行检查，就能进行推理。与模式不同，内部启发式关注的是事务的整体结构，而模式则是基于可提取的数据集。这包括


- 各种UTXO 的进出量；
- 与脚本有关的一切：接收地址、版本、锁定时间......

一般来说，这种启发式方法能让我们识别特定交易中的交换。这样，我们就可以在多个不同的交易中持续追踪一个实体。事实上，如果我们确定一个UTXO 属于我们要追踪的用户，那么当他进行交易时，就必须确定哪些输出已转移给另一个用户，哪些输出代表交易所，因而仍由他拥有。

![BTC204](assets/fr/044.webp)

请允许我再次提醒大家，这些启发式方法并不是绝对精确的。单独来看，它们只能让我们识别可能发生的情况。几种启发式方法的积累有助于减少不确定性，但却无法完全消除不确定性。

### 内部相似性

这种启发式方法是研究同一笔交易的输入和输出之间的相似性。如果在交易的输入和输出中的一个输入上发现了相同的特征，那么这个输出就很可能构成了交换。

最明显的特征是在同一交易中重复使用接收地址。

![BTC204](assets/fr/045.webp)

这种启发式方法几乎没有可疑之处。除非他的私钥被黑客破解，否则相同的接收地址必然会显示单个用户的活动。由此得出的解释是，交易交换的输出地址与输入地址相同。这样，我们就可以从这个交易交换继续追踪个人。

举例来说，这里有一笔交易，或许可以采用这种启发式：

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/fr/046.webp)

Source : [Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

输入和输出之间的这些相似性并不仅限于地址重用。脚本使用的任何相似性都可以用来应用启发式。例如，我们有时可以观察到输入和其中一个事务输出之间的相同版本。

![BTC204](assets/fr/047.webp)

在该图中，我们可以看到输入 n° 0 解锁了一个 P2WPKH 脚本（以 `bc1q` 开头的 SegWit V0）。输出 n° 0 使用相同类型的脚本。另一方面，输出 n° 1 使用的是 P2TR 脚本（以 `bc1p` 开头的 SegWit V1）。对这一特征的解释是，与输入具有相同版本的地址很可能是交换地址。因此，它将始终属于同一个用户。

下面是一笔交易，或许可以采用这种启发式方法：

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/fr/048.webp)

Source : [Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)

在后者中，我们可以看到输入编号 0 和输出编号 1 使用的是 P2WPKH 脚本（SegWit V0），而输出编号 0 使用的是另一种 P2PKH 脚本（Legacy）。

在 2010 年代初，由于可用脚本类型有限，这种基于脚本版本的启发式方法相对来说并不实用。然而，随着时间的推移和比特币的不断更新，脚本类型也越来越多样化。因此，这种启发式方法变得越来越重要，因为随着脚本类型的增多，用户会分成更小的群体，从而增加了应用这种内部版本重用启发式方法的机会。因此，仅从保密的角度来看，建议选择最常见的脚本类型。例如，在我写这几行字的时候，Taproot 脚本（`bc1p`）的使用频率低于 SegWit V0 脚本（`bc1q`）。虽然前者在某些特定情况下具有经济和保密优势，但对于更传统的单一签名用途，出于保密考虑，在新标准被更广泛地采用之前，坚持使用旧标准可能更有意义。

### 整数付款

另一个可以帮助我们识别交换的内部启发式是整数启发式。一般来说，面对简单的支付模式（1 个输入和 2 个输出），如果其中一个输出花费了整数，那么这就是支付。

![BTC204](assets/fr/049.webp)

根据排除法，如果一个输出代表支付，另一个则代表交换。因此，可以认为输入用户可能始终拥有被确定为交换的输出。

需要强调的是，这种启发式并不总是适用，因为大多数支付仍然是以信托记账单位进行的。事实上，当法国的零售商接受比特币时，一般不会以萨特为单位显示稳定的价格。相反，他会选择将欧元价格与比特币支付金额进行换算。因此，交易结束时不会出现整数。

不过，分析员可以根据交易在网络上广播时的汇率来进行换算。让我们举一个例子：一笔交易的输入为 97,552 萨特，输出为 31,085 萨特和 64,152 萨特。乍一看，这笔交易似乎不涉及整数。然而，按照交易时 64 339 欧元的汇率，我们可以将其换算成欧元如下：


- 投入 62.76 欧元；
- 产出为 20 欧元；
- 产出为 41.27 欧元。

一旦转换成法定货币，这笔交易就可以用来应用整数付款启发式。20 欧元的输出很可能被商家拿走了，或者至少改变了所有权。由此推断，41.27 欧元的输出可能仍为原用户所有。

![BTC204](assets/fr/050.webp)

如果有一天，比特币成为我们交易所的首选记账单位，那么这种启发式的分析方法就会变得更加有用。

例如，这里有一笔交易，或许就可以采用这种启发式：

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/fr/051.webp)

Source : [Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)

### 最大的产出

当我们在一个简单的支付模型上确定两个交易产出之间存在足够大的差距时，我们就可以估计最大的产出可能是外汇。

![BTC204](assets/fr/052.webp)

这种最大输出启发式无疑是最不精确的。就其本身而言，它非常薄弱。不过，这一特点可以与其他启发式相结合，以减少我们解释的不确定性。

例如，如果我们正在研究一笔有整数付款和大额付款的交易，那么同时应用整数付款启发式和大额付款启发式就会降低我们的不确定性水平。

举例来说，这里有一笔交易，或许可以采用这种启发式：

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/fr/053.webp)

Source : [Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## 外部启发式方法

<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>


研究外部启发法意味着分析某些非交易本身特有元素的相似性、模式和特征。换句话说，以前我们只局限于利用内部启发式分析交易的固有因素，而现在我们则借助外部启发式分析，将分析范围扩大到交易环境。

### 地址重用

这是比特币玩家最著名的启发式方法之一。地址重复使用可以在不同的交易和不同的UTXO之间建立联系。当一个比特币接收地址被多次使用时，就会出现这种情况。

因此，可以利用同一交易中的地址重用作为内部启发式来识别交换（如上一章所述）。不过，地址重用也可以作为一种外部启发式来识别多个交易背后的实体的唯一性。

对地址重复使用的解释是，在该地址上被拦截的所有UTXO都属于（或曾经属于）同一个实体。这种启发式方法几乎不存在不确定性。一旦确定，由此产生的解释很可能与现实相符。因此，它可以对不同的链上活动进行分组。

![BTC204](assets/fr/054.webp)

正如第 3 部分导言中所解释的，这种启发式是中本聪自己发现的。在《白皮书》中，他提到了一个帮助用户避免产生这种现象的解决方案，那就是在每笔新交易中使用一个空白地址：

"作为额外的防火墙，可以为每笔交易使用新的密钥对，使它们与共同的所有者没有关联。

![BTC204](assets/fr/055.webp)

资料来源S. Nakamoto，《比特币：点对点电子现金系统》，https://bitcoin.org/bitcoin.pdf，2009 年。

例如，这里有一个在多个交易中重复使用的地址：

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/056.webp)

来源 : [Mempool.space](https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### 脚本相似性和钱包印记

除地址重用外，还有许多其他启发式方法可以将操作链接到相同的组合或地址集群。

首先，分析人员可以查找脚本使用的相似性。例如，某些少数脚本（如 multisig）可能比 SegWit V0 脚本更容易被发现。我们藏身的群体越大，就越难被发现。这也是为什么在优秀的 Coinjoin 协议中，所有参与者都使用完全相同类型脚本的原因之一。

更广泛地说，分析师还可以关注投资组合的特征指纹。这些都是特定用途的过程，可以将其作为追踪启发式方法加以利用。换句话说，如果我们观察到归属于被追踪实体的交易中积累了相同的内部特征，我们就可以尝试在其他交易中识别这些相同的特征。

例如，我们可以发现被跟踪的用户系统性地向 P2TR 地址（"bc1p..."）发送更改。如果这一过程重复出现，我们就可以将其作为启发式方法进行其余分析。我们还可以使用其他指纹，如 UTXO 的顺序、变更在输出中的位置、RBF（Replace-by-Fee）信令或版本号、"nSequence "字段和 "nLockTime "字段。

![BTC204](assets/fr/057.webp)

正如[@LaurentMT](https://twitter.com/LaurentMT)在[Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji)（法文播客）中指出的那样，随着时间的推移，投资组合指纹在链分析中的作用正在显著增加。事实上，脚本类型的不断增加以及投资组合软件对这些新功能的逐步应用，都凸显了两者之间的差异。在某些情况下，甚至可以准确识别被跟踪实体所使用的软件。因此，必须认识到，对投资组合足迹的研究尤其适用于近期的交易，而不是 2010 年代初启动的交易。

总之，"足迹 "可以是钱包自动或用户手动执行的任何特定操作，我们可以在其他交易中找到这些 "足迹"，以帮助我们进行分析。

### 共同投入所有权启发式（CIOH）

共同输入所有权启发式（CIOH）是一种启发式，它认为当一项交易有多个输入时，它们都可能来自一个实体。因此，它们的所有权是共同的。

![BTC204](assets/fr/058.webp)

要应用 CIOH，我们首先要观察一笔有多个输入的交易。这可能是 2 个输入，也可能是 30 个输入。一旦确定了这一特征，我们就要检查该交易是否符合已知的交易模型。例如，如果有 5 个金额大致相同的输入和 5 个金额完全相同的输出，我们就会知道这是一个硬币连接的结构。我们将无法应用 CIOH。

![BTC204](assets/fr/059.webp)

另一方面，如果事务不符合任何已知的协作事务模型，那么我们可以解释为所有输入都可能来自同一个实体。这对于扩展已知群集或继续追踪非常有用。

![BTC204](assets/fr/060.webp)

中本聪发现了 CIOH。他在《白皮书》第 10 部分中谈到了这一点：

"_[......]对于多条目交易，链接是不可避免的，因为这些交易必然会显示其条目是由同一所有人持有的。风险在于，如果密钥的所有者被揭露，链接可能会揭露属于同一所有者的其他交易。

![BTC204](assets/fr/061.webp)

中本聪甚至在比特币正式推出之前，就已经发现了用户的两大隐私漏洞，即 CIOH 和地址重用，这一点尤其引人入胜。这种先见之明是非常了不起的，因为这两种启发式方法直到今天仍然是区块链分析中最有用的方法。

举个例子，我们可以在下面的交易中应用 CIOH：

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

![BTC204](assets/fr/062.webp)

Source : [Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### 链外数据

当然，链分析并不局限于链上数据。以前的分析或互联网上的任何数据也可用于完善分析。

例如，如果我们观察到追踪到的交易系统性地从同一个比特币节点发出，并设法识别其 IP 地址，我们可能就能识别来自同一实体的其他交易，并确定发行者的部分身份。虽然这种做法不容易实现，因为它需要大量节点的运行，但一些专门从事区块链分析的公司可能会采用这种方法。

分析人员还可以选择依赖以前的开源分析或自己以前的分析。也许我们能找到指向我们已经确定的地址集群的输出结果。有时，也可以依靠指向交换平台的输出，因为这些公司的地址一般都是众所周知的。

同样，也可以通过排除法进行分析。例如，在分析一个有两个输出的交易时，如果其中一个输出与已知的地址集群有关，但与我们正在追踪的实体不同，那么我们就可以解释为另一个输出可能代表了交换。

渠道分析还包括稍为一般的 OSINT（*开源情报*）部分，涉及互联网搜索。因此，我们建议不要在社交网络或网站上直接公布地址，无论是否为化名。

![BTC204](assets/fr/063.webp)

### 时间模型

我们很少去想它，但人类的某些行为是可以通过链条识别的。在分析中最有用的可能就是你的睡眠模式！是的，当你睡觉的时候，你不会广播比特币交易。但你一般会在大致相同的时间睡觉。这就是在区块链分析中使用时间分析的常见做法。简单地说，这就是对特定实体的交易在比特币网络中的广播时间进行普查。通过分析这些时间模式，我们可以推断出大量信息。

首先，时间分析有时可以确定被追踪实体的性质。如果我们观察到交易在 24 小时内持续播出，那么这就表明经济活动的水平很高。这些交易背后的实体很可能是一家公司，有可能是国际性的，或许有自动化的内部程序。

例如，[我在几个月前](https://twitter.com/Loic_Pandul/status/1701127409712452072) 分析[错误地分配了 19 个比特币费用的交易](https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd) 时就发现了这种模式。通过简单的时间分析，我推测我们面对的是一项自动服务，因此很可能是交易所平台这样的大型实体。

事实上，几天后，人们发现这些资金通过 Paxos 交易所平台属于 PayPal。

相反，如果我们可以看到时间模式分布在 16 个特定小时内，那么我们就可以估计，我们面对的是一个个人用户，或者是一家本地公司，具体取决于交换量。

除了观察到的实体性质外，时间模式还能通过时区告诉我们用户的大致位置。这样，我们就可以匹配其他交易，并将其时间戳作为额外的启发式方法添加到我们的分析中。

例如，在我前面提到的多用途地址上，我们可以看到，交易（包括传入和传出）都集中在 13 个小时的时间间隔内。

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/064.webp)

来源 : OXT.me

这个范围可能与欧洲、非洲或中东相对应。因此，我们可以假定这些交易背后的用户居住在这些地区。

与此不同，这种类型的时间分析还得出了中本聪不是在日本而是在美国运作的假设：[*中本聪的时区*](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## 用区块资源管理器将其付诸实践

<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

在这最后一章中，我们将把目前所学的概念付诸实践。我会向你展示真实的比特币交易实例，你必须提取我要求你提供的信息。

理想情况下，要进行这些练习，最好使用专业的链分析工具。然而，自从 Samourai Wallet 的创建者被捕后，唯一的免费分析工具 OXT.me 就不再可用了。因此，我们将选择经典的区块资源管理器来进行这些练习。我推荐使用[Mempool.space](https://mempool.space/)，因为它有很多功能和一系列的链分析工具，但你也可以选择其他资源管理器，比如[Bitcoin Explorer](https://bitcoinexplorer.org/)。

首先，我向大家介绍一下练习。使用图块浏览器完成这些练习，并将答案写在纸上。然后，在本章末尾，我将为你提供答案，以便你检查和更正你的结果。

*这些练习所选的交易完全是根据其特点随机选择的。本章仅用于教育和提供信息。我想明确指出，我既不支持也不鼓励将这些工具用于恶意目的。本章的目的是教你如何在字符串分析中保护自己，而不是进行分析以暴露他人的私人信息*。

### 练习 1

待分析交易的标识符 ：

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

该交易模型的名称是什么？仅考察其模型，即交易结构，可以得出哪些合理的解释？

### 练习 2

待分析交易的标识符 ：

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

该交易模型的名称是什么？仅考察其模型，即交易结构，可以得出哪些合理的解释？

### 练习 3

待分析交易的标识符 ：

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

这次交易的模式是什么？

在确定其模型后，利用交易的内部启发法，交易所可能代表什么输出？

### 练习 4

待分析交易的标识符 ：

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

这次交易的模式是什么？

在确定其模型后，利用交易的内部启发法，交易所可能代表什么输出？

### 练习 5

假设 Loïc 在 Twitter 社交网络上发布了他的一个比特币接收地址：

![BTC204](assets/fr/065.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

根据这些信息，仅使用**地址重用启发式**，哪些比特币交易可以与 Loïc 的身份联系起来？

*显然，我不是这个接收地址的真正主人，也没有在社交网络上发布过。这是我从区块链上随机获取的地址*。

### 练习 6

在练习 5 之后，通过地址重用启发式，您可以识别出 Loïc 似乎参与的几笔比特币交易。通常情况下，在已识别的交易中，您应该已经发现了这一交易：

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
```

这是第一笔向 Loïc 地址发送资金的交易。您认为 Loïc 通过这笔交易收到的比特币是从哪里来的？

### 练习 7

在练习 5 之后，多亏了地址重用启发式，你已经能够识别出 Loïc 似乎参与的几笔比特币交易。现在您想找出 Loïc 来自哪里。根据找到的交易，执行时间分析，找出 Loïc 最有可能使用的时区。根据这个时区，确定 Loïc 似乎居住的地点（国家、州/地区、城市......）。

![BTC204](assets/fr/066.webp)

### 练习 8

下面是比特币交易研究：

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

单看这笔交易，我们能解读出哪些信息？

### 运动解决方案

***练习 1：***

该交易的模型是简单支付模型。如果我们只研究它的结构，我们可以解释为一个输出代表交换，另一个输出代表实际支付。因此我们知道，被观察的用户很可能不再拥有输出中的两个 UTXO 中的一个（即支付），但仍然拥有另一个 UTXO（即交换）。

***练习 2：***

这一交易的模式是分组消费。这种模式可能揭示了一种大规模的经济活动，如交换平台。我们可以推断，输入的 UTXO 来自一家经济活动频繁的公司，而输出的 UTXO 将是分散的。其中一些属于公司客户，他们将比特币提取到自我保管的钱包中。还有一些可能会流向合作公司。最后，毫无疑问会有一些兑换物回到发行公司。

***练习 3:***

该交易的模式是简单支付。因此，我们可以对交易采用内部启发式方法，尝试识别交换。

我个人发现，至少有两种内部启发式方法支持同样的假设：


- 重复使用同一类型的脚本 ；
- 产量最大。

最明显的启发式方法是重复使用同一类型的脚本。事实上，输出`0`是一个`P2SH`，其接收地址以`3`开头：

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

而输出 `1` 是一个 `P2WPKH` ，可通过以 `bc1q` 开头的地址识别：

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

用作该事务输入的 UTXO 也使用了`P2WPKH`脚本：

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

因此，我们可以假设输出`0`对应的是付款，输出`1`是交易交换，这意味着输入用户始终拥有输出`1`。

为了支持或反驳这一假设，我们可以寻找其他启发式方法，要么证实我们的想法，要么降低我们假设正确的概率。

我至少还发现了一个启发式。它是最大的输出启发式。输出 "0 "测量了 "123,689 sats"，而输出 "1 "测量了 "505,839 sats"。因此，这两个输出之间存在显著差异。最大产出启发式表明，最大产出可能是外汇。这一启发式进一步加强了我们最初的假设。

因此，提供 UTXO 作为输入的用户很可能仍持有`1`输出，这似乎体现了交易的交换。

***练习 4:***

该交易的模式是简单支付。因此，我们可以对交易采用内部启发式方法，尝试识别交换。

我个人发现，至少有两种内部启发式方法支持同样的假设：


- 重复使用同一类型的脚本 ；
- 圆柱形输出。

最明显的启发式就是重复使用同类型的脚本。事实上，输出`0`是一个`P2SH`，其接收地址以`3`开头：

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

而输出 `1` 是一个 `P2WPKH` ，可通过以 `bc1q` 开头的地址识别：

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

用作该事务输入的 UTXO 也使用了`P2WPKH`脚本：

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

因此，我们可以假设输出`0`对应的是付款，输出`1`是交易交换，这意味着输入用户始终拥有输出`1`。

为了支持或反驳这一假设，我们可以寻找其他启发式方法，要么证实我们的想法，要么降低我们假设正确的概率。

我至少还发现了一个启发式。那就是输出的整数。输出量`0`为`70,000 萨特`，而输出量`1`为`22,962 萨特`。因此，在 BTC 记账单位中，我们有一个完美的整数输出。圆形输出启发式表明，具有圆形金额的UTXO 很可能是支付的UTXO，通过排除，其他的UTXO 代表交换。这一启发式进一步加强了我们最初的假设。

然而，在这个例子中，另一个启发式可能会挑战我们最初的假设。事实上，产出 "0 "大于产出 "1"。根据 "最大的产出一般是外汇 "这一启发式，我们可以推断产出 "0 "是外汇。然而，这一反假设似乎难以置信，因为其他两个启发式似乎比最大产出启发式更有说服力。因此，尽管存在这一明显的矛盾，但维持我们最初的假设似乎是合理的。

因此，提供 UTXO 作为输入的用户很可能仍持有`1`输出，这似乎体现了交易的交换。

***练习 5:***

我们可以看到，有 8 笔交易与 Loïc 的身份有关。其中 4 笔涉及比特币的接收：

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
8b70bd322e6118b8a002dbdb731d16b59c4a729c2379af376ae230cf8cdde0dd
d5864ea93e7a8db9d3fb113651d2131567e284e868021e114a67c3f5fb616ac4
bc4dcf2200c88ac1f976b8c9018ce70f9007e949435841fc5681fd33308dd762
```

另外 4 个涉及比特币的运输：

```plaintext
8b52fe3c2cf8bef60828399d1c776c0e9e99e7aaeeff721fff70f4b68145d540
c12499e9a865b9e920012e39b4b9867ea821e44c047d022ebb5c9113f2910ed6
a6dbebebca119af3d05c0196b76f80fdbf78f20368ebef1b7fd3476d0814517d
3aeb7ce02c35eaecccc0a97a771d92c3e65e86bedff42a8185edd12ce89d89cc
```

***练习 6:***

如果我们看一下这笔交易的模型，就会发现这是一笔捆绑支出。事实上，这笔交易有一个输入和 51 个输出，表明了经济活动的高度活跃。因此，我们可以假设 Loïc 从一个兑换平台上提取了比特币。

有几个因素强化了这一假设。首先，用于确保 UTXO 输入安全的脚本类型是 P2SH 2/3 多位脚本，这表明交易所平台具有典型的高级安全级别：

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```

更重要的是，所研究的地址 "3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF "在超过 22 万次不同的交易中被重复使用，这通常是交易所平台的特点，它们一般都不注重保密性。

应用于该地址的时间启发式也显示，在 3 个月的时间里，几乎每天都有固定的交易广播，时间超过 24 小时，表明交易所平台在持续活动。

最后，该实体处理的交易量巨大。在 2022 年 12 月至 2023 年 3 月期间，该地址在 222,262 笔交易中接收和发送了 44 BTC。这些庞大的交易量进一步证实了交易所平台活动的可能性。

***锻炼 7:***

通过分析交易确认时间，可以确定以下 UTC 时间：

```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

对这些时刻表的分析表明，UTC-7 和 UTC-8 在大多数时刻表中都符合当前人类活动的范围（08:00 至 23:00）：

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7
05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

![BTC204](assets/fr/066.webp)

UTC-7时区在夏季尤为重要，因为它包括 ：


- 加利福尼亚州（包括洛杉矶、旧金山和圣地亚哥等城市）；
- 内华达州（含拉斯维加斯） ；
- 俄勒冈州（含波特兰） ；
- 华盛顿（含西雅图） ；
- 加拿大不列颠哥伦比亚省（包括温哥华和维多利亚等城市）。

这些信息表明，Loïc 很可能居住在美国西海岸或加拿大。

***练习 8:***

对该交易的分析表明，有 5 个输入和一个输出，这表明交易是合并的。应用 CIOH 启发式，我们可以假定所有输入的UTXO 都属于一个实体，而输出的UTXO 也属于这个实体。看来，用户选择将他拥有的几个UTXO组合在一起，形成一个单一的输出UTXO，目的是整合他的部分。此举可能是为了利用当时低廉的交易成本，以降低未来的成本。

___

*在撰写关于产业链分析的第 3 部分时，我参考了以下资源：* *


- 2021 年，Samourai 钱包制作了题为：[用 OXT 理解比特币隐私](https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923) 的四篇系列文章；* *
- OXT Research](https://medium.com/oxt-research)的各种报告，以及他们的免费区块链分析工具（在萨莫拉钱包创始人被捕后暂时无法使用）;**。
- 更广泛地说，我的知识来自 [@LaurentMT](https://twitter.com/LaurentMT) 和 [@ErgoBTC](https://twitter.com/ErgoBTC) 的各种推文和内容 ;*
- 我与[@louneskmt](https://twitter.com/louneskmt)、[@TheoPantamis](https://twitter.com/TheoPantamis)、[@Sosthene___](https://twitter.com/Sosthene___)和[@LaurentMT](https://twitter.com/LaurentMT)一起参加了[Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji)。*

*我要感谢它们的作者、开发者和制作者。还要感谢校对人员，他们一丝不苟地校正了这篇文章，而这篇文章正是第 3 部分的基础，他们还为我提供了专家建议：* *。


- [Gilles Cadignan](https://twitter.com/gillesCadignan) ;*
- [Ludovic Lars](https://viresinnumeris.fr/)

# 掌握保护隐私的最佳做法

<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## 地址重用

<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>


在研究了可能破坏比特币保密性的技术之后，我们将在第三部分探讨保护自己的最佳方法。本部分的目的不是探讨提高保密性的方法，这个问题将在后面讨论，而是了解如何正确地与比特币互动，以保持其自然提供的保密性，而不诉诸其他技术。

显然，在第三部分的开头，我们要谈谈地址重用。这种现象是对用户机密性的主要威胁。本章肯定是整个课程中最重要的一章。

### 什么是接收地址？

比特币接收地址是用于在钱包上接收比特币的字符串或标识符。

从技术上讲，比特币接收地址并不是字面意义上的 "接收 "比特币，而是用来定义可以使用比特币的条件。具体来说，当你收到一笔付款时，发送者的交易会为你创建一个新的UTXO，作为其输入消耗的UTXO的输出。在这个输出上，它附加了一个脚本，定义了这个 UTXO 日后的使用方式。这个脚本被称为 "*ScriptPubKey*"或 "*Locking Script*"。您的接收地址，或者更准确地说，它的有效载荷，被整合到了这个脚本中。通俗地说，这个脚本基本上是这样写的：

> "*要使用这一新的UTXO，您必须使用与这一接收地址相关联的私人密钥提供数字签名。
![BTC204](assets/fr/067.webp)

根据所使用的脚本模型，比特币地址有不同的类型。第一种被称为 "传统*"，包括 "P2PKH"（*Pay-to-PubKey-Hash*）和 "P2SH"（*Pay-to-Script-Hash*）地址。P2PKH 地址总是以 "1 "开头，P2SH 以 "3 "开头。虽然这些格式仍然安全，但现在已经过时，因为与新标准相比，它们的交易成本更高，保密性更差。

SegWit V0（`P2WPKH`和`P2WSH`）和 Taproot / SegWit V1（`P2TR`）地址代表了现代格式。SegWit 地址以 `bc1q` 开头，2021 年推出的 Taproot 地址以 `bc1p` 开头。

例如，这是一个 Taproot 接收地址：

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

如何构建 ScriptPubKey 将取决于您使用的标准：

| 脚本模板

| ---------------- | ----------------------------------------------------------- |

| P2PKH | OP_DUP OP_HASH160 `<pubKeyHash>` OP_EQUALVERIFY OP_CHECKSIG | OP_EQUALVERIFY OP_CHECKSIG

P2SH | OP_HASH160 `<scriptHash>` OP_EQUAL | P2SH | OP_HASH160 `<scriptHash>` OP_EQUAL

| P2WPKH | 0 `<pubKeyHash>` | P2WPKH

P2WSH | 0 `<witnessScriptHash>` | P2WSH | 0 `<witnessScriptHash>` | P2WSH | 0

P2SH - P2WPKH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL | P2SH - P2WPKH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL

| P2SH - P2WSH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL | P2WSH

| P2TR | 1 `<pubKey>` | P2TR

接收地址的构建也取决于所选择的脚本模型：


- 对于 "P2PKH "和 "P2WPKH "地址，有效载荷（即地址的核心部分）代表公钥的哈希值；
- 对于 `P2SH` 和 `P2WSH` 地址，有效载荷代表 .NET 文件的哈希值；
- 至于 "P2TR "地址，其有效载荷是经过调整的公钥。P2TR 输出结合了_Pay-to-PubKey_和_Pay-to-Script_的各个方面。经过调整的公钥是在经典的消费公钥基础上进行 "调整 "的结果，它来自一组脚本的 Merkle 根，这些脚本也可以用来消费比特币。

![BTC204](assets/fr/068.webp)

组合软件上显示的地址还包括一个 HRP（*人可读部分*），通常是后 SegWit 地址的`bc`、`1`分隔符、版本号`q`（SegWit V0）和`p`（Taproot/SegWit V1）。此外，还添加了校验和，以保证地址在传输过程中的完整性和有效性。

最后，这些地址被转换成标准格式：


- 旧的传统地址的 Base58check ；
- Bech32 用于 SegWit 地址 ；
- 用于 Taproot 地址的 Bech32m。

下面是以 10 为基数的 bech32 和 bech32m 格式（SegWit 和 Taproot）的加法矩阵：

| + | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |

| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| 0 | q | p | z | r | y | 9 | x | 8 |

| 8 | g | f | 2 | t | v | d | w | 0 |

| 16 | s | 3 | j | n | 5 | 4 | k | h |

| 24 | c | e | 6 | m | u | a | 7 | l |

### 什么是地址重用？

地址重用是指使用相同的接收地址来阻塞多个不同的 UTXO。

正如我们在上一节中看到的，每个UTXO 都有自己的 ScriptPubKey，它锁定了UTXO，必须满足该条件，UTXO 才能作为新事务的输入被使用。正是在这个 ScriptPubKey 中集成了有效载荷地址。

当不同的 ScriptPubKeys 包含相同的接收地址时，这就是地址重复使用。实际上，这意味着用户重复向发送者提供相同的地址，以便通过多次支付接收比特币。而恰恰是这种做法对你的隐私造成了灾难性的影响。

### 为什么地址重复使用是个问题？

由于区块链是公开的，因此很容易看到哪些地址锁定了哪些 UTXO 以及有多少比特币。如果同一个地址被用于多项交易，就有可能推断出与该地址相关的所有比特币都属于同一个人。这种做法损害了用户隐私，因为不同交易之间可以建立确定的联系，比特币也可以在区块链上被追踪。中本聪本人已经在比特币白皮书中强调了这个问题：

> *作为额外的防火墙，可以为每笔交易使用一对新的密钥，使它们不与共同的所有者关联*。
![BTC204](assets/fr/055.webp)

资料来源S. Nakamoto，《比特币：点对点电子现金系统》，https://bitcoin.org/bitcoin.pdf，2009 年。

中本聪在这句话中的意图是，在用户身份与比特币上的密钥对发生关联的情况下，创建一个额外的防火墙，以防止他的整个活动被公开链接到他的身份上。如今，随着区块链分析公司和 KYC 法规的激增，使用唯一地址不再是 "额外的防火墙"，而是任何希望保留起码隐私的人不可或缺的做法。

当你重复使用一个地址时，你就在与该地址相关的所有交易之间建立了几乎不可否认的联系。虽然这不会直接危及你的资金，因为椭圆曲线加密法保证了你私钥的安全，但它确实让你的活动更容易被监控。事实上，任何拥有节点的人都可以观察到地址的交易和余额，从而完全破坏了你的匿名性。

![BTC204](assets/fr/054.webp)

为了说明这一点，让我们以鲍勃为例，他经常在 DCA 中少量购买比特币，并总是将它们发送到同一个地址。两年后，这个地址已经有了大量的比特币。如果鲍勃使用这个地址向本地商家付款，后者就能看到所有相关资金，并推断出鲍勃的财富。这可能会导致个人安全风险，比如盗窃或勒索未遂。如果鲍勃使用一个空白地址来接收每笔定期消费，他向商家透露的信息就会大大减少。

在字符串分析中，有两种地址重用类型：


- 外部再利用 ；
- 交易内部重复使用。

第一种情况是一个地址在多个不同的比特币交易中被重复使用。这就是我们之前谈到的：这种启发式推断出通过该地址的所有UTXO都属于一个实体。

内部地址重用不是发生在多个事务中，而是发生在单个事务中。事实上，如果用于锁定输入的相同地址被用作交易的输出，那么我们可以推断出该输出仍属于同一个用户（交易所），并且第二个输出代表实际支付。通过这种启发式方法，我们可以将资金追踪延续到多个交易中。

![BTC204](assets/fr/045.webp)

地址重复使用是比特币的真正祸害。根据 OXT.me 网站（目前无法访问）的数据，2022 年比特币的地址重复利用率约为 52%：

![BTC204](assets/fr/069.webp)

这一比例非常巨大，但绝大多数来自交换平台，而不是个人用户。

### 如何避免地址重复使用？

避免地址重复使用非常简单： **只需使用一个新的空白地址，就可以向钱包支付所有新款项**。

得益于 BIP32，现代投资组合现在是确定的、分层的。这意味着用户可以从单一的初始信息（种子）中生成大量地址。通过保存这一条信息，就可以恢复组合中的所有私钥，从而获得相应地址所担保的资金。

![BTC204](assets/fr/070.webp)

这就是为什么当您在钱包软件中按下 "*接收*"按钮时，每次都会提示一个未使用的接收地址。在这个地址接收比特币后，软件会自动推荐一个新地址。

> *PS: 最近，一些钱包软件宣布他们打算停止生成空白地址，因为他们担心这会被当局视为一种洗钱形式。如果您的软件属于此类，我强烈建议您立即更换，因为用户不能接受这种做法*。
如果你需要一个静态标识符来接收付款，比如捐款，由于重复使用的风险，不建议使用传统的比特币地址。取而代之的是使用闪电地址，或选择静态链上支付标识符，如 BIP47 或 Silent Payments。本培训课程的第 6 部分将详细讲解这些协议。

## 标记和检查部件

<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>


正如我们在字符串分析部分所发现的，有许多启发式方法和模式可以用来推断交易信息。作为用户，必须了解这些技术，以便更好地防范它们。

这就需要对自我保管的钱包进行严格管理，这意味着要了解UTXO的来源，并在支付时仔细选择要消耗的UTXO。这种高效的钱包管理依赖于优秀比特币钱包的两个重要功能：标记和硬币控制。

在本章中，我们将介绍这些功能，看看如何在不增加太多工作量的情况下智能地使用它们，从而大大优化你在比特币上的隐私。

### 什么是标签？

标签是为比特币钱包中的特定UTXO分配注释或标签的做法。这些注释由钱包软件本地存储，绝不会通过比特币网络传输。因此，贴标签是一种个人管理工具。

例如，如果我在 Bisq 上通过 P2P 购买了查尔斯的一个 UTXO，我可以将其标记为"`Non-KYC Bisq Charles`"。

标记是一种很好的做法，有助于记住UTXO的来源或预定目的地，从而便于管理资金和优化隐私。事实上，您的比特币钱包肯定有多个UTXO。如果这些UTXO的来源不同，您可能不希望将来合并这些UTXO，否则就会暴露它们的共同所有权。通过正确标记所有部件，您可以确保在需要使用它们时，即使是多年以后，也能记得它们的来源。

### 什么是转角控制？

如果在投资组合软件中加入硬币控制选项，标签的积极使用将变得更加有趣。

币值控制是优秀比特币钱包软件的一项功能，可以手动选择特定的UTXO作为输入来完成交易。事实上，为了满足输出支付，您需要消耗一个输入 UTXO 作为回报。出于多种原因（我们稍后会讨论），您可能希望精确选择哪些部分作为输入来满足特定支付。这正是硬币控制功能所能实现的。打个比方，这个功能就类似于您在支付法棍面包时从钱包中选择一个特定的硬币。

![BTC204](assets/fr/071.webp)

使用带有硬币控制功能的投资组合软件，再加上UTXO 标签，用户既能区分UTXO，又能为交易准确选择UTXO。

### 您如何给UTXO贴标签？

没有放之四海而皆准的UTXO标签方法。您需要为自己的投资组合确定一个易于理解的标签系统。无论如何，请记住，好的标签是你在需要时可以理解的标签。如果你的比特币钱包主要用于储蓄，那么这些标签可能在未来几十年都不会对你有用。因此，请确保标签清晰、准确、全面。

重要的是，如果有一天您的亲人需要查阅您的投资组合，他们可以很容易地确定资金的来源。这既有助于他们保密，也有助于他们出于法律目的，向有关部门证明资金的来源。

标签上最需要注意的是UTXO 的来源。您只需说明该币是如何进入您的钱包的。是在交易所平台购买的结果？来自客户的发票付款？点对点交换？或者，它代表的是一笔费用的兑换？例如，您可以说明


- 删除 Exchange.com` ；
- 客户付款 David` ；
- 购买 P2P Charles` ；
- 更换沙发

![BTC204](assets/fr/072.webp)

为了微调您的UTXO管理，并尊重您在投资组合中的基金隔离策略，您可以在标签中添加一个额外的指标，以反映这些分离情况。如果您的投资组合包含两类UTXO，而您又不希望将它们混在一起，那么您可以在标签中加入一个标记，以明确区分这两类UTXO。这些分离标记将取决于您自己的标准，例如区分涉及 KYC 的收购过程中产生的 UTXO，或区分专业基金和个人基金。以上述标签为例，这可以转化为：


- KYC - Withdrawal Exchange.com` ；
- KYC--客户付款大卫"；
- 无需 KYC - 购买 P2P Charles；
- 无 KYC - 改变沙发购买方式

![BTC204](assets/fr/073.webp)

此外，在交易过程中，最好对某个部分进行永久标记。例如，在合并UTXO no-KYC时，确保不仅将所得的UTXO标记为 "合并"，而且特别标记为 "合并 no-KYC"，以便清楚地记录硬币的来源。

最后，在标签上标注日期不是必须的。大多数钱包软件都会显示交易日期，而且在区块资源管理器上也可以通过 TXID 找到这些信息。

### 如何选择正确的部件？

执行交易时，硬币控件可让您具体选择消耗哪些UTXO 作为输入，以满足支付输出。这种选择有两个方面：


- 收款人有可能将您的部分身份与输入中使用的 UTXOs 联系起来；
- 外部观察者在作为输入消耗的所有UTXO之间建立联系的能力。

为了说明第一点，让我们举一个具体的例子。假设你用比特币从面包师那里买了一根法棍。你用自己持有的一个或多个UTXO作为输入，至少满足了法棍的输出价格以及交易费用。面包师可能会将你的脸或他知道的你身份的任何其他部分与作为输入的比特币联系起来。知道了这种联系的存在，您在付款时可能会选择特定的 UTXO 而不是其他。

![BTC204](assets/fr/074.webp)

例如，如果您的UTXO之一来自一个交易所平台，而您希望面包师不知道您在该平台上的账户，那么您就会避免使用该UTXO付款。如果您的UTXO价值很高，显示了大量比特币，您可能也会选择不使用它，以避免面包师知道您的 BTC 财富。

因此，选择哪些UTXO用于这第一点是一个个人决定，受你是否愿意透露信息的影响。您在收到UTXO时给它们贴上的标签将帮助您选择那些一旦使用后只暴露您愿意向接收者透露的信息的UTXO。

除了可能向接收者透露的信息外，输入的选择也会影响您向区块链所有观察者透露的信息。事实上，根据 CIOH 启发式（_共同输入所有权启发式_），如果将多个 UTXO 作为交易输入，就会暴露出它们为同一实体所有。

![BTC204](assets/fr/075.webp)

因此，在选择部件时，您需要注意您将要广播的交易将在所有使用的 UTXO 之间创建一个链接。这种链接可能会影响您的个人隐私，尤其是当UTXO来自不同来源时。

![BTC204](assets/fr/076.webp)

以我在 Bisq 上购买的无 KYC UTXO 为例，我希望避免将其与受监管交易所平台（例如，知道我身份的平台）的 UTXO 结合使用。事实上，如果我将这两个 UTXO 作为同一交易的输入，受监管平台就能将我的身份与我在 Bisq 上购买的 UTXO 联系起来，而这两个 UTXO 之前并未与我的身份联系起来。

![BTC204](assets/fr/077.webp)

最后，在选择使用哪些UTXO 作为交易输入时，最重要的是避免使用多个UTXO。在可能的情况下，最多选择一个足够大的硬币来满足支付。这样就可以完全避免与 CIOH 相关的风险。但是，如果单个UTXO不足以支付，而您需要使用多个UTXO，请确保它们的来源相似，以尽量减少不必要的链接风险。此外，请记住，收件人可能会将他们所掌握的您的信息与投入使用的硬币历史记录联系起来。

### 了解自动零件选择

在前面的章节中，我们讨论了如何手动选择用于交易的UTXO。但如果钱包软件自动执行这种选择，会发生什么情况呢？有几种方法可以决定使用哪些币，而UTXO 的选择是比特币研究的一个名副其实的领域。这种自动过程的主要目的通常是最大限度地降低用户的交易成本。

UTXO选择方法，如FIFO（*先进先出*）和LIFO（*后进先出*）是最简单的，但也是效率最低的。采用先进先出法时，首先使用投资组合中最老的部分。这种方法在最大限度地降低交易成本和保密性方面一般都效率不高，除非使用了相对时间锁，而且需要定期更新。相反，后进先出法优先使用最近的UTXO。这两种方法虽然都很简单，但往往被证明是无效的。

更先进的方法是*Knapsack Solver*。在 0.17 版之前，比特币核心钱包一直使用这种方法。它包括从钱包中随机迭代选择UTXO，将它们加起来组成子集，并保留尽可能降低交易权重的解决方案，以降低用户的成本。

分支与边界*（BNB）算法因其发明者而被昵称为 "默奇算法"，从0.17版本开始，该算法已经取代了比特币核心中的*卡纳帕克求解器*。这种更先进的方法旨在找到一组UTXOs，与满足交易输出所需的金额完全对应。BNB 的目标是通过减少所谓的浪费标准（该标准同时考虑了交换的即时成本和预期未来成本），最大限度地减少交换金额和费用。该方法源自艾尔莎-兰德和艾莉森-哈考特于 1960 年提出的 "分支与边界"（*Branch-and-Bound*）的原始概念，与 "纳帕克求解器"（*Knapsack Solver*）相比，该方法能更精确地优化费用。

所有这些自动UTXO选择方法在降低交易成本方面可能很有效，但在保护用户机密性方面往往效果不佳。事实上，这些算法可以将多个UTXO合并到输入中，从而揭示这些UTXO因CIOH而具有的共同属性。显然，这些方法无法考虑UTXOs 上的标签，而这些标签对于有意识地选择向交易接收者披露哪些部分至关重要。目前，选择硬币时优化保密性的唯一方法就是手动选择。

### UTXO标记教程

如果你想了解如何标记你的UTXOs，我们已经在主要的比特币钱包软件上做了一个全面的教程：

https://planb.network/tutorials/privacy/on-chain/utxo-labelling-d997f80f-8a96-45b5-8a4e-a3e1b7788c52

## KYC 和关键识别

<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>


KYC 是 "了解你的客户 "的缩写。这是在比特币领域运营的某些公司实施的一项监管程序。该程序的目的是核实和登记客户身份，以打击洗钱和资助恐怖主义的行为。

在实际操作中，KYC 涉及收集客户的各种个人数据，这些数据可能因司法管辖区而异，但一般包括身份证、照片和地址证明。然后对这些信息进行核实和存储，以备将来使用。

在大多数西方国家，所有受监管的兑换平台都必须履行这一程序。这意味着，任何希望通过这些平台用国家货币兑换比特币的人都必须遵守 KYC 要求。

这一程序对用户的隐私和安全并非没有风险。在本章中，我们将详细研究这些风险，并分析 KYC 和身份识别程序对比特币用户隐私的具体影响。

### 促进链上追踪

与 KYC 相关的第一个风险是，它为区块链分析提供了一个特权切入点。正如我们在上一节中看到的，分析师可以利用交易模式和启发式方法对区块链上的活动进行聚类和跟踪。一旦成功聚类用户的链上活动，他们只需在用户的所有交易和密钥中找到一个切入点，就能完全泄露用户的机密。

![BTC204](assets/fr/078.webp)

当您执行 KYC 时，您为区块链分析提供了一个高质量的切入点，因为您将从交易所平台提取比特币时使用的接收地址与您经过验证的完整身份联系起来。从理论上讲，只有您提供信息的公司才知道这些信息，但正如我们在下文中将看到的，数据泄露的风险是真实存在的。更重要的是，即使公司不共享这些信息，仅仅是公司拥有这些信息这一事实也会带来问题。

因此，如果你不采取其他措施来限制你在区块链上的活动，任何知道这个 KYC 入口点的人都有可能将你在比特币上的所有活动与你的身份联系起来。从该公司的角度来看，你使用比特币就失去了所有的保密性。

![BTC204](assets/fr/079.webp)

打个比方，就好像你在 X* 银行的银行职员不仅能看到你在 X* 银行的所有交易，还能看到你在 Y* 银行的交易和所有现金交易。

还记得本培训课程的第一部分吗？中本聪构想的比特币保密模式是基于用户身份和密钥对之间的分离。尽管这层保密性在今天已不再足够，但尽可能限制其退化仍是明智之举。

### 受到国家监控

KYC 的第二个主要问题是，它会让国家知道你在某个时间段拥有过比特币。当你通过受监管的行为者购买比特币时，国家就有可能知道你拥有比特币。目前看来，这似乎微不足道，但重要的是要记住，你的国家的政治和经济未来并不掌握在你的手中。

首先，国家可以迅速采取专制立场。历史上政策突然改变的例子比比皆是。今天，在欧洲，比特币使用者可以撰写关于比特币的文章，参加会议，并自我管理他们的钱包。但谁能说得准明天会发生什么呢？如果比特币突然成为头号公敌，那么在政府档案中与比特币联系在一起就会成为问题。

然后，面对严重的经济危机，国家可能会考虑没收公民持有的比特币。也许明天，比特币持有者就会被视为危机中的暴发户，在法定货币贬值的情况下被征收过高的资本收益税。

你可能认为这不是问题，因为你的比特币是混合的，因此无法追踪。然而，追踪并不是问题所在。真正的问题是国家知道你拥有比特币。仅这一信息就足以指控你或追究你的责任。你可以声称你已经花掉了你的比特币，但这必须反映在你的纳税申报单上，你会被抓住的。你也可以说你在一次划船事故中丢了钥匙，但除了 Twitter 上的笑话之外，你真的认为这足以为你开脱罪责吗？

因此，重要的是要考虑到国家知道您拥有 BTC 的风险，无论这种风险在今天看来多么遥远。

在国家监管方面，KYC 带来的另一个问题是受监管平台的强制报告。虽然我不熟悉其他司法管辖区的法规，但在法国，*Prestataires de Services sur Actifs Numériques* (PSAN) 有义务向金融监管部门报告他们认为可疑的任何资金流动。

2023 年，法国的公共安全网络报告了 1 449 起可疑行为。目前，这些行为大多与犯罪有关。不过，当局也要求受监管的平台仅根据比特币的结构来报告任何可疑的比特币交易。如果你进行的是合作交易，甚至只是模式略显反常的交易，而这笔交易又发生在你从这些平台提取比特币的不远处，那么你可能会发现自己被报告给了当局。即使没有渎职行为，即使是合法行使权利，这种举报也可能导致检查和监视的增加，而如果没有 KYC，这些不便是可以避免的。

### 个人数据泄露的风险

KYC 的另一个问题是，它要求将您的所有个人数据存储在一家私营公司的服务器上。

最近发生的事件提醒我们，没有人能够幸免于财务或 IT 故障。2022 年，Celsius 的客户承受了这一后果。公司破产后，美国法院在行政程序中公布了债权人的姓名及其资产数额。

就在两年多前，加密货币网络安全领域的一面旗帜，其客户的个人数据被盗。虽然这一事件与购买比特币并无直接联系，但对于交易所平台来说，这种风险依然存在。因此，个人数据存在一定的风险。

诚然，我们已经将许多个人数据委托给了私人公司。然而，这里的风险是双重的，因为这些数据不仅可以识别你的身份，还与比特币的活动相关联。事实上，当黑客获得交易所平台的客户数据时，他可以合理地认为这些客户拥有比特币。比特币和其他有价值的资产一样，会吸引盗贼的注意，这就加剧了这种风险。

如果发生数据泄漏，您最多可能成为有针对性的网络钓鱼企图的目标。在最坏的情况下，您可能会发现自己的家庭受到物理威胁。

除了与比特币相关的特定风险外，还有与传输身份证件相关的危险。事实上，一旦数据泄露，就有可能成为身份盗窃的受害者。因此，其利害关系不仅限于保护交易的机密性，还关系到每个人的个人安全。

### 关于 KYC 的一些先入为主的想法

在推特上或比特币玩家之间的交流中，我们经常会遇到一些关于 KYC 的先入为主的观点，解构这些观点非常重要。

首先，认为保护通过 KYC 获取的比特币的隐私毫无意义是不准确的。比特币上的隐私保护工具和方法多种多样，目的也各不相同。例如，对通过 KYC 获取的比特币使用 coinjoin 交易并不是一个坏主意。当然，你需要小心使用受监管的交易所平台，以避免账户被冻结或封禁，但从严格的技术角度来看，这些做法并不冲突。Coinjoin 可以打破一个币的历史记录，从而帮助你规避某些与 KYC 相关的链分析风险。虽然这并不能消除所有风险，但它确实是一项重大优势。

![BTC204](assets/fr/080.webp)

不应二元对立地看待比特币的保密性，将其视为 "匿名 "比特币和其他非匿名比特币之间的区别。拥有通过 KYC 获取的比特币并不意味着一切都失去了意义；相反，使用保密工具可以证明更加有益。

相反，通过非 KYC 方式获取比特币并不能保证完全保密，也不能免除你采取其他保护措施的需要。如果你持有非 KYC 比特币，但多次重复使用接收地址，你的交易可能会被追踪和汇总。与比特币外部世界的最微小联系都可能危及你仅有的一层保密性。因此，重要的是将比特币上的所有隐私增强工具和方法视为互补。每种技术都能解决特定的风险，并增加一层额外的保护。因此，拥有非 KYC 比特币并不意味着你不需要采取其他预防措施。

### KYC 可以取消吗？

我有时会被问到，在进行 KYC 之后是否可以 "回头"，正如你从前面的段落中可以想象到的，答案是微妙的。避免 KYC 相关风险的最简单方法就是在获取比特币时不要使用 KYC。我们将在下一章更深入地探讨这个问题。但是，如果已经进行了 KYC 并购买了比特币，是否有办法降低其中的风险呢？

说到追踪交易的风险，coinjoin 是一种解决方案。我们将在课程的稍后部分详细介绍这种方法，但您应该知道，coinjoin 可以让您中断一个币的历史记录，防止它被追踪到过去-现在和现在-过去。即使是通过受监管平台获得的 BTC，这种技术也能防止其被追踪。

然而，coinjoin 并不能消除与 KYC 相关的第二种风险：国家可能会被告知您拥有比特币。事实上，即使你的比特币不再可追踪，国家（取决于司法管辖区）也可能获得你的加密资产转移申报。由于这种风险不是技术性的，而是行政性的，因此，除了从一开始就不把自己暴露在 "KYC "之下之外，没有专门针对比特币的解决方案来消除这种风险。降低这种风险的唯一合法方法是在受监管平台上出售通过受监管平台获得的比特币，然后通过免 KYC 的方式回购。通过出售和申报转让，当局应该会发现你不再拥有这些比特币。

至于泄露个人数据和身份证件的风险，这是比特币的外部危险，没有技术手段可以避免。一旦你的数据被泄露，就很难撤销操作。您可以尝试关闭平台上的账户，但这并不能保证删除您的 KYC 数据，尤其是在身份验证外包的情况下。完全删除信息的验证是不可能的。因此，没有任何解决方案可以完全防止这种风险并确保其不复存在。

### KYC 与关键识别的区别

有时，一些比特币玩家倾向于将 "KYC "一词延伸到任何涉及电汇或信用卡支付的 BTC 交易所，因为这些手段也可以揭示支付的来源，就像 KYC 一样。但是，"KYC "不应与 "关键识别 "混为一谈。就我个人而言，我必须承认，随着时间的推移，我对这个问题的认识也在不断变化。

KYC 特指某些公司为核实和登记客户身份而实施的监管程序。这是一个二进制问题：在获取比特币时，要么做 KYC，要么不做。然而，关键识别涉及用户身份的一个方面与链上活动之间的联系，并非二元对立，而是一个连续体。事实上，在比特币的获取或转移过程中，这种身份识别总是在不同程度上是可能的。

例如，如果您在瑞士受监管的平台上购买比特币，则不需要 KYC。不过，你的密钥可能会被识别出来，因为购买是通过你的银行账户进行的。这时，与 KYC 相关的前两个风险--促进链上追踪和暴露于国家监控--也会在没有 KYC 的交易所中显现出来。如果瑞士实体向贵国当局报告可疑交易，他们只需检查用于购买的银行账户，就能发现你的身份。因此，在受监管的平台上购买而不进行 KYC，在关键识别的风险等级上是相当高的。

![BTC204](assets/fr/081.webp)

然而，避开受监管的平台并选择 P2P 收购方式并不能完全消除密钥识别的风险，而只是降低了风险。以在 Bisq 或其他 P2P 平台上购买为例。您可能会使用银行账户向对方付款。如果当局询问与您交易的人并询问您的姓名，我们又回到了风险 1 和 2。虽然这些风险比在没有 KYC 的平台上购买时要低得多，甚至比在有 KYC 的平台上购买时更低，但它们在一定程度上仍然存在。

![BTC204](assets/fr/082.webp)

最后，即使你通过现金实物交换获得比特币，你也不是完全匿名的。与你交换比特币的人看到了你的脸，这也是你身份的一部分。虽然在这个例子中，这种可能性微乎其微，但仍然存在关键识别的可能性。

![BTC204](assets/fr/083.webp)

总之，当比特币与其他资产交换时，无论是购买国家货币还是出售实物，总会有某种形式的密钥识别。根据所选择的兑换方式，这种识别的强度可能会有所不同。重要的是，不要将这种识别与 KYC 混为一谈，后者是一个定义明确的监管过程。不过，KYC 和识别范围之间有联系，因为 KYC 是识别范围的高端，因为它系统地促进了当局对用户密钥的识别。

## 销售和采购方法

<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>


读完上一章后，你可能会想知道如何才能在不进行身份验证的情况下买卖比特币，以避免与 "KYC "相关的风险。交易比特币有几种方式。

### P2P 现金交易所

正如我们所看到的，就保密性而言，最好的方法仍然是采用现金结算的 P2P（个人对个人）交换。这种方法可以最大限度地减少留下的痕迹，大大降低关键识别的可能性，无论是买还是卖。

![BTC204](assets/fr/084.webp)

不过，个人安全也有风险。主要的危险在于，在兑换过程中，对方会知道你持有大笔现金或比特币。这一信息可能会引起恶意人士的注意。因此，一般来说，对比特币的持有还是谨慎为好。这个建议也适用于现金。然而，在当面交换时，难免会暴露自己拥有比特币，这可能会引起不受欢迎的注意。

![BTC204](assets/fr/085.webp)

为了限制这种风险，我建议你最好与可信赖的人进行现金交易，比如家人或亲密的朋友。另外，你也可以考虑在[本地比特币聚会](https://btcmap.org/communities/map)上进行交易，参加几次之后就可以了。这将使你更好地了解其他参与者，在实际交换时不会感到孤单。不过，重要的是要认识到，P2P 现金交易本身会给您的人身安全带来风险，而通过受监管的平台和您的银行账户购买则不存在这种风险。

更重要的是，根据你居住的地方，无论是比特币还是现金，运输和存储大笔资金都可能存在风险。

如果遇到警察或其他方面的检查，兑换现金也会带来法律风险。虽然大多数国家对随身携带的现金数额没有限制，但过多的现金可能会引起怀疑。因此一定要小心谨慎，尤其是在必须长途旅行的情况下，避免一次进行过多的大额交易，以免需要为持有大额现金进行辩解。

最后，P2P 购买的另一个缺点是价格往往高于受监管的平台。卖家通常会加价 1%，有时甚至超过 10%。造成这种价格差异有几个原因。首先，这是 P2P 卖家的普遍做法，随着时间的推移已经形成。其次，卖方需要支付将资金发送给买方的相关交易费用。与平台交易相比，P2P 销售中的盗窃风险也会增加，因此有理由对所承担的风险进行补偿。最后，额外成本可能与交易所的保密需求和质量有关。作为买方，保密性的提高是有代价的，这体现在卖方的加价上。一些比特币玩家也认为，在 P2P 上购买的 BTC 的加价反映了其真实价格，并认为监管平台上较低的价格是个人数据保密性受损的结果。

![BTC204](assets/fr/086.webp)

### 通过撮合平台进行 P2P 交流

就个人安全而言，风险较低的另一种选择是通过 PayPal、银行转账或 Revolut 等电子支付方式，完全在网上进行 P2P 交换。

![BTC204](assets/fr/087.webp)

这种方法避免了与现金交易相关的许多风险。不过，在线交易所的交易对手违约的风险更大。事实上，在实体交易所，如果你把钱交给卖家，而他没有把比特币还给你，你可以立即要求他承担责任，因为他就站在你面前。而在网上，你往往无法追踪到偷你钱的人。

![BTC204](assets/fr/088.webp)

为了降低这种风险，可以使用专门的平台进行 P2P 交换。这些平台使用冲突解决机制来保护受害用户。一般来说，它们提供托管系统，在卖方确认以法定货币付款之前，比特币一直由托管系统保管。

![BTC204](assets/fr/089.webp)

就个人安全而言，这种购买方式要比实物现金交易安全得多。然而，如上所述，在线 P2P 交易所留下的痕迹比实体交易所更多，这可能不利于比特币的隐私保护。通过使用银行等在线法币支付方式，你会暴露更多的信息，从而便于关键识别。

![BTC204](assets/fr/090.webp)

再次提醒，我不建议在这些平台上进行过多的单笔大额交易。通过拆分交易，可以分散交易对手盗窃的风险。

同样，P2P 购买的另一个缺点是价格往往高于受监管平台的价格。卖家通常会加价 1%，有时甚至超过 10%。造成这种价格差异的原因有几个。首先，这是 P2P 卖家的普遍做法，随着时间的推移已经形成。其次，卖方需要支付将资金发送给买方的相关交易费用。与平台交易相比，P2P 销售中的盗窃风险也会增加，因此有理由对所承担的风险进行补偿。最后，额外成本可能与交易所的保密需求和质量有关。作为买方，保密性的提高是有代价的，这体现在卖方的加价上。一些比特币玩家也认为，在 P2P 上购买的 BTC 的加价反映了其真实价格，并认为监管平台上较低的价格是个人数据保密性受损的结果。

![BTC204](assets/fr/086.webp)

就解决方案而言，我个人一直使用 [Bisq](https://bisq.network/)，而且非常满意。他们的系统久经考验，似乎很可靠。不过，Bisq 只能在个人电脑上使用，其界面对于初学者来说可能过于复杂。另一个缺点是，Bisq 只能进行链上交易，这在比特币交易费用较高的时期可能会变得很昂贵。

-> 请参阅我们的 Bisq 教程。

https://planb.network/tutorials/exchange/peer-to-peer/bisq-fe244bfa-dcc4-4522-8ec7-92223373ed04

如果想选择更简单的方法，您可以试试 [Peach](https://peachbitcoin.com/)，这是一款连接买家和卖家的移动应用程序，内置冲突解决系统。该程序比 Bisq 更直观。

-> 请参阅我们的 Peach 教程。

https://planb.network/tutorials/exchange/peer-to-peer/peach-c6143241-d900-4047-9b73-1caba5e1f874

另一个在线选择是 [HodlHodl](https://hodlhodl.com/)，这是一个成熟的平台，提供良好的流动性，不过我没有亲自测试过。

-> 请参阅我们的 HodlHodl 教程。

https://planb.network/tutorials/exchange/peer-to-peer/hodlhodl-d7344cd5-6b18-40f5-8e78-2574a93a3879

关于基于闪电网络的解决方案，请尝试[RoboSats](https://learn.robosats.com/) 和[LNP2PBot](https://lnp2pbot.com/)。RoboSats 可通过网站访问，使用相对简单。LNP2PBot 则比较特殊，它通过 Telegram 消息应用程序上的交换系统运行。

-> 请参阅我们的机器人卫星教程。

-> 请参阅我们的 LNP2PBot 教程。

https://planb.network/tutorials/exchange/peer-to-peer/robosats-b60e4f7c-533a-4295-9f6d-5368152e8c06

https://planb.network/tutorials/exchange/peer-to-peer/lnp2pbot-v2-e6bcb210-610b-487d-970c-7cce85273e3c

![BTC204](assets/fr/091.webp)

### 无 KYC 的受监管平台

根据你所居住的国家，你可以使用不需要 KYC 程序的受监管平台来买卖比特币。例如，在瑞士，你可以使用 [Relai](https://relai.app/) 和 [MtPelerin](https://www.mtpelerin.com/) 等平台。

-> 请参阅我们的 Relai 教程。

https://planb.network/tutorials/exchange/centralized/relai-v2-30a9671d-e407-459d-9203-4c3eae15b30e

正如我们在上一章中看到的，这类平台可以让你免于 KYC 程序带来的风险，但它们确实会带来更高的密钥识别风险。因此，就比特币的保密性而言，这些平台提供的保护要好于 KYC 购买方式，但它们的吸引力仍不及 P2P 交易所。

不过，就个人安全而言，使用这些平台的风险远低于 P2P 交易所。使用起来也往往比 P2P 平台简单。

### 自动取款机

另一种无需 KYC 就能买卖比特币的方法是加密货币 ATM。就我个人而言，我从来没有机会测试这种解决方案，因为在我的国家没有这种设备。但这种方法可能非常有趣，这取决于你住在哪里。

![BTC204](assets/fr/092.webp)

自动取款机的问题在于，有些国家禁止使用自动取款机，有些国家则对其进行严格监管。如果自动取款机需要身份验证程序，那么它所面临的风险与受 KYC 监管的平台所固有的风险相同。另一方面，如果自动取款机允许小额交易而无需身份验证，那么使用自动取款机可以提供与 P2P 现金交易所相当的保密性，同时避免与这类交易所相关的大部分风险。

自动取款机的主要缺点是兑换手续费通常很高，从兑换金额的几个百分点到 15%不等。

### 礼品卡

最后，我还想向大家介绍一种解决方案，对于那些希望每天使用比特币进行购物而不是将其出售来兑换法定货币的人来说，这种方案非常适用。

消费比特币的最佳方式当然是直接使用比特币或闪电网络购买商品或服务。然而，在许多国家，接受比特币的商家数量仍然有限。一个实用的替代方法是使用礼品卡。

一些不需要 KYC 程序的平台提供将比特币兑换成礼品卡的可能性，这些礼品卡可以在大型零售商处使用。这些平台包括 [CoinsBee](https://www.coinsbee.com/)、[The Bitcoin Company](https://thebitcoincompany.com/) 和 [Bitrefill](https://www.bitrefill.com/)。这些平台使比特币的日常使用更加方便，让你无需将比特币兑换成法定货币，就能获得各种产品和服务。

https://planb.network/tutorials/exchange/centralized/bitrefill-8c588412-1bfc-465b-9bca-e647a647fbc1

![BTC204](assets/fr/093.webp)

### 其他获取方法

在保护隐私的同时获取比特币的其他方法当然还包括挖矿。要开始挖矿，你不需要暴露身份；只需找到有效的工作证明并提交给网络即可。如果你选择矿池挖矿，有些矿池需要某种形式的身份证明，如 KYC，有些则不需要。

另一种方法是以工作换取比特币。这种获取方式可能很有趣，但所需的身份验证程度因情况不同而有很大差异。

*为了撰写本章，我使用了 [@pivi___](https://x.com/pivi___) 在 Plan ₿ Network 上提供的 BTC205 培训课程（目前只有法语版本）。

## 合并、UTXO 管理和 CIOH

<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>


管理自我托管投资组合最复杂的一个方面就是合并。是否应该合并？有什么意义？应该尊重多大的 UTXO？在保密性方面有哪些妥协？这就是我们本节要探讨的问题。

### 什么是合并？

比特币的运作方式就像一个拍卖市场，矿工优先考虑费用最低的交易。不过，每个区块都有一个最大权重，这限制了可包含的交易数量。由于平均每 10 分钟产生一个区块，因此每个区块的可用空间是稀缺资源。

矿商的活动在电力、固定资产和维护方面产生大量成本，自然会寻求利润最大化。因此，他们倾向于选择相对于其权重能产生最高费用的交易。

并非所有的比特币交易都具有相同的权重。输入和输出越多的交易权重越大。例如，我们假设有 2 笔交易：


- 交易 A 包括 1 个输入和 1 个输出。它分配了 1 994 sats 的费用，权重为 141 vB；
- 交易 B 是一个更复杂的交易，有 2 个输入和 2 个输出，分配了 2 640 sats 的费用，权重为 220 vB。

![BTC204](assets/fr/094.webp)

在这个例子中，虽然交易 B 的总费用更高，但矿工们更喜欢交易 A，因为它的费用和权重之间的比率更高。以下是每笔交易的计算结果，以每个虚拟字节（sat/vB）表示：

```text
TXA : 1994 / 141 = 14 sats/vB
TXB : 2640 / 220 = 12 sats / vB
```

这意味着，就每单位重量而言，交易 A 的成本高于交易 B，尽管交易 B 的绝对成本更高。

![BTC204](assets/fr/095.webp)

因此，对于用户来说，在交易中消耗尽可能少的输入总是更有趣的。但是，您需要消耗足够的数量来满足输出支付。在管理您的投资组合时，您需要有足够大的 UTXO。

合并的原则正是利用比特币手续费较低的时期，将较小的UTXO合并成一个较大的UTXO。这样，当比特币的手续费上涨时，你就能以最少的投入进行交易，从而减少手续费的绝对支出。因此，这样做的目的是在高手续费期间，预测必须进行的交易。

![BTC204](assets/fr/096.webp)

除了节省交易成本外，合并UTXOs 还有助于防止 "灰尘 "的形成。灰尘 "指的是UTXO在卫星中的价值很低，不足以支付使用这些UTXO所需的交易成本。只要交易成本居高不下，使用这些UTXO在经济上就是不合理的。通过主动汇集您的UTXO，您可以防止它们变成灰尘，确保您的所有资金仍然可用。

### UTXO的最小尺寸是多少？

有时有人问我，UTXO 的建议最低值是多少。遗憾的是，这并没有一个通用的答案，因为这取决于您的偏好和收费市场的条件。不过，这里有一个公式，或许能帮你确定一个适合自己的阈值：

$$
\frac {P \times F}T = M
$$

在哪里？


- p$ 是交易权重；
- $F$ 代表您对冲的最大收费率，单位为每 vbyte（sats/vB）；
- t$ 是您愿意支付的交易费占 UTXO 总价值的百分比；
- m$ 是每个 UTXO 的最低金额（以卫星为单位）。

让我们假设，您计划支付一笔标准 SegWit 交易的费用，1 个输入和 2 个输出，总重量为 141 vB。如果您最多对冲 800 个 sats/vB，并且您最多愿意花费 UTXO 价值的 12% 作为费用，那么计算结果将是：

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

因此，在这个例子中，明智的做法是在投资组合中将UTXOs 的最小值保持在 940,000 sats。

### 合并和 CIOH

区块链分析中使用最广泛的启发式之一是 CIOH（*共同输入所有权启发式*），它假定比特币交易的所有输入都属于同一个实体。合并的原理就是消耗多个UTXO作为输入，创建一个UTXO作为输出。因此，合并可以应用 ICOH。

![BTC204](assets/fr/097.webp)

实际上，这意味着外部观察者可以推断出所有合并的 UTXO 很可能属于同一个人，而且所生成的唯一输出也属于他或她。这种情况会将不同的交易历史关联起来，从而危及你的保密性。例如，假设我将通过 P2P 获取的 3 个 UTXO 与通过需要 KYC 的平台获取的 1 个 UTXO 合并：

![BTC204](assets/fr/098.webp)

这样一来，任何可以访问交易所平台数据的实体（可能包括政府机构）都能识别出我拥有其他数量的 BTC。以前，这些 UTXOs 与我的身份没有直接联系；现在有了。更重要的是，它向所有消息来源透露了我拥有一定数量的比特币。

在管理 UTXOs 时，经济方面的考虑会促使合并以降低成本，而良好的保密做法则建议 永远不要合并 UTXOs。因此，如何在经济性和保密性之间做出选择，取决于每个用户的优先事项。

如果既能避免合并，又能保持可观的 UTXOs，那就再好不过了。要做到这一点，就要优化你的收购方法。如果你在 DCA 中购买比特币，请尽量拉开一次性购买的间隔，以便在较少的 UTXO 上巩固价值。每两个月一次性购买 1000 欧元比每周购买 120 欧元要容易得多。这样可以最大限度地减少产生的 UTXOs 数量，简化投资组合的管理，同时为您保密。

如果您发现自己必须合并比特币，请优先考虑合并同一来源的UTXO。例如，合并来自单一平台的 10 个UTXO 对你的保密性的影响要小于将来自平台 A 的 5 个UTXO 与来自平台 B 的 5 个UTXO 混合在一起的影响。例如，将通过 KYC 获取的UTXO 合并到一个交易中，将通过 P2P 获取的UTXO 合并到另一个交易中。

无论如何，不要忘记，任何合并都不可避免地会失去保密性。因此，在考虑到 CIOH 的情况下，要仔细评估这一操作的必要性以及对您隐私的潜在影响。

## 其他最佳做法

<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>


让我们来看看其他一些优化比特币隐私的最佳做法。

### 完整的结

拥有自我保管的比特币固然好，但使用自己的完整节点更好！以下是为什么拥有自己的节点对完全主权使用比特币至关重要：


- 抵制审查**：任何人都无法阻止您的交易；
- 独立于第三方**：您不再依赖任何外部服务来验证区块链数据；
- 积极参与**：您可以定义自己的验证规则，并直接参与达成共识；
- 网络贡献**：通过运行一个节点，你可以帮助加强和传播比特币网络；
- 技术教育**：管理一个完整的节点是加深你对比特币技术知识了解的好方法。

除了这些好处，使用完整节点还能提高您在发布交易时的保密性。当你发布一笔交易时，它首先是通过你的钱包创建和签名的。要在比特币网络上发布，必须至少有一个节点知道它。通过使用自己的节点，您可以直接控制这种传播，从而加强您的保密性并限制数据泄漏的风险。

![BTC204](assets/fr/099.webp)

如果您没有自己的比特币节点，就不得不使用第三方节点，如钱包软件供应商提供的节点。除了广播交易外，您的钱包还需要访问各种信息，如待处理交易、与您的地址相关的余额以及交易确认的次数。要访问所有这些数据，您需要查询一个节点。

![BTC204](assets/fr/100.webp)

当你不使用自己的比特币节点时，主要风险在于第三方节点的操作者可能会观察到你在区块链上的活动，甚至与其他实体共享这些信息。为了限制这种风险，一个中间解决方案是使用通过 Tor 屏蔽连接的钱包软件。这可以减少数据的暴露。然而，最佳的解决方案是拥有自己的比特币节点，并用它来广播您的交易。当然，你也需要注意不要通过你的节点泄露任何信息，但这是我们在后面章节中要讨论的另一个主题。

除了隐私方面的明显优势外，拥有自己的完整节点还能确保区块链上数据的真实性，保护您免受审查，并让您积极参与比特币治理。通过使用自己的节点，您可以为自己选择的链贡献自己的经济权重，这在社区内部发生冲突时非常重要，例如在 2015 年至 2017 年的 "区块链战争 "期间。在分叉的情况下，使用第三方节点可能会导致您支持您不想支持的链，因为节点运营商会为您做出选择。

如您所见，为了保密和个人主权，必须运行和使用自己的完整节点！

### 欺骗性分析启发法

更广泛地说，了解我们在上一节中谈到的启发式方法非常重要，这样才能更好地避免或欺骗它们。采用一系列最佳实践可能是有益的，即使它们并非必不可少。它们提供了一个额外的保护层，对使用比特币时的保密性非常重要。

我可以给出的第一个建议是融入最密集的人群。在比特币上，这意味着使用最广泛采用的脚本模板。例如，通常用于 SegWit V0 多重签名配置的 P2WSH 脚本就很不常见。它们无法让你隐藏在大型匿名集中。P2PKH 或 P2SH 等旧模式也是如此。虽然它们广泛存在于 UTXO 中，但在新交易中使用得越来越少。

一般来说，选择最新的脚本标准更为明智，前提是它已被充分采用。因此，如果说在 2022 年，我会建议不要使用 P2TR（Taproot），因为它的采用率很低的话，那么到了 2024 年，我会建议改用这种脚本，或者改用 SegWit V0 脚本，因为使用 P2TR 的交易数量已经开始占到相当大的比例。

![BTC204](assets/fr/101.webp)

来源 : [txstats.com](https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)

另一个保密技巧是尽量绕过内部交易启发式。例如，在付款时，您可以尽量避免创建金额为整数的输出，因为这可能意味着其他输出代表外汇。如果您需要向朋友发送 100 k 萨特，可以考虑转入稍高的金额，以避开这种启发式。同样，尽量不要创建与支付金额不成比例的高额外汇输出，因为这也会暴露出哪个输出代表外汇。

![BTC204](assets/fr/102.webp)

最后，如果你定期进行比特币交易，请确保不要总是在同一时间进行交易。通过将交易时间分散在一天或一周内，可以避免让外部观察者有机会发现基于时区的时间模式，从而加强他们的分析。

除了这些日常采用的好方法外，还有一些更有效的方法可以彻底破坏比特币的可追溯性。这些方法当然包括币合交易，我们将在下一节深入探讨。

# 了解联接交易

<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## 什么是硬币连接交易？

<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>


在学习了隐私保护的基础知识后，我们现在来看看更复杂的技术，旨在积极保护你的机密，尤其是通过拆分你的比特币历史。在下一部分，我们将学习一系列小技巧，但首先，我想向大家介绍一下 coinjoin。

Coinjoin 通常被认为是保护比特币用户隐私的最有效方法。但到底什么是 Coinjoin 交易呢？让我们一探究竟。

### 共同连接的基本原则

Coinjoin 是一种在区块链上破解比特币追踪的技术。它基于同名特定结构的协作交易：Coinjoin 交易。

正如我们在本课程的第一部分所看到的，比特币的交易通过节点为所有用户所知。因此，很容易检查每个币的电子签名链并观察其历史。这意味着所有用户都可以尝试分析其他用户的交易。因此，交易层面的匿名是不可能的。但在个人身份识别层面，匿名性却得以保留。在传统银行系统中，每个账户都与个人身份相关联，而在比特币中，资金与加密密钥对（或脚本）相关联，为用户提供了一种加密标识符背后的假名形式。

![BTC204](assets/fr/103.webp)

当外部观察者能够将特定的 UTXO 与已识别的用户联系起来时，比特币的保密性就会受到破坏。一旦这种关联建立起来，就有可能追踪他们的交易，分析他们的比特币历史。Coinjoin 正是为了打破UTXOs 的可追溯性而开发的一种技术，目的是在交易层面为比特币用户提供一定的保密性。

Coinjoins 使外部观察者对链的分析更加复杂，从而加强了比特币用户的保密性。它们的结构允许将来自不同用户的多个币合并成一笔交易，模糊了交易界限，难以确定输入和输出地址之间的联系。

重要的是要明白，"接币 "交易的目的是打破一个币的历史。这种技术并不会赋予比特币永久匿名性，也不会完全阻止比特币的追踪，这与你可能的想法恰恰相反。Coinjoin 的目的只是在进行 Coinjoin 交易时破坏历史记录。然而，在这一操作之前和之后，比特币在保密性方面仍然面临同样的风险。

![BTC204](assets/fr/104.webp)

### 共同连接是如何工作的？

Coinjoin 原理基于一种协作方法：几个希望混合比特币的用户将相同金额的比特币作为输入存入同一笔交易。然后，这些金额以等值输出的方式重新分配给每个用户。

![BTC204](assets/fr/105.webp)

在交易结束时，无法将特定的输出与称为输入的用户联系起来。输入和输出之间没有直接联系，这就打破了用户与其UTXO 之间的联系，也打破了每个部件的历史记录。

![BTC204](assets/fr/106.webp)

让我们以 Alice 为例。她想给妹妹伊芙发送大约 100,000 个比特币作为生日礼物。但是，爱丽丝不希望伊芙能够追踪到她的交易历史，因为她不想暴露自己有多少比特币，也不想暴露自己是如何得到这些比特币的。为此，爱丽丝决定用 Coinjoin 交易打破她的 UTXO 历史。她组织鲍勃、查尔斯、大卫和弗兰克进行了一次合作交易：


- 爱丽丝、鲍勃、查尔斯、大卫和弗兰克各自投入 105,000 萨特的UTXO（其中 5,000 萨特为采矿费）作为交易输入：

![BTC204](assets/fr/107.webp)


- 作为消耗这些输入的回报，每个输入都会生成一个空白地址，以创建五个相同的输出，每个输出都有 100,000 sats。每台设备检索一个输出：

![BTC204](assets/fr/108.webp)


- 爱丽丝发现自己有一个 100,000 sats 的UTXO，它的历史被搞混了。她在新的交易中使用这个UTXO，将这笔钱寄给夏娃作为生日礼物：

![BTC204](assets/fr/109.webp)


- 如果夏娃试图分析这笔交易以提取信息，她将面对的是涉及爱丽丝、鲍勃、查尔斯、大卫和弗兰克的 coinjoin 交易。由于金额的统一性，夏娃无法区分哪些输入属于谁，因此无法追踪爱丽丝的UTXO历史，也无法确定她的妹妹拥有多少比特币或她是如何获得这些比特币的：

![BTC204](assets/fr/110.webp)

在本例中，爱丽丝使用了硬币连接技术来提高追溯分析的保密性。实际上，爱丽丝是在保护自己免受夏娃可能进行的分析，因为夏娃会从特定的交易开始，倒推UTXO 的历史。这种防止从现在到过去进行分析的保护措施被称为 "追溯保密"。我们将在本节的最后几章更详细地探讨这一概念。

然而，面对从过去到现在的分析，coinjoin 也提供了加强保密性的可能性，这就是所谓的前瞻性取消。让我们回到爱丽丝给夏娃发送 98,000 封电子邮件作为生日礼物的例子，但角色要颠倒一下。现在让我们想象一下，担心自己隐私的是夏娃。事实上，爱丽丝可能会追踪她寄给夏娃的硬币，以便从中获取信息。Eve 很可能会将她刚刚收到的这个 UTXO 与她的所有其他 UTXO 合并，这样就会向 Alice 透露她钱包中的比特币数量。为了避免这种情况，夏娃还可以破坏她刚刚收到的比特币的历史记录：


- 夏娃、格蕾丝、马洛里、奥斯卡和维克多各自输入了 98,000 sats 的UTXO，作为比特币交易的输入：

![BTC204](assets/fr/111.webp)


- 作为消耗这些输入的回报，每个用户提供一个空白地址，用于创建 5 个由 97500 个完全相等的 sats 组成的输出。每个用户获得一个输出：

![BTC204](assets/fr/112.webp)


- 伊芙现在掌握着一个拥有 97500 个卫星的UTXO，其历史记录已被破坏。她可以毫无顾忌地使用它进行未来的交易。事实上，如果爱丽丝试图追踪她发送给夏娃的比特币，她将会遇到币合交易。她将无法确定哪个流出的 UTXO 属于 Eve。分析也就变得不可能了：

![BTC204](assets/fr/113.webp)

在第一个例子中，我们看到了 "硬币连接 "如何保护一个房间过去的隐私，而在第二个例子中，我们看到了 "硬币连接 "如何保护一个房间未来的历史。这就是为什么我提到，"硬币连接 "应被视为一个一次性事件，它在两个方向上都分割了部分历史：

![BTC204](assets/fr/104.webp)

### 混合器、共同连接、混合器......有什么区别？

Coinjoins 有时被描述为 "混合器"，一些比特币爱好者拒绝接受这个词，担心它会与托管混合器相混淆。不过，我认为这种担心是没有根据的，因为在数学语境中，币合恰恰体现了混合的概念。

在数学的一般领域中，混合是指动态系统的一种特性，即经过一段时间后，初始空间的所有部分理论上都可以与任何其他部分混合。混合意味着粒子的位置或系统的状态以这样一种方式演变，即粒子的未来分布与其初始分布无关，从而达到初始状态的特征在整个系统空间均匀分布的状态。这正是比特币的投币过程。因此，在我看来，coinjoin 是一种真正的硬币混合方法。

![BTC204](assets/fr/114.webp)

另一方面，区分 coinjoin 和洗币机也很重要。洗币机是一种用户发送比特币进行洗币的服务。这些服务曾在 2010 年代风靡一时，但由于与 Coinjoin 相比存在两大缺点，其使用量已有所下降：


- 它们要求用户在混合过程中放弃对资金的保管，这就使用户面临被盗的风险；
- 不能保证混合器不会记录交易细节，甚至不会将这些信息出售给连锁分析公司。

![BTC204](assets/fr/115.webp)

因此，如今的用户更喜欢 Coinjoin，因为它允许他们在整个过程中完全控制自己的资金。Coinjoin 参与者没有比特币被其他参与方盗取的风险。让我们在下一章看看这一切是如何实现的。

## Zerolink 与 chaumian 的共同连接

<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>


投币式连接所提供的私密性是由我们的棋子所隐藏的小组规模决定的。这意味着要找到尽可能多的参与者。我们完全可以通过自己找到的用户来手动创建一个币圈，但这是一个复杂的过程，而且不会为你赢得任何大的安索。

这就是为什么在比特币上发展出了 Coojoin 协调员。他们的作用是让不同的用户相互联系，并传递完成合作交易所需的信息。

![BTC204](assets/fr/116.webp)

但我们如何确保协调人永远不会接触到用户的比特币，尽管他是构建 coinjoin 交易的人，但我们如何确保他无法将用户的输入和输出联系起来，从而构成泄密？

### 乔姆的盲人签名

现代 Coinjoin 实现使用 David Chaum 的盲签名来避免信息泄露。让我们快速了解一下这些盲签名是如何工作的。

Chaum盲签名是一种数字签名形式，签名者不知道他所签名的信息内容。但签名可以根据原始信息进行验证。这种技术由密码学家戴维-乔姆于 1983 年开发。

![BTC204](assets/fr/117.webp)

例如，一家公司希望在不泄露合同等机密文件内容的情况下对其进行验证。该公司采用一种掩蔽程序，以可逆的方式对原始文件进行加密转换。修改后的文件发送给认证机构，认证机构在不知道文件内容的情况下进行盲签名。在收到签名文件后，公司会取消签名。这样，一份原始文件就得到了认证机构签名的认证，而认证机构却从未见过原始文件的内容。

因此，Chaum 的盲签名可以在不知道文件内容的情况下认证文件的真实性，从而保证用户数据的保密性和签名文件的完整性。

### Chaumian 硬币连接

所谓的 "Chaumian "coinjoins 将 Tor 和戴维-乔姆的盲签名结合使用，以确保协调者无法知道哪个输出属于哪个用户。

Coinjoin 交易构建过程包括三个主要阶段：输入注册、输出注册和交易签名。让我们以联合交易所参与者之一爱丽丝为例，来了解这一过程。所有其他参与者都各自按照与爱丽丝相同的步骤进行操作。

**第 1 步：输入登记


- 爱丽丝向协调者发送她希望作为交易输入的UTXO，以及她希望作为输出接收比特币的屏蔽接收地址。因此，协调者无法知道爱丽丝的地址。它只能看到爱丽丝的屏蔽地址：

![BTC204](assets/fr/118.webp)


- 协调者检查输入的有效性，然后用自己的私人密钥对 Alice 的屏蔽地址进行签名。他将盲签名返回给 Alice：

![BTC204](assets/fr/119.webp)

**第 2 步：输出登记**


- 爱丽丝可以解除她的地址，该地址现在由协调人的私人密钥签名。她将以不同的 Tor 身份建立新的连接。协调者无法识别以这个新身份连接的是爱丽丝：

![BTC204](assets/fr/120.webp)


- 爱丽丝向协调人（协调人仍不知道是爱丽丝）发送未屏蔽的地址和签名：

![BTC204](assets/fr/121.webp)

**第 3 步：签署交易**


- 协调人以同样的方式从所有参与者那里获取未掩盖的输出结果。有了相关的签名，他就可以检查每个匿名提交的输出是否事先经过他的私钥签名，从而保证其合法性。然后，他就可以建立币合交易，并将其发送给参与者签名：

![BTC204](assets/fr/122.webp)


- 爱丽丝和其他参与者一样，检查自己的输入和输出是否正确地包含在协调者构建的交易中。如果一切正常，她就会向协调者发送解锁输入脚本的签名：

![BTC204](assets/fr/123.webp)


- 在收集了所有 Coinjoin 参与者的签名后，协调人就可以在比特币网络上广播交易，以便将其添加到一个区块中。

在这个系统中，协调人无法将输入与特定输出联系起来。更重要的是，他无法挪用参与者的资金，因为他永远无法获得解锁参与者 UTXO 所需的私人密钥。在整个过程中，直到第 3 步结束，他也无法访问签名。当爱丽丝和其他参与者签署全局交易后，在检查一切无误后，协调者就不能再修改交易，包括输出，否则交易就会失效。这就防止了协调者窃取比特币。

最后，在注册交易产出时，币合用户希望获得与公民投票类似的保证。这些行为的公共性和私密性具有双重性。一方面，你希望保持私密性：对于投票者来说，他不希望他的选票与他的身份联系在一起；对于硬币连接用户来说，他不希望他的输出与他的输入联系在一起。事实上，如果协调人或任何其他方设法在输入和输出之间建立联系，那么投币器就会失去所有兴趣。如上所述，硬币连接必须作为硬币历史的一个断点。之所以会出现这种中断，正是因为在联币交易中不可能将特定的输入与特定的输出联系起来（前瞻性中断），反之亦然（追溯性中断）。

另一方面，还有公共方面：投票人希望确保他的选票包含在投票箱中；同样，币仓用户希望确保他的输出包含在币仓交易中。事实上，在签署交易之前，币合参与者绝对必须能够验证他们的输出是否存在，否则协调人可能会窃取资金。

正是这两个公共和私人方面，通过使用戴维-恰姆的盲签名，保证了恰姆币兑换的参与者的比特币不会被盗，他们的资金也不会被追踪。

### 谁发明了 "硬币连接 "概念？

很难确定是谁最先在比特币中引入了 coinjoin 的想法，又是谁提出了在这种情况下使用 David Chaum 的盲签名的想法。人们通常认为是 Gregory Maxwell 在 [2013 年 BitcoinTalk 上的一则消息](https://bitcointalk.org/index.php?topic=279249.0) 中首次提到的：

> *"使用 Chaum 的盲签名：用户登录并提供输入（和交换地址），以及他们希望发送私人部分的地址的加密盲版；服务器签署令牌并将其发回。用户以匿名方式重新连接，解除输出地址的屏蔽并将其发送回服务器。服务器可以看到所有输出都已由其签名，因此所有输出都来自有效的参与者。之后，人们重新连接并登录
Maxwell, G. (2013, August 22). *CoinJoin：现实世界的比特币隐私*.BitcoinTalk Forum. https://bitcointalk.org/index.php?topic=279249.0

![BTC204](assets/fr/124.webp)

不过，还有其他更早的说法，既有将Chaum签名作为混合的一部分，也有将其作为币币连接的一部分。[2011年6月，邓肯-汤森（Duncan Townsend）在BitcoinTalk](https://bitcointalk.org/index.php?topic=12751.0)上介绍了一种混合器，它使用Chaum签名的方式与现代的Chaumian硬币接合十分相似。

在同一主题中，我们可以找到[哈希币回复邓肯-汤森的信息](https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793)，以改进他的混合器。这条信息中描述的过程正是币合的本质。亚历克斯-米兹拉希（Alex Mizrahi）在 2012 年的一条信息](https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry) 中也提到了类似的系统，当时他正在为 Tenebrix 的创建者提供建议，Tenebrix 是最早的另类币之一，也是后来创建莱特币的基础。甚至连 "coinjoin "一词本身据说也不是格雷格-麦克斯韦尔（Greg Maxwell）创造的，而是来自彼得-托德（Peter Todd）的一个想法。

![BTC204](assets/fr/125.webp)

### Zerolink

Zerolink 是一种全面的混合协议，它结合了Chaumian coinjoins和各种策略，以保护用户的匿名性免受几种形式的链分析的影响，特别是通过最大限度地减少与投资组合管理相关的错误。该协议[由 nopara73 和 TDevD 于 2017 年推出](https://github.com/nopara73/ZeroLink/blob/master/README.md)。

![BTC204](assets/fr/126.webp)

顾名思义，Zerolink 的原理是创建硬币连接交易，确保无法追踪输入和输出之间的联系。这是通过确保所有输出的金额完全相同来实现的。

![BTC204](assets/fr/127.webp)

Zerolink 采取的一项重要预防措施是通过使用单独的加密密钥集，甚至是单独的组合，将未混合的 UTXO 与已混合的 UTXO 完全分开。这就将用于混合前部件的 "*pre-mix*"钱包与用于已混合部件的 "*post-mix*"钱包区分开来。

![BTC204](assets/fr/128.webp)

严格分离UTXO首先是为了防止混合UTXO和未混合UTXO之间的意外关联。事实上，如果出现这种关联，混合 UTXO 上硬币连接的有效性就会在用户不知情的情况下被取消，从而破坏UTXO 的保密性，而用户却以为自己已经破坏了UTXO 的历史记录。如果用户将混合UTXO和未混合UTXO作为同一交易的输入，这些联系可能通过地址重用发生，也可能通过应用 CIOH（_共同输入-所有权启发式_）发生。通过分离混合前和混合后的投资组合，我们可以避免这种意外关联，并保护用户免受无意错误的影响。

![BTC204](assets/fr/129.webp)

这种分离还提供了在组合软件层面对预混合和后混合组合应用不同规则的可能性。例如，在混合后投资组合中，软件可以禁止将 UTXOs 并入输入，以防止应用 CIOH，因为这将损害用户的 anonset。还可以对脚本和交易选项（例如 RBF 报告）的使用进行标准化，以防止钱包指纹识别。

目前，Whirlpool 是唯一一个严格执行 Zerolink 协议的联接实现。在下一章中，我们将介绍现有的各种 Coinjoin 实现，以及每种实现的优缺点。

## Coinjoin 实现

<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>


*2024 年，我们正在见证比特币用户可用工具的重大变化。我们目前正处于一个转折点，币圈市场正在经历重大调整。随着时间的推移，本章将会不断更新

目前，比特币上主要有三种不同的 Coojoin 实现方式：


- 惠而浦；
- Wabisabi；
- JoinMarket.

这些实现方式都旨在通过联合交易打破UTXO的历史。但是，它们的机制差异很大。因此，了解每种方法的工作原理至关重要，这样您就可以选择最适合您需求的方案。

### 加入市场

JoinMarket由亚当-吉布森（Adam Gibson）和克里斯-贝尔彻（Chris Belcher）于2015年创立，凭借其独特的用户连接模式，从其他币币连接实施方案中脱颖而出。该系统基于一个 P2P 交换市场，其中一些用户（即 "制造者"）将其比特币用于混合，而另一些用户（即 "接受者"）则使用这些现金进行币币合并，以换取一定的费用。

![BTC204](assets/fr/130.webp)

在这种模式下，"制造者 "将自己的比特币提供给 "接受者"，并收取一定的服务费。而 "接受者 "则付费使用 "制造者 "的比特币进行自己的币合交易。服务费因所扮演的角色而异："制造者 "通过提供流动性积累费用，而 "接受者 "则支付费用。市场运作自由，没有使用条件。

JoinMarket 的主要缺点之一是使用复杂，需要对终端有一定程度的熟悉才能有效操作。虽然这种复杂性对有经验的用户不是障碍，但可能会限制一般公众的使用。不过，最近推出的名为 JAM 的网络界面使其使用更加简便。

![BTC204](assets/fr/131.webp)

来源 : [JAM](https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

然而，技术障碍仍然是一个主要障碍。在币币结合生态系统中，参与者的数量加强了保密性，任何降低可访问性的限制都会直接影响可用的流动性，而流动性是混合效率的关键因素。比特币作为金融交易中的一个利基，将其使用的 Coinjoins 视为一个子利基，而 JoinMarket 则是其中更加专业的一部分，因此限制了其增加用户匿名性的潜力。

尽管 JoinMarket 创新性地采用了 P2P 连接模式，但它也有一些明显的缺点，特别是在交易结构方面。与 Whirlpool 等其他实现方式不同，JoinMarket 不能保证输出之间完全平等，而且有可能追踪输入和输出之间的确定性链接。此外，JoinMarket 没有工具防止已经混合在一起的部件再次混合，这可能会损害用户寻求的保密性。

最后，虽然 JoinMarket 的概念很有趣，特别是对于那些对动态流动性市场感兴趣的人来说，但我认为，它的结构弱点和技术复杂性使它对于寻找硬币连接实现的新手和专家来说都不那么有趣。

### Wabisabi

Wabisabi 是另一种币合实现方式，采用的是集中交易协调的方法。该模式由Ádám Ficsór (nopara73)、Yuval Kogman、Lucas Ontivero和István András Seres于2021年构思，并于次年集成到Wasabi 2.0软件中。Wabisabi正是2018年推出的Wasabi软件币合模式的进化版。

![BTC204](assets/fr/132.webp)

在 2010 年代末期，Wasabi 采用了与 Whirlpool 截然不同的币圈交易结构。Wasabi 采用了涉及数十个参与者的超大规模合并交易，以增加参与者的资产净值。与此相反，Whirlpool 选择了多个小型交易，从而使 anonsets 在每个周期内呈指数增长。

外汇管理方法也是两种实施方法的区别所在。在 Whirlpool 中，由于 TX0 的存在，外汇在币安循环之前就被排除和隔离在 UTXO 之外，我将在下一章进一步解释这一概念。另一方面，Wasabi 将外汇作为联接交易的输出之一，在某些输入和输出之间保持确定性联系。

![BTC204](assets/fr/133.webp)

随着 Wabisabi 的推出，Wasabi 2.0 版本对其硬币连接方法进行了调整，以与 Whirlpool 的方法相匹配。虽然硬币接合交易仍然非常大，但现在可以按照 Whirlpool 的模式连续进行几个循环。Wabisabi 还特别关注汇率管理：Wasabi 1.0 版本的汇率与用户输入直接挂钩，而 Wabisabi 2.0 则不同，它试图将汇率细分为几个小数目，并将所有参与者分成面额相等的小数目。

让我们用一个简化的例子来说明这一点，例子中只有两个用户：爱丽丝希望混合 115,000 萨特，鲍勃希望混合 210,000 萨特。如果忽略手续费，在 Wasabi 1.0 版本中，币合交易将产生 3 个 100,000 萨特的输出，加上爱丽丝的 1 次 15,000 萨特的兑换和鲍勃的 1 次 10,000 萨特的兑换。交易所的输出仍与输入相关联：

![BTC204](assets/fr/134.webp)

在 Wabisabi 模式下，同一笔交易会产生 3 个 100 000 萨特的产出和 5 个 5 000 萨特的产出，从而分散了交换，使其无法与特定的投入直接挂钩：

![BTC204](assets/fr/135.webp)

我个人认为，Wabisabi 公司的外汇管理存在一些风险，可能会影响其保密性能：


- 当一个用户贡献的UTXO明显大于其他参与者的UTXO时，他最终不可避免地会得到一个与他的投入相关联的兑换额。这违背了协议的初衷，即消除所有可识别的交换；
- 以分散交换为目的的面额倍增可能会损害混合效率。由于某些产出更容易识别，这一过程可能会导致不含税产出的减少；
- 这种方法还会产生低价值的 UTXO，给用户带来管理问题。这些小的 UTXO，如果与其价值相比花费过高，就会变成 "灰尘"。这种现象导致用户将多个 UTXO 合并为未来交易的输入，或将其合并。在这两种情况下，由于 CIOH 的存在，要么会减少所获得的保密利益，要么会完全抵消最初合并硬币所获得的保密利益。

惠而浦实施的 ZeroLink 协议确保了预混合和后混合 UTXO 之间的严格隔离，而 Wabisabi 则不同。此外，Wasabi 的一些客户还存在地址重复使用的问题，这显然对用户非常不利。

在 Wasabi 2.0 版本中，实施了新的接币费用政策。从现在起，0.01 个比特币以上的UTXO 的协调费定为 0.3%，而对于较小的UTXO，协调费则全额收取。此外，这些较小的 UTXOs 的重置是免费的，但用户仍需支付所有交易（包括重置）的挖矿费用。

这与惠而浦的政策形成了鲜明对比，惠而浦的政策是无论获得的anonsets大小，费用都是固定的。在 Wasabi 2.0 中，虽然小规模的 UTXO 可以免去协调人费用，但用户仍需为所有交易（包括混矿）支付挖矿费用。

就在我写这几行字的时候，由于最近发生的事件，Wabisabi 的使用变得更加复杂了。在 Samourai 钱包的创始人被捕后，Wasabi 的开发资金和管理公司 zkSNACKs 宣布将于 2024 年 6 月 1 日停止其 Coinjoin 协调员服务。该协调人是在 Wasabi 上默认设置的，负责绝大多数的流动性。

随着该主协调人的终止，用户现在必须连接到新的独立协调人。这一变化引发了一系列问题：一方面，新的协调者可能没有足够的流动性，从而降低了硬币连接的保密性。另一方面，还存在遇到恶意协调人的风险。这种情况给想要使用 Wabisabi 的人增加了新的重大风险。

除了技术问题之外，Wasabi 背后的公司 zkSNACKs 决定使用字符串分析公司的服务来过滤币圈参与者，也引发了严重的道德和战略问题。最初的想法是防止犯罪分子在 Wasabi 上使用硬币连接，此举看似合法。然而，这却引发了一个悖论：向一个以加强用户保密性为主要任务的协调人支付费用，却让他资助一个以破坏用户保密性为目的的公司。

更令人担忧的是过滤原则，这与比特币提供一个开放、不受审查的金融系统的理念形成了鲜明对比。虽然排除犯罪活动似乎是合理的，但这种过滤也可能影响到一些人，他们的行为虽然在某些情况下被归类为非法，但在道义上是正当的或对社会有益的。爱德华-斯诺登（Edward Snowden）的例子完美地诠释了这种对立：一些政府认为他的揭露行为是犯罪，而另一些政府则认为他是为公众利益而行动的举报人。这种复杂性凸显了过滤的潜在危险，尽管过滤的初衷是好的，但最终会损害合法用户的权利和安全。我还可以提到在某些专制政权下受到迫害的活动家和记者。

正如你现在已经了解到的，我更倾向于比特币上的 Whirlpool 合币模式。该系统因其严谨性和卓越的保密性而脱颖而出。它也是唯一一个在数学背景下提供完美混合的系统。在我看来，这种模式代表了比特币上币的未来。我邀请大家在下一章中更深入地探讨这种模式。

## 惠而浦如何工作

<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>


漩涡有别于其他加入硬币的方法，它使用"_ZeroLink_"交易，确保所有输入和输出之间没有任何可能的技术联系。这种完美的组合是通过一种结构实现的，在这种结构中，每个参与者的投入量完全相同（挖矿费用除外），产生的产出量完全相等。

这种对投入的限制性方法使惠而浦的联合交易具有一个独特的特征：投入和产出之间完全没有确定的联系。换句话说，相对于交易中的所有其他输出，每个输出归属于任何参与者的概率都是相等的。

![BTC204](assets/fr/136.webp)

### 惠而浦如何工作

最初，每次惠而浦币合的参与者人数限制为 5 人，其中包括 2 名新加入者和 3 名混币者（我们稍后将解释这些概念）。然而，2023 年观察到的链上交易费用的增加促使萨莫拉团队重新思考他们的模式，以提高保密性，同时降低成本。因此，考虑到费用市场情况和参与者数量，协调人现在可以组织包括 6、7 或 8 名参与者在内的 Coinjoins。这些增强型会议被称为 "激增周期"。值得注意的是，无论采用哪种配置，惠而浦币圈总是只有 2 名新参与者。

因此，惠而浦交易的特点是输入和输出数量相同，可以是......或......：


- 5 个输入和 5 个输出 ；

![BTC204](assets/fr/137.webp)


- 6 个输入和 6 个输出 ；

![BTC204](assets/fr/138.webp)


- 7 个输入和 7 个输出 ；

![BTC204](assets/fr/139.webp)


- 8 个输入和 8 个输出。

![BTC204](assets/fr/140.webp)

Whirlpool 的模型基于小规模的 Coinjoin 交易。与 Wabisabi 和 JoinMarket 不同，Whirlpool 依靠的是几个小循环的序列，而 Wabisabi 和 JoinMarket 则是根据单个循环（或几个循环）的参与者数量来确定匿名集的稳健性。

在这种模式下，用户只需在首次加入矿池时支付费用，就可以免费参与多种混音。新加入者支付混音者的采矿费。

每增加一次作品参与的混音，以及过去遇到的同类作品，Anonsets 就会呈指数级增长。这样做的目的是利用这些免费的混音，因为每次混音都有助于加强与每个混音作品相关的匿名集的密度。

![BTC204](assets/fr/141.webp)

惠而浦在设计时考虑到了两个重要要求：


- 考虑到 Samourai 钱包首先是一个智能手机应用程序，因此移动设备的可访问性；
- 快速的再混合周期可促进不沉淀物的显著增加。

Samourai Wallet 的开发人员在设计 Whirlpool 时，就是在这些必要条件的指导下做出选择的，这也导致他们限制了每个周期的参与者数量。参与人数太少会影响接币效率，大幅减少每个周期产生的安索，而参与人数太多又会给移动应用带来管理问题，阻碍周期流程。

最后，在 Whirlpool 上，每次合并不需要太多参与者，因为合并是在多次合并循环的基础上进行的。这里最重要的原则是所有参与者的UTXO的同质性，因为这可以确保完美的混合，从而充分受益于混合和再混合循环。

### 联合奖池和费用

为了让这些多重循环提高混合部件的安稳性，需要一个特定的框架来限制所使用的 UTXO 数量。Whirlpool 定义了不同的池。

一个币池代表一组希望混合在一起的用户，他们就UTXO的数量达成一致，以优化币合过程，同时保持完美的部件同质性。每个币池都规定了固定的UTXO数量，用户必须遵守该数量才能参与。因此，要使用 Whirlpool 进行硬币拼接，您需要选择一个池。目前可用的池如下


- 0.5 个比特币 ；
- 0.05 比特币 ；
- 0.01 比特币 ；
- 0.001 比特币（= 100,000 萨特）。

当您用比特币进入一个矿池时，这些比特币将被分割，生成与其他参与者完全一致的UTXO。每个比特币池都有一个最高限额，因此，如果金额超过这个限额，你就必须分两次进入同一个比特币池，或者转移到另一个金额更高的比特币池：

| 币池（比特币） | 每个条目的最高金额（比特币） | | 每个条目的最高金额（比特币） | | 每个条目的最高金额（比特币

|----------------|--------------------------------------|

| 0,5 | 35 |

| 0,05 | 3,5 |

| 0,01 | 0,7 |

| 0,001 | 0,025 |

当一个UTXO准备好并入一个币池时，它就被视为属于该币池。但这并不意味着用户失去了对它的所有权。正如我们在本节前几章所看到的，通过各种混合循环，用户仍可保留对密钥的完全控制权，因此也可保留对比特币的完全控制权。这就是币合技术与其他集中式混合技术的不同之处。

要加入 Coinjoin 矿池，您需要支付服务费和挖矿费。每个矿池的服务费都是固定的，旨在为负责开发和维护 Whirlpool 的团队提供报酬。

使用 Whirlpool 的服务费只需在加入泳池时支付一次。加入后，您可以无限次参加混音，无需支付额外费用。以下是每个池目前的固定费用：

| 奖池（比特币） | 报名费（比特币） | 奖金（比特币

|----------------|---------------------------------|

| 0,5 | 0,0175 |

| 0,05 | 0,00175 |

0.01 | 0.0005 (50,000 sats) | 0.01 | 0.0005 (50,000 sats) | 0.0005 (50,000 sats)

| 0.001 | 0.00005 (5,000 sats) | | 0.001 | 0.00005 (5,000 sats)

无论您在 coinjoin 中投入多少资金，这些费用本质上都是所选池的入场券。因此，无论您是以 0.01 BTC 还是 0.5 BTC 进入 0.01 池，费用的绝对值都是一样的。

在进行惠而浦硬币连接之前，用户可以选择两种策略：


- 选择较小的资金池，以最大限度地降低服务成本，因为他知道这将换来几个较小的 UTXO；
- 或者选择更大的资金池，愿意支付更高的费用，但最终获得的高价值 UTXO 数量却更少。

一般来说，在硬币连接循环后合并多个混合 UTXO 并不可取，因为这可能会危及获取的机密性，特别是由于共同输入所有权启发式（CIOH：*共同输入所有权启发式*）。因此，为了避免输出中出现过多的小值UTXO，选择更大的池可能是合理的，即使这意味着要支付更多的费用。用户必须对这些权衡进行评估，以选择自己喜欢的数据池。

除服务费外，还必须考虑任何比特币交易的特定采矿费。作为 Whirlpool 用户，您需要为准备交易 (`Tx0`)以及首次加入比特币支付挖矿费。由于 Whirlpool 基于向新加入者付费的模式，所有后续的混币都将是免费的。

事实上，在每一次惠而浦联合中，输入的用户中有 2 个是新加入者。其他投入则来自再混合者。因此，交易中所有参与者的挖矿成本都由这两个新加入者承担，他们也可以从免费的混音中获益：

![BTC204](assets/fr/142.webp)

由于UTXOs的匿名性与用户支付的价格不成正比，因此Whirlpool的收费系统与其他coinjoin实施系统相比显得与众不同。因此，用户只需支付入池费和 2 笔交易（"Tx0 "和初始混合）的挖矿费，就可以实现更高水平的匿名性。

值得注意的是，用户在完成多个 Coinjoin 后，还需要支付挖矿费用，才能从池中提取UTXOs，除非他选择了 "mix to "选项，该选项提供了一个外部地址，可直接从 Coinjoin 中接收资金，而无需任何额外交易。

### 高清组合账户

要通过 Whirlpool 创建合并币，钱包必须生成多个独立账户。这就是 ZeroLink 协议背后的原理。在 HD（*分层确定性*）投资组合的背景下，一个账户构成一个与其他账户完全隔离的部分，这种隔离发生在投资组合层次结构的第三层，即 "xpub "层。

![BTC204](assets/fr/143.webp)

一个 HD 钱包理论上最多可以衍生出 `2^(31)` 个不同的账户。所有比特币钱包默认使用的初始账户对应于`0'`索引。

对于适用于惠而浦的投资组合，使用 4 个账户来满足 ZeroLink 流程的需要：


- 以索引 `0'` 标识的**存款**账户；
- 坏银行**（或 "有毒变化"）账户，以 "2 147 483 644 "为索引；
- 以 "2 147 483 645 "为索引的**预混**账户；
- 以 "2 147 483 646 "为索引的**postmix**账户。

这些账户在联接过程中各司其职，我们将在下面的章节中进行探讨。

所有这些账户都与一个种子相关联，用户可以使用恢复短语和密码（如适用）恢复对所有比特币的访问。不过，在恢复操作过程中，软件必须了解所使用的各种账户索引。

让我们来看看惠而浦在这些账户中进行硬币兑换的不同阶段。

### TX0

任何惠而浦币合的起点都是**存款**账户。这是您创建新比特币钱包时自动使用的账户。该账户需要存入您想要混合的比特币。

Tx0 "是惠而浦混合过程的第一步。其目的是准备和均衡UTXO，将其分成与所选池数量相应的单位，以确保均匀混合。然后，经过均衡的UTXOs 被送入**预混**账户。至于不能进入池中的差额，则会被分离到一个特定的账户：**坏银行**（或 "有毒变化"）。

这笔最初的 "Tx0 "交易也用于支付应向 Coinjoin 协调员支付的服务费。与下面的步骤不同，这笔交易不是合作交易，因此用户必须承担全部挖矿成本：

![BTC204](assets/fr/144.webp)

在这个 "Tx0 "交易示例中，从我们的**存款**账户输入的 "372,000 萨特 "被分成几个输出UTXO，细分如下：


- 5,000萨特的协调员服务费，相当于100,000萨特的集合条目；
- 3 个准备混合的UTXO，转入我们的**预混合**账户，并在协调员处登记。这些UTXO的均价为每个108,000萨特，以支付其未来初始混合的采矿成本；
- 因数额太小而无法进入外汇池的盈余被视为有毒外汇。它被发送到其特定账户。在这里，这一兑换额为 40 000 萨特；
- 最后，还剩下 "3 000 个卫星"，它们并不构成产出，而是确认 "Tx0 "所需的采矿成本。

例如，这是一个真实的惠而浦 Tx0（不是我的）：[edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/fr/145.webp)

### 毒性变化

无法纳入资金池的盈余（此处相当于 "40 000 萨特"）被转入**坏银行**账户，也称为 "有毒交换"，以确保与投资组合中的其他UTXO严格分离。

这种UTXO 对用户的保密性来说是危险的，因为它不仅仍附着于其过去，因此也可能附着于其所有者的身份，而且它还被指出属于一个进行了硬币合并的用户。

![BTC204](assets/fr/146.webp)

如果将其与其他有毒更改合并，用户将面临失去保密性的风险，因为它将连接不同的联接循环条目。因此应谨慎对待。我们将在本章最后一节详细介绍如何管理这些UTXOs doxxic。

### 初始组合

在 "Tx0 "之后，均衡后的UTXO会被发送到我们的投资组合的**预混合**账户，准备好进入它们的第一个上币周期，也称为 "初始混合"。如果在我们的例子中，"Tx0 "产生了多个UTXO进行混合，那么每个UTXO都将被整合到一个单独的初始混合中。

在这些首次混合结束后，**premix**账户将清空，而我们的币在支付了首次加入币池的挖矿费用后，将被精确调整到所选币池定义的数量。在我们的例子中，我们最初的 `108,000 sats` UTXOs 将正好减少到 `100,000 sats`。

![BTC204](assets/fr/147.webp)

### 混音版

初始混音后，UTXO 将被转入 **postmix** 账户。该账户收集已混合和等待再混合的UTXO。当惠而浦客户激活时，**postmix** 账户中的UTXO 将自动用于再混合，并将被随机选中参与这些新的循环。

需要提醒的是，混矿是 100% 免费的：不需要额外的服务费或挖矿费。因此，将UTXOs保留在**混币后**账户中，可以保持其价值不变，同时提高其匿名性。这就是为什么让这些币参与多个加入币周期非常重要。这完全不需要任何成本，而且还能提高它们的匿名性。

当您决定使用混合 UTXO 时，可以直接从该 **postmix** 账户中使用。我们建议您将混合UTXO保存在此账户中，以享受免费混音，并防止其离开漩涡回路，从而降低其保密性。

### 您如何管理您的后置混音？

运行币合循环后，最好的策略是将UTXO保存在**后混合**账户中，以备将来使用。甚至建议无限期地让它们重新混合，直到你需要使用它们为止。

有些用户可能会考虑将混合比特币转移到一个由硬件钱包保护的钱包中。这是有可能的，但重要的是要严格遵守 Samourai 钱包的建议，以免影响获得的机密性。

合并UTXOs 是最常见的错误。为避免 CIOH（*共同输入-所有权-激励*），您必须避免在同一笔交易中将混合 UTXO 与非混合 UTXO 合并。这就要求在投资组合中仔细管理UTXO，特别是在标签方面。

![BTC204](assets/fr/148.webp)

在合并混合 UTXO 时也必须小心谨慎。如果您的混合 UTXOs 有大量的不相关性，可以进行适度的合并，但这将不可避免地降低部件的保密性。请确保合并的范围既不要太大，也不要在混频次数不足的情况下进行，否则就有可能在UTXOs之间建立可推断的链接，从而影响共混周期前后的UTXOs。如果对这些操作有疑问，最好的做法不是合并混合后的UTXO，而是将它们逐个转移到硬件钱包中，每次都生成一个新的空白地址。再次提醒，记得给收到的每个 UTXO 贴上标签。

使用未广泛使用的脚本将混合后的 UTXO 转移到钱包也是不可取的。例如，如果您使用 `P2WSH` 脚本从多位数钱包进入漩涡，那么您与其他拥有相同类型钱包的用户混在一起的可能性就很小。如果您将您的后混合币重新混合到同一个多位钱包中，您的混合比特币的保密性将大大降低。除了脚本之外，还有许多其他的钱包指纹也会欺骗你。

与任何比特币交易一样，重要的是不要重复使用接收地址。每笔新交易都必须用一个新的空白地址接收。

最简单、最安全的解决方案是将混合后的UTXO留在**后混合**账户中，让它们重新混合，只在消费时才接触它们。Samurai 和 Sparrow 钱包具有针对所有这些链分析风险的额外保护措施。这些保护措施可帮助您避免犯错。

### 如何管理有毒交流？

接下来，您需要小心管理 doxxic exchange，即没有进入 coinjoin 池的交易所。使用 Whirlpool 所产生的这些有毒 UTXOs 会对您的隐私构成风险，因为它们会在您和 Coinjoin 用户之间建立联系。因此，必须谨慎管理这些UTXO，不要将它们与其他UTXO，尤其是混合UTXO结合在一起。

下面是一些使用它们的策略：


- 将其混合到较小的水池中：** 如果有毒的UTXO足够大，可以单独放入一个较小的水池中，可以考虑将其混合。这通常是最好的选择。不过，将多个有毒UTXO合并到一个池子中并不可取，因为这可能会将不同的条目联系起来；
- 将其标记为 "不可消费"：** 另一种方法是停止使用，在专用账户中将其标记为 "不可消费"，然后直接使用。这样可以确保你不会不小心花掉它们。如果比特币价值上升，可能会出现更适合你的有毒 UTXOs 的新池；
- 捐款：** 考虑向开发比特币及相关软件的开发者捐款，无论多少。您也可以向接受 BTC 的协会捐款。如果管理有毒的 UTXOs 显得过于复杂，您可以直接将它们扔掉，然后进行捐赠；
- 购买礼品卡：** [Bitrefill](https://www.bitrefill.com/)等平台允许您用比特币兑换礼品卡，这些礼品卡可以在各种商家使用。这也是一种放弃有毒 UTXOs 而不损失相关价值的方法；
- 将它们整合到 Monero 上：** Samourai 钱包提供 BTC 和 XMR 之间的原子交换服务。这非常适合管理有毒的UTXO，将它们整合到莫奈罗上，同时不影响通过CIOH的保密性，然后再将它们发送回比特币。不过，由于流动性的限制，这一方案在采矿费和溢价方面可能成本较高；
- 将它们发送到闪电网络：** 将这些UTXO传输到闪电网络，以享受交易费用的降低，这可能是一个很有吸引力的选择。不过，这种方法可能会泄露某些信息，具体取决于您如何使用闪电网络，因此应谨慎使用。

### 如何使用惠而浦？

2024 年 4 月 24 日，Samourai 钱包的创始人被捕，其服务器也被查封，此后，漩涡工具已无法使用，即使拥有自己 Dojo 的用户也无法使用。在此之前，Samourai 钱包和 Sparrow 钱包可以使用该工具。

![BTC204](assets/fr/149.webp)

不过，根据试验结果，该工具仍有可能在未来几周内重新启用，或者以不同的方式重新推出。无论如何，我认为比特币接币市场不会长期没有供应，因为需求是存在的。更重要的是，由于惠而浦的模式在保密性方面是最先进的，它肯定会成为未来其他实施模式的首选。

我们一直在密切关注这一案件以及相关工具的发展。请放心，一旦有新的信息，我们将及时更新本培训课程。

在下一章中，我们将了解什么是 "anonsets"、这些指标是如何计算的，以及它们如何帮助我们估算联接循环的效率。

https://planb.network/tutorials/privacy/on-chain/coinjoin-sparrow-wallet-84def86d-faf5-4589-807a-83be60720c8b

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef

https://planb.network/tutorials/privacy/on-chain/coinjoin-dojo-c4b20263-5b30-4c74-ae59-dc8d0f8715c2

## 匿名套

<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>


在研究了共同连接的工作原理和有效混合所涉及的问题之后，我们现在要了解如何衡量其有效性。我们如何确定共同连接过程是否有效，以及某个部分获得了多大程度的匿名性？本章我们将通过匿名集或 "anonsets "来找出答案。

### 提醒您 coinjoin 的作用

联合拼接的作用在于，它能够将你的部分嵌入一组无法区分的部分中，从而产生似是而非的可抵赖性。这一行动的目的是打破从过去到现在以及从现在到过去的可追溯性联系。

换句话说，如果分析师知道您在加入硬币周期进入时的初始交易（"Tx0"），那么他就无法确定您在混币周期退出时的UTXO（周期进入到周期退出分析）。

![BTC204](assets/fr/150.webp)

相反，如果分析师知道您在硬币连接周期退出时的UTXO，那么他一定无法确定周期进入时的原始交易（周期退出到周期进入分析）。

![BTC204](assets/fr/151.webp)

为了评估分析人员将过去和现在联系起来的难度，我们需要量化你的部分所隐藏的同质部分组的大小。这一指标告诉我们有多少分析具有相同的概率。因此，如果正确的分析被淹没在其他 3 个概率相同的分析中，则您的隐藏程度很低。另一方面，如果正确的分析是在一组 2 万个相同概率的分析中找到的，那么你的部分就隐藏得很好。这些群组的大小代表了被称为 "anonsets "的指标。

### 了解不结盟国家

匿名集被用作评估特定 UTXO 保密程度的指标。更具体地说，它们衡量的是包括所研究部分在内的集合中无法区分的UTXO的数量。对同质 UTXOs 集的要求意味着，anonsets 通常是在共接循环中计算的。由于漩涡式联合接合的一致性，这些指标的使用与漩涡式联合接合尤其相关。

必要时，可以使用匿名集来判断共同连接的质量。大的匿名集意味着高水平的匿名性，因为在同质集合中很难分辨出特定的UTXO。

有两种类型的自动设置：


- 未来的ONSET ;**
- 回顾anonset.**

### 潜在的不发病者

前瞻性anonset表示在周期开始时的UTXO中，周期结束时研究的UTXO所隐藏的组的大小，即在该组中存在的无法区分的部分的数量。该指标的名称为 "前瞻性指标"。

该指标衡量房间保密性对过去到现在（输入到输出）分析的抵抗力。

![BTC204](assets/fr/152.webp)

该指标用于估算UTXO 受保护的程度，以防有人试图重建其在联合进程中从进入点到退出点的历史。

例如，如果您的交易参与了第一个加入硬币的周期，并完成了两个递减周期，那么您的硬币的预期停止时间将是 `13` ：

![BTC204](assets/fr/153.webp)

例如，让我们想象一下，在硬币连接周期开始时，我们的硬币的预期不确定性为 `86,871`。实际上，这意味着它隐藏在`86,871`个无法区分的部分中。对于一个外部观察者来说，如果他知道这枚硬币在硬币连接周期开始时的情况，并试图追踪它的出口，他将面临`86,871`个可能的UTXO，每个都有相同的概率是他正在寻找的硬币。

![BTC204](assets/fr/154.webp)

### 溯及既往

追溯性失效表明，在周期结束时了解UTXO，特定部件可能的来源数量。该指标衡量零件的保密性对从现在到过去（从输出到输入）分析的阻力，即分析人员在联合循环之前追溯零件来源的难度。这一指标的名称是 "后向保密性"，或 "后向指标"。

![BTC204](assets/fr/155.webp)

通过了解您在周期退出时的UTXO，回溯分析可以确定可能构成您进入币合周期的潜在Tx0交易的数量。在下图中，这相当于所有橙色气泡的总和。

![BTC204](assets/fr/156.webp)

例如，假设我们的硬币连接部分的追溯起始时间为 `42,185`。实际上，这意味着该UTXO有`42,185`个潜在来源。如果外部观察者在周期结束时识别出这枚硬币，并试图追踪其来源，他或她将面临`42,185`个可能的来源，所有这些来源成为所寻找的来源的概率相同。

![BTC204](assets/fr/157.webp)

### 如何计算onsets？

对于小型集合，可以使用区块资源管理器手动计算 anonsets。然而，对于较大的anonsets，就必须使用专门的工具了。据我所知，唯一能完成这项任务的软件是*Whirlpool Stats Tool*，这是一个由 Samourai 和 OXT 团队开发的 Python 工具。不幸的是，在 Samourai 创始人被捕和用于从区块链中提取数据的 OXT 中断后，该工具目前已停止使用。

![BTC204](assets/fr/158.webp)

正如我们在本章中所看到的，只有在币合结构存在一定的同质性的情况下，才能计算出anonsets。在下一章中，我们将了解如何量化比特币交易中的这种同质性，无论是币合还是更传统的交易。

https://planb.network/tutorials/privacy/analysis/wst-anonsets-0354b793-c301-48af-af75-f87569756375

## 熵

<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>


正如我们在 "币合 "一节中所看到的，UTXOs 在输入和输出中的同质性在提高比特币交易的保密性方面发挥着重要作用。面对区块链分析，这一参数创造了一种似是而非的可抵赖性。有几种方法可以用来测量这种同质性，但在我看来，最有效的方法之一是使用由 OXT 和 Samourai 钱包团队开发的*Boltzmann*工具提供的指标，尤其是交易的熵。这就是我们将在本章详细介绍的内容。

与根据一组交易计算的无交易集不同，这里介绍的指标侧重于单笔交易，无论是硬币连接还是更传统的交易。

### 解释的数量

在比特币交易中可以观察到的第一个指标是面对外部观察者分析时可能出现的解释总数。考虑到交易中涉及的UTXO的值，该指标显示了输入与输出相关联的方式的数量。换句话说，它决定了从外部观察者分析的角度来看，一笔交易在比特币流中可能引起的解释数量。

例如，一个有 1 个输入和 2 个输出的简单支付交易只有一种解释，即输入 #0 为输出 #0 和输出 #1 提供资金。没有其他可能的解释：

![BTC204](assets/fr/159.webp)

另一方面，惠而浦 5x5 角有 1,496 美元的可能组合：

![BTC204](assets/fr/160.webp)

Whirlpool Surge Cycle 8x8 coinjoin 有 9,934\,563 美元的可能解释：

![BTC204](assets/fr/161.webp)

### 熵

根据比特币交易的解释次数，我们可以计算出它的熵。

在密码学和信息的一般情况下，熵是对与数据源或随机过程相关的不确定性或不可预测性的定量测量。换句话说，熵是一种衡量信息难以预测或猜测程度的方法。

在区块链分析的具体语境中，熵也是一个指标的名称，它源于香农熵，[由 LaurentMT 发明](https://gist.github.com/LaurentMT/e758767ca4038ac40aaf)，可以计算比特币交易。

当一项交易存在大量可能的解释时，参考其熵往往更有意义。这一指标衡量的是分析师对交易的确切配置缺乏了解。换句话说，熵越高，分析师就越难识别比特币在输入和输出之间的流向。

在实践中，熵揭示了从外部观察者的角度来看，一笔交易是否仅根据输入和输出金额，而不考虑其他外部或内部模式和启发式方法，就能呈现出多种可能的解释。因此，熵越高，交易的保密性就越高。

熵的定义是可能组合数的二进制对数。下面是使用的公式，其中$E$为交易熵，$C$为可能的解释数：

$$
E = \log_2(C)
$$

在数学中，二进制对数（2 进制对数）是 2 的指数化运算的逆运算。换句话说，$x$ 的二进制对数是为得到 $x$ 而必须将$2$ 提升到的指数。因此，该指标用比特表示。

让我们以按照惠而浦 5x5 模型结构的硬币连接交易的熵计算为例，如上一节所述，该模型的可能解释数为 1\,496$ ：

$$
\begin{align*}
C &= 1\,496 \\
E &= \log_2(1\,496) \\
E &= 10.5469 \text{ bits}
\end{align*}
$$

因此，该硬币连接交易的熵值为 10.5469$ 比特，非常令人满意。该值越高，交易可接受的不同解释就越多，从而加强了其保密性。

对于有 $9,934\,563$ 解释的 coinjoin 8x8 交易，熵为 ：

$$
\begin{align*}
C &= 9\,934\,563 \\
E &= \log_2(9\,934\,563) \\
E &= 23.244 \text{ bits}
\end{align*}
$$

我们再以一个经典的支付交易为例，它有 1 个输入和 2 个输出：[1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/fr/162.webp)

就该事务而言，唯一可能的解释是：`(In.0) > (Out.0 ; Out.1)`。因此，其熵为 $0$ ：

$$
\begin{align*}
C &= 1 \\
E &= \log_2(1) \\
E &= 0 \text{ bits}
\end{align*}
$$

### 效率

根据交易熵，我们还可以计算其保密效率。该指标通过与相同配置下的最佳交易进行比较，来评估交易的效率。

这就引出了 "最大熵 "的概念，即特定事务结构理论上可以达到的最高熵。然后，将最大熵与所分析事务的实际熵进行比较，就能计算出事务效率。

计算公式如下


- e_R$：交易的实际熵，以比特为单位；
- e_M$：事务结构可能存在的最大熵，也以比特为单位；
- Ef$：以比特为单位的交易效率 ：

$$
Ef = E_R - E_M
$$

例如，对于惠而浦 5x5 联接结构，最大熵为 10.5469 美元：

$$
\begin{align*}
E_R &= 10.5469 \\
E_M &= 10.5469 \\
Ef &= E_R - E_M \\
Ef &= 10.5469 - 10.5469 \\
Ef &= 0 \text{ bits}
\end{align*}
$$

该指标也用百分比表示。计算公式如下:


- c_R$ ：可能的实数解释数 ；
- c_M$：同一结构可能出现的最大解释数；
- Ef$：以百分比表示的效率：

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1\,496}{1\,496} \\
E_f &= 100 \%
\end{align*}
$$

100 美元的效率表明，根据交易的结构，交易正在最大限度地发挥其保密潜力。

### 熵密度

熵是衡量交易保密性的一个很好的指标，但它在一定程度上取决于交易中输入和输出的数量。要比较输入和输出数量不同的两个不同事务的熵，我们可以计算熵密度。该指标提供了相对于交易中每个输入或输出的熵的视角。密度有助于评估和比较不同规模交易的效率。

要计算它，我们只需用交易的总熵除以交易涉及的输入和输出总数：


- e_D$：以比特为单位的熵密度；
- e$：以比特为单位的交易熵；
- t$：交易中输入和输出的总数：

$$
E_D = \frac{E}{T}
$$

让我们以惠而浦 5x5 硬盘为例：

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ bits}
\end{align*}
$$

我们也来计算一下 8x8 惠而浦硬币连接的熵密度：

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
E_D &= 1.453 \text{ bits}
\end{align*}
$$

通过分析这两种硬币连接的熵密度，我们可以清楚地看到，即使按元素数量对熵进行归一化处理，"浪涌循环 8x8 "硬币连接也会给分析带来更多的不确定性。

### 波尔兹曼分数

交易中分析的另一个信息是每个元素相对于另一个元素的波尔兹曼分数。这是输入和输出之间的匹配概率表。该表通过波尔兹曼分数显示了特定输入与特定输出之间的条件概率。因此，它是对交易中输入和输出之间发生关联的条件概率的量化衡量，其依据是在一组解释中，该事件的有利发生次数与可能发生的总次数之比。

以惠而浦硬币连接为例，条件概率表将突出显示每个输入和输出之间存在联系的几率，从而对交易中关联的模糊性进行量化衡量：

| % | 输出 0 | 输出 1 | 输出 2 | 输出 3 | 输出 4 |

| ------- | -------- | -------- | -------- | -------- | -------- |

输入 0 | | 34% | 34% | 34% | 34% | 34% | 34% |

| 输入 1 | 34% | 34% | 34% | 34% | 34% | 34% | 输入 1

| 输入 2 | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34

| 输入 3 | 34% | 34% | 34% | 34% | 34% | 34% | 输入 3

| 输入 4 | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34

显然，每个输入都有同等机会与任何输出相关联，这就加强了交易的保密性。

波尔兹曼分数的计算方法是用出现某一事件的解释数除以可用解释总数。因此，要确定输入 #0 与输出 #3（事件出现在 512$ 种解释中）的相关分数，我们的步骤如下：

$$
\begin{align*}
\text{Interpretations (IN.0 > OUT.3)} &= 512 \\
\text{Interpretations totales} &= 1496 \\
\text{Score} &= \frac{512}{1496} \\
\text{Score} &= 34 \%
\end{align*}
$$

如果我们以惠而浦 8x8 浪涌循环硬币连接为例，玻尔兹曼表将如下所示：

| 输出.0 | 输出.1 | 输出.2 | 输出.3 | 输出.4 | 输出.5 | 输出.6 | 输出.7 | 输出.8

|-------|-------|-------|-------|-------|-------|-------|-------|-------|

| in.0 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

| in.1 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

| in.2 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

| 英寸 3 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

| in.4 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23



| 英寸 6 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

| in.7 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

但是，对于只有一个输入和两个输出的简单交易，情况就不同了：

| 输出 0 输出 1

|---------|----------|----------|

| 输入 0 | 100% | 100% |

在这里，我们可以看到每个输出源于输入 0 号的概率是 100%。因此，较低的概率反映了更高的保密性，淡化了输入和输出之间的直接联系。

### 确定性链接

我们还可以计算交易中确定性联系的数量。这一指标揭示了在所分析的交易中，有多少输入和输出之间的联系是不确定的，概率为 100%。然后，可以通过计算确定性链接的比率来完善这一指标。通过该比率可以了解这些确定性链接在交易总链接中的权重。

例如，惠而浦投币交易的输入和输出之间没有确定性链接，因此显示的指标为 0 个链接，比率为 0%。相反，在我们研究的第二种简单支付交易（有一个输入和两个输出）中，指标告诉我们有两个确定性链接，比率达到 100%。换句话说，由于输入和输出之间没有直接和无可争议的联系，指标为 0 表明保密性极好。

### 如何计算这些指标？

使用我提供的公式手动计算这些指标相对简单。困难主要在于确定交易的可能解释数量。对于经典交易，这种计算可以手工完成。然而，对于联合交易来说，这项工作要复杂得多。

在此之前，OXT 和 Samourai 团队开发了一个名为_Boltzmann Calculator_的 Python 工具，可以自动计算比特币交易的所有这些指标：

![BTC204](assets/fr/163.webp)

也可以使用 KYCP.org 网站进行这些分析：

![BTC204](assets/fr/164.webp)

遗憾的是，在 Samourai 创始人被捕后，这些工具已无法使用。

既然我们已经详细介绍了 Cooinjoins，我们将在课程的最后一节了解比特币上的其他隐私保护技术。我们将学习支付连接、特定的伪比特币连接交易类型、静态地址协议，以及不是在交易本身层面，而是在节点网络层面加强保密性的措施。

https://planb.network/tutorials/privacy/analysis/boltzmann-entropy-738e45af-18a6-4ce6-af1a-1bf58e15f1fe

# 了解其他先进保密技术的挑战

<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## Payjoin 交易

<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>


Coinjoin 是目前在链分析中将不确定性引入零件追踪的最有效方法。正如我们在前几章中所看到的，要想获得高性能的组合，输入和输出必须尽可能同质。此外，重要的是部件要尽可能地集成到一个大的组中，以最大限度地实现共集。因此，要使共同连接有效，必须涉及大量统一的部件。如此多的要求意味着币合交易有一个非常严格的结构：金额事先是固定的，所有参与者都必须遵守，以保证过程的统一性。此外，硬币接合要求所有参与者和协调者在交易构建过程中保持同步。

这些要求使得 Coinjoin 不适合直接支付。例如，如果您在 Coinjoin 池中有 100 万萨特币，直接用它来支付会很复杂。它需要与其他参与者和协调者同步，以便在您需要付款时建立协作交易，而且购买金额必须与您的硬币价值完全一致，这几乎是不可行的。因此，coinjoin 交易就其本质而言是一种协作扫码交易，即通常我们在输出中发现的输入的所有者是相同的。

不过，如果能有一种交易结构，既能以实用的方式进行支付，又能在链式分析中引入疑问，那将会很有意思。这正是我们将在本章和下一章探讨的问题。

### 什么是 payjoin 交易？

payjoin 是一种特殊的比特币交易结构，它通过与收款人合作来增强用户消费时的隐私。

2015年，LaurentMT首次提出这种方法，称其为“*steganographic transactions*”，详见[此处](https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt)的文档。此技术随后被 Samourai Wallet 采用，并于2018年成为第一个使用 Stowaway 工具实现该功能的钱包客户端。payjoin 的概念也出现在 [BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki)、[BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki) 和 [BIP77](https://payjoin.org/docs/how-it-works/payjoin-v2-bip-77/) 中。多个术语被用于描述 payjoin：

- Payjoin ；
- 偷渡者
- P2EP（*支付到终点*） ；
- 加密交易。

payjoin 的特别之处在于它能够生成乍看之下很普通的交易，但实际上是两个人之间的迷你 Coinjoin。为了实现这一目标，交易结构将收款人与实际发款人一起纳入输入。这样，收款人就在交易中间向自己支付了一笔款项，而这笔款项本身也使他能够获得支付。

让我们举个例子来更好地理解这个过程。爱丽丝用 10 000 萨特的UTXO 购买了一个 4 000 萨特的法棍，并选择了付费加入。她的面包师鲍勃加入了属于他的 15000 萨特的UTXO 作为输入，除了爱丽丝的 4000 萨特外，他还收回了全部作为输出的UTXO。

![BTC204](assets/fr/165.webp)

在这个例子中，面包师鲍勃输入 15000 沙特，输出 19000 沙特，差额正好是 4000 沙特，也就是长棍面包的价格。爱丽丝输入 10,000 沙特，输出 6,000 沙特，差额为-4,000 沙特，即法棍的价格。为了简化示例，我特意省略了交易中的采矿成本。

### payjoin 是做什么用的？

payjoin 交易实现了两个目标，使用户能够提高支付的保密性。

首先，payjoin 的目的是通过在链分析中制造诱惑来误导外部观察者。这得益于 CIOH 启发式（*共同输入所有权启发式*）。正如我们在第 3 部分中所看到的，通常情况下，当区块链上的一笔交易有多个输入时，就会假定所有这些输入都属于同一个实体或用户。

因此，当分析人员检查付款连接交易时，会认为所有输入都来自同一个人。然而，这种看法是错误的，因为收款人也与实际付款人一起提供投入。因此，对链式分析的解释就会发生偏差，结果证明是错误的。

让我们以支付长棍面包的 payjoin 交易为例：

![BTC204](assets/fr/166.webp)

看到区块链上的这笔交易，外部观察者按照区块链分析的通常启发式方法会做出如下解释："*Alice合并了2个UTXO作为交易输入，以便向Bob支付19,000萨特*"。

![BTC204](assets/fr/167.webp)

这种解释显然是不正确的，因为大家已经知道，输入中的两个 UTXO 并不属于同一个人。一个来自买法棍的爱丽丝，另一个来自面包师鲍勃。

![BTC204](assets/fr/168.webp)

这样，外部观察员的分析就会被引向一个错误的结论，从而确保利益攸关方的保密性。

### 加密交易

支付连接的第二个目的是误导外部观察者，让他们不知道实际支付的金额。通过研究交易的结构，分析人员可能会认为支付的金额等同于其中一个输出的金额。

如果我们回到购买法棍的例子，分析员会认为付款金额要么与 6000 沙特的UTXO 对应，要么与 19000 沙特的UTXO 对应。在这种情况下，分析员更倾向于认为支付的金额是 19 000 萨特，因为输出中有 2 个UTXO，其中至少有一个大于 6 000 萨特（使用 2 个UTXO 支付 6 000 萨特没有任何逻辑上的理由，因为单个UTXO 就足以支付这笔款项）。

![BTC204](assets/fr/169.webp)

但实际上，这种分析是有缺陷的。付款额与任何产出都不对应。事实上，它是收款人产出的 UTXO 与收款人投入的 UTXO 之间的差额。

![BTC204](assets/fr/170.webp)

在这方面，payjoin 交易属于隐写术的范畴。它可以将交易的真实金额隐藏在作为诱饵的虚假交易中。

隐写术是一种将信息隐藏在其他数据或物体中，使人无法察觉隐藏信息存在的技术。例如，可以将秘密信息隐藏在无关文本的一个点中，使肉眼无法察觉（这就是 [microdot](https://fr.wikipedia.org/wiki/Micropoint) 技术）。

加密使信息在没有解密密钥的情况下无法理解，而隐写术则不同，它不会修改信息。信息仍以明文显示。相反，它的目的是隐藏秘密信息的存在，而加密则清楚地揭示了隐藏信息的存在，尽管没有密钥是无法获取的。这就是 payjoin 最初被称为 "隐写交易 "的原因。

可以将密码学与 Coinjoin 相提并论，也可以将隐写术与付费连接相提并论。Coinjoin 具有与加密类似的属性：方法可以识别，但信息无法破译。相反，付费连接则类似于隐写术：理论上可以获取信息，但由于隐藏方法无法识别，因此信息变得不可获取。

### 如何使用 payjoin？

支持 payjoin 的知名软件程序包括 Sparrow Wallet、Wasabi Wallet、Mutiny、BitMask、BlueWallet 和 JoinMarket，以及支付处理器 BTCPay。

![BTC204](assets/fr/171.webp)

最先进的 payjoin 实现工具只有 Samourai 钱包上的 Stowaway。然而，自从软件创始人被捕后，这个工具现在只能部分运行。Stowaway 的优势在于它是一个全面、易用的协议，同时支持接收和发送 payjoins。部分签名交易可以通过扫描几个 QR 码手动交换，也可以通过 Soroban 的 Tor 自动交换。后一种通信方式目前已停止服务。

![BTC204](assets/fr/172.webp)

使用 payjoin 的困难在于它依赖于商家的参与。作为顾客，如果商家不支持 payjoin，你就无法使用。这就给购买过程增加了难度：不仅很难找到接受比特币的商家，如果还要寻找那些支持 payjoin 的商家，情况就变得更加复杂了。

一种解决办法是使用交易结构，在不要求收款人合作的情况下将模糊性引入链分析。这样，我们就能在不依赖商家积极参与的情况下提高支付的保密性。这正是我们将在下一章讨论的内容。

https://planb.network/tutorials/privacy/on-chain/payjoin-sparrow-wallet-087a0e49-61cd-41f5-8440-ac7b157bdd62

https://planb.network/tutorials/privacy/on-chain/payjoin-samourai-wallet-48a5c711-ee3d-44db-b812-c55913080eab

## 支付迷你币

<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>


当你想在保持一定保密性的同时进行支付交易时，payjoin 是一个不错的选择。但正如我们刚才看到的，payjoin 需要收款人的参与。那么，如果收款人拒绝参与 payjoin，或者你根本不想让他们参与，该怎么办呢？一种替代方法是使用石墙或石墙 x2 交易。让我们仔细看看这两种交易。

### 石墙交易

石墙 "是比特币交易的一种特殊形式，旨在通过模仿两个人之间的伪比特币连接来提高用户消费时的保密性，但实际上并不是两个人。事实上，这种交易并不是协作式的。用户可以只使用自己拥有的UTXO作为输入，自行创建。因此，您可以在任何场合创建 "石墙 "交易，而无需与其他用户或收款人同步。

石墙交易的工作原理如下：作为交易的输入，发行人使用 2 个属于自己的UTXO。输出时，交易产生 4 个 UTXO，其中 2 个的金额完全相同。另外 2 个UTXO 将构成外汇。在 2 个相同金额的输出中，只有一个会实际支付给收款人。

因此，石墙交易中只有两种角色：


- 付款的发行人.........；
- 收件人可能不知道交易的具体性质，只是期望从发件人那里得到付款。

让我们举个例子来理解这种交易结构。爱丽丝去面包师鲍勃那里买她的长棍面包，价格是 4000 萨特。她想用比特币付款，同时又想对付款进行某种形式的保密。因此，她决定建立一个石墙交易。

![BTC204](assets/fr/173.webp)

通过分析这笔交易，我们可以看出面包师鲍勃实际上收到了 4000 萨特的长棍面包货款。爱丽丝使用了 2 个UTXO 作为输入：一个 10,000 萨特，一个 15,000 萨特。在产出中，她收回了 3 个UTXO：一个 4000 沙特，一个 6000 沙特，一个 11000 沙特。因此，爱丽丝在这次交易中的净余额为 -4,000 沙特，相当于长棍面包的价格。

在这个例子中，为了便于理解，我故意忽略了采矿费用。实际上，交易成本完全由发行者承担。

### 石墙交易的目标是什么？

石墙结构为交易增加了大量熵，模糊了链式分析的界限。从外观上看，这种交易可能被解释为两个人之间的迷你币合并。但实际上，这是一种支付。因此，这种方法会给链分析带来不确定性，甚至导致错误线索。

让我们以爱丽丝在面包师鲍勃的面包店为例。区块链上的交易是这样的

![BTC204](assets/fr/174.webp)

外部观察者根据常见的链式分析启发法可能会错误地得出结论："*两个人进行了一次小规模的硬币合并，每个人输入一个UTXO，每个人输出两个UTXO*"。从外部分析这一交易并不能得出应用 CIOH 的结论，因为两个相同金额的输出的存在表明了一种硬币合并模式。因此，从外部角度看，CIOH 不适用于这种特殊情况。

![BTC204](assets/fr/175.webp)

这种解释是不准确的，因为大家都知道，一个UTXO 被发送给了面包师鲍勃，2 个UTXO 输入来自爱丽丝，而她恢复了 3 个交换输出。

![BTC204](assets/fr/176.webp)

特别有趣的是，从外部观察者的角度来看，"石墙 "交易的结构与 "石墙 x2 "交易的结构十分相似。

### 石墙交易 x2

石墙 x2 是比特币交易的另一种特殊形式，其目的也是为了提高用户消费时的保密性，但这次是通过与不参与消费的第三人合作来实现的。这种方法就像两个参与者之间的伪比特币连接，同时向第三人付款。

石墙 x2 交易的操作相对简单：我们使用自己手中的UTXO进行支付，并寻求第三方的帮助，后者也使用属于自己的UTXO进行支付。交易最终有四个输出：其中两个输出的金额相等，一个输出到收款人的地址，另一个输出到属于合作者的地址。第三个UTXO 返回到属于合作者的另一个地址，使他能够收回初始金额（对他来说是一个中性的行为，不计挖矿成本），最后一个UTXO 返回到属于我们的地址，构成支付交换。

因此，在石墙 x2 交易中定义了三种不同的角色：


- 实际付款的发行人.........；
- 收件人可能不知道交易的具体性质，只是期望从发件人那里得到付款；
- 合作者，提供比特币，以便对交易分析产生怀疑，同时在最后全额收回自己的资金（对他来说是一个中性的行为，不计挖矿成本）。

让我们回到爱丽丝的例子，她在面包师鲍勃那里买了一条长棍面包，价格是 4000 萨特。她想用比特币支付，同时又要对付款保密。于是她找来了朋友查尔斯（Charles），由他来帮助她完成这个过程。

![BTC204](assets/fr/177.webp)

分析这笔交易，我们可以看到面包师鲍勃实际上收到了 4000 萨特的长棍面包货款。爱丽丝使用了 10 000 萨特的投入，收回了 6 000 萨特的产出，即净余额为-4 000 萨特，这相当于长棍面包的价格。至于查尔斯，他投入了 15 000 萨特，得到了两个产出：一个是 4 000 萨特，另一个是 11 000 萨特，余额为 0。

在这个例子中，为了便于理解，我故意省略了费用。实际上，采矿费一般由付款发行方和捐款方平摊。

### 石墙 x2 交易的目标是什么？

与 "石墙 "结构一样，"石墙 x2 "结构也为交易增加了大量熵，并混淆了链式分析。从外观上看，这样的交易可以被理解为两个人之间的一次小小的投币。但实际上，这是一种支付。因此，这种方法会给链分析带来不确定性，甚至导致错误线索。

让我们以爱丽丝、面包师鲍勃和查尔斯为例。区块链上的交易是这样的

![BTC204](assets/fr/178.webp)

外部观察者根据常见的链式分析启发法，可能会得出错误的结论："*艾丽丝和查尔斯进行了一次小规模的硬币合并，输入各为一个UTXO，输出各为两个UTXO*"。同样，从外部分析这笔交易并不能得出应用 ICOH 的结论，因为两笔相同金额的输出的存在表明了一种币合模式。因此，从外部角度看，CIOH 并不适用于这种特殊情况。

![BTC204](assets/fr/179.webp)

这种解释是不正确的，因为大家都知道，一个 UTXO 已经发送给了面包师鲍勃，爱丽丝只有一个交换输出，而查尔斯有两个。

![BTC204](assets/fr/180.webp)

同样，石墙 x2 公司的交易结构特别有趣的是，从外部观察者的角度来看，它在各方面都与石墙公司的交易相似。

### 石墙 "和 "石墙 x2 "有什么区别？

石墙 X2 交易的工作原理与石墙交易完全相同，只是前者是协作式的，而后者不是。正如我们所看到的，"石墙 X2 "交易涉及第三方（查尔斯）的参与，他不参与支付，但会提供自己的比特币，以提高交易的保密性。在典型的石墙交易中，合作者的角色由发送者承担。

![BTC204](assets/fr/181.webp)

从外部角度看，交易模式完全相同。

![BTC204](assets/fr/182.webp)

这两种交易结构具有完全相同的模式，这意味着即使外部观察者能够识别出 "石墙（x2）" 模式，他也无法获得所有信息。他无法确定两个相同金额的 UTXO 中哪一个与付款相对应。此外，他也无法确定这两个UTXO 的输入是来自两个不同的人（石墙 x2），还是属于合并了这两个UTXO 的同一个人（石墙）。

最后一点是因为 "石墙 x2 "交易与 "石墙 "交易的模式完全相同。从外部看，如果没有额外的背景信息，就无法区分石墙交易和石墙 x2 交易。前者不是合作交易，而后者是合作交易。这就给对其中一项交易的分析增添了更多疑点。

### 石墙和石墙 x2 交易应在何时使用？

当你想使用保密工具来支付一笔费用时，逻辑应该如下：


- 作为优先事项，我们可以选择付费加入；
- 如果商家不支持 payjoins，则可使用石墙 x2 结构与支付之外的其他人进行合作交易；
- 如果找不到人进行 "石墙 x2 "交易，可以只进行 "石墙 x2 "交易，这将模仿 "石墙 x2 "交易的行为。

### 如何使用石墙和石墙 x2 交易？

石墙 "和 "石墙 x2 "交易可在 Samourai 钱包应用程序和 Sparrow 钱包软件上进行。

![BTC204](assets/fr/183.webp)

然而，与支付连接一样，在 Samourai 创始人被捕后，石墙 x2 交易现在只能通过有关各方之间手动交换 PSBT 来进行。遗憾的是，通过 Soroban 进行的自动交换已不再可用。

也可以通过任何比特币钱包软件手动进行此类交易。

在下一章中，我们将学习另一种相对陌生的保密技术，但作为我们已经学习过的技术的补充，它非常有用。

https://planb.network/tutorials/privacy/on-chain/stonewall-033daa45-d42c-40e1-9511-cea89751c3d4

https://planb.network/tutorials/privacy/on-chain/stonewall-x2-05120280-f6f9-4e14-9fb8-c9e603f73e5b

## 跳弹

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>


比特币交易结构的使用会增加链分析的模糊性，比如coinjoin，尤其有利于隐私保护。然而，正如我们在 "payjoins "一章中所讨论的，coinjoin 交易在链上是自然可识别的。还记得我们在加密和联币之间做的类比吗：当一个文件被加密时，发现加密文件的第三方无法访问其内容，但可以清楚地识别出该文件已被修改以隐藏其内容。这同样适用于联锁交易：当分析师检查联锁交易时，虽然他或她无法在输入和输出之间建立直接联系（反之亦然），但他或她可以识别出观察到的交易是联锁交易。

根据您打算如何在接币周期后使用您的部分，它已经历这一过程的事实可能会造成问题。例如，如果您打算在受监管的交易所平台上出售您的币，但它最近经历了一次接币，平台的链分析工具就会检测到这一事实。平台可能会拒绝接受您的UTXO币，甚至要求您做出解释，您的账户有可能被暂停或资金被冻结。在某些情况下，平台还可能将您的行为报告给国家机关（例如，法国 TRACFIN 对 PSAN 的要求）。

![BTC204](assets/fr/184.webp)

为了避免这种情况，我们需要一种能够模糊比特币过去痕迹的工具，以恢复某种形式的可替代性。这正是反弹的目的。

![BTC204](assets/fr/185.webp)

### 什么是跳弹？

反弹是一种技术，包括对自己（扫货）进行数次虚假交易，以模拟比特币所有权的转移。这种工具与我们讨论过的其他交易结构不同，它不是获得预期的匿名性，而是一种追溯的匿名性。实际上，"回弹 "模糊了比特币的特殊性，这种特殊性可能会影响比特币的可替代性。

为了消除过去事件在硬币上留下的印记（如硬币接合周期），"回弹 "会连续执行四次交易，让用户在不同的地址向自己转账。

![BTC204](assets/fr/186.webp)

在这一系列交易之后，回弹工具最终会将比特币运送到最终目的地，如交易所平台。

![BTC204](assets/fr/187.webp)

这样做的目的是拉开影响硬币可替代性的距离，例如硬币连接交易和最终支出行为，后者可能会因为硬币的过去而拒绝接受这枚硬币。因此，链分析工具可能会得出结论：在事件发生后，硬币的所有权可能发生了变更，并认为这枚硬币是可替代的。在币合的情况下，区块链分析工具可以认为发送比特币和进行币合的不是同一个人，因此没有必要对发送者采取行动。

![BTC204](assets/fr/188.webp)

### 它为什么有效？

面对这种跳弹方法，我们可以想象，链式分析软件会在四次跳弹之后进行更深入的检查。然而，这些平台在优化检测阈值时面临两难选择。它们必须设定一个跳数限制，在这个跳数限制之后，它们才会认为可能发生了属性变化，并忽略与之前事件（如共同连接）的联系。

![BTC204](assets/fr/189.webp)

然而，设定这一阈值是有风险的：观察到的跳转次数每增加一次，假阳性的数量就会呈指数级增长，即被错误地标记为事件参与者的个人，实际上该操作是由其他人执行的。这种情况会给这些公司带来重大风险，因为误报会导致不满，从而使受影响的客户转向竞争对手。从长远来看，过高的检测门槛会导致平台失去比竞争对手更多的客户，从而威胁到平台的生存。因此，对于这些平台来说，增加所观察到的跳转次数是一件复杂的事情，而 4 次跳转往往足以反驳它们的分析。

这里观察到的现象与六度分隔理论有些类似。

六度分隔理论认为，地球上的每一个人都通过最多由六个中间人组成的关系链与其他任何人联系在一起。因此，只要通过六个人，每个人都认识下一个人，就可以联系到世界上的任何一个人。

在比特币交易中，我们也发现了类似的现象。通过追踪足够数量的比特币交易，我们不可避免地会遇到币合。跳跳板方法利用了这一原理，使用的跳数比交易所平台能够合理追踪的跳数更多。如果平台决定追踪更多的交易，那么就可以简单地增加一个跳数来规避这一措施。

### 何时以及如何使用跳弹？

最常见的跳票情况是，需要掩盖之前在自己拥有的 UTXO 上参与过合币。在理想情况下，最好避免向受监管的实体转移已进行过合币的比特币。不过，如果您发现自己别无选择，尤其是急需以国家货币变现比特币时，"跳票 "不失为一种有效的解决方案。

这种方法不仅对拼接有效，而且对任何其他可能影响部件可互换性的标记也很有效。

这种跳转方法的创意最初来自 Samourai 钱包团队，他们将其整合到自己的应用程序中，实现了流程自动化。这项服务在 Samourai 并不是免费的，因为一次跳转需要 100,000 萨特的服务费，外加挖矿成本。因此，建议大额转账时使用该服务。

![BTC204](assets/fr/190.webp)

武士 "应用程序提供两种跳弹变体：


- 强化跳转或 "交错交付"，其优点是将 Samurai 服务费分摊到连续的五笔交易中。这种方法还能确保每笔交易都在不同的时间进行广播，并记录在不同的区块中，尽可能模仿物主变更的行为。这种方法虽然速度较慢，但对那些不着急的人来说更可取，因为它通过加强对链式分析的抵抗力，最大限度地提高了跳转的效率；

![BTC204](assets/fr/191.webp)


- 经典的跳转法旨在快速执行操作，在较短的时间间隔内广播所有交易。因此，与加强型方法相比，这种方法的保密性和抗分析能力较差。它只能用于紧急货运。

![BTC204](assets/fr/192.webp)

跳转比特币简单地说就是把比特币发送给自己。你完全可以在任何钱包软件上手动发送比特币，而无需使用专门的工具。你所要做的就是连续向自己发送相同的比特币，每次都使用一个新的空白地址。

在下一章中，我们将探讨不同的所有权秘密转让技术。这些方法在操作和结果上都与我们迄今为止研究过的方法截然不同。

https://planb.network/tutorials/privacy/on-chain/ricochet-e0bb1afe-becd-44a6-a940-88a463756589

## 所有权的秘密转让

<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>


比特币的另一项保密技术是所有权的秘密转移。这种方法的目的是将比特币的所有权从一个人转移到另一个人，反之亦然，而交易在区块链上是不可见的。让我们来看看现有的不同技术及其优缺点。

### 硬币交换

Coinwap 基于一个相对简单的概念：它使用智能合约促进两个用户之间比特币所有权的转移，无需信任，也不会在区块链上明确显示这种转移。

![BTC204](assets/fr/193.webp)

让我们想象一个有爱丽丝和鲍勃的天真例子。爱丽丝持有 1 BTC，私钥为 $A$，鲍勃也持有 1 BTC，私钥为 $B$。理论上，他们可以通过外部通信渠道交换私钥，进行秘密转账。

![BTC204](assets/fr/194.webp)

然而，这种天真的方法会带来很高的信任风险。交换后，爱丽丝会保存一份 $A$ 私钥的副本，一旦密钥落入鲍勃手中，爱丽丝就可以用它来窃取比特币。

![BTC204](assets/fr/195.webp)

此外，无法保证爱丽丝不会收到鲍勃的私人密钥 $B$，也不会在交换中传递她的私人密钥 $A$。因此，这种交换依赖于双方之间的过度信任，无法有效确保所有权的安全秘密转移。

![BTC204](assets/fr/196.webp)

为了解决这些问题，并实现互不信任的各方之间的交换，我们将改用智能合约系统。智能合约是一个程序，在满足预定义条件时自动执行。在我们的案例中，这可以确保财产交换自动进行，而无需相互信任。

这可以通过 HTLC（*哈希时间锁定合约*）或 PTLC（*点时间锁定合约*）来实现。这两种协议的操作方式类似，都是使用一个时间锁定系统，确保交换要么成功完成，要么完全取消，从而保护双方资金的完整性。HTLC 和 PTLC 的主要区别在于 HTLC 使用哈希值和预图像来确保交易安全，而 PTLC 使用适配器签名。

在 Alice 和 Bob 之间使用 HTLC 或 PTLC 进行换币的情况下，交换是安全进行的：要么交换成功，双方都收到对方的 BTC，要么交换失败，双方都保留自己的 BTC。这样，任何一方都不可能欺骗或窃取对方的 BTC。

> *HTLC 也是通过闪电网络的双向通道进行安全支付的机制*。
在这种情况下，适配器签名的使用尤为有趣，因为它可以省去传统的脚本（这种机制有时被称为 "无脚本脚本"）。这一功能降低了与交换相关的成本。适配器签名的另一个主要优点是不需要交易双方使用共同的哈希值，从而避免了在某些类型的交换中暴露双方之间的直接联系。

### 适配器签名

适配器签名是一种加密方法，它将有效签名与称为 "适配器签名 "的附加签名整合在一起，以揭示秘密数据。这种机制的设计方式是，只要知道以下三个要素中的两个：有效签名、适配签名和秘密，我们就能推断出缺少的第三个要素。这种方法的一个有趣特性是，如果我们知道同伴的适配器签名以及与用于计算该适配器签名的秘密相关的椭圆曲线上的特定点，我们就可以推导出自己的适配器签名，该签名将与相同的秘密兼容，而无需直接访问秘密本身。

在币币交换中，适配器签名的使用可以在参与者之间同时披露两个敏感信息，从而避免了相互信任的需要。让我们以爱丽丝和鲍勃为例来说明这一过程，他们希望交换各自拥有的 1 BTC，但彼此互不信任。他们使用适配器签名来消除交换中相互信任的需要。他们是这样做的


- 爱丽丝通过创建一个向鲍勃发送 1 BTC 的 $m_A$ 交易来启动交换。她使用自己的私人密钥 $p_A$ ($P_A = p_A \cdot G$) 、nonce $n_A$ ($N_A = n_A \cdot G$) 和秘密 $t$ ($T = t \cdot G$) 生成一个签名 $s_A$，以验证这笔交易：

$$s_A = n_A + t + H(N_A + T \parallel P_A \parallel m_A) \cdot p_A$$


- 爱丽丝通过从其真实签名 $s_A$ 中减去秘密 $t$ 来计算适配器签名 $s_A'$：

$$s_A' = s_A - t$$


- 爱丽丝向鲍勃发送她的签名适配器 $s'_A$、她的未签名交易 $m_A$、与秘密对应的点（$T$）和与非 Cce 对应的点（$N_A$）。这些元素构成了所谓的 "适配器"。值得注意的是，仅凭这些信息，鲍勃无法恢复爱丽丝的 BTC。
- 不过，鲍勃可以检查爱丽丝是否试图窃取他的信息。为此，他会检查爱丽丝的适配签名 $s_A'$ 是否与提议的交易 $m_A$ 相对应。如果下式正确，那么他就可以确定爱丽丝的签名适配器是有效的：

$$s_A' \cdot G = N_A + H(N_A + T \parallel P_A \parallel m_A) \cdot P_A$$


- 这一验证为鲍勃提供了足够的保证，使他可以完全放心地继续交换。然后，他创建自己的交易 $m_B$，打算向爱丽丝发送 1 BTC，并生成自己的适配签名 $s_B'$，该签名也将与相同的秘密 $t$ 相关联。在这一阶段，只有爱丽丝知道 $t$ 的值，鲍勃只知道爱丽丝传送给他的相应点 $T$：

$$s_B' = n_B + H(N_B + T \parallel P_B \parallel m_B) \cdot p_B$$


- 鲍勃向爱丽丝发送他的适配器签名 $s_B'$、未签名的交易 $m_B$，以及与秘密对应的点 ($T$) 和与非 Cce 对应的点 ($N_B$)。知道秘密 $t$ 的爱丽丝现在可以将鲍勃的适配签名 $s_B'$ 与该秘密结合起来，为交易 $m_B$ 生成有效签名 $s_B$，从而将鲍勃的 BTC 转给她：

$$s_B = s_B' + t$$

$$(s_B' + t) \cdot G = N_B + T + H(N_B + T \parallel P_B \parallel m_B) \cdot P_B$$


- 爱丽丝在比特币区块链上广播这个签名为 $m_B$ 的交易，以获取鲍勃承诺的 BTC。当鲍勃在区块链上看到这笔交易时，他可以提取签名 $s_B = s_B' + t$。有了这些信息，鲍勃就能分离出他所需要的著名秘密 $t$：

$$t = (s_B' + t) - s_B' = s_B - s_B'$$


- 而这个秘密 $t$ 是鲍勃从爱丽丝的适配器签名 $s_A'$ 生成有效签名 $s_A$ 所缺少的唯一元素。该签名验证了 $m_A$ 交易，该交易将 BTC 从 Alice 发送给 Bob。然后，鲍勃计算出 $s_A$，并在区块链上广播 $m_A$ 交易：

$$s_A = s_A' + t$$

$$(s_A' + t) \cdot G = N_A + T + H(N_A + T \parallel P_A \parallel m_A) \cdot P_A$$

让我们来总结一下适配器签名在换币交易中是如何工作的。一开始，爱丽丝向鲍勃发送一个未签名的交易，并附带一个适配器，使鲍勃能够验证稍后透露的秘密是否能让他获得比特币。作为回报，鲍勃向爱丽丝发送他自己的未签名交易和适配器。然后，爱丽丝就可以通过广播一个有效的交易来最终确定鲍勃的交易并取回比特币。当这一交易在区块链上发布时，鲍勃就可以提取该秘密，从而解锁爱丽丝的交易。因此，如果爱丽丝发起对鲍勃的比特币的转账，鲍勃反过来也可以访问爱丽丝的比特币，而无需相互信任。

请注意，[Gregory Maxwell 于 2013 年 10 月在 BitcoinTalk 上](https://bitcointalk.org/index.php?topic=321228.0)首次提出了换币。

### 原子交换

与币币交换类似，使用相同类型的智能合约，也可以进行原子交换。原子交换使两个用户之间可以直接交换不同的加密货币，如 BTC 和 XMR，而无需信任或中介的干预。这些交换之所以被称为 "原子交换"，是因为它们只有两种可能的结果：要么交换成功，双方都满意；要么交换失败，双方都保留各自原有的加密货币，无需信任对方。

![BTC204](assets/fr/197.webp)

原子交换和硬币交换有着相似的操作方法，在保密性方面也有着相同的优缺点。事实上，从比特币的角度来看，原子交换与分两个阶段进行的硬币交换类似。首先，我们将自己的 BTC 兑换成另一种加密货币，然后这种加密货币可以兑换成其他 BTC。最后，我们收回另一个用户的 BTC。这就是为什么在分析保密性问题时，我将这两个协议归入专有秘密交换类别的原因。

![BTC204](assets/fr/198.webp)

但要注意的是，与币币交换不同，原子交换在可用流动性方面可能存在不平衡，尤其是在 BTC/XMR 交易所。一般来说，将比特币兑换成其他币比较容易，因为比特币的需求量很大，这使得这种兑换方向的溢价很低。然而，由于需求量较低，将替代币兑换成 BTC 可能会更加复杂，往往会导致很高的溢价。

最后，当原子交换涉及链上比特币和闪电网络上的比特币时，我们称之为 "海底交换"。

### 它真的有用吗？

所有权的秘密转移，如硬币交换和原子交换，具有骗过链分析启发法的优势。这些方法可以表明交易涉及的是同一个用户，而实际所有权已经易手。然而，这些方法的主要缺点是，如果不使用额外的技术来破坏硬币的历史记录，风险会非常大。

事实上，当爱丽丝与鲍勃进行换币或原子交换时，她将自己拥有的比特币与鲍勃的比特币进行交换。在原子交换的情况下，交换包括一个替代币，但原理是一样的。因此，爱丽丝最终得到的是 B$ 币，而鲍勃得到的是 A$ 币。这增加了链分析的疑点，但币的历史仍然是可追溯的。如果分析师检查了 $A$ 部分，他或她就可以追踪爱丽丝之前的活动，反之亦然。

![BTC204](assets/fr/199.webp)

从爱丽丝的角度来看，B$硬币的历史可能会被某些实体认为是可疑的。例如，如果鲍勃通过黑客等犯罪行为获得了 $B$币，那么该币就会与他的非法活动联系在一起。这样一来，爱丽丝就会发现自己拥有了一枚硬币，她无法将其转移到受监管的交易所平台，否则她的资金就有可能被冻结，甚至被指控参与鲍勃的犯罪，尽管她与这些犯罪毫无关系。

![BTC204](assets/fr/200.webp)

不可避免的是，那些资金受到当局监控的犯罪分子会青睐币币交换或原子交换等保密方法。通过这些协议，他们可以处理掉被监控的比特币，换取完全可替代的比特币。这也能让他们转移视线，把当局引向其他用户。所以这些人有双重目的

有了 Coinjoin，即使你的币与被监控的比特币混在一起，该币的历史也会被打破，从而提供了一种似是而非的可抵赖性，这在秘密所有权转移协议（如硬币交换或原子交换）中是不存在的。

![BTC204](assets/fr/201.webp)

如果爱丽丝希望避免任何风险，她就必须使用一种方法来破坏 B$硬币的历史，例如通过硬币连接来传递它。这就提出了一个问题，即把所有权的秘密转移和硬币接合结合起来是否有用。硬币连接通过破坏硬币的历史记录，已经为爱丽丝提供了足够的保密性。因此，我认为，如果爱丽丝想要保护自己的隐私，直接进行联币会比先换币再联币更明智。

要使秘密所有权转移方法真正有效，并避免将 $A$ 用户的历史与 $B$ 用户的历史联系起来的风险，矛盾的是，这些方法的使用必须广为人知。如果硬币交换法被广泛使用，而且当局也知道这种普遍做法，那么就可以建立一种可信的否认形式。然而，只要这些转账的使用仍处于边缘化状态，我认为这些方法对用户来说风险仍然太大。

到目前为止，我们主要研究了交易本身层面的保密方法。下一章，我们将研究网络层面和交易传播层面的问题。

## P2P 网络隐私

<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>


在第四部分中，我们讨论了使用完整节点来保护交易机密性的重要性。然而，重要的是要明白，你的节点本身也可能受到攻击，试图获取你的活动信息。因此，在本章中，我们将探讨保护个人隐私的各种措施，这些措施不是在交易本身或比特币流的层面上，而是在网络层面上。

### 蒲公英

避免各种去匿名化攻击的一种方法是使用蒲公英提案。这一广播协议在 BIP156 中正式提出，但从未在比特币上实施过。

蒲公英的理念是提高比特币网络中交易路由的保密性，以应对各种形式的攻击。其主要目的是隐藏最初在网络上广播交易的源节点。披露该节点可以将比特币交易与特定的 IP 地址联系起来（如果该节点在清算网上运行），从而为链分析提供切入点。

比特币上的活动与 IP 地址之间的这种关联给用户的保密性带来了相当大的风险。事实上，许多实体都能轻易地将 IP 地址与个人身份联系起来。这包括政府和互联网服务提供商。更重要的是，这些信息可能会被公开，例如，当一个网站的数据库被黑客攻击时，你的 IP 地址和个人数据就会被泄露。

在经典的比特币操作中，用户在其钱包软件上建立的交易会传输到其个人节点。该节点会立即向其连接的所有对等节点广播新的交易。

![BTC204](assets/fr/202.webp)

然后，这些同行检查交易，确保其符合共识和本地标准化规则。一旦通过验证，每个对等节点就会依次将交易转发给自己的对等节点，以此类推。

![BTC204](assets/fr/203.webp)

等待整合到区块中的交易分布是相当均衡的，在统计学上也是可以预测的。共谋的间谍节点可以利用这一弱点，通过合作监控和分析网络，找出第一个广播交易的节点。如果观察者成功找到源节点，他或她就可以假定交易来自该节点的操作员。这种观察方法可用于将通常匿名的交易与特定的 IP 地址联系起来。

![BTC204](assets/fr/204.webp)

BIP156 的目的就是解决这个问题。为此，它在新交易的传播过程中引入了一个额外阶段，以在大范围公开传播之前保持匿名性。蒲公英首先使用一个 "茎 "阶段，在这个阶段，交易通过节点的随机路径发送。

![BTC204](assets/fr/205.webp)

随后，交易在“Fluff”阶段广播到整个网络。

![BTC204](assets/fr/206.webp)

“茎”和“Fluff”是对交易在网络中传播行为的比喻，其形状和演化类似于蒲公英（英文为“Dandelion”）。

因此，间谍节点可能会将交易追溯到启动“Fluff”阶段（大规模广播）的节点，但该节点并不是最先广播交易的节点，因为它是从茎的最后一个节点接收到交易的。如果间谍节点无法追踪茎部路径，就无法识别源节点。

![BTC204](assets/fr/207.webp)

即使在干节点阶段存在间谍节点，疑点也始终存在，因为间谍一旦遇到扩散图中的诚实节点，就无法确定该节点是原始源还是只是一个中间节点。

![BTC204](assets/fr/208.webp)

这种路由方法模糊了通向源节点的线索，使交易难以通过网络追溯到其源头。因此，蒲公英能限制对手对网络进行去匿名化，从而提高保密性。当交易在 "去梗 "阶段穿过一个对其网络通信进行加密的节点（如 Tor 或 P2P Transport V2）时，这种方法就更加有效。

BIP156 尚未集成到比特币核心中，目前被归类为 "拒绝"。该协议的主要问题之一是，在茎阶段，交易必须通过中间节点转发，然后再进行验证。正如我们所看到的，在正常的比特币模式中，每个节点都会先对交易进行验证，然后再将其转发给同级节点。如果交易不符合节点的共识规则或本地标准化规则，节点就会忽略该交易，不进行分发。这个过程对于抵御 DoS 攻击非常重要，因为只有有效的交易才会被广播到整个网络。无效交易可能会大量产生，导致网络超载，但会在遇到的第一个节点被停止，不会传播。蒲公英的主要风险在于，这种新协议允许在部分网络中广播无效交易，从而为 DoS 攻击引入了新的载体。

### P2P 传输 V2

P2P 传输 V2 是 BIP324 中提出的另一个网络协议。它是比特币 P2P 传输协议的一个新版本，采用了机会加密技术，以提高节点间通信的保密性和安全性。

这一改进旨在解决 P2P 协议基本版本的几个问题。一方面，对于被动观察者来说，它使交换的数据与互联网上流通的其他类型的数据无法区分。其主要目的是防止政府、互联网服务提供商和 VPN 提供商大规模监控比特币用户。这也使得这些实体更难确定互联网用户是否也是比特币用户，即他或她是否在操作一个完整的节点。

P2P V2 还能通过检测数据包中的特定模式，帮助降低审查和攻击的风险。它使在网络层面实施各种类型的 Sybil 攻击变得更加复杂，成本更高。Sybil 攻击是指行为者为了获得不公平的优势而制造多个虚假身份。在比特币网络中，这通常表现为一个行为者控制了大量完整的节点，并积极利用它们来增加连接。Sybil攻击可以是被动的，用于收集信息和破坏用户机密；也可以是主动的，以Eclipse攻击的形式出现。后者将特定节点与网络的其他部分隔离开来，要么审查用户，要么更改其接收的数据。最后，P2P V2 还使 "中间人"（MITM）攻击成本更高，更容易被发现。

P2P V2 实现的加密不包括身份验证，这样就不会增加不必要的复杂性，也不会影响网络连接的无权限性。不过，这种新的 P2P 传输协议能更好地防范被动攻击，并大大提高主动攻击的成本和可探测性。在网络信息中引入伪随机数据流，使攻击者更难审查或操纵通信。

在 2023 年 12 月部署的比特币核心 26.0 版本中，P2P V2 传输被列为一个选项（默认禁用）。在 2024 年 4 月的 27.0 版本中，它被默认启用。可以通过配置文件中的 `v2transport=` 选项进行修改。

### 托尔

避免网络节点失密风险的另一个简单解决方案是完全在 Tor 下运行。

Tor 是一个由中继服务器（节点）组成的网络，用于匿名处理互联网上 TCP 连接的来源。它的工作原理是对数据进行多层加密封装。每个中继节点都会移除一层，以显示下一个节点的地址，直至到达最终目的地。Tor 网络通过防止中间节点知道数据的来源和目的地来确保匿名性，从而使观察者很难追踪用户的活动。

![BTC204](assets/fr/209.webp)

Tor 不仅可以加密数据，还可以掩盖通信的来源和目的地。通过使用 Tor 从你的个人节点进行通信，你可以加强交易的保密性：你的互联网服务供应商无法解密通信，比特币网络中的其他节点也无法识别源节点的 IP 地址。更重要的是，Tor 还可以向 ISP 隐藏你使用比特币的情况。

这种方法的主要风险在于 Tor 是一个独立于比特币的协议。如果你的比特币节点在 Tor 下运行，而 Tor 停止工作，那么你的比特币节点将无法再通信。

此外，需要注意的是，Tor 上的通信速度较慢。由于 IBD（*初始区块下载*）需要大量通信，这种延迟在节点初始启动时尤为明显。因此，使用 Tor 时，你与比特币网络的初始同步时间会大大延长。也可以在清网上执行 IBD，然后在第二步激活 Tor。虽然这种方法会向你的互联网服务供应商透露你的比特币节点的存在，但一旦你切换到 Tor，它就会保护你的个人交易信息。

在探讨了网络层面的各种保密方法后，在接下来的几章中，我还想向大家介绍两种避免地址重复使用的优雅解决方案：BIP47 和静默支付。

## BIP47 和可重复使用的付款代码

<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>


正如我们在第三部分中看到的，地址重复使用是比特币协议中用户保密性的一个严重障碍。为了降低这些风险，我们强烈建议为钱包中收到的每一笔新付款生成一个空白的收款地址。虽然现在使用现代软件和分层确定性钱包可以简化生成新地址的过程，但这种做法似乎有违直觉。

![BTC204](assets/fr/210.webp)

例如，在传统的银行系统中，我们习惯于共享自己的 IBAN，而这个 IBAN 始终保持不变。一旦我们将 IBAN 给了别人，他们就可以向我们发送多笔付款，而无需再次与我们互动。新银行还提供了更多现代化的可能性，例如在贝宝（PayPal）上使用独特的电子邮件地址，或在 Revolut 上使用 RevTags。即使在金融领域之外，我们日常使用的标识符，如邮寄地址、电话号码和电子邮件地址，也都是独一无二的永久性标识符。我们不必在每次新的互动中更新它们。

![BTC204](assets/fr/211.webp)

然而，比特币的工作方式不同：每笔交易都必须生成一个新的接收地址。这种在易用性和保密性之间的妥协可以追溯到比特币白皮书的起源。早在 2008 年底中本聪发表第一版白皮书时，他就已经提醒我们注意这种风险：

**作为额外的防火墙，可以为每笔交易使用新的密钥对，使它们与共同的所有者没有关联

有许多方法可以在一个标识符上接收多笔付款，而无需重复使用地址。每种方法都有自己的利弊。在这些方法中，BIP47 是由 Justus Ranvier 提出并于 2015 年发布的一项提案。该提案旨在创建可重复使用的支付代码，使同一人可以进行多项交易，同时避免地址重复使用。简而言之，BIP47旨在提供一个与唯一标识符一样直观的支付系统，同时维护交易的保密性。

![BTC204](assets/fr/212.webp)

BIP47 并没有直接提高用户的保密性，因为 BIP47 支付提供的保密性与使用空白地址的传统比特币交易相同。但是，它确实使比特币的使用更加方便和直观，而这种方便性通常会影响保密性。多亏了 BIP47，这种易用性实现了与传统交易相同的保密性。这就是为什么 BIP47 是保护隐私的重要工具。

最初，BIP47 被提议整合到 Bitcoin Core 中，但从未真正实施。不过，一些软件应用程序选择自行实施。例如，Samourai 钱包团队开发了自己的 BIP47 实施方案，名为 "PayNym"。

### BIP47 和 PayNym 的一般原则

BIP47 的目的是在不重复使用地址的情况下接收大量付款。它以使用可重复使用的支付代码为基础，使不同的发行者能够向属于另一个用户的单个代码发送数笔付款。因此，收款人不必为每笔交易提供一个新的空白地址，这极大地方便了交换，同时又能保密。

![BTC204](assets/fr/213.webp)

因此，与传统的收件人地址或公开密钥不同，用户可以完全自由地在社交网络或自己的网站上分享自己的支付密码，而不会有任何失密的风险。

要进行交易，双方都需要一个具有 BIP47 实施功能的比特币钱包，如 Samurai Wallet 或 Sparrow Wallet 上的 PayNym。共同使用他们的支付密码会在他们之间建立一个秘密通道。为有效建立这一通道，发行者必须在比特币区块链上进行特定交易，即 "通知交易"（稍后详述）。

将两个用户的支付密码组合起来就会产生共享秘密，而共享秘密又会产生大量独一无二的比特币收款地址（正好是 2^32，即大约 40 亿个）。这样，通过 BIP47 进行的支付实际上并不是针对支付代码本身，而是针对由相关用户的支付代码衍生出的经典收款地址。

因此，支付代码是由组合种子衍生出来的虚拟标识符。在投资组合的分层衍生结构中，付款代码位于第 3 层，即账户层。

![BTC204](assets/fr/214.webp)

BIP47 的派生目标由索引 `47'` (`0x8000002F`) 标识，指的是 BIP47。可重复使用支付代码的派生路径示例如下：

```plaintext
m/47'/0'/0'/
```

为了让您了解付款码的样子，下面是我的付款码：

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

该代码还可以编码为 QR 码，以便于通信，就像传统的接收地址一样。

至于 PayNym Bots（有时在 Twitter 上看到的机器人），它们是支付代码的可视化表示，由 Samourai Wallet 创建。它们是用哈希函数生成的，因此具有近乎唯一性。它们的形式是以 `+` 开头的一小串字符：

```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

这些化身也可以用图像来表示：

![BTC204](assets/fr/215.webp)

虽然这些机器人在 BIP47 框架内没有具体的技术功能，但它们通过提供易于识别的视觉标识，在促进用户互动方面确实发挥了作用。

---
*在本章有关 BIP47 的后续章节中，我们将详细介绍它的工作原理，并特别强调所使用的加密方法。要完全掌握这些略带技术性的解释，首先必须了解高清钱包的结构、密钥推导程序和椭圆曲线加密的基本原理。如果您想深入了解这些概念，Plan ₿ Network 上还有另一门免费培训课程：*。

https://planb.network/courses/46b0ced2-9028-4a61-8fbc-3b005ee8d70f

*我还是建议您关注这些建议，因为了解了 BIP47 的技术运作，您就更容易理解其他类似的建议，我们将在以下章节讨论这些建议*。

---
### 可重复使用的付款代码

如前所述，可重复使用的支付代码位于 HD 钱包的深度 3，这使其在钱包结构中的位置和作用都与 "xpub "类似。

80 个字节的支付密码细分如下：


- 字节 `0`：版本**。对于 BIP47 的第一个版本，该字节设置为 `0x01` ；
- 字节 `1`：位字段**。该空间用于整合特定用途的附加说明。对于传统的 PayNym 用途，该字节设置为 `0x00` ；
- 2 "字节：y`** 的奇偶校验。该字节为 `0x02` 或 `0x03`，表示公钥的序数是偶数还是奇数，因为使用的是压缩公钥；
- 从字节 `3` 到字节 `34`：x`**的值。这些字节代表公钥的尾数。x "和 "y "的奇偶校验值构成完整的压缩公开密钥；
- 从字节 `35` 到字节 `66`：字符串代码**。此空格包含与公钥相关的字符串代码；
- 从字节`67`到字节`79`：填充**。这部分空间用于未来可能的发展。对于当前版本，我们只需在此处放置 0，即可达到 `OP_RETURN` 输出所需的 80 字节大小。

下面是我在上一节中介绍的可重复使用的支付代码的十六进制表示法：

```plaintext
0x010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

![BTC204](assets/fr/216.webp)

接下来，必须在开头加上前缀字节 `P`，以清楚地表明这是一个付款码。这个字节用 `0x47` 表示：

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

最后，为确保付款代码的完整性，会使用 "HASH256 "进行校验和计算，其中包括使用 "SHA256 "函数进行双重散列。然后将哈希值的前四个字节连接到支付密码的末尾：

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

![BTC204](assets/fr/217.webp)

完成这些步骤后，支付代码就准备就绪了。剩下的工作就是将其转换为基数 58，以获得最终版本：

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

在创建支付密码的过程中，我们使用压缩公钥和字符串密码。二者都是从钱包种子中确定性地分层派生出来的。用于实现这一点的推导路径是 ：

```plaintext
m/47'/0'/0'/
```

具体来说，要生成与可重复使用的支付代码相关的压缩公钥和字符串代码，我们首先要从钱包种子中计算出主私钥。然后，我们使用索引 `47 + 2^31`（强化推导）推导出一对子密钥。之后，我们再使用索引 `2^31`（强化推导）连续推导出两对子钥匙。

![BTC204](assets/fr/218.webp)

### 椭圆曲线上的 Diffie-Hellman 密钥交换 (ECDH)

BIP47 的核心加密协议是 ECDH，即 *Elliptic-Curve Diffie-Hellman* 的缩写。这种方法是原始 Diffie-Hellman 密钥交换的一种变体。

Diffie-Hellman 密钥协议是 1976 年推出的一种密钥协议，它能使各自配备一对密钥（公开密钥和私人密钥）的双方就共同的秘密达成一致，即使仅通过公开、不安全的信道进行通信也是如此。

![BTC204](assets/fr/219.webp)

然后，这个共享秘密（在本例中为蓝钥）可用于其他操作。通常情况下，共享密钥可用于加密和解密不安全网络上的通信：

![BTC204](assets/fr/220.webp)

为此，迪菲-赫尔曼使用模块化算术来计算共享秘密。以下是通俗易懂的工作原理：


- 爱丽丝和鲍勃商定了一种共同的颜色，在本例中为黄色，这是公共数据（攻击者知道这种颜色）；
- 爱丽丝选择一种秘密颜色，在本例中是红色，然后将两者混合得到橙色；
- 鲍勃也选择了一种神秘色彩，在本例中是蓝色，并与黄色混合得到绿色；
- 然后，它们交换得到的橙色和绿色。这种交换可以在不安全的网络上进行，并被攻击者观察到；
- 爱丽丝将鲍勃的绿色与自己的秘色混合，得到了棕色；
- 鲍勃用爱丽丝的橙色和秘密的蓝色进行同样的操作，也得到了棕色。

![BTC204](assets/fr/221.webp)

在这个普及版中，棕色代表爱丽丝和鲍勃共享的秘密。想象一下，在现实中，攻击者不可能将橙色和绿色分开，从而找到爱丽丝或鲍勃的秘密颜色。

现在，让我们来看看这个协议究竟是如何运作的，不是用颜色来类比，而是用实数和模块运算！

在介绍 Diffie-Hellman 机制之前，请允许我简要地提醒大家我们需要的两个基本数学概念：


- 质数**是只有两个除数的自然数：1 美元和它本身。例如，7 美元是一个质数，因为它只能被 1 美元和 7 美元整除。另一方面，8 美元不是质数，因为它能被 1 美元、2 美元、4 美元和 8 美元整除。因此，它有四个正整数除数，而不是两个；
- modulo**（注：$mod$ 或 $/%$）是一种数学运算，在两个整数之间，返回前一个整数除以后一个整数的余数。例如，$16\bmod 5 = $1$。

**爱丽丝和鲍勃之间的迪菲-赫尔曼密钥交换过程如下：**


- 爱丽丝和鲍勃商定了两个共同的数字：$p$ 和 $g$。$p$ 是质数，数字越大，迪菲-赫尔曼就越安全。$g$是$p$的原始根。这两个数字可以在不安全的网络上进行明文通信。它们相当于之前普及的**黄色**。因此，爱丽丝和鲍勃必须使用完全相同的 $p$ 和 $g$ 值。
- 确定这些参数后，爱丽丝和鲍勃各自选择一个秘密随机数。爱丽丝将她的秘密随机数命名为 $a$（相当于**红色**），鲍勃将他的秘密随机数命名为 $b$（相当于**蓝色**）。这些数字必须保密。
- 双方不直接交换数字 $a$ 和 $b$，而是按如下方式计算 $A$ 和 $B$：

$A$等于$g$乘以$a$的幂$p$：

$$
A = g^a \bmod p
$$

$B$ 等于 $g$ 升幂 $b$ 取模 $p$ ：

$$
B = g^b \bmod p
$$


- 双方交换值 $A$（相当于**橙色**）和 $B$（相当于**绿色**）。这种交换可以在不安全的网络上以明文进行；
- 爱丽丝收到 $B$ 后，计算 $z$ 的值如下：

$z$等于$B$乘以$a$的幂$p$：

$$
z = B^a \bmod p
$$

提醒您

$$
B = g^b \bmod p
$$

结果是 ：

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

运用权力规则 ：

$$
(x^n)^m = x^{nm}
$$

结果是 ：

$$
z = g^{ba} \bmod p
$$


- 而鲍勃在收到 $A$ 后，也会计算 $z$ 的值，计算过程如下：

$z$等于$A$乘以$b$的幂$p$：

$$
z = A^b \bmod p
$$

结果是 ：

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

由于模运算符的分布性，爱丽丝和鲍勃得到了完全相同的值 $z$。这个数字代表了他们的共同秘密，相当于之前用油漆罐普及的**棕色**。现在，他们可以使用这个共同秘密在不安全的网络上对他们的通信进行对称加密。

![BTC204](assets/fr/222.webp)

攻击者即使掌握了 $p$、$g$、$A$ 和 $B$（公共值），也无法计算 $a$、$b$ 或 $z$（私人值）。要做到这一点，必须将指数化反转，而这一操作如果不逐一尝试所有的可能性是不可能的，因为它相当于计算离散对数，即有限循环群中指数的倒数。

因此，只要 $a$、$b$ 和 $p$ 的值足够大，迪菲-赫尔曼协议就是安全的。通常情况下，如果参数为 2048 位（一个 600 位的十进制数），测试 $a$ 和 $b$ 的所有可能性是不切实际的。迄今为止，使用这样的数字，这种算法被认为是安全的。

这就是 Diffie-Hellman 协议的主要缺点。为了保证安全，该算法必须使用大数字。这就是为什么如今我们更喜欢使用 ECDH（*椭圆曲线 Diffie-Hellman*）算法的原因，它是基于代数曲线，更准确地说，是基于椭圆曲线的 Diffie-Hellman 算法的变种。这种方法可以在保持同等安全性的情况下使用小得多的数字，从而减少计算和存储所需的资源。

算法的一般原理保持不变。不过，我们不再使用随机数 $a$ 和通过模乘计算得出的数 $A$，而是使用在椭圆曲线上建立的一对密钥。我们不再依赖模运算符的可分配性，而是使用椭圆曲线上的群律，更确切地说，是使用该律的关联性。

简单解释一下椭圆曲线密码学的原理：私人密钥由一个介于 $1$ 和 $n-1$ 之间的随机数表示，其中 $n$ 代表曲线的阶数。而公钥则是该曲线上的一个特定点，它是根据等式 ：

$$
K = k \cdot G
$$

在这个公式中，$K$ 表示公钥，$k$ 表示私钥，$G$ 表示生成点。

这些密钥的一个基本特征是，从 $K$ 和 $G$ 可以很容易地计算出 $K$，而从 $K$ 和 $G$ 几乎不可能找到 $k$。这种不对称性产生了一种单向函数。换句话说，如果你知道私人密钥，就很容易计算出公钥，但从公钥中检索私人密钥是不可能的。离散对数的计算难度进一步巩固了这种安全性。

我们将利用这一特性来调整我们的 Diffie-Hellman 算法。 **ECDH 的工作原理如下：**


- Alice 和 Bob 就加密安全的椭圆曲线及其参数达成一致。这些信息是公开的；
- 爱丽丝生成一个随机数 $ka$，作为她的私人密钥。这个私人密钥必须保密。她通过在选定的椭圆曲线上加点和加倍来确定自己的公开密钥 $Ka$：

$$
K_a = k_a \cdot G
$$


- 鲍勃还会生成一个随机数 $kb$，这将是他的私人密钥。他计算出相关的公钥 $Kb$ ：

$$
K_b = k_b \cdot G
$$


- 爱丽丝和鲍勃在不安全的公共网络上交换他们的公开密钥 $Ka$ 和 $Kb$。
- 爱丽丝使用自己的私人密钥 $ka$ 和鲍勃的公开密钥 $Kb$ 计算出曲线上的点 $(x,y)$：

$$
(x,y) = k_a \cdot K_b
$$


- 鲍勃使用自己的私人密钥 $kb$ 和爱丽丝的公开密钥 $Ka$ 计算出曲线上的点 $(x,y)$：

$$
(x,y) = k_b \cdot K_a
$$


- 爱丽丝和鲍勃获得椭圆曲线上的同一个点。共享秘密将是这一点的尾数 $x$。

它们获得相同的共享秘密，因为 ：

$$
(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a
$$

观察不安全公共网络的潜在攻击者只能获得每个人的公开密钥和所选椭圆曲线的参数。如上所述，仅凭这些信息不足以确定私钥。因此，攻击者无法找到 Alice 和 Bob 之间共享的秘密。

因此，ECDH 是一种密钥交换算法。它通常与其他加密方法结合使用，以建立一个完整的协议。例如，ECDH 是用于互联网传输层的加密和验证协议 TLS（*传输层安全*）的核心。TLS 使用 ECDHE 进行密钥交换，这是 ECDH 的一种变体，其中的密钥是短暂的，以提供持久的保密性。此外，TLS 还使用 ECDSA 等认证算法、AES 等加密算法和 SHA256 等散列函数。

TLS 负责 "https "中的 "s "和浏览器地址栏中的挂锁--加密通信的标志。通过学习本课程，您将使用 ECDH，而且很有可能在不知不觉中每天都在使用它。

### 通知事务

正如我们在上一节中看到的，ECDH 是 Diffie-Hellman 交换的一种变体，使用的是在椭圆曲线上建立的密钥对。好在我们的比特币钱包里已经有很多符合这一标准的密钥对了！BIP47 的理念是使用双方的分层确定性比特币钱包的密钥对，在双方之间建立共享的、短暂的秘密。BIP47 使用 ECDHE（*Elliptic Curve Diffie-Hellman **Ephemeral***）来代替。

![BTC204](assets/fr/223.webp)

ECDHE 首先用于 BIP47，将付款代码从发送方传输给接收方。这就是著名的**通知交易**。这一步至关重要，因为要使 BIP47 有效工作，相关双方（发送方和接收方）都需要知道对方的支付密码。有了这些知识，就能推导出短暂的公开密钥，从而推导出相关的空白接收地址。

在交换之前，发件人从逻辑上讲已经知道收件人的支付密码，因为发件人已经从链外获取了收件人的支付密码，例如从其网站、发票或社交网络获取的。然而，收件人并不一定知道发件人的付款代码。但是，支付密码必须传送给收款人，否则收款人就无法获得识别比特币存储地址或存取资金所需的短暂密钥。虽然从技术上讲，发送者代码的传输可以通过其他通信方式在链外进行，但如果只从种子中提取钱包，就会产生问题。

这是因为，与传统地址不同，BIP47 地址并不是直接从收件人的种子中提取的--在这种情况下使用 "xpub "会更简单--而是结合两个支付代码计算得出的：发件人的支付代码和收件人的支付代码。因此，如果收款人丢失了钱包，并试图从他的种子中恢复钱包，他将恢复自己的支付密码，该密码直接来自于他的种子。但是，要恢复短暂地址，他还需要所有通过 BIP47 发送比特币的人的支付密码。因此，通知交易就显得尤为重要，它可以将这些信息保存在比特币区块链上，同时还能非常容易地找到这些信息，而无需在 2009 年比特币发布以来执行的数十亿笔交易中进行搜索。

![BTC204](assets/fr/224.webp)

因此，只要每个用户都保存一份同伴付款代码的备份，就可以在不使用通知交易的情况下实施 BIP47。不过，在开发出一种简单、强大和高效的备份、存储和更新解决方案之前，这种方法的管理会很复杂。从目前的情况来看，通知交易几乎是不可避免的。

不过，在接下来的章节中，我们将探讨与 BIP47 目标类似、但不需要通知交易的其他协议。不过，这些替代方案也有自己的利弊权衡。

除了保存支付密码外，通知交易还具有通知收款人的功能，正如其名称所示。它提醒收款人的客户新的支付通道已经建立，并建议他们留意由此产生的短暂地址。

### BIP47 保密模式

在详细介绍通知交易的技术操作之前，有必要讨论一下与 BIP47 相关的保密模式，这也是在创建初始交易时采取某些措施的理由。

支付代码本身并不直接危及保密性。传统的比特币模式旨在通过保护密钥和地址的匿名性来切断用户身份与其交易（公开）之间的联系，而支付密码则不同，它可以公开地与用户身份联系在一起，而不会构成威胁。

这是因为付款代码不是用来直接生成接收 BIP47 付款的地址的。相反，这些地址是通过 ECDH 应用程序在有关双方的付款代码所产生的密钥之间生成的。

因此，支付密码本身并不会直接导致失密，因为从中只衍生出通知地址。虽然该地址可以透露某些信息，但通常不会透露与您进行交易的各方，除非进行了彻底的链式分析。事实上，如果发件人使用可与其身份相关联的 UTXO 来进行通知交易，那么就有可能推断出他的身份很可能与 BIP47 付款相关联，与您的付款代码相关联。这不会揭示潜在的交易，但会表明它们可能存在。

因此，必须严格区分用户的支付密码。有鉴于此，支付密码的初始通信是支付保密性的关键时刻，但也是协议正常运行的关键时刻。如果其中一个支付密码可以公开获取（如在网站上），那么第二个密码，即发送者的密码，在任何情况下都不得与第一个密码相链接。

让我们举一个具体的例子：我想通过 BIP47 向一个政治运动捐款：


- 该组织已在其网站上或通过其社交网络公布了其付款代码；
- 因此，该准则与政治运动息息相关；
- 我得到了这个付款码 ；
- 在发送之前，我必须确保他们知道我自己的支付密码，这个密码也与我的身份有关，因为我用它在社交网络上接收交易。

如何才能无风险地传递我的代码？使用传统通信手段可能会导致信息泄露，从而将我与这场政治运动联系起来。通知交易提供了一个解决方案，因为它有一层加密，可以防止两个代码之间产生这样的关联。虽然这不是秘密传输发件人支付密码的唯一方法，但却是非常有效的方法。

在下图中，橙色线条表示信息流必须中断的点，黑色箭头表示第三方可能观察到的连接点：

![BTC204](assets/fr/225.webp)

实际上，在比特币的传统保密模式中，要完全分离密钥对和用户之间的信息流往往是很复杂的，尤其是在远程交易中。例如，在捐款活动中，受捐者不可避免地要通过自己的网站或社交网络公开地址或公钥。正确使用 BIP47，特别是在通知交易中，可以通过 ECDHE 和我们稍后要介绍的加密层来解决这个问题。

当然，比特币的经典保密模式仍然适用于由两个支付密码组合而成的短暂公钥。这两种模式实际上是互补的。我在这里想强调的是，与通常使用公钥接收比特币不同，支付密码可以与特定身份联系起来，因为"_Alice 正在与 Bob 交易_"的信息在另一个阶段被破解了。支付代码用于生成支付地址，但仅凭对区块链的观察，不可能将 BIP47 支付交易与用于执行该交易的支付代码联系起来，除非所涉及的 UTXO 之前已经与某个身份关联，并且用户将其支付代码与各自的身份关联起来。

总之，BIP47 支付提供的保密模式可以说优于比特币的基本模式，但这并不意味着它是神奇的。

### 建立通知事务

现在让我们来看看这种通知交易是如何进行的。假设 Alice 希望使用 BIP47 向 Bob 汇款。在我的例子中，爱丽丝是发送方，鲍勃是接收方。鲍勃已在自己的网站上公布了付款代码。因此，爱丽丝已经知道鲍勃的付款代码。

**1- 爱丽丝用 ECDH 计算共享秘密：**


- 她从自己的 HD 钱包中选择与支付密码不同分支的密钥对。请注意，这对密钥不能轻易与 Alice 的通知地址或 Alice 的身份相关联（见上一节）；
- 爱丽丝为这对密钥选择私人密钥。我们称之为 $a$（小写）；

$$
a
$$


- Alice 检索与 Bob 的通知地址相关的公开密钥。该密钥是鲍勃付款代码（索引 $/0$）的第一个子密钥。我们称这个公钥为 $B$（大写）。与此公钥相关的私钥名为 $b$（小写）。$B$是通过在椭圆曲线上将$G$（生成点）与$b$（私人密钥）相加并加倍来确定的：

$$ B = b \cdot G $$


- 爱丽丝用自己的私人密钥 $a$和鲍勃的公开密钥 $B$，通过加点和倍点计算出椭圆曲线上的秘密点 $S$（大写）。

$$ S = a \cdot B $$


- Alice 计算用于加密支付密码的致盲因子 $f$。为此，她使用 HMAC-SHA512 函数确定一个伪随机数。该函数的第二个输入是一个只有鲍勃才能找到的值：x$，即上文计算的秘密点的横座标。第一个输入是 $o$，即作为本次交易输入（输出点）而消耗的 UTXO。

$$ f = \text{HMAC-SHA512}(o, x) $$

**2-爱丽丝将个人支付密码转换为基 2（二进制）**

**3- 它使用这个致盲因子作为密钥，对支付密码的有效载荷进行对称加密。** 使用的加密算法是简单的 "XOR"。**使用的加密算法是简单的 "XOR"，执行的操作类似于 Vernam 密码，也称为 "一次性垫"。


- 爱丽丝首先将她的致盲因子一分为二：前 32 个字节名为 $f1$，后 32 个字节名为 $f2$。这样就得到了 ：

$$ f = f1 || f2 $$


- 爱丽丝分别计算其支付密码的公钥$x$的尾数的密码$x'$和其字符串密码$c$的密码$c'$。$f1$ 和 $f2$ 分别作为密码密钥。使用的操作是 "XOR"（或排他）。

$$ x' = x \oplus f1 $$

$$ c' = c \oplus f2 $$


- 爱丽丝用加密值 x'$ 和 c'$ 替换支付密码中的公钥尾数 x'$ 和字符串代码 c'$ 的实值。

*因此，*4-** 爱丽丝目前拥有她的付款代码和加密的有效载荷。她将构建并广播一个交易，输入是她的公开密钥 $A$，输出是鲍勃的通知地址，输出`OP_RETURN`由她的付款代码和加密的有效载荷组成。 **该交易即为通知交易**。

OP_RETURN "是一个操作码，它将比特币交易的输出标记为无效。如今，它被用来在比特币区块链上广播或锚定信息。它最多可存储 80 字节的数据，然后写入链中，所有其他用户都能看到。

正如我们在前面的章节中所看到的，ECDH 被用来在两个通过不安全网络通信的用户之间生成共享秘密，并有可能被攻击者观察到。在 BIP47 中，ECDH 被用于在比特币网络上进行通信，而比特币网络本身就是一个透明的通信网络，许多攻击者都能观察到。通过 ECDH 密钥交换计算出的共享秘密随后用于加密要传输的秘密信息：发送者的支付密码（Alice）。

我将总结一下我们刚才看到的执行通知交易的步骤：


- Alice 获取 Bob 的支付密码和通知地址；
- 爱丽丝从自己的高清组合中选择一个UTXO，并配以相应的密钥对；
- 它使用 ECDH 计算椭圆曲线上的秘密点；
- 它使用这个秘密点来计算 HMAC，也就是致盲因子；
- 她利用这个致盲因子对个人支付密码的有效载荷进行加密；
- 它使用 `OP_RETURN` 事务输出将隐藏的付款代码发送给 Bob。

![BTC204](assets/fr/226.webp)

### 交易通知：一项实用研究

为了更详细地了解它的工作原理，特别是 `OP_RETURN` 的使用，让我们来看看一个真实的通知事务。我在 testnet 上执行了这样一个事务，您可以 [点击此处](https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e) 找到它。

![BTC204](assets/fr/227.webp)

观察这个事务，我们可以发现它有一个输入和 4 个输出：


- 第一个输出是 `OP_RETURN`，其中包含我隐藏的付款代码；
- 第二个输出的 546 sats 指向我的收件人通知地址；
- 第三笔输出的 15,000 sats 代表服务费，因为我是用 Samourai 钱包完成这笔交易的；
- 第四个 200 万 sats 输出代表汇率，即我的输入返回到属于我的另一个地址的剩余差值。

最值得研究的显然是使用 `OP_RETURN` 的输出 0。让我们仔细看看它的内容。下面是以十六进制表示的 `scriptPubKey` ：

```text
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

该脚本由几个部分组成。首先是.NET Framework 3.0：

```text
6a4c
```

在操作码中，我们可以识别指定 "OP_RETURN "的 "0x6a "和指定 "OP_PUSHDATA1 "的 "0x4c"。

最后一个操作码后面的字节表示后续有效载荷的大小。它表示 `0x50`，即 80 字节：

```text
6a4c50
```

接下来是我的付款代码的元数据，以明文显示：

```text
010002
```

我的支付密码的公开密钥的加密尾数：

```text
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

我的支付密码的加密字符串代码 ：

```text
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

最后，填充到 80 字节，这是 `OP_RETURN` 的标准大小：

```text
00000000000000000000000000
```

为了帮助您理解，以下是我的付款代码，以纯文本形式显示，基数为 58：

```text
PM8TJQCyt6ovbozreUCBrfKqmSVmTzJ5vjqse58LnBzKFFZTwny3KfCDdwTqAEYVasn11tTMPc2FJsFygFd3YzsHvwNXLEQNADgxeGnMK8Ugmin62TZU
```

基数为 16 ：

```text
4701000277507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42add94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc000000000000000000000000008604e4db
```

如果将我的明文支付代码与 `OP_RETURN` 进行比较，我们可以看到，HRP（`0x47`）和校验和（`0x8604e4db`）没有传输。这是正常的，因为这些信息是为人类准备的。

接下来，我们可以识别版本（`0x01`）、位域（`0x00`）和公钥奇偶校验（`0x02`）。在支付密码的末尾，是空字节（`0x00000000000000000000000000`），可以填充到总共 80 个字节。所有这些元数据都是未加密传输的。

最后，我们可以看到公钥的尾数（`0x77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a`）和字符串代码（`0xdd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc`）已被加密。这是付款代码的有效载荷。

### 什么是 XOR？

我们在前面的章节中看到，支付密码是通过 XOR 运算加密传输的。让我们来详细了解一下这个运算符的工作原理，因为它在密码学中被广泛使用。

XOR 是基于布尔代数的位逻辑运算符。给定两个操作数的位，如果同级的位不同，则返回 `1`，如果同级的位相等，则返回 `0`。下面是根据操作数 `D` 和 `E` 的值得到的 XOR 真值表：

| d | e | d xor e |

| --- | --- | ------- |

| 0 | 0 | 0 |

| 0 | 1 | 1 |

| 1 | 0 | 1 |

| 1 | 1 | 0 |

例如

$$
0110 \oplus 1110 = 1000
$$

或者 ：

$$
010011 \oplus 110110 = 100101
$$

在 ECDH 中，使用 XOR 作为加密层是特别一致的。首先，得益于这种运算符，加密是对称的。这意味着收款人可以用加密时使用的相同密钥解密付款代码。加密和解密密钥是通过 ECDH 从共享秘密中计算出来的。这种对称性得益于 XOR 运算符的交换性和关联性：


- 其他属性 ：

$$
D \oplus D = 0
$$

$$
D \oplus 0 = D
$$


- 交换性 ：

$$
D \oplus E = E \oplus D
$$


- 关联性 ：

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
$$

如果 ：

$$
D \oplus E = L
$$

然后 ：

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
$$

其次，这种加密方法与弗纳姆（一次性密码）密码非常相似，弗纳姆密码是迄今为止已知的唯一具有无条件（或绝对）安全性的加密算法。要使 Vernam 密码具有这种特性，加密密钥必须是完全随机的，大小与信息相同，并且只能使用一次。在这里用于 BIP47 的加密方法中，密钥的大小确实与信息相同，而致盲因子的大小与公共密钥的尾数与支付密码的字符串代码的连接完全相同。该加密密钥只使用一次。另一方面，由于是 HMAC，该密钥并非完全随机。相反，它是伪随机的。因此，这不是弗纳姆密码，但这种方法接近弗纳姆密码。

### 接收通知交易

现在，爱丽丝已经向鲍勃发送了交易通知，让我们看看鲍勃是如何解读它的。需要提醒的是，Bob 必须获得 Alice 的支付密码。没有这个信息，我们将在下一节中看到，他将无法推导出 Alice 创建的密钥对，因此也就无法获取通过 BIP47 收到的比特币。目前，爱丽丝的支付密码有效载荷是加密的。让我们看看鲍勃是如何解密的。

**1-** 鲍勃监控使用其通知地址创建输出的交易。

**2-** 当一个事务在其通知地址上有输出时，Bob 会分析它是否包含符合 BIP47 标准的 OP_RETURN 输出。

**3-** 如果 OP_RETURN 有效负载的第一个字节是 "0x01"，则 Bob 开始搜索与 ECDH 共享的可能秘密：


- 鲍勃为交易选择输入的公开密钥。也就是说，爱丽丝的公开密钥名为 $A$，带有 ：

$$ A = a \cdot G $$


- 鲍勃选择与其个人通知地址相关联的私人密钥 $b$ ：

$$ b $$


- 鲍勃通过加点和倍点计算椭圆曲线上的秘密点 $S$（共享秘密 ECDH），将他的私人密钥 $b$ 应用于爱丽丝的公开密钥 $A$ ：

$$ S = b \cdot A $$


- 鲍勃确定能够解密爱丽丝支付密码有效载荷的致盲因子 $f$。与爱丽丝之前计算的方法相同，鲍勃将通过将 HMAC-SHA512 应用于$x$（秘密点$S$的尾差值）和$o$（作为本次通知交易输入的UTXO）来找到$f$：

$$ f = \text{HMAC-SHA512}(o, x) $$

**4-** 鲍勃将通知交易中的 OP_RETURN 数据理解为付款代码。他只需使用 $f$ 致盲因子对这个潜在支付密码的有效载荷进行解密即可：


- 鲍勃将致盲因子 $f$ 分成两部分：$f$ 的前 32 个字节为 $f1$，后 32 个字节为 $f2$；
- 鲍勃从爱丽丝支付密码的公开密钥中解密出加密的尾数 $x'$ 的值：

$$ x = x' \oplus f1 $$


- 鲍勃从爱丽丝的支付密码中解密加密字符串代码 $c'$ 的值：

$$ c = c' \oplus f2 $$

**5-** 鲍勃检查爱丽丝付款密码的公钥值是否属于 secp256k1 组。如果是，他就将其视为有效的支付密码。如果不是，则忽略该交易。

既然鲍勃知道了爱丽丝的付款代码，爱丽丝就可以向他发送多达 `2^32` 笔付款，而无需重复此类通知交易。

为什么会成功？鲍勃如何才能确定与爱丽丝相同的致盲因子，从而破译她的支付密码呢？让我们仔细看看 ECDH 在我们刚才描述的过程中的作用。

首先，我们要处理的是对称加密。这意味着加密密钥和解密密钥的值相同。通知交易中的这个密钥就是致盲因素：

$$ f = f1 || f2 $$

因此，爱丽丝和鲍勃必须获得相同的 $f$ 值，但不能直接传输，因为攻击者可能窃取该值并解密秘密信息。通过对 2 个值应用 HMAC-SHA512 算法，就可以获得这个致盲因子：


- 秘密点的腹座标
- 和交易输入端消耗的UTXO。

因此，鲍勃需要这两个信息来解密爱丽丝的支付密码有效载荷。对于输入的 UTXO，Bob 只需通过观察通知交易即可获取。至于秘密点，鲍勃需要使用 ECDH。正如上一节关于 Diffie-Hellman 的内容所示，只需交换各自的公钥，并将私钥秘密应用于对方的公钥，爱丽丝和鲍勃就能在椭圆曲线上找到一个精确的秘密点。通知交易就是基于这种机制：


- 鲍勃的一对钥匙 ：

$$ B = b \cdot G $$


- 爱丽丝的密钥对 ：

$$ A = a \cdot G $$


- 对于一个秘密 $S (x, y)$ ：

$$ S = a\cdot B = a\cdot (b\cdot G) = (b\cdot a)\cdot G = b\cdot A $$

![BTC204](assets/fr/228.webp)

既然鲍勃知道了爱丽丝的支付密码，他就能检测到她的 BIP47 支付，并推导出阻止所收到的比特币的私钥。

我将总结一下我们刚才一起看过的接收和解释通知事务的步骤：


- 鲍勃监控发送到其通知地址的交易输出；
- 当检测到一个信息时，它会检索 OP_RETURN 中包含的信息；
- 鲍勃选择公开密钥作为输入，并使用 ECDH 计算秘密点；
- 它使用这个秘密点来计算 HMAC，也就是致盲因子；
- 它利用这个致盲因子来解密 OP_RETURN 中包含的 Alice 付款代码有效载荷。

![BTC204](assets/fr/229.webp)

### BIP47 支付交易

让我们来看看 BIP47 的付款流程。提醒您目前的情况 ：


- 爱丽丝知道鲍勃的支付密码，她只是从他的网站上获取了这个密码；
- 鲍勃从通知交易中知道了爱丽丝的支付密码；
- 爱丽丝将向鲍勃支付第一笔款项。她还可以以同样的方式支付更多。

在解释这个过程之前，我认为有必要记住我们目前正在处理的索引。付款代码的派生路径描述如下：`m/47'/0'/0'`.下面的深度将索引划分如下：


- 第一个正常（非强化）子对是用于生成上一节讨论的通知地址的子对：`m/47'/0'/0'/0`；
- 在 ECDH 中使用普通子密钥对生成 BIP47 付款收据地址，我们将在本节中看到：从 `m/47'/0'/0'/0` 到 `m/47'/0'/0'/2,147,483,647` ；
- 强化子密钥对是短暂的支付代码：从`m/47'/0'/0'/0'`到`m/47'/0'/0'/2,147,483,647'`。

每次爱丽丝要向鲍勃发送付款时，她都会再次使用 ECDH 协议生成一个新的、唯一的空白地址：


- Alice 选择的第一个私人密钥来自她的个人可重复使用支付密码 ：

$$ a $$


- Alice 从 Bob 的支付密码中选择第一个未使用的公钥。我们称之为 $B$。它与只有鲍勃知道的私人密钥 $b$ 相关联：

$$ B = b \cdot G $$


- 爱丽丝使用自己的私人密钥 $a$ 和鲍勃的公开密钥 $B$，通过加点和倍点计算出椭圆曲线上的秘密点 $S$：

$$ S = a \cdot B $$


- 根据这个秘密点，爱丽丝计算出共享秘密 $s$（小写）。为此，她选择了名为 $Sx$ 的秘密点 $S$ 的横座标，并将此值传递给 SHA256 哈希函数：

S = (Sx, Sy) $$$

$$ s = \text{SHA256}(Sx) $$


- 爱丽丝使用这个共享秘密 $s$ 计算比特币付款接收地址。首先，她会检查 $s$ 是否包含在 secp256k1 曲线的阶次中。如果不在其中，她就会递增鲍勃的公钥索引，从而得到另一个共享密钥 ；
- 第二步，爱丽丝将椭圆曲线上的 $B$ 和 $s-G$ 两点相加，计算出公共密钥 $K0$。换句话说，爱丽丝把从鲍勃的支付密码 $B$ 中得到的公钥添加到椭圆曲线上的另一个点，这个点是用 secp256k1 曲线生成点 $G$ 中的共享密码 $s$ 通过加点和倍点计算得出的。这个新点代表一个公开密钥，我们称之为 $K0$ ：

$$ K0 = B + s \cdot G $$


- 有了这个公开密钥 $K0$，爱丽丝就可以用标准方法（如 bech32 中的 SegWit V0）推导出一个空白接收地址。

一旦爱丽丝获得了鲍勃的 $K0$ 接收地址，她就可以按照标准方式进行比特币交易。为此，她选择一个自己拥有的UTXO，用HD钱包中不同分支的密钥对作为担保，然后消耗它来满足对Bob的$K0$地址的输出。值得注意的是，一旦地址被导出，这种支付将遵循传统流程，而不再依赖于与 BIP47 相关的密钥。

我将总结一下我们刚才看到的发送 BIP47 付款的步骤：


- Alice 选择从其个人支付密码中提取的第一个女儿私人密钥；
- 它使用 ECDH 计算椭圆曲线上的秘密点，该秘密点来自鲍勃支付密码中第一个未使用的子公钥；
- 它使用这个秘密点用 SHA256 计算共享秘密；
- 她利用这个共享秘密，在椭圆曲线上计算出一个新的秘密点；
- 她将这个新密点加到鲍勃的公开密钥中；
- 她获得了一个新的短暂公开密钥，只有鲍勃拥有与之相关的私人密钥；
- 爱丽丝可以用推导出的短暂接收地址向鲍勃进行传统交易。

![BTC204](assets/fr/230.webp)

如果爱丽丝想进行第二次支付，她会按照之前的步骤进行，只不过这次她会选择从鲍勃的支付密码中提取的第二个公钥。具体来说，她将使用下一个未使用的密钥。这样，她就会得到一个属于鲍勃的新接收地址，名为 $K1$ ：

![BTC204](assets/fr/231.webp)

这样下去，最多可以推导出属于 Bob 的 `2^32` 个空白地址。

从外部角度看区块链，理论上无法区分 BIP47 支付和传统支付。下面是 Testnet 上的 BIP47 支付交易示例：

```text
94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
```

它看起来就像一个典型的交易，有消费输入、支付输出和汇率：

![BTC204](assets/fr/232.webp)

### 收到 BIP47 付款并生成私人密钥

Alice 刚刚向属于 Bob 的空白 BIP47 地址支付了第一笔款项。现在让我们看看鲍勃是如何收到这笔款项的。我们还将看到为什么 Alice 无法访问她自己刚刚生成的地址的私钥，以及 Bob 如何找到这个私钥来花费他刚刚收到的比特币。

一旦鲍勃收到爱丽丝的交易通知，他就会在对方付款之前获得公开密钥 BIP47 $K0$。因此，他可以观察到向相关地址支付的任何款项。事实上，他会立即推导出他所观察到的几个地址（$K0$, $K1$, $K2$, $K3$......）。下面是它如何推导出这个公钥 $K0$ ：


- 鲍勃选择从他的支付密码中提取的第一个子私人密钥。该私人密钥名为 $b$。它与公共密钥 $B$ 相关联，爱丽丝在上一步中就是用公共密钥 $B$ 进行计算的：

$$ b $$


- 鲍勃从爱丽丝的支付密码中选出她的第一个公开密钥。这个密钥名为 $A$。它与 Alice 计算时使用的私人密钥 $a$ 相关联，只有 Alice 知道该私人密钥。鲍勃可以执行此过程，因为他知道爱丽丝的支付密码，该密码是与通知交易一起发送给他的：

$$ A = a \cdot G $$


- 鲍勃将自己的私人密钥 $b$ 应用于爱丽丝的公开密钥 $A$，通过在椭圆曲线上加点和倍点计算出秘密点 $S$。这里同样使用 ECDH 来保证鲍勃和爱丽丝的这个点 $S$ 是相同的：

$$ S = b \cdot A $$


- 与爱丽丝的方法相同，鲍勃分离出了这一点的底边 $S$。我们将这个值命名为 $Sx$。他将这个值传递给 SHA256 函数，以找到共享秘密 $s$（小写）：

$$ s = \text{SHA256}(Sx) $$


- 鲍勃和爱丽丝一样，计算出椭圆曲线上的 $s-G$ 点。然后，他将这个秘密点添加到他的公开密钥 $B$中。然后，他得到椭圆曲线上的一个新点，并将其解释为公开密钥 $K0$ ：

$$ K0 = B + s \cdot G $$

一旦 Bob 拥有了这把 $K0$ 公钥，他就可以导出相关的私钥来使用他的比特币。只有他自己才能生成这个私钥：


- 鲍勃将他女儿的私人密钥 $b$ 与他的个人支付密码相加。只有他能获得 $b$ 的值。然后，他将 $b$ 加到共享秘密 $s$ 中，得到 $k0$，即 $K0$ 的私人密钥：

$$ k0 = b + s $$

由于椭圆曲线的群规律，鲍勃可以准确地获得与爱丽丝使用的公开密钥相对应的私人密钥。因此，我们有 ：

$$ K0 = k0 \cdot G $$

我将总结一下我们刚才一起看过的接收 BIP47 付款和计算相应私钥的步骤：


- 鲍勃选择从其个人支付密码中提取的第一个子私人密钥；
- 它使用 ECDH 计算椭圆曲线上的秘钥点，这个秘钥点来自 Alice 字符串代码中的第一个子公共密钥；
- 它使用这个秘密点用 SHA256 计算共享秘密；
- 他利用这个共享秘密，在椭圆曲线上计算出一个新的秘密点；
- 他将这个新密点添加到个人公开密钥中；
- 他获得了一个新的短暂公开密钥，爱丽丝将向其发送第一笔付款；
- 鲍勃在计算与这个短暂公开密钥相关的私人密钥时，会加上从他的支付密码和共享秘密中得到的子私人密钥。

![BTC204](assets/fr/233.webp)

由于爱丽丝无法获得 $b$（鲍勃的私人密钥），她也就无法确定 $k0$（与鲍勃的 BIP47 接收地址相关的私人密钥）。我们可以用下面的方法来表示共享秘密 $S$ 的计算：

![BTC204](assets/fr/228.webp)

一旦通过 ECDH 找到共享密钥，爱丽丝和鲍勃就会计算出 BIP47 支付公钥 $K0$，鲍勃也会计算出相关的私钥 $k0$：

![BTC204](assets/fr/234.webp)

### 退还 BIP47 付款

由于鲍勃知道爱丽丝的可重复使用支付密码，他已经掌握了向爱丽丝退款所需的所有信息。他不需要再联系 Alice 询问任何信息。他只需用一个通知交易通知她，这样她就可以用她的种子检索到她的 BIP47 地址，然后他还可以向她发送多达 `2^32` 笔付款。

退款功能是 BIP47 特有的，也是它相对于其他方法（如我们将在后面章节介绍的静默支付）的优势之一。

然后，鲍勃可以用爱丽丝向他汇款的同样方式偿还爱丽丝。角色互换：

![BTC204](assets/fr/235.webp)

*非常感谢[Fanis Michalakis](https://x.com/FanisMichalakis)对文章的校对和专家建议，正是他的建议启发了本章的写作！

https://planb.network/tutorials/privacy/on-chain/paynym-bip47-a492a70b-50eb-4f95-a766-bae2c5535093

## 无声支付

<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>


BIP47 因其链上效率低下而广受批评。如前一章所述，它要求对每个新收款人进行一次通知交易。如果我们计划与收款人建立可持续的支付渠道，这一限制就变得微不足道了。事实上，一次通知交易就能为随后几乎无限次的 BIP47 支付铺平道路。

然而，在某些情况下，通知交易可能会成为用户的障碍。让我们以向收款人一次性捐款为例：使用传统的比特币地址，一次交易就足以完成捐款。但在 BIP47 中，需要进行两次交易：一次用于通知，另一次用于实际支付。当对区块空间的需求较低且交易费用较低时，这一额外步骤通常不成问题。然而，在拥堵时期，单笔支付的交易费可能会变得非常高昂，与标准的比特币交易相比，用户的成本可能会增加一倍，这可能会让用户无法接受。

对于用户只计划向静态标识符支付几笔款项的情况，已经开发了其他解决方案。其中包括[BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki)中描述的静默支付。该协议使使用静态标识符接收付款成为可能，而不会产生地址重复使用，也不需要使用通知交易。让我们来看看这个协议是如何工作的。

---
*要完全理解本章内容，必须掌握 ECDH（椭圆曲线 Diffie-Hellman）的工作原理和高清钱包中的加密密钥推导。这些概念在上一章 BIP47 中已有详细介绍。在此不再赘述。如果你还不熟悉这些概念，我建议你在继续学习本章之前先查阅前一章。我将不再赘述与重复使用收款地址相关的风险，也不再赘述为收款设置唯一标识符的重要性*。

---
### 为什么不移动通知？

如 BIP47 章所述，通知事务有两个主要功能：


- 它通知收件人......；
- 它传输发件人的支付密码。

有人可能会天真地认为，这种通知过程可以在链外进行。从理论上讲，这是完全可行的：收件人只需指明一种通信方式，即可从发送方接收 BIP47 支付代码。然而，这种方法存在两大问题：


- 首先，它将把代码传输过程转移到另一个通信协议中。与交换的成本和保密性有关的问题依然存在，只是转移到了这个新协议上。在保密性方面，这也会在用户身份和链上活动之间建立联系，而这正是我们通过直接在区块链上执行通知所要避免的。此外，在区块链之外进行通知会带来审查风险（如封锁资金），而比特币不存在这种风险；
- 其次，这将带来追回问题。使用 BIP47 时，收款人必须知道发款人的支付密码才能获取资金。收款时如此，但如果钱包丢失，通过种子找回资金时也是如此。有了链上通知，这种风险就可以避免，因为用户只需知道自己的种子，就可以检索和解密通知交易。但是，如果在区块链外发出通知，用户就必须对收到的所有付款代码进行动态备份，这对普通用户来说是不切实际的。

所有这些限制因素使得链上通知的使用对于 BIP47 来说至关重要。然而，Silent Payments 试图避免链上通知这一步骤，正是因为其成本高昂。因此，采用的解决方案不是移动通知，而是完全取消通知。为此，必须接受一种折衷方案：扫描。与 BIP47 不同的是，在 BIP47 中，由于有通知交易，用户可以准确地知道在哪里可以找到他的资金，而在 Silent Payments 中，用户必须检查所有现有的比特币交易，才能发现任何针对他的支付。为了减轻操作负担，无声支付的搜索仅限于可能包含此类支付的交易，即至少有一个 Taproot P2TR 输出的交易。扫描也只关注自钱包创建之日起的交易（如果钱包创建于 2024 年，则无需扫描 2009 年的交易）。

因此，你可以理解为什么 BIP47 和无声支付虽然目标相似，却涉及不同的取舍，因此 **实际上满足了不同的使用情况**。对于一次性支付，如一次性捐款，无声支付因其成本较低而更为合适。另一方面，对于向同一收款人的定期交易，如交易所平台或矿池，BIP47 可能是首选。

让我们来看看无声支付的技术操作，以便更好地理解其中的利害关系。为此，我建议我们采用与 BIP352 解释性文件相同的方法。我们将逐步逐项分解需要进行的计算，并对每项新增加的内容进行论证。

### 需要了解的几个概念

在开始之前，有一点很重要，那就是静默支付完全依赖于 P2TR（*支付到 Taproot*）脚本类型的使用。与 BIP47 不同的是，它不需要通过散列从子公钥推导出接收地址。在 P2TR 标准中，经过调整的公钥会在地址中直接使用，不会加密。因此，Taproot 接收地址本质上就是一个带有一些元数据的公钥。这个经过调整的公钥是另外两个公钥的集合：一个通过简单签名实现直接、传统的消费，另一个代表 MAST 的梅克尔树根，授权消费必须满足梅克尔树中潜在的条件之一。

![BTC204](assets/fr/068.webp)

决定将静默支付仅限于 Taproot 有两个主要原因：


- 首先，它大大方便了组合软件的实施和未来升级，因为只需遵守一种标准；
- 其次，这种方法鼓励用户不要将自己划分为不同类型的脚本，因为不同类型的脚本在链式分析中会产生不同的投资组合指纹（关于这一概念的更多信息，请参阅第 2 部分第 4 章），从而有助于提高用户的惰性。

### 沉默支付公开密钥的简单推导

让我们从一个简单的例子开始，了解 SP（无声支付）是如何工作的。让我们以两个比特币用户 Alice 和 Bob 为例。Alice 希望通过一个空白的接收地址向 Bob 发送比特币。这个过程有三个目的：


- Alice 必须能够生成一个空白地址；
- Bob 必须能够识别寄往这一特定地址的付款；
- 鲍勃需要获得与该地址相关的私人密钥，才能使用他的资金。

爱丽丝的比特币安全钱包里有一个UTXO，密钥对如下：


- $a$：私人密钥 ；
- $A$: 公钥（$A = a\cdot G$）

鲍勃在互联网上公布了自己的 SP 地址，地址为 ：


- b$：私人密钥 ；
- $B$：公开密钥（$B = b \cdot G$）

通过获取鲍勃的地址，爱丽丝可以使用 ECDH 计算出一个属于鲍勃的新空白地址。我们称这个地址为 $P$ ：

$$ P = B + \text{hash}(a \cdot B) \cdot G $$

在这个等式中，爱丽丝只是计算了她的私人密钥 $a$ 和鲍勃的公开密钥 $B$ 的标量乘积。她将计算结果输入一个众所周知的哈希函数。然后，将得到的值与椭圆曲线 `secp256k1` 的生成点 $G$ 进行标量相乘。最后，爱丽丝将生成点与鲍勃的公开密钥 $B$ 相加。一旦爱丽丝得到了这个地址 $P$，她就可以将其作为交易的输出，即向其发送比特币。

> *在静默支付中，"哈希 "函数对应于一个专门标记为 "BIP0352/SharedSecret "的 SHA256 哈希函数，它确保生成的哈希值是本协议独有的，不能在其他情况下重复使用，同时提供额外保护，防止在签名中重复使用非ces。该标准与[BIP340 中规定的 Schnorr 签名](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) 中的 `secp256k1`.* 相对应。
由于 ECDH 所基于的椭圆曲线的特性，我们知道 ：

$$ a \cdot B = b \cdot A $$

因此，鲍勃可以计算出爱丽丝发送比特币的收款地址。为此，他会监控所有符合 "静默支付 "标准的比特币交易，并对每笔交易进行如下计算，以确定付款是否是发给他的（*扫描*）：

$$ P' = B + \text{hash}(b \cdot A) \cdot G $$

当他扫描 Alice 的交易时，他发现 $P'$ 等于 $P$。因此，他知道这笔钱是付给她的：

$$ P' = B + \text{hash}(b \cdot A) \cdot G = B + \text{hash}(a \cdot B) \cdot G = P $$

在此基础上，鲍勃就能计算出私人密钥 $p$，从而可以使用地址 $P$：

$$ p = (b + \text{hash}(b \cdot A))\bmod n $$

如您所见，要计算私人密钥 $p$，您必须拥有私人密钥 $b$。只有鲍勃拥有这个私人密钥 $b$。因此，只有他才能使用发送到他的静默支付地址的比特币。

![BTC204](assets/fr/236.webp)

*图例：*


- $B$ : Bob 发布的公开密钥/静态地址
- $b$ : 鲍勃的私人密钥
- $A$ : 作为交易输入的 Alice 的 UTXO 公钥
- $a$ : Alice 的私人密钥
- $G$ : 椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$ ：标记为 "BIP0352/SharedSecret "的 SHA256 哈希函数
- $s$ : ECDH 的共同秘密
- $P$ : 用于向 Bob 付款的公开密钥/唯一地址

下面是一个相当天真的初始方法，即使用鲍勃的静态地址（注：$B$）来推导出一个唯一的地址 $P$ 以发送比特币。然而，这种方法过于简单，有几个缺陷需要纠正。第一个问题是，在这个方案中，爱丽丝无法在同一笔交易中向鲍勃创建多个输出。

### 如何创建多个输出？

在上一节的示例中，爱丽丝创建了一个单一的输出，将发送到鲍勃的唯一地址 $P$。在选择相同输入的情况下，爱丽丝不可能为鲍勃创建两个不同的空白地址，因为所使用的方法将始终导致 $P$ 相同的结果，即相同的地址。但是，在许多情况下，爱丽丝可能希望将支付给鲍勃的款项分成几个较小的数额，从而创建多个 UTXO。因此，有必要找到一种方法来实现这一点。

为了达到这个目的，我们要稍微修改一下爱丽丝为得出 $P$ 而进行的计算，这样她就能为鲍勃生成两个不同的地址，即 $P_0$ 和 $P_1$。

要修改计算结果并获得两个不同的地址，只需添加一个整数来修改结果即可。因此，爱丽丝将在计算结果中添加 $0$，得到地址 $P_0$；添加 $1$，得到地址 $P_1$。我们称这个整数为 $i$ ：

$$ P_i = B + text{hash}(a \cdot B \text{‖ } i) \cdot G $$

计算过程与之前的方法保持不变，只是这次 Alice 会在进行哈希计算前将 $a \cdot B$ 与 $i$ 连接起来。然后，您只需修改 $i$，即可获得属于 Bob 的新地址。例如

$$ P_0 = B + text{hash}(a \cdot B \text{ ‖ } 0) \cdot G $$

$$ P_1 = B + text{hash}(a \cdot B \text{‖ } 1) \cdot G $$

当鲍勃在区块链上扫描为他准备的静默支付时，他首先使用 $i = 0$ 地址 $P_0$。如果他在 $P_0$ 上没有找到任何付款，他就会得出结论，这笔交易不包含为他准备的无声付款，并放弃扫描。但是，如果 $P_0$ 是有效的，并且包含一笔给他的付款，他就继续扫描同一交易中的 $P_1$，检查 Alice 是否进行了第二次付款。如果 $P_1$ 无效，则停止搜索该交易；否则，继续测试连续的 $i$ 值：

$$ P_0 = B + text{hash}(b \cdot A \text{‖ } 0) \cdot G $$

$$ P_1 = B + text{hash}(b \cdot A \text{‖ } 1) \cdot G $$

由于如果 $P_0$ 不起作用，Bob 就会立即停止 $i = 0$，因此在事务扫描阶段，使用这个整数几乎不会给 Bob 增加额外的运行负荷。

然后，鲍勃可以用同样的方法计算私钥：

$$
p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n
$$

$$
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n
$$

![BTC204](assets/fr/237.webp)

*图例：*


- $B$ : Bob 发布的公开密钥/静态地址
- $b$ : 鲍勃的私人密钥
- $A$ : 作为交易输入的 Alice 的 UTXO 公钥
- $a$ : Alice 的私人密钥
- $G$ : 椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$ ：标记为 "BIP0352/SharedSecret "的 SHA256 哈希函数
- $s_0$ : 第一个共同秘密 ECDH
- $s_1$ ：第二个 ECDH 共同秘密
- $P_0$ : 第一个公共密钥/向 Bob 付款的唯一地址
- $P_1$ : 第二个公开密钥/向 Bob 付款的唯一地址

有了这种方法，我们开始有了一个不错的协议，但仍有一些难题需要克服，尤其是防止地址重用。

### 如何避免地址重复使用？

正如我们在前面的章节中所看到的，爱丽丝使用确保其UTXO安全的密钥对，她将用它来计算与鲍勃的ECDH共享秘密。通过这个秘密，爱丽丝可以得到唯一地址 $P_0$。但是，如果爱丽丝多次重复使用这个地址，她使用的密钥对（$a$, $A$）可以确保多个UTXO的安全。如果爱丽丝使用由相同密钥 $A$ 保护的两个 UTXO 向鲍勃的静态地址 $B$ 支付了两次款项，这将导致鲍勃重复使用地址。

> *就用户保密性而言，地址重复使用是一种非常糟糕的做法。要想知道原因，我建议您回顾一下本培训课程的前几部分*。
事实上，由于唯一地址 $P_0$ 是由 $A$ 和 $B$ 导出的，因此，如果爱丽丝使用相同的密钥 $A$ 为 $B$ 的第二次付款导出第二个地址，她最终将使用完全相同的地址 $P_0$。为了避免这种风险，并防止在静默支付中重复使用地址，我们需要稍微修改一下我们的计算方法。

我们希望的是，即使多个UTXO都由相同的密钥对保护，爱丽丝作为支付输入所使用的每个UTXO都能在鲍勃这边给出一个唯一地址。因此，我们需要做的就是在计算唯一地址 $P_0$ 时添加一个对 UTXO 的引用。这个引用就是作为输入的UTXO的哈希值：

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$

爱丽丝在计算唯一地址 $P_0$ 时，会将此引用添加到输入中：

$$ P_0 = B + text{hash}(\text{inputHash} \cdot a \cdot B \text{ ‖ } 0) \cdot G $$

在扫描时，鲍勃也可以添加 $\text{inputHash}$，因为他只需观察交易即可推断出 $\text{outpoint}$：

$$ P_0 = B + \text{inputHash} （ \text{inputHash} \cdot b \cdot A \text{ ‖ } 0） \cdot G $$

当找到有效的 $P_0$ 时，它就能计算出相应的 $p_0$ 私钥：

$$
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
$$

![BTC204](assets/fr/238.webp)

*图例：*


- $B$ : Bob 发布的公开密钥/静态地址
- $b$ : 鲍勃的私人密钥
- $A$ : 作为交易输入的 Alice 的 UTXO 公钥
- $a$ : Alice 的私人密钥
- $H$ : 作为输入的UTXO哈希值
- $G$ : 椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$ ：标记为 "BIP0352/SharedSecret "的 SHA256 哈希函数
- $s_0$ : 第一个 ECDH 共同秘密
- $P_0$ : 第一个公共密钥/向 Bob 付款的唯一地址

目前，我们的计算假设爱丽丝在交易中使用单一输入。但是，她应该可以使用多个输入。因此，在鲍勃这边，对于涉及多个输入的每笔交易，理论上他都应该计算每个输入的 ECDH，以确定付款是否针对他。这种方法并不理想，因此我们需要找到一种解决方案来减少工作量！

### 将公开密钥调整为输入

为了解决这个问题，我们将使用交易输入中使用的所有密钥对的总和，而不是使用确保 Alice 一方特定输入的密钥对。这个总和将被视为一个新的密钥对。这种技术被称为 "调整"。

例如，假设爱丽丝的交易有 3 个输入，每个输入都使用不同的密钥对：


- $a_0$ 用于保护输入 #0 ；
- $a_1$ 用于确保输入 #1 的安全；
- $a_2$ 确保输入 #2。

![BTC204](assets/fr/239.webp)

按照前面介绍的方法，爱丽丝必须从 $a_0$、$a_1$ 和 $a_2$ 中选择一个密钥对来计算 ECDH 密钥，并从鲍勃的静态地址 $B$ 生成单个支付地址 $P$。但是，这种方法要求鲍勃依次测试每种可能性，从 $a_0$开始，然后是 $a_1$，依此类推，直到他确定一对能生成有效 $P$ 地址的配对。这个过程要求 Bob 对所有事务的所有输入运行 ECDH 计算，这大大增加了扫描的操作负荷。

为了避免这种情况，我们会要求 Alice 使用所有输入密钥的总和来计算 $P$。以我们的例子为例，经过调整的私人密钥 $a$ 的计算方法如下：

$$ a = a_0 + a_1 + a_2 $$

同样，爱丽丝和鲍勃也能计算出经过调整的公开密钥：

$$ a = a_0 + a_1 + a_2 $$

使用这种方法，鲍勃只需计算交易公钥的总和，然后仅从 $A$ 计算出 ECDH 密钥，这大大减少了扫描阶段所需的计算量。

不过，请记住上一节的内容。我们在计算中添加了 $\text{inputHash}$ 哈希值，它被用作避免地址重复使用的 nonce：

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$

但如果在一个事务中有多个输入，则需要能够确定在计算中选择哪个 $\text{outpoint}$。根据 BIP352，要使用的 $\text{outpoint}$ 选择标准是按词典顺序选择最小的，即选择按字母顺序排列在前的 UTXO。这种方法使每个事务中选择的UTXO标准化。例如，如果这个按词典顺序排列的最小 $\text{outpoint}$ 是 $\text{outpoint}_L$，那么 $\text{inputHash}$ 的计算结果将是 ：

$$ \text{inputHash} = \text{hash}(\text{outpoint}_L \text{‖ } A) $$

接下来的计算仍与上一节中介绍的相同，只是私钥 $a$ 及其对应的公钥 $A$ 不再是一对用于保护单个输入的密钥，而是代表输入中所有密钥对的调整。

### 单独的支出和扫描键

目前，我们将静默支付静态地址 $B$ 称为唯一公钥。请记住，爱丽丝正是使用这个公钥 $B$ 创建共享秘密 ECDH，进而计算出唯一支付地址 $P$。鲍勃在扫描阶段使用此公钥 $B$ 和相应的私钥 $b$。但他也会使用私人密钥 $b$ 计算私人密钥 $p$，以便从地址 $P$ 进行消费。

这种方法的缺点是，用于计算所有收到静默支付地址的私钥的 $b$ 私钥也会被 Bob 用来扫描交易。这一步骤要求 $b$ 密钥在连接互联网的钱包软件中可用，这比将其保存在冷钱包中更容易面临被盗的风险。理想的情况是，在利用静默支付的同时，将控制所有其他私钥访问的 $b$ 私钥安全地保存在硬件钱包中。幸运的是，我们已经对协议进行了调整，使其能够做到这一点。

为此，BIP352 要求接收器使用两对不同的密钥：


- b_{text{spend}}$：计算唯一支付地址的私钥；
- b_{text{scan}}$：查找唯一的付款地址。

这样，鲍勃就可以将私钥 $b_{\text{spend}}$ 保存在硬件钱包中，并在在线软件中使用私钥 $b_{\text{scan}}$ 来查找他的静默支付，而不会泄露 $b_{\text{spend}}$。另一方面，公钥 $B_{\text{scan}}$ 和 $B_{\text{spend}}$ 都是公开的，因为它们位于 Bob 的静态地址 $B$ 中：

$$ B = B_{\text{scan}}\文本{ ‖ }B_{text{spend}}$$

为了计算出属于 Bob 的唯一付款地址 $P_0$，Alice 现在将进行以下计算：

$$ P_0 = B_{text{spend}}+ text{hash}(text{inputHash} \cdot a \cdot B_{text{scan}} \text{ ‖ } 0) \cdot G $$

为了找出给他的付款，鲍勃将进行如下计算：

$$ P_0 = B_{text{spend}}+ \text{hash}(\text{inputHash} \cdot b_{text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$

如您所见，到目前为止，鲍勃还不需要使用硬件钱包中的 $b_{\text{spend}}$。当他想花费 $P_0$ 时，可以通过下面的计算找到私钥 $p_0$ ：

$$ p_0 = （ b_{text{spend}}+ text{hash}(\text{inputHash} \cdot b_{text{scan}} \cdot A \text{ ‖ } 0)) \bmod n $$

![BTC204](assets/fr/240.webp)

*图例：*


- $B_{text{scan}}$：鲍勃的公开扫描密钥（静态地址）
- $b_{text{scan}}$ : 鲍勃的私人扫描密钥
- $B_{text{spend}}$ : 鲍勃的公共支出密钥（静态地址）
- $b_{text{spend}}$ : 鲍勃的私人消费密钥
- $A$ : 公钥输入总和（调整）
- $a$ : 与经过调整的公开密钥相对应的私人密钥
- $H$ : 作为输入的最小 UTXO 的哈希值（按词序排列
- $G$ : 椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$ ：标记为 "BIP0352/SharedSecret "的 SHA256 哈希函数
- $s_0$ : 第一个共同秘密 ECDH
- $P_0$ : 第一个公共密钥/向 Bob 付款的唯一地址

### 使用带标签的 SP 地址

因此，Bob 有一个静态地址 $B$，用于静默支付，如 ：

$$ B = B_{\text{scan}}\文本{ ‖ }B_{text{spend}}$$

这种方法的问题在于，它无法隔离发送到该地址的不同付款。例如，如果鲍勃的公司有两个不同的客户，而他又想区分向每个客户的付款，那么他就需要两个不同的静态地址。按照目前的方法，一个简单的解决方案是鲍勃创建两个独立的钱包，每个钱包都有自己的静态地址，或者甚至在同一个钱包中建立两个不同的静态地址。但是，这种解决方案需要对整个区块链扫描两次（每个地址一次），以检测分别发送到每个地址的付款。这种双重扫描不合理地增加了 Bob 的操作负荷。

为了解决这个问题，BIP352 使用了一种标签系统，允许不同的静态地址，同时不会不合理地增加在区块链上查找静默支付的工作量。为此，我们在公共支出密钥 $B_{\text{spend}}$ 中添加了一个整数 $m$。对于第一个静态地址，这个整数的值可以是 1$，对于第二个静态地址，这个整数的值可以是 2$，以此类推。现在，消费密钥 $B_{text{spend}}$ 将被称为 $B_m$，并将以这种方式构建：

$$ B_m = B_{text{spend}} + \text{hash}(b_{text{scan}} \text{ ‖ } m+ text{hash}(b_{text{scan}} \text{ ‖ } m) \cdot G $$

例如，第一个支出键的标签为 $1$ ：

$$ B_1 = B_{text{spend}} + \text{hash}(B_{text{scan}} \text{ ‖ } 1+ text{hash}(b_{text{scan}} \text{ ‖ } 1) \cdot G $$

现在，Bob 发布的静态地址将由 $B_{text{scan}}$ 和 $B_m$ 组成。例如，第一个标签为 $1$ 的静态地址将是 ：

$$ B = B_{\text{scan}}\文本{ ‖ }B_1 $$

> *我们只从标号 1 开始，因为标号 0 是为更改预留的*。
爱丽丝将以与之前相同的方式得出单个支付地址 $P$，但使用新的 $B_1$ 代替 $B_{text{spend}}$ ：

$$ P_0 = B_1 + \text{hash}(\text{inputHash} \cdot a \cdot B_{\text{scan}} \text{ ‖ } 0) \cdot G $$

实际上，爱丽丝甚至不一定知道鲍勃有一个带标签的地址，因为她只是在使用鲍勃提供的静态地址的第二部分，在这种情况下，它的值是 $B_1$，而不是 $B_{text{spend}}$。

在扫描付款时，鲍勃将始终以这种方式使用初始静态地址中的 $B_{text\{spend}}$ 值：

$$ P_0 = B_{text{spend}}+ \text{hash}(\text{inputHash} \cdot b_{text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$

然后，他只需从每个输出中逐个减去他找到的 $P_0$ 值。然后，他检查这些减法的结果之一是否与他在投资组合中使用的某个标签的值相匹配。例如，如果输出 #4 与 $1$ 标签相匹配，这意味着该输出是与静态标签地址 $B_1$ 相关联的静默支付：

$$ Out_4 - P_0 = \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G $$

它之所以有效，是因为 ：

$$ B_1 = B_{text{spend}} + \text{hash}(B_{text{scan}} \text{ ‖ } 1+ text{hash}(b_{text{scan}} \text{ ‖ } 1) \cdot G $$

有了这种方法，Bob 可以使用大量静态地址（$B_1$、$B_2$、$B_3$......），所有这些地址都来自于他的基本静态地址（$B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}}$），以便保持单独使用。

但请注意，这种静态地址分离仅从个人组合管理的角度有效，并不能分离身份。由于它们都具有相同的 $B_{text/{scan}}$，因此很容易将所有静态地址联系在一起，并推断出它们属于同一个实体。

![BTC204](assets/fr/241.webp)

*图例：*


- $B_{text{scan}}$：鲍勃的公开扫描密钥（静态地址）
- $b_{text{scan}}$ : 鲍勃的私人扫描密钥
- $B_{text{spend}}$ ：鲍勃的公共支出密钥（初始地址）
- $B_m$ : 鲍勃的公共支出密钥标签（静态地址）
- $b_m$：鲍勃的私人支出密钥，标记为
- $A$ : 公钥输入总和（调整）
- $a$ : 与经过调整的公开密钥相对应的私人密钥
- $H$ : 作为输入的最小 UTXO 的哈希值（按词序排列
- $G$ : 椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$ ：标记为 "BIP0352/SharedSecret "的 SHA256 哈希函数
- $s_0$ : 第一个 ECDH 共同秘密
- $P_0$ : 第一个公共密钥/向 Bob 付款的唯一地址
- $p_0$ : 鲍勃第一个唯一付款地址的私人密钥
- $X$ ：扫描私人密钥的哈希值，标签为

### 如何创建静默支付地址？

要建立一个专用于静默支付的地址，首先需要从您的 Bitcoin HD 钱包中获取 2 个密钥对：


- $b_{\text{scan}}$、$B_{\text{scan}}$ 对来搜索向我们支付的款项；
- 对 $b_{\text{spend}}$、$B_{\text{spend}}$ 来思考我们收到的比特币。

这些货币对通过以下路径得出（*比特币主网*）：

```text
scan : m / 352' / 0' / 0' / 1' / 0
spend : m / 352' / 0' / 0' / 0' / 0
```

有了这两对密钥后，我们只需将它们连接起来（端到端），即可创建静态地址有效载荷：

$$ B = B_{\text{scan}}\文本{ ‖ }B_{text{spend}}$$

如果我们想使用标签，则将 $B_{text{spend}}$ 替换为 $B_m$ ：

$$ B = B_{\text{scan}}\文本{ ‖ }B_m $$

标签为 $m$ ：

$$ B_m = B_{text{spend}} + \text{hash}(b_{text{scan}} \text{ ‖ } m+ text{hash}(b_{text{scan}} \text{ ‖ } m) \cdot G $$

获得有效载荷后，我们会添加 HRP（*人类可读部分*）"sp "和版本 "q"（= 版本 0）。我们还会添加校验和，并将地址格式化为 bech32m。

例如，这是我的静默支付静态地址：

```text
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```

关于静态地址的一个要点，大家在前面的章节中可能已经了解，那就是这些地址在比特币交易中是不可见的。只有输出中使用的 $P$ 支付地址才会以标准的 Taproot 格式出现在区块链上。因此，从外观上看，无法区分使用静默支付的交易和使用 P2TR 输出的普通交易。

与 BIP47 一样，静态地址 $B$ 和从 $B$ 导出的支付地址 $P$ 之间不可能建立联系。事实上，即使潜在攻击者夏娃试图用鲍勃的静态 $B$ 地址扫描区块链，她也无法执行确定 $P$ 所需的计算。为此，她需要鲍勃的私人密钥 $b_{\text{scan}}$，或者发件人的私人密钥 $a$，但两者当然都是私有的。因此，将一个人的静态地址与某种形式的个人身份明确联系起来是可能的。

### 如何使用静默支付？

静默支付（Silent Payments）提议是最近才提出的，目前只有极少数钱包实施了该提议。据我所知，只有 3 款软件产品支持它们：


- [CakeWallet](https://cakewallet.com/)
- [Silentium](https://app.silentium.dev/)
- [DonationWallet](https://github.com/Sosthene00/donationwallet)

我们很快将为您提供如何设置自己的静默支付静态地址的详细教程。

由于该功能是新功能，我们建议您谨慎使用，避免在主网上使用 "静默支付 "进行大额支付。

*为了撰写关于无声支付的这一章，我使用了[无声支付解释网站](https://silentpayments.xyz/) 和[BIP352 解释文件](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki)。*

# 最终部分

<partId>2aee56c0-b285-4799-b4f7-373a552ee2b2</partId>

## 评论与评级

<chapterId>195d149f-80fa-5816-8b46-995a9226d082</chapterId>

<isCourseReview>true</isCourseReview>

## 期末考试

<chapterId>e803d394-e3c1-5816-a6b4-a69a2472019c</chapterId>

<isCourseExam>true</isCourseExam>

## 结论

<chapterId>cd8e5c67-50e4-4dcd-8e04-88ba5ec95305</chapterId>

<isCourseConclusion>true</isCourseConclusion>
