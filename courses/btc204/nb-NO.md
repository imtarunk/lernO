---
name: Personvern på Bitcoin
goal: Forstå og beherske prinsippene for personvern ved bruk av Bitcoin
objectives: 

  - Definere de teoretiske begrepene som trengs for å forstå personvernspørsmål
  - Identifisere og redusere risikoen forbundet med tap av konfidensialitet for Bitcoin-brukere
  - Bruk av metoder og verktøy for å beskytte personvernet ditt på Bitcoin
  - Forstå metoder for kjedeanalyse og utvikle forsvarsstrategier

---
# Beskytt personvernet ditt på Bitcoin

I en verden der konfidensialiteten til finansielle transaksjoner gradvis blir en luksus, er det viktig å forstå og beherske prinsippene for personvern ved bruk av Bitcoin. Dette kurset gir deg alle nøklene, både teoretiske og praktiske, for å oppnå dette på egen hånd.

I dag, på Bitcoin, spesialiserer selskaper seg på blockchain-analyse. Deres kjernevirksomhet består nettopp i å trenge seg inn i din private sfære, for å kompromittere konfidensialiteten til transaksjonene dine. I virkeligheten finnes det ikke noe slikt som en "rett til privatliv" i Bitcoin. Så det er opp til deg, brukeren, å hevde dine naturlige rettigheter og beskytte konfidensialiteten til transaksjonene dine, fordi ingen andre kommer til å gjøre det for deg.

Kurset er utformet for å være omfattende og generelt. Hvert enkelt teknisk konsept gjennomgås i detalj og understøttes av forklarende diagrammer. Målet er å gjøre kunnskapen tilgjengelig for alle. BTC204 er derfor overkommelig for nybegynnere og viderekomne brukere. Kurset gir også merverdi for mer erfarne bitcoinere, ettersom vi går dypere inn i enkelte tekniske konsepter som ofte blir misforstått.

Bli med oss for å endre din bruk av Bitcoin og bli en informert bruker, som er i stand til å forstå problemene rundt konfidensialitet og beskytte personvernet ditt.

+++
# Innledning

<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## Kursoversikt

<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

Velkommen til BTC204-kurset!

I en verden der konfidensialiteten til finansielle transaksjoner gradvis blir en luksus, er det viktig å forstå og beherske prinsippene for personvern ved bruk av Bitcoin. Dette kurset gir deg alle nøklene, både teoretiske og praktiske, for å oppnå dette på egen hånd.

I dag, på Bitcoin, spesialiserer selskaper seg på blockchain-analyse. Deres kjernevirksomhet består nettopp i å trenge seg inn i din private sfære, for å kompromittere konfidensialiteten til transaksjonene dine. I virkeligheten finnes det ikke noe slikt som en "rett til privatliv" i Bitcoin. Så det er opp til deg, brukeren, å hevde dine naturlige rettigheter og beskytte konfidensialiteten til transaksjonene dine, fordi ingen andre kommer til å gjøre det for deg.

Bitcoin handler ikke bare om "Number Go Up" og å bevare verdien av sparepenger. Med sine unike egenskaper og historie er det først og fremst et verktøy for motøkonomien. Takket være denne formidable oppfinnelsen kan du fritt disponere pengene dine, bruke dem og akkumulere dem, uten at noen kan stoppe deg.

Bitcoin tilbyr en fredelig flukt fra statens åk, slik at du fullt ut kan nyte dine naturlige rettigheter, som ikke kan utfordres av etablerte lover. Takket være Satoshi Nakamotos oppfinnelse har du makt til å håndheve respekten for din private eiendom og gjenvinne friheten til å inngå kontrakter.

Bitcoin er imidlertid ikke anonymt som standard, noe som kan utgjøre en risiko for personer som driver med motøkonomi, særlig i regioner med despotisk styre. Men dette er ikke den eneste faren. Siden bitcoin er en verdifull og uvurderlig eiendel, kan den være et mål for tyver. Å beskytte personvernet ditt blir derfor også et spørsmål om sikkerhet: Det kan hjelpe deg med å forhindre hacking og fysiske angrep.

Som vi skal se, er det viktig å bruke flere verktøy for å optimalisere og forsvare konfidensialiteten, selv om protokollen i seg selv gir en viss konfidensialitetsbeskyttelse.

Dette kurset er utformet for å gi en omfattende, generell oversikt over problemene knyttet til Bitcoin-konfidensialitet. Hvert teknisk konsept gjennomgås i detalj, støttet av forklarende diagrammer. Målet er å gjøre denne kunnskapen tilgjengelig for alle, også nybegynnere og viderekomne brukere. For de mer erfarne Bitcoin-brukerne dekker vi også svært tekniske og noen ganger lite kjente konsepter gjennom hele kurset, for å utdype forståelsen av hvert emne.

Målet med dette kurset er ikke å gjøre deg helt anonym i din bruk av Bitcoin, men snarere å gi deg de viktigste verktøyene for å vite hvordan du kan beskytte konfidensialiteten din i henhold til dine personlige mål. Du vil ha frihet til å velge fra konseptene og verktøyene som presenteres for å utvikle dine egne strategier, skreddersydd til dine spesifikke mål og behov.

**Del 1: Definisjoner og nøkkelbegreper**

Til å begynne med skal vi gå gjennom de grunnleggende prinsippene som styrer driften av Bitcoin, slik at vi deretter kan gå rolig i gang med begrepene knyttet til konfidensialitet. Det er viktig å beherske noen grunnleggende begreper, som UTXO, mottaksadresser og skripting, før du fullt ut kan forstå begrepene vi tar for oss i de følgende avsnittene. Vi vil også introdusere Bitcoins generelle konfidensialitetsmodell, slik Satoshi Nakamoto forestilte seg den, slik at vi kan forstå hva som står på spill og hvilke risikoer som er forbundet med den.

![BTC204](assets/fr/001.webp)

**Del 2: Forståelse og beskyttelse mot kjedeanalyse**

I den andre delen ser vi på teknikkene som brukes av blokkjedeanalyseselskaper for å spore aktiviteten din på Bitcoin. Å forstå disse metodene er avgjørende for å styrke personvernet ditt. Målet med denne delen er å undersøke angripernes strategier for å få en bedre forståelse av risikoen og forberede grunnen for teknikkene vi skal studere i de neste delene. Vi vil analysere transaksjonsmønstre, interne og eksterne heuristikker og sannsynlige tolkninger av disse mønstrene. I tillegg til teori lærer vi hvordan vi kan bruke en blokkutforsker til kjedeanalyse, gjennom praktiske eksempler og øvelser.

![BTC204](assets/fr/002.webp)

**Del 3: Beherske beste praksis for å beskytte personvernet ditt**

I den tredje delen av kurset vårt går vi til det helt konkrete: praksis! Målet er å mestre alle de essensielle beste praksisene som bør bli naturlige reflekser for enhver Bitcoin-bruker. Vi går gjennom bruk av blanke adresser, tagging, konsolidering, bruk av komplette noder, samt KYC og anskaffelsesmetoder. Målet er å gi deg en omfattende oversikt over fallgruvene du bør unngå for å etablere et solid grunnlag i arbeidet med å beskytte personvernet. For noen av disse metodene vil du bli veiledet til en spesifikk veiledning om hvordan du implementerer dem.

![BTC204](assets/fr/003.webp)

**Del 4: Forståelse av coinjoin-transaksjoner**

Hvordan kan vi snakke om personvern på Bitcoin uten å nevne coinjoins? I del 4 finner du ut alt du trenger å vite om denne blandingsmetoden. Du vil lære hva coinjoins er, deres historie og mål, samt de forskjellige typene coinjoins som finnes. Til slutt, for den mer erfarne brukeren, tar vi en titt på hva anonsets og entropi er, og hvordan du beregner dem.

![BTC204](assets/fr/004.webp)

**Del 5: Forstå utfordringene med andre avanserte konfidensialitetsteknikker**

I den femte delen tar vi en titt på alle de andre teknikkene som er tilgjengelige for å beskytte personvernet ditt på Bitcoin, bortsett fra coinjoin. Gjennom årene har utviklere vist bemerkelsesverdig kreativitet i utformingen av verktøy dedikert til personvern. Vi ser på alle disse metodene, som payjoin, samarbeidstransaksjoner, Coin Swap og Atomic Swap, og beskriver hvordan de fungerer, deres mål og eventuelle svakheter.

Vi ser også på personvern på nettverksnivå med noder og transaksjonsformidling. Vi diskuterer også de ulike protokollene som har blitt foreslått opp gjennom årene for å forbedre brukernes personvern på Bitcoin, inkludert statiske adresseprotokoller.

![BTC204](assets/fr/005.webp)
Klar til å utforske de intrikate aspektene ved personvern på Bitcoin? La oss gå!

# Definisjoner og nøkkelbegreper

<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>

## Bitcoins UTXO-modell

<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>


Bitcoin er først og fremst en valuta, men vet du egentlig hvordan BTC er representert på protokollen?

### UTXOer på Bitcoin: hva er de?

Bitcoin-protokollen er basert på UTXO-modellen, som står for "Unspent Transaction Output".

Denne modellen skiller seg vesentlig fra tradisjonelle banksystemer, som baserer seg på en mekanisme med kontoer og saldoer for å spore finansielle strømmer. I banksystemet opprettholdes individuelle saldoer på kontoer som er knyttet til en identitet. Når du for eksempel kjøper en baguette av en baker, trekker banken din ganske enkelt kjøpesummen fra din konto, noe som reduserer saldoen din, mens bakerens konto krediteres med det samme beløpet, noe som øker saldoen. I dette systemet er det ingen sammenheng mellom pengene som går inn på kontoen din og pengene som går ut av den, bortsett fra transaksjonsregistreringer.

![BTC204](assets/fr/006.webp)

Bitcoin fungerer annerledes. Konseptet med en konto eksisterer ikke, og monetære enheter administreres ikke via saldoer, men gjennom UTXOer. En UTXO representerer en bestemt mengde bitcoins som ennå ikke er brukt, og danner dermed et "stykke bitcoin", som kan være stort eller lite. For eksempel kan en UTXO være verdt 500 BTC eller bare 700 SATS.

**> Satoshien, ofte forkortet til sat, er Bitcoins minste enhet, som kan sammenlignes med centimeteren i fiat-valutaer.

```plaintext
1 BTC = 100 000 000 SATS
```

Teoretisk sett kan en UTXO representere en hvilken som helst verdi i bitcoins, alt fra en sat til et teoretisk maksimum på rundt 21 millioner BTC. Det er imidlertid logisk umulig å eie alle 21 millioner bitcoins, og det finnes en nedre økonomisk terskel som kalles "dust", under hvilken en UTXO anses som økonomisk ulønnsom å bruke.

**> Den største UTXO som noensinne er opprettet på Bitcoin hadde en verdi på `500,000 BTC`. Den ble opprettet av MtGox-plattformen under en konsolideringsoperasjon i november 2011: [29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXOer og utgiftsbetingelser

UTXO-er er utvekslingsinstrumentene på Bitcoin. Hver transaksjon resulterer i forbruk av UTXO-er som input og opprettelse av nye UTXO-er som output. Når en transaksjon er fullført, anses UTXOene som ble brukt som input, som "brukt", og nye UTXOer genereres og allokeres til mottakerne som er angitt i transaksjonsoutputen. En UTXO representerer dermed ganske enkelt en ubrukt transaksjonsutgang, og dermed en mengde bitcoins som tilhører en bruker på et gitt tidspunkt.

![BTC204](assets/fr/007.webp)

Alle UTXO-er er sikret av skript som definerer betingelsene for hvordan de kan brukes. For å bruke en UTXO må en bruker vise nettverket at han eller hun oppfyller vilkårene som er fastsatt i skriptet som sikrer UTXO-en. UTXO-er er vanligvis beskyttet av en offentlig nøkkel (eller en mottakeradresse som representerer denne offentlige nøkkelen). For å bruke en UTXO som er knyttet til denne offentlige nøkkelen, må brukeren bevise at han eller hun har den tilsvarende private nøkkelen, ved å levere en digital signatur laget med denne nøkkelen. Det er derfor vi sier at Bitcoin-lommeboken din faktisk ikke inneholder bitcoins, men lagrer de private nøklene dine, som i sin tur gir deg tilgang til UTXO-ene dine og, i forlengelsen av dette, til bitcoinsene de representerer.

![BTC204](assets/fr/008.webp)

Siden det ikke finnes noe kontokonsept i Bitcoin, er en lommeboks saldo ganske enkelt summen av verdiene til alle UTXO-ene den kan bruke. For eksempel, hvis Bitcoin-lommeboken din kan bruke følgende 4 UTXOer:

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

Den totale saldoen på porteføljen din vil være `17 BTC`.

![BTC204](assets/fr/009.webp)

## Strukturen til Bitcoin-transaksjoner

<chapterId>29d3aaab-de2e-4746-ab40-c9748898850c</chapterId>


### Transaksjonsinnganger og -utganger

En Bitcoin-transaksjon er en operasjon registrert i blokkjeden som overfører eierskap av bitcoins fra en person til en annen. Mer presist, siden vi er på en UTXO-modell og det ikke er noen kontoer, tilfredsstiller transaksjonen utgiftsbetingelsene som sikret en eller flere UTXO-er, forbruker dem og tilsvarende skaper nye UTXO-er med nye utgiftsbetingelser. Kort sagt flytter en transaksjon bitcoins fra et tilfredsstillende skript til et nytt skript som er utformet for å sikre dem.

![BTC204](assets/fr/010.webp)

Hver Bitcoin-transaksjon består derfor av én eller flere innganger og én eller flere utganger. Inputs er UTXO-er som forbrukes av transaksjonen for å generere outputs. Utganger er nye UTXO-er som kan brukes som innganger for fremtidige transaksjoner.

![BTC204](assets/fr/011.webp)

**> Teoretisk sett kan en bitcoin-transaksjon ha et uendelig antall innganger og utganger. Den eneste grensen er den maksimale blokkstørrelsen.

Hver input i en Bitcoin-transaksjon refererer til en tidligere ubrukt UTXO. For å bruke en UTXO som input, må innehaveren demonstrere at han/hun er den rettmessige eieren ved å validere det tilknyttede skriptet, dvs. ved å oppfylle utgiftsbetingelsen som er pålagt. Generelt sett betyr dette å levere en digital signatur produsert med den private nøkkelen som tilsvarer den offentlige nøkkelen som opprinnelig sikret denne UTXO-en. Skriptet består derfor i å verifisere at signaturen samsvarer med den offentlige nøkkelen som ble brukt da midlene ble mottatt.

![BTC204](assets/fr/012.webp)

Hver utgang spesifiserer i sin tur mengden bitcoins som skal overføres, samt mottakeren. Sistnevnte er definert av et nytt skript, som vanligvis blokkerer den nyopprettede UTXO-en med en mottakeradresse eller en ny offentlig nøkkel.

For at en transaksjon skal anses som gyldig i henhold til konsensusreglene, må summen av utganger være mindre enn eller lik summen av innganger. Med andre ord må summen av nye UTXO-er som genereres av transaksjonen, ikke overstige summen av UTXO-er som forbrukes som input. Dette prinsippet er logisk: Hvis du bare har 500 000 SATS, kan du ikke kjøpe 700 000 SATS.

### Utveksling og sammenslåing i en Bitcoin-transaksjon

En Bitcoin-transaksjon på UTXO kan dermed sammenlignes med å støpe om en gullmynt. En UTXO er faktisk ikke delbar, men bare smeltbar. Dette betyr at en bruker ikke bare kan dele en UTXO som representerer et visst beløp i bitcoins i flere mindre UTXO-er. Han må forbruke den i sin helhet i en transaksjon for å skape en eller flere nye UTXO-er med vilkårlige verdier i utganger, som må være mindre enn eller lik den opprinnelige verdien.

Denne mekanismen ligner på den som gjelder for en gullmynt. La oss si at du eier en mynt på 2 unse og ønsker å betale for 1 unse, forutsatt at selgeren ikke kan gi deg vekslepenger. Da må du smelte mynten din og støpe to nye mynter på 1 unse hver.

Bitcoin fungerer på en lignende måte. La oss tenke oss at Alice har en UTXO på 10 000 SATS` og ønsker å kjøpe en baguette til 4 000 SATS`. Alice vil foreta en transaksjon med 1 UTXO på 10 000 SATS` som input, som hun vil forbruke i sin helhet, og 2 UTXOer på henholdsvis 4 000 SATS` og 6 000 SATS` som output. UTXO-en på 4 000 SATS` sendes til bakeren som betaling for baguetten, mens UTXO-en på 6 000 SATS` kommer tilbake til Alice i form av vekslepenger. Denne UTXO-en, som går tilbake til den opprinnelige utstederen av transaksjonen, kalles "exchange" i Bitcoin-sjargongen.

![BTC204](assets/fr/013.webp)

La oss nå tenke oss at Alice ikke har én UTXO med 10 000 SATS, men to UTXOer med 3 000 SATS hver. I denne situasjonen er ingen av UTXO-ene hver for seg tilstrekkelig til å stille inn stavens `4 000 SATS`. Alice må derfor bruke de to UTXO-ene på 3 000 SATS` samtidig som input til transaksjonen. På denne måten vil den totale mengden input komme opp i 6 000 SATS`, slik at hun kan oppfylle betalingen på 4 000 SATS` til bakeren. Denne metoden, der flere UTXO-er grupperes sammen som innsatsfaktorer i en transaksjon, kalles ofte "sammenslåing".

![BTC204](assets/fr/014.webp)

### Transaksjonsgebyrer

Intuitivt skulle man kanskje tro at transaksjonskostnadene også representerer resultatet av en transaksjon. Men i virkeligheten er dette ikke tilfelle. Transaksjonskostnadene representerer differansen mellom totale innsatsfaktorer og totale resultater. Det betyr at etter at man har brukt en del av verdien av innsatsfaktorene til å dekke ønsket output i en transaksjon, gjenstår det en viss sum av innsatsfaktorene som ikke blir brukt. Denne restsummen utgjør transaksjonskostnadene.

```plaintext
Frais = total inputs - total outputs
```

La oss ta et eksempel med Alice, som har en UTXO på 10 000 SATS og ønsker å kjøpe en baguette til 4 000 SATS. Alice oppretter en transaksjon med UTXO på 10 000 SATS som input. Deretter genererer hun et output på 4 000 SATS til bakeren for å betale for baguetten. For å oppmuntre utvinnerne til å integrere transaksjonen hennes i en blokk, tildeler Alice 200 SATS i gebyrer. Deretter lager hun en ny output, vekslingen, som vil bli returnert til henne, og som beløper seg til 5800 SATS.

![BTC204](assets/fr/015.webp)

Ved å bruke avgiftsformelen ser vi at det faktisk er `200 SATS` igjen for mindreårige:

```plaintext
Frais = total inputs - total outputs
Frais = 10 000 - (4 000 + 5 800)
Frais = 10 000 - 9 800
Frais = 200
```

Når en miner lykkes med å validere en blokk, har han rett til å kreve inn disse avgiftene for alle transaksjonene som inngår i blokken hans, via den såkalte "coinbase"-transaksjonen.

### Opprette UTXO-er på Bitcoin

Hvis du har fulgt de foregående avsnittene nøye, vet du nå at UTXO-er bare kan opprettes ved å konsumere andre eksisterende UTXO-er. På denne måten danner Bitcoin-mynter en kontinuerlig kjede. Du lurer kanskje på hvordan de første UTXO-ene i denne kjeden ble til. Dette reiser et problem som ligner på høna og egget: Hvor kom disse opprinnelige UTXO-ene fra?

Svaret ligger i **transaksjonen coinbase**.

Coinbase er en bestemt type Bitcoin-transaksjon, som er unik for hver blokk og alltid er den første av disse. Den gjør det mulig for utvinneren som har funnet et gyldig arbeidsbevis, å motta blokkbelønningen sin. Denne belønningen består av to elementer: **blokktilskudd** og **transaksjonsgebyr**, som ble diskutert i forrige avsnitt.

Coinbase-transaksjonen er unik ved at den er den eneste som er i stand til å skape bitcoins ex nihilo, uten behov for å forbruke input for å generere output. Disse nyopprettede bitcoinsene er det vi kan kalle "originale UTXO-er".

![BTC204](assets/fr/016.webp)

Blokk-subsidierte bitcoins er nye BTC-er som opprettes fra bunnen av, i henhold til en forhåndsbestemt utstedelsesplan i konsensusreglene. Blokktilskuddet halveres hver 210 000. blokk, dvs. omtrent hvert fjerde år, i en prosess som kalles "halvering". Opprinnelig ble det opprettet 50 bitcoins for hvert tilskudd, men dette beløpet har gradvis blitt redusert, og i dag er det 3,125 bitcoins per blokk.

Selv om transaksjonsgebyrene også representerer nyopprettede BTC, må de ikke overstige differansen mellom den totale inn- og utgangen av alle transaksjonene i en blokk. Vi så tidligere at disse avgiftene representerer den delen av input som ikke brukes i transaksjonsoutput. Denne delen er teknisk sett "tapt" under transaksjonen, og utvinneren har rett til å gjenskape denne verdien i form av en eller flere nye UTXO-er. Dette er en verdioverføring mellom utstederen av transaksjonen og utvinneren som legger den til i blokkjeden.

**> Bitcoins generert av en coinbase-transaksjon er underlagt en forfallsperiode på 100 blokker, der de ikke kan brukes av gruvearbeideren. Denne regelen er utformet for å unngå komplikasjoner knyttet til bruk av nyopprettede bitcoins i en kjede som senere kan bli foreldet.

### Konsekvensene av UTXO-modellen

Først og fremst påvirker UTXO-modellen Bitcoins transaksjonsgebyrer direkte. Siden kapasiteten til hver blokk er begrenset, favoriserer utvinnere transaksjoner som tilbyr de beste avgiftene i forhold til plassen de vil ta opp i blokken. Jo flere UTXO-er en transaksjon inkluderer i sine inn- og utganger, jo tyngre er den, og krever derfor høyere gebyrer. Dette er en av grunnene til at vi ofte prøver å redusere antallet UTXO-er i porteføljen vår, noe som også kan påvirke konfidensialiteten, et tema vi skal ta for oss i detalj i den tredje delen av dette kurset.

For det andre, som nevnt i de foregående avsnittene, er Bitcoin-mynter i hovedsak en kjede av UTXO-er. Hver transaksjon skaper dermed en kobling mellom en tidligere UTXO og en fremtidig UTXO. UTXO-er gjør det derfor mulig å følge Bitcoins' vei fra de ble skapt til de brukes i dag. Denne gjennomsiktigheten kan ses på som positiv, ettersom den gjør det mulig for hver bruker å forsikre seg om ektheten til de mottatte bitcoinsene. Det er imidlertid også på dette prinsippet om sporbarhet og etterprøvbarhet at blokkjedeanalyse er basert, en praksis som er utformet for å kompromittere konfidensialiteten din. Vi skal se nærmere på denne praksisen i andre del av kurset.

## Bitcoins personvernmodell

<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>


### Penger: autentisitet, integritet og dobbeltforbruk

En av pengenes funksjoner er å løse problemet med dobbelt sammenfall av behov. I et system basert på byttehandel krever fullføringen av et bytte ikke bare at man finner en person som gir fra seg en vare som dekker mitt behov, men også at man gir ham en vare av tilsvarende verdi som tilfredsstiller hans eget behov. Å finne denne balansen er en kompleks sak.

![BTC204](assets/fr/017.webp)

Det er derfor vi bruker penger til å flytte verdier i både tid og rom.

![BTC204](assets/fr/018.webp)

For at mynter skal kunne løse dette problemet, er det avgjørende at den som tilbyr en vare eller tjeneste, er overbevist om at han eller hun er i stand til å bruke beløpet på et senere tidspunkt. Ethvert rasjonelt individ som ønsker å akseptere en mynt, enten den er digital eller fysisk, vil derfor sørge for at den oppfyller to grunnleggende kriterier:


- Verket må ha integritet og autentisitet ;**
- og må ikke brukes dobbelt.**

Hvis du bruker fysisk valuta, er det den første egenskapen som er mest kompleks å fastslå. I ulike perioder i historien har metallmyntenes integritet ofte blitt påvirket av praksiser som trimming eller piercing. I antikkens Roma var det for eksempel vanlig praksis at borgerne skrapte kantene på gullmyntene for å samle litt edelt metall, samtidig som de sparte dem til fremtidige transaksjoner. På denne måten ble myntenes egenverdi redusert, men den nominelle verdien forble den samme. Dette er en av grunnene til at kanten på mynten senere ble riflet.

Autentisitet er også en egenskap som er vanskelig å verifisere på et fysisk pengemedium. Dagens teknikker for å bekjempe falsk valuta blir stadig mer komplekse, noe som tvinger forhandlere til å investere i kostbare verifiseringssystemer.

På den annen side er dobbeltbruk ikke noe problem for fysiske valutaer på grunn av deres natur. Hvis jeg gir deg en 10-euroseddel, forlater den ugjenkallelig min besittelse og går over i din, noe som naturligvis utelukker enhver mulighet for dobbeltbruk av pengeenhetene den representerer. Kort sagt vil jeg ikke kunne bruke denne 10-euroseddelen igjen.

![BTC204](assets/fr/019.webp)

For digital valuta er det annerledes. Det er ofte enklere å sikre en mynts autentisitet og integritet. Som vi så i forrige avsnitt, gjør Bitcoins UTXO-modell det mulig å spore en mynt tilbake til dens opprinnelse, og dermed verifisere at den faktisk ble skapt av en utvinner i samsvar med konsensusreglene.

På den annen side er det mer komplisert å sikre at det ikke forekommer dobbeltbruk, siden alle digitale varer i bunn og grunn er informasjon. I motsetning til fysiske varer deles ikke informasjon opp når den utveksles, men spres ved at den multipliseres. Hvis jeg for eksempel sender deg et dokument på e-post, blir det duplisert. Du kan ikke være sikker på at jeg har slettet originaldokumentet.

![BTC204](assets/fr/020.webp)

### Forhindre dobbeltbruk av Bitcoin

Den eneste måten å unngå denne dupliseringen av en digital eiendel på, er å være klar over alle utvekslinger i systemet. På denne måten kan vi vite hvem som eier hva, og oppdatere hver persons beholdning i henhold til de transaksjonene som er utført. Det er dette som for eksempel skjer med skriftens penger i banksystemet. Når du betaler 10 euro til en kjøpmann med kredittkort, registrerer banken byttet og oppdaterer kontoboken.

![BTC204](assets/fr/021.webp)

På Bitcoin forhindres dobbeltbruk på samme måte. Vi forsøker å bekrefte at det ikke finnes en transaksjon som allerede har brukt de aktuelle myntene. Hvis myntene aldri har blitt brukt, kan vi være sikre på at det ikke vil forekomme dobbeltbruk. Dette prinsippet ble beskrevet av Satoshi Nakamoto i hvitboken med den berømte setningen:

**Den eneste måten å bekrefte fraværet av en transaksjon på, er å være klar over alle transaksjoner

Men i motsetning til bankmodellen ønsker vi ikke å måtte stole på en sentral enhet på Bitcoin. Derfor må alle brukere kunne bekrefte at det ikke forekommer dobbeltbruk, uten å måtte stole på en tredjepart. Derfor må alle være klar over alle Bitcoin-transaksjoner. Dette er grunnen til at Bitcoin-transaksjoner kringkastes offentlig på alle nettverksnoder og registreres i klartekst på blokkjeden.

Det er nettopp denne offentlige spredningen av informasjon som gjør det vanskelig å beskytte personvernet i Bitcoin. I det tradisjonelle banksystemet er det i teorien bare finansinstitusjonen som kjenner til transaksjonene som utføres. Med Bitcoin, derimot, blir alle brukere informert om alle transaksjoner via sine respektive noder.

### Konfidensialitetsmodellen: banksystemet vs. Bitcoin

I det tradisjonelle systemet er bankkontoen din knyttet til identiteten din. Bankmannen vet hvilken bankkonto som tilhører hvilken kunde, og hvilke transaksjoner som er knyttet til den. Denne informasjonsflyten er imidlertid avskåret mellom banken og offentligheten. Det er med andre ord umulig å kjenne til saldo og transaksjoner på en bankkonto som tilhører en annen person. Det er bare banken som har tilgang til denne informasjonen.

![BTC204](assets/fr/022.webp)

For eksempel vet bankmannen din at du kjøper baguetten din hver morgen hos den lokale bakeren, men naboen din har ingen kjennskap til denne transaksjonen. På denne måten er informasjonsflyten tilgjengelig for de berørte partene, særlig banken, men forblir utilgjengelig for utenforstående.

![BTC204](assets/fr/023.webp)

På grunn av begrensningen med offentlig formidling av transaksjoner som vi så i forrige avsnitt, kan ikke Bitcoins konfidensialitetsmodell følge modellen til banksystemet. I Bitcoins tilfelle, siden informasjonsflyten ikke kan brytes mellom transaksjonene og det offentlige domenet, er **konfidensialitetsmodellen avhengig av separasjonen mellom brukerens identitet og selve transaksjonene**.

![BTC204](assets/fr/024.webp)

Hvis du for eksempel kjøper en baguette av bakeren og betaler i BTC, kan naboen din, som har sin egen komplette node, se transaksjonen din gå gjennom, akkurat som han kan se alle andre transaksjoner i systemet. Men hvis konfidensialitetsprinsippene respekteres, skal han ikke kunne knytte denne spesifikke transaksjonen til din identitet.

![BTC204](assets/fr/025.webp)

Men siden Bitcoin-transaksjoner offentliggjøres, er det likevel mulig å etablere koblinger mellom dem for å utlede informasjon om de involverte partene. Denne aktiviteten utgjør til og med en egen spesialitet, kjent som "blokkjedeanalyse". I neste del av kurset inviterer jeg deg til å utforske det grunnleggende i blokkjedeanalyse, slik at du kan forstå hvordan bitcoinsene dine spores og bedre forsvare deg mot dem.

# Forståelse og beskyttelse mot kjedeanalyse

<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## Hva er Bitcoin-kjedeanalyse?

<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>


### Definisjon og drift

Blokkjedeanalyse er praksisen med å spore strømmen av bitcoins på blokkjeden. Generelt sett er kjedeanalyse basert på observasjon av karakteristikker i eksempler på tidligere transaksjoner. Deretter går det ut på å identifisere de samme kjennetegnene i en transaksjon som vi ønsker å analysere, og utlede plausible tolkninger fra dem. Denne problemløsningsmetoden, som er basert på en praktisk tilnærming til å finne en god nok løsning, kalles en "heuristikk".

Enkelt sagt er det tre hovedfaser i en kjedeanalyse:

1. **Observering av blokkjeden

2. **Identifisering av kjente funksjoner

3. **Fradrag av forutsetninger **

![BTC204](assets/fr/026.webp)

Blokkjedeanalyse kan utføres av hvem som helst. Alt du trenger er tilgang til blokkjedens offentlige informasjon via en komplett node for å observere transaksjonsbevegelser og lage hypoteser. Det finnes også gratis verktøy som gjør denne analysen enklere, for eksempel [OXT.me] (https://oxt.me/), som vi skal se nærmere på i de to siste kapitlene i denne delen. Den største risikoen for konfidensialitet kommer imidlertid fra selskaper som spesialiserer seg på strenganalyse. Disse selskapene har tatt blokkjedeanalyse til industriell skala og selger tjenestene sine til finansinstitusjoner og myndigheter. Blant disse selskapene er Chainalysis helt klart det mest kjente.

### Kjedeanalysens mål

Et av målene med blokkjedeanalyse er å gruppere ulike aktiviteter på Bitcoin for å finne ut hvem som har utført dem. Deretter vil det være mulig å forsøke å knytte denne klyngen av aktiviteter til en reell identitet.

![BTC204](assets/fr/027.webp)

Tenk tilbake til forrige kapittel. Jeg forklarte hvorfor Bitcoins personvernmodell opprinnelig var basert på separasjon av brukeridentitet fra transaksjoner. Det ville derfor være fristende å tro at blokkjedeanalyse er ubrukelig, for selv om vi klarer å aggregere aktiviteter i blokkjeden, kan vi ikke knytte dem til en ekte identitet.

Teoretisk sett er denne påstanden korrekt. I første del av dette kurset så vi at kryptografiske nøkkelpar brukes til å etablere betingelser på UTXO. I bunn og grunn avslører disse nøkkelparene ingen informasjon om identiteten til innehaverne. Så selv om vi klarer å gruppere aktivitetene som er knyttet til ulike nøkkelpar, forteller dette oss ingenting om enheten som står bak disse aktivitetene.

![BTC204](assets/fr/028.webp)

Den praktiske virkeligheten er imidlertid langt mer kompleks. Det finnes en rekke atferdsmønstre som kan knytte en ekte identitet til aktivitet i kjeden. I analyse kalles dette et inngangspunkt, og det finnes et mangfold av dem.

Det vanligste er KYC (*Know Your Customer*). Hvis du tar ut Bitcoins fra en regulert plattform til en av dine personlige mottaksadresser, er det noen som kan knytte identiteten din til den adressen. Mer generelt kan et inngangspunkt være enhver form for interaksjon mellom ditt virkelige liv og en Bitcoin-transaksjon. Hvis du for eksempel publiserer en mottakeradresse på dine sosiale nettverk, kan dette være et inngangspunkt for analyse. Hvis du betaler med Bitcoins til bakeren din, vil han kunne knytte ansiktet ditt (en del av identiteten din) til en Bitcoin-adresse.

Disse inngangspunktene er så godt som uunngåelige når man bruker Bitcoin. Selv om vi kan forsøke å begrense omfanget av dem, vil de alltid være til stede. Derfor er det avgjørende å kombinere metoder som tar sikte på å bevare personvernet ditt. Selv om det å opprettholde et skille mellom din virkelige identitet og transaksjonene dine er en interessant tilnærming, er det fortsatt utilstrekkelig i dag. Hvis alle aktivitetene dine i kjeden kan grupperes sammen, vil selv det minste inngangspunktet sannsynligvis kompromittere det eneste laget av konfidensialitet du har etablert.

![BTC204](assets/fr/029.webp)

### Forsvar deg mot kjedeanalyse

Derfor må vi også kunne håndtere blokkjedeanalyse i vår bruk av Bitcoin. På denne måten kan vi minimere aggregeringen av aktivitetene våre og begrense innvirkningen av et inngangspunkt på personvernet vårt.

![BTC204](assets/fr/030.webp)

Hvilken bedre måte å motvirke blockchain-analyse på enn å lære om metodene som brukes i den? Hvis du vil vite hvordan du kan forbedre personvernet ditt på Bitcoin, må du forstå disse metodene. Dette vil gi deg en bedre forståelse av teknikker som coinjoin eller payjoin (teknikker vi vil se på i de siste delene av kurset), og redusere feilene du kan gjøre.

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef

https://planb.network/tutorials/privacy/on-chain/payjoin-848b6a23-deb2-4c5f-a27e-93e2f842140f

Her kan vi trekke en analogi til kryptografi og kryptoanalyse. En god kryptograf er først og fremst en god kryptoanalytiker. For å utvikle en ny krypteringsalgoritme må du vite hvilke angrep den vil bli utsatt for, og du må også studere hvorfor tidligere algoritmer har blitt brutt. Det samme prinsippet gjelder for Bitcoin-personvern. Å forstå blokkjedeanalysemetoder er nøkkelen til å beskytte seg mot dem. Derfor har jeg inkludert en hel seksjon om kjedeanalyse i dette kurset.

### Metoder for kjedeanalyse

Det er viktig å forstå at strenganalyse ikke er en eksakt vitenskap. Den baserer seg på heuristikker utledet fra tidligere observasjoner eller logiske tolkninger. Disse reglene gjør at vi kan oppnå relativt pålitelige resultater, men aldri med absolutt presisjon. Med andre ord innebærer **kjedeanalyse alltid en viss sannsynlighetsdimensjon i de konklusjonene man kommer frem til**. For eksempel kan det være mulig å anslå med varierende grad av sikkerhet at to adresser tilhører samme enhet, men total sikkerhet vil alltid være utenfor rekkevidde.

Hele poenget med kjedeanalyse ligger nettopp i aggregeringen av ulike heuristikker for å minimere risikoen for feil. På en måte er det en opphopning av bevis som bringer oss nærmere virkeligheten.

Disse berømte heuristikkene kan grupperes i ulike kategorier, som vi vil beskrive i detalj nedenfor:


- Transaksjonsmønstre ;**
- Transaksjonsintern heuristikk ;**
- Heuristikk utenfor transaksjonen**

### Satoshi Nakamoto og kjedeanalyse

De to første heuristikkene for kjedeanalyse ble oppdaget av Satoshi Nakamoto selv. Han snakker om dem i del 10 av Bitcoins hvitbok. De er :


- cIOH (*Common Input Ownership Heuristic*);
- og gjenbruk av adresser.

![BTC204](assets/fr/031.webp)

Kilde: S. Nakamoto: S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

Vi skal se hva de er i de neste kapitlene, men allerede nå er det interessant å merke seg at disse to heuristikkene fortsatt har en fremtredende plass i dagens kjedeanalyse.

## Transaksjonsmønstre

<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>


Et transaksjonsmønster er ganske enkelt en overordnet modell eller struktur for en typisk transaksjon som finnes i blokkjeden, og som man vet hvordan kan tolkes. Når vi studerer mønstre, fokuserer vi på én enkelt transaksjon og analyserer den på et høyt nivå.

Vi skal med andre ord bare se på antall UTXO i innganger og antall UTXO i utganger, uten å gå inn på de mer spesifikke detaljene eller miljøet rundt transaksjonen. Basert på det observerte mønsteret kan vi tolke transaksjonens natur. Vi vil deretter se etter kjennetegn ved strukturen og utlede en tolkning.

![BTC204](assets/fr/032.webp)

I dette avsnittet skal vi sammen se på de viktigste transaksjonsmodellene i kjedeanalyse, og for hver modell skal jeg gi deg en sannsynlig tolkning av denne strukturen, samt et konkret eksempel.

### Enkeltforsendelse (eller enkeltbetaling)

La oss starte med et veldig vanlig mønster, siden det er det som dukker opp på de fleste bitcoinbetalinger. Den enkle betalingsmodellen kjennetegnes av forbruk av en eller flere UTXO-er som input og produksjon av 2 UTXO-er som output. Denne modellen ser derfor slik ut:

![BTC204](assets/fr/033.webp)

Når vi ser denne transaksjonsstrukturen på blokkjeden, kan vi allerede trekke en tolkning. Som navnet antyder, indikerer denne modellen at vi er i nærvær av en sende- eller betalingstransaksjon. Brukeren har brukt sin egen UTXO som input for å tilfredsstille en UTXO for betaling og en UTXO for utveksling (penger som returneres til samme bruker) som output.

Vi vet derfor at den observerte brukeren sannsynligvis ikke lenger er i besittelse av den ene av de to UTXO-ene (betalings UTXO-en), men fortsatt er i besittelse av den andre UTXO-en (utvekslings UTXO-en).

For øyeblikket kan vi ikke spesifisere hvilken utgang som representerer hvilken UTXO, siden dette ikke er formålet med mønsterstudien. Vi vil komme dit ved hjelp av heuristikken vi studerer i de følgende avsnittene. På dette stadiet er målet vårt begrenset til å identifisere hva slags transaksjon det er snakk om, som i dette tilfellet er en enkel sending.

Her er for eksempel en Bitcoin-transaksjon som bruker det enkle sendemønsteret:

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/fr/034.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

Etter dette første eksemplet bør du ha fått en bedre forståelse av hva det vil si å studere en "transaksjonsmodell". Vi undersøker en transaksjon ved å fokusere utelukkende på dens struktur, uten å ta hensyn til omgivelsene eller de spesifikke detaljene i transaksjonen. I dette første trinnet ser vi bare på det store bildet.

Nå som du har forstått hva et mønster er, kan vi gå videre til de andre eksisterende modellene.

### Feiing

Denne andre modellen kjennetegnes av forbruk av én enkelt UTXO som input og produksjon av én enkelt UTXO som output.

![BTC204](assets/fr/035.webp)

Tolkningen av denne modellen er at vi er i nærvær av en selvoverføring. Brukeren har overført sine bitcoins til seg selv, til en annen adresse som tilhører ham. Siden det ikke er noen utveksling på transaksjonen, er det svært usannsynlig at vi er i nærvær av en betaling. Når en betaling utføres, er det faktisk nesten umulig for betaleren å ha en UTXO som tilsvarer nøyaktig beløpet som kreves av selgeren, pluss transaksjonsgebyret. Generelt er betaleren derfor forpliktet til å produsere en utvekslingseffekt.

Vi vet da at den observerte brukeren sannsynligvis fortsatt er i besittelse av denne UTXO-en. I forbindelse med en kjedeanalyse, hvis vi vet at UTXO-en som ble brukt som input i transaksjonen tilhører Alice, kan vi anta at UTXO-en som ble brukt som output også tilhører henne. Det som blir interessant senere, er å finne transaksjonsinterne heuristikker som kan styrke denne antagelsen (vi skal se på disse heuristikkene i kapittel 3.3).

Her er for eksempel en Bitcoin-transaksjon som følger sveipemønsteret:

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/fr/036.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d)

Vær imidlertid oppmerksom på at denne typen mønster også kan avsløre en selvoverføring til kontoen til en kryptovaluta-utvekslingsplattform. Det vil være studiet av kjente adresser og konteksten til transaksjonen som vil fortelle oss om det er et sveip til en selvbevarende lommebok eller et uttak til en plattform. Adressene til utvekslingsplattformene er faktisk ofte lett identifiserbare.

La oss ta Alices eksempel igjen: Hvis skanningen fører til en adresse som er kjent for en plattform (som Binance, for eksempel), kan dette bety at bitcoinsene har blitt overført ut av Alices direkte besittelse, sannsynligvis med den hensikt å selge dem eller lagre dem på denne plattformen. Hvis destinasjonsadressen derimot er ukjent, er det rimelig å anta at det rett og slett er en annen lommebok som fortsatt tilhører Alice. Men denne typen studier er mer i kategorien heuristikk enn mønstre.

### Konsolidering

Denne modellen kjennetegnes ved at det forbrukes flere UTXO-er ved inngangen og produseres én UTXO ved utgangen.

![BTC204](assets/fr/037.webp)

Tolkningen av dette mønsteret er at vi er i nærvær av konsolidering. Dette er en vanlig praksis blant Bitcoin-brukere, som har som mål å slå sammen flere UTXO-er i påvente av en mulig økning i transaksjonsgebyrene. Ved å utføre denne operasjonen i en periode hvor avgiftene er lave, er det mulig å spare på fremtidige avgifter. Vi skal snakke mer om denne praksisen i kapittel 4.3.

Vi kan utlede at brukeren bak denne transaksjonsmodellen sannsynligvis var i besittelse av alle UTXO-ene i input og fortsatt er i besittelse av UTXO-en i output. Så det er sannsynligvis en automatisk overføring.

I likhet med sweep kan denne typen mønster også avsløre en egenoverføring til kontoen til en utvekslingsplattform. Det vil være studiet av kjente adresser og konteksten for transaksjonen som vil fortelle oss om det er en konsolidering til en egenbeholdning eller et uttak til en plattform.

Her er for eksempel en Bitcoin-transaksjon som følger konsolideringsmønsteret:

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/fr/038.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)

I en kjedeanalyse kan denne modellen avsløre mye informasjon. Hvis vi for eksempel vet at en av inndataene tilhører Alice, kan vi anta at alle de andre inndataene og utdataene fra denne transaksjonen også tilhører henne. Denne antakelsen gjør det mulig å gå tilbake i kjeden av tidligere transaksjoner for å finne og analysere andre transaksjoner som sannsynligvis kan knyttes til Alice.

![BTC204](assets/fr/039.webp)

### Grupperte utgifter

Denne modellen kjennetegnes av forbruk av noen få UTXO-er som input (ofte bare én) og produksjon av mange UTXO-er som output.

![BTC204](assets/fr/040.webp)

Tolkningen av denne modellen er at vi er i nærvær av grupperte utgifter. Det er en praksis som sannsynligvis avslører en svært stor økonomisk aktivitet, for eksempel en utvekslingsplattform. Grupperte utgifter gjør det mulig for disse enhetene å spare kostnader ved å kombinere utgiftene sine i én enkelt transaksjon.

Vi kan utlede fra denne modellen at UTXO i input kommer fra et selskap med høy økonomisk aktivitet, og at UTXO i output vil spre seg. Mange vil tilhøre selskapets kunder som har tatt ut bitcoins fra plattformen. Andre kan gå til partnerbedrifter. Til slutt vil det helt sikkert være en eller flere utvekslinger som går tilbake til det utstedende selskapet.

Her er for eksempel en Bitcoin-transaksjon som bruker det samlede utgiftsmønsteret (antageligvis er det en transaksjon utstedt av Bybit-plattformen):

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/fr/041.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### Protokollspesifikke transaksjoner

Blant transaksjonsmønstrene kan vi også identifisere dem som avslører bruk av en bestemt protokoll. For eksempel vil Whirlpool coinjoins (omtalt i del 5) ha en lett identifiserbar struktur som skiller dem fra andre, mer konvensjonelle transaksjoner.

![BTC204](assets/fr/042.webp)

En analyse av dette mønsteret tyder på at vi sannsynligvis er i nærheten av en samarbeidstransaksjon. Det er også mulig å observere en coinjoin. Hvis sistnevnte hypotese viser seg å stemme, kan antallet exits gi oss et grovt estimat av antall deltakere i coinjoin.

Her er for eksempel en Bitcoin-transaksjon som bruker det samarbeidende transaksjonsmønsteret coinjoin:

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/fr/043.webp)

Source : [Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

Det finnes mange andre protokoller med sine egne spesifikke strukturer. Det finnes for eksempel Wabisabi-transaksjoner, Stamps og Runes-transaksjoner.

Takket være disse transaksjonsmønstrene kan vi allerede tolke en viss mengde informasjon om en gitt transaksjon. Men transaksjonsstrukturen er ikke den eneste kilden til informasjon som kan analyseres. Vi kan også studere detaljene. Disse interne detaljene kaller jeg "interne heuristikker", og vi skal se nærmere på dem i neste kapittel.

## Interne heuristikker

<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>


En intern heuristikk er en spesifikk egenskap som vi identifiserer i selve transaksjonen, uten at vi trenger å undersøke omgivelsene, og som gjør det mulig for oss å trekke slutninger. I motsetning til mønstre, som fokuserer på den overordnede strukturen i transaksjonen på et overordnet nivå, er interne heuristikker basert på et sett med data som kan hentes ut. Dette inkluderer


- Mengden av de ulike UTXO-ene inn og ut;
- Alt som har med skript å gjøre: mottaksadresser, versjonering, låsetider...

Generelt sett vil denne typen heuristikk gjøre oss i stand til å identifisere utvekslingen i en spesifikk transaksjon. På den måten kan vi fortsette sporingen av en enhet over flere forskjellige transaksjoner. Hvis vi identifiserer en UTXO som tilhører en bruker vi ønsker å spore, er det avgjørende å finne ut hvilken utgang som har blitt overført til en annen bruker, og hvilken utgang som representerer utvekslingen, og som dermed forblir i brukerens besittelse, når han utfører en transaksjon.

![BTC204](assets/fr/044.webp)

La meg igjen minne om at disse heuristikkene ikke er helt presise. Hver for seg gjør de oss bare i stand til å identifisere sannsynlige scenarier. Det er akkumuleringen av flere heuristikker som bidrar til å redusere usikkerheten, uten at vi noen gang kan eliminere den helt.

### Interne likheter

Denne heuristikken går ut på å studere likheter mellom inndata og utdata i en og samme transaksjon. Hvis den samme egenskapen observeres på inndataene og på bare én av transaksjonens utdata, er det sannsynlig at denne utdataen utgjør utvekslingen.

Den mest åpenbare funksjonen er gjenbruk av en mottakeradresse i samme transaksjon.

![BTC204](assets/fr/045.webp)

Denne heuristikken gir lite rom for tvil. Med mindre den private nøkkelen hans er blitt hacket, avslører den samme mottakeradressen nødvendigvis aktiviteten til én enkelt bruker. Tolkningen er at transaksjonsutvekslingen er utgangen med samme adresse som inngangen. Vi kan deretter fortsette å spore personen fra denne utvekslingen.

Her er for eksempel en transaksjon som denne heuristikken sannsynligvis kan brukes på:

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/fr/046.webp)

Source : [Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

Disse likhetene mellom inn- og utdata stopper ikke ved gjenbruk av adresser. Enhver likhet i bruken av skript kan brukes til å anvende en heuristikk. For eksempel kan vi noen ganger observere samme versjonering mellom inndata og en av transaksjonsutdataene.

![BTC204](assets/fr/047.webp)

På dette diagrammet kan vi se at inngang nr. 0 låser opp et P2WPKH-skript (SegWit V0 som starter med `bc1q`). Utgang nr. 0 bruker samme type skript. Utgang nr. 1, derimot, bruker et P2TR-skript (SegWit V1 som begynner med `bc1p`). Tolkningen av denne funksjonen er at det er sannsynlig at adressen med samme versjonering som inndataadressen er utvekslingsadressen. Den vil derfor alltid tilhøre den samme brukeren.

Her er en transaksjon som denne heuristikken sannsynligvis kan brukes på:

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/fr/048.webp)

Source : [Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)

På sistnevnte kan vi se at inngang nr. 0 og utgang nr. 1 bruker P2WPKH-skript (SegWit V0), mens utgang nr. 0 bruker et annet P2PKH-skript (Legacy).

På begynnelsen av 2010-tallet var denne heuristikken basert på skriptversjonering relativt lite nyttig på grunn av de begrensede skripttypene som var tilgjengelige. Etter hvert som Bitcoin har blitt oppdatert, har det imidlertid blitt introdusert et økende mangfold av skripttyper. Denne heuristikken blir derfor stadig mer relevant, ettersom brukerne deler seg inn i mindre grupper med et større utvalg av skripttyper, noe som øker sjansene for å bruke denne interne heuristikken for gjenbruk av versjonering. Av denne grunn er det, kun ut fra et konfidensialitetsperspektiv, tilrådelig å velge den vanligste typen skript. I skrivende stund er for eksempel Taproot-skript (`bc1p`) mindre brukt enn SegWit V0-skript (`bc1q`). Selv om førstnevnte gir økonomiske og konfidensialitetsmessige fordeler i visse spesifikke sammenhenger, kan det for mer tradisjonell bruk med én signatur være fornuftig å holde seg til en eldre standard av konfidensialitetshensyn, inntil den nye standarden er tatt i bruk i større utstrekning.

### Betalinger med runde tall

En annen intern heuristikk som kan hjelpe oss med å identifisere utvekslingen, er rundetallheuristikken. Generelt sett er det slik at når man står overfor et enkelt betalingsmønster (1 inngang og 2 utganger), vil det være betalingen hvis en av utgangene bruker et rundt beløp.

![BTC204](assets/fr/049.webp)

Ved eliminering, hvis den ene utgangen representerer betaling, representerer den andre utvekslingen. Det kan derfor tolkes som sannsynlig at inputbrukeren alltid er i besittelse av den outputen som er identifisert som bytte.

Det bør understrekes at denne heuristikken ikke alltid er anvendelig, siden de fleste betalinger fortsatt gjøres i fiduciære regningsenheter. Når en forhandler i Frankrike aksepterer bitcoin, vil han som regel ikke vise stabile priser i sats. I stedet vil han velge en konvertering mellom prisen i euro og beløpet i bitcoins som skal betales. Det bør derfor ikke være noen runde tall på slutten av transaksjonen.

En analytiker kan likevel prøve å gjøre denne omregningen ved å ta hensyn til valutakursen som gjaldt da transaksjonen ble sendt ut i nettverket. La oss ta et eksempel på en transaksjon med en inngang på 97 552 sats og to utganger, den ene på 31 085 sats og den andre på 64 152 sats. Ved første øyekast ser ikke denne transaksjonen ut til å involvere runde beløp. Ved å bruke valutakursen på 64 339 euro på transaksjonstidspunktet får vi imidlertid følgende omregning til euro


- En innsats på 62,76 euro;
- En produksjon på 20 euro;
- Et resultat på 41,27 euro.

Når transaksjonen er konvertert til fiat-valuta, kan den brukes til å anvende heuristikken for betaling med runde beløp. Utbetalingen på 20 euro har sannsynligvis gått til en forhandler, eller i det minste skiftet eier. Ut fra dette er det sannsynlig at utbetalingene på 41,27 euro forble i den opprinnelige brukerens besittelse.

![BTC204](assets/fr/050.webp)

Hvis bitcoin en dag blir den foretrukne regningsenheten på børsene våre, kan denne heuristikken bli enda mer nyttig for analyse.

Her er for eksempel en transaksjon som denne heuristikken sannsynligvis kan brukes på:

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/fr/051.webp)

Source : [Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)

### Den største produksjonen

Når vi identifiserer et tilstrekkelig stort gap mellom to transaksjonsoutput i en enkel betalingsmodell, kan vi anslå at det største outputtet sannsynligvis er valuta.

![BTC204](assets/fr/052.webp)

Denne heuristikken for størst produksjon er helt klart den mest upresise av alle. I seg selv er den ganske svak. Men denne funksjonen kan kombineres med andre heuristikker for å redusere usikkerheten i tolkningen vår.

Hvis vi for eksempel ser på en transaksjon med en rund betaling og en større betaling, vil det å bruke heuristikken for rund betaling og heuristikken for større betaling sammen redusere usikkerhetsnivået vårt.

Her er for eksempel en transaksjon som denne heuristikken sannsynligvis kan brukes på:

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/fr/053.webp)

Source : [Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## Ekstern heuristikk

<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>


Studiet av eksterne heuristikker innebærer å analysere likheter, mønstre og egenskaper ved visse elementer som ikke er spesifikke for selve transaksjonen. Med andre ord: Mens vi tidligere begrenset oss til å utnytte elementer som var iboende i transaksjonen med interne heuristikker, utvider vi nå analysefeltet til å omfatte transaksjonens omgivelser, takket være eksterne heuristikker.

### Gjenbruk av adresse

Dette er en av bitcoinernes mest kjente heuristikker. Gjenbruk av adresser gjør det mulig å etablere en kobling mellom ulike transaksjoner og ulike UTXO-er. Det skjer når en Bitcoin-mottakeradresse brukes flere ganger.

Dermed er det mulig å utnytte gjenbruk av adresser innenfor samme transaksjon som en intern heuristikk for å identifisere utvekslingen (som vi så i forrige kapittel). Men gjenbruk av adresser kan også brukes som en ekstern heuristikk for å gjenkjenne en unik enhet bak flere transaksjoner.

Tolkningen av gjenbruk av en adresse er at alle UTXO-er som er blokkert på den adressen, tilhører (eller har tilhørt) samme enhet. Denne heuristikken gir lite rom for usikkerhet. Når den først er identifisert, er det sannsynlig at tolkningen som blir resultatet, samsvarer med virkeligheten. Den gjør det derfor mulig å gruppere ulike aktiviteter i kjeden.

![BTC204](assets/fr/054.webp)

Som forklart i innledningen til del 3, ble denne heuristikken oppdaget av Satoshi Nakamoto selv. I hvitboken nevner han en løsning for å hjelpe brukerne med å unngå å generere den, nemlig å bruke en tom adresse for hver nye transaksjon:

"_Som en ekstra brannmur kan et nytt nøkkelpar brukes for hver transaksjon, slik at de ikke knyttes til en felles eier."

![BTC204](assets/fr/055.webp)

Kilde: S. Nakamoto: S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

Her er for eksempel en adresse som gjenbrukes i flere transaksjoner:

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/056.webp)

Kilde: [Mempool.space] (https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### Skriptlikhet og lommebokavtrykk

I tillegg til gjenbruk av adresser finnes det mange andre heuristikker som gjør det mulig å knytte handlinger til samme portefølje eller adresseklynge.

For det første kan en analytiker se etter likheter i skriptbruken. For eksempel kan visse minoritetsskript som multisig være lettere å oppdage enn SegWit V0-skript. Jo større gruppen vi gjemmer oss i, desto vanskeligere er det å oppdage oss. Dette er en av grunnene til at alle deltakerne i gode Coinjoin-protokoller bruker nøyaktig samme type skript.

Mer generelt kan en analytiker også fokusere på de karakteristiske fingeravtrykkene til en portefølje. Dette er bruksspesifikke prosesser som kan identifiseres med tanke på å utnytte dem som sporingsheuristikk. Med andre ord, hvis vi observerer en opphopning av de samme interne karakteristikkene i transaksjoner som tilskrives den sporede enheten, kan vi forsøke å identifisere de samme karakteristikkene i andre transaksjoner.

For eksempel vil vi kunne identifisere at den sporede brukeren systematisk sender endringene sine til P2TR-adresser (`bc1p...`). Hvis denne prosessen gjentas, kan vi bruke den som en heuristikk for resten av analysen. Vi kan også bruke andre fingeravtrykk, for eksempel rekkefølgen på UTXO-er, plasseringen av endringen i utdataene, RBF-signalering (Replace-by-Fee), eller versjonsnummeret, `nSequence`-feltet og `nLockTime`-feltet.

![BTC204](assets/fr/057.webp)

Som [@LaurentMT] (https://twitter.com/LaurentMT) påpeker i [Space Kek #19] (https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji) (en franskspråklig podkast), øker nytten av porteføljefingeravtrykk i kjedeanalyse betydelig over tid. Det økende antallet skripttyper og porteføljeprogramvarenes stadig mer progressive bruk av disse nye funksjonene forsterker forskjellene. I noen tilfeller er det til og med mulig å identifisere den eksakte programvaren som brukes av enheten som spores. Det er derfor viktig å forstå at studiet av porteføljefotavtrykk er spesielt relevant for nyere transaksjoner, snarere enn for dem som ble initiert tidlig på 2010-tallet.

For å oppsummere kan et fotavtrykk være en hvilken som helst spesifikk praksis, utført automatisk av lommeboken eller manuelt av brukeren, som vi kan finne på andre transaksjoner for å hjelpe oss i analysen vår.

### Heuristikken for felles input-eierskap (CIOH)

Common Input Ownership Heuristic (CIOH) er en heuristikk som sier at når en transaksjon har flere inndata, er det sannsynlig at de alle stammer fra én og samme enhet. Følgelig er eierskapet til dem felles.

![BTC204](assets/fr/058.webp)

For å anvende CIOH observerer vi først en transaksjon med flere inndata. Det kan være to innganger eller 30 innganger. Når denne karakteristikken er identifisert, sjekker vi om transaksjonen passer inn i en kjent transaksjonsmodell. Hvis det for eksempel er fem innganger med omtrent samme beløp og fem utganger med nøyaktig samme beløp, vet vi at dette er strukturen til en coinjoin. Vi vil ikke kunne bruke CIOH.

![BTC204](assets/fr/059.webp)

Hvis transaksjonen derimot ikke passer inn i noen kjent samarbeidende transaksjonsmodell, kan vi tolke det slik at alle inndataene sannsynligvis kommer fra samme enhet. Dette kan være svært nyttig for å utvide en allerede kjent klynge eller fortsette et spor.

![BTC204](assets/fr/060.webp)

CIOH ble oppdaget av Satoshi Nakamoto. Han snakker om det i del 10 av hvitboken:

"_[...] kobling er uunngåelig ved transaksjoner med flere poster, som nødvendigvis avslører at postene har samme eier. Risikoen er at hvis eieren av en nøkkel blir avslørt, kan koblingene avsløre andre transaksjoner som tilhørte samme eier."

![BTC204](assets/fr/061.webp)

Det er spesielt fascinerende å merke seg at Satoshi Nakamoto, allerede før den offisielle lanseringen av Bitcoin, hadde identifisert de to viktigste sårbarhetene for brukernes personvern, nemlig CIOH og gjenbruk av adresser. En slik framsynthet er ganske bemerkelsesverdig, ettersom disse to heuristikkene fortsatt i dag er de mest nyttige i blokkjedeanalyse.

Her er et eksempel på en transaksjon som vi sannsynligvis kan bruke CIOH på:

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

![BTC204](assets/fr/062.webp)

Source : [Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### Data utenfor kjeden

Kjedeanalyse er selvsagt ikke begrenset til data fra kjeden. Alle data fra en tidligere analyse eller data som er tilgjengelige på Internett, kan også brukes til å forbedre en analyse.

Hvis vi for eksempel observerer at sporede transaksjoner systematisk sendes fra den samme Bitcoin-noden, og vi klarer å identifisere IP-adressen, kan vi kanskje identifisere andre transaksjoner fra den samme enheten, samt bestemme deler av utstederens identitet. Selv om denne praksisen ikke er lett å oppnå, ettersom den krever drift av mange noder, kan den brukes av noen selskaper som spesialiserer seg på blokkjedeanalyse.

Analytikeren har også muligheten til å støtte seg på analyser som tidligere er lagt ut i åpen kildekode, eller på sine egne tidligere analyser. Kanskje finner vi en output som peker mot en klynge av adresser vi allerede har identifisert. Noen ganger er det også mulig å basere seg på utganger som peker mot en utvekslingsplattform, ettersom adressene til disse selskapene er allment kjent.

På samme måte kan du utføre en analyse ved eliminering. Hvis du for eksempel analyserer en transaksjon med to utganger, og en av dem er knyttet til en allerede kjent adresseklynge, men som er forskjellig fra enheten vi sporer, kan vi tolke det slik at den andre utgangen sannsynligvis representerer utvekslingen.

Kanalanalysen omfatter også en litt mer generell OSINT-komponent (*Open Source Intelligence*), som innebærer søk på internett. Derfor fraråder vi å publisere adresser direkte på sosiale nettverk eller på en nettside, uansett om de er pseudonyme eller ikke.

![BTC204](assets/fr/063.webp)

### Temporale modeller

Vi tenker ikke så mye over det, men visse menneskelige atferdsmønstre er gjenkjennelige i kjeden. Kanskje det mest nyttige i en analyse er søvnmønsteret ditt! Ja, når du sover, sender du ikke Bitcoin-transaksjoner. Men du sover vanligvis på omtrent samme tid. Dette er grunnen til at det er vanlig praksis å bruke tidsanalyse i blokkjedeanalyse. Dette er ganske enkelt en opptelling av tidspunktene for når en gitt enhets transaksjoner sendes til Bitcoin-nettverket. Ved å analysere disse tidsmønstrene kan vi utlede et vell av informasjon.

Først og fremst kan en tidsanalyse noen ganger identifisere hva slags enhet som spores. Hvis vi observerer at transaksjonene sendes konsekvent over 24 timer, vil dette tyde på høy økonomisk aktivitet. Enheten som står bak disse transaksjonene, er sannsynligvis et selskap, potensielt internasjonalt og kanskje med automatiserte interne prosedyrer.

For eksempel [gjenkjente jeg dette mønsteret for noen måneder siden](https://twitter.com/Loic_Pandul/status/1701127409712452072) da jeg analyserte [transaksjonen som feilaktig hadde allokert 19 bitcoins i gebyrer](https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd). En enkel tidsanalyse ga meg muligheten til å anta at vi hadde å gjøre med en automatisert tjeneste, og derfor sannsynligvis med en stor enhet som en utvekslingsplattform.

Noen dager senere ble det oppdaget at midlene tilhørte PayPal, via utvekslingsplattformen Paxos.

Hvis vi derimot kan se at det tidsmessige mønsteret er spredt over 16 spesifikke timer, kan vi anslå at vi har å gjøre med en enkelt bruker, eller kanskje et lokalt selskap, avhengig av volumet som utveksles.

I tillegg til hva slags enhet som er observert, kan tidsmønsteret også fortelle oss omtrent hvor brukeren befinner seg, takket være tidssoner. På denne måten kan vi matche andre transaksjoner og bruke tidsstemplene deres som en ekstra heuristikk som kan legges til i analysen vår.

På den flerbruksadressen jeg nevnte tidligere, kan vi for eksempel se at transaksjonene, både innkommende og utgående, er konsentrert på et 13-timers intervall.

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/064.webp)

Kilde: OXT.me

Dette området tilsvarer trolig Europa, Afrika eller Midtøsten. Vi kan derfor anta at brukeren bak disse transaksjonene bor i disse områdene.

På en annen måte førte en tidsanalyse av denne typen også til hypotesen om at Satoshi Nakamoto ikke opererte fra Japan, men fra USA: [*The Time Zones of Satoshi Nakamoto*](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## Bruk det i praksis med en blokkutforsker

<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

I dette siste kapittelet skal vi sette konseptene vi har studert så langt ut i praksis. Jeg skal vise deg eksempler på ekte Bitcoin-transaksjoner, og du må selv hente ut informasjonen jeg ber deg om.

Ideelt sett, for å utføre disse øvelsene, ville bruk av et profesjonelt kjedeanalyseverktøy være å foretrekke. Siden arrestasjonen av skaperne av Samourai Wallet er imidlertid det eneste gratis analyseverktøyet OXT.me ikke lenger tilgjengelig. Vi velger derfor en klassisk blokkutforsker for disse øvelsene. Jeg anbefaler å bruke [Mempool.space] (https://mempool.space/) på grunn av de mange funksjonene og utvalget av kjedeanalyseverktøy, men du kan også velge en annen utforsker, for eksempel [Bitcoin Explorer] (https://bitcoinexplorer.org/).

Til å begynne med vil jeg introdusere deg for oppgavene. Bruk blokkutforskeren til å fullføre dem, og skriv ned svarene dine på et ark. På slutten av dette kapittelet får du svarene, slik at du kan kontrollere og korrigere resultatene dine.

*Transaksjonene som er valgt ut for disse øvelsene, er valgt noe tilfeldig ut fra sine egenskaper. Dette kapittelet er kun ment for opplærings- og informasjonsformål. Jeg vil gjøre det klart at jeg verken støtter eller oppfordrer til bruk av disse verktøyene til ondsinnede formål. Målet er å lære deg hvordan du kan beskytte deg mot strenganalyse, ikke å utføre analyser for å avsløre andres private informasjon*

### Øvelse 1

Identifikator for transaksjonen som skal analyseres :

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

Hva heter modellen for denne transaksjonen, og hvilke plausible tolkninger kan man trekke ved kun å se på modellen, det vil si strukturen i transaksjonen?

### Øvelse 2

Identifikator for transaksjonen som skal analyseres :

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

Hva heter modellen for denne transaksjonen, og hvilke plausible tolkninger kan man trekke ved kun å se på modellen, det vil si strukturen i transaksjonen?

### Øvelse 3

Identifikator for transaksjonen som skal analyseres :

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

Hva er modellen for denne transaksjonen?

Etter å ha identifisert modellen ved hjelp av transaksjonens interne heuristikk, hvilken output er det sannsynlig at børsen vil representere?

### Øvelse 4

Identifikator for transaksjonen som skal analyseres :

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

Hva er modellen for denne transaksjonen?

Etter å ha identifisert modellen ved hjelp av transaksjonens interne heuristikk, hvilken output er det sannsynlig at børsen vil representere?

### Øvelse 5

La oss forestille oss at Loïc har lagt ut en av sine Bitcoin-mottaksadresser på det sosiale nettverket Twitter :

![BTC204](assets/fr/065.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

Basert på denne informasjonen og ved å bruke **kun heuristikken for gjenbruk av adresser**, hvilke Bitcoin-transaksjoner kan knyttes til Loïcs identitet?

*Jeg er selvsagt ikke den virkelige eieren av denne mottaksadressen, og jeg har ikke lagt den ut på sosiale nettverk. Det er en adresse jeg tok tilfeldig fra blockchain*

### Øvelse 6

Etter øvelse 5, takket være heuristikken for gjenbruk av adresser, var du i stand til å identifisere flere Bitcoin-transaksjoner som Loïc ser ut til å være involvert i. Normalt sett burde du ha oppdaget denne blant de identifiserte transaksjonene:

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
```

Denne transaksjonen er den aller første som sender penger til Loïcs adresse. Hvor tror du bitcoinsene som Loïc mottok via denne transaksjonen kom fra?

### Øvelse 7

Etter øvelse 5 har du, takket være heuristikken for gjenbruk av adresser, vært i stand til å identifisere flere Bitcoin-transaksjoner der Loïc ser ut til å være involvert. Nå ønsker du å finne ut hvor Loïc kom fra. Basert på transaksjonene du har funnet, utfører du en tidsanalyse for å finne tidssonen som mest sannsynlig ble brukt av Loïc. Ut fra denne tidssonen kan du finne ut hvor Loïc ser ut til å bo (land, stat/region, by...).

![BTC204](assets/fr/066.webp)

### Øvelse 8

Her er Bitcoin-transaksjonen å studere:

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

Hvilken informasjon kan vi tolke ut fra denne transaksjonen alene?

### Løsninger for trening

***Øvelse 1:***

Modellen for denne transaksjonen er den enkle betalingsmodellen. Hvis vi bare studerer strukturen, kan vi tolke det slik at den ene utgangen representerer utvekslingen og den andre utgangen representerer en faktisk betaling. Vi vet derfor at den observerte brukeren sannsynligvis ikke lenger er i besittelse av den ene av de to UTXOene i output (betalingen), men fortsatt er i besittelse av den andre UTXOen (utvekslingen).

***Øvelse 2:***

Modellen for denne transaksjonen er gruppert forbruk. Denne modellen avslører sannsynligvis en storskala økonomisk aktivitet, for eksempel en utvekslingsplattform. Vi kan utlede at input UTXO kommer fra et selskap med høy økonomisk aktivitet, og at output UTXO vil være spredt. Noen vil tilhøre selskapets kunder som har tatt ut bitcoinsene sine til egne lommebøker. Andre kan gå til partnerselskaper. Til slutt vil det utvilsomt være noe utveksling som vil gå tilbake til det utstedende selskapet.

***Øvelse 3:***

Modellen for denne transaksjonen er enkel betaling. Vi kan derfor bruke interne heuristikker på transaksjonen for å prøve å identifisere utvekslingen.

Selv har jeg identifisert minst to interne heuristikker som støtter den samme hypotesen:


- Gjenbruk av samme type skript ;
- Den største produksjonen.

Den mest åpenbare heuristikken er å gjenbruke samme type skript. Utdata `0` er faktisk en `P2SH`, gjenkjennelig ved at mottaksadressen begynner med `3` :

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

Mens utgang `1` er en `P2WPKH`, identifiserbar ved at adressen begynner med `bc1q` :

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

UTXO-en som brukes som input for denne transaksjonen, bruker også et `P2WPKH`-skript:

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

Vi kan dermed anta at output `0` tilsvarer en betaling og output `1` er transaksjonsutvekslingen, noe som betyr at input-brukeren alltid eier output `1`.

For å underbygge eller avkrefte denne hypotesen kan vi lete etter andre heuristikker som enten bekrefter eller reduserer sannsynligheten for at hypotesen vår er riktig.

Jeg har identifisert minst én annen heuristikk. Det er den største utgangsheuristikken. Utgang `0` måler `123 689 sats`, mens utgang `1` måler `505 839 sats`. Det er derfor en signifikant forskjell mellom disse to outputene. Heuristikken for største output tilsier at det største outputtet sannsynligvis er valuta. Denne heuristikken styrker vår opprinnelige hypotese ytterligere.

Det virker derfor sannsynlig at brukeren som leverte UTXO som input, fortsatt har `1` output, som ser ut til å representere transaksjonens utveksling.

***Øvelse 4:***

Modellen for denne transaksjonen er enkel betaling. Vi kan derfor bruke interne heuristikker på transaksjonen for å prøve å identifisere utvekslingen.

Selv har jeg identifisert minst to interne heuristikker som støtter den samme hypotesen:


- Gjenbruk av samme type skript ;
- Den runde stolpeutgangen.

Den mest åpenbare heuristikken er å gjenbruke samme type skript. Utdata `0` er faktisk en `P2SH`, gjenkjennelig ved at mottaksadressen begynner med `3` :

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

Mens utgang `1` er en `P2WPKH`, identifiserbar ved at adressen begynner med `bc1q` :

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

UTXO-en som brukes som input for denne transaksjonen, bruker også et `P2WPKH`-skript:

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

Vi kan dermed anta at output `0` tilsvarer en betaling og output `1` er transaksjonsutvekslingen, noe som betyr at input-brukeren alltid eier output `1`.

For å underbygge eller avkrefte denne hypotesen kan vi lete etter andre heuristikker som enten bekrefter eller reduserer sannsynligheten for at hypotesen vår er riktig.

Jeg har identifisert minst én annen heuristikk. Det er den runde mengden utdata. Output `0` måler `70 000 sats`, mens output `1` måler `22 962 sats`. Vi har derfor en perfekt rund utgang i BTC-regneenheten. Den runde outputheuristikken antyder at UTXO-en med et rundt beløp mest sannsynlig er betaling, og at den andre representerer utveksling. Denne heuristikken styrker vår opprinnelige hypotese ytterligere.

I dette eksemplet kan imidlertid en annen heuristikk utfordre vår opprinnelige hypotese. Produksjon `0` er nemlig større enn produksjon `1`. Basert på heuristikken om at den største produksjonen vanligvis er utenlandsk valuta, kan vi utlede at produksjonen `0` er utenlandsk valuta. Denne mothypotesen virker imidlertid usannsynlig, ettersom de to andre heuristikkene virker vesentlig mer overbevisende enn heuristikken om størst produksjon. Det virker derfor rimelig å opprettholde vår opprinnelige hypotese til tross for denne tilsynelatende selvmotsigelsen.

Det virker derfor sannsynlig at brukeren som leverte UTXO som input, fortsatt har `1` output, som ser ut til å representere transaksjonens utveksling.

***Øvelse 5:***

Vi kan se at 8 transaksjoner kan knyttes til Loïcs identitet. Av disse involverer 4 mottak av bitcoins:

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
8b70bd322e6118b8a002dbdb731d16b59c4a729c2379af376ae230cf8cdde0dd
d5864ea93e7a8db9d3fb113651d2131567e284e868021e114a67c3f5fb616ac4
bc4dcf2200c88ac1f976b8c9018ce70f9007e949435841fc5681fd33308dd762
```

De andre fire gjelder bitcoinforsendelser:

```plaintext
8b52fe3c2cf8bef60828399d1c776c0e9e99e7aaeeff721fff70f4b68145d540
c12499e9a865b9e920012e39b4b9867ea821e44c047d022ebb5c9113f2910ed6
a6dbebebca119af3d05c0196b76f80fdbf78f20368ebef1b7fd3476d0814517d
3aeb7ce02c35eaecccc0a97a771d92c3e65e86bedff42a8185edd12ce89d89cc
```

***Øvelse 6:***

Hvis vi ser på modellen for denne transaksjonen, er det tydelig at det er en samlet utgift. Transaksjonen har én inngang og 51 utganger, noe som indikerer et høyt nivå av økonomisk aktivitet. Vi kan derfor anta at Loïc har tatt ut bitcoins fra en utvekslingsplattform.

Flere faktorer styrker denne hypotesen. For det første er skriptet som brukes til å sikre UTXO-inndataene, et P2SH 2/3 multisig-skript, noe som indikerer et avansert sikkerhetsnivå som er typisk for utvekslingsplattformer:

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```

I tillegg er den studerte adressen `3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF` gjenbrukt i over 220 000 forskjellige transaksjoner, noe som ofte er karakteristisk for utvekslingsplattformer, som generelt ikke er opptatt av konfidensialiteten.

Den tidsmessige heuristikken som er brukt på denne adressen, viser også en regelmessig sending av transaksjoner nesten daglig over en periode på tre måneder, med lengre timer over 24 timer, noe som tyder på kontinuerlig aktivitet på en utvekslingsplattform.

Endelig er volumene som håndteres av denne enheten kolossale. Adressen mottok og sendte 44 BTC i 222 262 transaksjoner mellom desember 2022 og mars 2023. Disse store volumene bekrefter ytterligere den sannsynlige arten av en utvekslingsplattforms aktivitet.

***Øvelse 7:***

Ved å analysere transaksjonsbekreftelsestidene kan følgende UTC-tider identifiseres:

```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

En analyse av disse tidsskjemaene viser at UTC-7 og UTC-8 stemmer overens med en rekke nåværende menneskelige aktiviteter (mellom 08:00 og 23:00) for de fleste tidsskjemaene:

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7
05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

![BTC204](assets/fr/066.webp)

UTC-7-tidssonen er spesielt relevant om sommeren, ettersom den omfatter stater og regioner som :


- California (med byer som Los Angeles, San Francisco og San Diego);
- Nevada (med Las Vegas) ;
- Oregon (med Portland) ;
- Washington (sammen med Seattle) ;
- Den kanadiske regionen British Columbia (med byer som Vancouver og Victoria).

Denne informasjonen tyder på at Loïc sannsynligvis er bosatt på vestkysten av USA eller Canada.

***Øvelse 8:***

Analyse av denne transaksjonen viser fem inndata og én utdata, noe som tyder på konsolidering. Ved å bruke CIOH-heuristikken kan vi anta at alle UTXO-ene i input eies av én og samme enhet, og at UTXO-en i output også tilhører denne enheten. Det ser ut til at brukeren valgte å slå sammen flere UTXOer han eide, for å danne én UTXO i utdata, med det formål å konsolidere delene sine. Dette var sannsynligvis motivert av et ønske om å dra nytte av datidens lave transaksjonskostnader for å redusere fremtidige kostnader.

___

*For å skrive denne del 3 om kjedeanalyse har jeg benyttet meg av følgende ressurser:*


- Serien med fire artikler med tittelen: [Understanding Bitcoin Privacy with OXT] (https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923), produsert av Samourai Wallet i 2021 ;*
- De ulike rapportene fra [OXT Research] (https://medium.com/oxt-research), samt deres gratis blockchain-analyseverktøy (ikke lenger tilgjengelig for øyeblikket etter arrestasjonen av grunnleggerne av Samourai Wallet) ;*
- Mer generelt kommer kunnskapen min fra ulike tweets og innhold fra [@LaurentMT] (https://twitter.com/LaurentMT) og [@ErgoBTC] (https://twitter.com/ErgoBTC) ;*
- [Space Kek #19] (https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji), der jeg deltok i selskap med [@louneskmt] (https://twitter.com/louneskmt), [@TheoPantamis] (https://twitter.com/TheoPantamis), [@Sosthene___] (https://twitter.com/Sosthene___) og [@LaurentMT] (https://twitter.com/LaurentMT)

*Jeg vil gjerne takke forfatterne, utviklerne og produsentene. Takk også til korrekturleserne som omhyggelig korrigerte artikkelen som denne del 3 er basert på, og som ga meg sine ekspertråd :*


- [Gilles Cadignan](https://twitter.com/gillesCadignan) ;*
- [Ludovic Lars](https://viresinnumeris.fr/)

# Beherske beste praksis for å beskytte personvernet ditt

<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## Gjenbruk av adresse

<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>


Etter å ha studert teknikkene som kan bryte konfidensialiteten din på Bitcoin, vil vi i denne tredje delen nå se på de beste fremgangsmåtene du kan ta i bruk for å beskytte deg selv. Målet med denne delen er ikke å utforske metoder for å forbedre konfidensialiteten, et emne som vil bli behandlet senere, men heller å forstå hvordan man kan samhandle riktig med Bitcoin for å beholde den konfidensialiteten den naturlig tilbyr, uten å ty til ytterligere teknikker.

For å begynne denne tredje delen skal vi selvsagt snakke om gjenbruk av adresser. Dette fenomenet er den største trusselen mot brukernes konfidensialitet. Dette kapittelet er uten tvil det viktigste i hele kurset.

### Hva er en mottaksadresse?

En Bitcoin-mottaksadresse er en streng eller identifikator som brukes til å motta bitcoins på en lommebok.

Teknisk sett "mottar" ikke en Bitcoin-mottakeradresse bitcoins i bokstavelig forstand, men tjener heller til å definere betingelsene for hvordan bitcoins kan brukes. Konkret, når en betaling sendes til deg, oppretter avsenderens transaksjon en ny UTXO for deg som en output fra UTXOene den har brukt som input. På denne outputen legger den til et skript som definerer hvordan denne UTXO-en kan brukes på et senere tidspunkt. Dette skriptet kalles "*ScriptPubKey*" eller "*Locking Script*". Mottaksadressen din, eller mer presist nyttelasten, er integrert i dette skriptet. Enkelt sagt sier dette skriptet i utgangspunktet:

> "*For å bruke denne nye UTXO-en må du oppgi en digital signatur ved hjelp av den private nøkkelen som er knyttet til denne mottakeradressen*."
![BTC204](assets/fr/067.webp)

Bitcoin-adresser kommer i forskjellige typer, avhengig av hvilken skriptmodell som brukes. De første modellene, kjent som "Legacy*", inkluderer `P2PKH` (*Pay-to-PubKey-Hash*) og `P2SH` (*Pay-to-Script-Hash*) adresser. P2PKH-adresser begynner alltid med `1`, og P2SH med `3`. Selv om disse formatene fortsatt er sikre, er de nå foreldet, ettersom de medfører høyere transaksjonskostnader og gir mindre konfidensialitet enn de nye standardene.

SegWit V0-adresser (`P2WPKH` og `P2WSH`) og Taproot/SegWit V1-adresser (`P2TR`) representerer moderne formater. SegWit-adresser starter med `bc1q` og Taproot-adresser, som ble introdusert i 2021, starter med `bc1p`.

Her er for eksempel en mottaksadresse for Taproot:

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

Hvordan ScriptPubKey er konstruert, avhenger av hvilken standard du bruker:

| ScriptPubKey | Scriptmal

| ---------------- | ----------------------------------------------------------- |

| P2PKH | OP_DUP OP_HASH160 `<pubKeyHash>`` OP_EQUALVERIFY OP_CHECKSIG | OP_EQUALVERIFY OP_CHECKSIG

| P2SH | OP_HASH160 `<scriptHash>` `<scriptHash>` OP_EQUAL | OP_EQUAL

| P2WPKH | 0 `<pubKeyHash>` | | P2WPKH | 0

| P2WSH | 0 `<witnessScriptHash>` | | <<witnessScriptHash>` | <<witnessScriptHash>

| P2SH - P2WPKH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL | OP_EQUAL

| P2SH - P2WSH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL | OP_EQUAL

| P2TR | 1 `<pubKey>` | | P2TR | 1

Hvordan mottaksadressene konstrueres, avhenger også av hvilken skriptmodell som velges:


- For `P2PKH`- og `P2WPKH`-adresser representerer nyttelasten, dvs. kjernen i adressen, hashen av den offentlige nøkkelen;
- For `P2SH`- og `P2WSH`-adresser representerer nyttelasten hashen til en ;
- Når det gjelder P2TR-adresser, er nyttelasten en justert offentlig nøkkel. P2TR-adresser kombinerer aspekter av _Pay-to-PubKey_ og _Pay-to-Script_. Den justerte offentlige nøkkelen er resultatet av å legge til en klassisk offentlig nøkkel med en "tweak", avledet fra Merkle-roten til et sett med skript som også kan brukes til å bruke bitcoins.

![BTC204](assets/fr/068.webp)

Adresser som vises i porteføljeprogramvaren, inneholder også en HRP (*Human-Readable Part*), vanligvis `bc` for post-SegWit-adresser, et `1`-skilletegn og et versjonsnummer `q` for SegWit V0 og `p` for Taproot/SegWit V1. Det legges også til en kontrollsum for å garantere adressens integritet og gyldighet under overføring.

Til slutt settes adressene inn i et standardformat:


- Base58sjekk for gamle Legacy-adresser ;
- Bech32 for SegWit-adresser ;
- Bech32m for Taproot-adresser.

Her er addisjonsmatrisen for bech32- og bech32m-formatene (SegWit og Taproot) fra base 10:

| + | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |

| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| 0 | q | p | z | r | y | 9 | x | 8 |

| 8 g f 2 t v d w 0

16 | s | 3 | j | n | 5 | 4 | k | h | 5 | 4 | k | h

| 24 c e 6 m u a 7 l

### Hva er gjenbruk av adresser?

Gjenbruk av adresser betyr at samme mottakeradresse brukes til å blokkere flere forskjellige UTXO-er.

Som vi så i forrige avsnitt, har hver UTXO sin egen ScriptPubKey, som låser den og må oppfylles for at UTXO-en skal kunne brukes som input i en ny transaksjon. Det er i denne ScriptPubKey at nyttelastadressene er integrert.

Når forskjellige ScriptPubKeys inneholder den samme mottakeradressen, kalles dette gjenbruk av adresser. I praksis betyr dette at en bruker gjentatte ganger har oppgitt den samme adressen til avsendere for å motta bitcoins via flere betalinger. Og det er nettopp denne praksisen som er katastrofal for personvernet ditt.

### Hvorfor er gjenbruk av adresser et problem?

Siden blokkjeden er offentlig, er det enkelt å se hvilke adresser som låser hvilke UTXO og hvor mange bitcoins. Hvis samme adresse brukes til flere transaksjoner, er det mulig å utlede at alle bitcoins som er knyttet til denne adressen, tilhører samme person. Denne praksisen går på bekostning av brukernes personvern ved å gjøre det mulig å etablere deterministiske koblinger mellom ulike transaksjoner og spore bitcoins i blokkjeden. Satoshi Nakamoto selv fremhevet dette problemet allerede i Bitcoins hvitbok:

> *Som en ekstra brannmur kan det brukes et nytt nøkkelpar for hver transaksjon, slik at de ikke knyttes til en felles eier*
![BTC204](assets/fr/055.webp)

Kilde: S. Nakamoto: S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

Satoshis intensjon med denne setningen var å skape en ekstra brannmur i tilfelle en tilknytning mellom en brukers identitet og et nøkkelpar på Bitcoin, for å forhindre at hele aktiviteten hans ble offentlig knyttet til identiteten hans. I dag, med spredningen av blockchain-analyseselskaper og KYC-regelverk, er bruken av unike adresser ikke lenger en "ekstra brannmur", men en uunnværlig praksis for alle som ønsker å bevare et minimum av personvern.

Når du gjenbruker en adresse, lager du en nesten ubestridelig kobling mellom alle transaksjonene som er knyttet til denne adressen. Selv om dette ikke direkte truer pengene dine, ettersom elliptisk kurvekryptografi garanterer sikkerheten til de private nøklene dine, gjør det det lettere å overvåke aktivitetene dine. Alle som har en node, kan observere transaksjonene og saldoen til adressene, noe som går helt på bekostning av anonymiteten din.

![BTC204](assets/fr/054.webp)

For å illustrere dette poenget kan vi ta et eksempel med Bob, en bruker som regelmessig kjøper bitcoins i små mengder i DCA og alltid sender dem til samme adresse. Etter to år inneholder denne adressen en betydelig mengde bitcoins. Hvis Bob bruker denne adressen til å betale til en lokal forhandler, vil sistnevnte kunne se alle de tilknyttede midlene og utlede Bobs formue. Dette kan føre til risiko for personsikkerheten, for eksempel forsøk på tyveri eller utpressing. Hvis Bob hadde brukt en blank adresse til å motta hvert periodiske kjøp, ville han ha avslørt uendelig mye mindre informasjon til selgeren.

I strenganalyse finnes det to typer gjenbruk av adresser:


- Ekstern gjenbruk ;
- Intern gjenbruk innenfor en transaksjon.

Den første er når en adresse gjenbrukes i flere forskjellige Bitcoin-transaksjoner. Dette er det vi snakket om tidligere: denne heuristikken utleder at alle UTXO-er som sendes gjennom denne adressen tilhører en enkelt enhet.

Intern gjenbruk av adresser forekommer ikke når gjenbruk skjer over flere transaksjoner, men når det skjer innenfor én enkelt transaksjon. Hvis den samme adressen som brukes til å låse en inngang, brukes som utgang i en transaksjon, kan vi utlede at denne utgangen fortsatt tilhører den samme brukeren (børsen), og at den andre utgangen representerer den faktiske betalingen. Denne andre heuristikken gjør det mulig å forevige et pengespor over flere transaksjoner.

![BTC204](assets/fr/045.webp)

Gjenbruk av adresser er en reell svøpe på Bitcoin. Ifølge nettstedet OXT.me (for øyeblikket utilgjengelig) var den totale gjenbruksraten for adresser på Bitcoin rundt 52 % i 2022:

![BTC204](assets/fr/069.webp)

Dette er en enorm andel, men den kommer i overveldende grad fra utvekslingsplattformer snarere enn fra individuelle brukere.

### Hvordan unngå gjenbruk av adresser?

Det er ganske enkelt å unngå gjenbruk av adresser: **Bruk ganske enkelt en ny, tom adresse for alle nye betalinger til lommeboken din**.

Takket være BIP32 er moderne porteføljer nå deterministiske og hierarkiske. Det betyr at en bruker kan generere et stort antall adresser ut fra én enkelt innledende opplysning: seed. Ved å lagre denne ene informasjonen er det mulig å gjenopprette alle de private nøklene i porteføljen, slik at man får tilgang til midlene som er sikret av de tilsvarende adressene.

![BTC204](assets/fr/070.webp)

Dette er grunnen til at når du trykker på "*mottak*"-knappen i lommebokprogramvaren din, foreslås en ubrukt mottaksadresse hver gang. Etter å ha mottatt bitcoins på denne adressen, foreslår programvaren automatisk en ny.

> *PS: Nylig har noen lommebokprogrammer kunngjort at de har til hensikt å slutte å generere blanke adresser, i frykt for at dette vil bli oppfattet som en form for hvitvasking av penger av myndighetene. Hvis programvaren din er en av disse, anbefaler jeg deg på det sterkeste å bytte den ut umiddelbart, da dette ikke er akseptabelt for brukeren*
Hvis du trenger en statisk identifikator for å motta betalinger, for eksempel donasjoner, er det ikke tilrådelig å bruke en klassisk Bitcoin-adresse på grunn av risikoen for gjenbruk. I stedet bør du bruke en Lightning-adresse, eller velge en statisk onchain-betalingsidentifikator, for eksempel BIP47 eller Silent Payments. Disse protokollene forklares i detalj i del 6 av dette kurset.

## Merking og kontroll av deler

<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>


Som vi oppdaget i avsnittet om strenganalyse, finnes det en rekke heuristikker og mønstre som kan brukes til å utlede informasjon om en transaksjon. Som bruker er det viktig å være klar over disse teknikkene for å kunne beskytte seg bedre mot dem.

Dette innebærer streng administrasjon av lommeboken din i selvforvaring, noe som betyr å kjenne opprinnelsen til UTXO-ene dine, samt nøye velge hvilke UTXO-er som skal brukes når du foretar betalinger. Denne effektive lommebokforvaltningen er avhengig av to viktige funksjoner i gode Bitcoin-lommebøker: tagging og myntkontroll.

I dette kapittelet skal vi se nærmere på disse funksjonene og hvordan du kan bruke dem på en intelligent måte, uten å legge for mye arbeidsbelastning, for å optimalisere personvernet ditt på Bitcoin.

### Hva er merking?

Merking er praksisen med å tilordne en annotasjon eller etikett til en bestemt UTXO i en Bitcoin-lommebok. Disse merknadene lagres lokalt av lommebokprogramvaren og overføres aldri over Bitcoin-nettverket. Merking er derfor et personlig administrasjonsverktøy.

Hvis jeg for eksempel har en UTXO fra et P2P-kjøp på Bisq med Charles, kan jeg merke den "`Non-KYC Bisq Charles`".

Tagging er en god praksis som hjelper deg med å huske opprinnelsen eller den tiltenkte destinasjonen til en UTXO, noe som derfor letter forvaltningen av midler og optimalisering av personvernet. Bitcoin-lommeboken din sikrer helt sikkert flere UTXO-er. Hvis kildene til disse UTXO-ene er forskjellige, vil du kanskje ikke slå sammen disse UTXO-ene i fremtiden, ellers kan du avsløre deres felles eierskap. Ved å merke alle delene dine på riktig måte, kan du være sikker på at du husker hvor de kom fra når du trenger dem, selv om det er mange år fra nå.

### Hva er corner control?

Den aktive bruken av merking blir enda mer interessant når den kombineres med et alternativ for myntkontroll i porteføljeprogramvaren.

Myntkontroll er en funksjon som finnes i god Bitcoin-lommebokprogramvare, og som gir deg muligheten til å manuelt velge spesifikke UTXO-er som skal brukes som input for å fullføre en transaksjon. For å tilfredsstille en utgangsbetaling må du faktisk forbruke en UTXO i retur. Av flere grunner, som vi skal se nærmere på senere, kan det være lurt å velge nøyaktig hvilke deler som skal brukes som input for å utføre en gitt betaling. Det er nettopp dette du kan gjøre med myntkontroll. For å gi deg en analogi, kan denne funksjonen sammenlignes med å velge en bestemt mynt fra lommeboken din når du betaler for baguetten din.

![BTC204](assets/fr/071.webp)

Bruk av porteføljeprogramvare med myntkontroll, kombinert med UTXO-merking, gjør det mulig for brukerne å både skille ut og velge UTXO-er for transaksjonene sine på en nøyaktig måte.

### Hvordan merker du UTXO-ene dine?

Det finnes ingen universalmetode for merking av UTXO-er. Det er opp til deg å definere et merkesystem som er lett å forstå for porteføljen din. Husk uansett at god merking er merking du kan forstå når du trenger den. Hvis Bitcoin-lommeboken din først og fremst er ment for sparing, er det ikke sikkert at etikettene vil være nyttige for deg på flere tiår. Så sørg for at de er tydelige, presise og omfattende.

Det er viktig at dine nærmeste enkelt kan identifisere hvor pengene kommer fra hvis de en dag skulle trenge tilgang til porteføljen din. Dette vil hjelpe dem både av hensyn til konfidensialitet og av juridiske grunner, dersom de må dokumentere opprinnelsen til midlene overfor en myndighet.

Det viktigste å notere på etiketten er kilden til UTXO. Du bør ganske enkelt angi hvordan mynten havnet i lommeboken din. Er den et resultat av et kjøp på en børsplattform? En fakturabetaling fra en kunde? En peer-to-peer-utveksling? Eller representerer den utvekslingen av en utgift? Du kan for eksempel spesifisere dette:


- remove Exchange.com` ;
- kundebetaling David` ;
- kjøp P2P Charles` ;
- "Endre kjøp av sofa

![BTC204](assets/fr/072.webp)

For å finjustere UTXO-forvaltningen og respektere fondssegregeringsstrategiene i porteføljen din, kan du berike etikettene dine med en ekstra indikator som gjenspeiler disse skillene. Hvis porteføljen din inneholder to kategorier UTXO som du er opptatt av å ikke blande, kan du innlemme en markør i etikettene dine for å skille disse gruppene tydelig fra hverandre. Disse skillemarkørene vil avhenge av dine egne kriterier, for eksempel å skille mellom UTXO-er som er et resultat av en oppkjøpsprosess som involverer KYC, eller mellom profesjonelle og personlige fond. Hvis vi tar etiketteksemplene som er nevnt ovenfor, kan dette oversettes til:


- `KYC - Withdrawal Exchange.com` ;
- `KYC - Kundebetaling David` ;
- `NO KYC - Kjøp P2P Charles` ;
- `NO KYC - Bytte sofakjøp`

![BTC204](assets/fr/073.webp)

Det anbefales også å videreføre merkingen av en del i løpet av transaksjonene. For eksempel, når du konsoliderer UTXO no-KYC, må du sørge for å merke den resulterende UTXO-en ikke bare som `konsolidering`, men spesifikt som `konsolidering no-KYC` for å holde en klar oversikt over hvor myntene kom fra.

Til slutt er det ikke obligatorisk å sette en dato på en etikett. De fleste lommebokprogramvarer viser allerede transaksjonsdatoen, og det er alltid mulig å finne denne informasjonen på en blokkutforsker takket være TXID.

### Hvordan velge de riktige delene?

Når du utfører en transaksjon, kan du med myntkontrollen spesifikt velge hvilke UTXO-er som skal brukes som input for å tilfredsstille betalingsoutputen. Det er to aspekter ved dette valget:


- Mottakeren av betalingen har mulighet til å knytte en del av identiteten din til UTXO-ene som brukes i inndataene;
- En ekstern observatørs evne til å etablere koblinger mellom alle UTXO-er som brukes som inndata.

La oss ta et konkret eksempel for å illustrere det første poenget. Anta at du kjøper en baguette i bitcoins fra bakeren din. Du bruker en eller flere UTXO-er som du har som input for å betale minst prisen på baguetten i output, samt transaksjonsgebyrene. Bakeren din kan da potensielt knytte ansiktet ditt, eller en hvilken som helst annen del av identiteten din som han kjenner til, til myntene som brukes som input. Når du vet at denne koblingen eksisterer, foretrekker du kanskje å velge en bestemt UTXO fremfor en annen når du skal betale.

![BTC204](assets/fr/074.webp)

Hvis for eksempel en av UTXOene dine kommer fra en utvekslingsplattform, og du helst ikke vil at bakeren skal vite om kontoen din på den plattformen, vil du unngå å bruke den UTXOen til betaling. Hvis du har en UTXO med høy verdi som avslører en betydelig mengde bitcoins, kan du også velge å ikke bruke den for å unngå at bakeren blir klar over BTC-formuen din.

Å velge hvilke UTXO-er som skal brukes til dette første punktet, er derfor en personlig avgjørelse som påvirkes av hva du er villig til å avsløre eller ikke. Merkelappene du tildeler UTXO-ene dine når du mottar dem, vil hjelpe deg med å velge dem som, når de er brukt, bare avslører informasjon du er komfortabel med å avsløre for mottakeren.

Utover informasjonen som potensielt avsløres for mottakeren, påvirker valget av inndata også hva du avslører for alle observatører av blokkjeden. Ved å bruke flere UTXO-er som input i transaksjonen avslører du faktisk at de eies av samme enhet, i henhold til CIOH-heuristikken (_Common Input Ownership Heuristic_).

![BTC204](assets/fr/075.webp)

Når du velger deler, må du derfor være klar over at transaksjonen du skal sende, vil skape en kobling mellom alle UTXO-ene som brukes. Denne koblingen kan være problematisk for personvernet ditt, spesielt hvis UTXO-ene kommer fra forskjellige kilder.

![BTC204](assets/fr/076.webp)

La oss ta eksemplet med min UTXO uten KYC fra Bisq; jeg vil unngå å kombinere den med en UTXO fra for eksempel en regulert børsplattform som kjenner identiteten min. Hvis jeg noen gang bruker disse to UTXO-ene som input i samme transaksjon, vil den regulerte plattformen kunne koble identiteten min til UTXO-en jeg kjøpte på Bisq, som ikke tidligere var knyttet til identiteten min.

![BTC204](assets/fr/077.webp)

Til slutt, når du velger hvilke UTXO-er som skal brukes som input til en transaksjon, er det viktigste å unngå å bruke flere UTXO-er. Når du kan, velger du høyst en enkelt mynt som er stor nok til å tilfredsstille betalingen. På denne måten unngår du helt risikoen forbundet med CIOH. Men hvis ingen enkelt UTXO er tilstrekkelig for betaling og du må bruke flere, må du sørge for at de kommer fra lignende kilder for å minimere risikoen for uønskede koblinger. Husk også at mottakeren kan knytte informasjonen de har om deg til historikken til myntene som brukes i inndata.

### Forstå automatisk valg av deler

I de foregående avsnittene har vi diskutert manuell utvelgelse av UTXO-er som skal brukes til en transaksjon. Men hva skjer når lommebokprogramvaren utfører dette valget automatisk? Det finnes flere metoder for å avgjøre hvilke mynter som skal brukes, og utvelgelsen av UTXO-er utgjør et veritabelt forskningsfelt innen Bitcoin. Hovedformålet med denne automatiske prosessen er ofte å minimere transaksjonskostnadene for brukeren.

UTXO-seleksjonsmetoder som FIFO (*First In First Out*) og LIFO (*Last In First Out*) er blant de enkleste, men også de minst effektive. Med FIFO brukes de eldste delene i porteføljen først. Denne tilnærmingen er generelt ineffektiv både når det gjelder å minimere transaksjonskostnader og bevare konfidensialiteten, bortsett fra i tilfeller der man bruker relative tidslåser som må fornyes regelmessig. LIFO prioriterer derimot bruken av de nyeste UTXO-ene. Selv om begge metodene er enkle, viser de seg ofte å være ineffektive.

En mer avansert metode er *Knapsack Solver*. Denne ble brukt på Bitcoin Core-lommeboken frem til versjon 0.17. Den består av å iterativt og tilfeldig velge UTXO-er fra lommeboken, legge dem sammen i delmengder og beholde den løsningen som reduserer transaksjonsvekten mest mulig, for å redusere kostnaden for brukeren.

*Branch-and-Bound* (BNB), ofte kalt "Murch-algoritmen" etter oppfinneren, har erstattet *Knapsack Solver* i Bitcoin Core fra og med versjon 0.17. Denne mer avanserte metoden har som mål å finne et sett med UTXO-er som tilsvarer nøyaktig det beløpet som trengs for å tilfredsstille utbetalingene til en transaksjon. Målet med BNB er å minimere byttebeløpet samt gebyrene ved å redusere det såkalte avfallskriteriet, som tar hensyn til både de umiddelbare kostnadene og de forventede fremtidige kostnadene ved byttet. Denne metoden er avledet fra det opprinnelige konseptet *Branch-and-Bound*, som ble utviklet i 1960 av Ailsa Land og Alison Harcourt, og gir en mer presis optimalisering av gebyrer enn *Knapsack Solver*.

Alle disse metodene for automatisk UTXO-valg kan være effektive når det gjelder å redusere transaksjonskostnadene, men de er ofte ineffektive når det gjelder å bevare brukernes konfidensialitet. Disse algoritmene kan nemlig slå sammen flere UTXO-er til inndata, og dermed avsløre en felles egenskap ved disse UTXO-ene på grunn av CIOH. Disse metodene kan selvsagt ikke ta hensyn til etikettene på UTXO-ene, som ikke desto mindre er avgjørende for et bevisst valg av hvilke deler som skal avsløres for transaksjonsmottakeren. For øyeblikket er den eneste måten å optimalisere konfidensialiteten ved valg av mynter på, å gjøre det manuelt.

### Opplæring i UTXO-merking

Hvis du vil finne ut hvordan du merker UTXO-ene dine, har vi laget en omfattende veiledning om den viktigste Bitcoin-lommebokprogramvaren der ute:

https://planb.network/tutorials/privacy/on-chain/utxo-labelling-d997f80f-8a96-45b5-8a4e-a3e1b7788c52

## KYC og nøkkelidentifikasjon

<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>


KYC står for "Know Your Customer". Det er en regulatorisk prosedyre som implementeres av visse selskaper som opererer i Bitcoin-sektoren. Formålet med denne prosedyren er å verifisere og registrere identiteten til kundene deres, med det uttalte målet å bekjempe hvitvasking av penger og finansiering av terrorisme.

I praksis innebærer KYC innsamling av ulike personopplysninger fra kunden, som kan variere fra jurisdiksjon til jurisdiksjon, men som regel omfatter det ID, fotografi og adressebevis. Denne informasjonen blir deretter verifisert og lagret for fremtidig bruk.

Denne prosedyren har blitt obligatorisk for alle regulerte vekslingsplattformer i de fleste vestlige land. Det betyr at alle som ønsker å veksle statsvalutaer til bitcoin via disse plattformene, må oppfylle kravene til KYC.

Denne prosedyren er ikke uten risiko for brukernes personvern og sikkerhet. I dette kapittelet vil vi undersøke disse risikoene i detalj og analysere de spesifikke konsekvensene av KYC og identifikasjonsprosesser for personvernet til Bitcoin-brukere.

### Tilrettelegging for sporing i kjeden

Den første risikoen forbundet med KYC er at det gir et privilegert inngangspunkt for blokkjedeanalyse. Som vi så i forrige avsnitt, kan analytikere gruppere og spore aktivitet i blokkjeden ved hjelp av transaksjonsmønstre og heuristikk. Når de har lykkes med å gruppere en brukers aktivitet i blokkjeden, trenger de bare å finne et enkelt inngangspunkt blant alle transaksjonene og nøklene hans for å kompromittere konfidensialiteten hans fullt ut.

![BTC204](assets/fr/078.webp)

Når du utfører en KYC, gir du et inngangspunkt av høy kvalitet for blokkjedeanalyse, ettersom du knytter mottaksadressene dine som brukes når du tar ut bitcoins fra en utvekslingsplattform, til din fulle, bekreftede identitet. I teorien er denne informasjonen kun kjent for selskapet du har oppgitt den til, men som vi skal se nedenfor, er risikoen for datalekkasje reell. I tillegg kan bare det faktum at et selskap har denne informasjonen være problematisk, selv om de ikke deler den.

Så hvis du ikke tar andre skritt for å begrense aggregeringen av aktivitetene dine i blokkjeden, kan hvem som helst med kunnskap om dette KYC-punktet potensielt koble all aktiviteten din på Bitcoin til identiteten din. Fra dette selskapets synspunkt mister din bruk av Bitcoin all konfidensialitet.

![BTC204](assets/fr/079.webp)

For å illustrere dette med en sammenligning, kan vi tenke oss at bankmannen din i *Bank X* ikke bare har tilgang til alle transaksjonene dine med *Bank X*, men også kan observere transaksjonene dine med *Bank Y* og alle kontanttransaksjonene dine.

Husk fra første del av dette kurset: Bitcoins konfidensialitetsmodell, slik Satoshi Nakamoto utformet den, er basert på separasjonen mellom brukerens identitet og nøkkelparene hans. Selv om dette konfidensialitetslaget ikke lenger er tilstrekkelig i dag, er det fortsatt klokt å begrense forringelsen av det så mye som mulig.

### Eksponering for statlig overvåking

Det andre store problemet med KYC er at det avslører for staten at du har eid bitcoin på et eller annet tidspunkt. Når du kjøper bitcoins via en regulert aktør, blir det mulig for staten å vite om denne besittelsen. I øyeblikket kan dette virke trivielt, men det er viktig å huske at landets politiske og økonomiske fremtid ikke ligger i dine hender.

For det første kan staten raskt innta en autoritær holdning. Historien er full av eksempler på at politikken har endret seg brått. I dag kan Bitcoin-brukere i Europa skrive artikler om Bitcoin, delta på konferanser og forvalte lommebøkene sine på egen hånd. Men hvem kan si hva morgendagen bringer? Hvis Bitcoin plutselig blir folkefiende nummer én, kan det være problematisk å bli assosiert med det i offentlige arkiver.

I møte med alvorlige økonomiske kriser kan staten vurdere å beslaglegge borgernes bitcoins. Kanskje vil bitcoinere i morgen bli oppfattet som kriseprofittører, og de vil bli overbeskattet for sine kapitalgevinster i møte med devaluering av fiat-valuta.

Du tenker kanskje at dette ikke er et problem, ettersom bitcoinsene dine er blandet og derfor ikke kan spores. Sporing er imidlertid ikke problemet her. Det virkelige problemet er at staten vet at du har eid bitcoin. Denne informasjonen alene kan være nok til å inkriminere deg eller stille deg til ansvar. Du kan prøve å hevde at du har brukt opp bitcoinsene dine, men det må gjenspeiles i selvangivelsen din, og du vil bli tatt. Du kan også si at du mistet nøklene dine i en båtulykke, men tror du virkelig at det er nok til å renvaske deg, utover Twitter-vitsen?

Det er derfor viktig å ta hensyn til risikoen for at staten får vite at du har eid BTC, uansett hvor fjern denne risikoen kan virke i dag.

Et annet problem med KYC når det gjelder statlig tilsyn, er den obligatoriske rapporteringen fra regulerte plattformer. Jeg er ikke kjent med regelverket i andre jurisdiksjoner, men i Frankrike er *Prestataires de Services sur Actifs Numériques* (PSAN) forpliktet til å rapportere til finanstilsynsmyndighetene om alle pengebevegelser de anser som mistenkelige.

I Frankrike ble det i 2023 rapportert 1449 mistenkelige handlinger fra PSAN-ene. Foreløpig er de fleste av disse handlingene kriminalitetsrelaterte. Myndighetene ber imidlertid også regulerte plattformer om å rapportere mistenkelige Bitcoin-transaksjoner utelukkende på grunnlag av deres struktur. Hvis du utfører en samarbeidstransaksjon, eller til og med bare en transaksjon med et litt atypisk mønster, og denne transaksjonen skjer ikke langt fra uttaket av dine Bitcoins fra disse plattformene, kan du bli rapportert til myndighetene. Selv om du ikke har gjort noe kriminelt og utøver dine rettigheter på en legitim måte, kan en slik rapportering føre til økt kontroll og overvåkning, noe du ville ha unngått uten KYC.

### Risikoen for lekkasje av personopplysninger

Et annet problem med KYC er at det krever at alle personopplysningene dine lagres på serverne til et privat selskap.

Den siste tidens hendelser har minnet oss på at ingen er immune mot økonomiske eller IT-relaterte feil. I 2022 fikk Celsius' kunder merke konsekvensene. Etter at selskapet gikk konkurs, ble navnene på kreditorene og størrelsen på eiendelene deres offentliggjort av amerikanske domstoler under den administrative saksbehandlingen.

For litt over to år siden var det et flaggskip innen cybersikkerhet for kryptovaluta som fikk kundenes personopplysninger stjålet. Selv om denne hendelsen ikke var direkte knyttet til kjøp av bitcoins, er det fortsatt en slik risiko også for utvekslingsplattformer. Det er derfor en klar risiko forbundet med personopplysninger.

Det er sant at vi allerede overlater mange av våre personlige data til private selskaper. Risikoen her er imidlertid dobbelt, siden disse dataene ikke bare identifiserer deg, men også er knyttet til aktivitet på Bitcoin. Når en hacker får tilgang til kundedataene til en utvekslingsplattform, kan han med rimelighet anta at disse kundene har Bitcoins. Denne risikoen økes av det faktum at Bitcoin, som alle andre verdifulle eiendeler, tiltrekker seg tyvenes oppmerksomhet.

Ved en datalekkasje kan du i beste fall bli utsatt for målrettede phishing-forsøk. I verste fall kan du bli utsatt for fysiske trusler mot hjemmet ditt.

I tillegg til de spesifikke risikoene forbundet med Bitcoin, er det også farene forbundet med overføring av identitetsdokumenter. I tilfelle en datalekkasje er det faktisk mulig å bli offer for identitetstyveri. Så innsatsen er ikke bare begrenset til å beskytte konfidensialiteten til transaksjoner, men gjelder også den personlige sikkerheten til hver enkelt person.

### Noen forutinntatte oppfatninger om KYC

Det er viktig å dekonstruere noen av de forutinntatte ideene om KYC som vi ofte støter på på Twitter eller i utvekslingene våre mellom bitcoinere.

Først og fremst er det unøyaktig å tro at det er meningsløst å beskytte personvernet ditt for Bitcoins ervervet via KYC. Personvernverktøy og -metoder på Bitcoin er varierte og tjener forskjellige formål. Å bruke coinjoin-transaksjoner på Bitcoins ervervet via KYC, for eksempel, er ikke en dårlig idé. Selvfølgelig må du være forsiktig med regulerte utvekslingsplattformer for å unngå at kontoen din blir frosset eller utestengt, men fra et strengt teknisk synspunkt er ikke disse metodene uforenlige. Coinjoin har den effekten at en mynts historikk brytes, og hjelper deg dermed med å motvirke visse kjedeanalyserisikoer forbundet med KYC. Selv om det ikke eliminerer alle risikoer, representerer det en betydelig fordel.

![BTC204](assets/fr/080.webp)

Konfidensialitet på Bitcoin bør ikke ses på på en binær måte, som et skille mellom "anonyme" bitcoins og andre som ikke er det. Å eie Bitcoins ervervet via KYC betyr ikke at alt er tapt; tvert imot kan bruk av konfidensialitetsverktøy vise seg å være enda mer fordelaktig.

På den annen side garanterer ikke anskaffelse av bitcoin via en metode som ikke er basert på kundekontroll perfekt konfidensialitet, og det fritar deg heller ikke fra behovet for å iverksette andre beskyttelsestiltak. Hvis du har bitcoin som ikke er KYC-godkjente, men gjenbruker mottaksadresser flere ganger, kan transaksjonene dine spores og aggregeres. Den minste kobling til verden utenfor Bitcoin kan kompromittere det eneste laget av konfidensialitet du har. Det er derfor viktig å se på alle personvernfremmende verktøy og metoder på Bitcoin som komplementære. Hver teknikk adresserer en spesifikk risiko og kan legge til et ekstra lag med beskyttelse. Så det å eie Bitcoin uten KYC betyr ikke at du ikke trenger å ta andre forholdsregler.

### Kan KYC kanselleres?

Jeg får noen ganger spørsmål om det er mulig å "gå tilbake" etter å ha utført en KYC, og som du kan forestille deg fra de foregående avsnittene, er svaret nyansert. Den enkleste måten å unngå risikoen forbundet med KYC er å ikke bruke den når du anskaffer bitcoins. Vi skal se nærmere på dette emnet i neste kapittel. Men hvis KYC allerede er utført og bitcoins er kjøpt, finnes det måter å redusere risikoen på?

Når det gjelder risikoen for å spore transaksjonene dine, er bruken av coinjoin en løsning. Vi vil se nærmere på denne metoden senere i kurset, men du bør vite at coinjoin lar deg bryte historikken til en mynt og forhindre at den spores fortid-nåtid og nåtid-fortid. Selv for BTC oppnådd via en regulert plattform, kan denne teknikken forhindre sporbarhet.

Coinjoin sletter imidlertid ikke den andre risikoen forbundet med KYC: det faktum at staten kan bli informert om din besittelse av bitcoins. Selv om myntene dine ikke lenger kan spores, kan staten, avhengig av jurisdiksjon, ha tilgang til dine erklæringer om overføring av kryptoaktiva. Ettersom denne risikoen ikke er teknisk, men administrativ, finnes det ingen Bitcoin-spesifikke løsninger for å eliminere den, bortsett fra å ikke utsette deg for KYC i utgangspunktet. Den eneste lovlige måten å redusere denne risikoen på, er å selge Bitcoins du har kjøpt via regulerte plattformer, og deretter kjøpe dem tilbake på en KYC-fri måte. Ved å selge og deklarere overføringen bør myndighetene se at du ikke lenger eier dem.

Når det gjelder risikoen for lekkasje av personopplysninger og identitetsdokumenter, er dette en fare som ligger utenfor Bitcoin, og det finnes ingen teknisk løsning for å unngå det. Når dataene dine har blitt avslørt, er det vanskelig å angre operasjonen. Du kan prøve å stenge kontoen din på plattformen, men dette garanterer ikke sletting av KYC-dataene dine, spesielt når identitetsverifiseringen er outsourcet. Det er umulig å verifisere at opplysningene dine er fullstendig slettet. Det finnes derfor ingen løsning som helt kan forhindre denne risikoen og sikre at den ikke lenger eksisterer.

### Forskjellen mellom KYC og nøkkelidentifikasjon

Noen ganger har noen bitcoinere en tendens til å utvide begrepet "KYC" til enhver BTC-utveksling som involverer en bankoverføring eller kredittkortbetaling, ettersom disse måtene også kan avsløre opprinnelsen til betalingen, akkurat som en KYC ville gjort. KYC bør imidlertid ikke forveksles med nøkkelidentifikasjon. Personlig må jeg innrømme at min oppfatning av dette temaet har utviklet seg over tid.

KYC refererer spesifikt til en regulatorisk prosedyre som er implementert av visse selskaper for å verifisere og registrere identiteten til kundene sine. Det er en binær ting: Når du anskaffer bitcoins, gjør du enten KYC, eller så gjør du det ikke. Nøkkelidentifikasjon, som handler om koblingen mellom en fasett av en brukers identitet og aktivitet i kjeden, er imidlertid ikke like binær, men representerer snarere et kontinuum. I forbindelse med anskaffelse eller overføring av bitcoin er slik identifikasjon alltid mulig i varierende grad.

Hvis du for eksempel kjøper bitcoins på en regulert plattform i Sveits, er det ikke nødvendig med KYC. Nøklene dine kan imidlertid bli identifisert, ettersom kjøpet ble gjort via bankkontoen din. Det er her de to første risikoene forbundet med KYC - tilrettelegging for sporing i kjeden og eksponering for statlig overvåkning - også kan manifestere seg i en børs uten KYC. Hvis den sveitsiske enheten rapporterer mistenkelige transaksjoner til myndighetene i landet ditt, kan de ganske enkelt sjekke bankkontoen som ble brukt til kjøpet for å finne identiteten din. Så kjøp uten KYC på regulerte plattformer ligger ganske høyt på risikoskalaen for nøkkelidentifikasjon.

![BTC204](assets/fr/081.webp)

Å unngå regulerte plattformer og velge P2P-kjøpsmetoder eliminerer imidlertid ikke risikoen for nøkkelidentifikasjon helt, men reduserer den bare. La oss ta et eksempel på et kjøp på Bisq eller en annen P2P-plattform. For å betale motparten bruker du sannsynligvis bankkontoen din. Hvis myndighetene stiller spørsmål ved personen du har handlet med, og ber om navnet ditt, er vi tilbake til risiko 1 og 2. Selv om disse risikoene er mye lavere enn ved kjøp på en plattform uten KYC, og enda lavere enn ved kjøp med KYC, er de fortsatt til stede i mindre grad.

![BTC204](assets/fr/082.webp)

Selv om du skaffer deg bitcoins gjennom en fysisk veksling mot kontanter, er du ikke helt anonym. Personen du byttet med har sett ansiktet ditt, som er en del av identiteten din. Selv om muligheten for nøkkelidentifikasjon er minimal i dette eksemplet, er den fortsatt til stede.

![BTC204](assets/fr/083.webp)

Når bitcoins byttes mot andre eiendeler, enten det er et kjøp i statlig valuta eller et salg mot en ekte vare, er det alltid en eller annen form for nøkkelidentifikasjon. Avhengig av hvilken vekslingsmetode som velges, kan denne identifikasjonen variere i intensitet. Det er viktig å ikke forveksle denne identifikasjonen med KYC, som er en veldefinert regulatorisk prosess. Det er imidlertid en kobling mellom KYC og identifikasjonsspekteret, siden KYC ligger i den øvre enden av spekteret, ettersom det systematisk legger til rette for at myndighetene kan identifisere brukernøkler.

## Salgs- og anskaffelsesmetoder

<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>


Etter å ha lest forrige kapittel lurer du kanskje på hvordan du kan kjøpe eller selge bitcoin uten å måtte gjennomgå en identitetsverifisering, for å unngå risikoen forbundet med KYC. Det finnes flere måter å handle bitcoin på.

### P2P-kontantbørser

Som vi har sett, er den beste metoden når det gjelder konfidensialitet fortsatt P2P-utveksling (person-til-person) med kontantoppgjør. Denne metoden gjør det mulig å minimere sporene som etterlates, og reduserer muligheten for nøkkelidentifikasjon betraktelig, enten du kjøper eller selger.

![BTC204](assets/fr/084.webp)

Likevel er det risiko for personlig sikkerhet. Den største faren ligger i det faktum at motparten under utvekslingen vil vite at du holder en stor sum penger, enten i kontanter eller i bitcoins. Denne informasjonen kan tiltrekke seg oppmerksomheten til ondsinnede personer. Det anbefales derfor generelt å være diskret om bitcoinbeholdningen din. Dette rådet kan også brukes på kontanter. Ved personlig veksling er det imidlertid uunngåelig å avsløre at du eier bitcoins, og dette kan tiltrekke seg uønsket oppmerksomhet.

![BTC204](assets/fr/085.webp)

For å begrense denne risikoen vil jeg råde deg til å foretrekke kontanttransaksjoner med personer du stoler på, for eksempel familiemedlemmer eller nære venner. Alternativt kan du også vurdere å handle på [lokale Bitcoin-møter] (https://btcmap.org/communities/map), etter å ha deltatt noen ganger. Dette vil tillate deg å bli bedre kjent med de andre deltakerne og ikke være alene når du fysisk bytter. Det er imidlertid viktig å være klar over at P2P-kontantbørser i seg selv innebærer en risiko for din personlige sikkerhet som ikke eksisterer når du kjøper via en regulert plattform og bankkontoen din.

Avhengig av hvor du bor, kan det dessuten være risikabelt å transportere og oppbevare store pengesummer, enten det er bitcoin eller kontanter.

Utveksling av kontanter kan også utgjøre en juridisk risiko i tilfelle politikontroller eller andre kontroller. Selv om det i de fleste land ikke er noen begrensninger på hvor mye kontanter du kan ha med deg, kan for store beløp vekke mistanke. Vær derfor forsiktig, spesielt hvis du skal reise langt, og unngå å gjøre for mange store transaksjoner på én gang, slik at du ikke må rettferdiggjøre at du har store summer på deg.

En annen ulempe med P2P-kjøp er at prisen ofte er høyere enn på regulerte plattformer. Selgerne tar ofte et påslag på alt fra 1 % til noen ganger mer enn 10 %. Det er flere grunner til denne prisforskjellen. For det første er dette en vanlig praksis blant P2P-selgere som har blitt etablert over tid. For det andre har selgerne gebyrer knyttet til transaksjonen for å sende pengene til kjøperen. Det er også en økt risiko for tyveri ved P2P-salg sammenlignet med plattformtransaksjoner, noe som rettferdiggjør en kompensasjon for den risikoen som tas. Endelig kan merkostnaden være knyttet til etterspørselen etter og kvaliteten på utvekslingen når det gjelder konfidensialitet. Som kjøper har gevinsten ved konfidensialitet en pris som gjenspeiles i påslaget som selgeren tar. Noen bitcoinere mener også at påslagsprisen på BTC kjøpt på P2P gjenspeiler den reelle prisen, og hevder at de lavere prisene på regulerte plattformer er et resultat av at man går på akkord med konfidensialiteten til personopplysningene sine.

![BTC204](assets/fr/086.webp)

### P2P-utveksling via en matchmaking-plattform

Et mindre risikofylt alternativ når det gjelder personlig sikkerhet, er å utføre P2P-utvekslinger utelukkende på nettet, via elektroniske betalingsmetoder som PayPal, bankoverføringer eller Revolut.

![BTC204](assets/fr/087.webp)

På denne måten unngår man mange av de risikoene som er forbundet med kontanttransaksjoner. Risikoen for at motparten misligholder sine forpliktelser er imidlertid større på en nettbasert børs. I en fysisk veksling kan du umiddelbart stille ham til ansvar hvis du overleverer penger til selgeren som ikke sender deg bitcoins i retur, siden han står foran deg. På nettet, derimot, er det ofte umulig å spore opp noen som har stjålet fra deg.

![BTC204](assets/fr/088.webp)

For å redusere denne risikoen er det mulig å bruke spesialiserte plattformer for P2P-utveksling. Disse plattformene bruker konfliktløsningsmekanismer for å beskytte fornærmede brukere. De tilbyr vanligvis et escrow-system, der bitcoins oppbevares inntil betalingen i fiat-valuta er bekreftet av selgeren.

![BTC204](assets/fr/089.webp)

Når det gjelder personlig sikkerhet, er denne kjøpsmetoden betydelig tryggere enn en fysisk kontantutveksling. Som nevnt ovenfor etterlater imidlertid P2P-børser på nettet flere spor enn en fysisk utveksling, noe som kan være skadelig for personvernet på Bitcoin. Ved å bruke en fiat-betalingsmetode på nettet, for eksempel en bank, eksponerer du mer informasjon som kan gjøre det lettere å identifisere nøkkelpersoner.

![BTC204](assets/fr/090.webp)

Nok en gang vil jeg ikke anbefale å gjøre for mange store handler i én enkelt transaksjon på disse plattformene. Ved å dele opp transaksjonene dine sprer du risikoen for motpartstyveri.

En annen ulempe med P2P-kjøp er at prisen ofte er høyere enn på regulerte plattformer. Selgerne tar ofte et påslag på alt fra 1 % til noen ganger mer enn 10 %. Det er flere grunner til denne prisforskjellen. For det første er dette en vanlig praksis blant P2P-selgere som har blitt etablert over tid. For det andre har selgerne gebyrer knyttet til transaksjonen for å sende pengene til kjøperen. Det er også en økt risiko for tyveri ved P2P-salg sammenlignet med plattformtransaksjoner, noe som rettferdiggjør en kompensasjon for den risikoen som tas. Endelig kan merkostnaden være knyttet til etterspørselen etter og kvaliteten på utvekslingen når det gjelder konfidensialitet. Som kjøper har gevinsten ved konfidensialitet en pris som gjenspeiles i påslaget som selgeren tar. Noen bitcoinere mener også at påslagsprisen på BTC kjøpt på P2P gjenspeiler den reelle prisen, og hevder at de lavere prisene på regulerte plattformer er et resultat av at man går på akkord med konfidensialiteten til personopplysningene sine.

![BTC204](assets/fr/086.webp)

Når det gjelder løsninger, har jeg personlig alltid brukt [Bisq] (https://bisq.network/), og jeg er veldig fornøyd med det. Systemet deres er velprøvd og virker pålitelig. Bisq er imidlertid bare tilgjengelig på PC, og grensesnittet kan være for komplisert for nybegynnere. En annen ulempe er at Bisq kun opererer med onchain-transaksjoner, noe som kan bli kostbart i perioder med høye Bitcoin-transaksjonsgebyrer.

-> Se vår Bisq-veiledning.

https://planb.network/tutorials/exchange/peer-to-peer/bisq-fe244bfa-dcc4-4522-8ec7-92223373ed04

For et enklere alternativ kan du prøve [Peach] (https://peachbitcoin.com/), en mobilapp som kobler sammen kjøpere og selgere med et innebygd konfliktløsningssystem. Prosessen er mer intuitiv enn Bisqs.

-> Se vår Peach-veiledning.

https://planb.network/tutorials/exchange/peer-to-peer/peach-c6143241-d900-4047-9b73-1caba5e1f874

Et annet online-alternativ er [HodlHodl] (https://hodlhodl.com/), en veletablert plattform som tilbyr god likviditet, selv om jeg ikke har testet den personlig.

-> Se vår HodlHodl-veiledning.

https://planb.network/tutorials/exchange/peer-to-peer/hodlhodl-d7344cd5-6b18-40f5-8e78-2574a93a3879

For Lightning Network-baserte løsninger kan du prøve [RoboSats] (https://learn.robosats.com/) og [LNP2PBot] (https://lnp2pbot.com/). RoboSats er tilgjengelig via en nettside og er relativt enkel å bruke. LNP2PBot er mer atypisk, ettersom den fungerer via et utvekslingssystem på Telegram-meldingsapplikasjonen.

-> Se vår RoboSats-veiledning.

-> Se vår LNP2PBot-veiledning.

https://planb.network/tutorials/exchange/peer-to-peer/robosats-b60e4f7c-533a-4295-9f6d-5368152e8c06

https://planb.network/tutorials/exchange/peer-to-peer/lnp2pbot-v2-e6bcb210-610b-487d-970c-7cce85273e3c

![BTC204](assets/fr/091.webp)

### Regulerte plattformer uten KYC

Avhengig av hvilket land du bor i, kan du ha tilgang til regulerte plattformer som ikke krever KYC-prosedyrer for å kjøpe eller selge bitcoins. I Sveits kan du for eksempel bruke plattformer som [Relai] (https://relai.app/) og [MtPelerin] (https://www.mtpelerin.com/).

-> Se vår veiledning om Relai.

https://planb.network/tutorials/exchange/centralized/relai-v2-30a9671d-e407-459d-9203-4c3eae15b30e

Som vi så i forrige kapittel, sparer denne typen plattformer deg for risikoen forbundet med KYC-prosedyrer, men de utgjør en høyere risiko for nøkkelidentifikasjon. Når det gjelder Bitcoin-konfidensialitet, tilbyr disse plattformene bedre beskyttelse enn kjøpsmetoder med KYC, men de er fortsatt mindre attraktive enn P2P-børser.

Når det gjelder personlig sikkerhet, er det imidlertid langt mindre risikabelt å bruke disse plattformene enn P2P-børser. De er også ofte enklere å bruke enn P2P-plattformer.

### Minibanker

Et annet alternativ for å kjøpe eller selge bitcoins uten KYC er minibanker for kryptovaluta. Personlig har jeg aldri hatt muligheten til å teste denne løsningen, ettersom det ikke finnes noen i mitt land. Men denne metoden kan være veldig interessant, avhengig av hvor du bor.

![BTC204](assets/fr/092.webp)

Problemet med minibanker er at de enten er forbudt i noen land, eller sterkt regulert i andre. Hvis en minibank krever en prosedyre for identitetsbekreftelse, er den utsatt for samme risiko som de KYC-regulerte plattformene. Hvis minibanken derimot tillater transaksjoner uten identitetsbekreftelse for små beløp, kan den tilby et konfidensialitetsnivå som kan sammenlignes med en P2P-kontantutveksling, samtidig som man unngår de fleste av risikoene som er forbundet med denne typen utveksling.

Den største ulempen med minibanker er de ofte høye vekslingsgebyrene, som varierer fra noen få prosent opp til 15 % av det vekslede beløpet.

### Gavekort

Til slutt vil jeg også introdusere deg for en løsning som fungerer godt for de som ønsker å bruke bitcoinsene sine på daglig basis til å gjøre innkjøp i stedet for å selge dem mot fiat-valutaer.

Den beste måten å bruke BTC på er selvfølgelig å bruke Bitcoin eller Lightning Network direkte til å kjøpe en vare eller tjeneste. I mange land er det imidlertid fortsatt begrenset hvor mange forretninger som aksepterer Bitcoin. Et praktisk alternativ er å bruke gavekort.

Flere plattformer som ikke krever KYC-prosedyrer, tilbyr muligheten til å veksle bitcoins til gavekort som kan brukes hos store forhandlere. Disse inkluderer [CoinsBee] (https://www.coinsbee.com/), [The Bitcoin Company] (https://thebitcoincompany.com/) og [Bitrefill] (https://www.bitrefill.com/). Disse plattformene gjør det mye enklere å bruke bitcoinsene dine på daglig basis, og gir deg tilgang til et bredt spekter av produkter og tjenester uten å måtte konvertere dem til fiat-valuta.

https://planb.network/tutorials/exchange/centralized/bitrefill-8c588412-1bfc-465b-9bca-e647a647fbc1

![BTC204](assets/fr/093.webp)

### Andre anskaffelsesmetoder

Andre måter å anskaffe bitcoins på, samtidig som du beskytter personvernet ditt, inkluderer selvfølgelig utvinning. For å starte utvinning av sats trenger du ikke å avsløre identiteten din; du trenger bare å finne et gyldig arbeidsbevis og sende det til nettverket. Hvis du velger utvinning i et basseng, krever noen bassenger en form for identifikasjon, for eksempel en KYC, mens andre ikke gjør det.

En annen metode er å jobbe i bytte mot bitcoins. Denne anskaffelsesmetoden kan være interessant, men graden av identifikasjon som kreves varierer betydelig avhengig av omstendighetene.

*For å skrive dette kapittelet brukte jeg BTC205-kurset som ble gitt av [@pivi___] (https://x.com/pivi___) på Plan ₿ Network (foreløpig bare tilgjengelig på fransk)

## Konsolidering, UTXO-ledelse og CIOH

<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>


Et av de mest kompliserte aspektene ved å drive en portefølje med egen forvaltning er konsolidering. Bør du konsolidere? Hva er poenget? Hvor stor UTXO bør man respektere? Hva er kompromissene når det gjelder konfidensialitet? Det er dette vi skal se nærmere på i denne delen.

### Hva er konsolidering?

Bitcoin fungerer som et auksjonsmarked, der utvinnere foretrekker transaksjoner som tilbyr de laveste avgiftene. Hver blokk har imidlertid en maksimal vekt, noe som begrenser antallet transaksjoner som kan inkluderes. Ettersom en blokk produseres i gjennomsnitt hvert tiende minutt, er den tilgjengelige plassen i hver blokk en knapp ressurs.

Gruvearbeidere, hvis virksomhet genererer betydelige kostnader i form av strøm, anleggsmidler og vedlikehold, søker naturlig nok å maksimere lønnsomheten. De har derfor en tendens til å favorisere transaksjoner som genererer de høyeste avgiftene i forhold til vekten deres.

Ikke alle Bitcoin-transaksjoner har samme vekt. De med flere innganger og utganger vil veie mer. La oss for eksempel se for oss to transaksjoner:


- Transaksjon A består av 1 inngang og 1 utgang. Den allokerer 1 994 satser med avgifter og har en vekt på 141 vB ;
- Transaksjon B, en mer kompleks transaksjon med to innganger og to utganger, allokerer 2640 satser i avgifter med en vekt på 220 vB.

![BTC204](assets/fr/094.webp)

I dette eksempelet vil utvinnere foretrekke transaksjon A, selv om transaksjon B gir en høyere totalavgift, ettersom den gir et bedre forhold mellom avgift og vekt. Her er beregningen for hver transaksjon, uttrykt i sats per virtuell byte (sat/vB):

```text
TXA : 1994 / 141 = 14 sats/vB
TXB : 2640 / 220 = 12 sats / vB
```

Det betyr at for hver vektenhet gir transaksjon A høyere kostnader enn transaksjon B, selv om transaksjon B gir høyere kostnader i absolutte termer.

![BTC204](assets/fr/095.webp)

Det er derfor alltid mer interessant for brukeren å forbruke så lite input som mulig i sine transaksjoner. Du må imidlertid forbruke tilstrekkelige mengder for å kunne tilfredsstille utbetalingen. Når du forvalter porteføljen din, må du ha tilstrekkelig store UTXO-er.

Konsolideringsprinsippet går nettopp ut på å utnytte perioder med lave gebyrer på Bitcoin til å slå sammen de mindre UTXOene til én større. På denne måten, når avgiftene stiger på Bitcoin, vil du kunne gjøre transaksjoner med et minimum av innganger, og derfor bruke mindre på avgifter i absolutte termer. Målet er derfor å forutse de obligatoriske transaksjonene som skal utføres i perioder med høye gebyrer.

![BTC204](assets/fr/096.webp)

I tillegg til å spare transaksjonskostnader bidrar konsolidering av UTXO-er til å forhindre dannelsen av "støv". Med "støv" menes UTXOer som har så lav verdi i sats at den ikke er tilstrekkelig til å dekke transaksjonskostnadene som kreves for å bruke dem. Dette gjør det økonomisk irrasjonelt å bruke disse UTXO-ene så lenge transaksjonskostnadene forblir høye. Ved å samle UTXO-ene dine proaktivt, forhindrer du at de blir til støv, og sørger for at alle midlene dine forblir brukbare.

### Hva er minimumsstørrelsen for UTXO-ene dine?

Jeg får av og til spørsmål om hva som er den anbefalte minimumsverdien for en UTXO. Dessverre finnes det ikke noe universelt svar, ettersom det avhenger av dine preferanser og forholdene i gebyrmarkedet. Her er imidlertid en formel som kan hjelpe deg med å finne en terskelverdi som passer til dine behov:

$$
\frac {P \times F}T = M
$$

Hvor?


- p$ er transaksjonsvekten;
- $F$ representerer den maksimale ladningsraten i satoshis per vbyte (sats/vB) som du sikrer deg mot;
- t$ er prosentandelen av transaksjonsgebyret du er villig til å betale i forhold til den totale verdien av UTXO ;
- m$ er minimumsbeløpet i satoshis for hver UTXO.

La oss anta at du planlegger å dekke avgiftene for en standard SegWit-transaksjon med 1 inngang og 2 utganger, som veier 141 vB. Hvis du hedger opptil 800 sats/vB, og du er villig til å bruke opptil 12 % av UTXO-verdien i gebyrer, blir beregningen som følger:

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

I dette eksempelet vil det derfor være klokt å beholde en minimumsverdi på 940 000 sats for UTXO-er i porteføljen.

### Konsolidering og CIOH

En av de mest brukte heuristikkene i blokkjedeanalyse er CIOH (*Common Input Ownership Heuristic*), som antar at alle inndata til en Bitcoin-transaksjon tilhører samme enhet. Selve prinsippet med konsolidering er å konsumere flere UTXO-er som input og skape én enkelt UTXO som output. Konsolidering gjør det dermed mulig å bruke ICOH.

![BTC204](assets/fr/097.webp)

I praksis betyr dette at en utenforstående observatør kan utlede at alle de konsoliderte UTXO-ene sannsynligvis tilhører samme person, og at den unike utdataen som genereres, også tilhører ham eller henne. Denne situasjonen kan sette konfidensialiteten i fare ved at ulike transaksjonshistorikker knyttes sammen. La oss for eksempel si at jeg konsoliderer tre UTXO-er som er anskaffet via P2P, med én UTXO som er anskaffet via en plattform som krever KYC:

![BTC204](assets/fr/098.webp)

Ved å gjøre dette vil enhver enhet med tilgang til børsplattformens data, potensielt inkludert offentlige etater, kunne identifisere at jeg eier andre mengder BTC. Tidligere var ikke disse UTXO-ene direkte knyttet til identiteten min; nå er de det. I tillegg avslører det for alle kilder at jeg er i besittelse av en viss mengde bitcoins.

Når det gjelder håndtering av UTXO-er, kommer økonomiske hensyn, som driver frem konsolidering for å redusere kostnader, i konflikt med god personvernpraksis, som anbefaler at UTXO-er aldri slås sammen. Valget mellom økonomi og konfidensialitet avhenger derfor av den enkelte brukers prioriteringer.

Hvis du kan unngå konsolidering og samtidig opprettholde betydelige UTXO-er, er det ideelt. For å gjøre dette må du optimalisere anskaffelsesmetodene dine. Hvis du kjøper bitcoins i DCA, bør du prøve å spre engangskjøpene dine så mye som mulig for å konsolidere verdien over færre UTXO-er. Det vil være lettere å håndtere et engangskjøp på 1 000 euro annenhver måned enn et kjøp på 120 euro hver uke. Dette minimerer antallet UTXO-er som genereres, og forenkler forvaltningen av porteføljen samtidig som konfidensialiteten din bevares.

Hvis du må slå sammen bitcoins, bør du først og fremst slå sammen UTXO-er fra samme kilde. Hvis du for eksempel slår sammen 10 UTXO-er fra én plattform, vil det påvirke konfidensialiteten din mindre enn hvis du blander 5 UTXO-er fra plattform A med 5 UTXO-er fra plattform B. Hvis konsolidering av ulike kilder er uunngåelig, bør du prøve å skille dem i henhold til deres egenskaper. Grupper for eksempel UTXO-er som er anskaffet via KYC i én transaksjon, og UTXO-er som er anskaffet via P2P i en annen.

Uansett må du ikke glemme at enhver konsolidering uunngåelig medfører tap av konfidensialitet. Vurder derfor nøye behovet for denne operasjonen og den potensielle innvirkningen på personvernet ditt, og ta hensyn til CIOH.

## Annen beste praksis

<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>


La oss ta en titt på noen andre beste fremgangsmåter for å optimalisere personvernet ditt på Bitcoin.

### Den komplette knuten

Å eie dine bitcoins i egen forvaring er flott, men å bruke din egen komplette node er enda bedre! Her er hvorfor det å ha din egen node er avgjørende for å kunne bruke Bitcoin helt suverent:


- Motstand mot sensur**: Transaksjonene dine kan ikke blokkeres av noen;
- Uavhengighet fra tredjeparter**: Du er ikke lenger avhengig av noen ekstern tjeneste for å verifisere blokkjededata;
- Aktiv deltakelse**: Du kan definere dine egne valideringsregler og delta direkte i konsensusprosessen;
- Bidrag til nettverket**: Ved å drive en node bidrar du til å styrke og distribuere Bitcoin-nettverket;
- Teknisk utdannelse**: Å administrere en komplett node er en flott måte å utdype din tekniske kunnskap om Bitcoin på.

I tillegg til disse fordelene gir bruk av en komplett node også bedre konfidensialitet når du sender transaksjonene dine. Når du utsteder en transaksjon, blir den først opprettet og signert via lommeboken din. For å kringkaste den i Bitcoin-nettverket må den være kjent av minst én node. Ved å bruke din egen node har du direkte kontroll over denne distribusjonen, noe som styrker konfidensialiteten din og begrenser risikoen for datalekkasje.

![BTC204](assets/fr/099.webp)

Hvis du ikke har din egen Bitcoin-node, må du bruke en tredjepartsnode, for eksempel den som tilbys av leverandøren av lommebokprogramvaren din. I tillegg til å kringkaste transaksjoner, trenger lommeboken din tilgang til diverse informasjon, for eksempel ventende transaksjoner, saldoer knyttet til adressene dine og antall bekreftelser for transaksjonene dine. For å få tilgang til alle disse dataene må du forespørre en node.

![BTC204](assets/fr/100.webp)

Den største risikoen når du ikke bruker din egen Bitcoin-node, er at operatøren av tredjepartsnoden kan observere aktivitetene dine på blokkjeden, eller til og med dele denne informasjonen med andre enheter. For å begrense denne risikoen er en mellomløsning å bruke lommebokprogramvare som maskerer forbindelsene dine via Tor. Dette kan redusere eksponeringen av dataene dine. Den optimale løsningen er imidlertid å ha din egen Bitcoin-node og bruke den til å kringkaste transaksjonene dine. Du må selvfølgelig også være forsiktig så du ikke lekker informasjon gjennom noden din, men det er et annet tema vi skal se nærmere på i senere avsnitt.

Utover den åpenbare fordelen for personvernet ditt, sikrer det å ha din egen komplette node deg også sannheten til data på blokkjeden, beskytter deg mot sensur og lar deg delta aktivt i Bitcoins styring. Ved å bruke din egen node bidrar du med din økonomiske tyngde til den kjeden du velger, noe som er viktig under konflikter i samfunnet, som for eksempel under Blocksize-krigen fra 2015 til 2017. I tilfelle en forgrening kan det å bruke en tredjepartsnode føre til at du støtter en kjede du ikke ønsker å favorisere, ettersom nodeoperatøren tar valget for deg.

Som du ser, er det av hensyn til konfidensialitet og individuell suverenitet viktig å kjøre og bruke din egen komplette node!

### Villedende analyseheuristikk

Mer generelt er det viktig å forstå heuristikkene vi snakket om i forrige avsnitt, slik at man bedre kan unngå eller lure dem. Det kan være fordelaktig å ta i bruk en rekke beste praksiser, selv om de ikke er essensielle. De tilbyr et ekstra lag med beskyttelse som kan være viktig for å opprettholde konfidensialitet ved bruk av Bitcoin.

Det første rådet jeg kan gi er å blande seg med den tetteste mengden. På Bitcoin betyr dette å bruke de mest brukte skriptmalene. For eksempel er P2WSH-skript, som ofte brukes for SegWit V0 multisig-konfigurasjoner, svært uvanlige. De lar deg ikke gjemme deg i et stort anonymitetssett. Det samme gjelder eldre modeller som P2PKH eller P2SH. Selv om de er mye til stede i UTXO-settet, brukes de mindre og mindre for nye transaksjoner.

Generelt sett er det klokere å velge den nyeste skriptstandarden, forutsatt at den har blitt tilstrekkelig tatt i bruk. Så hvis jeg i 2022 ville ha frarådet å bruke P2TR (Taproot) på grunn av den lave adopsjonen, vil jeg i 2024 anbefale å velge denne typen skript i stedet, eller hvis ikke, SegWit V0-skript, ettersom antallet transaksjoner som bruker P2TR begynner å utgjøre en veldig betydelig andel.

![BTC204](assets/fr/101.webp)

Kilde: [txstats.com] (https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)

Et annet tips for å bevare konfidensialiteten er å prøve å omgå interne transaksjonsheuristikker. Når du for eksempel foretar en betaling, kan du prøve å unngå å opprette en utdata med et rundt beløp, da dette kan signalisere at den andre utdataen representerer utenlandsk valuta. Hvis du skal sende 100 000 sats til en venn, kan du vurdere å overføre et litt høyere beløp for å unngå denne heuristikken. På samme måte bør du prøve å unngå å opprette valutautganger som er uforholdsmessig høye i forhold til betalingen, da dette også kan avsløre hvilken av utgangene som representerer utenlandsk valuta.

![BTC204](assets/fr/102.webp)

Til slutt, hvis du utfører Bitcoin-transaksjoner regelmessig, må du sørge for at du ikke alltid sender dem på samme tidspunkter. Ved å spre utsendelsen av transaksjonene dine utover dagen og uken, unngår du å gi utenforstående observatører muligheten til å oppdage et tidssone-basert tidsmønster som kan forsterke analysen deres.

I tillegg til alle disse gode praksisene som skal tas i bruk på daglig basis, finnes det enda mer effektive metoder for å fullstendig bryte sporbarheten til bitcoinsene dine. Disse inkluderer selvfølgelig coinjoin-transaksjoner, som vi skal se nærmere på i neste avsnitt.

# Forståelse av coinjoin-transaksjoner

<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## Hva er en coinjoin-transaksjon?

<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>


Etter å ha studert det grunnleggende om personvern, skal vi nå se på mer sofistikerte teknikker som tar sikte på å aktivt forsvare konfidensialiteten din, spesielt ved å skille ut bitcoin-historikken din. I neste del skal vi se på en rekke små teknikker, men først vil jeg gjerne fortelle deg om coinjoin.

Coinjoin anses ofte som den mest effektive metoden for å beskytte personvernet til Bitcoin-brukere. Men hva er egentlig en coinjoin-transaksjon? La oss finne ut av det.

### De grunnleggende prinsippene for coinjoin

Coinjoin er en teknikk for å bryte bitcoin-sporing på blokkjeden. Den er basert på en samarbeidstransaksjon med en spesifikk struktur med samme navn: coinjoin-transaksjonen.

Som vi så i de første delene av dette kurset, er Bitcoin-transaksjoner kjent for alle brukere via noden deres. Det er derfor enkelt å sjekke den elektroniske signaturkjeden til hver enkelt mynt og observere dens historikk. Dette betyr at alle brukere kan forsøke å analysere transaksjonene til andre brukere. Dermed er anonymitet på transaksjonsnivå umulig. Anonymiteten er imidlertid ivaretatt på individnivå. I motsetning til det konvensjonelle banksystemet, der hver konto er knyttet til en personlig identitet, er midler i Bitcoin knyttet til kryptografiske nøkkelpar (eller skript), noe som gir brukerne en form for pseudonymitet bak kryptografiske identifikatorer.

![BTC204](assets/fr/103.webp)

Bitcoins konfidensialitet undergraves når utenforstående observatører kan knytte spesifikke UTXO-er til identifiserte brukere. Når denne tilknytningen er etablert, blir det mulig å spore transaksjonene deres og analysere Bitcoin-historikken deres. Coinjoin er nettopp en teknikk som er utviklet for å bryte sporbarheten til UTXO-er, for å tilby Bitcoin-brukere et visst lag med konfidensialitet på transaksjonsnivå.

Coinjoins styrker Bitcoin-brukernes konfidensialitet ved å gjøre kjedeanalysen mer kompleks for eksterne observatører. Strukturen gjør det mulig å slå sammen flere mynter fra ulike brukere til én enkelt transaksjon, noe som gjør det vanskelig å fastslå koblingene mellom inngangs- og utgangsadresser.

Det er viktig å forstå at målet med en coinjoin-transaksjon er å bryte historikken til en mynt. Denne teknikken gir ikke permanent anonymitet eller blokkerer definitivt sporing av bitcoin, i motsetning til hva du kanskje tror. Coinjoin har kun som mål å bryte historikken på det punktet der coinjoin-transaksjonen utføres. Før og etter denne operasjonen er mynten imidlertid fortsatt utsatt for den samme risikoen når det gjelder konfidensialitet.

![BTC204](assets/fr/104.webp)

### Hvordan fungerer coinjoins?

Coinjoin-prinsippet er basert på en samarbeidstilnærming: Flere brukere som ønsker å blande bitcoinsene sine, setter inn identiske beløp som input i samme transaksjon. Disse beløpene blir deretter omfordelt i utganger med lik verdi til hver bruker.

![BTC204](assets/fr/105.webp)

På slutten av transaksjonen blir det umulig å knytte en spesifikk utgang til en bruker som er kjent som en inngang. Det er ingen direkte kobling mellom innganger og utganger, noe som bryter forbindelsen mellom brukere og deres UTXO-er, samt historikken til hver del.

![BTC204](assets/fr/106.webp)

La oss ta Alices eksempel. Hun ønsker å sende rundt 100 000 sats til søsteren Eve i bursdagsgave. Alice vil imidlertid ikke at Eve skal kunne spore transaksjonshistorikken hennes, ettersom hun ikke ønsker å avsløre hvor mange bitcoins hun har eller hvordan hun fikk tak i dem. Derfor bestemmer Alice seg for å bryte UTXO-historikken sin med en coinjoin-transaksjon. Hun organiserer seg med Bob, Charles, David og Frank for å gjennomføre en samarbeidstransaksjon:


- Alice, Bob, Charles, David og Frank forplikter seg til å bruke hver sin UTXO på 105 000 sats (med 5 000 sats til gruveavgifter) som input i transaksjonen:

![BTC204](assets/fr/107.webp)


- Til gjengjeld genererer hver av dem en tom adresse for å skape fem identiske utganger på 100 000 satser hver. Hver av dem henter én utgang:

![BTC204](assets/fr/108.webp)


- Alice sitter med en UTXO på 100 000 satser, og historikken er forvekslet. Hun bruker denne UTXO-en i en ny transaksjon for å sende beløpet til Eve på bursdagen hennes:

![BTC204](assets/fr/109.webp)


- Hvis Eve prøver å analysere denne transaksjonen for å hente ut informasjon, vil hun bli konfrontert med coinjoin-transaksjonen som involverer Alice, Bob, Charles, David og Frank. Siden Eve ikke kan skille mellom hvem som eier hvem på grunn av at beløpene er like, kan hun ikke spore Alices UTXO-historikk, og hun kan heller ikke finne ut hvor mange bitcoins søsteren hennes eier eller hvordan hun har skaffet seg dem:

![BTC204](assets/fr/110.webp)

I dette tilfellet har Alice brukt coinjoin-teknikken for å øke konfidensialiteten med hensyn til retrospektiv analyse. Alice beskytter seg dermed mot en mulig analyse fra Eve, som kan ta utgangspunkt i en bestemt transaksjon og arbeide seg bakover gjennom UTXO-historikken. Denne beskyttelsen mot analyse fra nåtid til fortid kalles retrospektiv anonset. Vi skal se nærmere på dette konseptet i de siste kapitlene i denne delen.

Coinjoin gir imidlertid også muligheten til å forsterke konfidensialiteten i forbindelse med en analyse fra fortid til nåtid, såkalt prospektiv anonset. La oss gå tilbake til eksempelet der Alice sendte Eva 98 000 sats i bursdagsgave, men med ombyttede roller. La oss nå tenke oss at det er Eva som er bekymret for personvernet sitt. Alice kan bli fristet til å spore mynten hun sendte til Eva for å hente ut informasjon fra den. Eva kan godt konsolidere denne UTXO-en hun nettopp har mottatt med alle sine andre UTXO-er, noe som kan avsløre for Alice hvor mange bitcoins hun har i lommeboken sin. For å unngå dette kan Eva også bryte historikken til mynten hun nettopp har mottatt:


- Eve, Grace, Mallory, Oscar og Victor legger inn en UTXO på 98 000 sats hver som input til en Bitcoin-transaksjon:

![BTC204](assets/fr/111.webp)


- Til gjengjeld for å bruke disse inndataene får hver bruker en tom adresse som skal brukes til å lage fem utdata på 97 500 helt like satser. Hver bruker får én utgang:

![BTC204](assets/fr/112.webp)


- Eve har nå en UTXO med 97 500 satellitter, og historikken er brutt. Hun kan bruke den uten frykt til å utføre fremtidige transaksjoner. Hvis Alice prøver å spore bitcoinsene hun har sendt til Eve, vil hun bli konfrontert med en coinjoin-transaksjon. Hun vil ikke være i stand til å avgjøre hvilken utgående UTXO som tilhører Eve. Analyse blir umulig:

![BTC204](assets/fr/113.webp)

I det første eksempelet så vi hvordan coinjoin kan beskytte et roms personvern i forhold til dets fortid, og i det andre eksempelet hvordan det også kan sikre et roms historie i forhold til dets fremtid. Det var derfor jeg nevnte at coinjoin bør ses på som en engangshendelse som segmenterer en delhistorie i begge retninger:

![BTC204](assets/fr/104.webp)

### Mixer, coinjoin, mixer... Hva er forskjellen?

Coinjoins blir noen ganger beskrevet som "mixers", et begrep som noen bitcoinere avviser av frykt for at det kan forveksles med custodial mixers. Jeg mener imidlertid at denne frykten er ubegrunnet, siden coinjoin i en matematisk sammenheng nettopp er et uttrykk for begrepet mixing.

I matematikken generelt refererer blanding til egenskapen til et dynamisk system der alle deler av det opprinnelige rommet etter en viss tidsperiode teoretisk sett kan blandes med alle andre deler. Blanding innebærer at posisjonen til en partikkel eller tilstanden til et system utvikler seg på en slik måte at den fremtidige fordelingen er uavhengig av den opprinnelige fordelingen, slik at man når en tilstand der egenskapene til den opprinnelige tilstanden er jevnt fordelt i hele systemets rom. Dette er nøyaktig hva som skjer i en coinjoin med bitcoins. Så etter min mening er coinjoin virkelig en myntblandingsmetode.

![BTC204](assets/fr/114.webp)

På den annen side er det viktig å skille coinjoin fra shufflere. En shuffler er en tjeneste der brukerne sender bitcoinsene sine for å bli shufflet. Disse tjenestene var populære på 2010-tallet, men bruken av dem har gått ned på grunn av to store ulemper sammenlignet med coinjoin:


- De krever at brukerne gir fra seg kontrollen over midlene sine under blandingsprosessen, noe som utsetter dem for tyveririsiko;
- Det er ingen garanti for at mikseren ikke registrerer transaksjonsdetaljer, eller til og med selger denne informasjonen til kjedeanalyseselskaper.

![BTC204](assets/fr/115.webp)

Dagens brukere foretrekker derfor coinjoin, ettersom det lar dem beholde full kontroll over pengene sine gjennom hele prosessen. Coinjoin-deltakere løper ingen risiko for å få bitcoinsene sine stjålet av de andre involverte partene. La oss se nærmere på hvordan alt dette er mulig i neste kapittel.

## Zerolink og chaumian coinjoins

<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>


Privatlivet som en coinjoin gir, avhenger av størrelsen på gruppen som brikken vår er gjemt i. Det betyr at vi må finne så mange deltakere som mulig. Det er fullt mulig å opprette en coinjoin manuelt, med brukere vi har funnet selv, men dette er en kompleks prosess, og vil ikke gi deg noen store anonsett.

Dette er grunnen til at coinjoin-koordinatorer har utviklet seg på Bitcoin. Deres rolle er å sette de ulike brukerne i kontakt med hverandre og overføre informasjonen som trengs for å fullføre samarbeidstransaksjonen.

![BTC204](assets/fr/116.webp)

Men hvordan kan vi sikre at koordinatoren aldri får tak i brukernes bitcoins, og til tross for at det er han som bygger coinjoin-transaksjonen, hvordan kan vi sikre at han ikke kan koble sammen brukernes input og output, noe som kan utgjøre en konfidensialitetslekkasje?

### Chaums blinde signaturer

Moderne coinjoin-implementeringer bruker David Chaums blindsignaturer for å unngå å lekke informasjon. La oss ta en rask titt på hvordan disse blindsignaturene fungerer.

Chaums blindsignaturer er en form for digital signatur der utstederen av en signatur ikke kjenner innholdet i meldingen han signerer. Men signaturen kan deretter verifiseres mot den opprinnelige meldingen. Denne teknikken ble utviklet av kryptografen David Chaum i 1983.

![BTC204](assets/fr/117.webp)

La oss ta et eksempel med en bedrift som ønsker å autentisere et konfidensielt dokument, for eksempel en kontrakt, uten å avsløre innholdet. Bedriften bruker en maskeringsprosess som kryptografisk omdanner originaldokumentet på en reversibel måte. Det modifiserte dokumentet sendes til en sertifiseringsinstans, som påfører en blind signatur uten å kjenne til det underliggende innholdet. Etter å ha mottatt det signerte dokumentet, avmaskerer selskapet signaturen. Resultatet er et originaldokument som er autentisert med autoritetens signatur, uten at autoriteten noen gang har sett det opprinnelige innholdet.

Chaums blindsignaturer kan derfor bekrefte autentisiteten til et dokument uten å kjenne til innholdet, og dermed garantere både konfidensialiteten til brukerens data og integriteten til det signerte dokumentet.

### Chaumian coinjoins

Såkalte "Chaumian"-coinjoins kombinerer bruken av Tor og David Chaums blindsignaturer for å sikre at koordinatoren ikke kan vite hvilken utdata som tilhører hvilken bruker.

Prosessen med å konstruere en coinjoin-transaksjon består av tre hovedfaser: registrering av input, registrering av output og transaksjonssignatur. La oss se på denne prosessen gjennom eksemplet med Alice, en av deltakerne i coinjoin. Alle de andre deltakerne følger de samme trinnene som Alice, hver for seg.

**Trinn 1: Inngangsregistrering


- Alice sender UTXO-en hun ønsker å bruke som input til transaksjonen, samt den maskerte mottaksadressen hun ønsker å bruke som output for å motta bitcoinsene sine, til koordinatoren. Koordinatoren har derfor ingen mulighet til å vite Alices adresse. Den ser bare den maskerte versjonen hennes:

![BTC204](assets/fr/118.webp)


- Koordinatoren sjekker gyldigheten av inndataene, og signerer deretter Alices maskerte adresse med sin private nøkkel. Han returnerer den blinde signaturen til Alice:

![BTC204](assets/fr/119.webp)

**Trinn 2: Registrering av utganger**


- Alice kan avmaske adressen sin, som nå er signert med koordinatorens private nøkkel. Hun oppretter en ny forbindelse under en annen Tor-identitet. Koordinatoren kan ikke identifisere at det er Alice som kobler seg til under denne nye identiteten:

![BTC204](assets/fr/120.webp)


- Alice sender den umaskerte adressen og signaturen til koordinatoren (som fortsatt ikke vet at det er Alice):

![BTC204](assets/fr/121.webp)

**Trinn 3: Signering av transaksjonen**


- På samme måte henter koordinatoren inn umaskerte utdata fra alle deltakerne. Takket være de tilhørende signaturene kan han kontrollere at hver anonymt innsendte output er signert med hans private nøkkel på forhånd, og dermed garantere at de er legitime. Deretter er han klar til å lage coinjoin-transaksjonen og sende den til deltakerne for signering:

![BTC204](assets/fr/122.webp)


- Alice, i likhet med de andre deltakerne, sjekker at hennes input og output er korrekt inkludert i transaksjonen som er konstruert av koordinatoren. Hvis alt er i orden, sender hun signaturen som låser opp inndataskriptet hennes, til koordinatoren:

![BTC204](assets/fr/123.webp)


- Etter å ha samlet inn signaturer fra alle coinjoin-deltakerne, kan koordinatoren kringkaste transaksjonen på Bitcoin-nettverket, slik at den kan legges til i en blokk.

I dette systemet kan ikke koordinatoren koble en input til en spesifikk output. I tillegg kan han ikke tilegne seg deltakernes midler, siden han aldri har tilgang til de private nøklene som trengs for å låse opp UTXO-ene deres. Gjennom hele prosessen, helt til slutten av trinn 3, har han heller ikke tilgang til signaturene. Når Alice og de andre deltakerne signerer den globale transaksjonen, etter å ha kontrollert at alt er korrekt, kan koordinatoren ikke lenger endre transaksjonen, inkludert utdataene, uten å ugyldiggjøre den. Dette hindrer koordinatoren i å stjele bitcoins.

Til slutt, når coinjoin-brukeren registrerer sin innsats i transaksjonen, ønsker han eller hun å ha samme garantier som en borger som stemmer i et valg. Det er en dualitet mellom de offentlige og private aspektene ved disse handlingene. På den ene siden er det det du ønsker å holde privat: Velgeren ønsker ikke at stemmeseddelen hans skal knyttes til identiteten hans, og coinjoin-brukeren ønsker ikke at hans output skal knyttes til hans input. Hvis koordinatoren, eller noen annen part, klarer å etablere en kobling mellom en input og en output, mister coinjoin all interesse. Som forklart ovenfor må coinjoin fungere som et brudd i en mynts historie. Dette bruddet oppstår nettopp fordi det er umulig å knytte en spesifikk input til en spesifikk output i coinjoin-transaksjonen (prospektiv anonset) og vice versa (retrospektiv anonset).

På den andre siden har vi det offentlige aspektet: Velgeren vil være sikker på at stemmeseddelen hans er inkludert i valgurnen; på samme måte vil coinjoin-brukeren være sikker på at resultatet hans er inkludert i coinjoin-transaksjonen. Coinjoin-deltakerne må absolutt kunne verifisere at deres output er til stede før de signerer transaksjonen, ellers kan koordinatoren stjele pengene.

Det er nettopp disse to offentlige og private aspektene, som muliggjøres ved bruk av David Chaums blindsignaturer, som garanterer deltakerne i Chaumian coinjoins at bitcoinsene deres ikke blir stjålet, og at pengene deres ikke kan spores.

### Hvem oppfant coinjoin-konseptet?

Det er vanskelig å si med sikkerhet hvem som først introduserte coinjoin-ideen til Bitcoin, og hvem som kom opp med ideen om å bruke David Chaums blindsignaturer i denne sammenhengen. Det antas ofte at det var Gregory Maxwell som først nevnte det i [en melding på BitcoinTalk i 2013](https://bitcointalk.org/index.php?topic=279249.0) :

> *"Ved hjelp av Chaums blindsignaturer: Brukerne logger seg på og oppgir inndata (og utveksler adresser) samt en kryptografisk blindet versjon av adressen de ønsker å sende sine private deler til; serveren signerer symbolene og sender dem tilbake. Brukerne kobler seg anonymt til igjen, avmaskerer utdataadressene sine og sender dem tilbake til serveren. Serveren kan se at alle utdataene er signert av den, og at alle utdataene følgelig kommer fra gyldige deltakere. Senere kobler folk seg til igjen og logger seg på
Maxwell, G. (2013, 22. august). *CoinJoin: Bitcoin-personvern for den virkelige verden*. BitcoinTalk Forum. https://bitcointalk.org/index.php?topic=279249.0

![BTC204](assets/fr/124.webp)

Det finnes imidlertid andre tidligere omtaler, både for Chaum-signaturer som en del av miksing, men også for coinjoins. [I juni 2011 presenterte Duncan Townsend på BitcoinTalk (https://bitcointalk.org/index.php?topic=12751.0) en mikser som bruker Chaum-signaturer på en måte som er ganske lik moderne Chaumian coinjoins.

I samme tråd kan vi finne [en melding fra hashcoin som svar til Duncan Townsend] (https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793) for å forbedre mikseren hans. Prosessen som beskrives i denne meldingen er nøyaktig hva coinjoins handler om. Et lignende system nevnes også i [en melding fra Alex Mizrahi i 2012] (https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry), da han ga råd til skaperne av Tenebrix, en av de første altcoinsene som senere dannet grunnlaget for Litecoin. Til og med selve begrepet "coinjoin" sies ikke å ha blitt skapt av Greg Maxwell, men å ha kommet fra en idé av Peter Todd.

![BTC204](assets/fr/125.webp)

### Zerolink

Zerolink er en omfattende blandingsprotokoll som inneholder Chaumian coinjoins og ulike strategier for å beskytte brukernes anonymitet mot flere former for kjedeanalyse, særlig ved å minimere feil i forbindelse med porteføljeforvaltning. Denne protokollen [ble introdusert av nopara73 og TDevD i 2017] (https://github.com/nopara73/ZeroLink/blob/master/README.md).

![BTC204](assets/fr/126.webp)

Som navnet antyder, er prinsippet bak Zerolink å skape coinjoin-transaksjoner som sikrer at koblingene mellom inn- og utdata ikke kan spores. Dette oppnås ved å sørge for at alle utganger har helt identiske beløp.

![BTC204](assets/fr/127.webp)

Et viktig forebyggende tiltak Zerolink har iverksatt, er å holde ublandede UTXO-er helt adskilt fra blandede UTXO-er ved å bruke separate kryptografiske nøkkelsett, eller til og med separate porteføljer. Dette skiller "*pre-mix*"-lommeboken, som er beregnet på deler før blanding, fra "*post-mix*"-lommeboken, som er reservert for deler som har blitt blandet.

![BTC204](assets/fr/128.webp)

Denne strenge separasjonen av UTXO-er tjener først og fremst til å forhindre utilsiktede koblinger mellom en blandet UTXO og en ublandet UTXO. Hvis slike koblinger oppstår, blir effekten av coinjoin på den blandede UTXO-en kansellert uten at brukeren er klar over det, og dermed kompromitteres konfidensialiteten til en UTXO hvis historikk han trodde han hadde brutt. Disse koblingene kan oppstå enten gjennom gjenbruk av adresser ved sikring av en blandet UTXO med en ublandet UTXO, eller gjennom bruk av CIOH (_Common-Input-Ownership Heuristic_), hvis brukeren bruker blandede og ublandede UTXO-er som inndata i samme transaksjon. Ved å skille porteføljene før og etter blanding unngår vi slike utilsiktede assosiasjoner og beskytter brukeren mot utilsiktede feil.

![BTC204](assets/fr/129.webp)

Dette skillet gjør det også mulig å bruke forskjellige regler for pre-mix- og post-mix-porteføljer på porteføljeprogramvarenivå. I post-mixing-porteføljen kan programvaren for eksempel forby sammenslåing av UTXO-er til inndata for å forhindre bruk av CIOH, noe som ville kompromittere brukerens anonset. Det er også mulig å standardisere bruken av skript og transaksjonsalternativer (som for eksempel RBF-rapportering) for å forhindre identifisering ved hjelp av lommebokfingeravtrykk.

Whirlpool er for øyeblikket den eneste coinjoin-implementeringen som følger Zerolink-protokollen til punkt og prikke. I neste kapittel skal vi se nærmere på de ulike coinjoin-implementeringene som finnes, og fordelene og ulempene ved hver av dem.

## Coinjoin-implementeringer

<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>


*I 2024 er vi vitne til store endringer i verktøyene som er tilgjengelige for brukere som ønsker å gjøre coinjoins på Bitcoin. Vi er nå ved et vendepunkt, og coinjoin-markedet gjennomgår store omstruktureringer. Dette kapittelet vil helt sikkert bli oppdatert over tid

For øyeblikket finnes det hovedsakelig tre ulike implementeringer av coinjoin på Bitcoin:


- Whirlpool;
- Wabisabi;
- JoinMarket.

Hver av disse implementeringene har som mål å bryte UTXO-historikken ved hjelp av coinjoin-transaksjoner. Mekanismene deres varierer imidlertid betydelig. Det er derfor viktig å forstå hvordan de fungerer, slik at du kan velge det alternativet som passer best til dine behov.

### JoinMarket

JoinMarket, grunnlagt i 2015 av Adam Gibson og Chris Belcher, skiller seg klart ut fra andre coinjoin-implementeringer takket være sin unike modell for å koble sammen brukere. Systemet er basert på et P2P-byttemarked der noen brukere, "makerne", gjør bitcoinsene sine tilgjengelige for miksing, mens andre, "takerne", bruker disse kontantene til å foreta coinjoins mot et gebyr.

![BTC204](assets/fr/130.webp)

I denne modellen gjør "makers" sine bitcoins tilgjengelige for "takers" og mottar en avgift for tjenesten. De som tar bitcoins, betaler på sin side for å bruke produsentens bitcoins til å utføre sine egne coinjoin-transaksjoner. Serviceavgiftene varierer avhengig av hvilken rolle man har: "Makers" samler gebyrer for å tilby likviditet, mens "takers" betaler gebyrene. Markedet opererer fritt, uten betingelser for bruk.

En av de største ulempene med JoinMarket er at det er komplekst å bruke, og det krever en viss grad av fortrolighet med terminaler for å bruke det effektivt. Selv om denne kompleksiteten ikke er et hinder for den erfarne brukeren, kan den begrense tilgangen for allmennheten. Den nylige introduksjonen av et webgrensesnitt kalt JAM har imidlertid gjort det litt enklere å bruke.

![BTC204](assets/fr/131.webp)

Kilde: [JAM] (https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

Den tekniske barrieren er imidlertid fortsatt et stort hinder. I coinjoin-økosystemet, der konfidensialiteten forsterkes av antall deltakere, påvirker enhver begrensning som reduserer tilgjengeligheten direkte den tilgjengelige likviditeten, noe som er en avgjørende faktor for effektiviteten i miksen. Bitcoin, som allerede er en nisje innen finansielle transaksjoner, ser på bruken av coinjoins som en undernisje, og JoinMarket representerer en enda mer spesialisert del av den, noe som derfor begrenser potensialet for å øke brukernes anonsett.

Til tross for sin innovative P2P-koblingsmodell for coinjoinere har JoinMarket noen betydelige ulemper, særlig når det gjelder transaksjonsstrukturen. I motsetning til andre implementeringer, som Whirlpool, garanterer ikke JoinMarket perfekt likhet mellom utganger, og det er mulig å spore deterministiske koblinger mellom innganger og utganger. Dessuten har den ingen verktøy for å forhindre at deler som allerede er blandet sammen, blandes igjen, noe som kan gå på bekostning av konfidensialiteten som brukerne ønsker.

Selv om JoinMarket-konseptet er interessant, spesielt for dem som er interessert i et dynamisk likviditetsmarked, gjør dets strukturelle svakheter og tekniske kompleksitet det etter min mening mindre interessant for både nybegynnere og eksperter som er ute etter en coinjoin-implementering.

### Wabisabi

Wabisabi er en annen coinjoin-implementering, med en tilnærming som sentraliserer transaksjonskoordinering. Denne modellen ble utviklet av Ádám Ficsór (nopara73), Yuval Kogman, Lucas Ontivero og István András Seres i 2021, og ble integrert i Wasabi 2.0-programvaren året etter. Wabisabi er nettopp en videreutvikling av Wasabi software coinjoin-modellen som ble lansert i 2018.

![BTC204](assets/fr/132.webp)

Mot slutten av 2010-tallet tok Wasabi i bruk en helt annen struktur for coinjoin-transaksjoner enn Whirlpool. Wasabi brukte svært store coinjoin-transaksjoner som involverte dusinvis av deltakere for å øke anonsettene til deltakerne. Whirlpool valgte derimot flere små transaksjoner, slik at anonsettene kunne vokse eksponentielt for hver syklus.

Metodene for valutahåndtering skilte også de to implementasjonene fra hverandre. Med Whirlpool ble valuta ekskludert og isolert fra UTXO-er før coinjoin-sykluser takket være TX0, et konsept jeg vil forklare nærmere i neste kapittel. I Wasabi, derimot, var valuta en av utgangene fra coinjoin-transaksjonen, slik at det ble opprettholdt deterministiske koblinger mellom visse innganger og utganger.

![BTC204](assets/fr/133.webp)

Med Wabisabi har Wasabi versjon 2.0 tilpasset sin tilnærming til coinjoins til å matche Whirlpool. Selv om coinjoin-transaksjonene fortsatt er svært store, er det nå mulig å kjede flere påfølgende sykluser etter Whirlpool-modellen. Det er også lagt særlig vekt på valutakursstyring: I motsetning til Wasabi 1.0, der valutakursen var direkte knyttet til brukerens input, forsøker Wabisabi å dele opp valutakursen i flere små summer, fordelt på like store valører for alle deltakerne.

La oss illustrere dette med et forenklet eksempel med bare to brukere: Alice ønsker å blande 115 000 sats og Bob 210 000 sats. Hvis vi ser bort fra gebyrer, ville en coinjoin-transaksjon med Wasabi 1.0 ha generert 3 utganger på 100 000 sats, pluss 1 utveksling på 15 000 sats for Alice og 1 utveksling på 10 000 sats for Bob. Utbytteutgangene ville fortsatt vært knyttet til inngangene:

![BTC204](assets/fr/134.webp)

Under Wabisabi ville den samme transaksjonen ha gitt 3 utganger på 100 000 sats og 5 utganger på 5 000 sats, og dermed spredt utvekslingen slik at den ikke kunne knyttes direkte til en bestemt inngang:

![BTC204](assets/fr/135.webp)

Personlig mener jeg at Wabisabis valutahåndtering innebærer flere risikoer som kan svekke effektiviteten når det gjelder konfidensialitet:


- Når en bruker bidrar med en UTXO som er betydelig større enn de andre deltakernes, ender han uunngåelig opp med et utvekslingsbeløp som vil være knyttet til hans innsats. Dette er i strid med protokollens opprinnelige mål, som er å eliminere alle identifiserbare utvekslinger;
- Mangfoldiggjøring av valører med det formål å fragmentere børsen kan paradoksalt nok være skadelig for blandingseffektiviteten. Denne prosessen kan føre til en reduksjon i anonsets for visse utganger, ettersom de blir lettere å identifisere;
- Denne metoden genererer også UTXO-er med lav verdi, noe som utgjør et forvaltningsproblem for brukeren. Disse små UTXOene kan bli til "støv" hvis de blir for kostbare å bruke i forhold til verdien. Dette fenomenet fører til at brukeren slår sammen flere UTXO-er til inndata for fremtidige transaksjoner, eller konsoliderer dem. I begge tilfeller kan dette, på grunn av CIOH, enten redusere de oppnådde anonsettene, eller helt oppheve konfidensialitetsfordelene som ble oppnådd ved den første coinjoiningen.

I motsetning til Whirlpool, som implementerer ZeroLink-protokollen som sikrer streng separasjon mellom UTXO-er før og etter blanding, opprettholder ikke Wabisabi denne strenge separasjonen. Det har også vært problemer med gjenbruk av adresser hos enkelte Wasabi-kunder, noe som åpenbart er svært uheldig for brukeren.

I Wasabi versjon 2.0 er det innført en ny policy for myntsammenslåingsgebyrer. Fra nå av er koordinatoravgiftene satt til 0,3 % for UTXOer over 0,01 bitcoin, mens for mindre UTXOer tilbys disse avgiftene i sin helhet. I tillegg er remixer for disse mindre UTXO-ene gratis, selv om brukeren fortsatt må betale utvinningsgebyr for alle transaksjoner, inkludert remixer.

Dette står i kontrast til Whirlpools policy, der avgiftene forblir faste, uavhengig av størrelsen på de oppnådde anonsettene. Med Wasabi 2.0 må brukeren fortsatt betale utvinningsgebyr for alle transaksjoner, inkludert remixer, selv om koordinatoravgiftene frafalles for små UTXO-er.

Mens jeg skriver disse linjene, har bruken av Wabisabi blitt betydelig mer kompleks som et resultat av nylige hendelser. Etter arrestasjonen av Samourai Wallet-grunnleggerne kunngjorde zkSNACKs, selskapet som finansierer og administrerer Wasabis utvikling, at coinjoin-koordinatortjenesten ville bli avviklet 1. juni 2024. Denne koordinatoren, som ble satt opp som standard på Wasabi, var ansvarlig for det store flertallet av likviditeten.

Etter at denne hovedkoordinatoren ble avviklet, må brukerne nå koble seg til nye, uavhengige koordinatorer. Denne endringen reiser en rekke bekymringer: På den ene siden kan det hende at nye koordinatorer ikke har tilstrekkelig likviditet, noe som reduserer effektiviteten av coinjoins med tanke på konfidensialitet. På den annen side er det en risiko for å støte på en ondsinnet koordinator. Denne situasjonen medfører betydelig ny risiko for dem som ønsker å bruke Wabisabi.

Utover de tekniske problemene reiser beslutningen til zkSNACKs, selskapet bak Wasabi, om å bruke tjenestene til et strenganalyseselskap for å filtrere deltakere i coinjoins alvorlige etiske og strategiske spørsmål. Den opprinnelige tanken var å forhindre at kriminelle bruker coinjoins på Wasabi, noe som kan virke legitimt. Det er imidlertid et paradoks: å betale avgifter til en koordinator hvis primære oppgave er å styrke brukernes konfidensialitet, for så å la ham finansiere et selskap som har som mål å kompromittere den samme konfidensialiteten.

Enda mer bekymringsfullt er prinsippet om filtrering, som står i radikal kontrast til Bitcoins filosofi om å tilby et åpent, usensurert finanssystem. Selv om det kan virke berettiget å ønske å ekskludere kriminelle aktiviteter, kan denne filtreringen også ramme personer hvis handlinger, selv om de klassifiseres som ulovlige i visse sammenhenger, kan være moralsk forsvarlige eller samfunnsnyttige. Eksemplet Edward Snowden illustrerer denne todelingen på en perfekt måte: Noen regjeringer anser ham som kriminell på grunn av avsløringene hans, mens andre ser på ham som en varsler som handlet i allmennhetens interesse. Denne kompleksiteten understreker den potensielle faren ved filtrering som, selv om den er velment, til syvende og sist kan undergrave rettighetene og sikkerheten til legitime brukere. Jeg kunne også ha nevnt aktivister og journalister som forfølges under visse autoritære regimer.

Som du sikkert har forstått nå, foretrekker jeg definitivt Whirlpool-modellen for coinjoins på Bitcoin. Dette systemet skiller seg ut for sin strenghet og tilbyr overlegne garantier for konfidensialitet. Det er også det eneste som tilbyr en blanding som anses som perfekt i en matematisk sammenheng. Etter min mening representerer denne modellen fremtiden for coinjoins på Bitcoin. Jeg inviterer deg til å utforske denne modellen mer inngående i neste kapittel.

## Hvordan Whirlpool fungerer

<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>


Det som skiller Whirlpool fra andre coinjoin-metoder, er bruken av "_ZeroLink_"-transaksjoner, som sikrer at det strengt tatt ikke er noen mulig teknisk kobling mellom alle innganger og utganger. Denne perfekte miksen oppnås gjennom en struktur der hver deltaker bidrar med en identisk mengde input (med unntak av gruveavgifter), noe som genererer output av helt like mengder.

Denne restriktive tilnærmingen til input gir Whirlpools coinjoin-transaksjoner en unik egenskap: det totale fraværet av deterministiske koblinger mellom input og output. Med andre ord har hver utgang like stor sannsynlighet for å bli tilskrevet en hvilken som helst deltaker, i forhold til alle andre utganger i transaksjonen.

![BTC204](assets/fr/136.webp)

### Hvordan Whirlpool fungerer

Opprinnelig var antallet deltakere i hver Whirlpool coinjoin begrenset til 5, med 2 nye deltakere og 3 remixere (vi forklarer disse konseptene senere). Økningen i transaksjonsgebyrer i kjeden som ble observert i 2023, fikk imidlertid Samourais team til å revurdere modellen for å forbedre konfidensialiteten og samtidig redusere kostnadene. Dermed, med tanke på gebyrmarkedssituasjonen og antall deltakere, kan koordinatoren nå organisere coinjoins inkludert 6, 7 eller 8 deltakere. Disse forbedrede øktene er kjent som "Surge Cycles". Det er viktig å merke seg at uansett konfigurasjon er det alltid bare to nye deltakere i Whirlpool coinjoins.

Whirlpool-transaksjoner kjennetegnes dermed av et identisk antall innganger og utganger, som kan være :


- 5 innganger og 5 utganger ;

![BTC204](assets/fr/137.webp)


- 6 innganger og 6 utganger ;

![BTC204](assets/fr/138.webp)


- 7 innganger og 7 utganger ;

![BTC204](assets/fr/139.webp)


- 8 innganger og 8 utganger.

![BTC204](assets/fr/140.webp)

Whirlpools modell er basert på små coinjoin-transaksjoner. I motsetning til Wabisabi og JoinMarket, der robustheten til anonsets er basert på volumet av deltakere i en enkelt syklus (eller på noen få sykluser), er Whirlpool avhengig av sekvensen av flere små sykluser.

I denne modellen betaler brukerne kun avgifter når de først blir med i en pool, slik at de kan delta i en rekke remixer uten ekstra kostnader. Nye deltakere betaler utvinningsavgiftene for remixere.

For hver nye coinjoin et stykke deltar i, og for hver gang det blir blandet med andre stykker, vil anonsettene vokse eksponentielt. Målet er å dra nytte av disse gratis remiksene, som hver gang de oppstår, bidrar til å forsterke tettheten av anonsettene som er knyttet til hvert stykke som er blandet.

![BTC204](assets/fr/141.webp)

Whirlpool er designet med to viktige krav i tankene:


- Tilgjengeligheten av implementeringen på mobile enheter, gitt at Samourai Wallet først og fremst er en smarttelefonapplikasjon;
- Raske omblandingssykluser for å fremme en betydelig økning i anonsets.

Disse kravene styrte valgene Samourai Wallet-utviklerne tok da de designet Whirlpool, og førte til at de begrenset antall deltakere per syklus. For få deltakere ville ha gått på bekostning av effektiviteten ved myntfusjonering, noe som ville ha redusert anonsettene som genereres per syklus drastisk, mens for mange deltakere ville ha skapt problemer med håndteringen av mobilapplikasjoner og hemmet syklusflyten.

Endelig er det ikke nødvendig å ha et høyt antall deltakere per coinjoin på Whirlpool, siden anonsets gjøres ved akkumulering av flere coinjoin-sykluser. Det viktigste prinsippet her er at UTXO-ene til alle deltakerne er homogene, ettersom dette sikrer perfekt miksing, og dermed fullt utbytte av miksing- og remixing-syklusene.

### Coinjoin-pooler og avgifter

For at disse flere syklusene skal øke anonsettene til de blandede delene, er det nødvendig med et visst rammeverk for å begrense mengden UTXO-er som brukes. Whirlpool definerer ulike bassenger.

En pool representerer en gruppe brukere som ønsker å blande seg sammen, og som blir enige om hvor mange UTXO-er som skal brukes for å optimalisere coinjoin-prosessen og samtidig opprettholde perfekt delhomogenitet. Hver pool spesifiserer et fast UTXO-beløp, som brukeren må overholde for å kunne delta. For å kunne foreta coinjoins med Whirlpool må du velge en pool. Følgende puljer er for øyeblikket tilgjengelige:


- 0.5 bitcoins ;
- 0.05 bitcoin ;
- 0.01 bitcoin ;
- 0.001 bitcoin (= 100 000 sats).

Når du går inn i en pool med bitcoinsene dine, vil de bli delt opp for å generere UTXO-er som er helt homogene med de andre deltakerne i poolen. Hver pool har en maksimumsgrense, så for beløp som overstiger denne grensen, må du enten gjøre to separate oppføringer i samme pool, eller flytte til en annen pool med et høyere beløp:

| Pool (bitcoin) | Maksimumsbeløp per inngang (bitcoin) | Maksimumsbeløp per inngang (bitcoin)

|----------------|--------------------------------------|

| 0,5 | 35 |

| 0,05 | 3,5 |

| 0,01 | 0,7 |

| 0,001 | 0,025 |

En UTXO anses å tilhøre en pool når den er klar til å bli integrert i en coinjoin. Dette betyr imidlertid ikke at brukeren mister kontrollen over den. Som vi så i de første kapitlene i denne delen, beholder du full kontroll over nøklene dine og følgelig bitcoinsene dine gjennom de ulike blandingssyklusene. Det er dette som skiller coinjoin-teknikken fra andre sentraliserte blandingsteknikker.

For å bli med i et coinjoin-basseng må du betale en serviceavgift og en utvinningsavgift. Serviceavgiftene er faste for hvert basseng og er ment å godtgjøre teamene som er ansvarlige for Whirlpools utvikling og vedlikehold.

Serviceavgiften for bruk av Whirlpool betales kun én gang når du melder deg inn i bassenget. Når du har blitt medlem, kan du delta i et ubegrenset antall remixer uten ekstra kostnad. Her er de gjeldende faste avgiftene for hvert basseng:

| Pool (bitcoin) | Påmeldingsavgift (bitcoin) | Startavgift (bitcoin)

|----------------|---------------------------------|

| 0,5 | 0,0175 |

| 0,05 | 0,00175 |

| 0,01 | 0,0005 (50 000 sats) | 0,01 | 0,0005 (50 000 sats)

| 0,001 | 0,00005 (5 000 sats) | 0,001 | 0,00005 (5 000 sats)

Disse avgiftene fungerer i hovedsak som en inngangsbillett til det valgte bassenget, uavhengig av beløpet du legger inn i coinjoin. Så uansett om du går inn i 0.01-bassenget med nøyaktig 0.01 BTC eller 0.5 BTC, vil avgiftene forbli de samme i absolutte termer.

Før du går videre med Whirlpool coinjoins, kan brukeren velge mellom to strategier:


- Velg en mindre pool for å minimere servicekostnadene, vel vitende om at han vil få flere mindre UTXO-er i retur;
- Eller man kan velge en større pool og være villig til å betale høyere gebyrer, bare for å ende opp med et mindre antall UTXO-er med høyere verdi.

Det er generelt ikke tilrådelig å slå sammen flere blandede UTXO-er etter coinjoin-sykluser, da dette kan gå på bekostning av konfidensialiteten, særlig på grunn av heuristikken for felles inngangseierskap (CIOH: *Common-Input-Ownership-Heuristic*). Derfor kan det være fornuftig å velge en større pool, selv om det betyr at man må betale mer, for å unngå å få for mange UTXO-er med liten verdi i utdataene. Brukeren må vurdere disse avveiningene for å velge den puljen han foretrekker.

I tillegg til serviceavgiften må det også tas hensyn til utvinningsgebyret som er spesifikt for enhver Bitcoin-transaksjon. Som Whirlpool-bruker må du betale utvinningsgebyret for forberedelsestransaksjonen (`Tx0`) samt for den første coinjoin. Alle påfølgende remixer vil være gratis, takket være Whirlpools modell basert på å betale nye deltakere.

I hver Whirlpool-sammenslåing er faktisk to av brukerne blant input-brukerne nye deltakere. De andre inputene kommer fra remixere. Som et resultat bæres utvinningskostnadene for alle deltakerne i transaksjonen av disse to nykommerne, som da også kan dra nytte av gratis remikser:

![BTC204](assets/fr/142.webp)

Takket være dette gebyrsystemet skiller Whirlpool seg virkelig ut fra andre coinjoin-implementeringer, siden UTXOs anonsets ikke er proporsjonale med prisen som betales av brukeren. Som et resultat er det mulig å oppnå betydelig høyere nivåer av anonymitet ved å betale bare inngangsavgiften til bassenget og utvinningsavgiften for to transaksjoner (`Tx0` og den første blandingen).

Det er viktig å merke seg at brukeren også må betale gruveavgiftene for å ta ut UTXO-ene sine fra bassenget etter å ha fullført flere coinjoins, med mindre han har valgt alternativet `mix to`, som gir en ekstern adresse som vil motta midlene direkte ut av coinjoin, uten noen ekstra transaksjon.

### HD-porteføljekontoer

For å opprette en coinjoin via Whirlpool må lommeboken generere flere separate kontoer. Dette er prinsippet bak ZeroLink-protokollen. En konto, i sammenheng med en HD-portefølje (*Hierarchical Deterministic*), utgjør en seksjon som er helt isolert fra de andre, og denne separasjonen skjer på nivå med den tredje dybden i porteføljehierarkiet, dvs. på `xpub`-nivået.

![BTC204](assets/fr/143.webp)

En HD-lommebok kan teoretisk sett utlede opptil `2^(31)` forskjellige kontoer. Den første kontoen, som brukes som standard på alle Bitcoin-lommebøker, tilsvarer indeksen `0'.

For porteføljer tilpasset Whirlpool brukes 4 kontoer for å dekke behovene i ZeroLink-prosessen:


- **innskuddskontoen**, identifisert med indeks `0` ;
- Kontoen **dårlig bank** (eller "doxxic change"), identifisert med indeksen `2,147,483,644'` ;
- Kontoen **premix**, identifisert med indeksen "2 147 483 645";
- Kontoen **postmix**, identifisert med indeksen "2 147 483 646".

Hver av disse kontoene fyller en bestemt funksjon i coinjoin-prosessen, som vi skal se nærmere på i de følgende avsnittene.

Alle disse kontoene er knyttet til en enkelt seed, slik at brukeren kan gjenopprette tilgangen til alle sine bitcoins ved hjelp av gjenopprettingsfrasen og, der det er aktuelt, passordfrasen. Under gjenopprettingsoperasjonen må programvaren imidlertid informeres om de ulike kontoindeksene som brukes.

La oss ta en titt på de forskjellige stadiene av en Whirlpool coinjoin innenfor disse kontoene.

### TX0

Utgangspunktet for enhver Whirlpool coinjoin er **deposit**-kontoen. Dette er kontoen du automatisk bruker når du oppretter en ny Bitcoin-lommebok. Denne kontoen må krediteres med bitcoinsene du ønsker å blande.

Tx0" er det første trinnet i Whirlpools blandeprosess. Formålet er å klargjøre og utjevne UTXO-ene for sammenblandingen ved å dele dem inn i enheter som tilsvarer mengden av det valgte bassenget, for å sikre en homogen blanding. UTXO-ene som er utjevnet på denne måten, sendes deretter til **premix**-kontoen. Når det gjelder differansen som ikke kan inngå i bassenget, skilles den ut på en spesifikk konto: **dårlig bank** (eller "doxxic change").

Denne første Tx0-transaksjonen brukes også til å betale serviceavgiften til coinjoin-koordinatoren. I motsetning til de følgende trinnene er ikke denne transaksjonen samarbeidsbasert, så brukeren må bære hele kostnaden for utvinningen:

![BTC204](assets/fr/144.webp)

I dette eksemplet på en `Tx0`-transaksjon blir en input på `372 000 sats` fra vår **innskuddskonto** delt opp i flere UTXOer, som fordeler seg på følgende måte:


- Et beløp på 5 000 satser til koordinatoren for servicehonorar, tilsvarende puljeinngangen på 100 000 satser;
- 3 UTXOer klargjort for miksing, omdirigert til vår **premix**-konto og registrert hos koordinatoren. Disse UTXO-ene er utlignet til 108 000 sats hver, for å dekke utvinningskostnadene for den fremtidige første blandingen;
- Overskuddet, som ikke kan gå inn i poolen fordi det er for lite, regnes som giftig valuta. Den sendes til sin spesifikke konto. Her utgjør denne utvekslingen 40 000 sats;
- Til slutt gjenstår det "3000 satser", som ikke utgjør en produksjon, men er de gruvekostnadene som kreves for å bekrefte "Tx0".

Her er for eksempel en ekte Whirlpool Tx0 (ikke min): [edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/fr/145.webp)

### De doxiske endringene

Overskuddet som ikke kunne integreres i poolen, her tilsvarende 40 000 sats, omdirigeres til kontoen **bad bank**, også kjent som "doxxic exchange", for å sikre streng separasjon fra de andre UTXOene i porteføljen.

Denne UTXO-en er farlig for brukerens konfidensialitet, fordi den ikke bare fortsatt er knyttet til fortiden, og dermed muligens til eierens identitet, men den er også registrert som tilhørende en bruker som har gjort en coinjoin.

![BTC204](assets/fr/146.webp)

Hvis denne UTXO-en slås sammen med blandede utganger, vil sistnevnte miste all konfidensialitet som er oppnådd under coinjoin-sykluser, særlig på grunn av CIOH (*Common-Input-Ownership-Heuristic*). Hvis den slås sammen med andre doxiske endringer, risikerer brukeren å miste konfidensialiteten, siden den vil koble sammen de ulike coinjoin-syklusoppføringene. Den bør derfor behandles med forsiktighet. Vi går nærmere inn på håndteringen av disse UTXO-ene doxxic i siste del av dette kapittelet.

### Den opprinnelige miksen

Etter `Tx0` sendes de utlignede UTXO-ene til porteføljens **premix**-konto, klare til å bli introdusert i sin første coinjoin-syklus, også kjent som "initial mix". Hvis `Tx0`, som i vårt eksempel, genererer flere UTXO-er for miksing, vil hver av dem bli integrert i en separat startmiks.

På slutten av disse første blandingene vil **premix**-kontoen være tom, mens myntene våre, etter å ha betalt gruveavgiftene for denne første mynttilkoblingen, vil bli justert nøyaktig til det beløpet som er definert av det valgte bassenget. I vårt eksempel vil våre opprinnelige UTXO-er på 108 000 sats ha blitt redusert til nøyaktig 100 000 sats.

![BTC204](assets/fr/147.webp)

### Remixer

Etter den første miksen overføres UTXO-ene til **postmix**-kontoen. Denne kontoen samler UTXO-er som allerede er mikset og UTXO-er som venter på remiksing. Når Whirlpool-kunden er aktiv, er UTXO-er som befinner seg på **postmix**-kontoen, automatisk tilgjengelige for remiksing og vil bli tilfeldig valgt ut til å delta i disse nye syklusene.

Som en påminnelse er remixer 100 % gratis: ingen ekstra serviceavgifter eller utvinningsgebyrer er påkrevd. Ved å beholde UTXO-er på **postmix**-kontoen holder du derfor verdien deres intakt, og forbedrer samtidig anonsettene deres. Derfor er det viktig å la disse myntene delta i flere coinjoin-sykluser. Det koster deg absolutt ingenting, og øker anonymitetsnivået deres.

Når du bestemmer deg for å bruke blandede UTXO-er, kan du gjøre det direkte fra denne **postmix**-kontoen. Vi anbefaler at du beholder blandede UTXO-er på denne kontoen for å dra nytte av gratis remikser og for å forhindre at de forlater Whirlpool-kretsen, noe som kan redusere konfidensialiteten deres.

### Hvordan håndterer du postmixene dine?

Etter at du har kjørt coinjoin-sykluser, er den beste strategien å beholde UTXO-ene dine på **postmix**-kontoen i påvente av fremtidig bruk. Det er til og med tilrådelig å la dem remixes på ubestemt tid til du trenger å bruke dem.

Noen brukere kan vurdere å overføre sine blandede bitcoins til en lommebok sikret av en maskinvarelommebok. Dette er mulig, men det er viktig å følge Samourai Wallet sine anbefalinger nøye for ikke å kompromittere konfidensialiteten som er oppnådd.

Den vanligste feilen er å slå sammen UTXO-er. For å unngå CIOH (*Common-Input-Ownership-Heuristic*) må du unngå å kombinere blandede UTXO-er med ublandede UTXO-er i samme transaksjon. Dette krever nøye styring av UTXO-er i porteføljen, særlig når det gjelder merking.

![BTC204](assets/fr/148.webp)

Man må også være forsiktig når man konsoliderer blandede UTXO-er. Moderat konsolidering er mulig hvis de blandede UTXO-ene har betydelige anonsett, men dette vil uunngåelig redusere konfidensialiteten til delene dine. Sørg for at konsolideringene verken er for omfattende eller utføres etter et utilstrekkelig antall remikser, med fare for at det etableres koblinger mellom UTXO-ene dine før og etter sammenføyningssykluser. Hvis du er i tvil om disse manipulasjonene, er den beste fremgangsmåten å ikke konsolidere UTXO-er etter remix, men å overføre dem én etter én til maskinvarelommeboken din, og generere en ny blank adresse hver gang. Igjen, husk å merke hver UTXO du mottar.

Det er heller ikke tilrådelig å overføre postmix UTXO-er til en lommebok ved hjelp av skript som ikke er mye brukt. Hvis du for eksempel går inn i Whirlpool fra en multisig-lommebok ved hjelp av `P2WSH`-skript, er det liten sjanse for at du vil bli blandet med andre brukere som opprinnelig hadde samme type lommebok. Hvis du blander postmixene dine på nytt til den samme multisig-lommeboken, vil konfidensialitetsnivået til de blandede bitcoinsene dine bli kraftig redusert. Utover skript finnes det mange andre lommebokfingeravtrykk som kan lure deg.

Som med alle Bitcoin-transaksjoner er det også viktig å ikke gjenbruke mottakeradressen. Hver nye transaksjon må mottas på en ny, tom adresse.

Den enkleste og tryggeste løsningen er å la de blandede UTXO-ene ligge i ro på **postmix**-kontoen deres, la dem remixes og bare røre dem for å bruke dem. Samurai- og Sparrow-lommebøker har ekstra beskyttelse mot alle disse risikoene ved kjedeanalyse. Denne beskyttelsen hjelper deg med å unngå å gjøre feil.

### Hvordan håndterer du giftige utvekslinger?

Deretter må du være forsiktig med håndteringen av doxxic exchange, utvekslingen som ikke kom med i coinjoin-poolen. Disse giftige UTXO-ene, som er et resultat av bruken av Whirlpool, utgjør en risiko for personvernet ditt, siden de etablerer en kobling mellom deg og coinjoin-brukeren. Det er derfor viktig å håndtere dem med forsiktighet og ikke kombinere dem med andre UTXO-er, spesielt ikke blandede UTXO-er.

Her er noen strategier for hvordan du kan bruke dem:


- Bland dem i mindre bassenger:** Hvis den giftige UTXO-en din er stor nok til å passe inn i et mindre basseng alene, bør du vurdere å blande den. Dette er ofte det beste alternativet. Det er imidlertid ikke tilrådelig å slå sammen flere giftige UTXO-er for å få tilgang til et basseng, da dette kan koble sammen de ulike oppføringene dine;
- Merk dem som "ikke brukbare":** En annen måte å gjøre det på er å slutte å bruke dem, merke dem som "ikke brukbare" på den dedikerte kontoen deres og bare hodle. Dette sikrer at du ikke bruker dem ved et uhell. Hvis verdien av bitcoin stiger, kan det dukke opp nye bassenger som passer bedre til dine giftige UTXO-er;
- Gi donasjoner:** Vurder å gi donasjoner, selv om de er beskjedne, til utviklere som jobber med Bitcoin og relatert programvare. Du kan også donere til foreninger som aksepterer BTC. Hvis det virker for komplisert å administrere giftige UTXO-er, kan du bare kvitte deg med dem og gi en donasjon;
- Kjøp gavekort:** Plattformer som [Bitrefill] (https://www.bitrefill.com/) lar deg veksle bitcoins til gavekort som kan brukes hos ulike forhandlere. Dette kan være en måte å skille seg av med giftige UTXO-er uten å miste den tilhørende verdien;
- Konsolider dem på Monero:** Samourai Wallet tilbyr en atombyttetjeneste mellom BTC og XMR. Dette er ideelt for å håndtere giftige UTXO-er ved å konsolidere dem på Monero, uten å gå på kompromiss med konfidensialiteten din via CIOH, før du sender dem tilbake til Bitcoin. Dette alternativet kan imidlertid være kostbart når det gjelder gruveavgifter og premie på grunn av likviditetsbegrensninger;
- Send dem til Lightning Network:** Det kan være et attraktivt alternativ å overføre disse UTXO-ene til Lightning Network for å dra nytte av reduserte transaksjonsgebyrer. Denne metoden kan imidlertid avsløre visse opplysninger avhengig av hvordan du bruker Lightning, og bør derfor brukes med forsiktighet.

### Hvordan bruker jeg Whirlpool?

Etter arrestasjonen av grunnleggerne av Samourai Wallet og beslagleggelsen av serverne deres den 24. april 2024, fungerer ikke Whirlpool-verktøyet lenger, selv ikke for de med egen Dojo. Tidligere var det tilgjengelig på Samourai Wallet og Sparrow Wallet.

![BTC204](assets/fr/149.webp)

Det er imidlertid fortsatt mulig at dette verktøyet vil bli reaktivert i løpet av de kommende ukene, avhengig av utfallet av forsøkene, eller relansert på en annen måte. Uansett tror jeg ikke Bitcoin coinjoin-markedet vil være uten tilbud lenge, ettersom etterspørselen er der. Siden Whirlpools modell er den mest avanserte når det gjelder konfidensialitet, vil den helt sikkert være den foretrukne modellen for andre implementeringer i fremtiden.

Vi følger nøye med på denne saken og utviklingen i de tilhørende verktøyene. Du kan være trygg på at vi kommer til å oppdatere dette kurset etter hvert som ny informasjon blir tilgjengelig.

I neste kapittel skal vi finne ut hva "anonsets" er, hvordan disse indikatorene beregnes, og hvordan de kan hjelpe oss med å estimere effektiviteten til coinjoin-sykluser.

https://planb.network/tutorials/privacy/on-chain/coinjoin-sparrow-wallet-84def86d-faf5-4589-807a-83be60720c8b

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef

https://planb.network/tutorials/privacy/on-chain/coinjoin-dojo-c4b20263-5b30-4c74-ae59-dc8d0f8715c2

## Anonymitetssett

<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>


Etter å ha studert hvordan coinjoins fungerer og hva som skal til for å oppnå effektiv miksing, skal vi nå finne ut hvordan vi kan måle effektiviteten. Hvordan kan vi avgjøre om en coinjoining-prosess har vært effektiv, og hvilken grad av anonymitet en del har oppnådd? Det skal vi finne ut av i dette kapittelet ved hjelp av anonymitetssett eller "anonsett".

### En påminnelse om nytten av coinjoin

Nytten av coinjoin ligger i dens evne til å skape plausibel benektelse, ved å legge inn din del i en gruppe av deler som ikke kan skilles fra hverandre. Målet med denne handlingen er å bryte sporbarheten, både fra fortid til nåtid og fra nåtid til fortid.

Med andre ord, en analytiker som kjenner din opprinnelige transaksjon (`Tx0`) ved inngangen til coinjoin-sykluser, skal ikke med sikkerhet kunne identifisere UTXO ved utgangen av remix-sykluser (analyse av syklusinngang til syklusutgang).

![BTC204](assets/fr/150.webp)

Omvendt må en analytiker som kjenner UTXO ved utgangen av coinjoin-sykluser, være ute av stand til å fastslå den opprinnelige transaksjonen ved inngangen av syklusene (analyse av syklusutgang til syklusinngang).

![BTC204](assets/fr/151.webp)

For å vurdere hvor vanskelig det er for en analytiker å knytte fortiden til nåtiden og omvendt, må vi kvantifisere størrelsen på gruppene av homogene deler som din del er skjult innenfor. Dette målet forteller oss hvor mange analyser som har samme sannsynlighet. Så hvis den riktige analysen drukner blant tre andre analyser med samme sannsynlighet, er skjulingsgraden din svært lav. Hvis den riktige analysen derimot finnes blant 20 000 like sannsynlige analyser, er din del svært godt skjult. Størrelsen på disse gruppene representerer indikatorer kjent som "anonsets".

### Forståelse av anonsett

Anonsett brukes som indikatorer for å vurdere graden av konfidensialitet for en bestemt UTXO. Mer spesifikt måler de antallet UTXOer som ikke kan skilles fra hverandre i settet som omfatter den delen som studeres. Kravet om et homogent sett med UTXOer betyr at anonsett vanligvis beregnes på coinjoin-sykluser. Bruken av disse indikatorene er spesielt relevant for Whirlpool-sammenføyninger, på grunn av deres ensartethet.

Om nødvendig kan anonsett brukes til å bedømme kvaliteten på sammenføyninger. Et stort anonset betyr høy grad av anonymitet, ettersom det blir vanskelig å skille ut en bestemt UTXO i det homogene settet.

det finnes 2 typer anonsett:


- Den potensielle anonset ;**
- Retrospektiv anonset.**

### Den potensielle anonset

Den fremadskuende anonset indikerer størrelsen på gruppen som UTXO-en som studeres ved slutten av syklusen er skjult i, gitt UTXO-en ved starten, dvs. antallet deler som ikke kan skilles fra hverandre i denne gruppen. Navnet på denne indikatoren er "fremtidsrettet metrikk".

Denne indikatoren måler hvor motstandsdyktig rommets konfidensialitet er mot en fortid-til-nåtid-analyse (input-til-output).

![BTC204](assets/fr/152.webp)

Denne beregningen brukes til å estimere i hvilken grad UTXO-en er beskyttet mot forsøk på å rekonstruere historikken fra inngangspunktet til utgangspunktet i coinjoin-prosessen.

Hvis transaksjonen din for eksempel har deltatt i sin første coinjoin-syklus og ytterligere to synkende sykluser har blitt fullført, vil din mynts potensielle anonset være `13` :

![BTC204](assets/fr/153.webp)

La oss for eksempel tenke oss at mynten vår i starten av coinjoin-syklusen har en potensiell anonset på `86,871`. I praksis betyr dette at den er skjult blant `86 871` deler som ikke kan skilles fra hverandre. For en utenforstående observatør som kjenner denne mynten ved starten av coinjoin-syklusen og prøver å spore dens exit, vil han bli konfrontert med `86 871` mulige UTXO-er, hver med identisk sannsynlighet for å være mynten han leter etter.

![BTC204](assets/fr/154.webp)

### Den retrospektive anonset

Den retrospektive anonset-indikatoren angir antall mulige kilder for en gitt del, når man kjenner UTXO ved slutten av syklusen. Denne indikatoren måler hvor motstandsdyktig delens konfidensialitet er mot en nåtid-til-fortid-analyse (utgang-til-inngang), dvs. hvor vanskelig det er for en analytiker å spore delen tilbake til dens opprinnelse, før sammenføyningssyklusene. Navnet på denne indikatoren er "backward anonset", eller "bakoverskuende metrikk".

![BTC204](assets/fr/155.webp)

Ved å kjenne UTXO ved utgangen av syklusene, bestemmer den retrospektive anonset antallet potensielle Tx0-transaksjoner som kunne ha utgjort din inngang i coinjoin-syklusene. I diagrammet nedenfor tilsvarer dette summen av alle de oransje boblene.

![BTC204](assets/fr/156.webp)

La oss for eksempel tenke oss at coinjoin-delen vår har en retrospektiv anonset på `42,185`. I praksis betyr dette at det finnes `42 185` potensielle kilder til denne UTXO-en. Hvis en ekstern observatør identifiserer denne mynten på slutten av syklusene og forsøker å spore opprinnelsen, vil han eller hun stå overfor `42 185` mulige kilder, alle med like stor sannsynlighet for å være opprinnelsen som søkes.

![BTC204](assets/fr/157.webp)

### Hvordan beregner du anonsets?

Det er mulig å beregne anonsett manuelt ved hjelp av en blokkutforsker for små ensembler. For større anonsett er det imidlertid nødvendig å bruke et spesialisert verktøy. Så vidt jeg vet, er den eneste programvaren som kan utføre denne oppgaven *Whirlpool Stats Tool*, et Python-verktøy utviklet av Samourai- og OXT-teamene. Dessverre er dette verktøyet for øyeblikket ute av drift etter arrestasjonen av Samourais grunnleggere og avbruddet av OXT, som ble brukt til å hente ut data fra blokkjeden.

![BTC204](assets/fr/158.webp)

Som vi har sett i dette kapittelet, kan anonsets bare beregnes hvis det er en viss homogenitet i coinjoin-strukturen. I neste kapittel skal vi finne ut hvordan vi kan kvantifisere denne homogeniteten i en Bitcoin-transaksjon, enten det er en coinjoin eller en mer tradisjonell transaksjon.

https://planb.network/tutorials/privacy/analysis/wst-anonsets-0354b793-c301-48af-af75-f87569756375

## Entropi

<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>


Som vi har sett i denne delen om coinjoins, spiller homogeniteten til UTXO-er i input og output en viktig rolle i å forbedre konfidensialiteten til en Bitcoin-transaksjon. Denne parameteren skaper en plausibel benektbarhet i møte med blokkjedeanalyse. Flere metoder kan brukes til å måle denne homogeniteten, men en av de mest effektive, etter min mening, er bruken av indikatorene som tilbys av * Boltzmann * -verktøyet, utviklet av OXT- og Samourai Wallet-teamene, og spesielt entropien til transaksjonen. Det er dette vi skal se nærmere på i dette kapittelet.

I motsetning til anonsets, som beregnes ut fra et sett med transaksjoner, fokuserer indikatorene som presenteres her på én enkelt transaksjon, enten det er en coinjoin eller en mer tradisjonell transaksjon.

### Antall tolkninger

Den første indikatoren som kan observeres på en Bitcoin-transaksjon, er det totale antallet mulige tolkninger som står overfor en analyse fra en utenforstående observatør. Ved å ta hensyn til verdiene til UTXO-ene som er involvert i transaksjonen, viser denne indikatoren antall måter innganger kan knyttes til utganger på. Med andre ord bestemmer den hvor mange mulige tolkninger en transaksjon kan fremkalle i bitcoinstrømmer sett fra en utenforstående observatørs ståsted.

For eksempel vil en enkel betalingstransaksjon med 1 inngang og 2 utganger bare ha én tolkning, nemlig at inngang #0 finansierte utgang #0 og utgang #1. Det finnes ingen andre mulige tolkninger:

![BTC204](assets/fr/159.webp)

På den annen side har et Whirlpool 5x5-hjørne 1 496 $ mulige kombinasjoner:

![BTC204](assets/fr/160.webp)

En Whirlpool Surge Cycle 8x8 coinjoin har $9\,934\,563$ mulige tolkninger:

![BTC204](assets/fr/161.webp)

### Entropi

Ut fra antall tolkninger av en Bitcoin-transaksjon kan vi beregne dens entropi.

I en generell sammenheng med kryptografi og informasjon er entropi et kvantitativt mål på usikkerheten eller uforutsigbarheten knyttet til en datakilde eller tilfeldig prosess. Med andre ord er entropi en måte å måle hvor vanskelig det er å forutsi eller gjette seg frem til et stykke informasjon.

I blokkjedeanalysesammenheng er entropi også navnet på en indikator, avledet fra Shannons entropi og [oppfunnet av LaurentMT] (https://gist.github.com/LaurentMT/e758767ca4038ac40aaf), som kan beregnes på en Bitcoin-transaksjon.

Når en transaksjon har et stort antall mulige tolkninger, er det ofte mer relevant å se på dens entropi. Denne indikatoren måler analytikernes mangel på kunnskap om den nøyaktige konfigurasjonen av transaksjonen. Med andre ord, jo høyere entropien er, desto vanskeligere blir det for analytikerne å identifisere flyten av bitcoins mellom inn- og utganger.

I praksis avslører entropien om en transaksjon, sett fra en ekstern observatørs synspunkt, gir flere mulige tolkninger, utelukkende basert på inn- og utdatamengder, uten å ta hensyn til andre eksterne eller interne mønstre og heuristikker. En høy entropi er derfor ensbetydende med større konfidensialitet for transaksjonen.

Entropi er definert som den binære logaritmen til antall mulige kombinasjoner. Her er formelen som brukes med $E$ entropien til transaksjonen og $C$ antall mulige tolkninger:

$$
E = \log_2(C)
$$

I matematikken er den binære logaritmen (base-2-logaritmen) den inverse operasjonen av eksponentiering av 2. Med andre ord er den binære logaritmen til $x$ eksponenten som $2$ må heves til for å få $x$. Denne indikatoren uttrykkes derfor i bits.

La oss ta et eksempel på beregning av entropi for en coinjoin-transaksjon strukturert i henhold til Whirlpool 5x5-modellen, som, som nevnt i forrige avsnitt, har et antall mulige tolkninger på $1\,496$ :

$$
\begin{align*}
C &= 1\,496 \\
E &= \log_2(1\,496) \\
E &= 10.5469 \text{ bits}
\end{align*}
$$

Denne coinjoin-transaksjonen har dermed en entropi på $10,5469$ bits, noe som anses som svært tilfredsstillende. Jo høyere denne verdien er, jo flere ulike tolkninger kan transaksjonen tillate, noe som styrker konfidensialitetsnivået.

For en coinjoin 8x8-transaksjon med $9\,934\,563$ tolkninger, vil entropien være :

$$
\begin{align*}
C &= 9\,934\,563 \\
E &= \log_2(9\,934\,563) \\
E &= 23.244 \text{ bits}
\end{align*}
$$

La oss ta et annet eksempel med en klassisk betalingstransaksjon, med 1 inngang og 2 utganger: [1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/fr/162.webp)

I tilfellet med denne transaksjonen er den eneste mulige tolkningen: `(In.0) > (Out.0 ; Out.1)`. Følgelig er entropien $0$ :

$$
\begin{align*}
C &= 1 \\
E &= \log_2(1) \\
E &= 0 \text{ bits}
\end{align*}
$$

### Effektivitet

Basert på transaksjonens entropi kan vi også beregne dens effektivitet når det gjelder konfidensialitet. Denne indikatoren evaluerer effektiviteten til transaksjonen ved å sammenligne den med den optimale transaksjonen som kan tenkes i en identisk konfigurasjon.

Dette bringer oss til begrepet maksimal entropi, som tilsvarer den høyeste entropien som en spesifikk transaksjonsstruktur teoretisk sett kan oppnå. Transaksjonseffektiviteten beregnes deretter ved å sammenligne denne maksimale entropien med den faktiske entropien til transaksjonen som analyseres.

Formelen som brukes er som følger med :


- e_R$: Transaksjonens faktiske entropi uttrykt i bits;
- e_M$: den maksimale mulige entropien for en transaksjonsstruktur, også uttrykt i bits;
- $Ef$: transaksjonseffektivitet i bits :

$$
Ef = E_R - E_M
$$

For eksempel er den maksimale entropien for en Whirlpool 5x5 coinjoin-struktur $10,5469$ :

$$
\begin{align*}
E_R &= 10.5469 \\
E_M &= 10.5469 \\
Ef &= E_R - E_M \\
Ef &= 10.5469 - 10.5469 \\
Ef &= 0 \text{ bits}
\end{align*}
$$

Denne indikatoren uttrykkes også i prosent. Formelen som brukes er som følger: :


- c_R$ : antall mulige reelle tolkninger ;
- c_M$: det maksimale antallet mulige tolkninger av samme struktur;
- $Ef$: effektivitet uttrykt i prosent:

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1\,496}{1\,496} \\
E_f &= 100 \%
\end{align*}
$$

En effektivitet på 100 dollar indikerer at transaksjonen utnytter konfidensialitetspotensialet best mulig, avhengig av strukturen.

### Entropitetthet

Entropi er en god indikator for å måle konfidensialiteten til en transaksjon, men den avhenger delvis av antall innganger og utganger i transaksjonen. For å sammenligne entropien til to ulike transaksjoner med ulikt antall inn- og utdata kan vi beregne entropitettheten. Denne indikatoren gir et perspektiv på entropien i forhold til hver inngang eller utgang i transaksjonen. Tettheten er nyttig for å evaluere og sammenligne effektiviteten til transaksjoner av ulik størrelse.

For å beregne den dividerer vi ganske enkelt transaksjonens totale entropi med det totale antallet inn- og utganger som er involvert i transaksjonen:


- e_D$: entropitetthet uttrykt i bits;
- e$: Transaksjonens entropi uttrykt i bits;
- t$: totalt antall innganger og utganger i transaksjonen:

$$
E_D = \frac{E}{T}
$$

La oss ta et eksempel med en Whirlpool 5x5 coinjoin:

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ bits}
\end{align*}
$$

La oss også beregne entropitettheten til en 8x8 Whirlpool coinjoin:

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
E_D &= 1.453 \text{ bits}
\end{align*}
$$

Ved å analysere entropitettheten til disse to typene sammenføyninger blir det tydelig at selv når entropien normaliseres etter antall elementer, genererer "Surge Cycle 8x8"-samføyningen større usikkerhet for analysen.

### Boltzmann-poengsummen

En annen del av informasjonen som analyseres i en transaksjon, er Boltzmann-poengsummen for hvert element i forhold til et annet. Dette er en tabell over sannsynligheten for samsvar mellom inndata og utdata. Gjennom Boltzmann-poengsummen angir denne tabellen den betingede sannsynligheten for at en bestemt input er knyttet til en gitt output. Det er derfor et kvantitativt mål på den betingede sannsynligheten for at en kobling mellom en input og en output i en transaksjon vil inntreffe, basert på forholdet mellom antallet gunstige forekomster av denne hendelsen og det totale antallet mulige forekomster i et sett med tolkninger.

Hvis vi bruker eksemplet med en Whirlpool coinjoin, vil den betingede sannsynlighetstabellen fremheve sjansene for en kobling mellom hver inngang og utgang, noe som gir et kvantitativt mål på tvetydigheten i assosiasjonene i transaksjonen:



| ------- | -------- | -------- | -------- | -------- | -------- |

| Input 0 | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% |

| 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % Input 1

| Input 2 | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34

| 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % 34 % Input 3

| Input 4 | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34% | 34

Det er klart at hver inngang har like stor sjanse for å bli assosiert med en hvilken som helst utgang, noe som styrker transaksjonens konfidensialitet.

Boltzmann-poengsummen beregnes ved å dividere antallet tolkninger der en bestemt hendelse forekommer, med det totale antallet tilgjengelige tolkninger. For å finne poengsummen som knytter inngang #0 til utgang #3 (hendelse som forekommer i 512$ tolkninger), går vi frem på følgende måte:

$$
\begin{align*}
\text{Interpretations (IN.0 > OUT.3)} &= 512 \\
\text{Interpretations totales} &= 1496 \\
\text{Score} &= \frac{512}{1496} \\
\text{Score} &= 34 \%
\end{align*}
$$

Hvis vi tar et eksempel med en Whirlpool 8x8 Surge Cycle coinjoin, vil Boltzmann-tabellen se slik ut:

| UT.0 | UT.1 | UT.2 | UT.3 | UT.4 | UT.5 | UT.6 | UT.7 |

|-------|-------|-------|-------|-------|-------|-------|-------|-------|

| IN.0 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| IN.1 | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23

| IN.2 | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23

| IN.3 | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23

| IN.4 | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23

| IN.5 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

| IN.6 | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23

| IN.7 | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23 % | 23

Når det gjelder en enkel transaksjon med én inngang og to utganger, er situasjonen imidlertid en annen:

| Utgang 0 | Utgang 1 |

|---------|----------|----------|

| Input 0 | 100 % | 100 % | 100 % | 100

Her ser vi at sannsynligheten for at hver utgang stammer fra inngang nr. 0 er 100 %. En lavere sannsynlighet gjenspeiler dermed større konfidensialitet, noe som utvanner de direkte koblingene mellom inndata og utdata.

### Deterministiske koblinger

Vi kan også beregne antall deterministiske koblinger i en transaksjon. Denne indikatoren viser hvor mange av koblingene mellom innganger og utganger i den analyserte transaksjonen som er ubestridelige, med en sannsynlighet på 100 %. Denne indikatoren kan deretter kompletteres ved å beregne forholdet mellom deterministiske koblinger. Forholdstallet gir et perspektiv på vekten av disse deterministiske koblingene i forhold til transaksjonens totale antall koblinger.

For eksempel har en Whirlpool coinjoin-transaksjon ingen deterministiske koblinger mellom inn- og utdata, og viser derfor en indikator på 0 koblinger og et forholdstall på 0 %. I den andre enkle betalingstransaksjonen vi har undersøkt (med én inngang og to utganger), viser indikatoren derimot at det er to deterministiske koblinger, og forholdstallet er 100 %. En indikator på null indikerer med andre ord utmerket konfidensialitet, takket være fraværet av direkte og udiskutable koblinger mellom inn- og utdata.

### Hvordan beregner du disse indikatorene?

Det er relativt enkelt å beregne disse indikatorene manuelt ved hjelp av ligningene jeg har oppgitt. Vanskeligheten ligger hovedsakelig i å bestemme antall mulige tolkninger av en transaksjon. For en klassisk transaksjon kan denne beregningen gjøres for hånd. For en coinjoin er oppgaven imidlertid langt mer kompleks.

Tidligere var det et Python-verktøy kalt _Boltzmann Calculator_, utviklet av OXT- og Samourai-teamene, som automatisk beregnet alle disse indikatorene for en Bitcoin-transaksjon :

![BTC204](assets/fr/163.webp)

Det var også mulig å bruke nettstedet KYCP.org til disse analysene:

![BTC204](assets/fr/164.webp)

Etter at Samourais grunnleggere ble arrestert, er disse verktøyene dessverre ikke lenger operative.

Nå som vi har dekket coinjoins i detalj, skal vi se på de andre personvernteknikkene som er tilgjengelige på Bitcoin i den siste delen av kurset vårt. Vi skal se på payjoins, spesifikke transaksjonstyper for pseudocoinjoins, statiske adresseprotokoller, samt tiltak for å styrke konfidensialiteten, ikke på transaksjonsnivå, men på nettverksnivå.

https://planb.network/tutorials/privacy/analysis/boltzmann-entropy-738e45af-18a6-4ce6-af1a-1bf58e15f1fe

# Forstå utfordringene med andre avanserte konfidensialitetsteknikker

<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## Payjoin-transaksjoner

<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>


Coinjoin er per i dag den mest effektive metoden for å innføre usikkerhet i sporingen av deler i en kjedeanalyse. Som vi har sett i tidligere kapitler, må inn- og utdata være så homogene som mulig for å oppnå en miks med høy ytelse. I tillegg er det viktig at delene integreres i en så stor gruppe som mulig for å maksimere anonsettene. For at sammenføyninger skal være effektive, må de involvere et stort antall ensartede deler. Dette mangfoldet av krav betyr at coinjoin-transaksjoner har en svært rigid struktur: Beløpene er fastsatt på forhånd, og alle deltakerne må forholde seg til dem for å garantere ensartethet i prosessen. I tillegg krever coinjoins synkronisering mellom alle deltakerne og koordinatoren under transaksjonskonstruksjonen.

Disse kravene gjør coinjoin uegnet for direkte betalinger. Hvis du for eksempel har en satsmynt på 1 million i en coinjoin-pool, vil det være komplisert å bruke den direkte som betaling. Det ville kreve synkronisering med de andre deltakerne og koordinatoren for å bygge samarbeidstransaksjonen akkurat i det øyeblikket du trenger å foreta en betaling, og kjøpsbeløpet måtte tilsvare nøyaktig verdien av mynten din, noe som er praktisk talt ugjennomførbart. Coinjoin-transaksjonen er derfor i sin natur en samarbeidstransaksjon, dvs. at det vanligvis er de samme eierne av inndataene som vi finner i utdataene.

Det ville imidlertid være interessant å ha transaksjonsstrukturer som gjør det mulig å gjennomføre betalinger på en praktisk måte, samtidig som man innfører tvil i kjedeanalysen. Det er nettopp dette vi skal se nærmere på i dette og neste kapittel.

### Hva er en payjoin-transaksjon?

Payjoin er en spesifikk Bitcoin-transaksjonsstruktur som forbedrer brukernes personvern når de bruker penger ved å samarbeide med betalingsmottakeren.

Det var i 2015 at LaurentMT først omtalte denne metoden under navnet "*steganographic transactions*", ifølge et dokument tilgjengelig [her](https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt). Denne teknikken ble senere tatt i bruk av lommeboken Samourai Wallet, som i 2018 ble den første klienten til å implementere den ved hjelp av verktøyet Stowaway. Konseptet payjoin finnes også i [BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki), [BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki) og [BIP77](https://payjoin.org/docs/how-it-works/payjoin-v2-bip-77/). Flere begreper brukes dermed for å referere til en payjoin:

- Payjoin ;
- Blindpassasjer;
- P2EP (*Pay-to-End-Point*) ;
- Steganografisk transaksjon.

Det spesielle med payjoin er at den kan generere en transaksjon som ved første øyekast ser helt vanlig ut, men som i virkeligheten er en mini Coinjoin mellom to personer. For å oppnå dette involverer transaksjonsstrukturen betalingsmottakeren i inndataene ved siden av den faktiske avsenderen. Mottakeren inkluderer dermed en betaling til seg selv midt i transaksjonen, noe som i seg selv gjør det mulig for ham å få betalt.

La oss ta et eksempel for å forstå denne prosessen bedre. Alice kjøper en baguette for 4 000 satser ved hjelp av en UTXO på 10 000 satser og velger en payjoin. Bakeren hennes, Bob, legger til en UTXO på 15 000 satser som tilhører ham som input, som han får tilbake i sin helhet som output, i tillegg til Alices 4 000 satser.

![BTC204](assets/fr/165.webp)

I dette eksempelet går baker Bob inn med 15 000 sats og går ut med 19 000 sats, og differansen er nøyaktig 4 000 sats, dvs. prisen på baguetten. Alice på sin side går inn med 10 000 sats og ender opp med 6 000 sats i output, noe som tilsvarer en balanse på -4 000 sats, dvs. prisen på baguetten. For å forenkle eksemplet har jeg bevisst utelatt gruvekostnadene i denne transaksjonen.

### Hva er payjoin til?

Payjoin-transaksjonen oppfyller to mål, og gjør det mulig for brukerne å forbedre konfidensialiteten ved betalingen.

For det første har payjoin som mål å villede en utenforstående observatør ved å skape et lokkemiddel i kjedeanalysen. Dette gjøres mulig ved hjelp av CIOH-heuristikken (*Common Input Ownership Heuristic*). Som vi så i del 3, antas det vanligvis at når en transaksjon i blokkjeden har flere innganger, tilhører alle disse inngangene samme enhet eller bruker.

Når en analytiker undersøker en payjoin-transaksjon, forledes han eller hun til å tro at alle inndataene kommer fra samme person. Denne oppfatningen er imidlertid feil, fordi betalingsmottakeren også bidrar til inndataene ved siden av den faktiske betaleren. Kjedeanalysen blir derfor avledet mot en tolkning som viser seg å være feil.

La oss ta eksemplet vårt med en payjoin-transaksjon for betaling av en baguette:

![BTC204](assets/fr/166.webp)

Når en utenforstående observatør ser denne transaksjonen på blokkjeden, vil han eller hun følge de vanlige heuristikkene for blokkjedeanalyse og gjøre følgende tolkning: "*Alice fusjonerte 2 UTXO-er som input til transaksjonen for å betale 19 000 sats til Bob*".

![BTC204](assets/fr/167.webp)

Denne tolkningen er åpenbart feil, for som du allerede vet, tilhører ikke de to UTXO-ene i inndataene samme person. Den ene kommer fra Alice, baguettekjøperen, og den andre fra Bob, bakeren.

![BTC204](assets/fr/168.webp)

På denne måten styres den eksterne observatørens analyse mot en feilaktig konklusjon, slik at interessentenes konfidensialitet ivaretas.

### Den steganografiske transaksjonen

Det andre formålet med payjoin er å villede en utenforstående observatør om det faktiske beløpet som er betalt. Ved å undersøke strukturen i transaksjonen kan analytikeren tro at betalingen tilsvarer beløpet til en av utbetalingene.

Hvis vi går tilbake til vårt eksempel med kjøp av en baguette, vil analytikeren tro at betalingsbeløpet tilsvarer enten UTXO på 6 000 sats eller UTXO på 19 000 sats. I dette tilfellet vil analytikeren heller tro at betalingsbeløpet er 19 000 sats, fordi det er to UTXO-er i utgangene, hvorav minst én er større enn 6 000 sats (det er ingen logisk grunn til å bruke to UTXO-er for å betale 6 000 sats når én enkelt UTXO ville ha vært tilstrekkelig for å oppfylle denne betalingen).

![BTC204](assets/fr/169.webp)

Men i virkeligheten er denne analysen feil. Betalingsbeløpet tilsvarer ikke noen av produksjonene. Det er faktisk differansen mellom mottakerens UTXO i output og mottakerens UTXO i input.

![BTC204](assets/fr/170.webp)

I så måte faller payjoin-transaksjonen inn under steganografi. Den gjør det mulig å skjule det virkelige transaksjonsbeløpet i en falsk transaksjon som fungerer som en lokkedue.

Steganografi er en teknikk for å skjule informasjon i andre data eller objekter, slik at den skjulte informasjonen ikke er synlig. For eksempel kan en hemmelig melding skjules i en prikk i en urelatert tekst, slik at den ikke kan oppdages med det blotte øye (dette er [microdot]-teknikken (https://fr.wikipedia.org/wiki/Micropoint)).

I motsetning til kryptering, som gjør informasjonen uforståelig uten dekrypteringsnøkkelen, endrer ikke steganografi informasjonen. Den vises fortsatt i klartekst. Målet er snarere å skjule selve eksistensen av det hemmelige budskapet, mens kryptering tydelig avslører tilstedeværelsen av skjult informasjon, selv om den er utilgjengelig uten nøkkelen. Dette er grunnen til at det opprinnelige navnet på payjoin var "steganografiske transaksjoner".

Man kan trekke en analogi mellom kryptografi og coinjoin, og mellom steganografi og payjoin. Coinjoin har lignende egenskaper som kryptering: metoden er gjenkjennelig, men informasjonen er ikke mulig å tyde. Payjoin ligner på steganografi: Informasjonen er teoretisk sett tilgjengelig, men siden metoden for å skjule den ikke er gjenkjennelig, blir den utilgjengelig.

### Hvordan bruker jeg payjoin?

Kjente programmer som støtter payjoin inkluderer Sparrow Wallet, Wasabi Wallet, Mutiny, BitMask, BlueWallet og JoinMarket, samt betalingsbehandleren BTCPay.

![BTC204](assets/fr/171.webp)

Den mest avanserte payjoin-implementeringen var bare Stowaway på Samourai Wallet. Siden arrestasjonen av programvarens grunnleggere er dette verktøyet nå bare delvis funksjonelt. Fordelen med Stowaway er at det er en omfattende, brukervennlig protokoll som støtter både mottak og sending av payjoins. Delvis signerte transaksjoner kan utveksles manuelt ved å skanne flere QR-koder, eller automatisk via Tor via Soroban. Sistnevnte kommunikasjonsalternativ er for tiden ute av drift.

![BTC204](assets/fr/172.webp)

Vanskeligheten med å bruke payjoin ligger i at det er avhengig av at forhandleren deltar. Som kunde kan du ikke bruke payjoin hvis forhandleren ikke støtter det. Dette gjør kjøpsprosessen enda vanskeligere: Ikke bare er det vanskelig å finne forhandlere som aksepterer bitcoin, men hvis du i tillegg leter etter dem som støtter payjoin, blir det enda mer komplisert.

En løsning kan være å bruke transaksjonsstrukturer som introduserer tvetydighet i kjedeanalysen uten å kreve medvirkning fra mottakeren. På den måten kan vi forbedre konfidensialiteten i betalingene våre uten å være avhengige av aktiv medvirkning fra forhandlerne. Det er nettopp dette vi skal se nærmere på i neste kapittel.

https://planb.network/tutorials/privacy/on-chain/payjoin-sparrow-wallet-087a0e49-61cd-41f5-8440-ac7b157bdd62

https://planb.network/tutorials/privacy/on-chain/payjoin-samourai-wallet-48a5c711-ee3d-44db-b812-c55913080eab

## Betaling mini-coinjoin

<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>


Når du ønsker å gjennomføre en betalingstransaksjon med en viss grad av konfidensialitet, er payjoin et godt alternativ. Men som vi nettopp har sett, krever payjoin at mottakeren er involvert. Så hva gjør du hvis mottakeren nekter å delta i en payjoin, eller hvis du rett og slett foretrekker å ikke involvere dem? Et alternativ er å bruke en Stonewall- eller Stonewall x2-transaksjon. La oss se nærmere på disse to transaksjonstypene.

### Stonewall-transaksjonen

Stonewall er en spesifikk form for Bitcoin-transaksjon som er utformet for å øke brukernes konfidensialitet når de bruker penger ved å imitere en pseudocoinjoin mellom to personer, uten å faktisk være en. Faktisk er denne transaksjonen ikke samarbeidende. En bruker kan bygge den på egen hånd, kun ved å bruke UTXO-er han eller hun eier som input. Du kan altså opprette en Stonewall-transaksjon til enhver anledning, uten å måtte synkronisere med en annen bruker eller mottakeren.

Stonewall-transaksjonen fungerer på følgende måte: Som input til transaksjonen bruker utstederen 2 UTXO-er som tilhører ham selv. Transaksjonen produserer 4 UTXO-er, hvorav 2 er nøyaktig like store. De andre 2 UTXOene vil utgjøre utenlandsk valuta. Av de to UTXOene med samme beløp vil bare én faktisk gå til betalingsmottakeren.

Det er altså bare to roller i en Stonewall-transaksjon:


- Utstederen, som foretar betalingen ;
- Mottakeren, som kanskje ikke er klar over transaksjonens spesifikke natur og bare forventer betaling fra avsenderen.

La oss ta et eksempel for å forstå denne transaksjonsstrukturen. Alice går til Bob, bakeren, for å kjøpe baguetten sin, som koster 4000 sats. Hun ønsker å betale i bitcoins, samtidig som hun ønsker å opprettholde en form for konfidensialitet rundt betalingen. Hun bestemmer seg derfor for å lage en Stonewall-transaksjon for betalingen.

![BTC204](assets/fr/173.webp)

Ved å analysere denne transaksjonen kan vi se at Bob, bakeren, faktisk mottok 4 000 sats som betaling for baguetten. Alice brukte to UTXO-er som inndata: én for 10 000 sats og én for 15 000 sats. Som utganger har hun fått tilbake 3 UTXOer: én for 4 000 sats, én for 6 000 sats og én for 11 000 sats. Alice har derfor en nettosaldo på -4 000 sats på denne transaksjonen, noe som tilsvarer prisen på baguetten.

I dette eksempelet har jeg med vilje utelatt utvinningsgebyrene for å gjøre det lettere å forstå. I virkeligheten bæres transaksjonskostnadene i sin helhet av utstederen.

### Hva er målene med en Stonewall-transaksjon?

Stonewall-strukturen tilfører transaksjonen en enorm mengde entropi, noe som gjør det vanskelig å analysere kjeden. Sett utenfra kan en slik transaksjon tolkes som en mini-coinjoin mellom to personer. Men i virkeligheten er det en betaling. Denne metoden skaper derfor usikkerhet i kjedeanalysen, eller fører til og med til falske spor.

La oss ta et eksempel med Alice hos bakeren Bob. Transaksjonen på blokkjeden vil se slik ut:

![BTC204](assets/fr/174.webp)

En utenforstående observatør som baserer seg på vanlig heuristikk for kjedeanalyse, kan feilaktig konkludere med at "*to personer har gjort en liten coinjoin, med én UTXO hver i input og to UTXO hver i output*". Å analysere denne transaksjonen utenfra fører ikke til anvendelse av CIOH, ettersom tilstedeværelsen av to utganger på samme beløp tyder på et coinjoin-mønster. Fra et eksternt synspunkt er CIOH derfor ikke anvendelig i dette spesifikke tilfellet.

![BTC204](assets/fr/175.webp)

Denne tolkningen er feil, for som du vet, ble én UTXO sendt til Bob, bakeren, de to UTXO-inngangene kom fra Alice, og hun fikk tre utvekslingsutganger.

![BTC204](assets/fr/176.webp)

Og det som er spesielt interessant med strukturen i Stonewall-transaksjonen, er at den, sett fra en utenforstående observatørs ståsted, på alle måter ligner en Stonewall x2-transaksjon.

### Stonewall-transaksjonen x2

Stonewall x2 er en annen spesifikk form for Bitcoin-transaksjon som også har som mål å øke brukernes konfidensialitet når de bruker penger, men denne gangen ved å samarbeide med en tredje person som ikke er involvert i utgiften. Denne metoden fungerer som en pseudocoinjoin mellom to deltakere, samtidig som det foretas en betaling til en tredje person.

Stonewall x2-transaksjonen er relativt enkel: Vi bruker en UTXO vi har til å utføre betalingen, og får hjelp av en tredjepart som også bidrar med en UTXO som tilhører ham eller henne. Transaksjonen ender opp med fire utganger: to av dem med like store beløp, den ene til betalingsmottakerens adresse, den andre til en adresse som tilhører samarbeidspartneren. En tredje UTXO returneres til en annen adresse som tilhører samarbeidspartneren, slik at han eller hun kan få tilbake det opprinnelige beløpet (en nøytral handling for ham eller henne, modulert med gruvekostnadene), og en siste UTXO returneres til en adresse som tilhører oss, som utgjør betalingsutvekslingen.

I Stonewall x2-transaksjonene er det altså definert tre ulike roller:


- Utstederen, som foretar den faktiske betalingen ;
- Mottakeren, som kanskje ikke er klar over transaksjonens spesifikke natur og bare forventer betaling fra avsenderen;
- Samarbeidspartneren, som gjør bitcoins tilgjengelig for å så tvil om analysen av transaksjonen, mens han får tilbake pengene sine i sin helhet på slutten (en nøytral handling for ham, modulo utvinningskostnadene).

La oss gå tilbake til eksempelet med Alice, som er hos Bob bakeren for å kjøpe baguetten sin, som koster 4000 sats. Hun ønsker å betale i bitcoins, samtidig som hun ønsker å opprettholde en viss grad av konfidensialitet rundt betalingen. Hun oppsøker derfor sin venn Charles, som skal hjelpe henne i denne prosessen.

![BTC204](assets/fr/177.webp)

Når vi analyserer denne transaksjonen, ser vi at Bob, bakeren, faktisk mottok 4 000 sats som betaling for baguetten. Alice brukte 10 000 sats i input og fikk tilbake 6 000 sats i output, dvs. en nettobalanse på -4 000 sats, noe som tilsvarer prisen på baguetten. Charles leverte 15 000 sats i input og mottok to output: ett på 4 000 sats og ett på 11 000 sats, noe som gir en balanse på 0.

I dette eksempelet har jeg med vilje utelatt gebyrene for å gjøre det enklere å forstå. I virkeligheten deles utvinningsgebyrene vanligvis likt mellom utstederen av betalingen og bidragsyteren.

### Hva er formålet med en Stonewall x2-transaksjon?

I likhet med Stonewall-strukturen tilfører Stonewall x2-strukturen mye entropi til transaksjonen og forvirrer kjedeanalysen. Sett utenfra kan en slik transaksjon tolkes som en liten coinjoin mellom to personer. Men i virkeligheten er det en betaling. Denne metoden skaper derfor usikkerhet i kjedeanalysen, eller fører til og med til falske spor.

La oss ta et eksempel med Alice, Bob the Baker og Charles. Transaksjonen på blokkjeden vil se slik ut:

![BTC204](assets/fr/178.webp)

En utenforstående observatør som baserer seg på vanlig kjedeanalyseheuristikk, kan feilaktig konkludere med at "*Alice og Charles har utført en liten coinjoin, med én UTXO hver i input og to UTXO hver i output*". Igjen, å analysere denne transaksjonen utenfra fører ikke til anvendelse av ICOH, ettersom tilstedeværelsen av to utganger på samme beløp tyder på et coinjoin-mønster. Fra et eksternt synspunkt er CIOH derfor ikke anvendelig i dette spesifikke tilfellet.

![BTC204](assets/fr/179.webp)

Denne tolkningen er feil, for som du vet, har én UTXO blitt sendt til bakeren Bob, Alice har bare én utvekslingsutgang, og Charles har to.

![BTC204](assets/fr/180.webp)

Og igjen, det som er spesielt interessant med strukturen i Stonewall x2-transaksjonen, er at den, sett fra en utenforstående observatørs ståsted, på alle måter ligner en Stonewall-transaksjon.

### Hva er forskjellen mellom Stonewall og Stonewall x2?

En Stonewall X2-transaksjon fungerer akkurat som en Stonewall-transaksjon, bortsett fra at førstnevnte er kollaborativ, mens sistnevnte ikke er det. Som vi har sett, involverer en Stonewall X2-transaksjon deltakelse av en tredjepart (Charles), som står utenfor betalingen, og som stiller sine bitcoins til rådighet for å øke konfidensialiteten i transaksjonen. I en klassisk Stonewall-transaksjon er det avsenderen som tar på seg rollen som samarbeidspartner.

![BTC204](assets/fr/181.webp)

Fra et eksternt synspunkt er transaksjonsmønsteret nøyaktig det samme.

![BTC204](assets/fr/182.webp)

Det faktum at disse to transaksjonsstrukturene har nøyaktig samme mønster, betyr at selv om en utenforstående observatør klarer å identifisere et "Stonewall(x2)"-mønster, vil han ikke ha all informasjonen. Han vil ikke kunne avgjøre hvilken av de to UTXO-ene med samme beløp som tilsvarer betalingen. Han vil heller ikke kunne avgjøre om de to UTXO-ene med innbetalinger kommer fra to forskjellige personer (Stonewall x2) eller om de tilhører én og samme person som har slått dem sammen (Stonewall).

Dette siste poenget skyldes at Stonewall x2-transaksjoner følger nøyaktig samme mønster som Stonewall-transaksjoner. Sett utenfra, og uten ytterligere kontekstuell informasjon, er det umulig å skille en Stonewall-transaksjon fra en Stonewall x2-transaksjon. De førstnevnte er ikke samarbeidstransaksjoner, mens de sistnevnte er det. Dette gjør analysen av en av disse transaksjonene enda mer tvilsom.

### Når bør Stonewall- og Stonewall x2-transaksjoner brukes?

Logikken bør være som følger når du ønsker å bruke et konfidensialitetsverktøy for en utgift:


- Vi kan velge å prioritere en payjoin;
- Hvis forhandleren ikke støtter payjoins, kan en samarbeidstransaksjon gjøres med en annen person utenfor betalingen ved hjelp av Stonewall x2-strukturen;
- Hvis du ikke finner noen som kan foreta en Stonewall x2-transaksjon, kan du foreta en Stonewall only-transaksjon, som vil etterligne oppførselen til en Stonewall x2-transaksjon.

### Hvordan bruker jeg Stonewall og Stonewall x2-transaksjoner?

Stonewall- og Stonewall x2-transaksjoner er tilgjengelige både i Samourai Wallet-applikasjonen og Sparrow Wallet-programvaren.

![BTC204](assets/fr/183.webp)

Men som med payjoins, etter arrestasjonen av Samourais grunnleggere, fungerer Stonewall x2-transaksjoner nå bare ved å utveksle PSBT-er manuelt mellom de berørte partene. Dessverre er automatisk utveksling via Soroban ikke lenger tilgjengelig.

Det er også mulig å utføre denne typen transaksjoner manuelt fra hvilken som helst Bitcoin-lommebokprogramvare.

I neste kapittel skal vi se nærmere på en annen konfidensialitetsteknikk som er relativt ukjent, men som er svært nyttig som et supplement til det vi allerede har studert.

https://planb.network/tutorials/privacy/on-chain/stonewall-033daa45-d42c-40e1-9511-cea89751c3d4

https://planb.network/tutorials/privacy/on-chain/stonewall-x2-05120280-f6f9-4e14-9fb8-c9e603f73e5b

## Rikosjettene

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>


Bruken av Bitcoin-transaksjonsstrukturer som gjør kjedeanalysen mer tvetydig, for eksempel coinjoin, er spesielt fordelaktig for å beskytte personvernet. Som vi diskuterte i kapittelet om payjoins, er imidlertid coinjoin-transaksjoner naturlig nok identifiserbare i kjeden. Husk analogien vi trakk mellom kryptering og coinjoin: Når en fil er kryptert, kan en tredjepart som oppdager den krypterte filen, ikke få tilgang til innholdet, men kan tydelig identifisere at filen har blitt endret for å skjule innholdet. Det samme gjelder coinjoin: Når en analytiker undersøker en coinjoin-transaksjon, kan han eller hun, selv om han eller hun ikke kan etablere direkte koblinger mellom inndata og utdata (og vice versa), likevel gjenkjenne at den observerte transaksjonen er en coinjoin.

Avhengig av hvordan du har tenkt å bruke mynten din etter en coinjoin-syklus, kan det faktum at den har gjennomgått denne prosessen være problematisk. Hvis du for eksempel planlegger å selge mynten din på en regulert utvekslingsplattform, men den nylig har gjennomgått en coinjoin, vil plattformens kjedeanalyseverktøy oppdage dette. Plattformen kan da nekte å godta din coinjointe UTXO, eller til og med kreve en forklaring fra deg, med risiko for at kontoen din blir suspendert eller pengene dine frosset. I noen tilfeller kan plattformen også rapportere oppførselen din til statlige myndigheter (dette er for eksempel det TRACFIN krever av PSAN-er i Frankrike).

![BTC204](assets/fr/184.webp)

For å unngå dette trenger vi et verktøy som kan viske ut sporene etter en Bitcoin-mynts fortid, for å gjenopprette en form for fungibilitet. Dette er nettopp formålet med rikosjett.

![BTC204](assets/fr/185.webp)

### Hva er en rikosjett?

Rikosjett er en teknikk som går ut på å utføre flere fiktive transaksjoner mot seg selv (sweep) for å simulere en overføring av bitcoin-eierskap. Dette verktøyet skiller seg fra de andre transaksjonsstrukturene vi har diskutert, ved at det ikke gir prospektiv anonymitet, men snarere en form for retrospektiv anonymitet. I realiteten visker ricochet ut de spesifikke egenskapene som kan kompromittere fungibiliteten til en Bitcoin-mynt på grunn av dens fortid.

For å jevne ut avtrykket som en tidligere hendelse har etterlatt på en mynt, for eksempel møntsykluser, utfører ricochet fire påfølgende transaksjoner der brukeren overfører penger til seg selv på forskjellige adresser.

![BTC204](assets/fr/186.webp)

Etter denne transaksjonssekvensen sender ricochet-verktøyet til slutt bitcoinsene til deres endelige destinasjon, for eksempel en utvekslingsplattform.

![BTC204](assets/fr/187.webp)

Målet er å skape en avstand som påvirker myntens fungibilitet, for eksempel en coinjoin-transaksjon, og den endelige utgiftshandlingen, som kan avvise denne mynten på grunn av dens fortid. Dermed kan verktøy for kjedeanalyse konkludere med at det sannsynligvis har skjedd et eierskifte etter hendelsen, og anse denne mynten som fungibel. Ved en coinjoin kan verktøy for blokkjedeanalyse anta at det ikke var samme person som sendte bitcoinsene og utførte coinjoin, og at det derfor ikke er noe poeng i å iverksette tiltak mot avsenderen.

![BTC204](assets/fr/188.webp)

### Hvorfor fungerer det?

Med denne rikosjettmetoden kunne man tenke seg at programvare for kjedeanalyse ville gå dypere enn fire sprett. Disse plattformene står imidlertid overfor et dilemma når de skal optimalisere deteksjonsterskelen. De må sette en grense for hvor mange hopp som skal til før de aksepterer at det sannsynligvis har skjedd en endring i en egenskap, og at koblingen til en tidligere hendelse (for eksempel en coinjoin) bør ignoreres.

![BTC204](assets/fr/189.webp)

Det er imidlertid risikabelt å sette denne terskelen: Hver økning i antall observerte hopp øker eksponentielt mengden falske positiver, det vil si personer som feilaktig blir markert som deltakere i en hendelse, selv om det i virkeligheten var noen andre som utførte operasjonen. Dette scenariet utgjør en stor risiko for disse selskapene, ettersom falske positiver fører til misnøye, noe som kan føre til at berørte kunder går til konkurrenten. På lang sikt kan en for høy deteksjonsterskel føre til at en plattform mister flere kunder enn konkurrentene, noe som kan true plattformens levedyktighet. Det er derfor komplisert for disse plattformene å øke antallet observerte bounces, og 4 er ofte et tilstrekkelig antall for å motvirke analysene deres.

Fenomenet som observeres her, er noe analogt med teorien om de seks separasjonsgradene.

Teorien om de seks graders separasjon antyder at alle mennesker på jorden er forbundet med hverandre gjennom en kjede av relasjoner som består av høyst seks mellomledd. Det ville derfor være nok å gå gjennom en serie på seks personer, der hver person kjenner den neste, for å nå et hvilket som helst individ i verden.

Når det gjelder Bitcoin-transaksjoner, finner vi et lignende fenomen. Ved å spore et tilstrekkelig antall Bitcoin-transaksjoner, kommer vi uunngåelig over en coinjoin. Rikosjettmetoden utnytter dette prinsippet ved å bruke et større antall hopp enn det utvekslingsplattformene med rimelighet kan spore. Hvis plattformene bestemmer seg for å spore flere transaksjoner, er det da mulig å legge til et ekstra hopp for å omgå dette tiltaket.

### Når og hvordan bruke rikosjett?

Det vanligste bruksområdet for rikosjettering oppstår når det er nødvendig å skjule en tidligere deltakelse i en coinjoin på en UTXO du eier. Ideelt sett er det best å unngå å overføre bitcoins som har gjennomgått en myntsammenføyning til regulerte enheter. Likevel, i tilfelle du ikke har noe annet alternativ, spesielt i det presserende behovet for å avvikle bitcoins i statlig valuta, tilbyr ricochet en effektiv løsning.

Denne metoden er ikke bare effektiv for sammenføyninger, men også for alle andre merker som kan kompromittere en dels fungibilitet.

Ideen til denne rikosjettmetoden kom opprinnelig fra Samourai Wallet-teamene, som integrerte den i applikasjonen sin for å automatisere prosessen. Tjenesten er ikke gratis på Samourai, siden en ricochet innebærer en serviceavgift på 100 000 sats, pluss gruvekostnader. Det anbefales derfor å bruke den for overføringer av betydelige beløp.

![BTC204](assets/fr/190.webp)

Samurai-applikasjonen tilbyr to rikosjettvarianter:


- Forsterket rikosjett, eller "forskjøvet levering", som gir fordelen av å spre Samurai-gebyret over de fem påfølgende transaksjonene. Dette alternativet sikrer også at hver transaksjon sendes på et separat tidspunkt og registreres i en annen blokk, noe som etterligner oppførselen til et eierskifte så godt som mulig. Selv om denne metoden er langsommere, er den å foretrekke for de som ikke har det travelt, ettersom den maksimerer effektiviteten til rikosjetteringen ved å forsterke dens motstand mot kjedeanalyse;

![BTC204](assets/fr/191.webp)


- Den klassiske rikosjetteringen, som er designet for å utføre operasjonen raskt, sender alle transaksjoner i et redusert tidsintervall. Denne metoden gir derfor mindre konfidensialitet og mindre motstand mot analyse enn den forsterkede metoden. Den bør bare brukes til hastesendinger.

![BTC204](assets/fr/192.webp)

Ricocheting betyr ganske enkelt å sende bitcoins til deg selv. Det er fullt mulig å ricochetere bitcoins manuelt på hvilken som helst lommebokprogramvare, uten å bruke et spesialisert verktøy. Alt du trenger å gjøre er å overføre den samme mynten til deg selv suksessivt, med en ny, tom adresse hver gang.

I neste kapittel skal vi se nærmere på ulike teknikker for hemmelige eierskifter. Disse metodene skiller seg radikalt fra dem vi har sett på så langt, både når det gjelder virkemåte og resultater.

https://planb.network/tutorials/privacy/on-chain/ricochet-e0bb1afe-becd-44a6-a940-88a463756589

## Hemmelige eierskapsoverdragelser

<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>


En annen av Bitcoins konfidensialitetsteknikker er hemmelig overføring av eierskap. Denne metoden tar sikte på å overføre eierskap av Bitcoins fra en person til en annen, og omvendt, uten at transaksjonen er eksplisitt synlig på blokkjeden. La oss ta en titt på de ulike teknikkene som er tilgjengelige, sammen med fordeler og ulemper.

### Myntbyttet

Coinwap er basert på et relativt enkelt konsept: Det bruker smartkontrakter for å legge til rette for en overføring av bitcoin-eierskap mellom to brukere, uten behov for tillit og uten at denne overføringen er eksplisitt synlig i blokkjeden.

![BTC204](assets/fr/193.webp)

La oss tenke oss et naivt eksempel med Alice og Bob. Alice har 1 BTC sikret med den private nøkkelen $A$, og Bob har også 1 BTC sikret med den private nøkkelen $B$. De kan teoretisk sett utveksle sine private nøkler via en ekstern kommunikasjonskanal for å utføre en hemmelig overføring.

![BTC204](assets/fr/194.webp)

Denne naive metoden innebærer imidlertid en høy risiko når det gjelder tillit. Det er ingenting som hindrer Alice i å ta vare på en kopi av den private $A$-nøkkelen etter utvekslingen og bruke den til å stjele bitcoins senere, når Bob har fått nøkkelen i hendene.

![BTC204](assets/fr/195.webp)

Videre er det ingen garanti for at Alice ikke vil motta Bobs private nøkkel $B$ og aldri gi videre sin private nøkkel $A$ i bytte. Denne utvekslingen er derfor avhengig av overdreven tillit mellom partene, og er ineffektiv når det gjelder å sikre en sikker hemmelig overføring av eierskap.

![BTC204](assets/fr/196.webp)

For å løse disse problemene og muliggjøre utveksling mellom parter som ikke stoler på hverandre, skal vi i stedet bruke smartkontraktsystemer. En smartkontrakt er et program som kjøres automatisk når forhåndsdefinerte betingelser er oppfylt. I vårt tilfelle sørger dette for at utvekslingen av eiendom skjer automatisk, uten behov for gjensidig tillit.

Dette kan oppnås ved hjelp av HTLC (*Hash Time-Locked Contracts*) eller PTLC (*Point Time-Locked Contracts*). Disse to protokollene fungerer på samme måte, ved hjelp av et tidslåst system som sikrer at utvekslingen enten fullføres eller kanselleres helt, og dermed beskytter integriteten til begge parters midler. Hovedforskjellen mellom HTLC og PTLC er at HTLC bruker hashes og preimages for å sikre transaksjonen, mens PTLC bruker Adaptor Signatures.

I et myntbyttescenario med HTLC eller PTLC mellom Alice og Bob foregår utvekslingen på en sikker måte: enten lykkes den, og begge mottar den andres BTC, eller så mislykkes den, og begge beholder sin egen BTC. Dette gjør det umulig for noen av partene å jukse eller stjele den andres BTC.

> *HTLC er også mekanismen som brukes til å rute betalinger sikkert gjennom Lightning-nettverkets toveiskanaler*
Bruken av Adaptor Signatures er spesielt interessant i denne sammenhengen, ettersom den gjør det mulig å unngå tradisjonelle skript (en mekanisme som noen ganger omtales som "_skriptløse skript"). Denne funksjonen reduserer kostnadene forbundet med utveksling. En annen stor fordel med Adaptor Signatures er at de ikke krever bruk av en felles hash for begge parter i transaksjonen, slik at det ikke er nødvendig å avsløre en direkte kobling mellom dem ved visse typer utveksling.

### Adaptorsignaturer

Adaptorsignaturer er en kryptografisk metode som integrerer en gyldig signatur med en tilleggssignatur, kalt "_adaptorsignaturen_", for å avsløre hemmelige data. Denne mekanismen er utformet på en slik måte at kunnskap om to av de tre følgende elementene: den gyldige signaturen, adaptorsignaturen og hemmeligheten, gjør at vi kan utlede det manglende tredje elementet. En interessant egenskap ved denne metoden er at hvis vi kjenner adapterens signatur og det spesifikke punktet på den elliptiske kurven som er knyttet til hemmeligheten som ble brukt til å beregne adapterens signatur, kan vi utlede vår egen adapter-signatur som vil være kompatibel med den samme hemmeligheten, uten å ha direkte tilgang til selve hemmeligheten.

I et myntbytte gjør bruk av Adaptor Signatures det mulig å utlevere to sensitive opplysninger mellom deltakerne samtidig, slik at man unngår behovet for gjensidig tillit. La oss ta et eksempel for å illustrere denne prosessen med Alice og Bob, som ønsker å bytte 1 BTC hver, men som ikke stoler på hverandre. De bruker Adaptor Signatures for å eliminere behovet for å stole på hverandre i denne utvekslingen. Slik gjør de det:


- Alice starter utvekslingen ved å opprette en $m_A$-transaksjon som sender 1 BTC til Bob. Hun genererer en signatur $s_A$, som validerer denne transaksjonen, ved hjelp av sin private nøkkel $p_A$ ($P_A = p_A \cdot G$), et nonce $n_A$ ($N_A = n_A \cdot G$) og en hemmelighet $t$ ($T = t \cdot G$):

$$s_A = n_A + t + H(N_A + T \parallell P_A \parallell m_A) \cdot p_A$$$


- Alice beregner adapterens signatur $s_A'$ ved å trekke den hemmelige $t$ fra sin sanne signatur $s_A$ :

$$s_A' = s_A - t$$$$


- Alice sender Bob sin signaturadaptor $s'_A$, sin usignerte transaksjon $m_A$, punktet som tilsvarer hemmeligheten ($T$), og punktet som tilsvarer nonce ($N_A$). Disse elementene utgjør det som kalles en "adaptor". Det er viktig å merke seg at Bob ikke kan gjenopprette Alices BTC med bare denne informasjonen.
- Bob kan imidlertid kontrollere at Alice ikke prøver å stjele fra ham. For å gjøre dette sjekker han om Alices adapter-signatur $s_A'$ faktisk samsvarer med den foreslåtte transaksjonen $m_A$. Hvis følgende ligning er korrekt, kan han være sikker på at Alices signaturadapter er gyldig:

$$s_A' \cdot G = N_A + H(N_A + T \parallell P_A \parallell m_A) \cdot P_A$$$


- Denne verifiseringen gir Bob tilstrekkelige garantier for at han kan fortsette utvekslingen i full tillit. Deretter oppretter han sin egen transaksjon $m_B$, som skal sende 1 BTC til Alice, og genererer sin adapter-signatur $s_B'$, som også vil være knyttet til den samme hemmeligheten $t$. På dette stadiet er det bare Alice som kjenner verdien av $t$, mens Bob bare kjenner det tilsvarende punktet $T$ som Alice har overført til ham:

$$s_B' = n_B + H(N_B + T \parallell P_B \parallell m_B) \cdot p_B$$$


- Bob sender Alice sin adaptorsignatur $s_B'$, sin usignerte transaksjon $m_B$, samt punktet som tilsvarer hemmeligheten ($T$) og punktet som tilsvarer nonce ($N_B$). Alice, som kjenner hemmeligheten $t$, kan nå kombinere Bobs adaptorsignatur $s_B'$ med denne hemmeligheten for å generere en gyldig signatur $s_B$ for transaksjonen $m_B$ som vil overføre Bobs BTC til henne:

$$s_B = s_B' + t$$$$

$$$(s_B' + t) \cdot G = N_B + T + H(N_B + T \parallell P_B \parallell m_B) \cdot P_B$$$


- Alice sender denne signerte $m_B$-transaksjonen på Bitcoin-blokkjeden for å hente BTC som Bob har lovet. Når Bob ser denne transaksjonen på blokkjeden, kan han trekke ut signaturen $s_B = s_B' + t$. Med denne informasjonen kan Bob deretter isolere den berømte hemmeligheten $t$ han trengte:

$$t = (s_B' + t) - s_B' = s_B - s_B'$$$$


- Og denne hemmeligheten $t$ var det eneste elementet som manglet for at Bob kunne generere den gyldige signaturen $s_A$ fra Alices adaptorsignatur $s_A'$. Denne signaturen validerer transaksjonen $m_A$, som sender en BTC fra Alice til Bob. Bob beregner deretter $s_A$ og sender $m_A$-transaksjonen på blokkjeden:

$$s_A = s_A' + t$$$$

$$$(s_A' + t) \cdot G = N_A + T + H(N_A + T \parallell P_A \parallell m_A) \cdot P_A$$$

La oss oppsummere hvordan en adaptorsignatur fungerer i et myntbytte. Til å begynne med sender Alice en usignert transaksjon til Bob sammen med en adaptor, slik at Bob kan verifisere at hemmeligheten som avsløres senere, vil gi ham tilgang til bitcoins. Til gjengjeld sender Bob sin egen usignerte transaksjon og adaptor til Alice. Alice kan deretter fullføre Bobs transaksjon og hente bitcoinsene ved å kringkaste en gyldig transaksjon takket være hemmeligheten. Når denne transaksjonen publiseres på blokkjeden, har Bob muligheten til å trekke ut hemmeligheten og dermed låse opp Alices transaksjon. Hvis Alice initierer en overføring av Bobs bitcoin, kan Bob på sin side få tilgang til Alices bitcoin uten behov for gjensidig tillit.

Merk at coinswaps først ble foreslått av [Gregory Maxwell i oktober 2013 på BitcoinTalk] (https://bitcointalk.org/index.php?topic=321228.0).

### Atombytte

På samme måte som coinswap, og ved hjelp av de samme typene smartkontrakter, er det også mulig å utføre atomic swaps. Et atomic swap muliggjør en direkte utveksling av ulike kryptovalutaer, for eksempel BTC og XMR, mellom to brukere uten behov for tillit eller en mellommann. Disse byttene kalles "atomiske" fordi de bare har to mulige utfall: enten lykkes byttet, og begge parter er fornøyde, eller så mislykkes det, og begge beholder sine opprinnelige kryptovalutaer, noe som eliminerer behovet for å stole på den andre parten.

![BTC204](assets/fr/197.webp)

Atomic swap og coinswap har en lignende driftsmetode og tilbyr de samme fordelene og ulempene når det gjelder konfidensialitet. Fra Bitcoins synspunkt er et atombytte faktisk sammenlignbart med et myntbytte som utføres i to trinn. Først bytter vi vår BTC mot en annen kryptovaluta, deretter kan denne kryptovalutaen byttes mot andre BTC. Til slutt gjenoppretter vi en annen brukers BTC. Dette er grunnen til at jeg i analysen av konfidensialitetsspørsmål grupperer disse to protokollene under kategorien proprietære hemmelige utvekslinger.

![BTC204](assets/fr/198.webp)

Vær imidlertid oppmerksom på at i motsetning til coinswap, kan atomic swap ha ubalanse når det gjelder tilgjengelig likviditet, spesielt i BTC/XMR-børser. Det er generelt lettere å bytte bitcoins mot altcoins, ettersom det er sterk etterspørsel etter bitcoins, noe som holder premiene lave for denne konverteringsretningen. Det kan imidlertid være mer komplisert å veksle altcoins mot BTC på grunn av lavere etterspørsel, noe som ofte resulterer i svært høye premier.

Til slutt, når et atombytte involverer bitcoins i kjeden og bitcoins i Lightning-nettverket, snakker vi om et "ubåtbytte".

### Er det virkelig nyttig?

Hemmelige eierskifter, som myntbytter og atombytter, har den fordelen at de kan lure kjedeanalysens heuristikk. Disse metodene kan gi inntrykk av at transaksjonene involverer samme bruker, mens det faktiske eierskapet har skiftet hender. Den største ulempen med disse metodene er imidlertid at de er svært risikable uten bruk av en ekstra teknikk for å bryte mynthistorikken.

Når Alice utfører et coinswap eller atomic swap med Bob, bytter hun besittelsen av bitcoinsene sine med Bobs. Ved et atomic swap inkluderer utvekslingen en altcoin, men prinsippet forblir det samme. Dermed ender Alice opp med $B$-mynten og Bob med $A$-mynten. Dette skaper tvil om kjedeanalysen, men myntenes historikk forblir sporbar. Hvis en analytiker undersøker del $A$, kan han eller hun spore Alices tidligere aktiviteter, og vice versa for del $B$.

![BTC204](assets/fr/199.webp)

Sett fra Alices synspunkt er risikoen at historikken til $B$-mynten kan bli ansett som mistenkelig av visse enheter. Hvis Bob for eksempel hadde skaffet seg $B$-mynten gjennom en kriminell handling, for eksempel hacking, ville mynten forbli knyttet til hans ulovlige aktiviteter. Alice kan da komme i besittelse av en mynt som hun ikke kan overføre til regulerte vekslingsplattformer uten å risikere å få pengene sine frosset, eller til og med bli anklaget for Bobs forbrytelser, selv om hun ikke hadde noe med dem å gjøre.

![BTC204](assets/fr/200.webp)

Det er uunngåelig at konfidensialitetsmetoder som coinswap eller atomic swap foretrekkes av kriminelle som har midler som overvåkes av myndighetene. Disse protokollene gjør det mulig for dem å kvitte seg med sine overvåkede bitcoins i bytte mot helt fungible bitcoins. Det gjør det også mulig for dem å skape en avledningsmanøver ved å lede myndighetene mot andre brukere. Så det er et dobbelt formål for disse menneskene.

Med coinjoin blir mynten din ødelagt selv om den blandes med overvåkede bitcoins, noe som gir en form for plausibel benektelse som ikke finnes i hemmelige eierskapsoverføringsprotokoller som coinswap eller atomic swap.

![BTC204](assets/fr/201.webp)

Hvis Alice ønsker å unngå enhver risiko, må hun nødvendigvis bruke en metode for å bryte historien til $B$-mynten, for eksempel ved å sende den gjennom coinjoins. Dette reiser et spørsmål om nytten av å kombinere hemmelig overføring av eierskap og coinjoin. Coinjoin, ved å bryte en mynts historikk, tilbyr allerede et tilstrekkelig nivå av konfidensialitet for Alice. Derfor mener jeg at hvis Alice ønsker å beskytte personvernet sitt, vil det være klokere å gå direkte til en coinjoin enn å gjennomføre et coinswap etterfulgt av en coinjoin.

For at hemmelige metoder for overføring av eierskap virkelig skal være effektive, og unngå risikoen for å knytte historikken til en $A$-bruker til en $B$-bruker, er det paradoksalt nok nødvendig at bruken av dem er allment kjent. Hvis myntbytte brukes massivt og myndighetene er klar over denne vanlige praksisen, kan det etableres en plausibel form for fornektelse. Så lenge bruken av disse overføringene forblir marginal, tror jeg imidlertid at disse metodene vil forbli for risikable for brukerne.

Hittil har vi hovedsakelig studert konfidensialitetsmetoder på selve transaksjonsnivået. I neste kapittel skal vi se nærmere på problemstillinger på nettverksnivå og på transaksjonsformidling.

## Personvern i P2P-nettverket

<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>


I del 4 diskuterte vi viktigheten av å bruke en komplett node for å beskytte konfidensialiteten til transaksjonene dine. Det er imidlertid viktig å være klar over at noden i seg selv kan bli utsatt for angrep som forsøker å hente ut informasjon om aktivitetene dine. I dette kapittelet skal vi derfor se på de ulike tiltakene du kan iverksette for å beskytte personvernet ditt, ikke på transaksjonsnivå eller i selve bitcoinflyten, men på nettverksnivå.

### Løvetann

En måte å unngå de ulike avanonymiseringsangrepene på, er å bruke Dandelion-forslaget. Denne kringkastingsprotokollen ble formalisert i BIP156, men har aldri blitt implementert på Bitcoin.

Tanken bak Dandelion er å forbedre konfidensialiteten i transaksjonsrutingen i Bitcoin-nettverket for å motvirke ulike former for angrep. Hovedmålet er å skjule kildenoden som opprinnelig sendte en transaksjon i nettverket. Avsløring av denne noden kan gjøre det mulig å knytte en Bitcoin-transaksjon til en spesifikk IP-adresse (hvis noden opererer på clearnet), noe som kan gi et inngangspunkt for kjedeanalyse.

Denne koblingen mellom aktivitet på Bitcoin og en IP-adresse utgjør en betydelig risiko for brukernes konfidensialitet. Mange enheter kan enkelt koble en IP-adresse til en personlig identitet. Dette inkluderer myndigheter og internettleverandører. I tillegg kan denne informasjonen bli offentlig tilgjengelig, for eksempel hvis IP-adressen og personopplysningene dine blir lekket når databasen til et nettsted blir hacket.

I klassisk Bitcoin-drift overføres transaksjoner som er opprettet av en bruker i lommebokprogramvaren hans, til hans personlige node. Denne noden vil umiddelbart kringkaste den nye transaksjonen til alle de andre nodene som den er koblet til.

![BTC204](assets/fr/202.webp)

Disse peerene kontrollerer deretter transaksjonen for å sikre at den er i samsvar med konsensus og lokale standardiseringsregler. Når transaksjonen er validert, videresender hver peer transaksjonen til sine peers, og så videre.

![BTC204](assets/fr/203.webp)

Denne fordelingen av transaksjoner som venter på å bli integrert i en blokk, er ganske balansert og statistisk forutsigbar. Denne svakheten kan utnyttes av medskyldige spionnoder, som samarbeider om å overvåke og analysere nettverket for å identifisere den første noden som har kringkastet en transaksjon. Hvis en observatør lykkes i å lokalisere kildenoden, kan han eller hun anta at transaksjonen stammer fra denne nodens operatør. Denne typen observasjon kan brukes til å knytte normalt anonyme transaksjoner til bestemte IP-adresser.

![BTC204](assets/fr/204.webp)

Målet med BIP156 er å løse dette problemet. For å gjøre dette innfører den en ekstra fase i spredningen av en ny transaksjon for å bevare anonymiteten før den spres offentlig. Dandelion bruker først en "stem"-fase der transaksjonen sendes gjennom en tilfeldig sti av noder.

![BTC204](assets/fr/205.webp)

Transaksjonen blir deretter kringkastet til hele nettverket i "Fluff"-fasen.

![BTC204](assets/fr/206.webp)

Stilken og "Fluff"-fasen viser til oppførselen ved spredning av transaksjonen i nettverket, som ligner på formen og utviklingen til en løvetann ("Dandelion" på engelsk).

Spionnoder kan dermed potensielt spore transaksjonen tilbake til noden som startet "Fluff"-fasen (masseutsendingen), men denne noden er ikke den som sendte transaksjonen først, da den mottok den fra den siste noden i stilken. Hvis spionnodene ikke kan spore stilken, kan de heller ikke identifisere kildenoden.

![BTC204](assets/fr/207.webp)

Selv om det finnes spionnoder i stamfasen, vil det alltid være tvil, for så snart de støter på en ærlig node i diffusjonsgrafen, kan ikke spionene avgjøre om denne noden er den opprinnelige kilden eller bare et mellomledd.

![BTC204](assets/fr/208.webp)

Denne rutingsmetoden gjør det vanskelig å spore en transaksjon tilbake til kildenoden, slik at det blir vanskelig å spore transaksjonen tilbake til opprinnelsen gjennom nettverket. Dandelion forbedrer dermed konfidensialiteten ved å begrense motstandernes mulighet til å de-anonymisere nettverket. Denne metoden er desto mer effektiv når transaksjonen i "stemming"-fasen krysser en node som krypterer nettverkskommunikasjonen sin, som med Tor eller P2P Transport V2.

BIP156 har ikke blitt integrert i Bitcoin Core og er for øyeblikket klassifisert som "avvist". Et av hovedproblemene med denne protokollen er at transaksjonene må sendes gjennom mellomliggende noder før de blir verifisert. Som vi har sett, verifiserer hver node i den normale Bitcoin-modellen først transaksjonen før den sendes videre til de andre nodene. Hvis en transaksjon ikke er i samsvar med nodens konsensusregler eller lokale standardiseringsregler, ignorerer noden den og distribuerer den ikke. Denne prosessen er viktig for å motvirke DoS-angrep, ettersom bare gyldige transaksjoner sendes ut til hele nettverket. Ugyldige transaksjoner, som potensielt kan genereres i massevis for å overbelaste nettverket, stoppes ved den første noden og spres ikke videre. Den største risikoen med Dandelion er at denne nye protokollen kan introdusere nye vektorer for DoS-angrep ved å tillate at ugyldige transaksjoner kringkastes over deler av nettverket.

### P2P-transport V2

P2P-transport V2 er en annen nettverksprotokoll som presenteres i BIP324. Det er en ny versjon av Bitcoins P2P-transportprotokoll som inneholder opportunistisk kryptering for å forbedre konfidensialiteten og sikkerheten i kommunikasjonen mellom noder.

Denne forbedringen er utformet for å løse flere problemer med den grunnleggende versjonen av P2P-protokollen. På den ene siden gjør den det umulig for en passiv observatør å skille dataene som utveksles, fra andre typer data som sirkulerer på Internett. Hovedmålet er å forhindre at myndigheter, Internett-leverandører og VPN-leverandører overvåker Bitcoin-brukere i stor skala. Dette gjør det også vanskeligere for disse aktørene å avgjøre om en Internett-bruker også er en Bitcoin-bruker, det vil si om han eller hun driver en komplett node.

P2P V2 bidrar også til å redusere risikoen for sensur og angrep ved å oppdage spesifikke mønstre i datapakker. Det gjør det vanskeligere og mer kostbart å utføre ulike typer Sybil-angrep på nettverksnivå. Et Sybil-angrep oppstår når en aktør oppretter flere falske identiteter for å oppnå en urettferdig fordel. I Bitcoin-nettverket manifesterer dette seg ofte ved at en aktør kontrollerer et stort antall komplette noder og bruker dem aggressivt til å multiplisere tilkoblinger. Sybil-angrep kan være passive, for å samle informasjon og kompromittere brukernes konfidensialitet, eller aktive, i form av Eclipse-angrep. Sistnevnte isolerer en spesifikk node fra resten av nettverket, enten ved å sensurere brukeren eller endre dataene den mottar. Til slutt gjør P2P V2 også *Man-In-The-Middle*-angrep (MITM) mer kostbare og lettere å oppdage.

Krypteringen som P2P V2 implementerer, inkluderer ikke autentisering for ikke å gjøre det unødvendig komplekst, eller for å kompromittere det faktum at tilkoblingen til nettverket forblir tillatelsesfri. Likevel gir den nye P2P-transportprotokollen bedre sikkerhet mot passive angrep, samtidig som aktive angrep blir betydelig mer kostbare og lettere å oppdage. Innføringen av en pseudotilfeldig datastrøm i nettverksmeldingene gjør det vanskeligere for angripere å sensurere eller manipulere kommunikasjonen.

P2P V2-transport ble inkludert som et alternativ (deaktivert som standard) i Bitcoin Core versjon 26.0, som ble distribuert i desember 2023. Den ble deretter aktivert som standard i versjon 27.0 fra april 2024. Det kan endres med `v2transport=`-alternativet i konfigurasjonsfilen.

### Tor

En annen enkel løsning for å unngå risikoen for tap av konfidensialitet for en nettverksnode er å kjøre den helt og holdent under Tor.

Tor er et nettverk av relay-servere (noder) som anonymiserer opprinnelsen til TCP-forbindelser på Internett. Det fungerer ved at data kapsles inn i flere krypteringslag. Hver relénode fjerner et lag for å avsløre adressen til den neste noden, helt til den endelige destinasjonen er nådd. Tor-nettverket sikrer anonymitet ved å forhindre at mellomliggende noder kjenner både opprinnelsen og destinasjonen til dataene, noe som gjør det svært vanskelig for en observatør å spore en brukers aktivitet.

![BTC204](assets/fr/209.webp)

Tor krypterer ikke bare data, men maskerer også opprinnelsen og destinasjonen til kommunikasjonen. Ved å bruke Tor for kommunikasjon fra din personlige node, styrker du konfidensialiteten til transaksjonene dine: Internett-leverandøren din kan ikke dekryptere kommunikasjonen, og andre noder i Bitcoin-nettverket kan ikke identifisere kildenodens IP-adresse. I tillegg skjuler Tor også din bruk av Bitcoin fra din ISP.

Den største risikoen med denne metoden er at Tor er en protokoll som er uavhengig av Bitcoin. Hvis du har en Bitcoin-node som kjører under Tor og Tor slutter å fungere, vil Bitcoin-noden din ikke lenger kunne kommunisere.

Det er også viktig å merke seg at kommunikasjonen på Tor er tregere. Denne forsinkelsen er spesielt irriterende under den første lanseringen av en node, ettersom IBD (*Initial Block Download*) krever mye kommunikasjon. Som et resultat kan din første synkronisering med Bitcoin-nettverket ta betydelig lengre tid ved bruk av Tor. Det er også mulig å utføre IBD på clearnet, og deretter aktivere Tor som et andre trinn. Selv om denne metoden avslører eksistensen av din Bitcoin-node til din ISP, beskytter den din personlige transaksjonsinformasjon når du bytter til Tor.

Etter å ha utforsket de ulike metodene for konfidensialitet på nettverksnivå, vil jeg i de neste kapitlene også introdusere deg for to elegante løsninger for å unngå gjenbruk av adresser: BIP47 og Silent Payments.

## BIP47 og gjenbrukbare betalingskoder

<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>


Som vi så i del 3, er gjenbruk av adresser et alvorlig hinder for brukernes konfidensialitet i Bitcoin-protokollen. For å redusere denne risikoen anbefales det på det sterkeste å generere en tom mottakeradresse for hver nye betaling som mottas i en lommebok. Selv om det nå er enklere å generere en ny adresse ved bruk av moderne programvare og hierarkiske, deterministiske lommebøker, kan denne praksisen virke kontraintuitiv.

![BTC204](assets/fr/210.webp)

I det tradisjonelle banksystemet er vi for eksempel vant til å dele IBAN-nummeret vårt, som alltid forblir det samme. Når vi har gitt det til noen, kan de sende oss flere betalinger uten å måtte samhandle med oss på nytt. Nybankene tilbyr også mer moderne muligheter, som bruk av unike e-postadresser på PayPal eller RevTags på Revolut. Selv utenfor finansverdenen er våre daglige identifikatorer, som postadresse, telefonnummer og e-postadresse, også unike og permanente. Vi trenger ikke å fornye dem for hver nye interaksjon.

![BTC204](assets/fr/211.webp)

Bitcoin fungerer imidlertid annerledes: En ny mottakeradresse må genereres for hver innkommende transaksjon. Dette kompromisset mellom brukervennlighet og konfidensialitet går helt tilbake til opprinnelsen til Bitcoins hvitbok. Allerede da Satoshi Nakamoto publiserte den første versjonen av dokumentet i slutten av 2008, advarte han oss mot denne risikoen:

**Som en ekstra brannmur kan et nytt nøkkelpar brukes for hver transaksjon, slik at de ikke knyttes til en felles eier

Det finnes mange måter å motta flere betalinger på én og samme identifikator uten å måtte bruke en adresse på nytt. Hver av dem har sine egne avveininger og ulemper. Blant disse metodene er BIP47, et forslag utviklet av Justus Ranvier og publisert i 2015. Dette forslaget tar sikte på å skape gjenbrukbare betalingskoder som gjør det mulig å utføre flere transaksjoner mot samme person, samtidig som man unngår gjenbruk av adresser. Kort sagt har BIP47 som mål å tilby et betalingssystem som er like intuitivt som en unik identifikator, samtidig som transaksjonenes konfidensialitet ivaretas.

![BTC204](assets/fr/212.webp)

BIP47 forbedrer ikke brukernes konfidensialitet direkte, ettersom en BIP47-betaling tilbyr samme nivå av konfidensialitet som en klassisk Bitcoin-transaksjon med blanke adresser. Det gjør imidlertid bruken av Bitcoin mer praktisk og intuitiv, noe som normalt ville gått på bekostning av konfidensialiteten. Takket være BIP47 oppnår denne brukervennligheten samme nivå av konfidensialitet som en klassisk transaksjon. Det er derfor BIP47 er et så verdifullt verktøy for å bevare personvernet.

Opprinnelig ble BIP47 foreslått integrert i Bitcoin Core, men ble aldri implementert. Noen programvareapplikasjoner valgte imidlertid å implementere den på egen hånd. For eksempel har Samourai Wallet-teamene utviklet sin egen implementering av BIP47 kalt "PayNym".

### Generelt prinsipp for BIP47 og PayNym

Målet med BIP47 er å gjøre det mulig å motta et stort antall betalinger uten å måtte gjenbruke adresser. Det er basert på bruk av en gjenbrukbar betalingskode, som gjør det mulig for ulike utstedere å sende flere betalinger til en enkelt kode som tilhører en annen bruker. Mottakeren trenger dermed ikke å oppgi en ny, tom adresse for hver transaksjon, noe som forenkler utvekslingen samtidig som konfidensialiteten ivaretas.

![BTC204](assets/fr/213.webp)

En bruker kan derfor dele betalingskoden sin helt fritt, enten det er på sosiale nettverk eller på nettsiden sin, uten å risikere tap av konfidensialitet, i motsetning til med en vanlig mottakeradresse eller offentlig nøkkel.

For å gjennomføre en transaksjon trenger begge parter en Bitcoin-lommebok med en BIP47-implementering, for eksempel PayNym på Samurai Wallet eller Sparrow Wallet. Den felles bruken av betalingskodene deres skaper en hemmelig kanal mellom dem. For å etablere denne kanalen effektivt må utstederen utføre en spesifikk transaksjon på Bitcoin-blokkjeden, kjent som en "varslingstransaksjon" (mer om dette senere).

Ved å kombinere betalingskodene til de to brukerne genereres delte hemmeligheter, som i sin tur skaper et stort antall unike Bitcoin-mottaksadresser (nøyaktig 2^32, eller rundt 4 milliarder). På denne måten blir betalinger som gjøres via BIP47 ikke adressert til selve betalingskoden, men til klassiske mottaksadresser som er avledet fra betalingskodene til de involverte brukerne.

Betalingskoden fungerer dermed som en virtuell identifikator avledet fra porteføljefrøet. I porteføljens hierarkiske avledningsstruktur er betalingskoden plassert på nivå 3, dvs. på kontonivå.

![BTC204](assets/fr/214.webp)

Avledningsmålet for BIP47 er identifisert med indeksen `47` (`0x8000002F`), som refererer til BIP47. Et eksempel på en avledningssti for en gjenbrukbar betalingskode kan være som følger:

```plaintext
m/47'/0'/0'/
```

Her er min betalingskode, for å gi deg et inntrykk av hvordan den ser ut:

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

Denne koden kan også kodes som en QR-kode for å gjøre det enklere å kommunisere, akkurat som en vanlig mottaksadresse.

Når det gjelder PayNym Bots, robotene som noen ganger ses på Twitter, er disse visuelle representasjoner av betalingskoden, opprettet av Samourai Wallet. De genereres ved hjelp av en hash-funksjon, noe som gjør dem nesten unike. De har form av en liten streng med tegn som begynner med `+` :

```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

Disse avatarene kan også representeres som bilder:

![BTC204](assets/fr/215.webp)

Selv om disse robotene ikke har noen spesifikk teknisk funksjonalitet innenfor BIP47-rammeverket, bidrar de til å forenkle brukerinteraksjonen ved å tilby en lett gjenkjennelig visuell identitet.

---
*I de følgende delene av dette kapittelet, som er dedikert til BIP47, skal vi ta en detaljert titt på hvordan det fungerer, med særlig vekt på de kryptografiske metodene som brukes. For å forstå disse noe tekniske forklaringene fullt ut, er det viktig å først forstå strukturen til HD-lommebøker, prosedyrer for nøkkelderivasjon og grunnleggende elliptisk kurvekryptografi. Hvis du ønsker å gå dypere inn i disse konseptene, er et annet gratis opplæringskurs tilgjengelig på Plan ₿ Network :*

https://planb.network/courses/46b0ced2-9028-4a61-8fbc-3b005ee8d70f

*Jeg vil likevel råde deg til å følge dem, for hvis du forstår hvordan BIP47 fungerer rent teknisk, blir det mye lettere for deg å forstå andre, lignende forslag, som vi skal ta for oss i de neste kapitlene*

---
### Den gjenbrukbare betalingskoden

Som nevnt tidligere er den gjenbrukbare betalingskoden plassert på dybde 3 i HD-lommeboken, noe som gjør den sammenlignbar med en `xpub`, både når det gjelder dens posisjon i lommebokstrukturen og dens rolle.

Betalingskoden på 80 byte fordeler seg på følgende måte:


- Byte `0`: Versjonen**. For den første versjonen av BIP47 er denne byten satt til `0x01`;
- Byte `1`: Bit-feltet**. Denne plassen er reservert for å integrere tilleggsangivelser for spesifikke bruksområder. For klassisk PayNym-bruk er denne byten satt til `0x00`;
- Byte `2`: Pariteten til `y`**. Denne byten er `0x02` eller `0x03`, som angir om ordinaten til den offentlige nøkkelen er partall eller oddetall, ettersom det brukes en komprimert offentlig nøkkel;
- Fra byte `3` til byte `34`: Verdien av `x`**. Disse bytene representerer abscissen til den offentlige nøkkelen. Sammenkjedningen av `x` og pariteten til `y` danner den komplette komprimerte offentlige nøkkelen;
- Fra byte `35` til byte `66`: Strengkoden**. Dette området inneholder strengkoden som er knyttet til den offentlige nøkkelen;
- Fra byte `67` til byte `79`: Utfyllingen**. Denne plassen er ment for mulige fremtidige utviklinger. I den nåværende versjonen plasserer vi ganske enkelt nuller her for å oppnå størrelsen på 80 byte som kreves for `OP_RETURN`-utdata.

Her er den heksadesimale representasjonen av den gjenbrukbare betalingskoden min som allerede ble presentert i forrige avsnitt:

```plaintext
0x010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

![BTC204](assets/fr/216.webp)

Deretter må prefiksbyten `P` legges til i begynnelsen for å tydelig indikere at dette er en betalingskode. Denne byten representeres av `0x47` :

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

For å sikre betalingskodens integritet utføres det til slutt en kontrollsumberegning ved hjelp av `HASH256`, som består av en dobbel hash ved hjelp av `SHA256`-funksjonen. De fire første byte av denne hashen kobles deretter sammen på slutten av betalingskoden:

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

![BTC204](assets/fr/217.webp)

Når disse trinnene er fullført, er betalingskoden klar. Alt som gjenstår er å konvertere den til base 58 for å få den endelige versjonen:

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

I prosessen med å opprette betalingskoden bruker vi en komprimert offentlig nøkkel og en strengkode. Begge avledes deterministisk og hierarkisk fra lommebokfrøet. Avledningsstien som brukes for å oppnå dette, er :

```plaintext
m/47'/0'/0'/
```

For å generere den komprimerte offentlige nøkkelen og strengkoden som er knyttet til den gjenbrukbare betalingskoden, begynner vi med å beregne den private hovednøkkelen fra lommebokfrøet. Deretter utleder vi et par datternøkler ved hjelp av indeksen `47 + 2^31` (styrket utledning). Deretter følger ytterligere to påfølgende utledninger av datterpar, hver med indeksen `2^31` (forsterket utledning).

![BTC204](assets/fr/218.webp)

### Diffie-Hellman-nøkkelutveksling på elliptiske kurver (ECDH)

Den kryptografiske protokollen som ligger til grunn for BIP47, er kjent under akronymet ECDH, for *Elliptic-Curve Diffie-Hellman*. Denne metoden er en variant av den opprinnelige Diffie-Hellman-nøkkelutvekslingen.

Diffie-Hellman ble introdusert i 1976 og er en nøkkelavtaleprotokoll som gjør det mulig for to parter, som hver er utstyrt med et nøkkelpar (offentlig og privat), å bli enige om en felles hemmelighet, selv når de kun kommuniserer via en offentlig, usikret kanal.

![BTC204](assets/fr/219.webp)

Denne delte hemmeligheten (i dette tilfellet den blå nøkkelen) kan deretter brukes til andre operasjoner. Vanligvis kan denne delte hemmeligheten brukes til å kryptere og dekryptere en kommunikasjon i et usikret nettverk:

![BTC204](assets/fr/220.webp)

For å oppnå dette bruker Diffie-Hellman modulær aritmetikk til å beregne den delte hemmeligheten. Slik fungerer det i lekmannstermer:


- Alice og Bob blir enige om en felles farge, i dette tilfellet gul, som er offentlig data (angriperne kjenner denne fargen);
- Alice velger en hemmelig farge, i dette tilfellet rød, og blander de to for å få oransje;
- Bob velger også en hemmelig farge, i dette tilfellet blå, og blander den med gul for å få grønn;
- Deretter utveksler de de resulterende fargene, oransje og grønn. Denne utvekslingen kan foregå i et usikkert nettverk og observeres av angripere;
- Ved å blande Bobs grønne farge med sin egen hemmelige farge, får Alice frem brun;
- Bob gjør det samme med Alices oransje og hemmelige blå, og får også brun.

![BTC204](assets/fr/221.webp)

I denne populariseringen representerer fargen brun hemmeligheten som deles av Alice og Bob. Tenk deg at det i virkeligheten er umulig for angriperen å skille fargene oransje og grønn fra hverandre for å finne Alices eller Bobs hemmelige farger.

La oss nå ta en titt på hvordan denne protokollen faktisk fungerer, ikke med fargeanalogier, men ved hjelp av reelle tall og modulær aritmetikk!

Før vi går nærmere inn på Diffie-Hellman-mekanismene, vil jeg kort minne deg på to viktige matematiske begreper vi trenger:


- Et **primtall** er et naturlig tall som bare har to divisorer: $1$ og seg selv. For eksempel er $7$ et primtall fordi det bare kan deles med $1$ og $7$. På den annen side er $8$ ikke et primtall, siden det er delelig med $1$, $2$, $4$ og $8$. Det har derfor fire positive heltall som divisorer i stedet for to;
- **modulo** (kjent som $mod$ eller $\%$) er en matematisk operasjon som, mellom to heltall, returnerer resten av den euklidske delingen av det første med det andre. For eksempel $16\bmod 5 = $1$.

**Diffie-Hellman-nøkkelutvekslingen mellom Alice og Bob foregår på følgende måte:**


- Alice og Bob er enige om to felles tall: $p$ og $g$. $p$ er et primtall, og jo større tallet er, desto sikrere vil Diffie-Hellman være. $g$ er en primitiv rot av $p$. Disse to tallene kan kommuniseres i klartekst i et usikret nettverk. De tilsvarer **fargen gul** i den forrige populariseringen. Det er derfor viktig at Alice og Bob bruker nøyaktig de samme verdiene for $p$ og $g$.
- Når disse parameterne er definert, velger Alice og Bob hvert sitt hemmelige tilfeldige tall. Alice kaller sitt hemmelige tilfeldige tall $a$ (tilsvarer **fargen rød**), og Bob kaller sitt $b$ (tilsvarer **fargen blå**). Disse tallene må forbli hemmelige.
- I stedet for å utveksle tallene $a$ og $b$ direkte, beregner hver av partene $A$ og $B$ på følgende måte:

$A$ er lik $g$ opphøyd til potensen $a$ modulo $p$ :

$$
A = g^a \bmod p
$$

$B$ er lik $g$ opphøyd til potensen $b$ modulo $p$ :

$$
B = g^b \bmod p
$$


- Verdiene $A$ (tilsvarer **fargen oransje**) og $B$ (tilsvarer **fargen grønn**) utveksles mellom de to partene. Denne utvekslingen kan skje i klartekst på et usikret nettverk;
- Alice, som har mottatt $B$, beregner verdien av $z$ på følgende måte:

$z$ er lik $B$ opphøyd til potensen $a$ modulo $p$ :

$$
z = B^a \bmod p
$$

En påminnelse:

$$
B = g^b \bmod p
$$

Resultatet er :

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

Ved å bruke strømreglene :

$$
(x^n)^m = x^{nm}
$$

Resultatet er :

$$
z = g^{ba} \bmod p
$$


- Bob, som har mottatt $A$, beregner på sin side også verdien av $z$ på følgende måte:

$z$ er lik $A$ opphøyd til potensen $b$ modulo $p$ :

$$
z = A^b \bmod p
$$

Resultatet er :

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

Takket være distributiviteten til modulooperatoren får Alice og Bob nøyaktig samme verdi $z$. Dette tallet representerer deres felles hemmelighet, tilsvarende **fargen brun** i den tidligere populariseringen med malingsbokser. De kan nå bruke denne felles hemmeligheten til å kryptere kommunikasjonen sin symmetrisk over et usikret nettverk.

![BTC204](assets/fr/222.webp)

Selv om en angriper er i besittelse av $p$, $g$, $A$ og $B$ (de offentlige verdiene), vil han ikke være i stand til å beregne $a$, $b$ eller $z$ (de private verdiene). For å oppnå dette må eksponentialiseringen reverseres, en operasjon som er umulig uten å prøve alle mulighetene én etter én, ettersom det tilsvarer å beregne den diskrete logaritmen, dvs. den reciprokke av eksponentialen i en endelig syklisk gruppe.

Så lenge verdiene $a$, $b$ og $p$ er store nok, er Diffie-Hellman-protokollen sikker. Med parametere på 2048 bits (et 600-sifret desimaltall) vil det vanligvis være upraktisk å teste alle muligheter for $a$ og $b$. Til dags dato anses denne algoritmen som sikker med slike tall.

Her ligger den største ulempen med Diffie-Hellman-protokollen. For å være sikker må algoritmen bruke store tall. Derfor foretrekker vi i dag å bruke ECDH-algoritmen (*Elliptic Curve Diffie-Hellman*), en variant av Diffie-Hellman som er basert på en algebraisk kurve, nærmere bestemt en elliptisk kurve. Denne tilnærmingen gjør det mulig å arbeide med mye mindre tall samtidig som man opprettholder tilsvarende sikkerhet, noe som reduserer ressursene som kreves for beregning og lagring.

Det generelle prinsippet for algoritmen forblir det samme. Men i stedet for å bruke et tilfeldig tall $a$ og et tall $A$ beregnet fra $a$ ved hjelp av modulær eksponentiering, bruker vi et par nøkler som er etablert på en elliptisk kurve. I stedet for å stole på distributiviteten til modulooperatoren, bruker vi gruppeloven på elliptiske kurver, og mer presist assosiativiteten til denne loven.

For å forklare prinsippet om kryptografi på elliptiske kurver kort, er en privat nøkkel representert ved et tilfeldig tall mellom $1$ og $n-1$, der $n$ representerer kurvens orden. Den offentlige nøkkelen er derimot et spesifikt punkt på denne kurven, som er hentet fra den private nøkkelen ved å legge til og doble punkter fra det genererende punktet, i henhold til ligningen :

$$
K = k \cdot G
$$

I denne formelen betegner $K$ den offentlige nøkkelen, $k$ den private nøkkelen og $G$ generatorpunktet.

En viktig egenskap ved disse nøklene er at $K$ enkelt kan beregnes ut fra $k$ og $G$, mens det er praktisk talt umulig å finne $k$ ut fra $K$ og $G$. Denne asymmetrien skaper en enveisfunksjon. Med andre ord er det enkelt å beregne den offentlige nøkkelen hvis du kjenner den private nøkkelen, men det er umulig å hente den private nøkkelen fra den offentlige nøkkelen. Denne sikkerheten underbygges ytterligere av at den diskrete logaritmen er vanskelig å beregne.

Vi skal bruke denne egenskapen til å tilpasse Diffie-Hellman-algoritmen vår. **ECDH fungerer på følgende måte


- Alice og Bob blir enige om en kryptografisk sikker elliptisk kurve og dens parametere. Denne informasjonen er offentlig;
- Alice genererer et tilfeldig tall $ka$ som blir hennes private nøkkel. Denne private nøkkelen må forbli hemmelig. Hun bestemmer sin offentlige nøkkel $Ka$ ved å legge til og doble punkter på den valgte elliptiske kurven:

$$
K_a = k_a \cdot G
$$


- Bob genererer også et tilfeldig tall $kb$, som blir hans private nøkkel. Han beregner den tilhørende offentlige nøkkelen $Kb$ :

$$
K_b = k_b \cdot G
$$


- Alice og Bob utveksler sine offentlige nøkler $Ka$ og $Kb$ på et usikret, offentlig nettverk.
- Alice beregner et punkt $(x,y)$ på kurven ved å bruke sin private nøkkel $ka$ til Bobs offentlige nøkkel $Kb$ :

$$
(x,y) = k_a \cdot K_b
$$


- Bob beregner et punkt $(x,y)$ på kurven ved å bruke sin private nøkkel $kb$ på Alices offentlige nøkkel $Ka$ :

$$
(x,y) = k_b \cdot K_a
$$


- Alice og Bob får det samme punktet på den elliptiske kurven. Den delte hemmeligheten vil være abscissen $x$ av dette punktet.

De får den samme delte hemmeligheten fordi :

$$
(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a
$$

En potensiell angriper som observerer det usikrede offentlige nettverket, vil bare kunne få tak i de offentlige nøklene til hver enkelt person og parametrene til den valgte elliptiske kurven. Som forklart ovenfor, er ikke denne informasjonen alene tilstrekkelig til å finne de private nøklene. Angriperen kan derfor ikke finne hemmeligheten som deles mellom Alice og Bob.

ECDH er derfor en nøkkelutvekslingsalgoritme. Den brukes ofte sammen med andre kryptografiske metoder for å etablere en komplett protokoll. ECDH er for eksempel kjernen i TLS (*Transport Layer Security*), en krypterings- og autentiseringsprotokoll som brukes for transportlaget på Internett. TLS bruker ECDHE for nøkkelutveksling, en variant av ECDH der nøklene er flyktige, for å sikre vedvarende konfidensialitet. I tillegg bruker TLS autentiseringsalgoritmer som ECDSA, krypteringsalgoritmer som AES og hashfunksjoner som SHA256.

TLS er ansvarlig for `s`en i `https` og hengelåsen i nettleserens adressefelt - symboler på kryptert kommunikasjon. Når du tar dette kurset, bruker du ECDH, og det er høyst sannsynlig at du kommer til å bruke det daglig uten å vite det.

### Meldingstransaksjonen

Som vi så i forrige avsnitt, er ECDH en variant av Diffie-Hellman-utvekslingen som bruker nøkkelpar etablert på en elliptisk kurve. Det er bra at vi allerede har mange nøkkelpar som respekterer denne standarden i Bitcoin-lommebøkene våre! Ideen med BIP47 er å bruke nøkkelparene til begge parters hierarkiske, deterministiske Bitcoin-lommebøker til å etablere delte, flyktige hemmeligheter mellom dem. BIP47 bruker ECDHE (*Elliptic Curve Diffie-Hellman **Ephemeral***) i stedet.

![BTC204](assets/fr/223.webp)

ECDHE brukes først i BIP47 til å overføre betalingskoden fra avsender til mottaker. Dette er den berømte **notifikasjonstransaksjonen**. Dette trinnet er viktig, for for at BIP47 skal fungere effektivt, må begge involverte parter (avsender og mottaker) kjenne hverandres betalingskoder. Denne kunnskapen gjør det mulig å utlede flyktige offentlige nøkler og følgelig de tilhørende blanke mottakeradressene.

Før denne utvekslingen er avsenderen logisk sett allerede kjent med mottakerens betalingskode, ettersom han eller hun har hentet den utenfor kjeden, for eksempel fra nettsiden, fakturaen eller sosiale nettverk. Mottakeren kjenner imidlertid ikke nødvendigvis til avsenderens betalingskode. Koden må imidlertid overføres til ham, ellers vil han ikke kunne utlede de flyktige nøklene som trengs for å identifisere adressene der bitcoinsene hans er lagret, eller få tilgang til pengene sine. Selv om denne overføringen av avsenderens kode teknisk sett kan utføres utenfor kjeden ved hjelp av andre kommunikasjonsmidler, utgjør dette et problem hvis lommeboken kun skal hentes fra seed.

Dette skyldes at BIP47-adresser, i motsetning til konvensjonelle adresser, ikke er avledet direkte fra mottakerens seed - det ville vært enklere å bruke en `xpub` i dette tilfellet - men er resultatet av en beregning som kombinerer de to betalingskodene: avsenderens og mottakerens. Så hvis mottakeren mister lommeboken sin og prøver å gjenopprette den fra seed'en sin, vil han gjenopprette sin egen betalingskode, som er direkte avledet fra seed'en. Men for å gjenopprette efemeriske adresser trenger han også betalingskodene til alle dem som har sendt ham bitcoins via BIP47. Derfor er varslingstransaksjonen så viktig, fordi den gjør det mulig å lagre denne informasjonen i Bitcoin-blokkjeden, samtidig som det er enkelt å finne den uten å måtte søke gjennom de milliarder transaksjonene som er utført siden lanseringen i 2009.

![BTC204](assets/fr/224.webp)

Det vil derfor være mulig å implementere BIP47 uten å bruke varslingstransaksjonen, forutsatt at hver bruker tar en sikkerhetskopi av betalingskodene til sine kolleger. Denne metoden viser seg imidlertid å være komplisert å håndtere inntil det utvikles en enkel, robust og effektiv løsning for å lage, lagre og oppdatere disse sikkerhetskopiene. Slik situasjonen er i dag, er varslingstransaksjonen nærmest uunngåelig.

I de følgende kapitlene vil vi imidlertid se på andre protokoller med lignende mål som BIP47, men som ikke krever en varslingstransaksjon. Disse alternativene innebærer imidlertid sine egne avveininger.

I tillegg til å lagre betalingskoder har varslingstransaksjonen, som navnet antyder, også en varslingsfunksjon for mottakeren. Den varsler mottakerens kunde om at det er opprettet en ny betalingstunnel, og foreslår at han eller hun holder et øye med de efemære adressene som er opprettet.

### BIP47-modellen for konfidensialitet

Før vi går nærmere inn på den tekniske driften av meldingstransaksjonen, er det viktig å diskutere konfidensialitetsmodellen som er knyttet til BIP47, og som rettferdiggjør visse tiltak i forbindelse med opprettelsen av denne første transaksjonen.

Betalingskoden i seg selv utgjør ikke en direkte risiko for konfidensialiteten. I motsetning til den tradisjonelle Bitcoin-modellen, som har som mål å bryte koblingen mellom brukerens identitet og transaksjonene (som er offentlige) ved å bevare anonymiteten til nøkler og adresser, kan betalingskoden knyttes åpent til en identitet uten å utgjøre en trussel.

Dette skyldes at betalingskoden ikke brukes til å utlede adressene som mottar BIP47-betalinger direkte. I stedet genereres disse adressene via ECDH-applikasjonen mellom nøklene som er avledet fra betalingskodene til de to involverte partene.

En betalingskode i seg selv fører dermed ikke direkte til tap av konfidensialitet, siden det kun er aviseringsadressen som avledes av den. Selv om denne adressen kan avsløre visse opplysninger, avslører den normalt ikke hvem man handler med, med mindre man foretar en grundig kjedeanalyse. Hvis avsenderen bruker UTXO-er som kan knyttes til hans identitet for å gjennomføre meldingstransaksjonen, er det mulig å utlede at identiteten hans sannsynligvis er knyttet til BIP47-betalinger til betalingskoden din. Dette vil ikke avsløre de underliggende transaksjonene, men vil indikere deres sannsynlige eksistens.

Det er derfor viktig å opprettholde denne strenge separasjonen mellom brukernes betalingskoder. Med dette i bakhodet er den første kommunikasjonen av koden et kritisk øyeblikk for betalingens konfidensialitet, men samtidig avgjørende for at protokollen skal fungere korrekt. Hvis en av betalingskodene er offentlig tilgjengelig (for eksempel på en nettside), må den andre koden, avsenderens kode, under ingen omstendigheter kobles til den første.

La oss ta et konkret eksempel: Jeg ønsker å gi en donasjon til en politisk bevegelse via BIP47 :


- Organisasjonen har offentliggjort betalingskoden på sine nettsider eller via sine sosiale nettverk;
- Denne koden er derfor knyttet til den politiske bevegelsen;
- Jeg får denne betalingskoden ;
- Før jeg sender, må jeg forsikre meg om at de kjenner min egen betalingskode, som også er knyttet til identiteten min, siden jeg bruker den til å motta transaksjoner på de sosiale nettverkene mine.

Hvordan kan jeg videreformidle koden min uten risiko? Å bruke konvensjonelle kommunikasjonsmidler kan føre til informasjonslekkasje, og dermed assosiere meg med denne politiske bevegelsen. Meldingstransaksjonen tilbyr en løsning, takket være et krypteringslag som forhindrer nettopp en slik assosiasjon mellom to koder. Selv om det ikke er den eneste metoden for å overføre avsenderens betalingskode i hemmelighet, er det en svært effektiv metode.

I diagrammet nedenfor angir de oransje linjene de punktene der informasjonsflyten må avbrytes, og de svarte pilene viser forbindelsene som potensielt kan observeres av tredjeparter:

![BTC204](assets/fr/225.webp)

I Bitcoins tradisjonelle konfidensialitetsmodell er det i realiteten ofte komplisert å skille informasjonsflyten mellom nøkkelparet og brukeren helt fra hverandre, spesielt i eksterne transaksjoner. For eksempel i forbindelse med en donasjonskampanje må mottakeren uunngåelig oppgi en adresse eller offentlig nøkkel via nettsiden sin eller sosiale nettverk. Korrekt bruk av BIP47, spesielt i forbindelse med varslingstransaksjonen, gjør det mulig å omgå dette problemet takket være ECDHE og krypteringslaget vi skal se på senere.

Bitcoins klassiske konfidensialitetsmodell gjelder selvfølgelig fortsatt for kortvarige offentlige nøkler, som er avledet fra kombinasjonen av de to betalingskodene. De to modellene er faktisk komplementære. Det jeg vil understreke her, er at i motsetning til den vanlige bruken av en offentlig nøkkel for å motta Bitcoins, kan betalingskoden knyttes til en spesifikk identitet, ettersom informasjonen "_Alice handler med Bob_" brytes på et annet trinn. Betalingskoden brukes til å generere betalingsadresser, men basert utelukkende på observasjon av blokkjeden er det umulig å knytte en BIP47-betalingstransaksjon til betalingskodene som ble brukt til å utføre den, med mindre de involverte UTXO-ene allerede var knyttet til en identitet tidligere og brukerne knyttet betalingskodene sine til sine respektive identiteter.

For å oppsummere kan konfidensialitetsmodellen som tilbys av BIP47-betalinger anses å være bedre enn Bitcoins grunnleggende modell, selv om dette ikke betyr at den er magisk.

### Oppbygging av varslingstransaksjonen

La oss nå se hvordan denne varslingstransaksjonen fungerer. La oss tenke oss at Alice ønsker å sende penger til Bob ved hjelp av BIP47. I mitt eksempel fungerer Alice som avsender og Bob som mottaker. Bob har publisert betalingskoden sin på nettstedet sitt. Alice kjenner derfor allerede til Bobs betalingskode.

*1- Alice beregner en delt hemmelighet med ECDH: ** *1- Alice beregner en delt hemmelighet med ECDH


- Hun velger et nøkkelpar fra HD-lommeboken sin på en annen gren enn betalingskoden sin. Merk at dette nøkkelparet ikke må kunne assosieres med Alices varslingsadresse eller med Alices identitet (se forrige avsnitt);
- Alice velger den private nøkkelen for dette paret. Vi kaller den $a$ (små bokstaver);

$$
a
$$


- Alice henter den offentlige nøkkelen som er knyttet til Bobs varslingsadresse. Denne nøkkelen er det første barnet avledet fra Bobs betalingskode (indeks $/0$). Vi kaller denne offentlige nøkkelen $B$ (store bokstaver). Den private nøkkelen som er knyttet til denne offentlige nøkkelen, heter $b$ (små bokstaver). $B$ bestemmes ved å legge til og doble punkter på den elliptiske kurven fra $G$ (det genererende punktet) med $b$ (den private nøkkelen):

$$ B = b \cdot G $$


- Alice beregner et hemmelig punkt $S$ (store bokstaver) på den elliptiske kurven ved å legge til og doble punkter, og bruker sin private nøkkel $a$ fra Bobs offentlige nøkkel $B$.

$$ S = a \cdot B $$


- Alice beregner blindingsfaktoren $f$ som skal brukes til å kryptere betalingskoden hennes. For å gjøre dette bruker hun HMAC-SHA512-funksjonen til å bestemme et pseudotilfeldige tall. Den andre inndataen til denne funksjonen er en verdi som bare Bob vil kunne finne: $x$, som er abscissen til det hemmelige punktet som er beregnet ovenfor. Den første inndataen er $o$, som er UTXO-en som ble brukt som inndata til denne transaksjonen (utpunkt).

$$ f = \text{HMAC-SHA512}(o, x) $$$

**2 - Alice konverterer sin personlige betalingskode til base 2 (binær) **

**3 - Den bruker denne blendingsfaktoren som en nøkkel til å utføre symmetrisk kryptering på nyttelasten til betalingskoden. Operasjonen som utføres kan sammenlignes med Vernam-krypteringen, også kjent som "One-Time Pad".


- Alice deler først blendingsfaktoren sin i to: de første 32 byte får navnet $f1$ og de siste 32 byte får navnet $f2$. Dette gir oss :

$$ f = f1 || f2 $$


- Alice beregner koden $x'$ for abscissen til den offentlige nøkkelen $x$ til betalingskoden sin, og koden $c'$ for strengkoden $c$ hver for seg. $f1$ og $f2$ fungerer som henholdsvis krypteringsnøkler. Operasjonen som brukes er `XOR` (eller eksklusiv).

$$ x' = x \oplus f1 $$

$$ c' = c \oplus f2 $$


- Alice erstatter de reelle verdiene til den offentlige nøkkelabscissen $x$ og strengkoden $c$ i betalingskoden sin med de krypterte verdiene $x'$ og $c'$.

**4-** Alice har derfor for øyeblikket betalingskoden sin med en kryptert nyttelast. Hun vil konstruere og kringkaste en transaksjon som involverer hennes offentlige nøkkel $A$ som input, en output til Bobs varslingsadresse, og en output `OP_RETURN` som består av hennes betalingskode med den krypterte nyttelasten. **Denne transaksjonen er varslingstransaksjonen**.

En `OP_RETURN` er en op-kode som markerer utdata fra en Bitcoin-transaksjon som ugyldig. I dag brukes den til å kringkaste eller forankre informasjon på Bitcoin-blokkjeden. Den kan lagre opptil 80 byte med data, som deretter skrives til kjeden og er synlig for alle andre brukere.

Som vi har sett i de foregående avsnittene, brukes ECDH til å generere en delt hemmelighet mellom to brukere som kommuniserer over et usikkert nettverk, og som potensielt kan observeres av angripere. I BIP47 brukes ECDH til å kommunisere på Bitcoin-nettverket, som i sin natur er et transparent kommunikasjonsnettverk, og som kan observeres av mange angripere. Den delte hemmeligheten som beregnes gjennom ECDH-nøkkelutveksling, brukes deretter til å kryptere den hemmelige informasjonen som skal overføres: avsenderens betalingskode (Alice).

Jeg skal oppsummere trinnene vi nettopp har sett sammen for å gjennomføre en varslingstransaksjon:


- Alice henter Bobs betalingskode og varslingsadresse;
- Alice velger en UTXO fra HD-porteføljen sin med det tilsvarende nøkkelparet;
- Den beregner et hemmelig punkt på den elliptiske kurven ved hjelp av ECDH ;
- Den bruker dette hemmelige punktet til å beregne en HMAC, som er blindingsfaktoren;
- Hun bruker denne blendingsfaktoren til å kryptere nyttelasten til den personlige betalingskoden sin;
- Den bruker en `OP_RETURN`-transaksjonsutgang for å kommunisere den skjulte betalingskoden til Bob.

![BTC204](assets/fr/226.webp)

### Transaksjonsvarsling: en praktisk studie

For å forstå hvordan det fungerer i mer detalj, og spesielt bruken av `OP_RETURN`, la oss ta en titt på en ekte notifikasjonstransaksjon. Jeg utførte en slik transaksjon på testnettet, som du kan finne [ved å klikke her] (https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e).

![BTC204](assets/fr/227.webp)

Når vi ser på denne transaksjonen, kan vi allerede se at den har én inngang og fire utganger:


- Den første utdataen er `OP_RETURN`, som inneholder den skjulte betalingskoden min;
- Den andre utgangen av 546 sats peker til mottakerens varslingsadresse;
- Den tredje utgangen på 15 000 satser representerer serviceavgiften, ettersom jeg brukte Samourai Wallet til å opprette denne transaksjonen;
- Den fjerde utgangen på 2 millioner satser representerer valutakursen, dvs. den gjenværende differansen i min inngang som går tilbake til en annen adresse som tilhører meg.

Det mest interessante å studere er selvsagt output 0 ved hjelp av `OP_RETURN`. La oss se nærmere på hva den inneholder. Her er `scriptPubKey` i heksadesimal :

```text
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

Dette skriptet består av flere deler. For det første er :

```text
6a4c
```

Blant opkodene kan vi gjenkjenne `0x6a` som betegner `OP_RETURN` og `0x4c` som betegner `OP_PUSHDATA1`.

Byten som følger etter denne siste opkoden, angir størrelsen på den påfølgende nyttelasten. Den angir `0x50`, eller 80 byte:

```text
6a4c50
```

Deretter har vi metadataene til betalingskoden min i klartekst:

```text
010002
```

Den krypterte abscissen til den offentlige nøkkelen til betalingskoden min :

```text
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

Den krypterte strengkoden til betalingskoden min :

```text
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

Og til slutt, utfylling til 80 byte, standardstørrelsen på en `OP_RETURN` :

```text
00000000000000000000000000
```

For å hjelpe deg å forstå, her er betalingskoden min i ren tekst i base 58 :

```text
PM8TJQCyt6ovbozreUCBrfKqmSVmTzJ5vjqse58LnBzKFFZTwny3KfCDdwTqAEYVasn11tTMPc2FJsFygFd3YzsHvwNXLEQNADgxeGnMK8Ugmin62TZU
```

Og i base 16 :

```text
4701000277507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42add94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc000000000000000000000000008604e4db
```

Hvis vi sammenligner betalingskoden i klartekst med `OP_RETURN`, kan vi se at HRP (`0x47`) og sjekksummen (`0x8604e4db`) ikke overføres. Dette er normalt, siden denne informasjonen er ment for mennesker.

Deretter kan vi gjenkjenne versjonen (`0x01`), bitfeltet (`0x00`) og pariteten til den offentlige nøkkelen (`0x02`). Og på slutten av betalingskoden, de tomme byte (`0x000000000000000000000000000000000000000000`) som gjør det mulig å fylle ut for å nå totalt 80 byte. Alle disse metadataene overføres ukryptert.

Til slutt kan vi observere at den offentlige nøkkelabscissen (`0x77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a`) og strengkoden (`0xdd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc`) har blitt kryptert. Dette er nyttelasten til betalingskoden.

### Hva er XOR?

Vi har i tidligere avsnitt sett at betalingskoden overføres kryptert ved hjelp av XOR-operasjonen. La oss se nærmere på hvordan denne operatoren fungerer, siden den er mye brukt i kryptografi.

XOR er en bitvis logisk operator basert på boolsk algebra. Gitt to operander i bits, returnerer den `1` hvis bitene av samme rang er forskjellige, og den returnerer `0` hvis bitene av samme rang er like. Her er XOR-sannhetstabellen i henhold til verdiene til operandene `D` og `E` :

d | D | E | D XOR E | D

| --- | --- | ------- |

| 0 | 0 | 0 |

| 0 | 1 | 1 |

| 1 | 0 | 1 |

| 1 | 1 | 0 |

For eksempel:

$$
0110 \oplus 1110 = 1000
$$

Eller :

$$
010011 \oplus 110110 = 100101
$$

Med ECDH er bruken av XOR som krypteringslag spesielt konsekvent. For det første er krypteringen symmetrisk takket være denne operatoren. Det betyr at mottakeren kan dekryptere betalingskoden med den samme nøkkelen som ble brukt til krypteringen. Krypterings- og dekrypteringsnøklene beregnes ut fra den delte hemmeligheten ved hjelp av ECDH. Denne symmetrien er mulig på grunn av kommutativitets- og assosiativitetsegenskapene til XOR-operatoren:


- Andre egenskaper :

$$
D \oplus D = 0
$$

$$
D \oplus 0 = D
$$


- Kommutativitet :

$$
D \oplus E = E \oplus D
$$


- Assosiativitet :

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
$$

Hvis :

$$
D \oplus E = L
$$

Da :

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
$$

For det andre er denne krypteringsmetoden svært lik Vernam-krypteringen (One-Time Pad), den eneste krypteringsalgoritmen som hittil er kjent for å ha ubetinget (eller absolutt) sikkerhet. For at Vernam-krypteringen skal ha denne egenskapen, må krypteringsnøkkelen være helt tilfeldig, av samme størrelse som meldingen og bare brukes én gang. I krypteringsmetoden som brukes her for BIP47, er nøkkelen faktisk like stor som meldingen, og blindingfaktoren er nøyaktig like stor som sammenkjedningen av abscissen til den offentlige nøkkelen med strengkoden til betalingskoden. Denne krypteringsnøkkelen brukes bare én gang. På den annen side er ikke denne nøkkelen avledet fra en perfekt tilfeldighet, siden det er en HMAC. Den er snarere pseudotilfeldige. Det er altså ikke en Vernam-kryptering, men metoden er i nærheten.

### Mottak av meldingstransaksjon

Nå som Alice har sendt meldingstransaksjonen til Bob, skal vi se hvordan Bob tolker den. Bob må ha tilgang til Alices betalingskode. Uten denne informasjonen, som vi skal se i neste avsnitt, vil han ikke kunne utlede nøkkelparene som er opprettet av Alice, og vil derfor ikke kunne få tilgang til bitcoinsene han har mottatt via BIP47. For øyeblikket er Alices betalingskode kryptert. La oss se hvordan Bob dekrypterer den.

**1-** Bob overvåker transaksjoner som skaper utganger med hans varslingsadresse.

**2-** Når en transaksjon har en utdata på varslingsadressen, analyserer Bob den for å se om den inneholder en OP_RETURN-utdata som er i samsvar med BIP47-standarden.

**3-** Hvis den første byten i OP_RETURN-nyttelasten er `0x01`, begynner Bob å lete etter en mulig hemmelighet som deles med ECDH :


- Bob velger den offentlige nøkkelen for transaksjonen. Det vil si Alices offentlige nøkkel kalt $A$ med :

$$ A = a \cdot G $$


- Bob velger den private nøkkelen $b$ som er knyttet til hans personlige varslingsadresse :

$$ b $$


- Bob beregner det hemmelige punktet $S$ (delt hemmelighet ECDH) på den elliptiske kurven ved å legge til og doble punkter, ved å bruke sin private nøkkel $b$ til Alices offentlige nøkkel $A$ :

$$ S = b \cdot A $$


- Bob bestemmer blindingfaktoren $f$ som gjør det mulig å dekryptere nyttelasten til Alices betalingskode. På samme måte som Alice hadde beregnet den tidligere, finner Bob $f$ ved å bruke HMAC-SHA512 på $x$, abscisseverdien til det hemmelige punktet $S$, og på $o$, UTXO-en som ble brukt som input til denne varslingstransaksjonen:

$$ f = \text{HMAC-SHA512}(o, x) $$$

**4-** Bob tolker OP_RETURN-dataene i varslingstransaksjonen som en betalingskode. Han dekrypterer ganske enkelt nyttelasten til denne potensielle betalingskoden ved hjelp av blendingsfaktoren $f$:


- Bob deler blendingsfaktoren $f$ i to deler: de første 32 byte av $f$ vil være $f1$ og de siste 32 byte vil være $f2$ ;
- Bob dekrypterer verdien av den krypterte abscissen $x'$ fra den offentlige nøkkelen til Alices betalingskode:

$$ x = x' \oplus f1 $$


- Bob dekrypterer verdien av den krypterte strengkoden $c'$ fra Alices betalingskode:

$$ c = c' \oplus f2 $$

**5-** Bob sjekker om den offentlige nøkkelverdien til Alices betalingskode er en del av secp256k1-gruppen. Hvis det er tilfelle, tolker han dette som en gyldig betalingskode. Hvis ikke, ignorerer han transaksjonen.

Nå som Bob kjenner Alices betalingskode, kan Alice sende ham opptil `2^32` betalinger, uten å måtte gjenta en varslingstransaksjon av denne typen.

Hvorfor fungerer det? Hvordan kan Bob finne den samme blendingsfaktoren som Alice, og dermed dechiffrere betalingskoden hennes? La oss se nærmere på hvordan ECDH fungerer i det vi nettopp har beskrevet.

Først og fremst har vi å gjøre med symmetrisk kryptering. Det betyr at krypteringsnøkkelen og dekrypteringsnøkkelen har samme verdi. Denne nøkkelen i varslingstransaksjonen er den blendende faktoren:

$$ f = f1 || f2 $$

Alice og Bob må derfor få den samme verdien for $f$, uten å overføre den direkte, siden en angriper kan stjele den og dekryptere den hemmelige informasjonen. Denne blindingfaktoren oppnås ved å bruke HMAC-SHA512 på to verdier:


- abscissen til et hemmelig punkt ;
- og UTXO-en som forbrukes ved transaksjonsinngangen.

Bob trenger derfor begge disse opplysningene for å dekryptere Alices betalingskode. Når det gjelder input UTXO, kan Bob ganske enkelt hente den ved å observere varslingstransaksjonen. For det hemmelige punktet må Bob bruke ECDH. Som vi så i forrige avsnitt om Diffie-Hellman, kan Alice og Bob finne et nøyaktig hemmelig punkt på den elliptiske kurven ved å utveksle sine respektive offentlige nøkler og i hemmelighet bruke sine private nøkler på hverandres offentlige nøkkel. Varslingstransaksjonen er basert på denne mekanismen:


- Bobs nøkkelpar :

$$ B = b \cdot G $$


- Alices nøkkelpar :

$$ A = a \cdot G $$


- For en hemmelighet $S (x, y)$ :

$$ S = a \cdot B = a \cdot (b \cdot G) = (b \cdot a) \cdot G = b \cdot A $$$

![BTC204](assets/fr/228.webp)

Nå som Bob kjenner Alices betalingskode, vil han kunne oppdage BIP47-betalingene hennes, og han vil kunne utlede de private nøklene som blokkerer de mottatte bitcoinsene.

Jeg skal oppsummere trinnene vi nettopp har sett sammen for å motta og tolke en varslingstransaksjon:


- Bob overvåker transaksjonsutgangen til varslingsadressen sin;
- Når den oppdager en, henter den informasjonen som finnes i OP_RETURN ;
- Bob velger den offentlige nøkkelen som input og beregner et hemmelig punkt ved hjelp av ECDH ;
- Den bruker dette hemmelige punktet til å beregne en HMAC, som er blindingsfaktoren;
- Den bruker denne blindingfaktoren til å dekryptere Alices betalingskode i OP_RETURN.

![BTC204](assets/fr/229.webp)

### BIP47-betalingstransaksjonen

La oss ta en titt på betalingsprosessen med BIP47. For å minne deg på den nåværende situasjonen :


- Alice kjenner Bobs betalingskode, som hun ganske enkelt har hentet fra nettstedet hans;
- Bob kjenner Alices betalingskode fra varslingstransaksjonen;
- Alice foretar sin første betaling til Bob. Hun kan gjøre mange flere på samme måte.

Før jeg forklarer denne prosessen, tror jeg det er viktig å huske hvilke indekser vi jobber med for øyeblikket. Avledningsstien for en betalingskode er beskrevet som følger: `m/47'/0'/0'`. Følgende dybde deler indeksene på følgende måte:


- Det første normale (ikke-forsterkede) datterparet er det som brukes til å generere varslingsadressen som ble diskutert i forrige avsnitt: `m/47'/0'/0'/0'/0` ;
- Normale datternøkkelpar brukes i ECDH for å generere BIP47-betalingskvitteringsadresser, som vi skal se i dette avsnittet: fra `m/47'/0'/0'/0'/0` til `m/47'/0'/0'/0'/2,147,483,647` ;
- Forsterkede datternøkkelpar er kortvarige betalingskoder: fra `m/47'/0'/0'/0'/0'` til `m/47'/0'/0'/0'/2,147,483,647'`.

Hver gang Alice ønsker å sende en betaling til Bob, utleder hun en ny, unik, tom adresse, nok en gang ved hjelp av ECDH-protokollen:


- Alice velger den første private nøkkelen som er avledet fra hennes personlige gjenbrukbare betalingskode :

$$ a $$


- Alice velger den første ubrukte offentlige nøkkelen som er avledet fra Bobs betalingskode. Vi kaller denne offentlige nøkkelen $B$. Den er knyttet til den private nøkkelen $b$, som bare Bob kjenner til:

$$ B = b \cdot G $$


- Alice beregner et hemmelig punkt $S$ på den elliptiske kurven ved å legge til og doble punkter ved å bruke sin private nøkkel $a$ fra Bobs offentlige nøkkel $B$ :

$$ S = a \cdot B $$


- Fra dette hemmelige punktet beregner Alice den delte hemmeligheten $s$ (små bokstaver). For å gjøre dette velger hun abscissen til det hemmelige punktet $S$, kalt $Sx$, og sender denne verdien til SHA256-hashfunksjonen:

$$ S = (Sx, Sy) $$

$$ s = \text{SHA256}(Sx) $$


- Alice bruker denne delte hemmeligheten $s$ til å beregne en mottaksadresse for Bitcoin-betaling. Først sjekker hun at $s$ finnes i rekkefølgen på secp256k1-kurven. Hvis dette ikke er tilfelle, øker hun Bobs offentlige nøkkelindeks for å utlede en annen delt hemmelighet ;
- I et andre trinn beregner hun en offentlig nøkkel $K0$ ved å legge til punktene $B$ og $s-G$ på den elliptiske kurven. Med andre ord legger Alice til den offentlige nøkkelen som er utledet fra Bobs betalingskode $B$, til et annet punkt som er beregnet på den elliptiske kurven ved å legge til og doble punkter med den delte hemmeligheten $s$ fra secp256k1-kurvens generatorpunkt $G$. Dette nye punktet representerer en offentlig nøkkel, og vi kaller det $K0$ :

$$ K0 = B + s \cdot G $$$


- Med denne offentlige nøkkelen $K0$ kan Alice utlede en tom mottaksadresse på standard måte (f.eks. SegWit V0 i bech32).

Når Alice har fått tak i Bobs $K0$-mottakeradresse, kan hun utføre en Bitcoin-transaksjon på standard måte. For å gjøre dette velger hun en UTXO hun eier, sikret med et nøkkelpar fra en annen gren av HD-lommeboken sin, og bruker den for å tilfredsstille en utbetaling til Bobs $K0$-adresse. Det er viktig å merke seg at denne betalingen, etter at adressen er utledet, følger en klassisk prosess og ikke lenger er avhengig av nøklene som er knyttet til BIP47.

Jeg skal oppsummere trinnene vi nettopp har sett sammen for å sende en BIP47-betaling:


- Alice velger den første private datternøkkelen som er avledet fra hennes personlige betalingskode ;
- Den beregner et hemmelig punkt på den elliptiske kurven ved hjelp av ECDH fra den første ubrukte offentlige datternøkkelen som er utledet fra Bobs betalingskode;
- Den bruker dette hemmelige punktet til å beregne en delt hemmelighet med SHA256 ;
- Hun bruker denne delte hemmeligheten til å beregne et nytt hemmelig punkt på den elliptiske kurven;
- Hun legger dette nye hemmelige punktet til Bobs offentlige nøkkel;
- Hun får en ny, kortvarig offentlig nøkkel som bare Bob har den tilhørende private nøkkelen til;
- Alice kan foreta en klassisk transaksjon til Bob med den avledede efemeriske mottaksadressen.

![BTC204](assets/fr/230.webp)

Hvis Alice ønsker å foreta en ny betaling, følger hun de samme trinnene som før, bortsett fra at hun denne gangen velger den andre offentlige nøkkelen som er avledet fra Bobs betalingskode. Nærmere bestemt vil hun bruke den neste ubrukte nøkkelen. På denne måten får hun en ny mottakeradresse som tilhører Bob, kalt $K1$ :

![BTC204](assets/fr/231.webp)

Den kan fortsette på denne måten og utlede opptil `2^32` tomme adresser som tilhører Bob.

Fra et utenforstående perspektiv, som ser på blokkjeden, er det i teorien umulig å skille en BIP47-betaling fra en konvensjonell betaling. Her er et eksempel på en BIP47-betalingstransaksjon på Testnet:

```text
94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
```

Det ser ut som en klassisk transaksjon med en konsumert inngang, en betalingsutgang og en valutakurs:

![BTC204](assets/fr/232.webp)

### Mottak av BIP47-betaling og utledning av privat nøkkel

Alice har nettopp foretatt sin første betaling til en tom BIP47-adresse som tilhører Bob. La oss nå se hvordan Bob mottar denne betalingen. Vi skal også se hvorfor Alice ikke har tilgang til den private nøkkelen til adressen hun nettopp har generert selv, og hvordan Bob finner denne nøkkelen for å bruke bitcoinsene han nettopp har mottatt.

Så snart Bob mottar transaksjonsvarslingen fra Alice, utleder han den offentlige nøkkelen BIP47 $K0$ allerede før korrespondenten hans har sendt en betaling. Han observerer derfor enhver betaling til den tilknyttede adressen. Faktisk utleder han umiddelbart flere adresser som han observerer ($K0$, $K1$, $K2$, $K3$...). Slik utledes denne offentlige nøkkelen $K0$ :


- Bob velger den første private nøkkelen som er avledet fra betalingskoden hans. Denne private nøkkelen heter $b$. Den er knyttet til den offentlige nøkkelen $B$ som Alice foretok beregningene sine med i forrige trinn:

$$ b $$


- Bob velger Alices første offentlige nøkkel som er avledet fra betalingskoden hennes. Denne nøkkelen heter $A$. Den er knyttet til den private nøkkelen $a$ som Alice foretok beregningene sine med, og som bare Alice kjenner til. Bob kan utføre denne prosessen, siden han kjenner Alices betalingskode, som ble sendt til ham sammen med meldingstransaksjonen:

$$ A = a \cdot G $$


- Bob beregner det hemmelige punktet $S$, ved å legge til og doble punkter på den elliptiske kurven, ved å bruke sin private nøkkel $b$ til Alices offentlige nøkkel $A$. Også her brukes ECDH for å garantere at dette punktet $S$ vil være det samme for både Bob og Alice:

$$ S = b \cdot A $$


- På samme måte som Alice isolerer Bob abscissen til dette punktet $S$. Vi har kalt denne verdien $Sx$. Han sender denne verdien til SHA256-funksjonen for å finne den delte hemmeligheten $s$ (små bokstaver):

$$ s = \text{SHA256}(Sx) $$


- På samme måte som Alice beregner Bob $s-G$-punktet på den elliptiske kurven. Deretter legger han dette hemmelige punktet til sin offentlige nøkkel $B$. Deretter får han et nytt punkt på den elliptiske kurven, som han tolker som en offentlig nøkkel $K0$ :

$$ K0 = B + s \cdot G $$$

Når Bob har denne offentlige nøkkelen $K0$, kan han utlede den tilhørende private nøkkelen for å bruke bitcoinsene sine. Bare han kan generere denne private nøkkelen:


- Bob legger sammen datterens private nøkkel $b$ som er utledet fra hans personlige betalingskode. Bare han kan få tak i verdien av $b$. Deretter legger han $b$ til den delte hemmeligheten $s$ for å få $k0$, $K0$s private nøkkel:

$$ k0 = b + s $$

Takket være gruppeloven for den elliptiske kurven får Bob nøyaktig den private nøkkelen som svarer til den offentlige nøkkelen som Alice bruker. Vi har derfor :

$$ K0 = k0 \cdot G $$

Jeg skal oppsummere trinnene vi nettopp har sett sammen for å motta en BIP47-betaling og beregne den tilhørende private nøkkelen:


- Bob velger den første private datternøkkelen som er avledet fra hans personlige betalingskode ;
- Den beregner et hemmelig punkt på den elliptiske kurven ved hjelp av ECDH fra den første offentlige nøkkelen som er utledet fra Alices strengkode;
- Den bruker dette hemmelige punktet til å beregne en delt hemmelighet med SHA256 ;
- Han bruker denne delte hemmeligheten til å beregne et nytt hemmelig punkt på den elliptiske kurven;
- Han legger dette nye hemmelige punktet til sin personlige offentlige nøkkel;
- Han får en ny, kortvarig offentlig nøkkel, som Alice skal sende sin første betaling til;
- Bob beregner den private nøkkelen som er knyttet til denne kortvarige offentlige nøkkelen, ved å legge til den private nøkkelen til datteren sin, som er utledet fra betalingskoden og den delte hemmeligheten.

![BTC204](assets/fr/233.webp)

Siden Alice ikke kan få tak i $b$ (Bobs private nøkkel), kan hun heller ikke finne ut $k0$ (den private nøkkelen som er knyttet til Bobs BIP47-mottaksadresse). Skjematisk kan vi representere beregningen av den delte hemmeligheten $S$ på følgende måte:

![BTC204](assets/fr/228.webp)

Når den delte hemmeligheten er funnet med ECDH, beregner Alice og Bob den offentlige BIP47-betalingsnøkkelen $K0$, og Bob beregner også den tilhørende private nøkkelen $k0$ :

![BTC204](assets/fr/234.webp)

### Tilbakebetaling av BIP47-betaling

Siden Bob kjenner Alices gjenbrukbare betalingskode, har han allerede all informasjonen han trenger for å sende henne en refusjon. Han trenger ikke å kontakte Alice igjen for å be om informasjon. Han trenger bare å varsle henne med en varslingstransaksjon, slik at hun kan hente BIP47-adressene sine med seed, og så kan han også sende henne opptil `2^32` betalinger.

Refusjonsfunksjonen er spesifikk for BIP47 og er en av fordelene med BIP47 sammenlignet med andre metoder, for eksempel Silent Payments, som vi skal se nærmere på i senere kapitler.

Bob kan deretter betale Alice tilbake på samme måte som hun sendte ham betalinger. Rollene er byttet om:

![BTC204](assets/fr/235.webp)

*Tusen takk til [Fanis Michalakis] (https://x.com/FanisMichalakis) for korrekturlesing og ekspertråd om artikkelen som inspirerte til dette kapittelet!

https://planb.network/tutorials/privacy/on-chain/paynym-bip47-a492a70b-50eb-4f95-a766-bae2c5535093

## Stille betalinger

<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>


BIP47 har fått mye kritikk for sin ineffektivitet i kjeden. Som forklart i forrige kapittel, krever det en varslingstransaksjon for hver nye mottaker. Denne begrensningen blir ubetydelig hvis vi planlegger å etablere en bærekraftig betalingskanal med denne mottakeren. En enkelt varslingstransaksjon baner nemlig vei for et nesten uendelig antall påfølgende BIP47 -betalinger.

I visse situasjoner kan imidlertid varslingstransaksjonen være et hinder for brukeren. La oss ta et eksempel på en engangsdonasjon til en mottaker: Med en klassisk Bitcoin-adresse er det nok med én enkelt transaksjon for å fullføre donasjonen. Men med BIP47 kreves det to transaksjoner: én for varslingen og én for selve betalingen. Når etterspørselen etter blokkplass er lav og transaksjonsgebyrene lave, er dette ekstra trinnet vanligvis ikke noe problem. I tider med overbelastning kan imidlertid transaksjonsgebyrene bli ublu for en enkelt betaling, noe som potensielt fordobler kostnaden for brukeren sammenlignet med en standard Bitcoin-transaksjon, noe som kan være uakseptabelt for brukeren.

For situasjoner der brukeren planlegger å foreta bare noen få betalinger til en statisk identifikator, er det utviklet andre løsninger. Blant disse er Silent Payments, som er beskrevet i [BIP352] (https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki). Denne protokollen gjør det mulig å bruke en statisk identifikator til å motta betalinger uten at det oppstår gjenbruk av adresser, og uten at det er nødvendig å bruke varslingstransaksjoner. La oss ta en titt på hvordan denne protokollen fungerer.

---
*For å forstå dette kapittelet fullt ut, er det viktig å forstå hvordan ECDH (Elliptic Curve Diffie-Hellman) og utledning av kryptografiske nøkler i en HD-lommebok fungerer. Disse konseptene ble beskrevet i detalj i forrige kapittel om BIP47. Jeg vil ikke gjenta dem her. Hvis du ennå ikke er kjent med disse konseptene, anbefaler jeg at du leser det forrige kapittelet før du fortsetter med dette. Jeg vil ikke gå tilbake til risikoen forbundet med gjenbruk av mottaksadresser eller viktigheten av å ha en unik identifikator for mottak av betalinger*, men jeg vil bare nevne noen få punkter som jeg ønsker å ta opp her

---
### Hvorfor ikke flytte varslingen?

Som beskrevet i kapittelet om BIP47 har varslingstransaksjonen to hovedfunksjoner:


- Den varsler mottakeren ;
- Den overfører avsenderens betalingskode.

Man kan naivt tro at denne varslingsprosessen kan utføres utenfor kjeden. I teorien er det fullt mulig: Alt mottakeren trenger å gjøre, er å angi et kommunikasjonsmiddel for å motta BIP47-betalingskodene fra avsenderne. Det er imidlertid to store problemer med denne tilnærmingen:


- For det første ville det flytte kodeoverføringsprosessen til en annen kommunikasjonsprotokoll. Problemer knyttet til kostnader og konfidensialitet i forbindelse med utvekslingen vil bestå, men vil bare bli overført til denne nye protokollen. Når det gjelder konfidensialitet, kan dette også skape en kobling mellom en brukers identitet og aktivitet i blokkjeden, noe vi forsøker å unngå ved å utføre varslingen direkte i blokkjeden. Videre vil varsling utenfor blokkjeden medføre risiko for sensur (for eksempel blokkering av midler) som ikke finnes i Bitcoin;
- For det andre vil dette utgjøre et tilbakebetalingsproblem. Med BIP47 må mottakeren kjenne betalingskodene til avsenderne for å få tilgang til midlene. Dette gjelder ved mottak, men også i tilfelle pengene blir gjenopprettet via seed hvis lommeboken går tapt. Med onchain-varsler unngås denne risikoen, ettersom brukeren kan hente og dekryptere varslingstransaksjoner bare ved å kjenne seed-koden sin. Hvis varslingen derimot skjer utenfor blokkjeden, må brukeren vedlikeholde en dynamisk sikkerhetskopi av alle mottatte betalingskoder, noe som er upraktisk for den gjennomsnittlige brukeren.

Alle disse begrensningene gjør bruken av onchain-varsling avgjørende for BIP47. Silent Payments ønsker imidlertid å unngå dette trinnet i kjedevarslingen nettopp på grunn av kostnadene. Løsningen som er valgt, er derfor ikke å flytte varslingen, men å eliminere den helt. For å oppnå dette må et kompromiss aksepteres: skanning. I motsetning til BIP47, der brukeren vet nøyaktig hvor han kan finne pengene sine takket være varslingstransaksjoner, må brukeren med Silent Payments undersøke alle eksisterende Bitcoin-transaksjoner for å oppdage eventuelle betalinger som er ment for ham. For å redusere denne operasjonelle byrden er Silent Payments-søket begrenset til transaksjoner som sannsynligvis inneholder slike betalinger, dvs. de med minst én Taproot P2TR-utgang. Skanningen fokuserer også utelukkende på transaksjoner fra lommebokens opprettelsesdato (det er ikke nødvendig å skanne transaksjoner tilbake til 2009 hvis lommeboken ble opprettet i 2024).

Så du kan se hvorfor BIP47 og Silent Payments, selv om de har samme mål, innebærer ulike avveininger og derfor **faktisk oppfyller forskjellige bruksområder**. For engangsbetalinger, for eksempel engangsdonasjoner, er stille betalinger mer hensiktsmessige på grunn av de lavere kostnadene. For regelmessige transaksjoner til samme mottaker, som for eksempel utvekslingsplattformer eller gruvebassenger, kan BIP47 derimot være å foretrekke.

La oss ta en titt på den tekniske driften av Silent Payments for å bedre forstå hva som står på spill. For å gjøre dette foreslår jeg at vi bruker samme fremgangsmåte som i det forklarende dokumentet til BIP352. Vi bryter gradvis ned beregningene som skal utføres, element for element, og begrunner hvert nye tillegg.

### Noen begreper som er viktige å forstå

Før vi går i gang, er det viktig å påpeke at Silent Payments utelukkende baserer seg på bruk av P2TR (*Pay to Taproot*) skripttyper. I motsetning til BIP47 er det ikke nødvendig å utlede mottakeradresser fra offentlige nøkler for barn ved hashing. I P2TR-standarden brukes den finjusterte offentlige nøkkelen direkte og ukryptert i adressen. En Taproot-mottakeradresse er altså egentlig en offentlig nøkkel med noen metadata. Denne justerte offentlige nøkkelen er en aggregering av to andre offentlige nøkler: én som muliggjør direkte, tradisjonell bruk via en enkel signatur, og én som representerer Merkle-roten i MAST, som autoriserer bruk under forutsetning av at en av betingelsene som potensielt er innskrevet i Merkle-treet, er oppfylt.

![BTC204](assets/fr/068.webp)

Det er to hovedgrunner til at Silent Payments er begrenset til Taproot:


- For det første forenkler det implementeringen og fremtidige oppgraderinger av porteføljeprogramvare betraktelig, siden det bare er én standard som må overholdes;
- For det andre bidrar denne tilnærmingen til å forbedre brukernes anonset ved å oppmuntre dem til ikke å dele seg mellom ulike typer skript, noe som genererer forskjellige porteføljefingeravtrykk i kjedeanalysen (for mer informasjon om dette konseptet, se kapittel 4 i del 2).

### Naiv utledning av en offentlig nøkkel for Silent Payments

La oss starte med et enkelt eksempel for å komme til kjernen av hvordan SP-er (Silent Payments) fungerer. La oss ta Alice og Bob, to Bitcoin-brukere. Alice ønsker å sende Bitcoins til Bob på en tom mottakeradresse. Det er tre mål med denne prosessen:


- Alice må kunne generere en tom adresse;
- Bob må kunne identifisere en betaling som er sendt til denne spesifikke adressen;
- Bob må kunne få tak i den private nøkkelen som er knyttet til denne adressen, for å kunne bruke pengene sine.

Alice har en UTXO i sin sikre Bitcoin-lommebok med følgende nøkkelpar:


- $a$: den private nøkkelen ;
- $A$: den offentlige nøkkelen ($A = a \cdot G$)

Bob har en SP-adresse som han har publisert på Internett med :


- $b$: den private nøkkelen ;
- $B$: den offentlige nøkkelen ($B = b \cdot G$)

Ved å hente Bobs adresse kan Alice beregne en ny tom adresse som tilhører Bob, ved hjelp av ECDH. La oss kalle denne adressen $P$ :

$$ P = B + \text{hash}(a \cdot B) \cdot G $$$

I denne ligningen har Alice ganske enkelt beregnet skalarproduktet av sin private nøkkel $a$ og Bobs offentlige nøkkel $B$. Hun har sendt dette resultatet inn i en hashfunksjon som er kjent for alle. Den resulterende verdien multipliseres deretter skalarisk med det genererende punktet $G$ i den elliptiske kurven `secp256k1`. Til slutt legger Alice det resulterende punktet til Bobs offentlige nøkkel $B$. Når Alice har denne adressen $P$, bruker hun den som output i en transaksjon, dvs. at hun sender bitcoins til den.

> *I forbindelse med Silent Payments tilsvarer "hash"-funksjonen en SHA256-hashfunksjon som er spesielt merket med `BIP0352/SharedSecret`, som sikrer at hashene som genereres er unike for denne protokollen og ikke kan gjenbrukes i andre sammenhenger, samtidig som de gir ekstra beskyttelse mot gjenbruk av nonces i signaturer. Denne standarden tilsvarer den [spesifisert i BIP340 for Schnorr-signaturer](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) på `secp256k1`
Takket være egenskapene til den elliptiske kurven som ECDH er basert på, vet vi at :

$$ a \cdot B = b \cdot A $$$

Bob vil derfor kunne beregne mottakeradressen som Alice har sendt bitcoinsene til. For å gjøre dette overvåker han alle Bitcoin-transaksjoner som oppfyller kriteriene for Silent Payments, og bruker følgende beregning på hver av dem for å se om betalingen er adressert til ham (*scanning*):

$$ P' = B + \text{hash}(b \cdot A) \cdot G $$$

Når han skanner Alices transaksjon, innser han at $P'$ er lik $P$. Han vet derfor at betalingen er adressert til henne:

$$ P' = B + \text{hash}(b \cdot A) \cdot G = B + \text{hash}(a \cdot B) \cdot G = P $$$

Herfra vil Bob kunne beregne den private nøkkelen $p$ som gjør det mulig å bruke adressen $P$:

$$ p = (b + \text{hash}(b \cdot A)) \bmod n $$

Som du kan se, må du ha den private nøkkelen $b$ for å beregne denne private nøkkelen $p$. Bare Bob har denne private nøkkelen $b$. Han vil derfor være den eneste som kan bruke bitcoinsene som sendes til hans Silent Payments-adresse.

![BTC204](assets/fr/236.webp)

*Legend:*


- $B$ : Den offentlige nøkkelen/statiske adressen publisert av Bob
- $b$ : Bobs private nøkkel
- $A$ : Alices offentlige UTXO-nøkkel brukes som transaksjonsinndata
- $a$ : Alices private nøkkel
- $G$ : Det genererende punktet til den elliptiske kurven `secp256k1`
- $\text{SHA256}$ : SHA256-hashfunksjonen merket med `BIP0352/SharedSecret`
- $s$ : ECDHs felles hemmelighet
- $P$ : Den offentlige nøkkelen/unike adressen for betaling til Bob

Her er en ganske naiv innledende tilnærming til å bruke Bobs statiske adresse, notert $B$, til å utlede en unik adresse $P$ å sende bitcoins til. Denne metoden er imidlertid for enkel og har flere feil som må rettes opp. Det første problemet er at Alice ikke kan opprette flere utganger til Bob innenfor samme transaksjon.

### Hvordan oppretter jeg flere utganger?

I eksempelet i forrige avsnitt oppretter Alice en enkelt utdata som går til Bob på hans unike adresse $P$. Med samme inndata er det umulig for Alice å opprette to separate, tomme adresser for Bob, ettersom metoden som brukes alltid vil føre til samme resultat for $P$, dvs. samme adresse. Det kan imidlertid oppstå mange situasjoner der Alice ønsker å dele opp betalingen til Bob i flere mindre beløp, og dermed opprette flere UTXO-er. Det er derfor nødvendig å finne en metode for å oppnå dette.

For å oppnå dette skal vi endre litt på beregningen Alice utfører for å utlede $P$, slik at hun kan generere to forskjellige adresser for Bob, nemlig $P_0$ og $P_1$.

Hvis du vil endre beregningen og få to forskjellige adresser, legger du ganske enkelt til et heltall som endrer resultatet. Alice vil dermed legge til $0$ i beregningen for å få adressen $P_0$ og $1$ for å få adressen $P_1$. La oss kalle dette heltallet $i$ :

$$ P_i = B + \text{hash}(a \cdot B \text{ ‖ } i) \cdot G $$

Beregningsprosessen forblir uendret fra den forrige metoden, bortsett fra at Alice denne gangen vil sammenkoble $a \cdot B$ med $i$ før hun fortsetter med hashen. Deretter endrer du ganske enkelt $i$ for å få en ny adresse som tilhører Bob. For eksempel

$$ P_0 = B + \text{hash}(a \cdot B \text{ ‖ } 0) \cdot G $$

$$ P_1 = B + \text{hash}(a \cdot B \text{ ‖ } 1) \cdot G $$

Når Bob skanner blokkjeden etter Stille betalinger som er beregnet på ham, starter han med å bruke $i = 0$ for adressen $P_0$. Hvis han ikke finner noen betalinger på $P_0$, konkluderer han med at denne transaksjonen ikke inneholder noen stille betalinger som er ment for ham, og avbryter skanningen. Hvis $P_0$ derimot er gyldig og inneholder en betaling til ham, fortsetter han med $P_1$ i samme transaksjon for å sjekke om Alice har foretatt en ny betaling. Hvis $P_1$ viser seg å være ugyldig, slutter den å søke etter denne transaksjonen, ellers fortsetter den å teste påfølgende $i$-verdier:

$$ P_0 = B + \text{hash}(b \cdot A \text{ ‖ } 0) \cdot G $$

$$ P_1 = B + \text{hash}(b \cdot A \text{ ‖ } 1) \cdot G $$

Siden Bob stopper umiddelbart ved $i = 0$ hvis $P_0$ ikke fungerer, tilfører bruken av dette heltallet nesten ingen ekstra driftsbelastning på Bob for transaksjonsskanningsfasen.

Bob kan deretter beregne de private nøklene på samme måte:

$$
p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n
$$

$$
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n
$$

![BTC204](assets/fr/237.webp)

*Legend:*


- $B$ : Den offentlige nøkkelen/statiske adressen publisert av Bob
- $b$ : Bobs private nøkkel
- $A$ : Alices offentlige UTXO-nøkkel brukes som transaksjonsinndata
- $a$ : Alices private nøkkel
- $G$ : Det genererende punktet til den elliptiske kurven `secp256k1`
- $\text{SHA256}$ : SHA256-hashfunksjonen merket med `BIP0352/SharedSecret`
- $s_0$ : Den første felles hemmeligheten ECDH
- $s_1$ : Den andre felles ECDH-hemmeligheten
- $P_0$ : Den første offentlige nøkkelen / unike adressen for betaling til Bob
- $P_1$ : Den andre offentlige nøkkelen / unike adressen for betaling til Bob

Med denne metoden begynner vi å få en fin protokoll, men det er fortsatt noen utfordringer å overvinne, ikke minst det å hindre gjenbruk av adresser.

### Hvordan unngå gjenbruk av adresser?

Som vi så i de foregående avsnittene, bruker Alice nøkkelparet som sikrer UTXO-en hennes, til å beregne den delte ECDH-hemmeligheten med Bob. Denne hemmeligheten gjør henne i stand til å utlede den unike adressen $P_0$. Nøkkelparet ($a$, $A$) som Alice bruker, kan imidlertid sikre flere UTXO-er hvis hun har gjenbrukt denne adressen flere ganger. Hvis Alice foretar to betalinger til Bobs statiske adresse $B$ ved hjelp av to UTXOer som er sikret med samme nøkkel $A$, vil dette resultere i gjenbruk av adressen for Bob.

> *Gjenbruk av adresser er en svært uheldig praksis med tanke på brukernes konfidensialitet. For å finne ut hvorfor, anbefaler jeg deg å gå gjennom de første delene av dette kurset
Siden den unike adressen $P_0$ er avledet fra $A$ og $B$, vil Alice, hvis hun avleder en ny adresse for en ny betaling til $B$, med samme nøkkel $A$, ende opp på nøyaktig samme adresse $P_0$. For å unngå denne risikoen og forhindre gjenbruk av adresser i Silent Payments, må vi endre beregningene våre litt.

Det vi ønsker, er at hver UTXO som Alice bruker som input til en betaling, skal gi en unik adresse på Bobs side, selv om flere UTXO-er er sikret med det samme nøkkelparet. Så alt vi trenger å gjøre er å legge til en referanse til UTXO-en når vi beregner den unike adressen $P_0$. Denne referansen vil ganske enkelt være hashen til UTXO-en som brukes som input:

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$$

Og Alice vil legge til denne referansen i inndataene til sin beregning av den unike adressen $P_0$ :

$$ P_0 = B + \text{hash}(\text{inputHash} \cdot a \cdot B \text{ ‖ } 0) \cdot G $$$

Ved skanning kan Bob også legge til $\text{inputHash}$, siden alt han trenger å gjøre er å observere transaksjonen for å utlede $\text{outpoint}$ :

$$ P_0 = B + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0) \cdot G $$$

Når den finner en gyldig $P_0$, kan den beregne den tilsvarende private nøkkelen $p_0$:

$$
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
$$

![BTC204](assets/fr/238.webp)

*Legend:*


- $B$ : Den offentlige nøkkelen/statiske adressen publisert av Bob
- $b$ : Bobs private nøkkel
- $A$ : Alices offentlige UTXO-nøkkel brukes som transaksjonsinndata
- $a$ : Alices private nøkkel
- $H$ : UTXO-hash som brukes som input
- $G$ : Det genererende punktet til den elliptiske kurven `secp256k1`
- $\text{SHA256}$ : SHA256-hashfunksjonen merket med `BIP0352/SharedSecret`
- $s_0$ : Den første felles ECDH-hemmeligheten
- $P_0$ : Den første offentlige nøkkelen / unike adressen for betaling til Bob

I beregningene våre antar vi foreløpig at Alice bruker én enkelt inndata for transaksjonen sin. Hun bør imidlertid kunne bruke flere inndata. For hver transaksjon som involverer flere inndata, må Bob teoretisk sett beregne ECDH for hver enkelt inndata for å avgjøre om en betaling er tiltenkt ham. Denne metoden er ikke tilfredsstillende, så vi må finne en løsning for å redusere arbeidsmengden!

### Tilpasning av offentlige nøkler til inndata

For å løse dette problemet bruker vi summen av alle nøkkelparene som brukes i transaksjonens inndata, i stedet for å bruke nøkkelparet som sikrer en spesifikk inndata på Alices side. Denne summen vil da bli betraktet som et nytt nøkkelpar. Denne teknikken er kjent som "tweaking".

La oss for eksempel tenke oss at Alices transaksjon har tre innganger, hver sikret med et annet nøkkelpar:


- $a_0$ brukes til å sikre inndata #0 ;
- $a_1$ brukes til å sikre inngang #1;
- $a_2$ sikrer inngang nr. 2.

![BTC204](assets/fr/239.webp)

Ved å følge den tidligere beskrevne metoden må Alice velge ett enkelt nøkkelpar blant $a_0$, $a_1$ og $a_2$ for å beregne ECDH-hemmeligheten og generere den enkle betalingsadressen $P$ fra Bobs statiske adresse $B$. Denne tilnærmingen krever imidlertid at Bob tester hver mulighet sekvensielt, og starter med $a_0$, deretter $a_1$ og så videre, helt til han finner et par som genererer en gyldig $P$-adresse. Denne prosessen krever at Bob kjører ECDH-beregningen på alle inndataene til alle transaksjonene, noe som øker den operasjonelle belastningen ved skanning betraktelig.

For å unngå dette ber vi Alice om å beregne $P$ ved hjelp av summen av alle inndatanøklene. I vårt eksempel vil den justerte private nøkkelen $a$ bli beregnet på følgende måte:

$$ a = a_0 + a_1 + a_2 $$ $$ a = a_0 + a_1 + a_2

På samme måte kan Alice og Bob beregne den justerte offentlige nøkkelen:

$$ A = A_0 + A_1 + A_2 $$ $$ A = A_0 + A_1 + A_2

Med denne metoden trenger Bob bare å beregne summen av transaksjonens offentlige nøkler, og deretter beregne ECDH-hemmeligheten fra $A$ alene, noe som reduserer antallet beregninger som kreves for skanningstrinnet betraktelig.

Husk imidlertid forrige avsnitt. Vi hadde lagt til $\text{inputHash}$-hash i beregningen vår, som brukes som en nonce for å unngå gjenbruk av adresser:

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$$

Men hvis du har flere innganger i en transaksjon, må du kunne bestemme hvilken $\text{outpoint}$ som skal velges i denne beregningen. I henhold til BIP352 er kriteriet for valg av $\text{outpoint}$ å velge den minste leksikografisk, det vil si å velge den UTXO-en som kommer først i alfabetisk rekkefølge. Denne metoden standardiserer UTXO-en som skal velges i hver transaksjon. Hvis for eksempel den leksikografisk minste $\text{outpoint}$ er $\text{outpoint}_L$, vil beregningen av $\text{inputHash}$ være :

$$ \text{inputHash} = \text{hash}(\text{outpoint}_L \text{ ‖ } A) $$$

Beregningene er da identiske med dem som ble presentert i forrige avsnitt, bortsett fra at den private nøkkelen $a$ og den tilsvarende offentlige nøkkelen $A$ ikke lenger er et par som brukes til å sikre en enkelt inndata, men nå representerer justeringen for alle nøkkelpar i inndataene.

### Separate utgifts- og skannetaster

Inntil videre har vi referert til den statiske adressen $B$ for stille betaling som en unik offentlig nøkkel. Husk at det er denne offentlige nøkkelen $B$ som Alice bruker til å opprette den delte hemmeligheten ECDH, som i sin tur beregner den unike betalingsadressen $P$. Bob bruker denne offentlige nøkkelen $B$ og den tilsvarende private nøkkelen $b$ til skanningstrinnet. Men han vil også bruke den private nøkkelen $b$ til å beregne den private nøkkelen $p$ som gjør det mulig å bruke penger fra adressen $P$.

Ulempen med denne metoden er at den private $b$-nøkkelen, som brukes til å beregne alle de private nøklene til adressene som har mottatt Silent Payments, også brukes av Bob til å skanne transaksjonene. Dette trinnet krever at $b$-nøkkelen er tilgjengelig i en Internett-tilkoblet lommebokprogramvare, noe som gjør den mer utsatt for tyveri enn om den oppbevares i en kald lommebok. Ideelt sett ville det vært fordelaktig å kunne dra nytte av Silent Payments samtidig som den private $b$-nøkkelen, som kontrollerer tilgangen til alle andre private nøkler, er sikret i en maskinvarelommebok. Heldigvis er protokollen tilpasset for å tillate nettopp dette.

For å gjøre dette krever BIP352 at mottakeren bruker to forskjellige nøkkelpar:


- b_{\text{spend}}$: for å beregne de private nøklene til unike betalingsadresser;
- b_{\text{scan}}$: for å finne unike betalingsadresser.

På denne måten kan Bob oppbevare den private nøkkelen $b_{\text{spend}}$ i en maskinvarelommebok og bruke den private nøkkelen $b_{\text{scan}}$ i programvare på nettet for å finne sine stille betalinger, uten å avsløre $b_{\text{spend}}$. På den annen side er de offentlige nøklene $B_{\text{scan}}$ og $B_{\text{spend}}$ begge offentlig avslørt, siden de befinner seg i Bobs statiske adresse $B$ :

$$ B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}} $$

For å beregne en unik betalingsadresse $P_0$ som tilhører Bob, vil Alice nå utføre følgende beregning:

$$ P_0 = B_{\text{spend}} + \text{hash}(\text{inputHash} \cdot a \cdot B_{\text{scan}} \text{ ‖ } 0) \cdot G $$$

For å finne ut hvilke betalinger som er adressert til ham, utfører Bob følgende beregning:

$$ P_0 = B_{\text{spend}} + \text{hash}(\text{inputHash} \cdot b_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$$

Som du kan se, har Bob så langt ikke hatt behov for å bruke $b_{\text{spend}}$, som ligger på maskinvarelommeboken hans. Når han ønsker å bruke $P_0$, kan han gjøre følgende beregning for å finne den private nøkkelen $p_0$ :

$$ p_0 = (b_{\text{spend}} + \text{hash}(\text{inputHash} \cdot b_{\text{scan}} \cdot A \text{ ‖ } 0)) \bmod n $$$

![BTC204](assets/fr/240.webp)

*Legend:*


- $B_{\text{scan}}$: Bobs offentlige skannøkkel (statisk adresse)
- $b_{\text{scan}}$ : Bobs private skannøkkel
- $B_{\text{spend}}$ : Bobs offentlige utgiftsnøkkel (statisk adresse)
- $b_{\text{spend}}$ : Bobs private utgiftsnøkkel
- $A$ : Summen av offentlige nøkkelinnganger (tweak)
- $a$ : Den private nøkkelen som svarer til den justerte offentlige nøkkelen
- $H$ : Hashverdien til den minste UTXO-en (leksikografisk) som brukes som inndata
- $G$ : Det genererende punktet til den elliptiske kurven `secp256k1`
- $\text{SHA256}$ : SHA256-hashfunksjonen merket med `BIP0352/SharedSecret`
- $s_0$ : Den første felles hemmeligheten ECDH
- $P_0$ : Den første offentlige nøkkelen / unike adressen for betaling til Bob

### Bruke SP-adresser med en etikett

Bob har derfor en statisk adresse $B$ for stille betalinger som :

$$ B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}} $$

Problemet med denne metoden er at den ikke lar deg skille mellom de ulike betalingene som sendes til denne adressen. Hvis Bob for eksempel har to forskjellige kunder i virksomheten sin, og han ønsker å differensiere betalingene til hver av dem, trenger han to forskjellige statiske adresser. En naiv løsning, med dagens tilnærming, ville være at Bob oppretter to separate lommebøker med hver sin statiske adresse, eller til og med oppretter to forskjellige statiske adresser i samme lommebok. Denne løsningen krever imidlertid at hele blokkjeden skannes to ganger (én gang for hver adresse) for å oppdage betalinger til hver adresse. Denne doble skanningen øker Bobs driftsbelastning urimelig mye.

For å løse dette problemet bruker BIP352 et merkesystem som tillater forskjellige statiske adresser, uten å øke arbeidsmengden med å finne Silent Payments i blokkjeden urimelig mye. For å gjøre dette legger vi til et heltall $m$ i den offentlige utgiftsnøkkelen $B_{\text{spend}}$. Dette heltallet kan ha verdien $1$ for den første statiske adressen, deretter $2$ for den andre, og så videre. Utgiftsnøklene $B_{\text{spend}}$ vil nå bli kalt $B_m$ og vil bli konstruert på denne måten:

$$ B_m = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } m) \cdot G $$$

For eksempel, for den første utgiftsnøkkelen med etiketten $1$ :

$$ B_1 = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G $$$

Den statiske adressen som publiseres av Bob, vil nå bestå av $B_{\text{scan}}$ og $B_m$. For eksempel vil den første statiske adressen med etiketten $1$ være :

$$ B = B_{\text{scan}} \text{ ‖ } B_1 $$

> *Vi starter bare fra etikett 1 fordi etikett 0 er reservert for endringen
Alice vil på sin side utlede enkeltbetalingsadressen $P$ på samme måte som før, men ved å bruke den nye $B_1$ i stedet for $B_{\text{spend}}$ :

$$ P_0 = B_1 + \text{hash}(\text{inputHash} \cdot a \cdot B_{\text{scan}} \text{ ‖ } 0) \cdot G $$ $$

I virkeligheten vet Alice ikke engang nødvendigvis at Bob har en merket adresse, ettersom hun bare bruker den andre delen av den statiske adressen han oppga, og i dette tilfellet er det verdien $B_1$ i stedet for $B_{text{spend}}$.

For å skanne betalinger vil Bob alltid bruke verdien av sin opprinnelige statiske adresse med $B_{\text{spend}}$ på denne måten:

$$ P_0 = B_{\text{spend}} + \text{hash}(\text{inputHash} \cdot b_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$$

Deretter trekker han ganske enkelt fra verdien han finner for $P_0$ fra hver utgang én etter én. Deretter sjekker han om et av resultatene av disse subtraksjonene samsvarer med verdien til en av etikettene han bruker i porteføljen sin. Hvis for eksempel utdata nr. 4 samsvarer med $1$ -etiketten, betyr det at denne utdataen er en Silent Payment som er knyttet til den statisk merkede adressen $B_1$ :

$$ Out_4 - P_0 = \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G $$$

Det fungerer fordi :

$$ B_1 = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G $$$

Takket være denne metoden kan Bob bruke en rekke statiske adresser ($B_1$, $B_2$, $B_3$ ...), som alle er avledet fra hans grunnleggende statiske adresse ($B = B_{\tekst{scan}} \tekst{ ‖ } B_{\tekst{spend}}$), for å holde bruken atskilt.

Vær imidlertid oppmerksom på at denne separasjonen av statiske adresser kun er gyldig fra et personlig porteføljeforvaltningssynspunkt, men ikke skiller identiteter. Siden alle har samme $B_{\text{scan}}$, er det veldig enkelt å knytte alle statiske adresser sammen og utlede at de tilhører én og samme enhet.

![BTC204](assets/fr/241.webp)

*Legend:*


- $B_{\text{scan}}$: Bobs offentlige skannøkkel (statisk adresse)
- $b_{\text{scan}}$ : Bobs private skannøkkel
- $B_{\text{spend}}$ : Bobs offentlige utgiftsnøkkel (opprinnelig adresse)
- $B_m$ : Bobs offentlige utgiftsnøkkel merket (statisk adresse)
- $b_m$: Bobs private utgiftsnøkkel merket
- $A$ : Summen av offentlige nøkkelinnganger (tweak)
- $a$ : Den private nøkkelen som svarer til den justerte offentlige nøkkelen
- $H$ : Hashverdien til den minste UTXO-en (leksikografisk) som brukes som inndata
- $G$ : Det genererende punktet til den elliptiske kurven `secp256k1`
- $\text{SHA256}$ : SHA256-hashfunksjonen merket med `BIP0352/SharedSecret`
- $s_0$ : Den første felles ECDH-hemmeligheten
- $P_0$ : Den første offentlige nøkkelen / unike adressen for betaling til Bob
- $p_0$ : Den private nøkkelen til den første unike betalingsadressen til Bob
- $X$ : Hashverdien av den private skannøkkelen med etiketten

### Hvordan bygger jeg en Silent Payments-adresse?

For å opprette en adresse dedikert til Silent Payments, må du først utlede to nøkkelpar fra Bitcoin HD-lommeboken din:


- Paret $b_{\text{scan}}$, $B_{\text{scan}}$ for å søke etter betalinger adressert til oss;
- Paret $b_{\text{spend}}$, $B_{\text{spend}}$ for å tenke på bitcoinsene vi har mottatt.

Disse parene er utledet ved hjelp av følgende baner (*Bitcoin Mainnet*):

```text
scan : m / 352' / 0' / 0' / 1' / 0
spend : m / 352' / 0' / 0' / 0' / 0
```

Når vi har disse to nøkkelparene, kobler vi dem ganske enkelt sammen (ende-til-ende) for å lage den statiske adressen:

$$ B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}} $$

Hvis vi ønsker å bruke etiketter, erstatter vi $B_{\text{spend}}$ med $B_m$ :

$$ B = B_{\text{scan}} \text{ ‖ } B_m $$$

Med etiketten $m$ :

$$ B_m = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } m) \cdot G $$$

Når vi har denne nyttelasten, legger vi til HRP (*Human-Readable Part*) `sp` og versjon `q` (= versjon 0). Vi legger også til en kontrollsum og formaterer adressen som bech32m.

Her er for eksempel den statiske adressen min til Silent Payments:

```text
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```

Et viktig poeng angående statiske adresser, som du kanskje har forstått i de foregående avsnittene, er at disse adressene ikke er synlige i Bitcoin-transaksjoner. Bare $P$-betalingsadressene som brukes i utganger vises på blokkjeden i standard Taproot-format. Fra utsiden er det derfor umulig å skille en transaksjon som involverer Silent Payment fra en vanlig transaksjon som bruker P2TR-utganger.

Som med BIP47 er det umulig å etablere en forbindelse mellom en statisk adresse $B$ og en betalingsadresse $P$ avledet fra $B$. Selv om Eve, en potensiell angriper, forsøker å skanne blokkjeden med Bobs statiske $B$-adresse, vil hun ikke være i stand til å utføre beregningene som kreves for å bestemme $P$. Til det trenger hun enten Bobs private nøkkel $b_{\text{scan}}$, eller avsenderens private nøkkel $a$, men begge er selvsagt private. Det er derfor mulig å eksplisitt knytte ens statiske adresse til en form for personlig identitet.

### Hvordan bruker jeg Silent Payments?

Silent Payments-forslaget er relativt nytt og har bare blitt implementert av et svært begrenset antall lommebøker for øyeblikket. Så vidt jeg vet, er det bare tre programvareprodukter som støtter dem:


- [CakeWallet](https://cakewallet.com/)
- [Silentium] (https://app.silentium.dev/)
- [DonationWallet](https://github.com/Sosthene00/donationwallet)

Vi vil snart gi deg en detaljert veiledning i hvordan du setter opp din egen statiske Silent Payments-adresse.

Siden denne funksjonen er ny, anbefaler vi at du utviser forsiktighet og unngår å bruke Silent Payments for store beløp på mainnet.

*For å lage dette kapittelet om Silent Payments brukte jeg [nettstedet med forklaringer om Silent Payments] (https://silentpayments.xyz/) og [BIP352-forklaringsdokumentet] (https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki)

# Siste seksjon

<partId>2aee56c0-b285-4799-b4f7-373a552ee2b2</partId>

## Anmeldelser og rangeringer

<chapterId>195d149f-80fa-5816-8b46-995a9226d082</chapterId>

<isCourseReview>true</isCourseReview>

## Avsluttende eksamen

<chapterId>e803d394-e3c1-5816-a6b4-a69a2472019c</chapterId>

<isCourseExam>true</isCourseExam>

## Konklusjon

<chapterId>cd8e5c67-50e4-4dcd-8e04-88ba5ec95305</chapterId>

<isCourseConclusion>true</isCourseConclusion>
